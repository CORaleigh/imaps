(this.webpackJsonpimaps=this.webpackJsonpimaps||[]).push([[25],{1065:function(e,t,r){"use strict";var a=r(2),n=r(3),i=r(4),s=r(5),l=r(24),u=r(44),o=r(868),c=r(909),d=r(688),f=r(935),h=r(920),y=function(e){Object(i.a)(r,e);var t=Object(s.a)(r);function r(e){var n;return Object(a.a)(this,r),(n=t.call(this,e)).declaredClass="esri.arcade.featureset.actions.AttributeFilter",n._maxProcessing=1e3,n._parent=e.parentfeatureset,e.whereclause instanceof d.WhereClause?(n._whereclause=e.whereclause,n._whereClauseFunction=null):(n._whereClauseFunction=e.whereclause,n._whereclause=null),n}return Object(n.a)(r,[{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new u.a({wkid:4326}),this.geometryType=o.m.point)}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getFilteredSet("",null,t._whereclause,null,e)})).then((function(r){return t._checkCancelled(e),null!==t._whereClauseFunction?t._wset=new c.a(r._candidates.slice(0).concat(r._known.slice(0)),[],r._ordered,t._clonePageDefinition(r.pagesDefinition)):t._wset=new c.a(r._candidates.slice(0),r._known.slice(0),r._ordered,t._clonePageDefinition(r.pagesDefinition)),t._wset})):Object(l.s)(this._wset)}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);return t===o.b.NotInFeatureSet?t:void 0===(t=this._idstates[e])?o.b.Unknown:t}},{key:"_getFeature",value:function(e,t,r){return this._parent._getFeature(e,t,r)}},{key:"_getFeatures",value:function(e,t,r,a){return this._parent._getFeatures(e,t,r,a)}},{key:"_featureFromCache",value:function(e){return this._parent._featureFromCache(e)}},{key:"executeWhereClause",value:function(e){return this._whereclause.testFeature(e)}},{key:"executeWhereClauseDeferred",value:function(e){if(null!==this._whereClauseFunction)try{var t=this._whereClauseFunction(e);return Object(l.o)(t)?t:Object(l.s)(t)}catch(r){return Object(l.r)(r)}return Object(l.s)(this.executeWhereClause(e))}},{key:"_fetchAndRefineFeatures",value:function(e,t,r){var a=this,n=new c.a([],e,!1,null),i=Math.min(t,e.length);return this._parent._getFeatures(n,-1,i,r).then((function(){if(a._checkCancelled(r),null==a._whereClauseFunction){for(var n=0;n<i;n++){var s=a._parent._featureFromCache(e[n]);!0===a.executeWhereClause(s)?a._idstates[e[n]]=o.b.InFeatureSet:a._idstates[e[n]]=o.b.NotInFeatureSet}return"success"}for(var u=[],c=0;c<i;c++){var d=a._parent._featureFromCache(e[c]);u.push(a.executeWhereClauseDeferred(d))}return Object(l.b)(u).then((function(r){for(var n=0;n<t;n++)!0===r[n]?a._idstates[e[n]]=o.b.InFeatureSet:a._idstates[e[n]]=o.b.NotInFeatureSet;return"success"}))}))}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return null!==this._whereClauseFunction||(null!==r?null!==this._whereclause&&(r=Object(f.a)(this._whereclause,r)):r=this._whereclause),this._ensureLoaded().then((function(){return i._parent._getFilteredSet(e,t,r,a,n)})).then((function(e){return i._checkCancelled(n),null!==i._whereClauseFunction?new c.a(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,i._clonePageDefinition(e.pagesDefinition)):new c.a(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_stat",value:function(e,t,r,a,n,i,s){var u=this;if(null!==this._whereClauseFunction)return null===n&&""===r&&null===a?this._manualStat(e,t,i,s):Object(l.s)({calculated:!1});var o=this._whereclause;return null!==n&&null!==this._whereclause&&(o=Object(f.a)(this._whereclause,n)),this._parent._stat(e,t,r,a,o,i,s).then((function(l){return!1===l.calculated?null===n&&""===r&&null===a?u._manualStat(e,t,i,s):{calculated:!1}:l}))}},{key:"_canDoAggregates",value:function(e,t,r,a,n){return null!==this._whereClauseFunction?Object(l.s)(!1):(null!==n?null!==this._whereclause&&(n=Object(f.a)(this._whereclause,n)):n=this._whereclause,null===this._parent?Object(l.s)(!1):this._parent._canDoAggregates(e,t,r,a,n))}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,a,n,i,s){return null===this._parent?Object(l.r)(new Error("Should never be called")):(null!==n?null!==this._whereclause&&(n=Object(f.a)(this._whereclause,n)):n=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(e,t,r,a,n,i,s))}}],[{key:"registerAction",value:function(){h.a._featuresetFunctions.filter=function(e){if("function"==typeof e)return new r({parentfeatureset:this,whereclause:e});var t=null;return e instanceof d.WhereClause&&(t=e),new r({parentfeatureset:this,whereclause:t})}}}]),r}(h.a);t.a=y},1067:function(e,t,r){"use strict";var a=r(15),n=r(2),i=r(3),s=r(4),l=r(5),u=r(24),o=r(861),c=r(909),d=r(920),f=r(1068),h=function(e){Object(s.a)(r,e);var t=Object(l.a)(r);function r(e){var a;return Object(n.a)(this,r),(a=t.call(this,e))._orderbyclause=null,a.declaredClass="esri.arcade.featureset.actions.OrderBy",a._maxProcessing=100,a._orderbyclause=e.orderbyclause,a._parent=e.parentfeatureset,a}return Object(i.a)(r,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,t._orderbyclause,e)})).then((function(r){return t._checkCancelled(e),t._wset=r,t._wset})):Object(u.s)(this._wset)}},{key:"manualOrderSet",value:function(e,t){var r=this;return this.getIdColumnDictionary(e,[],-1,t).then((function(e){r._orderbyclause.order(e);for(var t=new c.a([],[],!0,null),a=0;a<e.length;a++)t._known.push(e[a].id);return t}))}},{key:"getIdColumnDictionary",value:function(e,t,r,n){var i=this;if(r<e._known.length-1){var s=this._maxQueryRate();if("GETPAGES"===e._known[r+1])return Object(o.q)(this._parent._expandPagedSet(e,s,0,0,n)).then((function(){return i.getIdColumnDictionary(e,t,r,n)}));for(var l=r+1,c=[];l<e._known.length&&"GETPAGES"!==e._known[l];)c.push(e._known[l]),l++;return r+=c.length,Object(o.q)(this._parent._getFeatureBatch(c,n)).then((function(s){i._checkCancelled(n);var l,u=Object(a.a)(s);try{for(u.s();!(l=u.n()).done;){var o=l.value;t.push({id:o.attributes[i.objectIdField],feature:o})}}catch(c){u.e(c)}finally{u.f()}return i.getIdColumnDictionary(e,t,r,n)}))}return e._candidates.length>0?Object(o.q)(this._refineSetBlock(e,this._maxProcessingRate(),n)).then((function(){return i._checkCancelled(n),i.getIdColumnDictionary(e,t,r,n)})):Object(u.s)(t)}},{key:"_isInFeatureSet",value:function(e){return this._parent._isInFeatureSet(e)}},{key:"_getFeatures",value:function(e,t,r,a){return this._parent._getFeatures(e,t,r,a)}},{key:"_featureFromCache",value:function(e){if(void 0===this._featureCache[e]){var t=this._parent._featureFromCache(e);if(void 0===t)return;return null===t?null:(this._featureCache[e]=t,t)}return this._featureCache[e]}},{key:"_fetchAndRefineFeatures",value:function(){return Object(u.r)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return this._ensureLoaded().then((function(){return i._parent._getFilteredSet(e,t,r,null===a?i._orderbyclause:a,n)})).then((function(e){i._checkCancelled(n);var a=new c.a(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition)),s=!0;return e._candidates.length>0&&(s=!1),!1===a._ordered?i.manualOrderSet(a,n).then((function(e){return!1===s&&(null===t&&null===r||(e=new c.a(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,i._clonePageDefinition(e.pagesDefinition)))),e})):a}))}}],[{key:"registerAction",value:function(){d.a._featuresetFunctions.orderBy=function(e){return""===e?this:new r({parentfeatureset:this,orderbyclause:new f.a(e)})}}}]),r}(d.a);t.a=h},1068:function(e,t,r){"use strict";var a=r(15),n=r(2),i=r(3);function s(e,t){return e===t?0:null===e?-1:null===t?1:e<t?-1:1}var l=function(){function e(t){Object(n.a)(this,e);var r=t.split(",");this._fields=[],this._directions=[];for(var a=0;a<r.length;a++){var i=r[a].match(/\S+/g);this._fields.push(i[0]),2===i.length?"asc"===i[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}return Object(i.a)(e,[{key:"constructClause",value:function(){for(var e="",t=0;t<this._fields.length;t++)0!==t&&(e+=","),e+=this._fields[t],1===this._directions[t]?e+=" ASC":e+=" DESC";return e}},{key:"order",value:function(e){var t=this;e.sort((function(e,r){for(var a=0;a<t._fields.length;a++){var n,i=t.featureValue(e.feature,t._fields[a],a),l=t.featureValue(r.feature,t._fields[a],a);if(0!==(n=1===t._directions[a]?s(i,l):-1*s(i,l)))return n}return 0}))}},{key:"scanForField",value:function(e){for(var t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===e.toLowerCase().trim())return!0;return!1}},{key:"replaceFields",value:function(t){for(var r="",n=0;n<this._fields.length;n++){0!==n&&(r+=",");var i,s=this._fields[n],l=Object(a.a)(t);try{for(l.s();!(i=l.n()).done;){var u=i.value;if(s.toLowerCase()===u.field.toLowerCase()){s=u.newfield;break}}}catch(o){l.e(o)}finally{l.f()}r+=s,1===this._directions[n]?r+=" ASC":r+=" DESC"}return new e(r)}},{key:"featureValue",value:function(e,t,r){var a=e.attributes[t];if(void 0!==a)return a;for(var n in e.attributes)if(t.toLowerCase()===n.toLowerCase())return this._fields[r]=n,e.attributes[n];return null}}]),e}();t.a=l},1103:function(e,t,r){"use strict";var a=r(2),n=r(3),i=r(24),s=function(){function e(){Object(a.a)(this,e),this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}return Object(n.a)(e,[{key:"add",value:function(e,t,r){this._layerById[t]=r,this._layerByName[e]=r}},{key:"featureSetByName",value:function(e){return void 0===this._layerByName[e]?this.resolvePromise(null):this.resolvePromise(this._layerByName[e])}},{key:"featureSetById",value:function(e){return void 0===this._layerById[e]?this.resolvePromise(null):this.resolvePromise(this._layerById[e])}},{key:"castToText",value:function(){return"object, FeatureSetCollection"}},{key:"resolvePromise",value:function(e){return Object(i.s)(e)}}]),e}();t.a=s},1105:function(e,t,r){"use strict";r.d(t,"a",(function(){return w})),r.d(t,"b",(function(){return b})),r.d(t,"c",(function(){return g})),r.d(t,"d",(function(){return F})),r.d(t,"e",(function(){return m}));var a=r(15),n=r(4),i=r(5),s=r(2),l=r(3),u=r(24),o=r(44),c=r(72),d=r(868),f=r(972),h=r(909),y=r(688),p=r(935),_=r(920),v=function(){function e(){Object(s.a)(this,e),this.sqlRewritable=!1}return Object(l.a)(e,[{key:"postInitialization",value:function(e,t){}}]),e}(),g=function(e){Object(n.a)(r,e);var t=Object(i.a)(r);function r(e){var a;return Object(s.a)(this,r),(a=t.call(this)).field=e,a.sqlRewritable=!0,a}return Object(l.a)(r,[{key:"extractValue",value:function(e){return e.attributes[this.field.name]}},{key:"rewriteSql",value:function(e){return{rewritten:this.sqlRewritable,where:e}}}]),r}(v),b=function(e){Object(n.a)(r,e);var t=Object(i.a)(r);function r(e,a,n){var i;return Object(s.a)(this,r),(i=t.call(this)).originalField=e,i.sqlRewritable=!0,i.field=Object(d.c)(e),i.field.name=a,i.field.alias=n,i}return Object(l.a)(r,[{key:"rewriteSql",value:function(e,t){return{rewritten:this.sqlRewritable,where:Object(p.g)(e,this.field.name,this.originalField.name,t.getFieldsIndex())}}},{key:"extractValue",value:function(e){return e.attributes[this.originalField.name]}}]),r}(v),m=function(e){Object(n.a)(r,e);var t=Object(i.a)(r);function r(e,a,n){var i;for(var l in Object(s.a)(this,r),(i=t.call(this)).field=e,i.codefield=a,i.lkp=n,i.reverseLkp={},n)i.reverseLkp[n[l]]=l;return i.sqlRewritable=!0,i}return Object(l.a)(r,[{key:"rewriteSql",value:function(e,t){var a=this.evaluateNodeToWhereClause(e.parseTree,d.a.Standardised,this.field.name,this.codefield instanceof y.WhereClause?Object(p.i)(this.codefield,d.a.Standardised):this.codefield,e.parameters);return a.indexOf(r.BADNESS)>=0?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:y.WhereClause.create(a,t._parent.getFieldsIndex())}}},{key:"evaluateNodeToWhereClause",value:function(e,t){var n,i,s,l,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,c=arguments.length>4?arguments[4]:void 0;switch(e.type){case"interval":return Object(p.b)(this.evaluateNodeToWhereClause(e.value,t,u,o,c),e.qualifier,e.op);case"case_expression":var d=" CASE ";"simple"===e.format&&(d+=this.evaluateNodeToWhereClause(e.operand,t,u,r.BADNESS,c));for(var f=0;f<e.clauses.length;f++)d+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[f].operand,t,u,r.BADNESS,c)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[f].value,t,u,r.BADNESS,c);return null!==e.else&&(d+=" ELSE "+this.evaluateNodeToWhereClause(e.else,t,u,r.BADNESS,c)),d+=" END ";case"param":var h=c[e.value.toLowerCase()];if("string"==typeof h)return"'"+c[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(h instanceof Date)return Object(p.d)(h,t);if(h instanceof Array){for(var y=[],_=0;_<h.length;_++)"string"==typeof h[_]?y.push("'"+h[_].toString().replace(/'/g,"''")+"'"):h[_]instanceof Date?y.push(Object(p.d)(h[_],t)):y.push(h[_].toString());return y}return h.toString();case"expr_list":i=[];var v,g=Object(a.a)(e.value);try{for(g.s();!(v=g.n()).done;){var b=v.value;i.push(this.evaluateNodeToWhereClause(b,t,u,o,c))}}catch(T){g.e(T)}finally{g.f()}return i;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,t,u,r.BADNESS,c)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" AND "+this.evaluateNodeToWhereClause(e.right,t,u,o,c)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" OR "+this.evaluateNodeToWhereClause(e.right,t,u,o,c)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IS NOT NULL )";case"IN":if(n=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){var m,F=[],w=!0,S=Object(a.a)(e.right.value);try{for(S.s();!(m=S.n()).done;){var O=m.value;if("string"!==O.type){w=!1;break}if(void 0===this.lkp[O.value]){w=!1;break}F.push(this.lkp[O.value].toString())}}catch(T){S.e(T)}finally{S.f()}if(w)return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+F.join(",")+")) "}return n=this.evaluateNodeToWhereClause(e.right,t,u,o,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+n.join(",")+")) "}return(l=this.evaluateNodeToWhereClause(e.right,t,u,o,c))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+l.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+l+")) ";case"NOT IN":if(n=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){var k,j=[],I=!0,C=Object(a.a)(e.right.value);try{for(C.s();!(k=C.n()).done;){var D=k.value;if("string"!==D.type){I=!1;break}if(void 0===this.lkp[D.value]){I=!1;break}j.push(this.lkp[D.value].toString())}}catch(T){C.e(T)}finally{C.f()}if(I)return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+j.join(",")+")) "}return n=this.evaluateNodeToWhereClause(e.right,t,u,o,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+n.join(",")+")) "}return(l=this.evaluateNodeToWhereClause(e.right,t,u,o,c))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+l.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+l+")) ";case"BETWEEN":return s=this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" BETWEEN "+s[0]+" AND "+s[1]+" ) ";case"NOTBETWEEN":return s=this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" NOT BETWEEN "+s[0]+" AND "+s[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+") ";case"<>":case"=":if("column_ref"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+o+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column_ref"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+o+") ";return" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return Object(p.d)(e.value,t);case"number":return e.value.toString();case"current_time":return Object(p.e)("date"===e.mode,t);case"column_ref":return u&&u.toLowerCase()===e.column.toLowerCase()?"("+o+")":e.column;case"function":var R=this.evaluateNodeToWhereClause(e.args,t,u,r.BADNESS,c);return Object(p.k)(e.name,R,t)}throw new Error("Unsupported sql syntax "+e.type)}},{key:"extractValue",value:function(e){return this.codefield instanceof y.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]}}]),r}(v);m.BADNESS="_!!!_BAD_LKP_!!!!";var F=function(e){Object(n.a)(r,e);var t=Object(i.a)(r);function r(e,a){var n;return Object(s.a)(this,r),(n=t.call(this)).field=e,n.sql=a,n}return Object(l.a)(r,[{key:"rewriteSql",value:function(e,t){return{rewritten:!0,where:Object(p.g)(e,this.field.name,Object(p.i)(this.sql,d.a.Standardised),t.getFieldsIndex())}}},{key:"extractValue",value:function(e){return this.sql.calculateValueCompiled(e)}}]),r}(v),w=function(e){Object(n.a)(r,e);var t=Object(i.a)(r);function r(e){var a;return Object(s.a)(this,r),(a=t.call(this,e))._calcFunc=null,a.declaredClass="esri.arcade.featureset.actions.Adapted",a.adaptedFields=null,a._extraFilter=null,a._extraFilter=e.extraFilter,a._parent=e.parentfeatureset,a._maxProcessing=30,a.adaptedFields=e.adaptedFields,a}return Object(l.a)(r,[{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new o.a({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=d.m.point,this.typeIdField="",this.types=null),this.fields=[];var e,t=Object(a.a)(this.adaptedFields);try{for(t.s();!(e=t.n()).done;){var r=e.value;r.postInitialization(this,this._parent),this.fields.push(r.field)}}catch(n){t.e(n)}finally{t.f()}}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._extraFilter?t._getFilteredSet("",null,null,null,e):t._parent._getSet(e)})).then((function(r){return t._checkCancelled(e),t._wset=new h.a(r._candidates.slice(0),r._known.slice(0),r._ordered,t._clonePageDefinition(r.pagesDefinition)),t._wset})):Object(u.s)(this._wset)}},{key:"_isInFeatureSet",value:function(e){return this._parent._isInFeatureSet(e)}},{key:"_getFeatures",value:function(e,t,r,n){var i=this,s=[];-1!==t&&void 0===this._featureCache[t]&&s.push(t);var l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,n).then((function(){return i._getFeatures(e,t,r,n)}));for(var o=0,d=e._lastFetchedIndex;d<e._known.length&&(++o<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[d]]&&(e._known[d]!==t&&s.push(e._known[d]),s.length>=l-1)));d++);if(0===s.length)return Object(u.s)("success");e=new h.a([],s,e._ordered,null);var y=Math.min(s.length,r);return this._parent._getFeatures(e,-1,y,n).then((function(){i._checkCancelled(n);for(var e=[],t=0;t<y;t++){var r=i._parent._featureFromCache(s[t]);void 0!==r&&e.push({geometry:r.geometry,attributes:r.attributes,id:s[t]})}for(var l=0,u=e;l<u.length;l++){var o,d=u[l],h=[],p=Object(a.a)(i.adaptedFields);try{for(p.s();!(o=p.n()).done;){var _=o.value;h[_.field.name]=_.extractValue(d)}}catch(v){p.e(v)}finally{p.f()}i._featureCache[d.id]=new c.a({attributes:h,geometry:Object(f.a)(d.geometry)})}return"success"}))}},{key:"_fetchAndRefineFeatures",value:function(){return Object(u.r)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(e,t,r,n,i){var s,l=this,u=this.reformulateWithoutAdaptions(r);s=u.cannot,r=u.where;var o=!1;if(null!==n){o=!0;var c,d=[],f=Object(a.a)(this.adaptedFields);try{for(f.s();!(c=f.n()).done;){var y=c.value;if(!(y instanceof g)&&!0===n.scanForField(y.field.name)){if(!(y instanceof b)){n=null,o=!1;break}d.push({field:y.field.name,newfield:y.originalField.name})}}}catch(_){f.e(_)}finally{f.f()}n&&d.length>0&&(n=n.replaceFields(d))}return null!==r?null!==this._extraFilter&&(r=Object(p.a)(this._extraFilter,r)):r=this._extraFilter,this._ensureLoaded().then((function(){return l._parent._getFilteredSet(e,t,r,n,i)})).then((function(e){return l._checkCancelled(i),!0===s?new h.a(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===o&&e._ordered,l._clonePageDefinition(e.pagesDefinition)):new h.a(e._candidates.slice(0),e._known.slice(0),!0===o&&e._ordered,l._clonePageDefinition(e.pagesDefinition))}))}},{key:"reformulateWithoutAdaptions",value:function(e){var t={cannot:!1,where:e};if(null!==e){var r,n=Object(a.a)(this.adaptedFields);try{for(n.s();!(r=n.n()).done;){var i=r.value;if(!0===Object(p.h)(e,i.field.name)){var s=i.rewriteSql(e,this);if(!0!==s.rewritten){t.cannot=!0,t.where=null;break}t.where=s.where}}}catch(l){n.e(l)}finally{n.f()}}return t}},{key:"_stat",value:function(e,t,r,a,n,i,s){var l=this,o=!1,c=this.reformulateWithoutAdaptions(t);return o=c.cannot,t=c.where,c=this.reformulateWithoutAdaptions(n),o=o||c.cannot,null!==(n=c.where)?null!==this._extraFilter&&(n=Object(p.a)(this._extraFilter,n)):n=this._extraFilter,!0===o?null===n&&""===r&&null===a?this._manualStat(e,t,i,s):Object(u.s)({calculated:!1}):this._parent._stat(e,t,r,a,n,i,s).then((function(u){return!1===u.calculated?null===n&&""===r&&null===a?l._manualStat(e,t,i,s):{calculated:!1}:u}))}},{key:"_canDoAggregates",value:function(e,t,r,n,i){if(null===this._parent)return Object(u.s)(!1);for(var s=0;s<e.length;s++){var l,o=Object(a.a)(this.adaptedFields);try{for(o.s();!(l=o.n()).done;){var c=l.value;if(e[s].toLowerCase()===c.field.name.toLowerCase()&&!(c instanceof g))return Object(u.s)(!1)}}catch(b){o.e(b)}finally{o.f()}}for(var d=[],f=0;f<t.length;f++){var h=t[f];if(null!==h.workingexpr){var y=this.reformulateWithoutAdaptions(h.workingexpr);if(y.cannot)return Object(u.s)(!1);var _=h.clone();_.workingexpr=y.where,d.push(_)}else d.push(h)}var v=this.reformulateWithoutAdaptions(i);return v.cannot?Object(u.s)(!1):(null!==(i=v.where)?null!==this._extraFilter&&(i=Object(p.a)(this._extraFilter,i)):i=this._extraFilter,this._parent._canDoAggregates(e,d,r,n,i))}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,a,n,i,s){if(null===this._parent)return Object(u.r)(new Error("Should never be called"));for(var l=[],o=0;o<t.length;o++){var c=t[o];if(null!==c.workingexpr){var d=this.reformulateWithoutAdaptions(c.workingexpr);if(d.cannot)return Object(u.r)(new Error("Should never be called"));var f=c.clone();f.workingexpr=d.where,l.push(f)}else l.push(c)}var h=this.reformulateWithoutAdaptions(n);return h.cannot?Object(u.r)(new Error("Should never be called")):(null!==(n=h.where)?null!==this._extraFilter&&(n=Object(p.a)(this._extraFilter,n)):n=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(e,l,r,a,n,i,s))}}],[{key:"findField",value:function(e,t){var r,n=Object(a.a)(e);try{for(n.s();!(r=n.n()).done;){var i=r.value;if(i.name.toLowerCase()===t.toString().toLowerCase())return i}}catch(s){n.e(s)}finally{n.f()}return null}}]),r}(_.a)},1107:function(e,t,r){"use strict";var a=r(2),n=r(3),i=r(4),s=r(5),l=r(24),u=r(868),o=r(909),c=r(920),d=function(e){Object(i.a)(r,e);var t=Object(s.a)(r);function r(e){var n;return Object(a.a)(this,r),(n=t.call(this,e))._topnum=0,n.declaredClass="esri.arcade.featureset.actions.Top",n._countedin=0,n._maxProcessing=100,n._topnum=e.topnum,n._parent=e.parentfeatureset,n}return Object(n.a)(r,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getSet(e)})).then((function(e){return t._wset=new o.a(e._candidates.slice(0),e._known.slice(0),!1,t._clonePageDefinition(e.pagesDefinition)),t._setKnownLength(t._wset)>t._topnum&&(t._wset._known=t._wset._known.slice(0,t._topnum)),t._setKnownLength(t._wset)>=t._topnum&&(t._wset._candidates=[]),t._wset})):Object(l.s)(this._wset)}},{key:"_setKnownLength",value:function(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?e._known.length-1:e._known.length}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);if(t===u.b.NotInFeatureSet)return t;var r=this._idstates[e];return r===u.b.InFeatureSet||r===u.b.NotInFeatureSet?r:t===u.b.InFeatureSet&&void 0===r?this._countedin<this._topnum?(this._idstates[e]=u.b.InFeatureSet,this._countedin++,u.b.InFeatureSet):(this._idstates[e]=u.b.NotInFeatureSet,u.b.NotInFeatureSet):u.b.Unknown}},{key:"_expandPagedSet",value:function(e,t,r,a,n){var i=this;if(null===this._parent)return Object(l.r)(new Error("Parent Paging not implemented"));if(t>this._topnum&&(t=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){var s=e._known.length;return s>0&&"GETPAGES"===e._known[s-1]&&(e._known.length=s-1),(s=e._candidates.length)>0&&"GETPAGES"===e._candidates[s-1]&&(e._candidates.length=s-1),Object(l.s)("success")}return this._parent._expandPagedSet(e,t,r,a,n).then((function(t){return i._setKnownLength(e)>i._topnum&&(e._known.length=i._topnum),i._setKnownLength(e)>=i._topnum&&(e._candidates.length=0),t}))}},{key:"_getFeatures",value:function(e,t,r,a){var n=this,i=[],s=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,s))return this._expandPagedSet(e,s,0,0,a).then((function(){return n._getFeatures(e,t,r,a)}));-1!==t&&void 0===this._featureCache[t]&&i.push(t);for(var u=0,c=e._lastFetchedIndex;c<e._known.length&&(++u<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[c]]&&(e._known[c]!==t&&i.push(e._known[c]),i.length>s-1)));c++);if(0===i.length)return Object(l.s)("success");var d=new o.a([],i,!1,null),f=Math.min(i.length,r);return this._parent._getFeatures(d,-1,f,a).then((function(){for(var e=0;e<f;e++){var t=n._parent._featureFromCache(i[e]);void 0!==t&&(n._featureCache[i[e]]=t)}return"success"}))}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return this._ensureLoaded().then((function(){return i._getSet(n)})).then((function(e){return new o.a(e._candidates.slice(0).concat(e._known.slice(0)),[],!1,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_refineKnowns",value:function(e,t){for(var r=0,a=null,n=[],i=0;i<e._candidates.length;i++){var s=this._isInFeatureSet(e._candidates[i]);if(s===u.b.InFeatureSet){if(e._known.push(e._candidates[i]),r+=1,null===a?a={start:i,end:i}:a.end===i-1?a.end=i:(n.push(a),a={start:i,end:i}),e._known.length>=this._topnum)break}else if(s===u.b.NotInFeatureSet)null===a?a={start:i,end:i}:a.end===i-1?a.end=i:(n.push(a),a={start:i,end:i}),r+=1;else if(s===u.b.Unknown)break;if(r>=t)break}null!==a&&n.push(a);for(var l=n.length-1;l>=0;l--)e._candidates.splice(n[l].start,n[l].end-n[l].start+1);this._setKnownLength(e)>this._topnum&&(e._known=e._known.slice(0,this._topnum)),this._setKnownLength(e)>=this._topnum&&(e._candidates=[])}},{key:"_stat",value:function(){return Object(l.s)({calculated:!1})}},{key:"_canDoAggregates",value:function(){return Object(l.s)(!1)}}],[{key:"registerAction",value:function(){c.a._featuresetFunctions.top=function(e){return new r({parentfeatureset:this,topnum:e})}}}]),r}(c.a);t.a=d},1108:function(e,t,r){"use strict";var a=r(15),n=r(2),i=r(3),s=r(4),l=r(5),u=r(24),o=r(136),c=r(72),d=r(194),f=r(868),h=r(909),y=r(935),p=r(920),_=r(412),v=r(106),g=r(219),b=function(e){Object(s.a)(r,e);var t=Object(l.a)(r);function r(e){var a;return Object(n.a)(this,r),(a=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",a._removeGeometry=!1,a._overrideFields=null,a._forceIsTable=!1,e.spatialReference&&(a.spatialReference=e.spatialReference),a._transparent=!0,a._maxProcessing=1e3,a._layer=e.layer,a._wset=null,!0===e.isTable&&(a._forceIsTable=!0),void 0!==e.outFields&&(a._overrideFields=e.outFields),void 0!==e.includeGeometry&&(a._removeGeometry=!1===e.includeGeometry),a}return Object(i.a)(r,[{key:"_maxQueryRate",value:function(){return f.f}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(u.c)((function(t,r){if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(a){r(a)}}),r),e._layer.load()}))),this._loadPromise}},{key:"gdbVersion",get:function(){return""}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{var e,t=[],r=Object(a.a)(this.fields);try{for(r.s();!(e=r.n()).done;){var n=e.value;if("oid"===n.type)t.push(n);else{var i,s=Object(a.a)(this._layer.outFields);try{for(s.s();!(i=s.n()).done;){if(i.value.toLowerCase()===n.name.toLowerCase()){t.push(n);break}}}catch(g){s.e(g)}finally{s.f()}}}}catch(g){r.e(g)}finally{r.f()}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var l,u=[],o=[],c=Object(a.a)(this.fields);try{for(c.s();!(l=c.n()).done;){var d=l.value;if("oid"===d.type)u.push(d),o.push(d.name);else{var h,y=Object(a.a)(this._overrideFields);try{for(y.s();!(h=y.n()).done;){if(h.value.toLowerCase()===d.name.toLowerCase()){u.push(d),o.push(d.name);break}}}catch(g){y.e(g)}finally{y.f()}}}}catch(g){c.e(g)}finally{c.f()}this.fields=u,this._overrideFields=o}this.objectIdField=this._layer.objectIdField;var p,_=Object(a.a)(this.fields);try{for(_.s();!(p=_.n()).done;){var v=p.value;"global-id"===v.type&&(this.globalIdField=v.name)}}catch(g){_.e(g)}finally{_.f()}this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=f.a.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}},{key:"isTable",value:function(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}},{key:"_isInFeatureSet",value:function(){return f.b.InFeatureSet}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):Object(u.s)(this._wset)}},{key:"_changeFeature",value:function(e){var t,r={},n=Object(a.a)(this.fields);try{for(n.s();!(t=n.n()).done;){var i=t.value;r[i.name]=e.attributes[i.name]}}catch(s){n.e(s)}finally{n.f()}return new c.a({geometry:!0===this._removeGeometry?null:e.geometry,attributes:r})}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this,s="",l=!1;if(null!==a&&(s=a.constructClause(),l=!0),this.isTable()&&t&&null!==e&&""!==e){var o=new h.a([],[],!0,null);return Object(u.s)(o)}var c=new v.a;return c.where=null===r?null===t?"1=1":"":Object(y.i)(r,f.a.Standardised),c.spatialRelationship=this._makeRelationshipEnum(e),c.outSpatialReference=this.spatialReference,c.orderByFields=""!==s?s.split(","):null,c.geometry=null===t?null:t,c.returnGeometry=!0,c.relationParameter=this._makeRelationshipParam(e),this._layer.queryFeatures(c).then((function(e){if(null===e)return new h.a([],[],l,null);i._checkCancelled(n);var t=[];return e.features.forEach((function(e){var r=e.attributes[i._layer.objectIdField];t.push(r),i._featureCache[r]=i._changeFeature(e)})),new h.a([],t,l,null)}))}},{key:"_makeRelationshipEnum",value:function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}},{key:"_makeRelationshipParam",value:function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}},{key:"_queryAllFeatures",value:function(){var e=this;if(this._wset)return Object(u.s)(this._wset);var t=new v.a;return t.where="1=1",this._ensureLoaded().then((function(){if(e._layer.source&&e._layer.source.items){var r=[];return e._layer.source.items.forEach((function(t){var a=t.attributes[e._layer.objectIdField];r.push(a),e._featureCache[a]=e._changeFeature(t)})),e._wset=new h.a([],r,!1,null),e._wset}return e._layer.queryFeatures(t).then((function(t){var r=[];return t.features.forEach((function(t){var a=t.attributes[e._layer.objectIdField];r.push(a),e._featureCache[a]=e._changeFeature(t)})),e._wset=new h.a([],r,!1,null),e._wset}))}))}},{key:"_getFeatures",value:function(e,t,r){var a=[];-1!==t&&void 0===this._featureCache[t]&&a.push(t);for(var n=e._lastFetchedIndex;n<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[n]]&&(e._known[n]!==t&&a.push(e._known[n]),a.length>r)));n++);return 0===a.length?Object(u.s)("success"):Object(u.r)(new Error("Unaccounted for Features. Not in Feature Collection"))}},{key:"_refineSetBlock",value:function(e){return Object(u.s)(e)}},{key:"_stat",value:function(){return Object(u.s)({calculated:!1})}},{key:"_canDoAggregates",value:function(){return Object(u.s)(!1)}},{key:"relationshipMetaData",value:function(){return[]}},{key:"nativeCapabilities",value:function(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}},{key:"queryAttachments",value:function(){return Object(u.s)([])}},{key:"getFeatureByObjectId",value:function(e){var t=new v.a;return t.where=this.objectIdField+"="+e.toString(),this._layer.queryFeatures(t).then((function(e){return 1===e.features.length?e.features[0]:null}))}},{key:"getOwningSystemUrl",value:function(){return Object(u.s)("")}},{key:"getIdentityUser",value:function(){return Object(u.s)("")}}],[{key:"_cloneAttr",value:function(e){var t={};for(var r in e)t[r]=e[r];return t}},{key:"create",value:function(e,t){var n=e.layerDefinition.objectIdField,i=e.layerDefinition.typeIdField?e.layerDefinition.typeIdField:"",s=[];if(e.layerDefinition.types){var l,u=Object(a.a)(e.layerDefinition.types);try{for(u.s();!(l=u.n()).done;){var c=l.value;s.push(_.a.fromJSON(c))}}catch(q){u.e(q)}finally{u.f()}}var f=e.layerDefinition.geometryType;void 0===f&&(f=e.featureSet.geometryType||"");var h=e.featureSet.features,y=t.toJSON();if(""===n||void 0===n){var p,v=!1,b=Object(a.a)(e.layerDefinition.fields);try{for(b.s();!(p=b.n()).done;){var m=p.value;if("oid"===m.type||"esriFieldTypeOID"===m.type){n=m.name,v=!0;break}}}catch(q){b.e(q)}finally{b.f()}if(!1===v){for(var F="FID",w=!0,S=0;w;){var O,k=!0,j=Object(a.a)(e.layerDefinition.fields);try{for(j.s();!(O=j.n()).done;){if(O.value.name===F){k=!1;break}}}catch(q){j.e(q)}finally{j.f()}!0===k?w=!1:F="FID"+(++S).toString()}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:F,alias:F});for(var I=[],C=0;C<h.length;C++)I.push({geometry:e.featureSet.features[C].geometry,attributes:e.featureSet.features[C].attributes?this._cloneAttr(e.featureSet.features[C].attributes):{}}),I[C].attributes[F]=C;h=I,n=F}}var D,R=[],T=Object(a.a)(e.layerDefinition.fields);try{for(T.s();!(D=T.n()).done;){var x=D.value;x instanceof d.a?R.push(x):R.push(d.a.fromJSON(x))}}catch(q){T.e(q)}finally{T.f()}var N=f;switch(N){case"esriGeometryPoint":N="point";break;case"esriGeometryPolyline":N="polyline";break;case"esriGeometryPolygon":N="polygon";break;case"esriGeometryExtent":N="extent";break;case"esriGeometryMultipoint":N="multipoint"}var E,P=Object(a.a)(h);try{for(P.s();!(E=P.n()).done;){var A=E.value;A.geometry&&A.geometry instanceof o.a==0&&(A.geometry.type=N,void 0===A.geometry.spatialReference&&(A.geometry.spatialReference=y))}}catch(q){P.e(q)}finally{P.f()}var L={outFields:["*"],source:h,fields:R,types:s,typeIdField:i,objectIdField:n,spatialReference:t};return L.geometryType=N||"point",new r({layer:new g.default(L),spatialReference:t,isTable:null===N||""===N})}}]),r}(p.a);t.a=b},1129:function(e,t,r){"use strict";r.r(t),r.d(t,"constructAssociationMetaDataFeatureSetFromUrl",(function(){return re})),r.d(t,"constructFeatureSet",(function(){return ee})),r.d(t,"constructFeatureSetFromPortalItem",(function(){return ce})),r.d(t,"constructFeatureSetFromRelationship",(function(){return ae})),r.d(t,"constructFeatureSetFromUrl",(function(){return $})),r.d(t,"createFeatureSetCollectionFromMap",(function(){return se})),r.d(t,"createFeatureSetCollectionFromService",(function(){return le})),r.d(t,"getPortal",(function(){return ue})),r.d(t,"initialiseMetaDataCache",(function(){return X})),r.d(t,"lookupUser",(function(){return oe}));var a=r(10),n=r(2),i=r(3),s=r(4),l=r(5),u=r(15),o=r(24),c=r(91),d=r(54),f=r(89),h=r(300),y=r(868),p=r(1103),_=r(1104),v=r(688),g=r(1065),b=r(1067),m=r(44),F=r(72),w=r(861),S=r(194),O=r(909),k=r(935),j=r(1066),I=r(430),C=r(920),D=r(1105),R=r(1068);var T=function(){function e(){Object(n.a)(this,e)}return Object(i.a)(e,[{key:"clone",value:function(){var t=new e;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}},{key:"toStatisticsName",value:function(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg";default:return"count"}}}],[{key:"parseStatField",value:function(t,r,a){var n=new e;n.field=t;var i=v.WhereClause.create(r,a),s=function(e){if("function"===e.parseTree.type){if(0===e.parseTree.args.value.length)return{name:e.parseTree.name,expr:null};if(e.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");var t=v.WhereClause.create(Object(k.j)(e.parseTree.args.value[0],y.a.Standardised,e.parameters),e.fieldsIndex);return{name:e.parseTree.name,expr:t}}return null}(i);if(null===s)throw new Error("Invalid Statistic Function");var l=s.name.toUpperCase().trim();if("MIN"===l){if(n.typeofstat="MIN",n.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===l){if(n.typeofstat="MAX",n.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===l)n.typeofstat="COUNT",n.workingexpr=s.expr;else if("STDEV"===l){if(n.typeofstat="STDDEV",n.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===l){if(n.typeofstat="SUM",n.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===l){if(n.typeofstat="AVG",n.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===l){if(n.typeofstat="AVG",n.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==l)throw new Error("Invalid Statistic Function");if(n.typeofstat="VAR",n.workingexpr=s.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}return n}}]),e}(),x=r(977);function N(e){if(!e)return"COUNT";switch(e.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}var E=function(e){Object(s.a)(r,e);var t=Object(l.a)(r);function r(e){var a;return Object(n.a)(this,r),(a=t.call(this,e))._decodedStatsfield=[],a._decodedGroupbyfield=[],a._candosimplegroupby=!0,a.phsyicalgroupbyfields=[],a.objectIdField="ROW__ID",a._internalObjectIdField="ROW__ID",a._adaptedFields=[],a.declaredClass="esri.arcade.featureset.actions.Aggregate",a._uniqueIds=1,a._maxQuery=10,a._maxProcessing=10,a._parent=e.parentfeatureset,a._config=e,a}return Object(i.a)(r,[{key:"isTable",value:function(){return!0}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._getFilteredSet("",null,null,null,e).then((function(e){return t._wset=e,t._wset})):Object(o.s)(this._wset)}},{key:"_isInFeatureSet",value:function(){return y.b.InFeatureSet}},{key:"nextUniqueName",value:function(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;var t="T"+this._uniqueIds.toString();return e[t]=1,t}},{key:"convertToEsriFieldType",value:function(e){return e}},{key:"_initialiseFeatureSet",value:function(){var e={},t=!1,r=1,a=this._parent?this._parent.getFieldsIndex():new I.a([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){for(var n=!1,i=0;i<this._config.groupbyfields.length;i++)if(this._config.groupbyfields[i].name.toLowerCase()===this.objectIdField.toLowerCase()){n=!0;break}if(!1===n)for(var s=0;s<this._config.statsfields.length;s++)if(this._config.statsfields[s].name.toLowerCase()===this.objectIdField.toLowerCase()){n=!0;break}!1===n?t=!0:(this.objectIdField="ROW__ID"+r.toString(),r++)}var l,o=Object(u.a)(this._config.statsfields);try{for(o.s();!(l=o.n()).done;){var c=l.value,d=new T;d.field=c.name,d.tofieldname=c.name,d.workingexpr=c.expression instanceof v.WhereClause?c.expression:v.WhereClause.create(c.expression,a),d.typeofstat=N(c.statistic),this._decodedStatsfield.push(d)}}catch(W){o.e(W)}finally{o.f()}this._decodedGroupbyfield=[];var f,h=Object(u.a)(this._config.groupbyfields);try{for(h.s();!(f=h.n()).done;){var p=f.value,_={name:p.name,singlefield:null,tofieldname:p.name,expression:p.expression instanceof v.WhereClause?p.expression:v.WhereClause.create(p.expression,a)};this._decodedGroupbyfield.push(_)}}catch(W){h.e(W)}finally{h.f()}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";var g,b=Object(u.a)(this._parent.fields);try{for(b.s();!(g=b.n()).done;){e[g.value.name.toUpperCase()]=1}}catch(W){b.e(W)}finally{b.f()}this.types=null}else this.geometryType=y.m.point,this.typeIdField="",this.types=null,this.spatialReference=new m.a({wkid:4326});this.fields=[];var F=new T;F.field=this.nextUniqueName(e),F.tofieldname=this.objectIdField,F.workingexpr=v.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),F.typeofstat="MIN",this._decodedStatsfield.push(F);var w,O=Object(u.a)(this._decodedGroupbyfield);try{for(O.s();!(w=O.n()).done;){var j=w.value,C=new S.a;if(j.name=this.nextUniqueName(e),C.name=j.tofieldname,C.alias=C.name,Object(k.c)(j.expression)){var R=this._parent.getField(Object(k.i)(j.expression,y.a.Standardised));if(!R)throw new Error("Field is not present for Aggregation");j.name=R.name,j.singlefield=R.name,this.phsyicalgroupbyfields.push(R.name),C.type=R.type}else{C.type=this.convertToEsriFieldType(Object(k.f)(j.expression,this._parent.fields));var x=new S.a;x.name=j.name,x.alias=x.name,this.phsyicalgroupbyfields.push(j.name),this._adaptedFields.push(new D.d(x,j.expression)),this._candosimplegroupby=!1}this.fields.push(C)}}catch(W){O.e(W)}finally{O.f()}if(this._adaptedFields.length>0){var E,P=Object(u.a)(this._parent.fields);try{for(P.s();!(E=P.n()).done;){var A=E.value;this._adaptedFields.push(new D.c(A))}}catch(W){P.e(W)}finally{P.f()}}for(var L=0;L<this._decodedStatsfield.length;L++){var q=new S.a,G=null,B=this._decodedStatsfield[L];B.field=this.nextUniqueName(e),B.tofieldname===this.objectIdField&&(this._internalObjectIdField=B.field),q.name=B.tofieldname,q.alias=q.name;var U=null!==B.workingexpr&&Object(k.c)(B.workingexpr)?Object(k.i)(B.workingexpr,y.a.Standardised):"";switch(this._decodedStatsfield[L].typeofstat){case"SUM":if(""!==U){if(!(G=this._parent.getField(U)))throw new Error("Field is not present for Aggregation");q.type=G.type}else q.type="double";break;case"MIN":case"MAX":if(""!==U){if(!(G=this._parent.getField(U)))throw new Error("Field is not present for Aggregation");q.type=G.type}else q.type="double";break;case"COUNT":q.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==U&&!(G=this._parent.getField(U)))throw new Error("Field is not present for Aggregation");q.type="double"}this.fields.push(q)}}},{key:"_canDoAggregates",value:function(){return Object(o.s)(!1)}},{key:"_getFeatures",value:function(e,t,r,a){var n=this;-1!==t&&this._featureCache[t];var i=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,i)?this._expandPagedSet(e,i,0,0,a).then((function(){return n._getFeatures(e,t,r,a)})):Object(o.s)("success")}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;if(""!==e)return Object(o.s)(new O.a([],[],!0,null));var s=null,l={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then((function(){if(null!==r)for(var e=0;e<i._decodedStatsfield.length;e++)if(!0===Object(k.h)(r,i._decodedStatsfield[e].tofieldname)){l.nowhereclause=!0,r=null;break}if(null!==a){l.ordered=!0;for(var t=0;t<i._decodedStatsfield.length;t++)if(!0===a.scanForField(i._decodedStatsfield[t].tofieldname)){a=null,l.ordered=!1;break}if(null!==a){var n,s=Object(u.a)(i._decodedGroupbyfield);try{for(s.s();!(n=s.n()).done;){var c=n.value;if(null===c.singlefield&&!0===a.scanForField(c.tofieldname)){a=null,l.ordered=!1;break}}}catch(d){s.e(d)}finally{s.f()}}}return!1===i._candosimplegroupby?Object(o.s)(!1):i._parent._canDoAggregates(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,null)})).then((function(e){if(e){var t=null;r&&(t=i._reformulateWhereClauseWithoutGroupByFields(r));var u=null;return a&&(u=i._reformulateOrderClauseWithoutGroupByFields(a)),i._parent._getAggregatePagesDataSourceDefinition(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,t,u,i._internalObjectIdField).then((function(e){return i._checkCancelled(n),s=!0===l.nowhereclause?new O.a(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===l.ordered&&e._ordered,i._clonePageDefinition(e.pagesDefinition)):new O.a(e._candidates.slice(0),e._known.slice(0),!0===l.ordered&&e._ordered,i._clonePageDefinition(e.pagesDefinition))}))}var o=i._parent;if(i._adaptedFields.length>0&&(o=new D.a({parentfeatureset:i._parent,adaptedFields:i._adaptedFields,extraFilter:null})),!0===l.nowhereclause)s=new O.a(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new b.a({parentfeatureset:o,orderbyclause:new R.a(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}});else{var c=o;if(null!==r){var d=null;r&&(d=i._reformulateWhereClauseWithoutGroupByFields(r)),c=new g.a({parentfeatureset:c,whereclause:d})}s=new O.a(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new b.a({parentfeatureset:c,orderbyclause:new R.a(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}})}return s}))}},{key:"_reformulateWhereClauseWithoutStatsFields",value:function(e){var t,r=Object(u.a)(this._decodedStatsfield);try{for(r.s();!(t=r.n()).done;){var a=t.value;e=Object(k.g)(e,a.tofieldname,Object(k.i)(a.workingexpr,y.a.Standardised),this._parent.getFieldsIndex())}}catch(n){r.e(n)}finally{r.f()}return e}},{key:"_reformulateWhereClauseWithoutGroupByFields",value:function(e){var t,r=Object(u.a)(this._decodedGroupbyfield);try{for(r.s();!(t=r.n()).done;){var a=t.value;a.tofieldname!==a.name&&(e=Object(k.g)(e,a.tofieldname,Object(k.i)(a.expression,y.a.Standardised),this._parent.getFieldsIndex()))}}catch(n){r.e(n)}finally{r.f()}return e}},{key:"_reformulateOrderClauseWithoutGroupByFields",value:function(e){var t,r=[],a=Object(u.a)(this._decodedGroupbyfield);try{for(a.s();!(t=a.n()).done;){var n=t.value;n.tofieldname!==n.name&&r.push({field:n.tofieldname,newfield:n.name})}}catch(i){a.e(i)}finally{a.f()}return r.length>0?e.replaceFields(r):e}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}},{key:"_refineSetBlock",value:function(e,t,r){var a=this;try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery))return this._expandPagedSet(e,this._maxQuery,0,0,r).then((function(){return a._refineSetBlock(e,t,r)}));this._checkCancelled(r);e._candidates.length;return this._refineKnowns(e,t),e._candidates.length,e._candidates.length,Object(o.s)(e)}catch(n){return Object(o.r)(n)}}},{key:"_expandPagedSet",value:function(e,t,r,a,n){return this._expandPagedSetFeatureSet(e,t,r,a,n)}},{key:"_getPhysicalPage",value:function(e,t,r){var a=this;return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?Object(o.c)((function(t,n){a._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,r,[]).then((function(e){t(e)}),n)})):this._getAgregagtePhysicalPage(e,t,r).then((function(e){var t,r=Object(u.a)(e);try{for(r.s();!(t=r.n()).done;){var n,i=t.value,s={geometry:i.geometry,attributes:{}},l=Object(u.a)(a._decodedGroupbyfield);try{for(l.s();!(n=l.n()).done;){var o=n.value;s.attributes[o.tofieldname]=i.attributes[o.name]}}catch(h){l.e(h)}finally{l.f()}var c,d=Object(u.a)(a._decodedStatsfield);try{for(d.s();!(c=d.n()).done;){var f=c.value;s.attributes[f.tofieldname]=i.attributes[f.field]}}catch(h){d.e(h)}finally{d.f()}a._featureCache[s.attributes[a.objectIdField]]=new F.a(s)}}catch(h){r.e(h)}finally{r.f()}return e.length}))}},{key:"_sequentialGetPhysicalItem",value:function(e,t,r,a){var n=this;return Object(o.c)((function(i,s){null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(r)),!0===e.pagesDefinition.internal.fullyResolved||0===t?i(a.length):n._nextAggregateItem(e,t,r,a,(function(s){null===s?i(a.length):(t-=1,i(n._sequentialGetPhysicalItem(e,t,r,a)))}),s)}))}},{key:"_nextAggregateItem",value:function(e,t,r,a,n,i){var s=this;try{Object(w.q)(e.pagesDefinition.internal.iterator.next()).then((function(l){if(null===l)if(null!==e.pagesDefinition.internal.workingItem){var u=s._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);a.push(u),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(u.attributes[s.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,n(null)}else e.pagesDefinition.internal.fullyResolved=!0,n(null);else{var o=s._generateAggregateHash(l);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[l],id:o};else{if(o!==e.pagesDefinition.internal.workingItem.id){var c=s._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return a.push(c),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(c.attributes[s.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[l],id:o},void n(c)}e.pagesDefinition.internal.workingItem.features.push(l)}s._nextAggregateItem(e,t,r,a,n,i)}}),i)}catch(l){i(l)}}},{key:"_calculateFieldStat",value:function(e,t,r){for(var a=[],n=0;n<e.features.length;n++)if(null!==t.workingexpr){var i=t.workingexpr.calculateValue(e.features[n]);null!==i&&a.push(i)}else a.push(null);switch(t.typeofstat){case"MIN":r.attributes[t.tofieldname]=Object(j.a)("min",a,-1);break;case"MAX":r.attributes[t.tofieldname]=Object(j.a)("max",a,-1);break;case"SUM":r.attributes[t.tofieldname]=Object(j.a)("sum",a,-1);break;case"COUNT":r.attributes[t.tofieldname]=a.length;break;case"VAR":r.attributes[t.tofieldname]=Object(j.a)("var",a,-1);break;case"STDDEV":r.attributes[t.tofieldname]=Object(j.a)("stddev",a,-1);break;case"AVG":r.attributes[t.tofieldname]=Object(j.a)("avg",a,-1)}return!0}},{key:"_calculateAndAppendAggregateItem",value:function(e){var t,r={attributes:{},geometry:null},a=Object(u.a)(this._decodedGroupbyfield);try{for(a.s();!(t=a.n()).done;){var n=t.value,i=n.singlefield?e.features[0].attributes[n.singlefield]:n.expression.calculateValue(e.features[0]);r.attributes[n.tofieldname]=i}}catch(f){a.e(f)}finally{a.f()}var s,l=Object(u.a)(this._decodedStatsfield);try{for(l.s();!(s=l.n()).done;){var o=s.value;this._calculateFieldStat(e,o,r)}}catch(f){l.e(f)}finally{l.f()}for(var c=[],d=0;d<this._decodedStatsfield.length;d++)c.push(this._calculateFieldStat(e,this._decodedStatsfield[d],r));return this._featureCache[r.attributes[this.objectIdField]]=new F.a({attributes:r.attributes,geometry:r.geometry}),r}},{key:"_generateAggregateHash",value:function(e){var t,r="",a=Object(u.a)(this._decodedGroupbyfield);try{for(a.s();!(t=a.n()).done;){var n=t.value,i=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);r+=null==i?":":":"+i.toString()}}catch(s){a.e(s)}finally{a.f()}return Object(x.a)(r,x.b.String)}},{key:"_stat",value:function(){return Object(o.s)({calculated:!1})}},{key:"getFeatureByObjectId",value:function(){return Object(o.s)(null)}}],[{key:"registerAction",value:function(){C.a._featuresetFunctions.groupby=function(e,t){return new r({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}]),r}(C.a),P=r(1106),A=r(1107),L=r(219),q=r(67),G=r(954),B=r(511),U=r(150),W=r(456),M=r(106),Q=r(581),V=r(222),J=r(577),K=function(e){Object(s.a)(r,e);var t=Object(l.a)(r);function r(e){var a;return Object(n.a)(this,r),(a=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",a._removeGeometry=!1,a._overrideFields=null,a.formulaCredential=null,a._pageJustIds=!1,a._requestStandardised=!1,e.spatialReference&&(a.spatialReference=e.spatialReference),a._transparent=!0,a._maxProcessing=1e3,a._layer=e.layer,a._wset=null,void 0!==e.outFields&&(a._overrideFields=e.outFields),void 0!==e.includeGeometry&&(a._removeGeometry=!1===e.includeGeometry),a}return Object(i.a)(r,[{key:"_maxQueryRate",value:function(){return y.f}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(e){this._pageJustIds=e}},{key:"convertQueryToLruCacheKey",value:function(e){var t=Object(y.q)(e.toJSON());return Object(x.a)(t,x.b.String)}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(o.c)((function(t,r){try{if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(a){r(a)}}),r),e._layer.load()}catch(a){r(a)}}))),this._loadPromise}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{var e,t=[],r=Object(u.a)(this.fields);try{for(r.s();!(e=r.n()).done;){var a=e.value;if("oid"===a.type)t.push(a);else{var n,i=Object(u.a)(this._layer.outFields);try{for(i.s();!(n=i.n()).done;){if(n.value.toLowerCase()===a.name.toLowerCase()){t.push(a);break}}}catch(b){i.e(b)}finally{i.f()}}}}catch(b){r.e(b)}finally{r.f()}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var s,l=[],o=[],c=Object(u.a)(this.fields);try{for(c.s();!(s=c.n()).done;){var d=s.value;if("oid"===d.type)l.push(d),o.push(d.name);else{var f,h=Object(u.a)(this._overrideFields);try{for(h.s();!(f=h.n()).done;){if(f.value.toLowerCase()===d.name.toLowerCase()){l.push(d),o.push(d.name);break}}}catch(b){h.e(b)}finally{h.f()}}}}catch(b){c.e(b)}finally{c.f()}this.fields=l,this._overrideFields=o}if(this._layer.source&&this._layer.source.sourceJSON){var p=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=y.a.StandardisedNoInterval,null!=p&&p>=10.61&&(this._databaseType=y.a.Standardised)):null!=p&&(p>=10.5&&(this._databaseType=y.a.StandardisedNoInterval,this._requestStandardised=!0),p>=10.61&&(this._databaseType=y.a.Standardised))}this.objectIdField=this._layer.objectIdField;var _,v=Object(u.a)(this.fields);try{for(v.s();!(_=v.n()).done;){var g=_.value;"global-id"===g.type&&(this.globalIdField=g.name)}}catch(b){v.e(b)}finally{v.f()}this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}},{key:"_isInFeatureSet",value:function(){return y.b.InFeatureSet}},{key:"_refineSetBlock",value:function(e){return Object(o.s)(e)}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):Object(o.s)(this._wset)}},{key:"_runDatabaseProbe",value:function(e){var t=this;return Object(o.c)((function(r,a){try{t._ensureLoaded().then((function(){try{var n=new M.a;n.where=e.replace("OBJECTID",t._layer.objectIdField),t._layer.queryObjectIds(n).then((function(){r(!0)}),(function(){try{r(!1)}catch(e){a(e)}}))}catch(i){a(i)}}))}catch(n){a(n)}}))}},{key:"_canUsePagination",value:function(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}},{key:"_cacheableFeatureSetSourceKey",value:function(){return this._layer.url}},{key:"pbfSupportedForQuery",value:function(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}},{key:"queryPBF",value:function(e){return e.quantizationParameters={mode:"edit"},Object(V.executeQueryPBF)(this._layer.parsedUrl,e,new Q.b({})).then((function(e){return U.default.fromJSON(Object(B.j)(e.data)).unquantize()}))}},{key:"gdbVersion",get:function(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}},{key:"nativeCapabilities",value:function(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}},{key:"executeQuery",value:function(e,t){var r=this,a=new J.a({url:this._layer.parsedUrl.path}),n="execute"===t&&this.pbfSupportedForQuery(e),i=null;if(this.recentlyUsedQueries){var s=this.convertQueryToLruCacheKey(e);null===(i=this.recentlyUsedQueries.getFromCache(s))&&(i=!0!==n?a[t](e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(s,i),i=i.catch((function(e){throw r.recentlyUsedQueries.removeFromCache(s),e})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===i&&(i=!0!==n?a[t](e):this.queryPBF(e)),i}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return this.databaseType().then((function(s){if(i.isTable()&&t&&null!==e&&""!==e)return new O.a([],[],!0,null);if(i._canUsePagination())return i._getFilteredSetUsingPaging(e,t,r,a,n);var l="",u=!1;null!==a&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(l=a.constructClause(),u=!0);var o=new M.a;return o.where=null===r?null===t?"1=1":"":Object(k.i)(r,s),i._requestStandardised&&(o.sqlFormat="standard"),o.spatialRelationship=i._makeRelationshipEnum(e),o.outSpatialReference=i.spatialReference,o.orderByFields=""!==l?l.split(","):null,o.geometry=null===t?null:t,o.relationParameter=i._makeRelationshipParam(e),i.executeQuery(o,"executeForIds").then((function(e){return null===e&&(e=[]),i._checkCancelled(n),new O.a([],e,u,null)}))}))}},{key:"_expandPagedSet",value:function(e,t,r,a,n){return this._expandPagedSetFeatureSet(e,t,r,a,n)}},{key:"_getFilteredSetUsingPaging",value:function(e,t,r,a,n){var i=this;try{var s="",l=!1;return null!==a&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(s=a.constructClause(),l=!0),this.databaseType().then((function(a){var u=null===r?null===t?"1=1":"":Object(k.i)(r,a);i._layer.definitionExpression&&(u=""!==u?"(("+i._layer.definitionExpression+") AND ("+u+"))":i._layer.definitionExpression);var o=i._maxQueryRate(),c=i._layer.capabilities.query.maxRecordCount;void 0!==c&&c<o&&(o=c);var d=null;if(!0===i._pageJustIds)d=new O.a([],["GETPAGES"],l,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:i._layer.objectIdField,resultRecordCount:o,resultOffset:0,geometry:null===t?null:t,where:u,orderByFields:s,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{var f=!0;!0===i._removeGeometry&&(f=!1);var h=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._layer.outFields?i._layer.outFields:["*"]);d=new O.a([],["GETPAGES"],l,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:h.join(","),resultRecordCount:o,resultOffset:0,geometry:null===t?null:t,where:u,orderByFields:s,returnGeometry:f,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return i._expandPagedSet(d,o,0,1,n).then((function(){return d}))}))}catch(u){return Object(o.r)(u)}}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}},{key:"_getPhysicalPage",value:function(e,t,r){var a=this;try{var n=e.pagesDefinition.internal.lastRetrieved,i=n,s=e.pagesDefinition.internal.lastPage,l=new M.a;return this._requestStandardised&&(l.sqlFormat="standard"),l.spatialRelationship=e.pagesDefinition.spatialRel,l.relationParameter=e.pagesDefinition.relationParam,l.outFields=e.pagesDefinition.outFields.split(","),l.num=e.pagesDefinition.resultRecordCount,l.start=e.pagesDefinition.internal.lastPage,l.geometry=e.pagesDefinition.geometry,l.where=e.pagesDefinition.where,l.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,l.returnGeometry=e.pagesDefinition.returnGeometry,l.outSpatialReference=this.spatialReference,this.executeQuery(l,"execute").then((function(t){if(a._checkCancelled(r),e.pagesDefinition.internal.lastPage!==s)return"done";for(var l=0;l<t.features.length;l++)e.pagesDefinition.internal.set[i+l]=t.features[l].attributes[a._layer.objectIdField];if(!1===a._pageJustIds)for(var u=0;u<t.features.length;u++)a._featureCache[t.features[u].attributes[a._layer.objectIdField]]=t.features[u];return(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=n+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"}))}catch(u){return Object(o.r)(u)}}},{key:"_fieldsIncludingObjectId",value:function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;var r,a=!1,n=Object(u.a)(t);try{for(n.s();!(r=n.n()).done;){if(r.value.toUpperCase()===this.objectIdField.toUpperCase()){a=!0;break}}}catch(i){n.e(i)}finally{n.f()}return!1===a&&t.push(this.objectIdField),t}},{key:"_getFeatures",value:function(e,t,r,a){var n=this,i=[];try{if(-1!==t&&void 0===this._featureCache[t]&&i.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,a).then((function(){return n._getFeatures(e,t,r,a)}));for(var s=0,l=e._lastFetchedIndex;l<e._known.length;l++){if(e._lastFetchedIndex+=1,s++,void 0===this._featureCache[e._known[l]]){var u=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var c=this._layer._mode;if(void 0!==c._featureMap[e._known[l]]){var d=c._featureMap[e._known[l]];null!==d&&(u=!0,this._featureCache[e._known[l]]=d)}}if(!1===u&&(e._known[l]!==t&&i.push(e._known[l]),i.length>=this._maxProcessingRate()-1))break}if(s>=r&&0===i.length)break}if(0===i.length)return Object(o.s)("success");try{var f=new M.a;return this._requestStandardised&&(f.sqlFormat="standard"),f.objectIds=i,f.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),f.returnGeometry=!0,!0===this._removeGeometry&&(f.returnGeometry=!1),f.outSpatialReference=this.spatialReference,this.executeQuery(f,"execute").then((function(e){if(n._checkCancelled(a),void 0!==e.error)return Object(o.r)(new Error(e.error));for(var t=0;t<e.features.length;t++)n._featureCache[e.features[t].attributes[n._layer.objectIdField]]=e.features[t];return"success"}))}catch(h){return Object(o.r)(h)}}catch(h){return Object(o.r)(h)}}},{key:"_getDistinctPages",value:function(e,t,r,a,n,i,s,l,u){var c=this;return this._ensureLoaded().then((function(){return c.databaseType()})).then((function(d){for(var f=r.parseTree.column,h=0;h<c._layer.fields.length;h++)if(c._layer.fields[h].name.toLowerCase()===f.toLowerCase()){f=c._layer.fields[h].name;break}var y=new M.a;c._requestStandardised&&(y.sqlFormat="standard");var p=null===i?null===n?"1=1":"":Object(k.i)(i,d);return c._layer.definitionExpression&&(p=""!==p?"(("+c._layer.definitionExpression+") AND ("+p+"))":c._layer.definitionExpression),y.where=p,y.spatialRelationship=c._makeRelationshipEnum(a),y.relationParameter=c._makeRelationshipParam(a),y.geometry=null===n?null:n,y.returnDistinctValues=!0,y.returnGeometry=!1,y.outFields=[f],c.executeQuery(y,"execute").then((function(d){if(c._checkCancelled(u),!d.hasOwnProperty("features"))return Object(o.r)(new Error("Unnexected Result querying statistics from layer"));for(var h=!1,y=0;y<c._layer.fields.length;y++)if(c._layer.fields[y].name===f){"date"===c._layer.fields[y].type&&(h=!0);break}for(var p=0;p<d.features.length;p++){if(h){var _=d.features[p].attributes[f];null!==_?l.push(new Date(_)):l.push(_)}else l.push(d.features[p].attributes[f]);if(l.length>=s)break}return 0===d.features.length?l:d.features.length===c._layer.capabilities.query.maxRecordCount&&l.length<s?c._getDistinctPages(e+d.features.length,t,r,a,n,i,s,l,u).then((function(e){return{calculated:!0,result:e}})):l}))}))}},{key:"_distinctStat",value:function(e,t,r,a,n,i,s){return this._getDistinctPages(0,e,t,r,a,n,i,[],s).then((function(e){return{calculated:!0,result:e}}))}},{key:"isTable",value:function(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}},{key:"_countstat",value:function(e,t,r,a){var n=this;return this.databaseType().then((function(e){var i=new M.a;if(n._requestStandardised&&(i.sqlFormat="standard"),n.isTable()&&r&&null!==t&&""!==t)return{calculated:!0,result:0};var s=null===a?null===r?"1=1":"":Object(k.i)(a,e);return n._layer.definitionExpression&&(s=""!==s?"(("+n._layer.definitionExpression+") AND ("+s+"))":n._layer.definitionExpression),i.where=s,i.where=s,i.spatialRelationship=n._makeRelationshipEnum(t),i.relationParameter=n._makeRelationshipParam(t),i.geometry=null===r?null:r,i.returnGeometry=!1,n.executeQuery(i,"executeForCount").then((function(e){return{calculated:!0,result:e}}))}))}},{key:"_stats",value:function(e,t,r,a,n,i,s){var l=this;return this._ensureLoaded().then((function(){var u=l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsSqlExpression,c=l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsStatistics,d=l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsDistinct;return"count"===e?d?l._countstat(e,r,a,n):{calculated:!1}:!1===c||!1===Object(k.c)(t)&&!1===u||!1===t.isStandardized?""!==r||null!==n?{calculated:!1}:l._manualStat(e,t,i,s):"distinct"===e?!1===d?""!==r||null!==n?{calculated:!1}:l._manualStat(e,t,i,s):l._distinctStat(e,t,r,a,n,i,s):l.databaseType().then((function(i){if(l.isTable()&&a&&null!==r&&""!==r)return{calculated:!0,result:null};var s=new M.a;l._requestStandardised&&(s.sqlFormat="standard");var u=null===n?null===a?"1=1":"":Object(k.i)(n,i);l._layer.definitionExpression&&(u=""!==u?"(("+l._layer.definitionExpression+") AND ("+u+"))":l._layer.definitionExpression),s.where=u,s.spatialRelationship=l._makeRelationshipEnum(r),s.relationParameter=l._makeRelationshipParam(r),s.geometry=null===a?null:a;var c=new W.a;c.statisticType=Object(j.c)(e),c.onStatisticField=Object(k.i)(t,i),c.outStatisticFieldName="ARCADE_STAT_RESULT",s.returnGeometry=!1;var d="ARCADE_STAT_RESULT";return s.outStatistics=[c],l.executeQuery(s,"execute").then((function(e){if(!e.hasOwnProperty("features")||0===e.features.length)return Object(o.r)(new Error("Unnexected Result querying statistics from layer"));for(var t=!1,r=0;r<e.fields.length;r++)if("ARCADE_STAT_RESULT"===e.fields[r].name.toUpperCase()){d=e.fields[r].name,"date"===e.fields[r].type&&(t=!0);break}if(t){var a=e.features[0].attributes[d];return null!==a&&(a=new Date(e.features[0].attributes[d])),{calculated:!0,result:a}}return{calculated:!0,result:e.features[0].attributes[d]}}))}))}))}},{key:"_stat",value:function(e,t,r,a,n,i,s){return this._stats(e,t,r,a,n,i,s)}},{key:"_canDoAggregates",value:function(e,t){var r=this;return this._ensureLoaded().then((function(){var e=!1,a=r._layer.capabilities&&r._layer.capabilities.query&&!0===r._layer.capabilities.query.supportsSqlExpression;if(void 0!==r._layer.capabilities&&null!==r._layer.capabilities.query&&!0===r._layer.capabilities.query.supportsStatistics&&!0===r._layer.capabilities.query.supportsOrderBy&&(e=!0),e)for(var n=0;n<t.length-1;n++)null!==t[n].workingexpr&&(!1===t[n].workingexpr.isStandardized||!1===Object(k.c)(t[n].workingexpr)&&!1===a)&&(e=!1);return!1!==e}))}},{key:"_makeRelationshipEnum",value:function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}},{key:"_makeRelationshipParam",value:function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,a,n,i,s){var l=this;return this._ensureLoaded().then((function(){return l.databaseType()})).then((function(u){var o="",c=!1,d=!1;null!==i&&l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsOrderBy&&(o=i.constructClause(),d=!0),l._layer.capabilities&&l._layer.capabilities.query&&!1===l._layer.capabilities.query.supportsPagination&&(d=!1,c=!0,o=l._layer.objectIdField);for(var f=[],h=0;h<t.length;h++){var y=new W.a;y.onStatisticField=null!==t[h].workingexpr?Object(k.i)(t[h].workingexpr,u):"",y.outStatisticFieldName=t[h].field,y.statisticType=t[h].toStatisticsName(),f.push(y)}""===o&&(o=e.join(","));var p=l._maxQueryRate(),_=l._layer.capabilities.query.maxRecordCount;void 0!==_&&_<p&&(p=_);var v=null===n?null===a?"1=1":"":Object(k.i)(n,u);return l._layer.definitionExpression&&(v=""!==v?"(("+l._layer.definitionExpression+") AND ("+v+"))":l._layer.definitionExpression),new O.a([],["GETPAGES"],d,{groupbypage:!0,spatialRel:l._makeRelationshipEnum(r),relationParam:l._makeRelationshipParam(r),outFields:["*"],useOIDpagination:c,generatedOid:s,resultRecordCount:p,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:f,geometry:null===a?null:a,where:v,orderByFields:o,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}))}},{key:"_getAgregagtePhysicalPage",value:function(e,t,r){var a=this;try{var n=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(n=""!==n?"("+n+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());var i=e.pagesDefinition.internal.lastRetrieved,s=i,l=e.pagesDefinition.internal.lastPage,u=new M.a;return this._requestStandardised&&(u.sqlFormat="standard"),u.where=n,u.spatialRelationship=e.pagesDefinition.spatialRel,u.relationParameter=e.pagesDefinition.relationParam,u.outFields=e.pagesDefinition.outFields,u.outStatistics=e.pagesDefinition.outStatistics,u.geometry=e.pagesDefinition.geometry,u.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,u.num=e.pagesDefinition.resultRecordCount,u.start=e.pagesDefinition.internal.lastPage,u.returnGeometry=e.pagesDefinition.returnGeometry,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&u.geometry&&u.spatialRelationship?Object(o.s)([]):this.executeQuery(u,"execute").then((function(t){if(a._checkCancelled(r),!t.hasOwnProperty("features"))return Object(o.r)(new Error("Unnexected Result querying aggregates from layer"));var n=[];if(e.pagesDefinition.internal.lastPage!==l)return[];for(var u=0;u<t.features.length;u++)e.pagesDefinition.internal.set[s+u]=t.features[u].attributes[e.pagesDefinition.generatedOid];for(var c=0;c<t.features.length;c++)n.push(new F.a({attributes:t.features[c].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,n}))}catch(c){return Object(o.r)(c)}}},{key:"relationshipMetaData",value:function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}},{key:"serviceUrl",value:function(){return Object(y.i)(this._layer.parsedUrl.path)}},{key:"queryAttachments",value:function(e,t,r,a){var n=this;if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){var i={objectIds:[e]};return(t&&t>0||r&&r>0)&&(i.size=[t&&t>0?t:0,r&&r>0?r:t+1]),a&&a.length>0&&(i.attachmentTypes=a),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:i,method:"attachments"}),this._layer.queryAttachments(i).then((function(t){var r=[];return t&&t[e]&&t[e].forEach((function(t){var a=n._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString();r.push(new G.a(t.id,t.name,t.contentType,t.size,a))})),r}))}return Object(o.s)([])}},{key:"queryRelatedFeatures",value:function(e){var t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return void 0!==e.resultOffset&&null!==e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJSON())),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:t,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"}),Object(d.default)(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:t}).then((function(e){if(e.data){var t={},r=e.data;if(r&&r.relatedRecordGroups){var a,n=r.spatialReference,i=Object(u.a)(r.relatedRecordGroups);try{for(i.s();!(a=i.n()).done;){var s,l=a.value,c=l.objectId,d=[],f=Object(u.a)(l.relatedRecords);try{for(f.s();!(s=f.n()).done;){var h=s.value;h.geometry&&(h.geometry.spatialReference=n);var y=new F.a({geometry:h.geometry?Object(q.a)(h.geometry):null,attributes:h.attributes});d.push(y)}}catch(p){f.e(p)}finally{f.f()}t[c]={features:d,exceededTransferLimit:!0===r.exceededTransferLimit}}}catch(p){i.e(p)}finally{i.f()}}return t}return Object(o.r)("Invalid Request")}))}},{key:"getFeatureByObjectId",value:function(e,t){var r=new J.a({url:this._layer.parsedUrl.path}),a=new M.a;return a.outFields=t,a.returnGeometry=!1,a.outSpatialReference=this.spatialReference,a.where=this.objectIdField+"="+e.toString(),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:a,method:"execute"}),r.execute(a).then((function(e){return 1===e.features.length?e.features[0]:null}))}},{key:"getIdentityUser",value:function(){var e=this;return this.load().then((function(){var t,r=null==(t=c.b)?void 0:t.findCredential(e._layer.url);return r?r.userId:null}))}},{key:"getOwningSystemUrl",value:function(){var e=this;return this.load().then((function(){var t,r=null==(t=c.b)?void 0:t.findServerInfo(e._layer.url);if(r)return Object(o.s)(r.owningSystemUrl);var a=e._layer.url,n=a.toLowerCase().indexOf("/rest/services");return(a=n>-1?a.substring(0,n):a)?(a+="/rest/info",Object(o.c)((function(e,t){Object(d.default)(a,{query:{f:"json"}}).then((function(t){var r="";t.data&&t.data.owningSystemUrl&&(r=t.data.owningSystemUrl),e(r)}),(function(t){e("")}))}))):Object(o.s)("")}))}}],[{key:"create",value:function(e,t,a,n,i){return new r({layer:new L.default({url:e,outFields:null===t?["*"]:t}),spatialReference:a,lrucache:n,interceptor:i})}}]),r}(C.a),z=r(1108),Z=r(238),H=function(e){Object(s.a)(r,e);var t=Object(l.a)(r);function r(e){var a;return Object(n.a)(this,r),(a=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",a._findObjectId=-1,a._requestStandardised=!1,a._removeGeometry=!1,a._overrideFields=null,a.featureObjectId=null,a.relatedLayer=null,a.relationship=null,e.spatialReference&&(a.spatialReference=e.spatialReference),a._transparent=!0,a._maxProcessing=1e3,a._layer=e.layer,a._wset=null,a._findObjectId=e.objectId,a.featureObjectId=e.objectId,a.relationship=e.relationship,a.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(a._overrideFields=e.outFields),void 0!==e.includeGeometry&&(a._removeGeometry=!1===e.includeGeometry),a}return Object(i.a)(r,[{key:"_maxQueryRate",value:function(){return y.f}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(o.c)((function(t,r){Object(o.b)([e._layer.load(),e.relatedLayer.load()]).then((function(){e._initialiseFeatureSet(),t(e)}),r)}))),this._loadPromise}},{key:"nativeCapabilities",value:function(){return this.relatedLayer.nativeCapabilities()}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var e,t=[],r=[],a=Object(u.a)(this.fields);try{for(a.s();!(e=a.n()).done;){var n=e.value;if("oid"===n.type)t.push(n),r.push(n.name);else{var i,s=Object(u.a)(this._overrideFields);try{for(s.s();!(i=s.n()).done;){if(i.value.toLowerCase()===n.name.toLowerCase()){t.push(n),r.push(n.name);break}}}catch(o){s.e(o)}finally{s.f()}}}}catch(o){a.e(o)}finally{a.f()}this.fields=t,this._overrideFields=r}var l=this._layer.nativeCapabilities();l&&(this._databaseType=l.databaseType,this._requestStandardised=l.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}},{key:"databaseType",value:function(){var e=this;return this.relatedLayer.databaseType().then((function(){return e._databaseType=e.relatedLayer._databaseType,e._databaseType}))}},{key:"isTable",value:function(){return this.relatedLayer.isTable()}},{key:"_isInFeatureSet",value:function(){return y.b.InFeatureSet}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):Object(o.s)(this._wset)}},{key:"_changeFeature",value:function(e){var t,r={},a=Object(u.a)(this.fields);try{for(a.s();!(t=a.n()).done;){var n=t.value;r[n.name]=e.attributes[n.name]}}catch(i){a.e(i)}finally{a.f()}return new F.a({geometry:!0===this._removeGeometry?null:e.geometry,attributes:r})}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return this.databaseType().then((function(){if(i.isTable()&&t&&null!==e&&""!==e)return new O.a([],[],!0,null);var s=i._layer.nativeCapabilities();if(!1===s.canQueryRelated)return new O.a([],[],!0,null);if(s.capabilities.queryRelated&&s.capabilities.queryRelated.supportsPagination)return i._getFilteredSetUsingPaging(e,t,r,a,n);var l="",u=!1;null!==a&&s.capabilities&&s.capabilities.queryRelated&&!0===s.capabilities.queryRelated.supportsOrderBy&&(l=a.constructClause(),u=!0);var o=new Z.a;o.objectIds=[i._findObjectId];var c=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map((function(e){return e.name})):["*"]);o.outFields=c,o.relationshipId=i.relationship.id,o.where="1=1";var d=!0;return!0===i._removeGeometry&&(d=!1),o.returnGeometry=d,i._requestStandardised&&(o.sqlFormat="standard"),o.outSpatialReference=i.spatialReference,o.orderByFields=""!==l?l.split(","):null,s.source.queryRelatedFeatures(o).then((function(a){i._checkCancelled(n);for(var s=a[i._findObjectId]?a[i._findObjectId].features:[],l=[],o=0;o<s.length;o++)i._featureCache[s[o].attributes[i._layer.objectIdField]]=s[o],l.push(s[o].attributes[i._layer.objectIdField]);var c=t&&null!==e&&""!==e,d=null!=r;return new O.a(c||d?l:[],c||d?[]:l,u,null)}))}))}},{key:"_fieldsIncludingObjectId",value:function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;var r,a=!1,n=Object(u.a)(t);try{for(n.s();!(r=n.n()).done;){if(r.value.toUpperCase()===this.objectIdField.toUpperCase()){a=!0;break}}}catch(i){n.e(i)}finally{n.f()}return!1===a&&t.push(this.objectIdField),t}},{key:"_getFilteredSetUsingPaging",value:function(e,t,r,a,n){var i=this;try{var s="",l=!1,u=this._layer.nativeCapabilities();return null!==a&&u&&u.capabilities.queryRelated&&!0===u.capabilities.queryRelated.supportsOrderBy&&(s=a.constructClause(),l=!0),this.databaseType().then((function(){var a=i._maxQueryRate(),o=u.capabilities.query.maxRecordCount;void 0!==o&&o<a&&(a=o);var c,d=t&&null!==e&&""!==e,f=null!=r,h=!0;!0===i._removeGeometry&&(h=!1);var y=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map((function(e){return e.name})):["*"]);return c=new O.a(d||f?["GETPAGES"]:[],d||f?[]:["GETPAGES"],l,{outFields:y.join(","),resultRecordCount:a,resultOffset:0,objectIds:[i._findObjectId],where:"1=1",orderByFields:s,returnGeometry:h,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),i._expandPagedSet(c,a,0,0,n).then((function(){return c}))}))}catch(c){return Object(o.r)(c)}}},{key:"_expandPagedSet",value:function(e,t,r,a,n){return this._expandPagedSetFeatureSet(e,t,r,a,n)}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}},{key:"_getPhysicalPage",value:function(e,t,r){var a=this;try{var n=e.pagesDefinition.internal.lastRetrieved,i=n,s=e.pagesDefinition.internal.lastPage,l=this._layer.nativeCapabilities(),u=new Z.a;return!0===this._requestStandardised&&(u.sqlFormat="standard"),u.relationshipId=this.relationship.id,u.objectIds=e.pagesDefinition.objectIds,u.resultOffset=e.pagesDefinition.internal.lastPage,u.resultRecordCount=e.pagesDefinition.resultRecordCount,u.outFields=e.pagesDefinition.outFields.split(","),u.where=e.pagesDefinition.where,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,u.returnGeometry=e.pagesDefinition.returnGeometry,u.outSpatialReference=this.spatialReference,l.source.queryRelatedFeatures(u).then((function(t){if(a._checkCancelled(r),e.pagesDefinition.internal.lastPage!==s)return 0;for(var l=t[a._findObjectId]?t[a._findObjectId].features:[],u=0;u<l.length;u++)e.pagesDefinition.internal.set[i+u]=l[u].attributes[a._layer.objectIdField];for(var o=0;o<l.length;o++)a._featureCache[l[o].attributes[a._layer.objectIdField]]=l[o];var c=!t[a._findObjectId]||!1===t[a._findObjectId].exceededTransferLimit;return l.length!==e.pagesDefinition.resultRecordCount&&c&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=n+l.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,l.length}))}catch(c){return Object(o.r)(c)}}},{key:"_getFeatures",value:function(e,t,r,a){var n=this,i=[];-1!==t&&void 0===this._featureCache[t]&&i.push(t);var s=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,s))return this._expandPagedSet(e,s,0,0,a).then((function(){return n._getFeatures(e,t,r,a)}));for(var l=0,u=e._lastFetchedIndex;u<e._known.length&&(++l<=r&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[u]&&void 0===this._featureCache[e._known[u]]&&(e._known[u]!==t&&i.push(e._known[u]),i.length>r)))&&!(l>=r&&0===i.length);u++);return 0===i.length?Object(o.s)("success"):Object(o.r)(new Error("Unaccounted for Features. Not in Feature Collection"))}},{key:"_refineSetBlock",value:function(e,t,r){return Object(o.s)(e)}},{key:"_stat",value:function(e,t,r,a,n,i,s){return Object(o.s)({calculated:!1})}},{key:"gdbVersion",get:function(){return this.relatedLayer.gdbVersion}},{key:"_canDoAggregates",value:function(e,t,r,a,n){return Object(o.s)(!1)}},{key:"relationshipMetaData",value:function(){return this.relatedLayer.relationshipMetaData()}},{key:"serviceUrl",value:function(){return this.relatedLayer.serviceUrl()}},{key:"queryAttachments",value:function(e,t,r,a){return this.relatedLayer.queryAttachments(e,t,r,a)}},{key:"getFeatureByObjectId",value:function(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}},{key:"getOwningSystemUrl",value:function(){return this.relatedLayer.getOwningSystemUrl()}},{key:"getIdentityUser",value:function(){return this.relatedLayer.getIdentityUser()}}]),r}(C.a);function X(){null===_.a.applicationCache&&(_.a.applicationCache=new _.a)}function Y(e,t){if(_.a.applicationCache){var r=_.a.applicationCache.getLayerInfo(e);if(r)return r.then((function(r){return Object(o.s)(new L.default({url:e,outFields:t,sourceJSON:r}))}));var a=new L.default({url:e,outFields:t}),n=Object(o.c)((function(e,t){a.load().then((function(){e(a.sourceJSON)}),(function(e){t(e)}))}));return _.a.applicationCache&&(_.a.applicationCache.setLayerInfo(e,n),n=n.catch((function(t){throw _.a.applicationCache.clearLayerInfo(e),t}))),n.then((function(){return Object(o.s)(a)}))}return Object(o.s)(new L.default({url:e,outFields:t}))}function $(e,t,r,a,n){var i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;return Y(e,["*"]).then((function(e){return Object(o.s)(ee(e,t,r,a,n,i))}))}function ee(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;return!0===e._hasMemorySource()?new z.a({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n,interceptor:i}):new K({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n,interceptor:i})}function te(e){if(null!==_.a.applicationCache){var t=_.a.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=Object(d.default)(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),Object(o.s)(t)}return Object(o.s)({layers:[],tables:[]})}));return null!==_.a.applicationCache&&(_.a.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw _.a.applicationCache.clearLayerInfo(e),t}))),r}function re(e,t){var r={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return te(e).then((function(a){if(r.metadata=a,a.controllerDatasetLayers&&void 0!==a.controllerDatasetLayers.utilityNetworkLayerId&&null!==a.controllerDatasetLayers.utilityNetworkLayerId){if(a.layers){var n,i=Object(u.a)(a.layers);try{for(i.s();!(n=i.n()).done;){var s=n.value;r.layerNameLkp[s.id]=s.name}}catch(y){i.e(y)}finally{i.f()}}if(a.tables){var l,c=Object(u.a)(a.tables);try{for(c.s();!(l=c.n()).done;){var f=l.value;r.layerNameLkp[f.id]=f.name}}catch(y){c.e(y)}finally{c.f()}}var h=a.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=h,function(e,t){var r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==_.a.applicationCache){var a=_.a.applicationCache.getLayerInfo(r);if(null!==a)return a}var n=Object(d.default)(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((function(e){if(e.data){var t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==_.a.applicationCache&&(_.a.applicationCache.setLayerInfo(r,n),n=n.catch((function(e){throw _.a.applicationCache.clearLayerInfo(r),e}))),n}(e,h).then((function(a){if(a){r.queryelem=a,r.queryelem&&r.queryelem.dataElement&&void 0!==r.queryelem.dataElement.schemaGeneration&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);var n,i=Object(u.a)(r.queryelem.dataElement.domainNetworks);try{for(i.s();!(n=i.n()).done;){var s,l=n.value,c=Object(u.a)(l.edgeSources?l.edgeSources:[]);try{for(c.s();!(s=c.n()).done;){var f=s.value,p={layerId:f.layerId,sourceId:f.sourceId,className:r.layerNameLkp[f.layerId]?r.layerNameLkp[f.layerId]:null};p.className&&(r.lkp[p.className]=p)}}catch(y){c.e(y)}finally{c.f()}var g,b=Object(u.a)(l.junctionSources?l.junctionSources:[]);try{for(b.s();!(g=b.n()).done;){var m=g.value,F={layerId:m.layerId,sourceId:m.sourceId,className:r.layerNameLkp[m.layerId]?r.layerNameLkp[m.layerId]:null};F.className&&(r.lkp[F.className]=F)}}catch(y){b.e(y)}finally{b.f()}}}catch(y){i.e(y)}finally{i.f()}if(r.queryelem.dataElement.terminalConfigurations){var w,S=Object(u.a)(r.queryelem.dataElement.terminalConfigurations);try{for(S.s();!(w=S.n()).done;){var O,k=w.value,j=Object(u.a)(k.terminals);try{for(j.s();!(O=j.n()).done;){var I=O.value;r.terminals.push({terminalId:I.terminalId,terminalName:I.terminalName})}}catch(y){j.e(y)}finally{j.f()}}}catch(y){S.e(y)}finally{S.f()}}return function(e){if(null!==_.a.applicationCache){var t=_.a.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=Object(d.default)(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return Object(o.s)(t)}return Object(o.s)(null)}));return null!==_.a.applicationCache&&(_.a.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw _.a.applicationCache.clearLayerInfo(e),t}))),r}(e+"/"+h).then((function(a){if(a.systemLayers&&void 0!==a.systemLayers.associationsTableId&&null!==a.systemLayers.associationsTableId){var n=[];return r.unVersion>=4&&(n.push("STATUS"),n.push("PERCENTALONG")),$(e+"/"+a.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"].concat(n),!1,null,null).then((function(e){return e.load()})).then((function(e){return r.unVersion>=4?(e=e.filter(v.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e})).then((function(e){return{lkp:r.lkp,associations:e,unVersion:r.unVersion,terminals:r.terminals}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}function ae(e,t,r){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,u=e.serviceUrl();return u?$(u="/"===u.charAt(u.length-1)?u+t.relatedTableId.toString():u+"/"+t.relatedTableId.toString(),a,n,i,s,l).then((function(u){return new H({layer:e,relatedLayer:u,relationship:t,objectId:r,spatialReference:a,outFields:n,includeGeometry:i,lrucache:s,interceptor:l})})):null}g.a.registerAction(),E.registerAction(),b.a.registerAction(),P.a.registerAction(),A.a.registerAction();var ne=function(e){Object(s.a)(r,e);var t=Object(l.a)(r);function r(e){var a,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return Object(n.a)(this,r),(a=t.call(this))._map=e,a._overridespref=i,a.lrucache=s,a.interceptor=l,a._instantLayers=[],a}return Object(i.a)(r,[{key:"makeAndAddFeatureSet",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=ee(e,this._overridespref,null===r?["*"]:r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a}},{key:"featureSetByName",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return t.featureSetByName(e,r,n)}catch(i){return Object(o.r)(i)}}));null===n&&(n=["*"]),n=(n=n.slice(0)).sort();for(var i=JSON.stringify(n),s=0;s<this._instantLayers.length;s++){var l=this._instantLayers[s];if(l.opitem.title===e&&l.includeGeometry===r&&l.outFields===i)return this.resolvePromise(this._instantLayers[s].featureset)}var u=this._map.layers.find((function(t){return t instanceof L.default&&t.title===e}));if(u)return this.resolvePromise(this.makeAndAddFeatureSet(u,r,n));if(this._map.tables){var c=this._map.tables.find((function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)}));if(c){if(c instanceof L.default)return this.resolvePromise(this.makeAndAddFeatureSet(c,r,n));if(c._materializedTable);else{var d=c.outFields?c:Object(a.a)(Object(a.a)({},c),{},{outFields:["*"]});c._materializedTable=new L.default(d)}return c._materializedTable.load().then((function(){return t.resolvePromise(t.makeAndAddFeatureSet(c._materializedTable,r,n))}))}}return this.resolvePromise(null)}},{key:"featureSetById",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"];if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return t.featureSetById(e,r,n)}catch(i){return Object(o.r)(i)}}));null===n&&(n=["*"]),n=(n=n.slice(0)).sort();for(var i=JSON.stringify(n),s=0;s<this._instantLayers.length;s++){var l=this._instantLayers[s];if(l.opitem.id===e&&l.includeGeometry===r&&l.outFields===i)return this.resolvePromise(this._instantLayers[s].featureset)}var u=this._map.layers.find((function(t){return t instanceof L.default&&t.id===e}));if(u)return this.resolvePromise(this.makeAndAddFeatureSet(u,r,n));if(this._map.tables){var c=this._map.tables.find((function(t){return t.id===e}));if(c){if(c instanceof L.default)return this.resolvePromise(this.makeAndAddFeatureSet(c,r,n));if(c._materializedTable);else{var d=Object(a.a)(Object(a.a)({},c),{},{outFields:["*"]});c._materializedTable=new L.default(d)}return c._materializedTable.load().then((function(){return t.resolvePromise(t.makeAndAddFeatureSet(c._materializedTable,r,n))}))}}return this.resolvePromise(null)}}]),r}(p.a),ie=function(e){Object(s.a)(r,e);var t=Object(l.a)(r);function r(e){var a,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return Object(n.a)(this,r),(a=t.call(this))._url=e,a._overridespref=i,a.lrucache=s,a.interceptor=l,a.metadata=null,a._instantLayers=[],a}return Object(i.a)(r,[{key:"url",get:function(){return this._url}},{key:"makeAndAddFeatureSet",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=ee(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a}},{key:"_loadMetaData",value:function(){var e=this;return te(this._url).then((function(t){return e.metadata=t,t}))}},{key:"load",value:function(){return this._loadMetaData()}},{key:"clone",value:function(){return new r(this._url,this._overridespref,this.lrucache,this.interceptor)}},{key:"featureSetByName",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var n=JSON.stringify(a),i=0;i<this._instantLayers.length;i++){var s=this._instantLayers[i];if(s.opitem.title===e&&s.includeGeometry===r&&s.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(n){var i,s=null,l=Object(u.a)(n.layers?n.layers:[]);try{for(l.s();!(i=l.n()).done;){var o=i.value;o.name===e&&(s=o)}}catch(h){l.e(h)}finally{l.f()}if(!s){var c,d=Object(u.a)(n.tables?n.tables:[]);try{for(d.s();!(c=d.n()).done;){var f=c.value;f.name===e&&(s=f)}}catch(h){d.e(h)}finally{d.f()}}return s?Y(t._url+"/"+s.id,["*"]).then((function(e){return t.makeAndAddFeatureSet(e,r,a)})):t.resolvePromise(null)}))}},{key:"featureSetById",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"];null===a&&(a=["*"]),a=(a=a.slice(0)).sort();var n=JSON.stringify(a);e=null!=e?e.toString():"";for(var i=0;i<this._instantLayers.length;i++){var s=this._instantLayers[i];if(s.opitem.id===e&&s.includeGeometry===r&&s.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(n){var i,s=null,l=Object(u.a)(n.layers?n.layers:[]);try{for(l.s();!(i=l.n()).done;){var o=i.value;null!==o.id&&void 0!==o.id&&o.id.toString()===e&&(s=o)}}catch(h){l.e(h)}finally{l.f()}if(!s){var c,d=Object(u.a)(n.tables?n.tables:[]);try{for(d.s();!(c=d.n()).done;){var f=c.value;null!==f.id&&void 0!==f.id&&f.id.toString()===e&&(s=f)}}catch(h){d.e(h)}finally{d.f()}}return s?Y(t._url+"/"+s.id,["*"]).then((function(e){return t.makeAndAddFeatureSet(e,r,a)})):t.resolvePromise(null)}))}}]),r}(p.a);function se(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return new ne(e,t,r,a)}function le(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return new ie(e,t,r,a)}function ue(e,t){return null===e?t:new f.a({url:e.field("url")})}function oe(e,t,r){return c.b.findCredential(e.restUrl)?"loaded"===e.loadStatus&&""===t&&e.user&&e.user.sourceJSON&&!1===r?Object(o.s)(e.user.sourceJSON):""===t?Object(d.default)(e.restUrl+"/community/self",{responseType:"json",query:Object(a.a)({f:"json"},!1===r?{}:{returnUserLicenseTypeExtensions:!0})}).then((function(e){if(e.data){var t=e.data;if(t&&t.username)return Object(o.s)(t)}return Object(o.s)(null)})):Object(d.default)(e.restUrl+"/community/users/"+t,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.error?null:Object(o.s)(t)}return Object(o.s)(null)})):Object(o.s)(null)}function ce(e,t,r,a,n,i,s){var l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(_.a.applicationCache){var u=_.a.applicationCache.getLayerInfo(e+":"+i.url);if(u)return u.then((function(i){try{var u=new L.default({url:Object(y.i)(i.url)+"/"+t,outFields:["*"]});return Object(o.s)(ee(u,r,a,n,s,l))}catch(e){return Object(o.r)(e)}}),(function(e){return Object(o.r)(e)}))}return Object(o.c)((function(u,o){var c=new h.default({id:e,portal:i}).load();_.a.applicationCache&&_.a.applicationCache.setLayerInfo(e+":"+i.url,c),c.then((function(i){try{var c=new L.default({url:Object(y.i)(i.url)+"/"+t,outFields:["*"]});u(ee(c,r,a,n,s,l))}catch(e){o(e)}}),(function(t){_.a.applicationCache&&_.a.applicationCache.clearLayerInfo(e+":"+i.url),o(t)}))}))}},977:function(e,t,r){"use strict";r.d(t,"a",(function(){return p})),r.d(t,"b",(function(){return a}));var a={Base64:0,Hex:1,String:2,Raw:3};function n(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function i(e){for(var t=[],r=0,a=8*e.length;r<a;r+=8)t[r>>5]|=(255&e.charCodeAt(r/8))<<r%32;return t}function s(e){for(var t=[],r=0,a=32*e.length;r<a;r+=8)t.push(String.fromCharCode(e[r>>5]>>>r%32&255));return t.join("")}function l(e){for(var t="0123456789abcdef",r=[],a=0,n=4*e.length;a<n;a++)r.push(t.charAt(e[a>>2]>>a%4*8+4&15)+t.charAt(e[a>>2]>>a%4*8&15));return r.join("")}function u(e){for(var t=[],r=0,a=4*e.length;r<a;r+=3)for(var n=(e[r>>2]>>r%4*8&255)<<16|(e[r+1>>2]>>(r+1)%4*8&255)<<8|e[r+2>>2]>>(r+2)%4*8&255,i=0;i<4;i++)8*r+6*i>32*e.length?t.push("="):t.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(n>>6*(3-i)&63));return t.join("")}function o(e,t,r,a,i,s){return n(function(e,t){return e<<t|e>>>32-t}(n(n(t,e),n(a,s)),i),r)}function c(e,t,r,a,n,i,s){return o(t&r|~t&a,e,t,n,i,s)}function d(e,t,r,a,n,i,s){return o(t&a|r&~a,e,t,n,i,s)}function f(e,t,r,a,n,i,s){return o(t^r^a,e,t,n,i,s)}function h(e,t,r,a,n,i,s){return o(r^(t|~a),e,t,n,i,s)}function y(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var r=1732584193,a=-271733879,i=-1732584194,s=271733878,l=0;l<e.length;l+=16){var u=r,o=a,y=i,p=s;r=c(r,a,i,s,e[l+0],7,-680876936),s=c(s,r,a,i,e[l+1],12,-389564586),i=c(i,s,r,a,e[l+2],17,606105819),a=c(a,i,s,r,e[l+3],22,-1044525330),r=c(r,a,i,s,e[l+4],7,-176418897),s=c(s,r,a,i,e[l+5],12,1200080426),i=c(i,s,r,a,e[l+6],17,-1473231341),a=c(a,i,s,r,e[l+7],22,-45705983),r=c(r,a,i,s,e[l+8],7,1770035416),s=c(s,r,a,i,e[l+9],12,-1958414417),i=c(i,s,r,a,e[l+10],17,-42063),a=c(a,i,s,r,e[l+11],22,-1990404162),r=c(r,a,i,s,e[l+12],7,1804603682),s=c(s,r,a,i,e[l+13],12,-40341101),i=c(i,s,r,a,e[l+14],17,-1502002290),r=d(r,a=c(a,i,s,r,e[l+15],22,1236535329),i,s,e[l+1],5,-165796510),s=d(s,r,a,i,e[l+6],9,-1069501632),i=d(i,s,r,a,e[l+11],14,643717713),a=d(a,i,s,r,e[l+0],20,-373897302),r=d(r,a,i,s,e[l+5],5,-701558691),s=d(s,r,a,i,e[l+10],9,38016083),i=d(i,s,r,a,e[l+15],14,-660478335),a=d(a,i,s,r,e[l+4],20,-405537848),r=d(r,a,i,s,e[l+9],5,568446438),s=d(s,r,a,i,e[l+14],9,-1019803690),i=d(i,s,r,a,e[l+3],14,-187363961),a=d(a,i,s,r,e[l+8],20,1163531501),r=d(r,a,i,s,e[l+13],5,-1444681467),s=d(s,r,a,i,e[l+2],9,-51403784),i=d(i,s,r,a,e[l+7],14,1735328473),r=f(r,a=d(a,i,s,r,e[l+12],20,-1926607734),i,s,e[l+5],4,-378558),s=f(s,r,a,i,e[l+8],11,-2022574463),i=f(i,s,r,a,e[l+11],16,1839030562),a=f(a,i,s,r,e[l+14],23,-35309556),r=f(r,a,i,s,e[l+1],4,-1530992060),s=f(s,r,a,i,e[l+4],11,1272893353),i=f(i,s,r,a,e[l+7],16,-155497632),a=f(a,i,s,r,e[l+10],23,-1094730640),r=f(r,a,i,s,e[l+13],4,681279174),s=f(s,r,a,i,e[l+0],11,-358537222),i=f(i,s,r,a,e[l+3],16,-722521979),a=f(a,i,s,r,e[l+6],23,76029189),r=f(r,a,i,s,e[l+9],4,-640364487),s=f(s,r,a,i,e[l+12],11,-421815835),i=f(i,s,r,a,e[l+15],16,530742520),r=h(r,a=f(a,i,s,r,e[l+2],23,-995338651),i,s,e[l+0],6,-198630844),s=h(s,r,a,i,e[l+7],10,1126891415),i=h(i,s,r,a,e[l+14],15,-1416354905),a=h(a,i,s,r,e[l+5],21,-57434055),r=h(r,a,i,s,e[l+12],6,1700485571),s=h(s,r,a,i,e[l+3],10,-1894986606),i=h(i,s,r,a,e[l+10],15,-1051523),a=h(a,i,s,r,e[l+1],21,-2054922799),r=h(r,a,i,s,e[l+8],6,1873313359),s=h(s,r,a,i,e[l+15],10,-30611744),i=h(i,s,r,a,e[l+6],15,-1560198380),a=h(a,i,s,r,e[l+13],21,1309151649),r=h(r,a,i,s,e[l+4],6,-145523070),s=h(s,r,a,i,e[l+11],10,-1120210379),i=h(i,s,r,a,e[l+2],15,718787259),a=h(a,i,s,r,e[l+9],21,-343485551),r=n(r,u),a=n(a,o),i=n(i,y),s=n(s,p)}return[r,a,i,s]}function p(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.Hex,r=t||a.Base64,n=y(i(e),8*e.length);switch(r){case a.Raw:return n;case a.Hex:return l(n);case a.String:return s(n);case a.Base64:return u(n)}}}}]);
//# sourceMappingURL=25.5d2088cd.chunk.js.map