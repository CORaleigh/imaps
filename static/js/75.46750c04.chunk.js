(this.webpackJsonpimaps=this.webpackJsonpimaps||[]).push([[75,11,22,114,166,273,274,282],{102:function(e,t,r){"use strict";function s(){return[0,0,0]}function n(e){return[e[0],e[1],e[2]]}function i(e,t,r){return[e,t,r]}function o(e){const t=[0,0,0],r=Math.min(3,e.length);for(let s=0;s<r;++s)t[s]=e[s];return t}function a(e,t){return new Float64Array(e,t,3)}function u(){return[0,0,0]}function c(){return i(1,1,1)}function l(){return i(1,0,0)}function h(){return i(0,1,0)}function d(){return i(0,0,1)}r.d(t,"a",(function(){return p})),r.d(t,"b",(function(){return f})),r.d(t,"c",(function(){return a})),r.d(t,"d",(function(){return n})),r.d(t,"e",(function(){return s})),r.d(t,"f",(function(){return o})),r.d(t,"g",(function(){return i}));const f=[0,0,0],p=c(),g=l(),m=h(),y=d();Object.freeze({__proto__:null,create:s,clone:n,fromValues:i,fromArray:o,createView:a,zeros:u,ones:c,unitX:l,unitY:h,unitZ:d,ZEROS:f,ONES:p,UNIT_X:g,UNIT_Y:m,UNIT_Z:y})},109:function(e,t,r){"use strict";r.d(t,"a",(function(){return h})),r.d(t,"b",(function(){return f})),r.d(t,"c",(function(){return I})),r.d(t,"d",(function(){return d})),r.d(t,"e",(function(){return u})),r.d(t,"f",(function(){return v})),r.d(t,"g",(function(){return _})),r.d(t,"h",(function(){return x})),r.d(t,"i",(function(){return c})),r.d(t,"j",(function(){return o})),r.d(t,"k",(function(){return g})),r.d(t,"l",(function(){return w})),r.d(t,"m",(function(){return E})),r.d(t,"n",(function(){return p})),r.d(t,"o",(function(){return i})),r.d(t,"p",(function(){return F})),r.d(t,"q",(function(){return b})),r.d(t,"r",(function(){return m})),r.d(t,"s",(function(){return y})),r.d(t,"t",(function(){return j})),r.d(t,"u",(function(){return M})),r.d(t,"v",(function(){return a})),r.d(t,"w",(function(){return O})),r.d(t,"x",(function(){return N})),r.d(t,"y",(function(){return A})),r.d(t,"z",(function(){return R}));var s=r(102),n=r(181);function i(e){const t=e[0],r=e[1],s=e[2];return Math.sqrt(t*t+r*r+s*s)}function o(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function a(e,t,r,s){return e[0]=t,e[1]=r,e[2]=s,e}function u(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function c(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function l(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}function h(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e}function d(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function f(e,t,r,s){return e[0]=t[0]+r[0]*s,e[1]=t[1]+r[1]*s,e[2]=t[2]+r[2]*s,e}function p(e,t){const r=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return Math.sqrt(r*r+s*s+n*n)}function g(e,t){const r=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2];return r*r+s*s+n*n}function m(e){const t=e[0],r=e[1],s=e[2];return t*t+r*r+s*s}function y(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function b(e,t){const r=t[0],s=t[1],n=t[2];let i=r*r+s*s+n*n;return i>0&&(i=1/Math.sqrt(i),e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i),e}function _(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function v(e,t,r){const s=t[0],n=t[1],i=t[2],o=r[0],a=r[1],u=r[2];return e[0]=n*u-i*a,e[1]=i*o-s*u,e[2]=s*a-n*o,e}function x(e,t,r,s){const n=t[0],i=t[1],o=t[2];return e[0]=n+s*(r[0]-n),e[1]=i+s*(r[1]-i),e[2]=o+s*(r[2]-o),e}function w(e,t,r){const s=t[0],n=t[1],i=t[2];return e[0]=r[0]*s+r[4]*n+r[8]*i+r[12],e[1]=r[1]*s+r[5]*n+r[9]*i+r[13],e[2]=r[2]*s+r[6]*n+r[10]*i+r[14],e}function O(e,t,r){const s=t[0],n=t[1],i=t[2];return e[0]=s*r[0]+n*r[3]+i*r[6],e[1]=s*r[1]+n*r[4]+i*r[7],e[2]=s*r[2]+n*r[5]+i*r[8],e}function j(e,t,r){const s=r[0],n=r[1],i=r[2],o=r[3],a=t[0],u=t[1],c=t[2];let l=n*c-i*u,h=i*a-s*c,d=s*u-n*a,f=n*d-i*h,p=i*l-s*d,g=s*h-n*l;const m=2*o;return l*=m,h*=m,d*=m,f*=2,p*=2,g*=2,e[0]=a+l+f,e[1]=u+h+p,e[2]=c+d+g,e}function I(e,t,r,s){const n=[],i=[];return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],i[0]=n[0]*Math.cos(s)-n[1]*Math.sin(s),i[1]=n[0]*Math.sin(s)+n[1]*Math.cos(s),i[2]=n[2],e[0]=i[0]+r[0],e[1]=i[1]+r[1],e[2]=i[2]+r[2],e}const S=Object(s.e)(),T=Object(s.e)();function F(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}const M=c,k=l,C=h,R=p,A=g,E=i,N=m;Object.freeze({__proto__:null,length:i,copy:o,set:a,add:u,subtract:c,multiply:l,divide:h,ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},min:function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e},max:function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e},round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},scale:d,scaleAndAdd:f,distance:p,squaredDistance:g,squaredLength:m,negate:y,inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},normalize:b,dot:_,cross:v,lerp:x,hermite:function(e,t,r,s,n,i){const o=i*i,a=o*(2*i-3)+1,u=o*(i-2)+i,c=o*(i-1),l=o*(3-2*i);return e[0]=t[0]*a+r[0]*u+s[0]*c+n[0]*l,e[1]=t[1]*a+r[1]*u+s[1]*c+n[1]*l,e[2]=t[2]*a+r[2]*u+s[2]*c+n[2]*l,e},bezier:function(e,t,r,s,n,i){const o=1-i,a=o*o,u=i*i,c=a*o,l=3*i*a,h=3*u*o,d=u*i;return e[0]=t[0]*c+r[0]*l+s[0]*h+n[0]*d,e[1]=t[1]*c+r[1]*l+s[1]*h+n[1]*d,e[2]=t[2]*c+r[2]*l+s[2]*h+n[2]*d,e},random:function(e,t){t=t||1;const r=2*Object(n.b)()*Math.PI,s=2*Object(n.b)()-1,i=Math.sqrt(1-s*s)*t;return e[0]=Math.cos(r)*i,e[1]=Math.sin(r)*i,e[2]=s*t,e},transformMat4:w,transformMat3:O,transformQuat:j,rotateX:function(e,t,r,s){const n=[],i=[];return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],i[0]=n[0],i[1]=n[1]*Math.cos(s)-n[2]*Math.sin(s),i[2]=n[1]*Math.sin(s)+n[2]*Math.cos(s),e[0]=i[0]+r[0],e[1]=i[1]+r[1],e[2]=i[2]+r[2],e},rotateY:function(e,t,r,s){const n=[],i=[];return n[0]=t[0]-r[0],n[1]=t[1]-r[1],n[2]=t[2]-r[2],i[0]=n[2]*Math.sin(s)+n[0]*Math.cos(s),i[1]=n[1],i[2]=n[2]*Math.cos(s)-n[0]*Math.sin(s),e[0]=i[0]+r[0],e[1]=i[1]+r[1],e[2]=i[2]+r[2],e},rotateZ:I,angle:function(e,t){o(S,e),o(T,t),b(S,S),b(T,T);const r=_(S,T);return r>1?0:r<-1?Math.PI:Math.acos(r)},str:function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},exactEquals:F,equals:function(e,t){const r=e[0],s=e[1],i=e[2],o=t[0],a=t[1],u=t[2];return Math.abs(r-o)<=n.a*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-a)<=n.a*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(i-u)<=n.a*Math.max(1,Math.abs(i),Math.abs(u))},sub:M,mul:k,div:C,dist:R,sqrDist:A,len:E,sqrLen:N})},113:function(e,t,r){"use strict";var s=r(81),n=r(88),i=r(84),o=r(83),a=r(95),u=r(105);let c=class extends a.a{constructor(e){super(e),this._groups=new Map}destroy(){this.removeAll()}get size(){let e=0;return this._groups.forEach((t=>{e+=t.length})),e}add(e,t){if(!this._isHandle(e)&&!Array.isArray(e)&&!u.a.isCollection(e))return this;const r=this._getOrCreateGroup(t);return Array.isArray(e)||u.a.isCollection(e)?e.forEach((e=>this._isHandle(e)&&r.push(e))):r.push(e),this.notifyChange("size"),this}forEach(e,t){if("function"==typeof e)this._groups.forEach((t=>t.forEach(e)));else{const r=this._getGroup(e);r&&t&&r.forEach(t)}}has(e){return this._groups.has(this._ensureGroupKey(e))}remove(e){if(Array.isArray(e)||u.a.isCollection(e))return e.forEach(this.remove,this),this;if(!this.has(e))return this;const t=this._getGroup(e);for(let r=0;r<t.length;r++)t[r].remove();return this._deleteGroup(e),this.notifyChange("size"),this}removeAll(){return this._groups.forEach((e=>{for(let t=0;t<e.length;t++)e[t].remove()})),this._groups.clear(),this.notifyChange("size"),this}_isHandle(e){return e&&!!e.remove}_getOrCreateGroup(e){if(this.has(e))return this._getGroup(e);const t=[];return this._groups.set(this._ensureGroupKey(e),t),t}_getGroup(e){return Object(n.d)(this._groups.get(this._ensureGroupKey(e)))}_deleteGroup(e){return this._groups.delete(this._ensureGroupKey(e))}_ensureGroupKey(e){return e||"_default_"}};Object(s.a)([Object(i.b)({readOnly:!0})],c.prototype,"size",null),c=Object(s.a)([Object(o.a)("esri.core.Handles")],c);var l=c;t.a=l},115:function(e,t,r){"use strict";r.d(t,"a",(function(){return B})),r.d(t,"b",(function(){return j})),r.d(t,"c",(function(){return S})),r.d(t,"d",(function(){return G})),r.d(t,"e",(function(){return z})),r.d(t,"f",(function(){return q})),r.d(t,"g",(function(){return N})),r.d(t,"h",(function(){return D})),r.d(t,"i",(function(){return P})),r.d(t,"j",(function(){return c})),r.d(t,"k",(function(){return I})),r.d(t,"l",(function(){return w})),r.d(t,"m",(function(){return A})),r.d(t,"n",(function(){return V})),r.d(t,"o",(function(){return O})),r.d(t,"p",(function(){return v})),r.d(t,"q",(function(){return x})),r.d(t,"r",(function(){return R})),r.d(t,"s",(function(){return M})),r.d(t,"t",(function(){return k})),r.d(t,"u",(function(){return C})),r.d(t,"v",(function(){return T})),r.d(t,"w",(function(){return F})),r.d(t,"x",(function(){return E}));r(79);var s=r(93),n=r(254),i=r(110),o=r(97),a=r(136),u=r(170);const c=39.37,l=a.a.radius*Math.PI/200,h=/UNIT\[([^\]]+)\]\]$/i,d=n.a,f=/UNIT\[([^\]]+)\]/i,p=new Set([4261,4305,4807,4810,4811,4812,4816,4819,4821,4901,4902,37225,104139,104140]),g=Object(s.b)()({meter:"meters",foot:"feet",foot_us:"us-feet",foot_clarke:"clarke-feet",yard_clarke:"clarke-yards",link_clarke:"clarke-links",yard_sears:"sears-yards",foot_sears:"sears-feet",chain_sears:"sears-chains",chain_benoit_1895_b:"benoit-1895-b-chains",yard_indian:"indian-yards",yard_indian_1937:"indian-1937-yards",foot_gold_coast:"gold-coast-feet",chain_sears_1922_truncated:"sears-1922-truncated-chains","50_kilometers":"50-kilometers","150_kilometers":"150-kilometers"}),m=e=>e*e,y=e=>e*e*e,b={length:{baseUnit:"meters",units:{millimeters:{inBaseUnits:.001},centimeters:{inBaseUnits:.01},decimeters:{inBaseUnits:.1},meters:{inBaseUnits:1},kilometers:{inBaseUnits:1e3},inches:{inBaseUnits:.0254},feet:{inBaseUnits:.3048},yards:{inBaseUnits:.9144},miles:{inBaseUnits:1609.344},"nautical-miles":{inBaseUnits:1852},"us-feet":{inBaseUnits:1200/3937}}},area:{baseUnit:"square-meters",units:{"square-millimeters":{inBaseUnits:m(.001)},"square-centimeters":{inBaseUnits:m(.01)},"square-decimeters":{inBaseUnits:m(.1)},"square-meters":{inBaseUnits:1},"square-kilometers":{inBaseUnits:m(1e3)},"square-inches":{inBaseUnits:m(.0254)},"square-feet":{inBaseUnits:m(.3048)},"square-yards":{inBaseUnits:m(.9144)},"square-miles":{inBaseUnits:m(1609.344)},"square-us-feet":{inBaseUnits:m(1200/3937)},acres:{inBaseUnits:.0015625*m(1609.344)},ares:{inBaseUnits:100},hectares:{inBaseUnits:1e4}}},volume:{baseUnit:"liters",units:{liters:{inBaseUnits:1},"cubic-millimeters":{inBaseUnits:1e3*y(.001)},"cubic-centimeters":{inBaseUnits:1e3*y(.01)},"cubic-decimeters":{inBaseUnits:1e3*y(.1)},"cubic-meters":{inBaseUnits:1e3},"cubic-kilometers":{inBaseUnits:1e3*y(1e3)},"cubic-inches":{inBaseUnits:1e3*y(.0254)},"cubic-feet":{inBaseUnits:1e3*y(.3048)},"cubic-yards":{inBaseUnits:1e3*y(.9144)},"cubic-miles":{inBaseUnits:1e3*y(1609.344)}}},angle:{baseUnit:"radians",units:{radians:{inBaseUnits:1},degrees:{inBaseUnits:Math.PI/180}}}},_=function(){const e={};for(const t in b)for(const r in b[t].units)e[r]=t;return e}();const v=["metric","imperial","square-inches","square-feet","square-yards","square-miles","square-us-feet","square-meters","square-kilometers","acres","ares","hectares"],x=["metric","imperial","inches","feet","yards","miles","nautical-miles","us-feet","meters","kilometers"];function w(e){return"imperial"===e||"metric"===e}function O(e){const t=_[e];if(t)return t;throw new Error("unknown measure")}function j(e){return function(e){return b[e].baseUnit}(O(e))}function I(e,t=null){return t=t||O(e),b[t].baseUnit===e}function S(e,t,r){if(t===r)return e;const s=O(t);if(s!==O(r))throw new Error("incompatible units");const n=I(t,s)?e:function(e,t,r){return e*b[r].units[t].inBaseUnits}(e,t,s);return I(r,s)?n:function(e,t,r){return e/b[r].units[t].inBaseUnits}(n,r,s)}function T(e,t){return S(e,t,"meters")<3e3?"meters":"kilometers"}function F(e,t){return S(e,t,"meters")<1e5?"meters":"kilometers"}function M(e,t){return S(e,t,"feet")<1e3?"feet":"miles"}function k(e,t){return S(e,t,"feet")<1e5?"feet":"miles"}function C(e,t){return S(e,t,"square-meters")<3e6?"square-meters":"square-kilometers"}function R(e,t){return S(e,t,"square-feet")<1e6?"square-feet":"square-miles"}function A(e,t,r){return S(e,t,"meters")/(r*Math.PI/180)}function E(e){return g.fromJSON(e.toLowerCase())||null}function N(e){if(e&&"object"==typeof e&&!Object(i.e)(e))return 1;const t=q(e);return t>1e5?1:t}function P(e){return q(e)>=(e instanceof o.a?Object(u.e)(e).metersPerDegree:1e5)?"meters":D(e)}function q(e,t=a.a.metersPerDegree){return z(e,!0)||t}function z(e,t=!1){let r,s,n=null;if(null!=e&&("object"==typeof e?(r=e.wkid,s=e.wkt):"number"==typeof e?r=e:"string"==typeof e&&(s=e)),r){if(Object(i.k)(r))return a.b.metersPerDegree;if(Object(i.l)(r))return a.c.metersPerDegree;n=d.values[d[r]],!n&&t&&p.has(r)&&(n=l)}else if(s)if(-1!==s.search(/^PROJCS/i)){const e=h.exec(s);e&&e[1]&&(n=parseFloat(e[1].split(",")[1]))}else if(-1!==s.search(/^GEOCCS/i)){const e=f.exec(s);e&&e[1]&&(n=parseFloat(e[1].split(",")[1]))}return n}function D(e){let t,r,s=null;if(null!=e&&("object"==typeof e?(t=e.wkid,r=e.wkt):"number"==typeof e?t=e:"string"==typeof e&&(r=e)),t)s=d.units[d[t]];else if(r&&-1!==r.search(/^PROJCS/i)){let e=h.exec(r);e&&e[1]&&(e=/[\\"\\']{1}([^\\"\\']+)/.exec(e[1]),s=e&&e[1])}return s?E(s):null}function G(e){if(!e)return null;switch(D(e)){case"feet":case"us-feet":case"clarke-feet":case"clarke-yards":case"clarke-links":case"sears-yards":case"sears-feet":case"sears-chains":case"benoit-1895-b-chains":case"indian-yards":case"indian-1937-yards":case"gold-coast-feet":case"sears-1922-truncated-chains":return"imperial";case"50-kilometers":case"150-kilometers":case"meters":return"metric";case null:case void 0:return null}return null}const L={esriAcres:"acres",esriAres:"ares",esriHectares:"hectares",esriSquareCentimeters:"square-centimeters",esriSquareDecimeters:"square-decimeters",esriSquareFeet:"square-feet",esriSquareInches:"square-inches",esriSquareKilometers:"square-kilometers",esriSquareMeters:"square-meters",esriSquareMiles:"square-miles",esriSquareMillimeters:"square-millimeters",esriSquareUsFeet:"square-us-feet",esriSquareYards:"square-yards"},U={esriCentimeters:"centimeters",esriDecimeters:"decimeters",esriFeet:"feet",esriInches:"inches",esriKilometers:"kilometers",esriMeters:"meters",esriMiles:"miles",esriMillimeters:"millimeters",esriNauticalMiles:"nautical-miles",esriYards:"yards"},B=Object(s.b)()(L),V=Object(s.b)()(U);Object(s.b)()({...L,...U})},120:function(e,t,r){"use strict";var s,n=r(81),i=(r(79),r(90)),o=r(88),a=(r(80),r(87),r(84)),u=r(83),c=(r(82),r(85),r(86),r(89)),l=r(98),h=r(99),d=r(166),f=r(135),p=r(186);let g=s=class extends c.a{constructor(...e){super(...e),this.isAggregate=!1,this.layer=null,this.popupTemplate=null,this.sourceLayer=null,Object.defineProperty(this,"uid",{value:Object(p.a)(),configurable:!0})}normalizeCtorArgs(e,t,r,s){return e&&!e.declaredClass?e:{geometry:e,symbol:t,attributes:r,popupTemplate:s}}set attributes(e){const t=this._get("attributes");t!==e&&(this._set("attributes",e),this._notifyLayer("attributes",t,e))}set geometry(e){const t=this._get("geometry");t!==e&&(this._set("geometry",e),this._notifyLayer("geometry",t,e))}set symbol(e){const t=this._get("symbol");t!==e&&(this._set("symbol",e),this._notifyLayer("symbol",t,e))}set visible(e){const t=this._get("visible");t!==e&&(this._set("visible",e),this._notifyLayer("visible",t,e))}getEffectivePopupTemplate(e=!1){return this.popupTemplate?this.popupTemplate:this.sourceLayer?"popupTemplate"in this.sourceLayer&&this.sourceLayer.popupTemplate?this.sourceLayer.popupTemplate:e&&"defaultPopupTemplate"in this.sourceLayer&&Object(o.k)(this.sourceLayer.defaultPopupTemplate)?this.sourceLayer.defaultPopupTemplate:null:null}getAttribute(e){return this.attributes&&this.attributes[e]}setAttribute(e,t){if(this.attributes){const r=this.getAttribute(e);this.attributes[e]=t,this._notifyLayer("attributes",r,t,e)}else this.attributes={[e]:t},this._notifyLayer("attributes",void 0,t,e)}getObjectId(){return this.sourceLayer&&"objectIdField"in this.sourceLayer&&this.sourceLayer.objectIdField?this.getAttribute(this.sourceLayer.objectIdField):null}toJSON(){return{geometry:Object(o.k)(this.geometry)?this.geometry.toJSON():null,symbol:Object(o.k)(this.symbol)?this.symbol.toJSON():null,attributes:{...this.attributes},popupTemplate:this.popupTemplate&&this.popupTemplate.toJSON()}}clone(){return new s(this.cloneProperties())}cloneProperties(){return{attributes:Object(i.a)(this.attributes),geometry:Object(i.a)(this.geometry),layer:this.layer,popupTemplate:this.popupTemplate&&this.popupTemplate.clone(),sourceLayer:this.sourceLayer,symbol:Object(i.a)(this.symbol),visible:this.visible}}_notifyLayer(e,t,r,s){if(!this.layer||!("graphicChanged"in this.layer))return;const n={graphic:this,property:e,oldValue:t,newValue:r};"attributes"===e&&(n.attributeName=s),this.layer.graphicChanged(n)}};Object(n.a)([Object(a.b)({value:null})],g.prototype,"attributes",null),Object(n.a)([Object(a.b)({value:null,types:h.a,json:{read:l.a}})],g.prototype,"geometry",null),Object(n.a)([Object(a.b)({type:Boolean})],g.prototype,"isAggregate",void 0),Object(n.a)([Object(a.b)()],g.prototype,"layer",void 0),Object(n.a)([Object(a.b)({type:d.a})],g.prototype,"popupTemplate",void 0),Object(n.a)([Object(a.b)()],g.prototype,"sourceLayer",void 0),Object(n.a)([Object(a.b)({value:null,types:f.e})],g.prototype,"symbol",null),Object(n.a)([Object(a.b)({type:Boolean,value:!0})],g.prototype,"visible",null),g=s=Object(n.a)([Object(u.a)("esri.Graphic")],g),(g||(g={})).generateUID=p.a;var m=g;t.a=m},1219:function(e,t,r){"use strict";r.r(t),r.d(t,"getInstances",(function(){return at}));var s=r(81),n=r(79),i=r(80),o=(r(87),r(84)),a=r(83),u=(r(82),r(85),r(86),r(164)),c=r(333),l=r(505),h=r(552);class d{constructor(){this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}static create(e){const t=new d;for(const r in e){const s=e[r];if("object"==typeof s)for(const e in s){const n=s[e];t[r][e]=n}t[r]=s}return t}static empty(){return d.create({})}static all(){return d.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}unset(e){e.source&&(this.source=!1),e.targets.feature&&(this.targets.feature=!1),e.targets.aggregate&&(this.targets.aggregate=!1),e.storage.filters&&(this.storage.filters=!1),e.storage.data&&(this.storage.data=!1),e.mesh&&(this.mesh=!1),e.queryFilter&&(this.queryFilter=!1)}any(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}describe(){let e=0,t="";if(this.mesh){e+=20,t+="-> (20) Mesh needs update\n";for(const e of this.why.mesh)t+=`    + ${e}\n`}if(this.source){e+=10,t+="-> (10) The source needs update\n";for(const e of this.why.source)t+=`    + ${e}\n`}this.targets.feature&&(e+=5,t+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(e+=5,t+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(e+=4,t+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(e+=1,t+="-> (1) Texture storage parameters changed");const r=e<5?"Fastest":e<10?"Fast":e<15?"Moderate":e<20?"Slow":"Very Slow";console.debug(`Applying ${r} update of cost ${e}/45 `),console.debug(t)}toJSON(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}var f=r(88),p=r(92),g=r(106),m=r(165),y=r(204),b=r(493),_=r(708),v=r(363),x=r(560),w=r(966),O=r(763),j=r(239),I=r(91),S=r(104),T=r(129),F=r(272),M=r(187),k=r(110),C=r(97),R=r(158),A=(r(99),r(234),r(313)),E=(r(143),r(964));r(779);i.a.getLogger("esri.layers.graphics.sources.ogcfeature");const N="json";async function P(e,t,r){const{capabilities:{query:{maxRecordCount:s}},collectionId:n,layerDefinition:i,spatialReference:o,supportedCrs:a,url:u}=e,c=`${u}/collections/${n}/items`,{geometry:l,num:h,start:d,timeExtent:p,where:g}=t;if(t.objectIds)throw new I.a("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const y=C.a.fromJSON(o),b=Object(f.r)(t.outSpatialReference,y),_=b.isWGS84?null:q(b,a),v=function(e,t){if(!function(e){return Object(f.k)(e)&&"extent"===e.type}(e))return null;const{spatialReference:r}=e;if(!r||r.isWGS84)return{bbox:z(e)};const s=q(r,t);return s?{bbox:z(e),"bbox-crs":s}:r.isWebMercator?{bbox:z(Object(R.d)(e,C.a.WGS84))}:null}(l,a),x=function(e){if(Object(f.j)(e))return null;const{start:t,end:r}=e;return`${t?t.toISOString():".."}/${r?r.toISOString():".."}`}(p),w=(T=g,Object(f.j)(T)||!T||"1=1"===T?null:T),O=null!=h?h:null!=d&&void 0!==d?10:s,{data:j}=await Object(S.default)(c,{...r,query:{...v,crs:_,datetime:x,query:w,limit:O,startindex:d,f:N}});var T;let F=!1;j.links&&(F=!!j.links.find((e=>"next"===e.rel))),!F&&Number.isInteger(j.numberMatched)&&Number.isInteger(j.numberReturned)&&(F=j.numberReturned<j.numberMatched);const{fields:M,globalIdField:P,hasM:D,hasZ:G,objectIdField:L}=i,U=i.geometryType,B=Object(E.a)(j,{geometryType:U,hasZ:G,objectIdFieldName:L});if(!_&&b.isWebMercator)for(const f of B)if(f.geometry){const e=Object(m.k)(f.geometry,U,G,!1);e.spatialReference=C.a.WGS84,f.geometry=Object(m.d)(Object(R.d)(e,b))}for(const f of B)f.objectId=f.attributes[L];const V=_||!_&&b.isWebMercator?b.toJSON():k.a,Q=new A.a;return Q.exceededTransferLimit=F,Q.features=B,Q.fields=M,Q.geometryType=U,Q.globalIdFieldName=P,Q.hasM=D,Q.hasZ=G,Q.objectIdFieldName=L,Q.spatialReference=V,Q}function q(e,t){return t.find((t=>{const r=function(e){const t=new RegExp("^http://www.opengis.net/def/crs/(?<authority>.*)/(?<version>.*)/(?<code>.*)$","i").exec(e),r=null==t?void 0:t.groups;if(!r)return null;const{authority:s,code:n}=r;switch(s.toLowerCase()){case"ogc":switch(n.toLowerCase()){case"crs27":return C.a.GCS_NAD_1927;case"crs83":return new C.a({wkid:4269});case"crs84":case"crs84h":return C.a.WGS84;default:return null}case"esri":case"epsg":{const e=Number.parseInt(n,10);return Number.isNaN(e)?null:900913===e?C.a.WebMercator:new C.a({wkid:e})}default:return null}}(t);return Object(k.c)(r,e)}))}function z(e){const{xmin:t,ymin:r,xmax:s,ymax:n}=e;return`${t},${r},${s},${n}`}var D=r(289),G=r(175),L=r(404),U=r(359),B=r(384);const V=268435455;class Q{constructor(){this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}hasField(e){return this.fieldMap.has(e)}isDateField(e){var t;return null==(t=this.fieldMap.get(e))?void 0:t.isDate}getFieldIndex(e){var t;return null==(t=this.fieldMap.get(e))?void 0:t.index}}function Y(e){const t=e.getLength(),r=e.pos()+t,s={name:"",isDate:!1};for(;e.pos()<r&&e.next();)switch(e.tag()){case 1:s.name=e.getString();break;case 2:"esriFieldTypeDate"===Object(B.b)(e.getEnum())&&(s.isDate=!0);break;default:e.skip()}return s}function X(e){return e.toLowerCase().trim()}const J=i.a.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF"),Z=268435455;function H(e){for(;e.next();)switch(e.tag()){case 1:return e.getMessage();default:e.skip()}return null}class $ extends L.a{constructor(e,t,r,s){super(e),this._hasNext=!1,this._isPoints=!1,this._isPolygons=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=s,this._reader=t,this._header=r,this._hasNext=r.hasFeatures,this._isPoints="esriGeometryPoint"===s,this._isPolygons="esriGeometryPolygon"===s}static fromBuffer(e,t,r=!1){const s=function(e){try{const t=2,r=new U.a(new Uint8Array(e),new DataView(e));for(;r.next();)switch(r.tag()){case t:return H(r.getMessage());default:r.skip()}}catch(t){const r=new I.a("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:t});J.error(r)}return null}(e),n=function(e,t,r=!1){const s=e.pos(),n=new Q;let i=0,o=0,a=null,u=null,c=null,l=!1;for(;e.next();)switch(e.tag()){case 1:a=e.getString();break;case 3:u=e.getString();break;case 12:c=e.processMessage(B.c);break;case 9:if(n.exceededTransferLimit=e.getBool(),n.exceededTransferLimit){n.offsets.geometry=r?new Float64Array(8e3):new Int32Array(8e3),n.centroid=r?new Float64Array(16e3):new Int32Array(16e3);for(let e=0;e<n.centroid.length;e++)n.centroid[e]=V}break;case 13:{const t=Y(e),r=t.name,s=X(t.name),o={fieldName:r,index:i++,isDate:t.isDate};n.fields.push(o),n.fieldMap.set(t.name,o),n.fieldMap.set(s,o);break}case 15:{const s=e.getLength(),a=e.pos()+s;if(!n.exceededTransferLimit){const e=n.offsets.geometry,t=n.centroid;e.push(0),t.push(V),t.push(V)}!l&&n.exceededTransferLimit&&(l=!0,n.offsets.attributes=r?new Float64Array(8e3*i):new Uint32Array(8e3*i));let u=o*i;for(;e.pos()<a&&e.next();)switch(e.tag()){case 1:{l?n.offsets.attributes[u++]=e.pos():n.offsets.attributes.push(e.pos());const t=e.getLength();e.skipLen(t);break}case 2:if(t){const t=e.getLength(),r=e.pos()+t;for(;e.pos()<r&&e.next();)switch(e.tag()){case 3:{e.getUInt32();const t=e.getSInt64(),r=e.getSInt64();n.centroid[2*o]=t,n.centroid[2*o+1]=r;break}default:e.skip()}}else{n.offsets.geometry[o]=e.pos();const t=e.getLength();e.skipLen(t)}break;case 4:{const t=e.getLength(),r=e.pos()+t;for(;e.pos()<r&&e.next();)switch(e.tag()){case 3:{e.getUInt32();const t=e.getSInt64(),r=e.getSInt64();n.centroid[2*o]=t,n.centroid[2*o+1]=r;break}default:e.skip()}break}default:e.skip()}o++,n.hasFeatures=!0;break}default:e.skip()}const h=a||u;if(!h)throw new I.a("FeatureSet has no objectId or globalId field name");return n.featureCount=o,n.fieldCount=i,n.objectIdFieldIndex=n.getFieldIndex(h),n.transform=c,n.displayIds=new Uint32Array(n.featureCount),n.groupIds=new Uint16Array(n.featureCount),e.move(s),n}(s,"esriGeometryPoint"===t,r),i=L.a.createInstance();return new $(i,s,n,t)}get geometryType(){return this._geometryType}get size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getApproximateSize(){if(this._hasFilter){const e=Math.abs(this._xmax-this._xmin)*Math.abs(this._ymax-this._ymin),t=this.size*e/262144;return Math.max(Math.round(t),0)}return this.size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e}getAttributeHash(){let e="";return this._header.fields.forEach((({index:t})=>{e+=this._readAttributeAtIndex(t)+"."})),e}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(e){this._header.displayIds[this._featureIndex]=e}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(e){this._header.groupIds[this._featureIndex]=e}readLegacyFeature(){if(void 0===this._cache.legacyFeature){var e;const t=this.readCentroid(),r={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(e=t&&{x:t.coords[0],y:t.coords[1]})?e:null};return this._cache.legacyFeature=r,r}return this._cache.legacyFeature}readOptimizedFeature(){if(void 0===this._cache.optFeature){const e=new D.a(this.readGeometry(),this.readAttributes(),this.readCentroid());return e.objectId=this.getObjectId(),e.displayId=this.getDisplayId(),this._cache.optFeature=e,e}return this._cache.optFeature}getXHydrate(){const e=this._header.centroid[2*this._featureIndex],t=this.getQuantizationTransform();return Object(f.j)(t)?e:e*t.scale[0]+t.translate[0]}getYHydrate(){const e=this._header.centroid[2*this._featureIndex+1],t=this.getQuantizationTransform();return Object(f.j)(t)?e:t.translate[1]-e*t.scale[1]}getX(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}getY(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}readLegacyPointGeometry(){return{x:this.getX(),y:this.getY()}}readLegacyGeometry(){const e=this.readGeometry();return Object(m.k)(e,this.geometryType,!1,!1)}readLegacyCentroid(){const e=this.readCentroid();if(!e)return null;const[t,r]=e.coords;return{x:t,y:r}}readGeometryArea(){return this._cache.area||this.readGeometry(),this._cache.area}readUnquantizedGeometry(){if(void 0===this._cache.unquantGeometry){const e=this.readGeometry();if(!e)return this._cache.unquantGeometry=null,null;const t=e.clone(),r=t.lengths,s=t.coords;for(let n=0,i=2;n<r.length;n++,i+=2){const e=r[n];for(let t=1;t<e;t+=1,i+=2)s[i]+=s[i-2],s[i+1]+=s[i-1]}return this._cache.unquantGeometry=t,t}return this._cache.unquantGeometry}readHydratedGeometry(){if(this._isPoints){const e=this.getXHydrate(),t=this.getYHydrate();return new G.a([],[e,t])}const e=this.readGeometry();if(!e)return null;const t=e.clone(),r=this.getQuantizationTransform();return Object(f.k)(r)&&Object(m.z)(t,t,this.hasZ,this.hasM,r),t}readGeometry(){if(void 0===this._cache.geometry){let e=null;if(this._isPoints){const t=this.getX(),r=this.getY();e=new G.a([],[t,r])}else{const t=this._header.offsets.geometry[this._featureIndex],r=this._reader;if(0===t)return null;r.move(t);try{e=this._parseGeometry(r)}catch(Ie){return console.error("Failed to parse geometry!",Ie),null}}return this._cache.geometry=e,e}return this._cache.geometry}readCentroid(){if(void 0===this._cache.centroid){let e=null;const t=this._header.centroid[2*this._featureIndex]+this._tx,r=this._header.centroid[2*this._featureIndex+1]+this._ty;return t===Z?(e=this._computeCentroid(),e&&(this._header.centroid[2*this._featureIndex]=e.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=e.coords[1]-this._ty)):e=new G.a([],[t,r]),this._cache.centroid=e,e}return this._cache.centroid}copy(){const e=this._reader.clone(),t=new $(this.instance,e,this._header,this.geometryType);return this.copyInto(t),t}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this.size&&!this._passesFilter()&&!this._getExists(););return this._featureIndex<this.size}_readAttribute(e,t){const r=this._header.hasField(e)?e:function(e){return e.toLowerCase().trim()}(e),s=this._header.getFieldIndex(r);if(null==s)return;const n=this._readAttributeAtIndex(s);return t?null==n?n:this._header.isDateField(r)?new Date(n):n:n}_readAttributes(){const e={};return this._header.fields.forEach((({fieldName:t,index:r})=>{e[t]=this._readAttributeAtIndex(r)})),e}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext}_passesFilter(){if(!this._hasFilter)return!0;let e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1];if(e===Z){if(this._isPolygons&&!this.readCentroid())return!1;e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1]}return e>=this._xmin&&e<=this._xmax&&t>=this._ymin&&t<=this._ymax}_readAttributeAtIndex(e){const t=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],r=this._reader;return r.move(t),function(e){const t=e.getLength(),r=e.pos()+t;for(;e.pos()<r&&e.next();)switch(e.tag()){case 1:{const t=e.getString();return""===t?null:t}case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}(r)}_preprocessPolygon(e,t){let r=0,s=0,n=0,i=!1,o=!1,a=!1,u=-1;const c=[];let l=0,h=!1;for(let d=0;d<t.length;d++){const f=t[d];let p=e[2*r],g=e[2*r+1],m=0;for(let t=1;t<f;t++){const s=p,n=g,i=p+e[2*(r+t)],o=g+e[2*(r+t)+1];p=i,g=o,m+=(i-s)*(o+n)*.5}const y=m>0;if(y&&h&&(s+=f),y||(u++,h=!1),u>=1e6)break;l+=m,i&&y&&o&&(a=!0);{e[2*n]=e[2*s],e[2*n+++1]=e[2*s+++1];let t=1,r=e[2*s],i=e[2*s+++1];for(let o=2;o<f;o++){const o=e[2*s],a=e[2*s+++1];0===r*a-o*i&&r*o+i*a>0?(r+=o,i+=a):(e[2*n]=r,e[2*n+++1]=i,t++,r=o,i=a)}e[2*n]=r,e[2*n+++1]=i,t++,c.push(t)}i=!1,o=!0,r+=f}return c.length?(this._cache.area=Math.abs(l),new G.a(c,e,a)):null}_parseGeometry(e){const t=e.getLength(),r=e.pos()+t,s=[],n=[];for(;e.pos()<r&&e.next();)switch(e.tag()){case 2:{const t=e.getUInt32(),r=e.pos()+t;for(;e.pos()<r;)n.push(e.getUInt32());break}case 3:{const t=e.getUInt32(),r=e.pos()+t;for(;e.pos()<r;)s.push(e.getSInt32()),s.push(e.getSInt32()),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();break}case 1:default:e.skip()}let i=0;for(const o of n)s[2*i]+=this._tx,s[2*i+1]+=this._ty,i+=o;return this._isPolygons?this._preprocessPolygon(s,n):new G.a(n,s)}}class W{constructor(e){this.service=e}destroy(){}}function K(e){const{capabilities:t}=e;return(r=e.source)&&r.capabilities&&r.collectionId&&r.layerDefinition&&r.url?new se(e):function(e){return Array.isArray(e.source)}(e)?new ee(e):t.query.supportsFormatPBF&&Object(n.a)("featurelayer-pbf")?new te(e):new re(e);var r}class ee extends W{constructor(e){super(e),this._portsOpen=Object(F.c)(e.source).then((e=>this.client=e))}destroy(){this.client.close(),this.client=null}async executeQuery(e,t){await this._portsOpen;const r=await this.client.invoke("queryFeatures",e.toJSON(),t);return b.a.fromFeatureSet(r,this.service.objectIdField)}}class te extends W{async executeQuery(e,t){const{data:r}=await Object(M.executeQueryPBFBuffer)(this.service.source,e,{...t,query:{...this.service.customParameters,...null==t?void 0:t.query}}),s=!e.quantizationParameters;return $.fromBuffer(r,this.service.geometryType,s)}}class re extends W{async executeQuery(e,t){const{source:r,capabilities:s,spatialReference:n,objectIdField:i}=this.service;if(e.quantizationParameters&&!s.query.supportsQuantization){const s=e.clone();s.quantizationParameters=null;const{data:o}=await Object(M.executeQuery)(r,s,n,{...t,query:{...this.service.customParameters,...null==t?void 0:t.query}}),a=Object(m.b)(o,i);return Object(m.t)(t.transform,a),b.a.fromOptimizedFeatureSet(a)}const{data:o}=await Object(M.executeQuery)(r,e,this.service.spatialReference,{...t,query:{...Object(f.q)(this.service.customParameters),...null==t?void 0:t.query}});return b.a.fromFeatureSet(o,this.service.objectIdField)}}class se extends W{async executeQuery(e,t){const{capabilities:r}=this.service;if(e.quantizationParameters&&!r.query.supportsQuantization){e.clone().quantizationParameters=null;const r=await P(this.service.source,e,t);return Object(m.t)(t.transform,r),b.a.fromOptimizedFeatureSet(r)}const s=await P(this.service.source,e,t);return b.a.fromOptimizedFeatureSet(s)}}var ne=r(128),ie=r(147),oe=r(314),ae=r(95);let ue=class extends ae.a{constructor(e){super(e),this._queue=[],this._onGoingRequest=null,this._abortController=Object(p.d)()}destroy(){this.clear()}get updating(){return!this.destroyed&&(this._queue.length>0||null!=this._onGoingRequest)}clear(){if(this.destroyed)throw new Error("instance is already destroyed");let e=this._queue.pop();for(;e;)e.resolver.reject(Object(p.e)()),e=this._queue.pop();this._queue.length=0,this._abortController.abort(),this._abortController=Object(p.d)()}async push(e){if(this.destroyed)throw new Error("instance is already destroyed");const t=Object(p.g)();return this._queue.push({event:e,resolver:t}),this.notifyChange("updating"),Promise.resolve().then((()=>{this._processNext()})),t.promise}async _processNext(){if(this._onGoingRequest)return;const e=[],t=new Set,r=new Set,s=new Set;let n=this._queue.shift();for(;n;){const{event:{addedFeatures:i,deletedFeatures:o,updatedFeatures:a},resolver:u}=n;e.push(u);for(const{objectId:e,error:n}of i)n||(t.add(e),r.add(e),s.delete(e));for(const{objectId:e,error:t}of a)t||(r.add(e),s.delete(e));for(const{objectId:e,error:n}of o)n||(t.has(e)?t.delete(e):s.add(e),r.delete(e));n=this._queue.shift()}if(!r.size&&!s.size)return this.notifyChange("updating"),void e.forEach((e=>e()));const i=[],o=[];r.size&&r.forEach((e=>{i.push(e)})),s.size&&s.forEach((e=>{o.push(e)})),this._onGoingRequest=Promise.resolve().then((()=>this.processEdits(i,o,{signal:this._abortController.signal}))).catch((()=>{})),this.notifyChange("updating"),await this._onGoingRequest,this._onGoingRequest=null,this.notifyChange("updating"),e.forEach((e=>e())),this._queue.length>0&&this._processNext()}};Object(s.a)([Object(o.b)({constructOnly:!0})],ue.prototype,"processEdits",void 0),Object(s.a)([Object(o.b)({readOnly:!0})],ue.prototype,"updating",null),ue=Object(s.a)([Object(a.a)("esri.views.2d.layers.features.controllers.EditsQueue")],ue);var ce=r(664);class le{constructor(e){this.requests={done:new Array,stream:new ce.a(10)},this._abortController=new AbortController,this.didSend=!1,this.tile=e}get invalid(){return this._invalid}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}sentEnd(){return this.requests.done.some((e=>e.message.end))}clear(){this.requests.done=[]}applyUpdate(e){this.requests.done.forEach((t=>t.message.status.unset(e)))}invalidate(e){switch(e){case"fields":return void("none"===this._invalid&&(this._invalid="fields"));case"all":return void(this._invalid="all")}}done(){this._invalid="none"}add(e){var t;e.message.status=null!=(t=e.message.status)?t:d.empty(),this.requests.done.push(e),e.message.end&&(this.resolved=!0)}abort(){this._abortController.abort()}}class he{constructor(e){this.events=new ne.a,this._pendingEdits=new Set,this._resolver=Object(p.g)(),this._editsQueue=new ue({processEdits:(e,t)=>this._processEdit(e,t)}),this._subscriptions=new Map,this._outSR=e.outSR,this._serviceInfo=e.serviceInfo,this._onTileUpdateMessage=e.onMessage}destroy(){this._editsQueue.clear()}async _onMessage(e){var t;const r=this._subscriptions.get(e.id);if(!r)return;const s={...e,remove:null!=(t=e.remove)?t:[],status:e.status};return this._onTileUpdateMessage(s,r.options)}update(e,t){var r;const s=t.fields.length;t.outFields=function(e,t){const r=new Set;return e&&e.forEach((e=>r.add(e))),t&&t.forEach((e=>r.add(e))),r.has("*")?["*"]:Array.from(r)}(null==(r=this._schema)?void 0:r.outFields,t.outFields),t.outFields=t.outFields.length>=.75*s?["*"]:t.outFields,t.outFields.sort();const i=Object(oe.a)(this._schema,t);if(!i)return;Object(n.a)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",i);const o={returnCentroid:Object(n.a)("esri-2d-query-centroid-enabled")&&"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,outFields:t.outFields,outSpatialReference:this._outSR,orderByFields:[`${this._serviceInfo.objectIdField} ASC`],where:t.definitionExpression||"1=1",gdbVersion:t.gdbVersion,historicMoment:t.historicMoment?new Date(t.historicMoment):null,timeExtent:ie.a.fromJSON(t.timeExtent)},a=this._schema&&Object(oe.b)(i,"outFields");this._schema&&Object(oe.c)(i,["timeExtent","definitionExpression","gdbVersion","historicMoment"])&&(e.why.mesh.push("Layer filter changed"),e.why.source.push("Layer filter changed"),e.mesh=!0,e.source=!0,e.queryFilter=!0,this._invalidate("all")),a&&(e.why.source.push("Layer required fields changed"),e.source=!0,this._invalidate("fields")),Object(oe.a)(o,this._queryInfo)&&(this._queryInfo=o),this._schema=t,this._resolver.resolve()}whenInitialized(){return this._resolver.promise}async applyUpdate(e){e.queryFilter?this.refresh():(this._subscriptions.forEach((t=>t.applyUpdate(e))),await this.resend())}refresh(){for(const e of this._tiles())this.unsubscribe(e),this.subscribe(e)}_tiles(){const e=[];return this._subscriptions.forEach((t=>e.push(t.tile))),e}pause(){this._subscriptions.forEach((e=>e.abort()))}subscribe(e){const t=new le(e);this._subscriptions.set(e.id,t)}unsubscribe(e){const t=this.get(e.id);Object(f.k)(t)&&t.abort(),this._subscriptions.delete(e.id)}forEachPendingEdit(e){Array.from(this._subscriptions.values()).some((e=>"none"!==e.invalid))?this._pendingEdits.forEach(e):this._pendingEdits.clear()}async edit(e){return this._editsQueue.push(e)}createQuery(e={}){return new T.a({...this._queryInfo,...e})}get(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null}async queryLastEditDate(){throw new Error("Service does not support query type")}async query(e,t){throw new Error("Service does not support query")}_invalidate(e){this._subscriptions.forEach((t=>t.invalidate(e)))}async _processEdit(e,t){t.forEach((e=>{this._pendingEdits.has(e)&&this._pendingEdits.delete(e)})),e.forEach((e=>this._pendingEdits.add(e)));const r=Array.from(this._subscriptions.values()).map((({tile:e})=>e)).map((t=>{const r=this.createTileQuery(t);return r.objectIds=e,{tile:t,query:r}})).map((async({tile:e,query:t})=>({tile:e,result:await this.query(t)}))),s=(await Object(p.b)(r)).map((async({tile:r,result:s})=>{if(s.hasFeatures||t.length||e.length)return this._subscriptions.get(r.key.id)?this._onMessage({type:"update",id:r.key.id,addOrUpdate:s,remove:[...e,...t],end:!0,status:d.empty()}):void 0}));await Promise.all(s),this._invalidate("all")}}const de=i.a.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource");class fe extends he{constructor(e){super(e),this.type="feature",this.mode="on-demand",this._adapter=K(e.serviceInfo),this._queue=new _.a({concurrency:8,process:async e=>{if(Object(p.u)(e),Object(f.k)(e.tile)){const t=e.tile.key.id,{tile:r,signal:s}=e,i={query:Object(n.a)("esri-tiles-debug")?{tile:t.replace(/\//g,"."),depth:e.depth}:void 0,signal:s,transform:r.transform};return this._adapter.executeQuery(e.query,i)}return this._adapter.executeQuery(e.query,e)}}),this._patchQueue=new _.a({concurrency:8,process:async e=>{if(Object(p.u)(e),Object(f.k)(e.tile)){const t=e.tile.key.id,{tile:r,signal:s}=e,i={query:Object(n.a)("esri-tiles-debug")?{tile:t.replace(/\//g,"."),depth:e.depth}:void 0,signal:s,transform:r.transform};return this._adapter.executeQuery(e.query,i)}return this._adapter.executeQuery(e.query,e)}})}destroy(){super.destroy(),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}get updating(){return!!this._queue.length}get maxRecordCountFactor(){const{query:e}=this._serviceInfo.capabilities;return e.supportsMaxRecordCountFactor?4:null}get maxPageSize(){var e;const{query:t}=this._serviceInfo.capabilities;return(null!=(e=t.maxRecordCount)?e:8e3)*Object(f.r)(this.maxRecordCountFactor,1)}get pageSize(){return Math.min(8e3,this.maxPageSize)}enableEvent(e,t){}subscribe(e){super.subscribe(e),this._fetchDataTile(e).catch((t=>{Object(p.m)(t)||de.error(new I.a("mapview-query-error","Encountered error when fetching tile",{tile:e,error:t}))}))}unsubscribe(e){super.unsubscribe(e)}resume(){this._queue.resume()}forEachRequest(e,t){const r=this._subscriptions.get(e),{requests:s,signal:n}=r;for(const i of s.done)t(i.message,{signal:n})}async query(e,t){return this._adapter.executeQuery(e,t)}async queryLastEditDate(){const e=this._serviceInfo.source,t={...e.query,f:"json"};return(await Object(S.default)(e.path,{query:t,responseType:"json"})).data.editingInfo.lastEditDate}createTileQuery(e){const t=this.createQuery();return t.quantizationParameters=e.getQuantizationParameters(),t.resultType="tile",t.geometry=e.extent,"esriGeometryPolyline"===this._serviceInfo.geometryType&&(t.maxAllowableOffset=e.resolution),this._serviceInfo.capabilities.query.supportsQuantization||(t.quantizationParameters=null,t.maxAllowableOffset=e.resolution),t}_createQuery(e,t){const r=new T.a({...this._queryInfo,...t});return this._serviceInfo.capabilities.query.supportsQuantization||(t.quantizationParameters=null,r.maxAllowableOffset=e.resolution),t.quantizationParameters&&"esriGeometryPolyline"===this._serviceInfo.geometryType&&(r.maxAllowableOffset=e.resolution),r.resultType="tile",r.geometry=e.extent,r}async _executePatchQuery(e,t,r,s){const n=t.clone();n.outFields=[this._serviceInfo.objectIdField,...r],n.returnCentroid=!1,n.returnGeometry=!1;const i=Object(f.k)(n.start)?n.start/8e3:0,o=s.signal;return this._patchQueue.push({tile:e,query:n,signal:o,depth:i})}async _resend(e,t){const{query:r,message:s}=e,n=Object(f.k)(r.outFields)?r.outFields:[],i=this._queryInfo.outFields,o=i.filter((e=>-1===n.indexOf(e)));if(!Object(f.j)(s.addOrUpdate))if(o.length)try{const e=this._subscriptions.get(s.id).tile,n=await this._executePatchQuery(e,r,o,t);Object(p.u)(t),r.outFields=i,s.addOrUpdate.joinAttributes(n),this._onMessage({...s,end:s.end,type:"append"})}catch(a){}else this._onMessage({...s,end:s.end,type:"append"})}async resend(){let e=0,t=!1;const r=[];for(this._subscriptions.forEach((e=>{e.requests.done.length||this._onMessage({id:e.tile.id,addOrUpdate:null,end:!1,type:"append"})}));!t;)t=!0,this._subscriptions.forEach((({requests:s,signal:n})=>{s.done.length>e&&(t=!1,r.push(this._resend(s.done[e],{signal:n})))})),e++;await Promise.all(r)}}const pe=Object(n.a)("esri-mobile"),ge={maxDrillLevel:pe?1:4,maxRecordCountFactor:pe?1:3};class me extends fe{constructor(e){super(e)}async _fetchDataTile(e){const t=this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,r=this._subscriptions.get(e.key.id),s=r.signal,n=e.getQuantizationParameters();let i=0;const o=async(a,u)=>{const c=this._queryInfo,l=this._createQuery(a,{maxRecordCountFactor:t?ge.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:n});i++;try{const t=await this._queue.push({tile:e,query:l,signal:s,depth:u});if(i--,Object(p.u)(s),!t)return;if(c!==this._queryInfo)return void o(a,u);if(t.exceededTransferLimit&&u<ge.maxDrillLevel){for(const e of a.createChildTiles())o(e,u+1);return}const n={id:e.id,addOrUpdate:t,end:0===i,type:"append"};r.add({query:l,message:n}),this._onMessage(n)}catch(h){Object(p.m)(h)||this._onMessage({id:e.id,addOrUpdate:null,end:!0,type:"append"})}};o(e,0)}}var ye=r(417),be=r(108);var _e=class{constructor(e,t,r,s,n=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=r,this._purgeOptions=s,this.store=e,this.objectIdField=t,this.purgeInterval=n,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}add(e){if(this._useGeneratedIds){const t=this._nextId();e.attributes[this.objectIdField]=t,e.objectId=t}else e.objectId=e.attributes[this.objectIdField];if(this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return Object(f.j)(this._trackIdLessObservations)&&(this._trackIdLessObservations=new ce.a(1e5)),void this._trackIdLessObservations.enqueue(e.objectId);const t=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(t)){const e=Object(f.k)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,r=Object(be.d)(e,0,1e3);this._trackIdToObservations.set(t,new ce.a(r))}const r=this._trackIdToObservations.get(t).enqueue(e.objectId);Object(f.k)(r)&&(this._addOrUpdated.has(r)?this._addOrUpdated.delete(r):this._removed.push(r))}checkForUpdates(){const e=this._getToAdd(),t=this._getToRemove(),r=performance.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(r),this._lastPurge=r);const s=[];if(Object(f.k)(t))for(const n of t){const e=this.store.removeById(n);Object(f.k)(e)&&s.push(e)}if(Object(f.k)(e))for(const n of e)n.attributes.__esri_timestamp__=r,this.store.add(n);(e||s)&&this.store.update(e,s)}_getToAdd(){if(!this._addOrUpdated.size)return null;const e=new Array(this._addOrUpdated.size);let t=0;return this._addOrUpdated.forEach((r=>e[t++]=r)),this._addOrUpdated.clear(),e}_getToRemove(){const e=this._removed;return this._removed.length?(this._removed=[],e):null}_nextId(){const e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}_purge(e){const t=this._purgeOptions;Object(f.k)(t)&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}_purgeSomeByDisplayCount(e){if(!e.displayCount)return;let t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField)for(const r of this._trackIdToObservations.values())if(t>e.displayCount&&r.size){const e=Object(f.q)(r.dequeue());this._removed.push(e),t--}if(Object(f.k)(this._trackIdLessObservations)){let r=t-e.displayCount;for(;r-- >0;){const e=this._trackIdLessObservations.dequeue();Object(f.k)(e)&&this._removed.push(e)}}}}_purgeByAge(e){var t;if(!e.age||null==(t=this._timeInfo)||!t.startTimeField)return;const r=60*e.age*1e3,s=this._maxAge-r;this.store.forEach((e=>{e.attributes[this._timeInfo.startTimeField]<s&&this._removed.push(e.objectId)}))}_purgeByAgeReceived(e,t){if(!t.ageReceived)return;const r=e+60*t.ageReceived*1e3;this.store.forEach((e=>{e.attributes.__esri_timestamp__<r&&this._removed.push(e.objectId)}))}_purgeTracks(){this._trackIdToObservations.forEach(((e,t)=>{0===e.size&&this._trackIdToObservations.delete(t)}))}},ve=r(209);let xe=class extends(ne.a.EventedMixin(u.a)){onFeature(e){this.emit("feature",e)}};xe=Object(s.a)([Object(a.a)("esri.layers.graphics.sources.connections.StreamConnection")],xe);var we=xe;const Oe=i.a.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");var je,Ie;(Ie=je||(je={}))[Ie.CONNECTING=0]="CONNECTING",Ie[Ie.OPEN=1]="OPEN",Ie[Ie.CLOSING=2]="CLOSING",Ie[Ie.CLOSED=3]="CLOSED";let Se=class extends we{constructor(e){super(),this.errorString=null;const{geometryType:t,spatialReference:r,sourceSpatialReference:s}=e;this._config=e,this._featureZScaler=Object(ve.a)(t,s,r),this._open()}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){Object(f.k)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(Object(f.j)(this._websocket))return"disconnected";switch(this._websocket.readyState){case je.CONNECTING:case je.OPEN:return"connected";case je.CLOSING:case je.CLOSED:return"disconnected"}}async _tryCreateWebSocket(e=this._config.source.path,t=1e3,r=0){try{if(this.destroyed)return;this._websocket=await this._createWebSocket(e),this.notifyChange("connectionStatus")}catch(s){const n=t/1e3;return this._config.maxReconnectionAttempts&&r>=this._config.maxReconnectionAttempts?(Oe.error(new I.a("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void this.destroy()):(Oe.error(new I.a("websocket-connection",`Failed to connect. Attempting to reconnect in ${n}s`,s)),await Object(p.a)(t),this._tryCreateWebSocket(e,Math.min(1.5*t,1e3*this._config.maxReconnectionInterval),r+1))}}_createWebSocket(e){const t=new WebSocket(e),r=new Promise(((e,r)=>{t.onopen=()=>e(t),t.onclose=e=>r(e)}));return r.then((()=>{if(this.destroyed)return t.onclose=()=>{},void t.close();t.onclose=e=>this._onClose(e),t.onerror=e=>this._onError(e),t.onmessage=e=>this._onMessage(e)})),r}async _handshake(e=1e4){const t=this._websocket;if(Object(f.j)(t))return;const r=Object(p.g)(),s=t.onmessage,{filter:n,outFields:i,spatialReference:o}=this._config;return r.timeout(e),t.onmessage=e=>{var a;let u=null;try{u=JSON.parse(e.data)}catch(c){}u&&"object"==typeof u||(Oe.error(new I.a("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),r.reject(),this.destroy()),(null==(a=u.spatialReference)?void 0:a.wkid)!==(null==o?void 0:o.wkid)&&(Oe.error(new I.a("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${o.wkid}`,e.data)),r.reject(),this.destroy()),"json"!==u.format&&(Oe.error(new I.a("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),r.reject(),this.destroy()),n&&u.filter!==n&&Oe.error(new I.a("websocket-connection","Tried to set filter, but server doesn't support it")),i&&u.outFields!==i&&Oe.error(new I.a("websocket-connection","Tried to set outFields, but server doesn't support it")),t.onmessage=s,r.resolve()},t.send(JSON.stringify({filter:n,outFields:i,format:"json",spatialReference:{wkid:o.wkid}})),r.promise}_onMessage(e){try{const t=JSON.parse(e.data);if("featureResult"!==t.type)throw new I.a("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);for(const e of t.features)this._featureZScaler&&this._featureZScaler(e.geometry),this.onFeature(e)}catch(t){return Oe.error(new I.a("websocket-connection","Failed to parse message",t)),void this.destroy()}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),Oe.error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&Oe.error("websocket-connection",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};Object(s.a)([Object(o.b)()],Se.prototype,"connectionStatus",null),Object(s.a)([Object(o.b)()],Se.prototype,"errorString",void 0),Se=Object(s.a)([Object(a.a)("esri.layers.graphics.sources.connections.WebSocketConnection")],Se);var Te=r(98);const Fe=i.a.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),Me={maxQueryDepth:5,maxRecordCountFactor:3};let ke=class extends Se{constructor(e){super({...Me,...e})}async _open(){const e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||Fe.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const t=await this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||(this._buddyServicesQuery=this._queryBuddyServices()),await this._buddyServicesQuery,await this._tryCreateWebSocket(t);const{filter:r,outFields:s}=this._config;this.destroyed||this._setFilter(r,s)}_onMessage(e){let t;try{t=this._enrich(JSON.parse(e.data)),this._featureZScaler&&this._featureZScaler(t.geometry)}catch(r){return void Fe.error(new I.a("geoevent-connection","Failed to parse message",r))}this.onFeature(t)}async _fetchServiceDefinition(e){const t=Object(S.default)(e.path,{query:{f:"json"},responseType:"json"}),r=(await t).data;return this._serviceDefinition=r,r}async _fetchWebSocketUrl(e,t){const r=e[0],{urls:s,token:n}=r;return`${this._inferWebSocketBaseUrl(s)}/subscribe?outSR=${t.wkid}${n?"&token="+n:""}`}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(-1!==t.indexOf("wss"))return t;return Fe.error(new I.a("geoevent-connection","Unable to infer WebSocket url",e)),null}async _setFilter(e,t){const r=this._websocket;if(Object(f.j)(r)||Object(f.j)(e)&&Object(f.j)(t))return;const s=JSON.stringify({filter:this._serializeFilter(e,t)});let n=!1;const i=Object(p.g)();return r.onmessage=e=>{const t=JSON.parse(e.data);t.filter&&(t.error&&(Fe.error(new I.a("geoevent-connection","Failed to set service filter",t.error)),this._set("errorString",`Could not set service filter - ${t.error}`),i.reject(t.error)),r.onmessage=this._onMessage.bind(this),n=!0,i.resolve())},r.send(s),setTimeout((()=>{n||(this.destroyed||this._websocket!==r||Fe.error(new I.a("geoevent-connection","Server timed out when setting filter")),i.reject())}),1e4),i.promise}_serializeFilter(e,t){const r={};if(Object(f.j)(e)&&Object(f.j)(t))return r;if(Object(f.k)(e)&&e.geometry)try{const t=Object(Te.a)(e.geometry);if("extent"!==t.type)throw new I.a(`Expected extent but found type ${t.type}`);r.geometry=JSON.stringify(t.shiftCentralMeridian())}catch(s){Fe.error(new I.a("geoevent-connection","Encountered an error when setting connection geometryDefinition",s))}return Object(f.k)(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),Object(f.k)(t)&&(r.outFields=t.join(",")),r}_enrich(e){if(!this._relatedFeatures)return e;const t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return Fe.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:s,geometry:n}=this._relatedFeatures.get(r);for(const i in s)e.attributes[i]=s[i];return n&&(e.geometry=n),e.geometry||e.centroid||Fe.error(new I.a("geoevent-connection","Found malformed feature - no geometry found",e)),e}async _queryBuddyServices(){try{const{relatedFeatures:e,keepLatestArchive:t}=this._serviceDefinition,r=this._queryRelatedFeatures(e),s=this._queryArchive(t);await r;const n=await s;if(!n)return;for(const i of n.features)this.onFeature(this._enrich(i))}catch(Ie){Fe.error(new I.a("geoevent-connection","Encountered an error when querying buddy services",{error:Ie}))}}async _queryRelatedFeatures(e){if(!e)return;const t=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(t)}async _queryArchive(e){if(e)return this._queryBuddy(e.featuresUrl)}async _queryBuddy(e){const t=new((await Promise.all([r.e(4),r.e(3),r.e(33),r.e(34),r.e(163)]).then(r.bind(null,268))).default)({url:e}),{capabilities:s}=await t.load(),n=s.query.supportsMaxRecordCountFactor,i=s.query.supportsPagination,o=s.query.supportsCentroid,a=this._config.maxRecordCountFactor,u=t.capabilities.query.maxRecordCount,c=n?u*a:u,l=new T.a;if(l.outFields=Object(f.r)(this._config.outFields,["*"]),l.where=Object(f.r)(Object(f.i)(this._config.filter,"where"),"1=1"),l.returnGeometry=!0,l.returnExceededLimitFeatures=!0,l.outSpatialReference=C.a.fromJSON(this._config.spatialReference),o&&(l.returnCentroid=!0),n&&(l.maxRecordCountFactor=a),i)return l.num=c,t.destroy(),this._queryPages(e,l);const h=await Object(M.executeQuery)(e,l,this._config.sourceSpatialReference);return t.destroy(),h.data}async _queryPages(e,t,r=[],s=0){t.start=Object(f.k)(t.num)?s*t.num:null;const{data:n}=await Object(M.executeQuery)(e,t,this._config.sourceSpatialReference);return n.exceededTransferLimit&&s<this._config.maxQueryDepth?(n.features.forEach((e=>r.push(e))),this._queryPages(e,t,r,s+1)):(r.forEach((e=>n.features.push(e))),n)}_addRelatedFeatures(e){const t=new Map,r=e.features,s=this._serviceDefinition.relatedFeatures.joinField;for(const n of r){const e=n.attributes[s];t.set(e,n)}this._relatedFeatures=t}};ke=Object(s.a)([Object(a.a)("esri.layers.graphics.sources.connections.GeoEventConnection")],ke);var Ce=ke;function Re(e,t){const r=e.weakClone(),s=Object(m.v)(t,e.geometry.coords[0]),n=Object(m.w)(t,e.geometry.coords[1]);return r.geometry=new G.a([],[s,n]),r}function Ae(e,t){const r=Object(ye.a)(9,function(e){switch(e){case"esriGeometryPoint":return e=>({minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]});default:return e=>{let t=1/0,r=1/0,s=-1/0,n=-1/0;return e.geometry.forEachVertex(((e,i)=>{t=Math.min(t,e),r=Math.min(r,i),s=Math.max(s,e),n=Math.max(n,i)})),{minX:t,minY:r,maxX:s,maxY:n}}}}(t));return r.load(e),r}class Ee{constructor(e,t){this.onUpdate=e,this._geometryType=t,this._objectIdToFeature=new Map}get _features(){const e=[];return this._objectIdToFeature.forEach((t=>e.push(t))),e}add(e){this._objectIdToFeature.set(e.objectId,e),this._index=null}get(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null}forEach(e){this._objectIdToFeature.forEach(e)}search(e){return this._index||(this._index=Ae(this._features,this._geometryType)),function(e,t){return e.search({minX:t.bounds[0],minY:t.bounds[1],maxX:t.bounds[2],maxY:t.bounds[3]})}(this._index,e)}removeById(e){const t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null}update(e,t){this.onUpdate(e,t)}get size(){return this._objectIdToFeature.size}}class Ne extends he{constructor(e){super(e),this.type="geoevent",this._dataReceiveEventEnabled=!1,this._level=0,this._updateInfo={websocket:0,client:0};const{outSR:t}=e,{geometryType:r,objectIdField:s,timeInfo:n,purgeOptions:i,source:o,spatialReference:a,serviceFilter:u,maxReconnectionAttempts:c,maxReconnectionInterval:l,updateInterval:h}=e.serviceInfo,d=new Ee(this._onUpdate.bind(this),r),f=new _e(d,s,n,i),p=function(e,t,r,s,n,i,o){const a=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),u={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:s,filter:n,maxReconnectionAttempts:i,maxReconnectionInterval:o};return a?new Se(u):new Ce(u)}(o,a,t,r,u,c,l);this._store=d,this._manager=f,this._connection=p,this._quantize=function(e){switch(e){case"esriGeometryPoint":return Re;case"esriGeometryPolygon":case"esriGeometryPolyline":default:return(t,r)=>{const s=t.weakClone(),n=new G.a,i=Object(m.u)(n,t.geometry,!1,!1,e,r,!1,!1);return s.geometry=i,s}}}(r),this._handles=[this._connection.on("feature",(e=>this._onFeature(e))),this._connection.watch("connectionStatus",(e=>this.events.emit("connectionStatus",e))),this._connection.watch("errorString",(e=>this.events.emit("errorString",e)))];let g=performance.now();this._updateIntervalId=setInterval((()=>{const t=performance.now(),r=t-g;if(r>2500){g=t;const e=Math.round(this._updateInfo.client/(r/1e3)),s=Math.round(this._updateInfo.websocket/(r/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit("updateRate",{client:e,websocket:s})}e.canAcceptRequest()&&this._manager.checkForUpdates()}),h)}destroy(){super.destroy(),clearInterval(this._updateIntervalId),this._handles.forEach((e=>e.remove())),this._connection.destroy()}_fetchDataTile(){}resume(){}enableEvent(e,t){"data-received"===e&&(this._dataReceiveEventEnabled=t)}get updating(){return!1}subscribe(e){super.subscribe(e);const t=this._subscriptions.get(e.id);this._level=e.level;const r=this._getTileFeatures(e);this._onMessage({type:"append",id:e.key.id,addOrUpdate:r,end:!0}),t.didSend=!0}unsubscribe(e){super.unsubscribe(e)}forEachRequest(e,t){const r=this._subscriptions.get(e),{tile:s,signal:n}=r,i={type:"append",tile:s,id:e,addOrUpdate:this._getTileFeatures(s),end:!0};t(i,{signal:n}),r.requests.stream.entries.forEach((e=>{Object(f.k)(e)&&t(e,{signal:n})}))}createTileQuery(e){throw new Error("Service does not support tile  queries")}async resend(){this._subscriptions.forEach((e=>{const{tile:t}=e,r={type:"append",id:t.id,addOrUpdate:this._getTileFeatures(t),end:!0};this._onMessage(r)}))}_getTileFeatures(e){const t=this._store.search(e).map((t=>this._quantize(t,e.transform)));return b.a.fromOptimizedFeatures(t,this._serviceInfo.geometryType,e.transform)}_onFeature(e){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",e);const t=Object(m.a)(e,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch(t){}}_onUpdate(e,t){Object(f.k)(e)&&(this._updateInfo.client+=e.length),this._subscriptions.forEach(((e,t)=>{e.didSend&&e.tile.level===this._level&&this._onMessage({type:"append",id:t,addOrUpdate:null,clear:!0,end:!1})})),this._subscriptions.forEach(((e,t)=>{if(!e.didSend||e.tile.level!==this._level)return;const r=e.tile,s={type:"append",id:t,addOrUpdate:this._getTileFeatures(r),remove:[],end:!0,status:d.empty()};e.requests.stream.enqueue(s),this._onMessage(s)}))}}const Pe=i.a.getLogger("esri.views.2d.layers.features.sources.FeatureSource");class qe extends fe{constructor(e){super(e)}async _fetchDataTile(e){const t=this._subscriptions.get(e.key.id);let r=!1,s=0,n=0;const i=(s,i)=>{n--,Object(p.u)(t);const o=e.id,a=s.reader,u=s.query;if(!a.exceededTransferLimit){if(r=!0,0!==i&&!a.hasFeatures){const e={id:o,addOrUpdate:a,end:0===n,type:"append"};return t.add({message:e,query:u}),void this._onMessage(e)}const e={id:o,addOrUpdate:a,end:0===n,type:"append"};return t.add({message:e,query:u}),void this._onMessage(e)}const c={id:o,addOrUpdate:a,end:r&&0===n,type:"append"};t.add({message:c,query:u}),this._onMessage(c)};let o=0,a=0;for(;!r&&a++<20;){let a;for(let u=0;u<o+1;u++){const o=s++;n++,a=this._fetchDataTilePage(e,o,t).then((e=>e&&i(e,o))).catch((t=>{r=!0,Object(p.m)(t)||(Pe.error(new I.a("mapview-query-error","Encountered error when fetching tile",{tile:e,error:t})),this._onMessage({id:e.id,addOrUpdate:null,end:r,type:"append"}))}))}await a,Object(p.u)(t),o=Math.min(o+2,6)}}async _fetchDataTilePage(e,t,r){const s=this._queryInfo,n={start:this.pageSize*t,num:this.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:e.getQuantizationParameters()};Object(f.k)(this.maxRecordCountFactor)&&(n.maxRecordCountFactor=this.maxRecordCountFactor);const i=this._createQuery(e,n);try{const n=r.signal,o=await this._queue.push({tile:e,query:i,signal:n,depth:t});return Object(p.u)(r),o?s!==this._queryInfo?this._fetchDataTilePage(e,t,r):{reader:o,query:i}:null}catch(o){return Object(p.v)(o),null}}}var ze=r(523),De=r(901);const Ge=i.a.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");function Le(e,t,r){const s=e.getXHydrate(),n=e.getYHydrate(),i=t.getColumnForX(s),o=Math.floor(t.normalizeCol(i));return`${r}/${Math.floor(t.getRowForY(n))}/${o}`}function Ue(e,t){if(Object(f.j)(e))return null;const r=t.transform,s=e.getQuantizationTransform();if(Object(f.j)(s)){const[t,s]=r.scale,[n,i]=r.translate,o=-n/t,a=1/t,u=i/s,c=1/-s;return e.transform(o,u,a,c)}const[n,i]=s.scale,[o,a]=s.translate,[u,c]=r.scale,[l,h]=r.translate,d=n/u,p=(o-l)/u,g=i/c,m=(-a+h)/c;return e.transform(p,m,d,g)}class Be extends fe{constructor(e){super(e),this.mode="snapshot",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new ze.a(1e3),this._featureCount=e.featureCount,this._store=e.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(e,t){super.update(e,t),this._hasAggregates=e.targets.aggregate}async resend(e=!1){if(await this._downloadPromise,this._invalidated||e)return this._invalidated=!1,this._subscriptions.forEach((e=>e.clear())),this._downloadPromise=this._download(this._featureCount),void await this._downloadPromise;const t=this._queries.map((({query:e,reader:t})=>this._sendPatchQuery(e,t)));await Promise.all(t),this._subscriptions.forEach((e=>{e.requests.done.forEach((e=>this._onMessage(e.message)))}))}async refresh(){await this.resend(!0)}async edit(e){const t=this._signal,r=[...e.addedFeatures.filter((e=>!e.error)).map((e=>e.objectId)),...e.updatedFeatures.filter((e=>!e.error)).map((e=>e.objectId))],s=[...e.deletedFeatures.filter((e=>!e.error)).map((e=>e.objectId)),...r];for(const o of s)this._store.remove(o);const n=this.createQuery();n.objectIds=r;const i=await this._queue.push({query:n,depth:0,signal:t});Object(p.u)({signal:t}),this._store.insert(i),this._send(i),this._invalidateQueries()}_invalidateQueries(){this._invalidated=!0}async _sendPatchQuery(e,t){const r=Object(f.k)(e.outFields)?e.outFields:[],s=this._queryInfo.outFields,n=s.filter((e=>-1===r.indexOf(e)));if(!n.length)return;const i=e.clone(),o=this._signal;i.returnGeometry=!1,i.returnCentroid=!1,i.outFields=n,e.outFields=s;const a=await this._queue.push({query:i,depth:0,signal:o});Object(p.u)({signal:o}),t.joinAttributes(a)}async _fetchDataTile(e){this._downloadPromise||(this._downloadPromise=this._download(this._featureCount));const t=this._store.search(e),r=this._subscriptions.get(e.key.id),s=t.length-1;for(let a=0;a<s;a++){const s=Ue(t[a],e),n={type:"append",id:e.id,addOrUpdate:s,end:!1,status:d.empty()};r.add({query:null,message:n}),this._hasAggregates||await Object(p.a)(1),this._onMessage(n)}const n=Ue(s>=0?t[s]:null,e),i=this._didSendEnd,o={type:"append",id:e.id,addOrUpdate:n,end:i,status:d.empty()};r.add({query:null,message:o}),this._onMessage(o)}async _download(e){try{await this.whenInitialized();const t=this._store.storage.getBitset(this._markedIdsBufId),r=new Set;t.clear();const s=Math.ceil(e/this.pageSize),n=Array.from({length:s},((e,t)=>t)).sort(((e,t)=>this._random.getInt()-this._random.getInt())).map((e=>this._downloadPage(e,t,r)));await Promise.all(n),this._store.sweepFeatures(t,this._store.storage),this._store.sweepFeatureSets(r)}catch(t){Ge.error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",t)}this._sendEnd(),this._loading=!1}async _downloadPage(e,t,r){const s=this.pageSize,n={start:e*s,num:s,cacheHint:!0};Object(f.k)(this.maxRecordCountFactor)&&(n.maxRecordCountFactor=this.maxRecordCountFactor);const i=this.createQuery(n),o=this._signal,a=await this._queue.push({query:i,depth:e,signal:o});Object(p.u)({signal:o}),this._queries.push({query:i,reader:a}),this._store.insert(a),r.add(a.instance);const u=a.getCursor();for(;u.next();)t.set(u.getDisplayId());this._send(a)}_send(e){if(!this._subscriptions.size)return;let t=null;const r=new Map,s=new Set,n=new Map;this._subscriptions.forEach((e=>{var i;const o=e.tile;r.set(o.key.id,null),t=o.tileInfoView,s.add(o.level);const{row:a,col:u}=o.key,c=`${o.level}/${a}/${u}`,l=null!=(i=n.get(c))?i:[];l.push(e),n.set(c,l)}));for(const i of s){const s=t.getLODInfoAt(i),o=e.getCursor();for(;o.next();){const e=Le(o,s,i),t=o.getIndex();if(n.has(e))for(const s of n.get(e)){const e=s.tile.id;let n=r.get(e);Object(f.j)(n)&&(n=[],r.set(e,n)),n.push(t)}}}r.forEach(((t,r)=>{if(Object(f.k)(t)){const s=this._subscriptions.get(r),n={type:"append",id:r,addOrUpdate:Ue(De.a.from(e,t),s.tile),end:!1,status:d.empty()};s.add({query:null,message:n}),this._onMessage(n)}}))}_sendEnd(){this._subscriptions.forEach((e=>{const t={type:"append",id:e.tile.id,addOrUpdate:null,end:!0,status:d.empty()};e.add({query:null,message:t}),this._onMessage(t)})),this._didSendEnd=!0}}function Ve(e,t,r,s,n,i){const o=function(e,t,r,s,n,i){switch(e.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:Object(f.r)(e.featureCount,0),serviceInfo:e,onMessage:s,outSR:t,tileInfoView:r,canAcceptRequest:n,store:i};case"stream":return{type:"geoevent",serviceInfo:e,onMessage:s,outSR:t,canAcceptRequest:n};case"memory":case"on-demand":return{type:"feature",serviceInfo:e,onMessage:s,outSR:t,origin:o(e.source),tileInfoView:r,canAcceptRequest:n}}function o(e){return Array.isArray(e)?"local":"path"in e&&Object(j.c)(e.path)?"hosted":"unknown"}}(e,t,r,s,n,i);switch(o.type){case"feature":switch(o.origin){case"hosted":case"local":return new qe(o);case"snapshot":return new Be(o);case"unknown":return new me(o)}case"geoevent":return new Ne(o)}}var Qe=r(136);new Float64Array(2),new Float64Array(2);function Ye(e,t,r,s){s%2&&(s+=1);let n=0,i=0,o=-90,a=90,u=-180,c=180;for(let l=0;l<s/2;l++){for(let e=0;e<5;e++){const t=(u+c)/2,s=r>t?1:0;n|=s<<29-(e+5*l),u=(1-s)*u+s*t,c=(1-s)*t+s*c}for(let e=0;e<5;e++){const r=(o+a)/2,s=t>r?1:0;i|=s<<29-(e+5*l),o=(1-s)*o+s*r,a=(1-s)*r+s*a}}e.geohashX=n,e.geohashY=i}function Xe(e,t,r,s,n){n%2&&(n+=1);let i=0,o=0,a=-90,u=90,c=-180,l=180;for(let h=0;h<n/2;h++){for(let e=0;e<5;e++){const t=(c+l)/2,r=s>t?1:0;i|=r<<29-(e+5*h),c=(1-r)*c+r*t,l=(1-r)*t+r*l}for(let e=0;e<5;e++){const t=(a+u)/2,s=r>t?1:0;o|=s<<29-(e+5*h),a=(1-s)*a+s*t,u=(1-s)*t+s*u}}e[2*t]=i,e[2*t+1]=o}class Je{constructor(e=[],t=8096){this._nodes=0,this._root=new Ze(0,0,0),this._statisticFields=e,this._pool=t?new ce.a(8096):null}_acquire(e,t,r){this._nodes++;let s=null;return Object(f.k)(this._pool)&&(s=this._pool.dequeue()),Object(f.k)(s)?s.realloc(e,t,r):new Ze(e,t,r)}_release(e){this._nodes--,Object(f.k)(this._pool)&&this._pool.enqueue(e)}get count(){return this._root.count}get size(){return this._nodes}get poolSize(){return Object(f.n)(this._pool,0,(e=>e.size))}get depth(){let e=0;return this._forEachNode((t=>e=Math.max(e,t.depth))),e}dropLevels(e){this._forEachNode((t=>{if(t.depth>=e)for(let e=0;e<t.children.length;e++){const r=t.children[e];t.children[e]=null,r&&this._release(r)}}))}clear(){this.dropLevels(0)}insert(e,t,r=0){const s=b.a.fromOptimizedFeatures([e],"esriGeometryPoint").getCursor();s.next();const n=s.readGeometry();if(!n)return;const[i,o]=n.coords,a=e.geohashX,u=e.geohashY;this.insertCursor(s,e.displayId,i,o,a,u,t,r)}insertCursor(e,t,r,s,n,i,o,a=0){let u=this._root,c=0,l=0,h=0;for(;null!==u;){if(u.depth>=a&&(u.count+=1,u.xTotal+=r,u.yTotal+=s,u.xGeohashTotal+=n,u.yGeohashTotal+=i,u.displayId=t,this._updateStatisticsCursor(e,u,1)),c>=o)return void u.add(t);const d=Math.ceil((c+1)/2),f=Math.floor((c+1)/2),p=1-c%2,g=30-(3*d+2*f),m=30-(2*d+3*f),y=(n&7*p+3*(1-p)<<g)>>g,b=(i&3*p+7*(1-p)<<m)>>m,_=y+b*(8*p+4*(1-p));l=l<<3*p+2*(1-p)|y,h=h<<2*p+3*(1-p)|b,null==u.children[_]&&(u.children[_]=this._acquire(l,h,c+1)),c+=1,u=u.children[_]}}remove(e,t){const r=b.a.fromOptimizedFeatures([e],"esriGeometryPoint").getCursor();r.next();const s=r.readGeometry();if(!s)return;const[n,i]=s.coords,o=e.geohashX,a=e.geohashY;this.removeCursor(r,n,i,o,a,t)}removeCursor(e,t,r,s,n,i){let o=this._root,a=0;for(;null!==o;){if(o.count-=1,o.xTotal-=t,o.yTotal-=r,o.xGeohashTotal-=s,o.yGeohashTotal-=n,this._updateStatisticsCursor(e,o,-1),a>=i)return void o.remove(e.getDisplayId());const u=Math.ceil((a+1)/2),c=Math.floor((a+1)/2),l=1-a%2,h=30-(3*u+2*c),d=30-(2*u+3*c),f=((s&7*l+3*(1-l)<<h)>>h)+((n&3*l+7*(1-l)<<d)>>d)*(8*l+4*(1-l)),p=o.children[f];1===p.count&&(this._release(p),o.children[f]=null),a+=1,o=p}}find(e,t,r){return this._root.find(e,t,r,0,0,0)}findSingleOccupancyNode(e,t,r,s,n){let i=this._root;for(;null!==i;){const o=i.depth,a=i.xNode,u=i.yNode,c=1-o%2,l=i.xGeohashTotal/i.count,h=i.yGeohashTotal/i.count;if(1===i.count&&e<l&&l<=r&&t<h&&h<=s)return i;if(o>=n){i=i.next;continue}const d=Math.ceil((o+1)/2),f=Math.floor((o+1)/2),p=30-(3*d+2*f),g=30-(2*d+3*f),m=~((1<<p)-1),y=~((1<<g)-1),b=(e&m)>>p,_=(t&y)>>g,v=(r&m)>>p,x=(s&y)>>g,w=a<<3*c+2*(1-c),O=u<<2*c+3*(1-c),j=w+8*c+4*(1-c),I=O+4*c+8*(1-c),S=Math.max(w,b),T=Math.max(O,_),F=Math.min(j,v),M=Math.min(I,x);let k=null,C=null;for(let e=T;e<=M;e++)for(let t=S;t<=F;t++){const r=t-w+(e-O)*(8*c+4*(1-c)),s=i.children[r];s&&(k||(k=s,k.next=i.next),C&&(C.next=s),C=s,s.next=i.next)}i=k||i.next}return null}getRegionDisplayIds(e,t,r,s,n){let i=this._root;const o=[];for(;null!==i;){const a=i.depth,u=i.xNode,c=i.yNode;if(a>=n){const n=i.xGeohashTotal/i.count,a=i.yGeohashTotal/i.count;e<=n&&n<=r&&t<=a&&a<=s&&i.displayIds.forEach((e=>o.push(e))),i=i.next;continue}const l=Math.ceil((a+1)/2),h=Math.floor((a+1)/2),d=1-a%2,f=30-(3*l+2*h),p=30-(2*l+3*h),g=~((1<<f)-1),m=~((1<<p)-1),y=(e&g)>>f,b=(t&m)>>p,_=(r&g)>>f,v=(s&m)>>p,x=u<<3*d+2*(1-d),w=c<<2*d+3*(1-d),O=x+8*d+4*(1-d),j=w+4*d+8*(1-d),I=Math.max(x,y),S=Math.max(w,b),T=Math.min(O,_),F=Math.min(j,v);let M=null,k=null;for(let e=S;e<=F;e++)for(let t=I;t<=T;t++){const r=t-x+(e-w)*(8*d+4*(1-d)),s=i.children[r];s&&(M||(M=s,M.next=i.next),k&&(k.next=s),k=s,s.next=i.next)}i=M||i.next}return o}getRegionStatistics(e,t,r,s,n){let i=this._root,o=0,a=0,u=0;const c={};let l=0;for(;null!==i;){const h=i.depth,d=i.xNode,f=i.yNode;if(h>=n){const n=i.xGeohashTotal/i.count,h=i.yGeohashTotal/i.count;e<n&&n<=r&&t<h&&h<=s&&(o+=i.count,a+=i.xTotal,u+=i.yTotal,1===i.count&&(l=i.displayId),this._aggregateStatistics(c,i.statistics)),i=i.next;continue}const p=Math.ceil((h+1)/2),g=Math.floor((h+1)/2),m=1-h%2,y=30-(3*p+2*g),b=30-(2*p+3*g),_=~((1<<y)-1),v=~((1<<b)-1),x=(e&_)>>y,w=(t&v)>>b,O=(r&_)>>y,j=(s&v)>>b,I=d<<3*m+2*(1-m),S=f<<2*m+3*(1-m),T=I+8*m+4*(1-m),F=S+4*m+8*(1-m),M=Math.max(I,x),k=Math.max(S,w),C=Math.min(T,O),R=Math.min(F,j);let A=null,E=null;for(let n=k;n<=R;n++)for(let h=M;h<=C;h++){const d=h-I+(n-S)*(8*m+4*(1-m)),f=i.children[d];if(f){if(n!==k&&n!==R&&h!==M&&h!==C){const n=f.xGeohashTotal/f.count,i=f.yGeohashTotal/f.count;e<n&&n<=r&&t<i&&i<=s&&(o+=f.count,a+=f.xTotal,u+=f.yTotal,1===f.count&&(l=f.displayId),this._aggregateStatistics(c,f.statistics));continue}A||(A=f,A.next=i.next),E&&(E.next=f),E=f,f.next=i.next}}i=A||i.next}return{count:o,attributes:this._normalizeStatistics(c,o),xTotal:a,yTotal:u,referenceId:l}}_forEachNode(e){let t=this._root;for(;null!==t;){const r=this._linkChildren(t)||t.next;e(t),t=r}}_linkChildren(e){let t=null,r=null;for(let s=0;s<=e.children.length;s++){const n=e.children[s];n&&(t||(t=n,t.next=e.next),r&&(r.next=n),r=n,n.next=e.next)}return t}_updateStatisticsCursor(e,t,r){for(const s of this._statisticFields){const n=s.name,i=s.inField?e.readAttribute(s.inField):e.getComputedNumericAtIndex(s.inFieldIndex);switch(s.statisticType){case"norm":{t.statistics[n]||(t.statistics[n]={});const o=s.inNormalizationField,a=e.readAttribute(o),u=t.statistics[n].onStatisticField||0,c=t.statistics[n].onStatisticNormalizationField||0;null==i||isNaN(i)||null==a||0===a||isNaN(a)||(t.statistics[n].onStatisticField=u+r*i,t.statistics[n].onStatisticNormalizationField=c+r*a);break}case"sum":case"avg":{t.statistics[n]||(t.statistics[n]={value:0,nanCount:0});const e=t.statistics[n].value,s=t.statistics[n].nanCount;null==i||isNaN(i)?t.statistics[n].nanCount=s+r:t.statistics[n].value=e+r*i;break}case"avg_angle":{t.statistics[n]||(t.statistics[n]={x:0,y:0,nanCount:0});const e=t.statistics[n].x,s=t.statistics[n].y,o=t.statistics[n].nanCount,a=Math.PI/180;null==i||isNaN(i)?t.statistics[n].nanCount=o+r:(t.statistics[n].x=e+r*Math.cos(i*a),t.statistics[n].y=s+r*Math.sin(i*a));break}case"mode":{t.statistics[n]||(t.statistics[n]={});const e=t.statistics[n][i]||0;t.statistics[n][i]=e+r;break}}}}_aggregateStatistics(e,t){for(const r of this._statisticFields){const s=r.name;switch(r.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":e[s]||(e[s]={});for(const r in t[s]){const n=e[s][r]||0;e[s][r]=n+t[s][r]}}}}_normalizeStatistics(e,t){const r={};for(const s of this._statisticFields){const n=s.name;switch(s.statisticType){case"norm":{const s=e[n];if(t&&null==s.onStatisticNormalizationField)break;if(t&&s.onStatisticNormalizationField){r[n]=s.onStatisticField/s.onStatisticNormalizationField;break}r[n]=0;break}case"sum":{if(!t)break;const{value:s,nanCount:i}=e[n];if(!(t-i))break;r[n]=s;break}case"avg":{if(!t)break;const{value:s,nanCount:i}=e[n];if(!(t-i))break;r[n]=s/(t-i);break}case"avg_angle":{if(!t)break;const{x:s,y:i,nanCount:o}=e[n];if(!(t-o))break;const a=s/(t-o),u=i/(t-o),c=180/Math.PI,l=Math.atan2(u,a)*c;r[n]=l;break}case"mode":{const t=e[n];let s=0,i=null;for(const e in t){const r=t[e];r>s&&(s=r,i=e)}r[n]="null"===i?null:i;break}}}return r}}class Ze{constructor(e,t,r){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this.children=new Array(32);for(let s=0;s<this.children.length;s++)this.children[s]=null;this.xNode=e,this.yNode=t,this.depth=r}realloc(e,t,r){for(let s=0;s<this.children.length;s++)this.children[s]=null;return this.xNode=e,this.yNode=t,this.depth=r,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}add(e){this.displayIds.add(e)}remove(e){this.displayIds.delete(e)}getLngLatBounds(){const e=this.depth,t=Math.ceil(e/2),r=Math.floor(e/2),s=30-(3*t+2*r),n=30-(2*t+3*r);return function(e,t){let r=-90,s=90,n=-180,i=180;for(let o=0;o<t;o++){const t=Math.ceil((o+1)/2),a=Math.floor((o+1)/2),u=1-o%2,c=30-(3*t+2*a),l=30-(2*t+3*a),h=3*u+2*(1-u),d=2*u+3*(1-u),f=3*u+7*(1-u)<<l,p=(7*u+3*(1-u)<<c&e.geohashX)>>c,g=(f&e.geohashY)>>l;for(let e=h-1;e>=0;e--){const t=(n+i)/2,r=p&1<<e?1:0;n=(1-r)*n+r*t,i=(1-r)*t+r*i}for(let e=d-1;e>=0;e--){const t=(r+s)/2,n=g&1<<e?1:0;r=(1-n)*r+n*t,s=(1-n)*t+n*s}}return[n,r,i,s]}({geohashX:this.xNode<<s,geohashY:this.yNode<<n},this.depth)}find(e,t,r,s,n,i){if(s>=r)return this;const o=1-s%2,a=3*o+2*(1-o),u=2*o+3*(1-o),c=30-n-a,l=30-i-u,h=((e&7*o+3*(1-o)<<c)>>c)+((t&3*o+7*(1-o)<<l)>>l)*(8*o+4*(1-o)),d=this.children[h];return null==d?null:d.find(e,t,r,s+1,n+a,i+u)}}var He=r(119),$e=r(397),We=r(927);class Ke extends D.a{constructor(e,t,r,s,n){super(new G.a([],[t,r]),s,null,e),this.geohashBoundsInfo=n}get count(){return this.attributes.cluster_count}static create(e,t,r,s,n,i,o,a){const u=new Ke(t,r,s,i,o);return u.displayId=e.createDisplayId(!0),u.referenceId=a,u.tileLevel=n,u}update(e,t,r,s,n,i){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=r,this.attributes=s,this.geohashBoundsInfo=n,this.referenceId=null,this.referenceId=i,this}toJSON(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:{...this.attributes,clusterId:this.objectId},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}function et(e){return 57.29577951308232*e}class tt extends We.a{constructor(e,t,r){super(e,r),this.events=new ne.a,this._geohashLevel=0,this._aggregateValueRanges={},this._aggregateValueRangesChanged=!1,this._geohashBuf=[],this._clusters=new Map,this._tiles=new Map,this.geometryInfo=e.geometryInfo,this._spatialReference=t,this._projectionSupportCheck=Object($e.a)(t,C.a.WGS84),this._bitsets.geohash=r.getBitset(r.createBitset()),this._bitsets.inserted=r.getBitset(r.createBitset())}async updateSchema(e,t){const r=this._schema;try{await super.updateSchema(e,t),await this._projectionSupportCheck}catch(i){}const s=Object(oe.a)(r,t);t&&(!Object(f.j)(s)||e.source||e.storage.filters)?((Object(oe.b)(s,"params.fields")||!this._tree||e.source)&&(this._tree=new Je(this._statisticFields),this._rebuildTree(),Object(n.a)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),Object(n.a)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",s),e.targets[t.name]=!0,e.mesh=!1,this._aggregateValueRanges={}):r&&(e.mesh=!0)}sweepFeatures(e,t){this._bitsets.inserted.forEachSet((r=>{if(!e.has(r)){const e=t.lookupByDisplayIdUnsafe(r);this._remove(e)}}))}sweepClusters(e,t,r){this._clusters.forEach(((s,n)=>{s&&s.tileLevel!==r&&(e.releaseDisplayId(s.displayId),t.unsetAttributeData(s.displayId),this._clusters.delete(n))}))}onTileData(e,t,r,s,n=!0){if(!this._schema||Object(f.j)(t.addOrUpdate))return t;const i=this._tree,o=this._getTransforms(e,this._spatialReference);{const e=t.addOrUpdate.getCursor();for(;e.next();)this._update(e,s,i)}if(t.status.mesh||!n)return t;const a=new Array,u=this._schema.params.clusterRadius;this._getClustersForTile(a,e,u,r,i,o),t.addOrUpdate=b.a.fromOptimizedFeatures(a,"esriGeometryPoint"),t.addOrUpdate.attachStorage(r),t.end=!0;{const s=t.addOrUpdate.getCursor();for(;s.next();){const t=s.getDisplayId();this._bitsets.computed.unset(t),this.setComputedAttributes(r,s,t,e.scale)}}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t}onTileUpdate({added:e,removed:t}){if(e.length){const t=e[0].level;this._setGeohashLevel(t)}if(!this._schema)return;const r=this._schema.params.clusterRadius;t.forEach((e=>{this._tiles.delete(e.key.id),this._markTileClustersForDeletion(e,r)}))}getAggregate(e){let t=null;return this._clusters.forEach((r=>{r&&r.displayId===e&&(t=r.toJSON())})),t}getDisplayId(e){const t=this._clusters.get(e);return t?t.displayId:null}getFeatureDisplayIdsForAggregate(e){const t=this._clusters.get(e);if(!t)return[];const r=t.geohashBoundsInfo;return this._tree.getRegionDisplayIds(r.xLL,r.yLL,r.xTR,r.yTR,r.level)}getDisplayIdForReferenceId(e){let t;return this._clusters.forEach((r=>{r&&r.referenceId===e&&(t=r.displayId)})),t}getAggregateValueRanges(){return this._aggregateValueRanges}forEach(e){this._clusters.forEach(((t,r)=>{t&&e(t,r)}))}size(){let e=0;return this.forEach((t=>e++)),e}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(e){const t=e.getDisplayId(),r=e.getXHydrate(),s=e.getYHydrate(),n=this._geohashBuf[2*t],i=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,r,s,n,i,this._geohashLevel))}_update(e,t,r){const s=e.getDisplayId(),n=this._bitsets.inserted,i=t.isVisible(s);if(i===n.has(s))return;if(!i)return void this._remove(e);const o=e.getXHydrate(),a=e.getYHydrate();if(!this._setGeohash(s,o,a))return;const u=this._geohashBuf[2*s],c=this._geohashBuf[2*s+1];r.insertCursor(e,s,o,a,u,c,this._geohashLevel),n.set(s)}_setGeohash(e,t,r){if(this._bitsets.geohash.has(e))return!0;const s=this._geohashBuf;if(this._spatialReference.isWebMercator){const n=et(t/Qe.a.radius),i=n-360*Math.floor((n+180)/360);Xe(s,e,et(Math.PI/2-2*Math.atan(Math.exp(-1*r/Qe.a.radius))),i,12)}else{const n=Object($e.b)({x:t,y:r},this._spatialReference,C.a.WGS84);if(!n)return!1;Xe(s,e,n.y,n.x,12)}return this._bitsets.geohash.set(e),!0}_getClustersForTile(e,t,r,s,n,i,o=!0){const a=this._schema.params.clusterPixelBuffer,u=2*r,c=this._getGeohashLevel(t.key.level),l=Math.ceil(2**t.key.level*He.E/u),h=Math.ceil(a/u)+0,d=Math.ceil(He.E/u),{row:p,col:g}=t.key,y=g*He.E,b=p*He.E,_=Math.floor(y/u)-h,v=Math.floor(b/u)-h,x=_+d+2*h,w=v+d+2*h,O=t.tileInfoView.getLODInfoAt(t.key.level);for(let j=_;j<=x;j++)for(let r=v;r<=w;r++){let a=j;O.wrap&&(a=j<0?j+l:j%l);const u=O.wrap&&j<0,h=O.wrap&&j%l!==j,d=this._lookupCluster(s,O,t.key.level,a,r,c,n);if(Object(f.k)(d)){const t=Object(f.b)(i,(e=>u?e.left:h?e.right:e.tile));if(o&&Object(f.j)(t))continue;if(!d.count)continue;if(Object(f.k)(t)&&o){const r=d.geometry.clone();let s=d.attributes;r.coords[0]=Object(m.v)(t,r.coords[0]),r.coords[1]=Object(m.w)(t,r.coords[1]),1===d.count&&Object(f.k)(d.referenceId)&&(s={...d.attributes,referenceId:d.referenceId});const n=new D.a(r,s);n.displayId=d.displayId,e.push(n)}}}}_getGeohashLevel(e){return Math.min(Math.ceil(e/2+2),12)}_setGeohashLevel(e){const t=this._getGeohashLevel(e),r=1*(Math.floor(t/1)+1)-1;if(this._geohashLevel!==r)return this._geohashLevel=r,this._rebuildTree(),void this._bitsets.geohash.clear()}_getTransforms(e,t){const r={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},s=Object(k.d)(t);if(!s)return{tile:r,left:null,right:null};const[n,i]=s.valid;return{tile:r,left:{...r,translate:[i,e.bounds[3]]},right:{...r,translate:[n-i+e.bounds[0],e.bounds[3]]}}}_getClusterId(e,t,r){return(15&e)<<28|(16383&t)<<14|16383&r}_markForDeletion(e,t,r){const s=this._getClusterId(e,t,r);this._clusters.delete(s)}_getClusterBounds(e,t,r){const s=this._schema.params.clusterRadius,n=2*s;let i=r%2?t*n:t*n-s;const o=r*n;let a=i+n;const u=o-n,c=2**e.level*He.E;e.wrap&&i<0&&(i=0),e.wrap&&a>c&&(a=c);const l=i/He.E,h=o/He.E,d=a/He.E,f=u/He.E;return[e.getXForColumn(l),e.getYForRow(h),e.getXForColumn(d),e.getYForRow(f)]}_lookupCluster(e,t,r,s,n,i,o){const a=this._getClusterId(r,s,n),u=this._clusters.get(a),[c,l,h,d]=this._getClusterBounds(t,s,n),p={x:c,y:l},g={x:h,y:d};let m=0,y=0,b=0,_=0;if(this._spatialReference.isWebMercator){{const e=et(p.x/Qe.a.radius);m=e-360*Math.floor((e+180)/360),y=et(Math.PI/2-2*Math.atan(Math.exp(-1*p.y/Qe.a.radius)))}{const e=et(g.x/Qe.a.radius);b=e-360*Math.floor((e+180)/360),_=et(Math.PI/2-2*Math.atan(Math.exp(-1*g.y/Qe.a.radius)))}}else{const e=Object($e.b)(p,this._spatialReference,C.a.WGS84),t=Object($e.b)(g,this._spatialReference,C.a.WGS84);if(!e||!t)return null;m=e.x,y=e.y,b=t.x,_=t.y}const v={geohashX:0,geohashY:0},x={geohashX:0,geohashY:0};Ye(v,y,m,i),Ye(x,_,b,i);const w=v.geohashX,O=v.geohashY,j=x.geohashX,I=x.geohashY,S={xLL:w,yLL:O,xTR:j,yTR:I,level:i},T=o.getRegionStatistics(w,O,j,I,i),{count:F,xTotal:M,yTotal:k,referenceId:R}=T,A=F?M/F:0,E=F?k/F:0;if(0===F)return this._clusters.set(a,null),null;const N={cluster_count:F,...T.attributes},P=Object(f.k)(u)?u.update(A,E,r,N,S,R):Ke.create(e,a,A,E,r,N,S,R);return 0===F&&(P.geometry.coords[0]=(c+h)/2,P.geometry.coords[1]=(l+d)/2),this._clusters.set(a,P),this._updateAggregateValueRangeForCluster(P,P.tileLevel),P}_updateAggregateValueRangeForCluster(e,t){const r=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},s=r.minValue,n=r.maxValue;r.minValue=Math.min(s,e.count),r.maxValue=Math.max(n,e.count),this._aggregateValueRanges[t]=r,s===r.minValue&&n===r.maxValue||(this._aggregateValueRangesChanged=!0)}_markTileClustersForDeletion(e,t){const r=2*t,s=Math.ceil(He.E/r),{row:n,col:i}=e.key,o=i*He.E,a=n*He.E,u=Math.floor(o/r),c=Math.floor(a/r);for(let l=u;l<u+s;l++)for(let t=c;t<c+s;t++)this._markForDeletion(e.key.level,l,t)}}function rt(e){if(!Object(p.m)(e)&&!function(e){return"worker:port-closed"===e.name}(e))throw e}function st(e){return"feature"===e.type&&"snapshot"===e.mode}let nt=class extends u.a{constructor(){super(...arguments),this._storage=new x.a,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null}initialize(){this._initAttributeStore(),this._initStores(),this._initQueryEngine(),this._initSource(),this._updateQueue=new _.a({concurrency:"geoevent"===this._source.type?1:4,process:(e,t)=>this._onTileMessage(e,{signal:t})}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),this.watch("updating",(e=>!e&&this.onIdle()))]),this._checkUpdating=setInterval((()=>this.notifyChange("updating")),300)}async startup(){this._initAttributeStore(),this.tileStore.tiles.forEach((e=>this._source.subscribe(e)))}_initSource(){const e=this.tileStore.tileScheme;this._source=Ve(this.service,this.spatialReference,e,((e,t)=>(this._invalidated=!0,this._patchTile(e,t))),(()=>this._updateQueue.length<50),this.featureStore),this._proxyEvents()}_proxyEvents(){if("geoevent"===this._source.type){const e=this._source.events;this.handles.add([e.on("connectionStatus",(e=>this.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:e}).catch(rt))),e.on("errorString",(e=>this.remoteClient.invoke("setProperty",{propertyName:"errorString",value:e}).catch(rt))),e.on("feature",(e=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry}}).catch(rt))),e.on("updateRate",(e=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:{...e}}).catch(rt)))])}}_initAttributeStore(){this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new v.a({type:"remote",initialize:(e,t)=>Object(p.l)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",e,{signal:t}).catch(rt)),update:(e,t)=>Object(p.l)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",e,{signal:t}).catch(rt)),render:e=>Object(p.l)(this.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:e}).catch(rt))},this.config)}_initStores(){const e="snapshot"===this.service.type?"snapshot":"on-demand",t={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.featureStore=new w.a(t,this._storage,e),this.aggregateStore=new tt(t,this.spatialReference,this._storage),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",(e=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:e.valueRanges}}).catch(rt)})))}_initQueryEngine(){var e;const t=this;null==(e=this.queryEngine)||e.destroy(),this.queryEngine=new O.a({definitionExpression:this.config.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:e=>t.aggregateStore.getFeatureDisplayIdsForAggregate(e).map((e=>t.getObjectId(e)))},timeInfo:this.service.timeInfo})}destroy(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy(),clearInterval(this._checkUpdating)}get fieldsIndex(){return new y.a(this.service.fields)}get hasAggregates(){return!!this.config.schema.targets.aggregate}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get updating(){return this.isUpdating()}isUpdating(){return this._source.updating||!!this._updateQueue.length}enableEvent(e){this._source.enableEvent(e.name,e.value)}pause(){this._updateQueue.pause(),this._updateQueue.clear()}async update(e,t){this._set("config",t),this._schema=t.schema,this._initQueryEngine(),await Promise.all([this._source.update(e,t.schema.source),this.featureStore.updateSchema(e,t.schema.targets.feature),this.attributeStore.update(e,t),this.attributeStore.updateFilters(e,this)]),await this.aggregateStore.updateSchema(e,t.schema.targets.aggregate),Object(n.a)("esri-2d-update-debug")&&e.describe()}async applyUpdate(e){e.mesh&&this.clearTiles(),this._updateQueue.clear(),this._updateQueue.resume(),await this._source.applyUpdate(e),this.notifyChange("updating"),await Object(g.g)(this,"updating",!0),this.hasAggregates&&(await Object(p.a)(10),await Object(g.g)(this,"updating",!0))}async onEdits(e){try{const t=e.deletedFeatures.map((e=>({...e,objectId:e.objectId&&-1!==e.objectId?e.objectId:this._lookupObjectIdByGlobalId(e.globalId)})));this.featureStore.invalidate(),await this._source.edit({...e,deletedFeatures:t})}catch(t){}}async refresh(){this.featureStore.invalidate(),this.clearTiles(),this._source.refresh(),this._cleanupNeeded=!0,this.notifyChange("updating"),await Object(g.g)(this,"updating",!0)}clearTiles(){for(const e of this.tileStore.tiles)this.processor.onTileClear(e)}onTileUpdate(e){this.aggregateStore.onTileUpdate(e);for(const t of e.added)this._source.subscribe(t),this._level=t.level;for(const t of e.removed)this._source.unsubscribe(t),this._cleanupNeeded=!0,this._tileToResolver.has(t.id)&&(this._tileToResolver.get(t.id).resolve(),this._tileToResolver.delete(t.id));this.notifyChange("updating")}onIdle(){this._invalidated&&((this.hasAggregates||"heatmap"===this.processor.type)&&this._repushTiles(),this._invalidated=!1),this._markAndSweep()}queryExtent(e){return this.queryEngine.executeQueryForExtent(e)}queryFeatures(e){return this.queryEngine.executeQuery(e)}queryFeatureCount(e){return this.queryEngine.executeQueryForCount(e)}queryLatestObservations(e){return this.queryEngine.executeQueryForLatestObservations(e)}queryObjectIds(e){return this.queryEngine.executeQueryForIds(e)}async queryStatistics(){return{...this.featureStore.storeStatistics,displayedFeatureCount:0,displayedVertexCount:0,displayPreProcessTime:0}}getObjectId(e){return this.featureStore.lookupObjectId(e,this._storage)}getDisplayId(e){if(this._schema.targets.aggregate){const t=this.aggregateStore.getDisplayId(e);if(Object(f.j)(t)){const t=this.featureStore.lookupDisplayId(e);return this.aggregateStore.getDisplayIdForReferenceId(t)}return t}return this.featureStore.lookupDisplayId(e)}getFeature(e){const t=this.featureStore.lookupFeatureByDisplayId(e,this._storage);if(Object(f.j)(t))return null;const r=t.readHydratedGeometry(),s=Object(m.k)(r,t.geometryType,t.hasZ,t.hasM);return{attributes:t.readAttributes(),geometry:s}}getAggregate(e){return this.aggregateStore.getAggregate(e)}async setHighlight(e){const t=e.map((e=>this.getDisplayId(e)));return this.attributeStore.setHighlight(e,t)}_lookupObjectIdByGlobalId(e){const t=this.service.globalIdField;if(Object(f.j)(t))throw new Error("Expected globalIdField to be defined");let r=null;if(this.featureStore.forEach((s=>{e===s.readAttribute(t)&&(r=s.getObjectId())})),Object(f.j)(r))throw new Error(`Expected to find a feature with globalId ${e}`);return r}_repushTiles(){for(const e of this.tileStore.tiles)this._patchTile({type:"append",id:e.key.id,addOrUpdate:b.a.fromOptimizedFeatures([],this.service.geometryType),remove:[],end:!0,status:d.empty()})}_maybeForceCleanup(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}_patchTile(e,t){const r=this._updateQueue.push(e,t).then((()=>{this.notifyChange("updating")})).catch((e=>{this.notifyChange("updating")}));return this.notifyChange("updating"),r}async _onTileMessage(e,t){Object(p.u)(t);const r=this.tileStore.get(e.id);if(!r)return;if(e.clear)return this.processor.onTileClear(r);const s=e.status;e.remove.length&&(this._cleanupNeeded=!0);const n=[];for(const o of e.remove)n.push(this.featureStore.lookupDisplayId(o));e.remove=n;try{if(Object(f.j)(e.addOrUpdate))return void this.processor.onTileMessage(r,{...e,addOrUpdate:null},this.hasAggregates,t).catch(p.v);if(e.addOrUpdate.setArcadeSpatialReference(this.spatialReference),this.featureStore.hasInstance(e.addOrUpdate.instance)&&s.targets.feature||(s.targets.feature=!0,this.featureStore.onTileData(r,e)),s.storage.data&&s.storage.filters||(s.storage.data=!0,s.storage.filters=!0,this.attributeStore.onTileData(r,e),"geoevent"===this._source.type?(await this.attributeStore.sendUpdates(),Object(p.u)(t)):this.attributeStore.sendUpdates()),this.hasAggregates&&!s.targets.aggregate){s.targets.aggregate=!0;const t=st(this._source)&&this._source.loading,n=!st(this._source)||t||e.end;if(this.aggregateStore.onTileData(r,e,this._storage,this.attributeStore,n),!n)return;s.mesh||(this.attributeStore.onTileData(r,e),this.attributeStore.sendUpdates(),this.processor.onTileClear(r))}s.mesh||(s.mesh=!0,await this.processor.onTileMessage(r,e,this.hasAggregates,t),Object(p.u)(t)),this._maybeForceCleanup()}catch(i){Object(p.v)(i)}}_mark(e,t,r){const s=(4294901760&this._storage.getInstanceId(e))>>>16;e&&(t.add(s),r.set(e))}_markAndSweep(){if(this._lastCleanup=performance.now(),!this._cleanupNeeded||"geoevent"===this._source.type||"snapshot"===this._source.mode)return;this._cleanupNeeded=!1;const e=this._storage.getBitset(this._markedIdsBufId),t=new Set;e.clear();for(const r of this.tileStore.tiles)this._source.forEachRequest(r.key.id,(r=>{if(Object(f.j)(r.addOrUpdate))return;const s=r.addOrUpdate.getCursor();for(;s.next();){let r=s.getDisplayId();if(!r){const e=s.getObjectId();r=this.featureStore.lookupDisplayId(e)}this._mark(r,t,e)}}));this._source.forEachPendingEdit((r=>{const s=this.featureStore.lookupDisplayId(r);this._mark(s,t,e)})),this._updateQueue.forEach((r=>{for(const s of r.remove){const r=this.featureStore.lookupDisplayId(s);this._mark(r,t,e)}})),this.config.schema.targets.aggregate&&(this.aggregateStore.sweepFeatures(e,this.featureStore),this.aggregateStore.sweepClusters(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(e,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(t)}};Object(s.a)([Object(o.b)({constructOnly:!0})],nt.prototype,"tileStore",void 0),Object(s.a)([Object(o.b)()],nt.prototype,"config",void 0),Object(s.a)([Object(o.b)({readOnly:!0})],nt.prototype,"fieldsIndex",null),Object(s.a)([Object(o.b)()],nt.prototype,"processor",void 0),Object(s.a)([Object(o.b)({constructOnly:!0})],nt.prototype,"remoteClient",void 0),Object(s.a)([Object(o.b)({constructOnly:!0})],nt.prototype,"service",void 0),Object(s.a)([Object(o.b)()],nt.prototype,"spatialReference",null),Object(s.a)([Object(o.b)()],nt.prototype,"updating",null),nt=Object(s.a)([Object(a.a)("esri.views.2d.layers.features.controllers.FeatureController2D")],nt);var it=nt;const ot=new Set;function at(){return ot}let ut=class extends u.a{constructor(){super(...arguments),this.controller=null,this.processor=null,this.remoteClient=null,this.tileStore=null,this.service=null,this.viewState=null}initialize(){this.handles.add(this.watch("updating",(e=>{this.remoteClient.invoke("setUpdating",e).catch((e=>{}))})))}destroy(){var e,t,r;null==(e=this.controller)||e.destroy(),null==(t=this.processor)||t.destroy(),null==(r=this.tileStore)||r.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}get updating(){return!this.controller||this.controller.updating}async startup({service:e,config:t,tileInfo:r,tiles:s}){if(this.service=e,!this.tileStore){const e=new l.a(c.a.fromJSON(r));this.tileStore=new h.a(e)}this.tileStore.clear(),await this._createProcessorAndController(t),await this.update({config:t},!0),this.tileStore.updateTiles(s)}async updateTiles(e){this.tileStore.updateTiles(e)}async update({config:e},t=!1){const r=d.empty();return t||this.controller.pause(),await Promise.all([this.processor.update(r,e),this.controller.update(r,e)]),r.toJSON()}async applyUpdate(e){return this.controller.applyUpdate(d.create(e))}async _createProcessorAndController(e){await Promise.all([this._handleControllerConfig(e),this._handleProcessorConfig(e)]),this.controller.processor=this.processor}async _handleControllerConfig(e){const t=await this._createController(this.service,e);return await t.startup(),t}async _handleProcessorConfig(e){return this._createProcessor(this.service,e)}async _createController(e,t){this.controller&&this.controller.destroy();const{tileStore:r,remoteClient:s}=this,n=new it({service:e,config:t,tileStore:r,remoteClient:s});return this.controller=n,n}async _createProcessor(e,t){const s=t.schema.processors[0].type,n=(await function(e){return"heatmap"===e?r.e(169).then(r.bind(null,1201)):Promise.all([r.e(4),r.e(17),r.e(21),r.e(43),r.e(95)]).then(r.bind(null,1202))}(s)).default,{remoteClient:i,tileStore:o}=this,a=new n({service:e,config:t,tileStore:o,remoteClient:i});return this.processor&&this.processor.destroy(),this.processor=a,a}};Object(s.a)([Object(o.b)()],ut.prototype,"controller",void 0),Object(s.a)([Object(o.b)()],ut.prototype,"processor",void 0),Object(s.a)([Object(o.b)()],ut.prototype,"updating",null),Object(s.a)([Object(o.b)()],ut.prototype,"viewState",void 0),ut=Object(s.a)([Object(a.a)("esri.views.2d.layers.features.Pipeline")],ut);var ct=ut;t.default=ct},122:function(e,t,r){"use strict";r.d(t,"a",(function(){return O})),r.d(t,"b",(function(){return f})),r.d(t,"c",(function(){return i})),r.d(t,"d",(function(){return _})),r.d(t,"e",(function(){return p})),r.d(t,"f",(function(){return g})),r.d(t,"g",(function(){return y})),r.d(t,"h",(function(){return m})),r.d(t,"i",(function(){return n})),r.d(t,"j",(function(){return x})),r.d(t,"k",(function(){return c})),r.d(t,"l",(function(){return l})),r.d(t,"m",(function(){return a})),r.d(t,"n",(function(){return o})),r.d(t,"o",(function(){return d})),r.d(t,"p",(function(){return b})),r.d(t,"q",(function(){return v})),r.d(t,"r",(function(){return u})),r.d(t,"s",(function(){return h}));r(79),r(88);var s=r(101);function n(e=j){return[e[0],e[1],e[2],e[3]]}function i(e){return[e[0],e[1],e[2],e[3]]}function o(e,t,r,s,i=n()){return i[0]=e,i[1]=t,i[2]=r,i[3]=s,i}function a(e,t=n()){return t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax,t}function u(e,t){return new s.a({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:t})}function c(e,t,r=e){if("length"in t)w(t)?(r[0]=Math.min(e[0],t[0]),r[1]=Math.min(e[1],t[1]),r[2]=Math.max(e[2],t[2]),r[3]=Math.max(e[3],t[3])):2!==t.length&&3!==t.length||(r[0]=Math.min(e[0],t[0]),r[1]=Math.min(e[1],t[1]),r[2]=Math.max(e[2],t[0]),r[3]=Math.max(e[3],t[1]));else switch(t.type){case"extent":r[0]=Math.min(e[0],t.xmin),r[1]=Math.min(e[1],t.ymin),r[2]=Math.max(e[2],t.xmax),r[3]=Math.max(e[3],t.ymax);break;case"point":r[0]=Math.min(e[0],t.x),r[1]=Math.min(e[1],t.y),r[2]=Math.max(e[2],t.x),r[3]=Math.max(e[3],t.y)}return r}function l(e,t,r=e){const s=t.length;let n=e[0],i=e[1],o=e[2],a=e[3];for(let u=0;u<s;u++){const e=t[u];n=Math.min(n,e[0]),i=Math.min(i,e[1]),o=Math.max(o,e[0]),a=Math.max(a,e[1])}return r[0]=n,r[1]=i,r[2]=o,r[3]=a,r}function h(e){return e[0]>=e[2]?0:e[2]-e[0]}function d(e){return e[1]>=e[3]?0:e[3]-e[1]}function f(e){return h(e)*d(e)}function p(e,t){return m(e,t[0],t[1])}function g(e,t){return m(e,t.x,t.y)}function m(e,t,r){return t>=e[0]&&r>=e[1]&&t<=e[2]&&r<=e[3]}function y(e,t,r){return t[0]>=e[0]-r&&t[1]>=e[1]-r&&t[0]<=e[2]+r&&t[1]<=e[3]+r}function b(e,t){return Math.max(t[0],e[0])<=Math.min(t[2],e[2])&&Math.max(t[1],e[1])<=Math.min(t[3],e[3])}function _(e,t){return t[0]>=e[0]&&t[2]<=e[2]&&t[1]>=e[1]&&t[3]<=e[3]}function v(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function x(e){return e?v(e,O):n(O)}function w(e){return 4===e.length}const O=[1/0,1/0,-1/0,-1/0],j=[0,0,0,0]},129:function(e,t,r){"use strict";var s,n=r(81),i=(r(79),r(90)),o=r(88),a=(r(80),r(87)),u=r(84),c=r(114),l=r(93),h=r(83),d=r(94),f=(r(82),r(85),r(86),r(89)),p=r(97),g=r(111),m=r(98),y=r(99),b=r(147),_=r(167),v=r(247),x=r(243);const w=new l.a({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),O=new l.a({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let j=s=class extends f.a{constructor(e){super(e),this.aggregateIds=null,this.cacheHint=void 0,this.datumTransformation=null,this.distance=void 0,this.dynamicDataSource=void 0,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=void 0,this.groupByFieldsForStatistics=null,this.having=null,this.historicMoment=null,this.maxAllowableOffset=void 0,this.maxRecordCountFactor=1,this.multipatchOption=null,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.outStatistics=null,this.parameterValues=null,this.pixelSize=null,this.quantizationParameters=null,this.rangeValues=null,this.relationParameter=null,this.resultType=null,this.returnCentroid=!1,this.returnDistinctValues=!1,this.returnExceededLimitFeatures=!0,this.returnGeometry=!1,this.returnQueryGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.sourceSpatialReference=null,this.spatialRelationship="intersects",this.start=void 0,this.sqlFormat=null,this.text=null,this.timeExtent=null,this.units=null,this.where=null}static from(e){return Object(a.d)(s,e)}castDatumTransformation(e){return"number"==typeof e||"object"==typeof e?e:null}writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}writeParameterValues(e,t){if(e){const r={};for(const t in e){const s=e[t];Array.isArray(s)?r[t]=s.map((e=>e instanceof Date?e.getTime():e)):s instanceof Date?r[t]=s.getTime():r[t]=s}t.parameterValues=r}}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10,t.where="1=1"}writeWhere(e,t){t.where=e||"1=1"}clone(){return new s(Object(i.a)({aggregateIds:this.aggregateIds,cacheHint:this.cacheHint,datumTransformation:this.datumTransformation,distance:this.distance,gdbVersion:this.gdbVersion,geometry:this.geometry,geometryPrecision:this.geometryPrecision,groupByFieldsForStatistics:this.groupByFieldsForStatistics,having:this.having,historicMoment:Object(o.k)(this.historicMoment)?new Date(this.historicMoment.getTime()):null,maxAllowableOffset:this.maxAllowableOffset,maxRecordCountFactor:this.maxRecordCountFactor,multipatchOption:this.multipatchOption,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,outStatistics:this.outStatistics,parameterValues:this.parameterValues,pixelSize:this.pixelSize,quantizationParameters:this.quantizationParameters,rangeValues:this.rangeValues,relationParameter:this.relationParameter,resultType:this.resultType,returnDistinctValues:this.returnDistinctValues,returnGeometry:this.returnGeometry,returnCentroid:this.returnCentroid,returnExceededLimitFeatures:this.returnExceededLimitFeatures,returnQueryGeometry:this.returnQueryGeometry,returnM:this.returnM,returnZ:this.returnZ,dynamicDataSource:this.dynamicDataSource,sourceSpatialReference:this.sourceSpatialReference,spatialRelationship:this.spatialRelationship,start:this.start,sqlFormat:this.sqlFormat,text:this.text,timeExtent:this.timeExtent,units:this.units,where:this.where}))}};j.MAX_MAX_RECORD_COUNT_FACTOR=5,Object(n.a)([Object(u.b)({json:{write:!0}})],j.prototype,"aggregateIds",void 0),Object(n.a)([Object(u.b)({type:Boolean,json:{write:{writer:(e,t)=>{null!=e&&(t.cacheHint=e)}}}})],j.prototype,"cacheHint",void 0),Object(n.a)([Object(u.b)({json:{write:!0}})],j.prototype,"datumTransformation",void 0),Object(n.a)([Object(c.a)("datumTransformation")],j.prototype,"castDatumTransformation",null),Object(n.a)([Object(u.b)({type:Number,json:{write:{overridePolicy:e=>({enabled:e>0})}}})],j.prototype,"distance",void 0),Object(n.a)([Object(u.b)({type:_.a,json:{write:!0}})],j.prototype,"dynamicDataSource",void 0),Object(n.a)([Object(u.b)({type:String,json:{write:!0}})],j.prototype,"gdbVersion",void 0),Object(n.a)([Object(u.b)({types:y.a,json:{read:m.a,write:!0}})],j.prototype,"geometry",void 0),Object(n.a)([Object(u.b)({type:Number,json:{write:!0}})],j.prototype,"geometryPrecision",void 0),Object(n.a)([Object(u.b)({type:[String],json:{write:!0}})],j.prototype,"groupByFieldsForStatistics",void 0),Object(n.a)([Object(u.b)({type:String,json:{write:!0}})],j.prototype,"having",void 0),Object(n.a)([Object(u.b)({type:Date})],j.prototype,"historicMoment",void 0),Object(n.a)([Object(d.a)("historicMoment")],j.prototype,"writeHistoricMoment",null),Object(n.a)([Object(u.b)({type:Number,json:{write:!0}})],j.prototype,"maxAllowableOffset",void 0),Object(n.a)([Object(u.b)({type:Number,cast:e=>e<1?1:e>s.MAX_MAX_RECORD_COUNT_FACTOR?s.MAX_MAX_RECORD_COUNT_FACTOR:e,json:{write:{overridePolicy:e=>({enabled:e>1})}}})],j.prototype,"maxRecordCountFactor",void 0),Object(n.a)([Object(u.b)({type:String,json:{write:!0}})],j.prototype,"multipatchOption",void 0),Object(n.a)([Object(u.b)({type:Number,json:{read:{source:"resultRecordCount"}}})],j.prototype,"num",void 0),Object(n.a)([Object(u.b)({json:{write:!0}})],j.prototype,"objectIds",void 0),Object(n.a)([Object(u.b)({type:[String],json:{write:!0}})],j.prototype,"orderByFields",void 0),Object(n.a)([Object(u.b)({type:[String],json:{write:!0}})],j.prototype,"outFields",void 0),Object(n.a)([Object(u.b)({type:p.a,json:{read:{source:"outSR"},write:{target:"outSR"}}})],j.prototype,"outSpatialReference",void 0),Object(n.a)([Object(u.b)({type:[x.a],json:{write:{enabled:!0,overridePolicy(){return{enabled:Object(o.k)(this.outStatistics)&&this.outStatistics.length>0}}}}})],j.prototype,"outStatistics",void 0),Object(n.a)([Object(u.b)({json:{write:!0}})],j.prototype,"parameterValues",void 0),Object(n.a)([Object(d.a)("parameterValues")],j.prototype,"writeParameterValues",null),Object(n.a)([Object(u.b)({type:g.a,json:{write:!0}})],j.prototype,"pixelSize",void 0),Object(n.a)([Object(u.b)({type:v.a,json:{write:!0}})],j.prototype,"quantizationParameters",void 0),Object(n.a)([Object(u.b)({type:[Object],json:{write:!0}})],j.prototype,"rangeValues",void 0),Object(n.a)([Object(u.b)({type:String,json:{read:{source:"relationParam"},write:{target:"relationParam",overridePolicy(){return{enabled:"relation"===this.spatialRelationship}}}}})],j.prototype,"relationParameter",void 0),Object(n.a)([Object(u.b)({type:String,json:{write:!0}})],j.prototype,"resultType",void 0),Object(n.a)([Object(u.b)({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],j.prototype,"returnCentroid",void 0),Object(n.a)([Object(u.b)({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],j.prototype,"returnDistinctValues",void 0),Object(n.a)([Object(u.b)({type:Boolean,json:{write:{overridePolicy:e=>({enabled:!e})}}})],j.prototype,"returnExceededLimitFeatures",void 0),Object(n.a)([Object(u.b)({type:Boolean,json:{write:!0}})],j.prototype,"returnGeometry",void 0),Object(n.a)([Object(u.b)({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],j.prototype,"returnQueryGeometry",void 0),Object(n.a)([Object(u.b)({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],j.prototype,"returnM",void 0),Object(n.a)([Object(u.b)({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],j.prototype,"returnZ",void 0),Object(n.a)([Object(u.b)({type:p.a,json:{write:!0}})],j.prototype,"sourceSpatialReference",void 0),Object(n.a)([Object(u.b)({type:String,json:{read:{source:"spatialRel",reader:w.read},write:{target:"spatialRel",writer:w.write}}})],j.prototype,"spatialRelationship",void 0),Object(n.a)([Object(u.b)({type:Number,json:{read:{source:"resultOffset"}}})],j.prototype,"start",void 0),Object(n.a)([Object(d.a)("start"),Object(d.a)("num")],j.prototype,"writeStart",null),Object(n.a)([Object(u.b)({type:String,json:{write:!0}})],j.prototype,"sqlFormat",void 0),Object(n.a)([Object(u.b)({type:String,json:{write:!0}})],j.prototype,"text",void 0),Object(n.a)([Object(u.b)({type:b.a,json:{write:!0}})],j.prototype,"timeExtent",void 0),Object(n.a)([Object(u.b)({type:String,json:{read:O.read,write:{writer:O.write,overridePolicy(e){return{enabled:e&&this.distance>0}}}}})],j.prototype,"units",void 0),Object(n.a)([Object(u.b)({type:String,json:{write:{overridePolicy(e){return{enabled:null!=e||this.start>0}}}}})],j.prototype,"where",void 0),Object(n.a)([Object(d.a)("where")],j.prototype,"writeWhere",null),j=s=Object(n.a)([Object(h.a)("esri.tasks.support.Query")],j);var I=j;t.a=I},130:function(e,t,r){"use strict";(function(e){r.d(t,"a",(function(){return i})),r.d(t,"b",(function(){return n})),r.d(t,"c",(function(){return s}));"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof e||"undefined"!=typeof self&&self;function s(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function n(e,t,r){return e(r={path:t,exports:{},require:function(e,t){return i(null==t&&r.path)}},r.exports),r.exports}function i(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}}).call(this,r(169))},137:function(e,t,r){"use strict";r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return u})),r.d(t,"c",(function(){return a})),r.d(t,"d",(function(){return o})),r.d(t,"e",(function(){return c}));r(79);var s=r(93);function n(e){return e}const i={milliseconds:{getter:"getMilliseconds",setter:"setMilliseconds",multiplier:1},seconds:{getter:"getSeconds",setter:"setSeconds",multiplier:1},minutes:{getter:"getMinutes",setter:"setMinutes",multiplier:1},hours:{getter:"getHours",setter:"setHours",multiplier:1},days:{getter:"getDate",setter:"setDate",multiplier:1},weeks:{getter:"getDate",setter:"setDate",multiplier:7},months:{getter:"getMonth",setter:"setMonth",multiplier:1},years:{getter:"getFullYear",setter:"setFullYear",multiplier:1},decades:{getter:"getFullYear",setter:"setFullYear",multiplier:10},centuries:{getter:"getFullYear",setter:"setFullYear",multiplier:100}},o=Object(s.b)()({esriTimeUnitsMilliseconds:"milliseconds",esriTimeUnitsSeconds:"seconds",esriTimeUnitsMinutes:"minutes",esriTimeUnitsHours:"hours",esriTimeUnitsDays:"days",esriTimeUnitsWeeks:"weeks",esriTimeUnitsMonths:"months",esriTimeUnitsYears:"years",esriTimeUnitsDecades:"decades",esriTimeUnitsCenturies:"centuries",esriTimeUnitsUnknown:null});function a(e,t,r){const s=new Date(e.getTime());if(t&&r){const e=i[r],{getter:n,setter:o,multiplier:a}=e;s[o](s[n]()+t*a)}return s}const u={milliseconds:1,seconds:1e3,minutes:6e4,hours:36e5,days:864e5,weeks:6048e5,months:26784e5,years:31536e6,decades:31536e7,centuries:31536e8};function c(e,t){switch(t){case"milliseconds":return new Date(e.getTime());case"seconds":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds());case"minutes":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes());case"hours":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours());case"days":return new Date(e.getFullYear(),e.getMonth(),e.getDate());case"weeks":return new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay());case"months":return new Date(e.getFullYear(),e.getMonth(),1);case"years":return new Date(e.getFullYear(),0,1);case"decades":return new Date(e.getFullYear()-e.getFullYear()%10,0,1);case"centuries":return new Date(e.getFullYear()-e.getFullYear()%100,0,1);default:return null}}},143:function(e,t,r){"use strict";r.r(t);var s=r(81),n=(r(79),r(88)),i=(r(80),r(87),r(84)),o=r(93),a=r(96),u=r(83),c=r(94),l=(r(82),r(85),r(86),r(89)),h=r(97),d=r(98),f=r(99),p=r(120),g=r(152);const m=new o.a({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh","":null});let y=class extends l.a{constructor(e){super(e),this.displayFieldName=null,this.exceededTransferLimit=!1,this.features=[],this.fields=null,this.geometryType=null,this.hasM=!1,this.hasZ=!1,this.queryGeometry=null,this.spatialReference=null}readFeatures(e,t){const r=h.a.fromJSON(t.spatialReference),s=[];for(let i=0;i<e.length;i++){const t=e[i],o=p.a.fromJSON(t),a=t.geometry&&t.geometry.spatialReference;Object(n.k)(o.geometry)&&!a&&(o.geometry.spatialReference=r),s.push(o)}return s}writeGeometryType(e,t,r,s){if(e)return void m.write(e,t,r,s);const{features:i}=this;if(i)for(const o of i)if(o&&Object(n.k)(o.geometry))return void m.write(o.geometry.type,t,r,s)}readQueryGeometry(e,t){if(!e)return null;const r=!!e.spatialReference,s=Object(d.a)(e);return!r&&t.spatialReference&&(s.spatialReference=h.a.fromJSON(t.spatialReference)),s}writeSpatialReference(e,t){if(e)return void(t.spatialReference=e.toJSON());const{features:r}=this;if(r)for(const s of r)if(s&&Object(n.k)(s.geometry)&&s.geometry.spatialReference)return void(t.spatialReference=s.geometry.spatialReference.toJSON())}toJSON(e){const t=this.write(null);if(t.features&&Array.isArray(e)&&e.length>0)for(let r=0;r<t.features.length;r++){const s=t.features[r];if(s.geometry){const t=e&&e[r];s.geometry=t&&t.toJSON()||s.geometry}}return t}quantize(e){const{scale:[t,r],translate:[s,i]}=e,o=this.features,a=this._getQuantizationFunction(this.geometryType,(e=>Math.round((e-s)/t)),(e=>Math.round((i-e)/r)));for(let u=0,c=o.length;u<c;u++)a(Object(n.q)(o[u].geometry))||(o.splice(u,1),u--,c--);return this.transform=e,this}unquantize(){const{geometryType:e,features:t,transform:r}=this;if(!r)return this;const{translate:[s,i],scale:[o,a]}=r,u=this._getHydrationFunction(e,(e=>e*o+s),(e=>i-e*a));for(const{geometry:c}of t)Object(n.k)(c)&&u(c);return this.transform=null,this}_quantizePoints(e,t,r){let s,n;const i=[];for(let o=0,a=e.length;o<a;o++){const a=e[o];if(o>0){const e=t(a[0]),o=r(a[1]);e===s&&o===n||(i.push([e-s,o-n]),s=e,n=o)}else s=t(a[0]),n=r(a[1]),i.push([s,n])}return i.length>0?i:null}_getQuantizationFunction(e,t,r){return"point"===e?e=>(e.x=t(e.x),e.y=r(e.y),e):"polyline"===e||"polygon"===e?e=>{const s=Object(d.g)(e)?e.rings:e.paths,n=[];for(let i=0,o=s.length;i<o;i++){const e=s[i],o=this._quantizePoints(e,t,r);o&&n.push(o)}return n.length>0?(Object(d.g)(e)?e.rings=n:e.paths=n,e):null}:"multipoint"===e?e=>{const s=this._quantizePoints(e.points,t,r);return s.length>0?(e.points=s,e):null}:"extent"===e?e=>e:null}_getHydrationFunction(e,t,r){return"point"===e?e=>{e.x=t(e.x),e.y=r(e.y)}:"polyline"===e||"polygon"===e?e=>{const s=Object(d.g)(e)?e.rings:e.paths;let n,i;for(let o=0,a=s.length;o<a;o++){const e=s[o];for(let s=0,o=e.length;s<o;s++){const o=e[s];s>0?(n+=o[0],i+=o[1]):(n=o[0],i=o[1]),o[0]=t(n),o[1]=r(i)}}}:"extent"===e?e=>{e.xmin=t(e.xmin),e.ymin=r(e.ymin),e.xmax=t(e.xmax),e.ymax=r(e.ymax)}:"multipoint"===e?e=>{const s=e.points;let n,i;for(let o=0,a=s.length;o<a;o++){const e=s[o];o>0?(n+=e[0],i+=e[1]):(n=e[0],i=e[1]),e[0]=t(n),e[1]=r(i)}}:void 0}};Object(s.a)([Object(i.b)({type:String,json:{write:!0}})],y.prototype,"displayFieldName",void 0),Object(s.a)([Object(i.b)({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],y.prototype,"exceededTransferLimit",void 0),Object(s.a)([Object(i.b)({type:[p.a],json:{write:!0}})],y.prototype,"features",void 0),Object(s.a)([Object(a.a)("features")],y.prototype,"readFeatures",null),Object(s.a)([Object(i.b)({type:[g.a],json:{write:!0}})],y.prototype,"fields",void 0),Object(s.a)([Object(i.b)({type:["point","multipoint","polyline","polygon","extent","mesh"],json:{read:{reader:m.read}}})],y.prototype,"geometryType",void 0),Object(s.a)([Object(c.a)("geometryType")],y.prototype,"writeGeometryType",null),Object(s.a)([Object(i.b)({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],y.prototype,"hasM",void 0),Object(s.a)([Object(i.b)({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],y.prototype,"hasZ",void 0),Object(s.a)([Object(i.b)({types:f.a,json:{write:!0}})],y.prototype,"queryGeometry",void 0),Object(s.a)([Object(a.a)("queryGeometry")],y.prototype,"readQueryGeometry",null),Object(s.a)([Object(i.b)({type:h.a,json:{write:!0}})],y.prototype,"spatialReference",void 0),Object(s.a)([Object(c.a)("spatialReference")],y.prototype,"writeSpatialReference",null),Object(s.a)([Object(i.b)({json:{write:!0}})],y.prototype,"transform",void 0),y=Object(s.a)([Object(u.a)("esri.tasks.support.FeatureSet")],y),y.prototype.toJSON.isDefaultToJSON=!0,y||(y={});var b=y;t.default=b},147:function(e,t,r){"use strict";var s,n=r(81),i=(r(79),r(80),r(87),r(84)),o=r(96),a=r(83),u=r(94),c=(r(82),r(85),r(86),r(89)),l=r(137);let h=s=class extends c.a{constructor(e){super(e),this.end=null,this.start=null}static get allTime(){return d}static get empty(){return f}readEnd(e,t){return null!=t.end?new Date(t.end):null}writeEnd(e,t){t.end=e?e.getTime():null}get isAllTime(){return this.equals(s.allTime)}get isEmpty(){return this.equals(s.empty)}readStart(e,t){return null!=t.start?new Date(t.start):null}writeStart(e,t){t.start=e?e.getTime():null}clone(){return new s({end:this.end,start:this.start})}expandTo(e){if(this.isEmpty||this.isAllTime)return this.clone();const t=this.start?Object(l.e)(this.start,e):null,r=this.end?Object(l.c)(Object(l.e)(this.end,e),1,e):null;return new s({start:t,end:r})}intersection(e){var t,r,n,i,o,a,u,c;if(!e)return this.clone();if(this.isEmpty||e.isEmpty)return s.empty;if(this.isAllTime)return e.clone();if(e.isAllTime)return this.clone();const l=null!=(t=null==(r=this.start)?void 0:r.getTime())?t:-1/0,h=null!=(n=null==(i=this.end)?void 0:i.getTime())?n:1/0,d=null!=(o=null==(a=e.start)?void 0:a.getTime())?o:-1/0,f=null!=(u=null==(c=e.end)?void 0:c.getTime())?u:1/0;let p,g;if(d>=l&&d<=h?p=d:l>=d&&l<=f&&(p=l),h>=d&&h<=f?g=h:f>=l&&f<=h&&(g=f),!isNaN(p)&&!isNaN(g)){const e=new s;return e.start=p===-1/0?null:new Date(p),e.end=g===1/0?null:new Date(g),e}return s.empty}offset(e,t){if(this.isEmpty||this.isAllTime)return this.clone();const r=new s,{start:n,end:i}=this;return n&&(r.start=Object(l.c)(n,e,t)),i&&(r.end=Object(l.c)(i,e,t)),r}equals(e){if(!e)return!1;const t=this.start?this.start.getTime():this.start,r=this.end?this.end.getTime():this.end,s=e.start?e.start.getTime():e.start,n=e.end?e.end.getTime():e.end;return t===s&&r===n}union(e){if(!e||e.isEmpty)return this.clone();if(this.isEmpty)return e.clone();if(this.isAllTime||e.isAllTime)return d.clone();const t=this.start&&e.start?new Date(Math.min(this.start.getTime(),e.start.getTime())):null,r=this.end&&e.end?new Date(Math.max(this.end.getTime(),e.end.getTime())):null;return new s({start:t,end:r})}};Object(n.a)([Object(i.b)({type:Date,json:{write:{allowNull:!0}}})],h.prototype,"end",void 0),Object(n.a)([Object(o.a)("end")],h.prototype,"readEnd",null),Object(n.a)([Object(u.a)("end")],h.prototype,"writeEnd",null),Object(n.a)([Object(i.b)({readOnly:!0,json:{read:!1}})],h.prototype,"isAllTime",null),Object(n.a)([Object(i.b)({readOnly:!0,json:{read:!1}})],h.prototype,"isEmpty",null),Object(n.a)([Object(i.b)({type:Date,json:{write:{allowNull:!0}}})],h.prototype,"start",void 0),Object(n.a)([Object(o.a)("start")],h.prototype,"readStart",null),Object(n.a)([Object(u.a)("start")],h.prototype,"writeStart",null),h=s=Object(n.a)([Object(a.a)("esri.TimeExtent")],h);const d=new h,f=new h({start:void 0,end:void 0});var p=h;t.a=p},152:function(e,t,r){"use strict";var s,n=r(81),i=(r(79),r(80),r(87)),o=r(84),a=r(93),u=r(100),c=r(96),l=r(83),h=(r(82),r(85),r(86),r(89)),d=r(146),f=r(234);const p=new a.a({binary:"binary",coordinate:"coordinate",countOrAmount:"count-or-amount",dateAndTime:"date-and-time",description:"description",locationOrPlaceName:"location-or-place-name",measurement:"measurement",nameOrTitle:"name-or-title",none:"none",orderedOrRanked:"ordered-or-ranked",percentageOrRatio:"percentage-or-ratio",typeOrCategory:"type-or-category",uniqueIdentifier:"unique-identifier"});let g=s=class extends h.a{constructor(e){super(e),this.alias=null,this.defaultValue=void 0,this.description=null,this.domain=null,this.editable=!0,this.length=-1,this.name=null,this.nullable=!0,this.type=null,this.valueType=null}readDescription(e,{description:t}){let r;try{r=JSON.parse(t)}catch(s){}return r?r.value:null}readValueType(e,{description:t}){let r;try{r=JSON.parse(t)}catch(s){}return r?p.fromJSON(r.fieldValueType):null}clone(){return new s({alias:this.alias,defaultValue:this.defaultValue,description:this.description,domain:this.domain&&this.domain.clone()||null,editable:this.editable,length:this.length,name:this.name,nullable:this.nullable,type:this.type,valueType:this.valueType})}};Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],g.prototype,"alias",void 0),Object(n.a)([Object(o.b)({type:[String,Number],json:{write:{allowNull:!0}}})],g.prototype,"defaultValue",void 0),Object(n.a)([Object(o.b)()],g.prototype,"description",void 0),Object(n.a)([Object(c.a)("description")],g.prototype,"readDescription",null),Object(n.a)([Object(o.b)({types:d.d,json:{read:{reader:d.b},write:!0}})],g.prototype,"domain",void 0),Object(n.a)([Object(o.b)({type:Boolean,json:{write:!0}})],g.prototype,"editable",void 0),Object(n.a)([Object(o.b)({type:i.a,json:{write:!0}})],g.prototype,"length",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],g.prototype,"name",void 0),Object(n.a)([Object(o.b)({type:Boolean,json:{write:!0}})],g.prototype,"nullable",void 0),Object(n.a)([Object(u.a)(f.a)],g.prototype,"type",void 0),Object(n.a)([Object(o.b)()],g.prototype,"valueType",void 0),Object(n.a)([Object(c.a)("valueType",["description"])],g.prototype,"readValueType",null),g=s=Object(n.a)([Object(l.a)("esri.layers.support.Field")],g);var m=g;t.a=m},164:function(e,t,r){"use strict";r.d(t,"a",(function(){return l})),r.d(t,"b",(function(){return c}));var s=r(81),n=r(84),i=r(83),o=r(95),a=r(113),u=r(294);const c=e=>{let t=class extends e{destroy(){this.destroyed||(this.handles.destroy(),this.updatingHandles.destroy())}get handles(){return this._get("handles")||new a.a}get updatingHandles(){return this._get("updatingHandles")||new u.a}};return Object(s.a)([Object(n.b)({readOnly:!0})],t.prototype,"handles",null),Object(s.a)([Object(n.b)({readOnly:!0})],t.prototype,"updatingHandles",null),t=Object(s.a)([Object(i.a)("esri.core.HandleOwner")],t),t};let l=class extends(c(o.a)){};l=Object(s.a)([Object(i.a)("esri.core.HandleOwner")],l)},165:function(e,t,r){"use strict";r.d(t,"a",(function(){return V})),r.d(t,"b",(function(){return W})),r.d(t,"c",(function(){return Q})),r.d(t,"d",(function(){return J})),r.d(t,"e",(function(){return Y})),r.d(t,"f",(function(){return L})),r.d(t,"g",(function(){return G})),r.d(t,"h",(function(){return q})),r.d(t,"i",(function(){return X})),r.d(t,"j",(function(){return $})),r.d(t,"k",(function(){return Z})),r.d(t,"l",(function(){return R})),r.d(t,"m",(function(){return x})),r.d(t,"n",(function(){return z})),r.d(t,"o",(function(){return N})),r.d(t,"p",(function(){return le})),r.d(t,"q",(function(){return re})),r.d(t,"r",(function(){return ie})),r.d(t,"s",(function(){return ce})),r.d(t,"t",(function(){return ee})),r.d(t,"u",(function(){return te})),r.d(t,"v",(function(){return y})),r.d(t,"w",(function(){return b})),r.d(t,"x",(function(){return ae})),r.d(t,"y",(function(){return K})),r.d(t,"z",(function(){return oe}));var s=r(80),n=r(91),i=r(98),o=r(289),a=r(313),u=r(175);function c(e,t){return e?t?4:3:t?3:2}const l=s.a.getLogger("esri.tasks.support.optimizedFeatureSet"),h={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},d=(e,t,r,s,n,i)=>{e[r]=n,e[r+1]=i},f=(e,t,r,s,n,i)=>{e[r]=n,e[r+1]=i,e[r+2]=t[s+2]},p=(e,t,r,s,n,i)=>{e[r]=n,e[r+1]=i,e[r+2]=t[s+3]},g=(e,t,r,s,n,i)=>{e[r]=n,e[r+1]=i,e[r+2]=t[s+2],e[r+3]=t[s+3]};function m(e,t,r,s){if(e){if(r)return t&&s?g:f;if(t&&s)return p}else if(t&&s)return f;return d}function y({scale:e,translate:t},r){return Math.round((r-t[0])/e[0])}function b({scale:e,translate:t},r){return Math.round((t[1]-r)/e[1])}function _({scale:e,translate:t},r){return r*e[0]+t[0]}function v({scale:e,translate:t},r){return t[1]-r*e[1]}function x(e,t,r){return e?t?r?F(e):j(e):r?S(e):w(e):null}function w(e){const t=e.coords;return{x:t[0],y:t[1]}}function O(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function j(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function I(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function S(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function T(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function F(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function M(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function k(e,t){return e&&t?M:e?I:t?T:O}function C(e,t,r,s,n){const i=k(r,s);for(const a of t){const{geometry:t,attributes:r}=a;let s;t&&(s=i(new u.a,t)),e.push(new o.a(s,r,null,r[n]))}return e}function R(e,t,r){if(!e)return null;const s=c(t,r),n=[];for(let i=0;i<e.coords.length;i+=s){const t=[];for(let r=0;r<s;r++)t.push(e.coords[i+r]);n.push(t)}return t?r?{points:n,hasZ:t,hasM:r}:{points:n,hasZ:t}:r?{points:n,hasM:r}:{points:n}}function A(e,t,r,s,n){const i=c(r,s);for(const a of t){const t=a.geometry,r=a.attributes;let s;t&&(s=E(new u.a,t,i)),e.push(new o.a(s,r,null,r[n]))}return e}function E(e,t,r=c(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const s=e.coords;let n=0;for(const i of t.points)for(let e=0;e<r;e++)s[n++]=i[e];return e}function N(e,t,r){if(!e)return null;const s=c(t,r),{coords:n,lengths:i}=e,o=[];let a=0;for(const u of i){const e=[];for(let t=0;t<u;t++){const t=[];for(let e=0;e<s;e++)t.push(n[a++]);e.push(t)}o.push(e)}return t?r?{paths:o,hasZ:t,hasM:r}:{paths:o,hasZ:t}:r?{paths:o,hasM:r}:{paths:o}}function P(e,t,r,s,n){const i=c(r,s);for(const a of t){const t=a.geometry,r=a.attributes;let s;t&&(s=q(new u.a,t,i)),e.push(new o.a(s,r,null,r[n]))}return e}function q(e,t,r=c(t.hasZ,t.hasM)){const{lengths:s,coords:n}=e;let i=0;for(const o of t.paths){for(const e of o)for(let t=0;t<r;t++)n[i++]=e[t];s.push(o.length)}return e}function z(e,t,r){if(!e)return null;const s=c(t,r),{coords:n,lengths:i}=e,o=[];let a=0;for(const u of i){const e=[];for(let t=0;t<u;t++){const t=[];for(let e=0;e<s;e++)t.push(n[a++]);e.push(t)}o.push(e)}return t?r?{rings:o,hasZ:t,hasM:r}:{rings:o,hasZ:t}:r?{rings:o,hasM:r}:{rings:o}}function D(e,t,r,s,n){for(const i of t){const t=i.geometry,a=i.centroid,c=i.attributes;let l;t&&(l=G(new u.a,t,r,s)),a?e.push(new o.a(l,c,O(new u.a,a),c[n])):e.push(new o.a(l,c,null,c[n]))}return e}function G(e,t,r=t.hasZ,s=t.hasM){return L(e,t.rings,r,s),e}function L(e,t,r,s){const n=c(r,s),{lengths:i,coords:o}=e;let a=0;i.length=o.length=0;for(const u of t){for(const e of u)for(let t=0;t<n;t++)o[a++]=e[t];i.push(u.length)}return e}const U=[],B=[];function V(e,t,r,s,n){U[0]=e;const[i]=Q(B,U,t,r,s,n);return U.length=B.length=0,i}function Q(e,t,r,s,i,a){if(e.length=0,!r){for(const r of t){const t=r.attributes[a];e.push(new o.a(null,r.attributes,null,t))}return e}switch(r){case"esriGeometryPoint":return C(e,t,s,i,a);case"esriGeometryMultipoint":return A(e,t,s,i,a);case"esriGeometryPolyline":return P(e,t,s,i,a);case"esriGeometryPolygon":return D(e,t,s,i,a);default:l.error("convertToFeatureSet:unknown-geometry",new n.a(`Unable to parse unknown geometry type '${r}'`)),e.length=0}return e}function Y(e,t,r,s,i,o){const a=e.length;switch(r){case"esriGeometryPoint":C(e,t,s,i,o);break;case"esriGeometryMultipoint":A(e,t,s,i,o);break;case"esriGeometryPolyline":P(e,t,s,i,o);break;case"esriGeometryPolygon":D(e,t,s,i,o);break;default:l.error("convertToFeatureSet:unknown-geometry",new n.a(`Unable to parse unknown geometry type '${r}'`))}for(let n=0;n<t.length;n++)e[n+a].geometryType=r,e[n+a].insertAfter=t[n].insertAfter,e[n+a].groupId=t[n].groupId;return e}function X(e,t,r,s){B[0]=e,H(U,B,t,r,s);const n=U[0];return U.length=B.length=0,n}function J(e,t,r){if(!e)return null;const s=new u.a;return"hasZ"in e&&null==t&&(t=e.hasZ),"hasM"in e&&null==r&&(r=e.hasM),Object(i.f)(e)?k(null!=t?t:null!=e.z,null!=r?r:null!=e.m)(s,e):Object(i.g)(e)?G(s,e,t,r):Object(i.h)(e)?q(s,e,c(t,r)):Object(i.e)(e)?E(s,e,c(t,r)):void l.error("convertFromGeometry:unknown-geometry",new n.a(`Unable to parse unknown geometry type '${e}'`))}function Z(e,t,r,s){const i=e&&("coords"in e?e:e.geometry);if(!i)return null;switch(t){case"esriGeometryPoint":{let e=w;return r&&s?e=F:r?e=j:s&&(e=S),e(i)}case"esriGeometryMultipoint":return R(i,r,s);case"esriGeometryPolyline":return N(i,r,s);case"esriGeometryPolygon":return z(i,r,s);default:return void l.error("convertToGeometry:unknown-geometry",new n.a(`Unable to parse unknown geometry type '${t}'`))}}function H(e,t,r,s,i){switch(e.length=0,r){case"esriGeometryPoint":return function(e,t,r,s){let n=w;r&&s?n=F:r?n=j:s&&(n=S);for(const i of t){const{geometry:t,attributes:r}=i,s=t?n(t):null;e.push({attributes:r,geometry:s})}return e}(e,t,s,i);case"esriGeometryMultipoint":return function(e,t,r,s){for(const n of t){const{geometry:t,attributes:i}=n;let o;t&&(o=R(t,r,s)),e.push({attributes:i,geometry:o})}return e}(e,t,s,i);case"esriGeometryPolyline":return function(e,t,r,s){for(const n of t){const{geometry:t,attributes:i}=n;let o;t&&(o=N(t,r,s)),e.push({attributes:i,geometry:o})}return e}(e,t,s,i);case"esriGeometryPolygon":return function(e,t,r,s){for(const n of t){const{geometry:t,attributes:i,centroid:o}=n;let a;if(t&&(a=z(t,r,s)),o){const t=w(o);e.push({attributes:i,centroid:t,geometry:a})}else e.push({attributes:i,geometry:a})}return e}(e,t,s,i);default:l.error("convertToFeatureSet:unknown-geometry",new n.a(`Unable to parse unknown geometry type '${r}'`))}return e}function $(e){const{objectIdFieldName:t,spatialReference:r,transform:s,fields:n,hasM:i,hasZ:o,features:a,geometryType:u,exceededTransferLimit:c,uniqueIdField:l,queryGeometry:h,queryGeometryType:d}=e,f={features:H([],a,u,o,i),fields:n,geometryType:u,objectIdFieldName:t,spatialReference:r,uniqueIdField:l,queryGeometry:Z(h,d,!1,!1)};return s&&(f.transform=s),c&&(f.exceededTransferLimit=c),i&&(f.hasM=i),o&&(f.hasZ=o),f}function W(e,t){const r=new a.a,{hasM:s,hasZ:i,features:o,objectIdFieldName:u,spatialReference:c,geometryType:h,exceededTransferLimit:d,transform:f,fields:p}=e;return p&&(r.fields=p),r.geometryType=h,r.objectIdFieldName=u||t,r.spatialReference=c,r.objectIdFieldName?(o&&Q(r.features,o,h,i,s,r.objectIdFieldName),d&&(r.exceededTransferLimit=d),s&&(r.hasM=s),i&&(r.hasZ=i),f&&(r.transform=f),r):(l.error(new n.a("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),r)}function K(e){const{transform:t,features:r,hasM:s,hasZ:n}=e;if(!t)return e;for(const i of r)i.geometry&&oe(i.geometry,i.geometry,s,n,t),i.centroid&&oe(i.centroid,i.centroid,s,n,t);return e.transform=null,e}function ee(e,t){const{geometryType:r,features:s,hasM:n,hasZ:i}=t;if(!e)return t;for(let o=0;o<s.length;o++){const t=s[o],a=t.weakClone();a.geometry=new u.a,te(a.geometry,t.geometry,n,i,r,e),t.centroid&&(a.centroid=new u.a,te(a.centroid,t.centroid,n,i,"esriGeometryPoint",e)),s[o]=a}return t.transform=e,t}function te(e,t,r,s,n,i,o=r,a=s){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!t||!t.coords.length)return null;const u=h[n],{coords:l,lengths:d}=t,f=c(r,s),p=c(r&&o,s&&a),g=m(r,s,o,a);if(!d.length)return g(e.coords,l,0,0,y(i,l[0]),b(i,l[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=f,e;let _,v,x,w,O=0,j=0,I=j;for(const c of d){if(c<u)continue;let t=0;j=I,x=_=y(i,l[O]),w=v=b(i,l[O+1]),g(e.coords,l,j,O,x,w),t++,O+=f,j+=p;for(let r=1;r<c;r++,O+=f)x=y(i,l[O]),w=b(i,l[O+1]),x===_&&w===v||(g(e.coords,l,j,O,x-_,w-v),j+=p,t++,_=x,v=w);t>=u&&(e.lengths.push(t),I=j)}return e.coords.length=I,e.coords.length?e:null}function re(e,t,r,s,n,i,o=r,a=s){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!t||!t.coords.length)return null;const u=h[n],{coords:l,lengths:d}=t,f=c(r,s),p=c(r&&o,s&&a),g=m(r,s,o,a);if(!d.length)return g(e.coords,l,0,0,l[0],l[1]),e.lengths.length&&(e.lengths.length=0),e.coords.length=f,e;let y=0;const b=i*i;for(const c of d){if(c<u){y+=c*f;continue}const t=e.coords.length/p,r=y,s=y+(c-1)*f;g(e.coords,l,e.coords.length,r,l[r],l[r+1]),ne(e.coords,l,f,b,g,r,s),g(e.coords,l,e.coords.length,s,l[s],l[s+1]);const n=e.coords.length/p-t;n>=u?e.lengths.push(n):e.coords.length=t*p,y+=c*f}return e.coords.length?e:null}function se(e,t,r,s){const n=e[t],i=e[t+1],o=e[r],a=e[r+1],u=e[s],c=e[s+1];let l=o,h=a,d=u-l,f=c-h;if(0!==d||0!==f){const e=((n-l)*d+(i-h)*f)/(d*d+f*f);e>1?(l=u,h=c):e>0&&(l+=d*e,h+=f*e)}return d=n-l,f=i-h,d*d+f*f}function ne(e,t,r,s,n,i,o){let a,u=s,c=0;for(let l=i+r;l<o;l+=r)a=se(t,l,i,o),a>u&&(c=l,u=a);u>s&&(c-i>r&&ne(e,t,r,s,n,i,c),n(e,t,e.length,c,t[c],t[c+1]),o-c>r&&ne(e,t,r,s,n,c,o))}function ie(e,t,r,s){if(!t||!t.coords||!t.coords.length)return null;const n=c(r,s);let i=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,u=Number.NEGATIVE_INFINITY;if(t&&t.coords){const e=t.coords;for(let t=0;t<e.length;t+=n){const r=e[t],s=e[t+1];i=Math.min(i,r),a=Math.max(a,r),o=Math.min(o,s),u=Math.max(u,s)}}return e[0]=i,e[1]=o,e[2]=a,e[3]=u,e}function oe(e,t,r,s,n){const{coords:i,lengths:o}=t,a=r?s?g:f:s?f:d,u=c(r,s);if(!i.length)return e!==t&&(e.lengths.length=0,e.coords.length=0),e;if(!o.length)return a(e.coords,i,0,0,_(n,i[0]),v(n,i[1])),e!==t&&(e.lengths.length=0,e.coords.length=u),e;const[l,h]=n.scale;let p=0;for(let c=0;c<o.length;c++){const t=o[c];e.lengths[c]=t;let r=_(n,i[p]),s=v(n,i[p+1]);a(e.coords,i,p,p,r,s),p+=u;for(let n=1;n<t;n++,p+=u)r+=i[p]*l,s-=i[p+1]*h,a(e.coords,i,p,p,r,s)}return e!==t&&(e.lengths.length=o.length,e.coords.length=i.length),e}function ae(e,t,r,s,n,i){const o=c(r,s),a=m(r,s,n,i),u=t.coords;e.coords.length=0,e.lengths.length=0,e.lengths.push(...t.lengths);for(let c=0;c<u.length;c+=o)a(e.coords,u,e.coords.length,c,u[c],u[c+1]);return e}function ue(e,t,r,s){let n=0,i=e[s*t],o=e[s*(t+1)];for(let a=1;a<r;a++){const r=i+e[s*(t+a)],u=o+e[s*(t+a)+1],c=(r-i)*(u+o);i=r,o=u,n+=c}return.5*n}function ce(e,t){const{coords:r,lengths:s}=e;let n=0,i=0;for(let o=0;o<s.length;o++)i+=ue(r,n,s[o],t),n+=o;return Math.abs(i)}function le(e,t){const r=e.clone(),s=e.coords,n=e.lengths;let i=0;for(let o=0;o<n.length;o++){const e=n[o];let a=s[t*i],u=s[t*i+1];for(let n=1;n<e;n++){const e=a+s[t*(i+n)],o=u+s[t*(i+n)+1];r.coords[t*(i+n)]=e,r.coords[t*(i+n)+1]=o,a=e,u=o}i+=e}return r}},167:function(e,t,r){"use strict";r.d(t,"a",(function(){return R}));var s,n=r(81),i=(r(79),r(80),r(87)),o=r(84),a=r(114),u=r(93),c=r(100),l=r(96),h=r(185),d=r(83),f=(r(82),r(85),r(86),r(89)),p=r(152),g=r(259),m=r(97),y=r(180);r(99);let b=s=class extends f.a{constructor(e){super(e),this.type="query-table"}clone(){var e;const{workspaceId:t,query:r,oidFields:n,spatialReference:i,geometryType:o}=this,a={workspaceId:t,query:r,oidFields:n,spatialReference:null!=(e=null==i?void 0:i.clone())?e:void 0,geometryType:o};return new s(a)}};var _;Object(n.a)([Object(c.a)({queryTable:"query-table"})],b.prototype,"type",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],b.prototype,"workspaceId",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],b.prototype,"query",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],b.prototype,"oidFields",void 0),Object(n.a)([Object(o.b)({type:m.a,json:{write:!0}})],b.prototype,"spatialReference",void 0),Object(n.a)([Object(c.a)(y.a)],b.prototype,"geometryType",void 0),b=s=Object(n.a)([Object(d.a)("esri.layers.support.source.QueryTableDataSource")],b);let v=_=class extends f.a{constructor(e){super(e),this.type="raster"}clone(){const{workspaceId:e,dataSourceName:t}=this;return new _({workspaceId:e,dataSourceName:t})}};var x;Object(n.a)([Object(c.a)({raster:"raster"})],v.prototype,"type",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],v.prototype,"dataSourceName",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],v.prototype,"workspaceId",void 0),v=_=Object(n.a)([Object(d.a)("esri.layers.support.source.RasterDataSource")],v);let w=x=class extends f.a{constructor(e){super(e),this.type="table"}clone(){const{workspaceId:e,gdbVersion:t,dataSourceName:r}=this;return new x({workspaceId:e,gdbVersion:t,dataSourceName:r})}};var O,j;Object(n.a)([Object(c.a)({table:"table"})],w.prototype,"type",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],w.prototype,"workspaceId",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],w.prototype,"gdbVersion",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],w.prototype,"dataSourceName",void 0),w=x=Object(n.a)([Object(d.a)("esri.layers.support.source.TableDataSource")],w);const I=Object(u.b)()({esriLeftInnerJoin:"left-inner-join",esriLeftOuterJoin:"left-outer-join"});let S=O=class extends f.a{constructor(e){super(e),this.type="join-table"}readLeftTableSource(e,t,r){return F()(e,t,r)}castLeftTableSource(e){return Object(i.k)(k(),e)}readRightTableSource(e,t,r){return F()(e,t,r)}castRightTableSource(e){return Object(i.k)(k(),e)}clone(){var e,t;const{leftTableKey:r,rightTableKey:s,leftTableSource:n,rightTableSource:i,joinType:o}=this,a={leftTableKey:r,rightTableKey:s,leftTableSource:null!=(e=null==n?void 0:n.clone())?e:void 0,rightTableSource:null!=(t=null==i?void 0:i.clone())?t:void 0,joinType:o};return new O(a)}};Object(n.a)([Object(c.a)({joinTable:"join-table"})],S.prototype,"type",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],S.prototype,"leftTableKey",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],S.prototype,"rightTableKey",void 0),Object(n.a)([Object(o.b)({json:{write:!0}})],S.prototype,"leftTableSource",void 0),Object(n.a)([Object(l.a)("leftTableSource")],S.prototype,"readLeftTableSource",null),Object(n.a)([Object(a.a)("leftTableSource")],S.prototype,"castLeftTableSource",null),Object(n.a)([Object(o.b)({json:{write:!0}})],S.prototype,"rightTableSource",void 0),Object(n.a)([Object(l.a)("rightTableSource")],S.prototype,"readRightTableSource",null),Object(n.a)([Object(a.a)("rightTableSource")],S.prototype,"castRightTableSource",null),Object(n.a)([Object(c.a)(I)],S.prototype,"joinType",void 0),S=O=Object(n.a)([Object(d.a)("esri.layers.support.source.JoinTableDataSource")],S);let T=null;function F(){return T||(T=Object(h.b)({types:k()})),T}let M=null;function k(){return M||(M={key:"type",base:null,typeMap:{"data-layer":R,"map-layer":g.a}}),M}const C={key:"type",base:null,typeMap:{"join-table":S,"query-table":b,raster:v,table:w}};let R=j=class extends f.a{constructor(e){super(e),this.type="data-layer"}clone(){const{fields:e,dataSource:t}=this;return new j({fields:e,dataSource:t})}};Object(n.a)([Object(c.a)({dataLayer:"data-layer"})],R.prototype,"type",void 0),Object(n.a)([Object(o.b)({type:[p.a],json:{write:!0}})],R.prototype,"fields",void 0),Object(n.a)([Object(o.b)({types:C,json:{write:!0}})],R.prototype,"dataSource",void 0),R=j=Object(n.a)([Object(d.a)("esri.layers.support.source.DataLayerSource")],R),R.from=Object(i.m)(R)},170:function(e,t,r){"use strict";r.d(t,"a",(function(){return a})),r.d(t,"b",(function(){return u})),r.d(t,"c",(function(){return c})),r.d(t,"d",(function(){return l})),r.d(t,"e",(function(){return d})),r.d(t,"f",(function(){return f})),r.d(t,"g",(function(){return h}));var s=r(110),n=r(97),i=r(136);function o(e){return new n.a({wkt:`GEOCCS["Spherical geocentric",\n    DATUM["Not specified",\n      SPHEROID["Sphere",${e.radius},0]],\n    PRIMEM["Greenwich",0.0,\n      AUTHORITY["EPSG","8901"]],\n    UNIT["m",1.0],\n    AXIS["Geocentric X",OTHER],\n    AXIS["Geocentric Y",EAST],\n    AXIS["Geocentric Z",NORTH]\n  ]`})}const a=o(i.a),u=o(i.b),c=o(i.c),l=new n.a({wkt:`GEOCCS["WGS 84",\n  DATUM["WGS_1984",\n    SPHEROID["WGS 84",${i.a.radius},298.257223563,\n      AUTHORITY["EPSG","7030"]],\n    AUTHORITY["EPSG","6326"]],\n  PRIMEM["Greenwich",0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0,\n    AUTHORITY["EPSG","9001"]],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",OTHER],\n  AXIS["Geocentric Z",NORTH],\n  AUTHORITY["EPSG","4978"]\n]`});function h(e){return e&&(Object(s.g)(e)||e===u)?u:e&&(Object(s.h)(e)||e===c)?c:a}function d(e){return e&&(Object(s.g)(e)||e===u)?i.b:e&&(Object(s.h)(e)||e===c)?i.c:i.a}function f(e){return Object(s.k)(e)?i.b:Object(s.l)(e)?i.c:i.a}},175:function(e,t,r){"use strict";class s{constructor(e=[],t=[],r=!1){this.lengths=null!=e?e:[],this.coords=null!=t?t:[],this.hasIndeterminateRingOrder=r}get isPoint(){return 0===this.lengths.length}forEachVertex(e){let t=0;this.lengths.length||e(this.coords[0],this.coords[1]);for(let r=0;r<this.lengths.length;r++){const s=this.lengths[r];for(let r=0;r<s;r++)e(this.coords[2*(r+t)],this.coords[2*(r+t)+1]);t+=s}}clone(){return new s(this.lengths.slice(),this.coords.slice(),this.hasIndeterminateRingOrder)}}t.a=s},181:function(e,t,r){"use strict";r.d(t,"a",(function(){return s})),r.d(t,"b",(function(){return n})),r.d(t,"c",(function(){return u})),r.d(t,"d",(function(){return a}));const s=1e-6,n=Math.random,i=Math.PI/180,o=180/Math.PI;function a(e){return e*i}function u(e){return e*o}Object.freeze({__proto__:null,EPSILON:s,RANDOM:n,toRadian:a,toDegree:u,equals:function(e,t){return Math.abs(e-t)<=s*Math.max(1,Math.abs(e),Math.abs(t))}})},186:function(e,t,r){"use strict";r.d(t,"a",(function(){return n}));let s=0;function n(){return++s}},187:function(e,t,r){"use strict";r.r(t),r.d(t,"executeQuery",(function(){return f})),r.d(t,"executeQueryForCount",(function(){return y})),r.d(t,"executeQueryForExtent",(function(){return b})),r.d(t,"executeQueryForIds",(function(){return m})),r.d(t,"executeQueryPBF",(function(){return p})),r.d(t,"executeQueryPBFBuffer",(function(){return g})),r.d(t,"queryToQueryStringParameters",(function(){return d})),r.d(t,"runQuery",(function(){return _}));var s=r(88),n=r(82),i=r(98),o=r(104),a=r(233),u=r(267),c=r(266),l=r(383);const h="Layer does not support extent calculation.";function d(e,t){const r=e.geometry,n=e.toJSON(),o=n;if(Object(s.k)(r)&&(o.geometry=JSON.stringify(r),o.geometryType=Object(i.c)(r),o.inSR=r.spatialReference.wkid||JSON.stringify(r.spatialReference)),n.groupByFieldsForStatistics&&(o.groupByFieldsForStatistics=n.groupByFieldsForStatistics.join(",")),n.objectIds&&(o.objectIds=n.objectIds.join(",")),n.orderByFields&&(o.orderByFields=n.orderByFields.join(",")),!n.outFields||!n.returnDistinctValues&&(null!=t&&t.returnCountOnly||null!=t&&t.returnExtentOnly||null!=t&&t.returnIdsOnly)?delete o.outFields:-1!==n.outFields.indexOf("*")?o.outFields="*":o.outFields=n.outFields.join(","),n.outSR?o.outSR=n.outSR.wkid||JSON.stringify(n.outSR):r&&(n.returnGeometry||n.returnCentroid)&&(o.outSR=o.inSR),n.returnGeometry&&delete n.returnGeometry,n.outStatistics&&(o.outStatistics=JSON.stringify(n.outStatistics)),n.pixelSize&&(o.pixelSize=JSON.stringify(n.pixelSize)),n.quantizationParameters&&(o.quantizationParameters=JSON.stringify(n.quantizationParameters)),n.parameterValues&&(o.parameterValues=JSON.stringify(n.parameterValues)),n.rangeValues&&(o.rangeValues=JSON.stringify(n.rangeValues)),n.dynamicDataSource&&(o.layer=JSON.stringify({source:n.dynamicDataSource}),delete n.dynamicDataSource),n.timeExtent){const e=n.timeExtent,{start:t,end:r}=e;null==t&&null==r||(o.time=t===r?t:`${null==t?"null":t},${null==r?"null":r}`),delete n.timeExtent}return o}async function f(e,t,r,n){const i=Object(s.k)(t.timeExtent)&&t.timeExtent.isEmpty?{data:{features:[]}}:await _(e,t,"json",n);return Object(u.a)(t,r,i.data),i}async function p(e,t,r,n){if(Object(s.k)(t.timeExtent)&&t.timeExtent.isEmpty)return Promise.resolve({data:r.createFeatureResult()});const i=await g(e,t,n),o=i;return o.data=Object(l.a)(i.data,r),o}function g(e,t,r){return _(e,t,"pbf",r)}function m(e,t,r){return Object(s.k)(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):_(e,t,"json",r,{returnIdsOnly:!0})}function y(e,t,r){return Object(s.k)(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):_(e,t,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})}function b(e,t,r){return Object(s.k)(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):_(e,t,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}).then((e=>{const t=e.data;if(t.hasOwnProperty("extent"))return e;if(t.features)throw new Error(h);if(t.hasOwnProperty("count"))throw new Error(h);return e}))}function _(e,t,r,i={},u={}){const l="string"==typeof e?Object(n.J)(e):e,h=t.geometry?[t.geometry]:[];return i.responseType="pbf"===r?"array-buffer":"json",Object(a.a)(h,null,i).then((e=>{const a=e&&e[0];Object(s.k)(a)&&((t=t.clone()).geometry=a);const h=Object(c.a)({...l.query,f:r,...u,...d(t,u)});return Object(o.default)(Object(n.y)(l.path,"query"),{...i,query:{...h,...i.query}})}))}},204:function(e,t,r){"use strict";function s(e){return"date"===e.type||"esriFieldTypeDate"===e.type}function n(e){return e.toLowerCase().trim()}t.a=class{constructor(e){if(this.fields=e,this._fieldsMap=new Map,this._dateFieldsSet=new Set,this.dateFields=[],!e)return;const t=[];for(const r of e){const e=r&&r.name;if(e){const i=n(e);this._fieldsMap.set(e,r),this._fieldsMap.set(i,r),t.push(i),s(r)&&(this.dateFields.push(r),this._dateFieldsSet.add(r))}}t.sort(),this.uid=t.join(",")}destroy(){this._fieldsMap.clear()}has(e){return null!=this.get(e)}get(e){return null!=e?this._fieldsMap.get(e)||this._fieldsMap.get(n(e)):void 0}isDateField(e){return this._dateFieldsSet.has(this.get(e))}normalizeFieldName(e){const t=this.get(e);if(t)return t.name}}},209:function(e,t,r){"use strict";r.d(t,"a",(function(){return o})),r.d(t,"b",(function(){return u}));var s=r(88),n=r(110),i=r(115);function o(e,t,r){if(Object(s.j)(t)||Object(s.j)(r)||r.vcsWkid||Object(n.c)(t,r))return null;const o=Object(i.g)(t)/Object(i.g)(r);if(1===o)return null;switch(e){case"point":case"esriGeometryPoint":return e=>function(e,t){e&&null!=e.z&&(e.z*=t)}(e,o);case"polyline":case"esriGeometryPolyline":return e=>function(e,t){if(e)for(const r of e.paths)for(const e of r)e.length>2&&(e[2]*=t)}(e,o);case"polygon":case"esriGeometryPolygon":return e=>function(e,t){if(e)for(const r of e.rings)for(const e of r)e.length>2&&(e[2]*=t)}(e,o);case"multipoint":case"esriGeometryMultipoint":return e=>function(e,t){if(e)for(const r of e.points)r.length>2&&(r[2]*=t)}(e,o);default:return null}}function a(e,t,r){if(null==e.hasM||e.hasZ)for(const s of t)for(const e of s)e.length>2&&(e[2]*=r)}function u(e,t,r){if(!e&&!t||!r)return;const s=Object(i.g)(r);c(e,r,s),c(t,r,s)}function c(e,t,r){if(e)for(const s of e)l(s.geometry,t,r)}function l(e,t,r){if(!e||!e.spatialReference||Object(n.c)(e.spatialReference,t))return;const s=Object(i.g)(e.spatialReference)/r;if(1!==s)if("x"in e)null!=e.z&&(e.z*=s);else if("rings"in e)a(e,e.rings,s);else if("paths"in e)a(e,e.paths,s);else if("points"in e&&(null==e.hasM||e.hasZ))for(const n of e.points)n.length>2&&(n[2]*=s)}},210:function(e,t,r){"use strict";r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return i}));var s=r(173);class n{constructor(e,t,r){this._namespace=e,this._storage=t,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),this._namespace+=":",r&&(this._storage.registerRemoveFunc(this._namespace,r),this._removeFunc=!0)}destroy(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),this._storage.deregister(this),this._storage=null}get namespace(){return this._namespace.slice(0,-1)}get hitRate(){return this._hit/(this._hit+this._miss)}get size(){return this._storage.size}get maxSize(){return this._storage.maxSize}resetHitRate(){this._hit=this._miss=0}put(e,t,r,s=0){this._storage.put(this._namespace+e,t,r,s)}get(e){const t=this._storage.get(this._namespace+e);return void 0===t?++this._miss:++this._hit,t}pop(e){const t=this._storage.pop(this._namespace+e);return void 0===t?++this._miss:++this._hit,t}updateSize(e,t,r){this._storage.updateSize(this._namespace+e,t,r)}clear(){this._storage.clear(this._namespace)}clearAll(){this._storage.clearAll()}getStats(){return this._storage.getStats()}resetStats(){this._storage.resetStats()}}class i{constructor(e=10485760){this._maxSize=e,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new s.a,this._users=new s.a}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(e){this._users.push(e)}deregister(e){this._users.removeUnordered(e)}registerRemoveFunc(e,t){this._removeFuncs.push([e,t])}deregisterRemoveFunc(e){this._removeFuncs.filterInPlace((t=>t[0]!==e))}get size(){return this._size}get maxSize(){return this._maxSize}set maxSize(e){this._maxSize=Math.max(e,0),this._checkSizeLimit()}put(e,t,r,s){const n=this._db.get(e);if(n&&(this._size-=n.size,this._db.delete(e),n.entry!==t&&this._notifyRemoved(e,n.entry)),r>this._maxSize)return void this._notifyRemoved(e,t);if(void 0===t)return void console.warn("Refusing to cache undefined entry ");if(!r||r<0)return void console.warn("Refusing to cache entry with invalid size "+r);const i=1+Math.max(s,-3)- -3;this._db.set(e,{entry:t,size:r,lifetime:i,lives:i}),this._size+=r,this._checkSizeLimit()}updateSize(e,t,r){const s=this._db.get(e);if(s&&s.entry===t){if(this._size-=s.size,r>this._maxSize)return this._db.delete(e),void this._notifyRemoved(e,t);s.size=r,this._size+=r,this._checkSizeLimit()}}pop(e){const t=this._db.get(e);if(t)return this._size-=t.size,this._db.delete(e),++this._hit,t.entry;++this._miss}get(e){const t=this._db.get(e);if(void 0!==t)return this._db.delete(e),t.lives=t.lifetime,this._db.set(e,t),++this._hit,t.entry;++this._miss}getStats(){const e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},t={},r=new Array;this._db.forEach(((e,s)=>{const n=e.lifetime;r[n]=(r[n]||0)+e.size,this._users.forAll((r=>{const n=r.namespace;if(s.startsWith(n)){const r=t[n]||0;t[n]=r+e.size}}))}));const s={};this._users.forAll((e=>{const r=e.namespace;if(!isNaN(e.hitRate)&&e.hitRate>0){const n=t[r]||0;t[r]=n,s[r]=Math.round(100*e.hitRate)+"%"}else s[r]="0%"}));const n=Object.keys(t);n.forEach((e=>t[e]=t[e]/this._size*100)),n.sort(((e,r)=>t[r]-t[e])),n.forEach((r=>e[r]=Math.round(t[r])+"% / "+s[r]));for(let i=r.length-1;i>=0;--i){const t=r[i];t&&(e["Priority "+(i+-3-1)]=Math.round(t/this.size*100)+"%")}return e}resetStats(){this._hit=this._miss=0,this._users.forAll((e=>e.resetHitRate()))}clear(e){this._db.forEach(((t,r)=>{r.startsWith(e)&&(this._size-=t.size,this._db.delete(r),this._notifyRemoved(r,t.entry))}))}clearAll(){this._db.forEach(((e,t)=>this._notifyRemoved(t,e.entry))),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemoved(e,t){this._removeFuncs.forAll((r=>{e.startsWith(r[0])&&r[1](t)}))}_checkSizeLimit(){if(!(this._size<=this._maxSize))for(const[e,t]of this._db)if(this._db.delete(e),t.lives<=1?(this._size-=t.size,this._notifyRemoved(e,t.entry)):(--t.lives,this._db.set(e,t)),this._size<=.9*this.maxSize)return}}},233:function(e,t,r){"use strict";r.d(t,"a",(function(){return w})),r.d(t,"b",(function(){return O})),r.d(t,"c",(function(){return _}));var s=r(156),n=r(88),i=r(80),o=r(91),a=r(110),u=r(158),c=r(127),l=r(138),h=r(240),d=r(82),f=r(98),p=(r(99),r(104));async function g(e,t,r){const s="string"==typeof e?Object(d.J)(e):e,n=t[0].spatialReference,i=Object(f.c)(t[0]),o={...r,query:{...s.query,f:"json",sr:n.wkid?n.wkid:JSON.stringify(n),geometries:JSON.stringify((a=t,{geometryType:Object(f.c)(a[0]),geometries:a.map((e=>e.toJSON()))}))}};var a;return function(e,t,r){const s=Object(f.b)(t);return e.map((e=>{const t=s.fromJSON(e);return t.spatialReference=r,t}))}((await Object(p.default)(s.path+"/simplify",o)).data,i,n)}const m=i.a.getLogger("esri.geometry.support.normalizeUtils");function y(e){return"polygon"===e[0].type}function b(e){return"polyline"===e[0].type}function _(e,t){if(!(e instanceof l.a||e instanceof c.a)){const e="straightLineDensify: the input geometry is neither polyline nor polygon";throw m.error(e),new o.a(e)}const r=Object(h.b)(e),s=[];for(const n of r){const e=[];s.push(e),e.push([n[0][0],n[0][1]]);for(let r=0;r<n.length-1;r++){const s=n[r][0],i=n[r][1],o=n[r+1][0],a=n[r+1][1],u=Math.sqrt((o-s)*(o-s)+(a-i)*(a-i)),c=(a-i)/u,l=(o-s)/u,h=u/t;if(h>1){for(let a=1;a<=h-1;a++){const r=a*t,n=l*r+s,o=c*r+i;e.push([n,o])}const r=(u+Math.floor(h-1)*t)/2,n=l*r+s,o=c*r+i;e.push([n,o])}e.push([o,a])}}return function(e){return"polygon"===e.type}(e)?new c.a({rings:s,spatialReference:e.spatialReference}):new l.a({paths:s,spatialReference:e.spatialReference})}function v(e,t,r){if(t){const t=_(e,1e6);e=Object(u.e)(t,!0)}return r&&(e=Object(h.e)(e,r)),e}function x(e,t,r){if(Array.isArray(e)){const s=e[0];if(s>t){const r=Object(h.d)(s,t);e[0]=s+r*(-2*t)}else if(s<r){const t=Object(h.d)(s,r);e[0]=s+t*(-2*r)}}else{const s=e.x;if(s>t){const r=Object(h.d)(s,t);e=e.clone().offset(r*(-2*t),0)}else if(s<r){const t=Object(h.d)(s,r);e=e.clone().offset(t*(-2*r),0)}}return e}async function w(e,t,r){if(!Array.isArray(e))return w([e],t);const i=t?t.url:s.a.geometryServiceUrl;let o,m,_,O,j,I,S,T,F=0;const M=[],k=[];for(const s of e)if(Object(n.j)(s))k.push(s);else if(o||(o=s.spatialReference,m=Object(a.d)(o),_=o.isWebMercator,I=_?102100:4326,O=h.a[I].maxX,j=h.a[I].minX,S=h.a[I].plus180Line,T=h.a[I].minus180Line),m)if("mesh"===s.type)k.push(s);else if("point"===s.type)k.push(x(s.clone(),O,j));else if("multipoint"===s.type){const e=s.clone();e.points=e.points.map((e=>x(e,O,j))),k.push(e)}else if("extent"===s.type){const e=s.clone()._normalize(!1,!1,m);k.push(e.rings?new c.a(e):e)}else if(s.extent){const e=s.extent,t=Object(h.d)(e.xmin,j)*(2*O);let r=0===t?s.clone():Object(h.e)(s.clone(),t);e.offset(t,0),e.intersects(S)&&e.xmax!==O?(F=e.xmax>F?e.xmax:F,r=v(r,_),M.push(r),k.push("cut")):e.intersects(T)&&e.xmin!==j?(F=e.xmax*(2*O)>F?e.xmax*(2*O):F,r=v(r,_,360),M.push(r),k.push("cut")):k.push(r)}else k.push(s.clone());else k.push(s);let C=Object(h.d)(F,O),R=-90;const A=C,E=new l.a;for(;C>0;){const e=360*C-180;E.addPath([[e,R],[e,-1*R]]),R*=-1,C--}if(M.length>0&&A>0){const t=function(e,t){let r=-1;for(let s=0;s<t.cutIndexes.length;s++){const n=t.cutIndexes[s],i=t.geometries[s],o=Object(h.b)(i);for(let e=0;e<o.length;e++){const t=o[e];t.some((r=>{if(r[0]<180)return!0;{let r=0;for(let e=0;e<t.length;e++){const s=t[e][0];r=s>r?s:r}r=Number(r.toFixed(9));const s=-360*Object(h.d)(r,180);for(let n=0;n<t.length;n++){const t=i.getPoint(e,n);i.setPoint(e,n,t.clone().offset(s,0))}return!0}}))}if(n===r){if(y(e))for(const t of Object(h.b)(i))e[n]=e[n].addRing(t);else if(b(e))for(const t of Object(h.b)(i))e[n]=e[n].addPath(t)}else r=n,e[n]=i}return e}(M,await async function(e,t,r,s){const n="string"==typeof e?Object(d.J)(e):e,i=t[0].spatialReference,o={...s,query:{...n.query,f:"json",sr:JSON.stringify(i),target:JSON.stringify({geometryType:Object(f.c)(t[0]),geometries:t}),cutter:JSON.stringify(r)}},a=await Object(p.default)(n.path+"/cut",o),{cutIndexes:u,geometries:c=[]}=a.data;return{cutIndexes:u,geometries:c.map((e=>{const t=Object(f.a)(e);return t.spatialReference=i,t}))}}(i,M,E,r)),s=[],o=[];for(let r=0;r<k.length;r++){const i=k[r];if("cut"!==i)o.push(i);else{const i=t.shift(),a=e[r];Object(n.k)(a)&&"polygon"===a.type&&a.rings&&a.rings.length>1&&i.rings.length>=a.rings.length?(s.push(i),o.push("simplify")):o.push(_?Object(u.b)(i):i)}}if(!s.length)return o;const a=await g(i,s,r),c=[];for(let e=0;e<o.length;e++){const t=o[e];"simplify"!==t?c.push(t):c.push(_?Object(u.b)(a.shift()):a.shift())}return c}const N=[];for(let s=0;s<k.length;s++){const e=k[s];if("cut"!==e)N.push(e);else{const e=M.shift();N.push(!0===_?Object(u.b)(e):e)}}return Promise.resolve(N)}function O(e,t){const r=Object(a.d)(t);if(r){const[t,s]=r.valid,n=s-t;if(e<t)for(;e<t;)e+=n;if(e>s)for(;e>s;)e-=n}return e}},234:function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));const s=new(r(93).a)({esriFieldTypeSmallInteger:"small-integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"single",esriFieldTypeDouble:"double",esriFieldTypeLong:"long",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"oid",esriFieldTypeGeometry:"geometry",esriFieldTypeBlob:"blob",esriFieldTypeRaster:"raster",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"global-id",esriFieldTypeXML:"xml"})},239:function(e,t,r){"use strict";r.d(t,"a",(function(){return f})),r.d(t,"b",(function(){return l})),r.d(t,"c",(function(){return g})),r.d(t,"d",(function(){return v})),r.d(t,"e",(function(){return _})),r.d(t,"f",(function(){return h})),r.d(t,"g",(function(){return d})),r.d(t,"h",(function(){return m})),r.d(t,"i",(function(){return y})),r.d(t,"j",(function(){return p})),r.d(t,"k",(function(){return b}));var s=r(88),n=r(82),i=r(255);const o=["MapServer","ImageServer","FeatureServer","SceneServer","StreamServer","VectorTileServer"],a=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/rest\\/services\\/(.+?)\\/(${o.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),u=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/([^\\/\\n]+)\\/(${o.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),c=/(.*)\/(\d+)\/?$/i;function l(e){return!!a.test(e)}function h(e){const t=Object(n.J)(e),r=t.path.match(a)||t.path.match(u);if(!r)return null;const[,s,i,o,c]=r,l=i.indexOf("/");return{title:f(-1!==l?i.slice(l+1):i),serverType:o,sublayer:null!=c&&""!==c?parseInt(c,10):null,url:{path:s}}}function d(e){const t=Object(n.J)(e).path.match(c);return t?{serviceUrl:t[1],sublayerId:Number(t[2])}:null}function f(e){return(e=e.replace(/\s*[/_]+\s*/g," "))[0].toUpperCase()+e.slice(1)}function p(e,t){const r=[];if(e){const t=h(e);Object(s.k)(t)&&t.title&&r.push(t.title)}if(t){const e=f(t);r.push(e)}if(2===r.length){if(-1!==r[0].toLowerCase().indexOf(r[1].toLowerCase()))return r[0];if(-1!==r[1].toLowerCase().indexOf(r[0].toLowerCase()))return r[1]}return r.join(" - ")}function g(e){if(!e)return!1;const t=-1!==(e=e.toLowerCase()).indexOf(".arcgis.com/"),r=-1!==e.indexOf("//services")||-1!==e.indexOf("//tiles")||-1!==e.indexOf("//features");return t&&r}function m(e,t){return e?Object(n.H)(Object(n.G)(e,t)):e}function y(e){let{url:t}=e;if(!t)return{url:t};t=Object(n.G)(t,e.logger);const r=Object(n.J)(t),i=h(r.path);let o;if(Object(s.k)(i))null!=i.sublayer&&null==e.layer.layerId&&(o=i.sublayer),t=i.url.path;else if(e.nonStandardUrlAllowed){const e=d(r.path);Object(s.k)(e)&&(t=e.serviceUrl,o=e.sublayerId)}return{url:Object(n.H)(t),layerId:o}}function b(e,t,r,s,o){Object(i.f)(t,s,"url",o),s.url&&null!=e.layerId&&(s.url=Object(n.y)(s.url,r,e.layerId.toString()))}function _(e){if(!e)return!1;const t=e.toLowerCase(),r=-1!==t.indexOf("/services/"),s=-1!==t.indexOf("/mapserver/wmsserver"),n=-1!==t.indexOf("/imageserver/wmsserver"),i=-1!==t.indexOf("/wmsserver");return r&&(s||n||i)}function v(e){if(!e)return!1;const t=new n.a(Object(n.z)(e)).authority.toLowerCase();return"server.arcgisonline.com"===t||"services.arcgisonline.com"===t}},240:function(e,t,r){"use strict";r.d(t,"a",(function(){return o})),r.d(t,"b",(function(){return c})),r.d(t,"c",(function(){return l})),r.d(t,"d",(function(){return a})),r.d(t,"e",(function(){return u}));var s=r(97),n=r(138),i=r(98);const o={102100:{maxX:20037508.342788905,minX:-20037508.342788905,plus180Line:new n.a({paths:[[[20037508.342788905,-20037508.342788905],[20037508.342788905,20037508.342788905]]],spatialReference:s.a.WebMercator}),minus180Line:new n.a({paths:[[[-20037508.342788905,-20037508.342788905],[-20037508.342788905,20037508.342788905]]],spatialReference:s.a.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new n.a({paths:[[[180,-180],[180,180]]],spatialReference:s.a.WGS84}),minus180Line:new n.a({paths:[[[-180,-180],[-180,180]]],spatialReference:s.a.WGS84})}};function a(e,t){return Math.ceil((e-t)/(2*t))}function u(e,t){const r=c(e);for(const s of r)for(const e of s)e[0]+=t;return e}function c(e){return Object(i.g)(e)?e.rings:e.paths}function l(e){const t=(null==e?void 0:e.isWebMercator)?102100:4326;return[o[t].minX,o[t].maxX]}},242:function(e,t,r){"use strict";var s=r(218);class n{constructor(e,t,r,s){this.set(e,t,r,s)}static getId(e,t,r,s){return"object"==typeof e?`${e.level}/${e.row}/${e.col}/${e.world}`:`${e}/${t}/${r}/${s}`}get key(){return this}get id(){return this.toString()}set id(e){this.set(e)}acquire(e,t,r,s){this.set(e,t,r,s)}contains(e){const t=e.level-this.level;return this.row===e.row>>t&&this.col===e.col>>t&&this.world===e.world}equals(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}clone(){return new n(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(e,t,r,s){if(null==e)this.level=0,this.row=0,this.col=0,this.world=0;else if("object"==typeof e)this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if("string"==typeof e){const[t,r,s,n]=e.split("/");this.level=parseFloat(t),this.row=parseFloat(r),this.col=parseFloat(s),this.world=parseFloat(n)}else this.level=+e,this.row=+t,this.col=+r,this.world=+s||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new n(this.level-1,this.row>>1,this.col>>1,this.world)}getChildKeys(){const e=this.level+1,t=this.row<<1,r=this.col<<1,s=this.world;return[new n(e,t,r,s),new n(e,t,r+1,s),new n(e,t+1,r,s),new n(e,t+1,r+1,s)]}compareRowMajor(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}}n.pool=new s.a(n,null,null,25,50),t.a=n},243:function(e,t,r){"use strict";var s,n=r(81),i=(r(79),r(90)),o=(r(80),r(87),r(84)),a=r(93),u=r(83),c=r(94),l=(r(82),r(85),r(86),r(89));const h=new a.a({count:"count",sum:"sum",min:"min",max:"max",avg:"avg",stddev:"stddev",var:"var",exceedslimit:"exceedslimit",percentile_cont:"percentile-continuous",percentile_disc:"percentile-discrete"});let d=s=class extends l.a{constructor(e){super(e),this.maxPointCount=void 0,this.maxRecordCount=void 0,this.maxVertexCount=void 0,this.onStatisticField=null,this.outStatisticFieldName=null,this.statisticType=null,this.statisticParameters=null}writeStatisticParameters(e,t){"percentile-continuous"!==this.statisticType&&"percentile-discrete"!==this.statisticType||(t.statisticParameters=Object(i.a)(e))}clone(){return new s({maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,statisticType:this.statisticType,statisticParameters:Object(i.a)(this.statisticParameters)})}};Object(n.a)([Object(o.b)({type:Number,json:{write:!0}})],d.prototype,"maxPointCount",void 0),Object(n.a)([Object(o.b)({type:Number,json:{write:!0}})],d.prototype,"maxRecordCount",void 0),Object(n.a)([Object(o.b)({type:Number,json:{write:!0}})],d.prototype,"maxVertexCount",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],d.prototype,"onStatisticField",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],d.prototype,"outStatisticFieldName",void 0),Object(n.a)([Object(o.b)({type:String,json:{read:{source:"statisticType",reader:h.read},write:{target:"statisticType",writer:h.write}}})],d.prototype,"statisticType",void 0),Object(n.a)([Object(o.b)({type:Object})],d.prototype,"statisticParameters",void 0),Object(n.a)([Object(c.a)("statisticParameters")],d.prototype,"writeStatisticParameters",null),d=s=Object(n.a)([Object(u.a)("esri.tasks.support.StatisticDefinition")],d);var f=d;t.a=f},247:function(e,t,r){"use strict";var s,n=r(81),i=(r(79),r(90)),o=(r(80),r(87),r(84)),a=r(93),u=r(83),c=(r(82),r(85),r(86),r(89)),l=r(101);r(99);const h=new a.a({upperLeft:"upper-left",lowerLeft:"lower-left"});let d=s=class extends c.a{constructor(e){super(e),this.extent=null,this.mode="view",this.originPosition="upper-left",this.tolerance=1}clone(){return new s(Object(i.a)({extent:this.extent,mode:this.mode,originPosition:this.originPosition,tolerance:this.tolerance}))}};Object(n.a)([Object(o.b)({type:l.a,json:{write:{overridePolicy(){return{enabled:"view"===this.mode}}}}})],d.prototype,"extent",void 0),Object(n.a)([Object(o.b)({type:["view","edit"],json:{write:!0}})],d.prototype,"mode",void 0),Object(n.a)([Object(o.b)({type:String,json:{read:h.read,write:h.write}})],d.prototype,"originPosition",void 0),Object(n.a)([Object(o.b)({type:Number,json:{write:{overridePolicy(){return{enabled:"view"===this.mode}}}}})],d.prototype,"tolerance",void 0),d=s=Object(n.a)([Object(u.a)("esri.tasks.support.QuantizationParameters")],d);var f=d;t.a=f},259:function(e,t,r){"use strict";r.d(t,"a",(function(){return l}));var s,n=r(81),i=(r(79),r(80),r(87)),o=r(84),a=r(100),u=r(83),c=(r(82),r(85),r(86),r(89));let l=s=class extends c.a{constructor(e){super(e),this.type="map-layer"}clone(){const{mapLayerId:e,gdbVersion:t}=this;return new s({mapLayerId:e,gdbVersion:t})}};Object(n.a)([Object(a.a)({mapLayer:"map-layer"})],l.prototype,"type",void 0),Object(n.a)([Object(o.b)({type:i.a,json:{write:!0}})],l.prototype,"mapLayerId",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],l.prototype,"gdbVersion",void 0),l=s=Object(n.a)([Object(u.a)("esri.layers.support.source.MapLayerSource")],l)},266:function(e,t,r){"use strict";function s(e){const t={};for(const r in e){if("declaredClass"===r)continue;const n=e[r];if(null!=n&&"function"!=typeof n)if(Array.isArray(n)){t[r]=[];for(let e=0;e<n.length;e++)t[r][e]=s(n[e])}else"object"==typeof n?n.toJSON&&(t[r]=JSON.stringify(n)):t[r]=n}return t}r.d(t,"a",(function(){return s}))},267:function(e,t,r){"use strict";r.d(t,"a",(function(){return n}));var s=r(209);function n(e,t,r){if(!r||!r.features||!r.hasZ)return;const n=Object(s.a)(r.geometryType,t,e.outSpatialReference);if(n)for(const s of r.features)n(s.geometry)}},269:function(e,t,r){"use strict";r.r(t),r.d(t,"WhereClause",(function(){return x})),r.d(t,"defaultAttributeAdapter",(function(){return P}));var s=r(79);const n={min:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.min.apply(Math,e[0])},max:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.max.apply(Math,e[0])},avg:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:i(e[0])},sum:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:function(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r];return t}(e[0])},stddev:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.sqrt(o(e[0]))},count:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].length},var:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:o(e[0])}};function i(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r];return t/e.length}function o(e){const t=i(e),r=e.length;let s=0;for(const n of e)s+=(n-t)**2;return r>1?s/(r-1):0}var a=r(140);class u{constructor(){this.op="+",this.day=0,this.second=0,this.hour=0,this.month=0,this.year=0,this.minute=0}static fixDefaults(e){if(null!==e.precision||null!==e.secondary)throw new Error("Primary and Secondary SqlInterval qualifiers not supported")}static createFromMilliseconds(e){const t=new u;return t.second=e/1e3,t}static createFromValueAndQualifer(e,t,r){let s=null;const n=new u;if(n.op="-"===r?"-":"+","interval-period"===t.type){u.fixDefaults(t);const r=new RegExp("^[0-9]{1,}$");if("year"===t.period||"month"===t.period)throw new Error("Year-Month Intervals not supported");if(!r.test(e))throw new Error("Illegal Interval");n[t.period]=parseFloat(e)}else{if(u.fixDefaults(t.start),u.fixDefaults(t.end),"year"===t.start.period||"month"===t.start.period)throw new Error("Year-Month Intervals not supported");if("year"===t.end.period||"month"===t.end.period)throw new Error("Year-Month Intervals not supported");switch(t.start.period){case"day":switch(t.end.period){case"hour":if(s=new RegExp("^[0-9]{1,} [0-9]{1,}$"),!s.test(e))throw new Error("Illegal Interval");n[t.start.period]=parseFloat(e.split(" ")[0]),n[t.end.period]=parseFloat(e.split(" ")[1]);break;case"minute":if(s=new RegExp("^[0-9]{1,} [0-9]{1,2}:[0-9]{1,}$"),!s.test(e))throw new Error("Illegal Interval");{n[t.start.period]=parseFloat(e.split(" ")[0]);const r=e.split(" ")[1].split(":");n.hour=parseFloat(r[0]),n.minute=parseFloat(r[1])}break;case"second":if(s=new RegExp("^[0-9]{1,} [0-9]{1,2}:[0-9]{1,2}:[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$"),!s.test(e))throw new Error("Illegal Interval");{n[t.start.period]=parseFloat(e.split(" ")[0]);const r=e.split(" ")[1].split(":");n.hour=parseFloat(r[0]),n.minute=parseFloat(r[1]),n.second=parseFloat(r[2])}break;default:throw"Invalid Interval."}break;case"hour":switch(t.end.period){case"minute":if(s=new RegExp("^[0-9]{1,}:[0-9]{1,}$"),!s.test(e))throw new Error("Illegal Interval");n.hour=parseFloat(e.split(":")[0]),n.minute=parseFloat(e.split(":")[1]);break;case"second":if(s=new RegExp("^[0-9]{1,}:[0-9]{1,2}:[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$"),!s.test(e))throw new Error("Illegal Interval");{const t=e.split(":");n.hour=parseFloat(t[0]),n.minute=parseFloat(t[1]),n.second=parseFloat(t[2])}break;default:throw"Invalid Interval."}break;case"minute":switch(t.end.period){case"second":if(s=new RegExp("^[0-9]{1,}:[0-9]{1,}([.]{1}[0-9]{1,}){0,1}$"),!s.test(e))throw new Error("Illegal Interval");{const t=e.split(":");n.minute=parseFloat(t[0]),n.second=parseFloat(t[1])}break;default:throw"Invalid Interval."}break;default:throw"Invalid Interval."}}return n}valueInMilliseconds(){return("-"===this.op?-1:1)*(1e3*this.second+60*this.minute*1e3+60*this.hour*60*1e3+24*this.day*60*60*1e3+this.month*(365/12)*24*60*60*1e3+365*this.year*24*60*60*1e3)}}function c(e,t){const r=l[e.toLowerCase()];if(null==r)throw new Error("Function Not Recognised");if(t.length<r.minParams||t.length>r.maxParams)throw new Error(`Invalid Parameter count for call to ${e.toUpperCase()}`);return r.evaluate(t)}const l={extract:{minParams:2,maxParams:2,evaluate:([e,t])=>{if(null==t)return null;if(t instanceof Date)switch(e.toUpperCase()){case"SECOND":return t.getSeconds();case"MINUTE":return t.getMinutes();case"HOUR":return t.getHours();case"DAY":return t.getDate();case"MONTH":return t.getMonth()+1;case"YEAR":return t.getFullYear()}throw new Error("Invalid Parameter for call to EXTRACT")}},substring:{minParams:2,maxParams:3,evaluate:e=>{if(2===e.length){const[t,r]=e;return null==t||null==r?null:t.toString().substring(r-1)}if(3===e.length){const[t,r,s]=e;return null==t||null==r||null==s?null:s<=0?"":t.toString().substring(r-1,r+s-1)}}},position:{minParams:2,maxParams:2,evaluate:([e,t])=>null==e||null==t?null:t.indexOf(e)+1},trim:{minParams:2,maxParams:3,evaluate:e=>{const t=3===e.length,r=t?e[1]:" ",s=t?e[2]:e[1];if(null==r||null==s)return null;const n=`(${Object(a.a)(r)})`;switch(e[0]){case"BOTH":return s.replace(new RegExp(`^${n}*|${n}*$`,"g"),"");case"LEADING":return s.replace(new RegExp(`^${n}*`,"g"),"");case"TRAILING":return s.replace(new RegExp(`${n}*$`,"g"),"")}throw new Error("Invalid Parameter for call to TRIM")}},abs:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.abs(e[0])},ceiling:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.ceil(e[0])},floor:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.floor(e[0])},log:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.log(e[0])},log10:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.log(e[0])*Math.LOG10E},sin:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.sin(e[0])},cos:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.cos(e[0])},tan:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.tan(e[0])},asin:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.asin(e[0])},acos:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.acos(e[0])},atan:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:Math.atan(e[0])},sign:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0]>0?1:e[1]<0?-1:0},power:{minParams:2,maxParams:2,evaluate:e=>null==e[0]||null==e[1]?null:e[0]**e[1]},mod:{minParams:2,maxParams:2,evaluate:e=>null==e[0]||null==e[1]?null:e[0]%e[1]},round:{minParams:1,maxParams:2,evaluate:e=>{const t=e[0],r=2===e.length?10**e[1]:1;return null==t?null:Math.round(t*r)/r}},truncate:{minParams:1,maxParams:2,evaluate:e=>null==e[0]?null:1===e.length?parseInt(e[0].toFixed(0),10):parseFloat(e[0].toFixed(e[1]))},char_length:{minParams:1,maxParams:1,evaluate:e=>"string"==typeof e[0]||e[0]instanceof String?e[0].length:0},concat:{minParams:1,maxParams:1/0,evaluate:e=>{let t="";for(let r=0;r<e.length;r++){if(null==e[r])return null;t+=e[r].toString()}return t}},lower:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].toString().toLowerCase()},upper:{minParams:1,maxParams:1,evaluate:e=>null==e[0]?null:e[0].toString().toUpperCase()}};var h=r(130),d=Object(h.b)((function(e){var t;t=function(){function e(t,r,s,n){this.message=t,this.expected=r,this.found=s,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}return function(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}(e,Error),e.buildMessage=function(e,t){var r={literal:function(e){return'"'+n(e.text)+'"'},class:function(e){var t,r="";for(t=0;t<e.parts.length;t++)r+=e.parts[t]instanceof Array?i(e.parts[t][0])+"-"+i(e.parts[t][1]):i(e.parts[t]);return"["+(e.inverted?"^":"")+r+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function s(e){return e.charCodeAt(0).toString(16).toUpperCase()}function n(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+s(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+s(e)}))}function i(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(e){return"\\x0"+s(e)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(e){return"\\x"+s(e)}))}function o(e){return r[e.type](e)}return"Expected "+function(e){var t,r,s=new Array(e.length);for(t=0;t<e.length;t++)s[t]=o(e[t]);if(s.sort(),s.length>0){for(t=1,r=1;t<s.length;t++)s[t-1]!==s[t]&&(s[r]=s[t],r++);s.length=r}switch(s.length){case 1:return s[0];case 2:return s[0]+" or "+s[1];default:return s.slice(0,-1).join(", ")+", or "+s[s.length-1]}}(e)+" but "+function(e){return e?'"'+n(e)+'"':"end of input"}(t)+" found."},{SyntaxError:e,parse:function(t,r){r=void 0!==r?r:{};var s,n={},i={start:Ye},o=Ye,a=function(e,t){var r={type:"expr_list"},s=function(e,t,r){return function(e,t){for(var r=[e],s=0;s<t.length;s++)r.push(t[s][3]);return r}(e,t)}(e,t);return r.value=s,r},u=function(e,t){return gr(e,t)},c=Le("!",!1),l=Le("=",!1),h=Le(">=",!1),d=Le(">",!1),f=Le("<=",!1),p=Le("<>",!1),g=Le("<",!1),m=Le("!=",!1),y=function(e){return e[0]+" "+e[2]},b=Le("+",!1),_=Le("-",!1),v=Le("*",!1),x=Le("/",!1),w=function(e,t){return e+t.join("")},O=/^[A-Za-z_\x80-\uFFFF]/,j=Ue([["A","Z"],["a","z"],"_",["\x80","\uffff"]],!1,!1),I=/^[A-Za-z0-9_]/,S=Ue([["A","Z"],["a","z"],["0","9"],"_"],!1,!1),T=/^[A-Za-z0-9_.\x80-\uFFFF]/,F=Ue([["A","Z"],["a","z"],["0","9"],"_",".",["\x80","\uffff"]],!1,!1),M=Le("@",!1),k=function(e){return{type:"interval-period",period:e.value,precision:null,secondary:null}},C=function(e,t){return{type:"interval-period",period:"second",precision:e,secondary:t}},R=function(e){return parseFloat(e)},A=Le("'",!1),E=Le("N'",!1),N="''",P=Le("''",!1),q=/^[^']/,z=Ue(["'"],!0,!1),D=function(e,t){return{type:"when_clause",operand:e,value:t}},G=Le(".",!1),L=/^[0-9]/,U=Ue([["0","9"]],!1,!1),B=/^[eE]/,V=Ue(["e","E"],!1,!1),Q=/^[+\-]/,Y=Ue(["+","-"],!1,!1),X=Le("NULL",!0),J=Le("TRUE",!0),Z=Le("FALSE",!0),H=Le("IN",!0),$=Le("IS",!0),W=Le("LIKE",!0),K=Le("ESCAPE",!0),ee=Le("NOT",!0),te=Le("AND",!0),re=Le("OR",!0),se=Le("BETWEEN",!0),ne=Le("FROM",!0),ie=Le("FOR",!0),oe=Le("SUBSTRING",!0),ae=Le("EXTRACT",!0),ue=Le("TRIM",!0),ce=Le("POSITION",!0),le=Le("TIMESTAMP",!0),he=Le("DATE",!0),de=Le("LEADING",!0),fe=Le("TRAILING",!0),pe=Le("BOTH",!0),ge=Le("TO",!0),me=Le("INTERVAL",!0),ye=Le("YEAR",!0),be=Le("MONTH",!0),_e=Le("DAY",!0),ve=Le("HOUR",!0),xe=Le("MINUTE",!0),we=Le("SECOND",!0),Oe=Le("CASE",!0),je=Le("END",!0),Ie=Le("WHEN",!0),Se=Le("THEN",!0),Te=Le("ELSE",!0),Fe=Le(",",!1),Me=Le("(",!1),ke=Le(")",!1),Ce=/^[ \t\n\r]/,Re=Ue([" ","\t","\n","\r"],!1,!1),Ae=Le("`",!1),Ee=/^[^`]/,Ne=Ue(["`"],!0,!1),Pe=0,qe=[{line:1,column:1}],ze=0,De=[],Ge=0;if("startRule"in r){if(!(r.startRule in i))throw new Error("Can't start parsing from rule \""+r.startRule+'".');o=i[r.startRule]}function Le(e,t){return{type:"literal",text:e,ignoreCase:t}}function Ue(e,t,r){return{type:"class",parts:e,inverted:t,ignoreCase:r}}function Be(e){var r,s=qe[e];if(s)return s;for(r=e-1;!qe[r];)r--;for(s={line:(s=qe[r]).line,column:s.column};r<e;)10===t.charCodeAt(r)?(s.line++,s.column=1):s.column++,r++;return qe[e]=s,s}function Ve(e,t){var r=Be(e),s=Be(t);return{start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:s.line,column:s.column}}}function Qe(e){Pe<ze||(Pe>ze&&(ze=Pe,De=[]),De.push(e))}function Ye(){var e,t;return e=Pe,hr()!==n&&(t=Je())!==n&&hr()!==n?e=t:(Pe=e,e=n),e}function Xe(){var e,t,r,s,i,o,u,c;if(e=Pe,(t=Je())!==n){for(r=[],s=Pe,(i=hr())!==n&&(o=ur())!==n&&(u=hr())!==n&&(c=Je())!==n?s=i=[i,o,u,c]:(Pe=s,s=n);s!==n;)r.push(s),s=Pe,(i=hr())!==n&&(o=ur())!==n&&(u=hr())!==n&&(c=Je())!==n?s=i=[i,o,u,c]:(Pe=s,s=n);r!==n?e=t=a(t,r):(Pe=e,e=n)}else Pe=e,e=n;return e}function Je(){var e,t,r,s,i,o,a,c;if(e=Pe,(t=Ze())!==n){for(r=[],s=Pe,(i=hr())!==n&&(o=Pt())!==n&&(a=hr())!==n&&(c=Ze())!==n?s=i=[i,o,a,c]:(Pe=s,s=n);s!==n;)r.push(s),s=Pe,(i=hr())!==n&&(o=Pt())!==n&&(a=hr())!==n&&(c=Ze())!==n?s=i=[i,o,a,c]:(Pe=s,s=n);r!==n?e=t=u(t,r):(Pe=e,e=n)}else Pe=e,e=n;return e}function Ze(){var e,t,r,s,i,o,a,c;if(e=Pe,(t=He())!==n){for(r=[],s=Pe,(i=hr())!==n&&(o=Nt())!==n&&(a=hr())!==n&&(c=He())!==n?s=i=[i,o,a,c]:(Pe=s,s=n);s!==n;)r.push(s),s=Pe,(i=hr())!==n&&(o=Nt())!==n&&(a=hr())!==n&&(c=He())!==n?s=i=[i,o,a,c]:(Pe=s,s=n);r!==n?e=t=u(t,r):(Pe=e,e=n)}else Pe=e,e=n;return e}function He(){var e,r,s,i,o;return e=Pe,(r=Et())===n&&(r=Pe,33===t.charCodeAt(Pe)?(s="!",Pe++):(s=n,0===Ge&&Qe(c)),s!==n?(i=Pe,Ge++,61===t.charCodeAt(Pe)?(o="=",Pe++):(o=n,0===Ge&&Qe(l)),Ge--,o===n?i=void 0:(Pe=i,i=n),i!==n?r=s=[s,i]:(Pe=r,r=n)):(Pe=r,r=n)),r!==n&&(s=hr())!==n&&(i=He())!==n?e=r=function(e){return function(e,t){return{type:"unary_expr",operator:"NOT",expr:t}}(0,e)}(i):(Pe=e,e=n),e===n&&(e=function(){var e,t,r;return e=Pe,(t=et())!==n&&hr()!==n?((r=function(){var e;return(e=function(){var e,t,r,s,i,o;if(e=[],t=Pe,(r=hr())!==n&&(s=$e())!==n&&(i=hr())!==n&&(o=et())!==n?t=r=[r,s,i,o]:(Pe=t,t=n),t!==n)for(;t!==n;)e.push(t),t=Pe,(r=hr())!==n&&(s=$e())!==n&&(i=hr())!==n&&(o=et())!==n?t=r=[r,s,i,o]:(Pe=t,t=n);else e=n;return e!==n&&(e=function(e){return{type:"arithmetic",tail:e}}(e)),e}())===n&&(e=function(){var e,t,r,s;return e=Pe,(t=Ke())!==n&&hr()!==n&&(r=cr())!==n&&hr()!==n&&(s=Xe())!==n&&hr()!==n&&lr()!==n?e=t=function(e,t){return{op:e,right:t}}(t,s):(Pe=e,e=n),e===n&&(e=Pe,(t=Ke())!==n&&hr()!==n&&(r=cr())!==n&&hr()!==n&&(s=lr())!==n?e=t=function(e){return{op:e,right:{type:"expr_list",value:[]}}}(t):(Pe=e,e=n),e===n&&(e=Pe,(t=Ke())!==n&&hr()!==n&&(r=ct())!==n?e=t=function(e,t){return{op:e,right:t}}(t,r):(Pe=e,e=n))),e}())===n&&(e=function(){var e,t,r,s,i,o;return e=Pe,(t=Et())!==n&&hr()!==n&&(r=qt())!==n&&hr()!==n&&(s=et())!==n&&hr()!==n&&(i=Nt())!==n&&hr()!==n&&(o=et())!==n?e=t=function(e,t,r){return{op:"NOT"+e,right:{type:"expr_list",value:[t,r]}}}(r,s,o):(Pe=e,e=n),e===n&&(e=Pe,(t=qt())!==n&&hr()!==n&&(r=et())!==n&&hr()!==n&&(s=Nt())!==n&&hr()!==n&&(i=et())!==n?e=t=function(e,t,r){return{op:e,right:{type:"expr_list",value:[t,r]}}}(t,r,i):(Pe=e,e=n)),e}())===n&&(e=function(){var e,t,r,s;return e=Pe,(t=Ct())!==n&&hr()!==n&&(r=Et())!==n&&hr()!==n&&(s=et())!==n?e=t=function(e,t){return{op:e+"NOT",right:t}}(t,s):(Pe=e,e=n),e===n&&(e=Pe,(t=Ct())!==n&&hr()!==n&&(r=et())!==n?e=t=function(e,t){return{op:e,right:t}}(t,r):(Pe=e,e=n)),e}())===n&&(e=function(){var e,t,r,s;return e=Pe,(t=We())!==n&&hr()!==n&&(r=mt())!==n&&hr()!==n&&At()!==n&&hr()!==n&&(s=yt())!==n?e=t=function(e,t,r){return{op:e,right:t,escape:r.value}}(t,r,s):(Pe=e,e=n),e===n&&(e=Pe,(t=We())!==n&&hr()!==n&&(r=mt())!==n?e=t=function(e,t){return{op:e,right:t,escape:""}}(t,r):(Pe=e,e=n)),e}()),e}())===n&&(r=null),r!==n?e=t=function(e,t){return""==t||null==t||null==t?e:"arithmetic"==t.type?gr(e,t.tail):pr(t.op,e,t.right,t.escape)}(t,r):(Pe=e,e=n)):(Pe=e,e=n),e}()),e}function $e(){var e;return">="===t.substr(Pe,2)?(e=">=",Pe+=2):(e=n,0===Ge&&Qe(h)),e===n&&(62===t.charCodeAt(Pe)?(e=">",Pe++):(e=n,0===Ge&&Qe(d)),e===n&&("<="===t.substr(Pe,2)?(e="<=",Pe+=2):(e=n,0===Ge&&Qe(f)),e===n&&("<>"===t.substr(Pe,2)?(e="<>",Pe+=2):(e=n,0===Ge&&Qe(p)),e===n&&(60===t.charCodeAt(Pe)?(e="<",Pe++):(e=n,0===Ge&&Qe(g)),e===n&&(61===t.charCodeAt(Pe)?(e="=",Pe++):(e=n,0===Ge&&Qe(l)),e===n&&("!="===t.substr(Pe,2)?(e="!=",Pe+=2):(e=n,0===Ge&&Qe(m)))))))),e}function We(){var e,t,r,s,i;return e=Pe,t=Pe,(r=Et())!==n&&(s=hr())!==n&&(i=Rt())!==n?t=r=[r,s,i]:(Pe=t,t=n),t!==n&&(t=y(t)),(e=t)===n&&(e=Rt()),e}function Ke(){var e,t,r,s,i;return e=Pe,t=Pe,(r=Et())!==n&&(s=hr())!==n&&(i=kt())!==n?t=r=[r,s,i]:(Pe=t,t=n),t!==n&&(t=y(t)),(e=t)===n&&(e=kt()),e}function et(){var e,t,r,s,i,o,a,c;if(e=Pe,(t=rt())!==n){for(r=[],s=Pe,(i=hr())!==n&&(o=tt())!==n&&(a=hr())!==n&&(c=rt())!==n?s=i=[i,o,a,c]:(Pe=s,s=n);s!==n;)r.push(s),s=Pe,(i=hr())!==n&&(o=tt())!==n&&(a=hr())!==n&&(c=rt())!==n?s=i=[i,o,a,c]:(Pe=s,s=n);r!==n?e=t=u(t,r):(Pe=e,e=n)}else Pe=e,e=n;return e}function tt(){var e;return 43===t.charCodeAt(Pe)?(e="+",Pe++):(e=n,0===Ge&&Qe(b)),e===n&&(45===t.charCodeAt(Pe)?(e="-",Pe++):(e=n,0===Ge&&Qe(_))),e}function rt(){var e,t,r,s,i,o,a,u;if(e=Pe,(t=nt())!==n){for(r=[],s=Pe,(i=hr())!==n&&(o=st())!==n&&(a=hr())!==n&&(u=nt())!==n?s=i=[i,o,a,u]:(Pe=s,s=n);s!==n;)r.push(s),s=Pe,(i=hr())!==n&&(o=st())!==n&&(a=hr())!==n&&(u=nt())!==n?s=i=[i,o,a,u]:(Pe=s,s=n);r!==n?e=t=function(e,t){return gr(e,t)}(t,r):(Pe=e,e=n)}else Pe=e,e=n;return e}function st(){var e;return 42===t.charCodeAt(Pe)?(e="*",Pe++):(e=n,0===Ge&&Qe(v)),e===n&&(47===t.charCodeAt(Pe)?(e="/",Pe++):(e=n,0===Ge&&Qe(x))),e}function nt(){var e,t;return(e=function(){var e;return(e=yt())===n&&(e=function(){var e,t,r,s;return e=Pe,(t=function(){var e,t,r,s;return e=Pe,(t=xt())!==n&&(r=wt())!==n&&(s=Ot())!==n?e=t=function(e,t,r){return parseFloat(e+t+r)}(t,r,s):(Pe=e,e=n),e===n&&(e=Pe,(t=xt())!==n&&(r=wt())!==n?e=t=function(e,t){return parseFloat(e+t)}(t,r):(Pe=e,e=n),e===n&&(e=Pe,(t=xt())!==n&&(r=Ot())!==n?e=t=function(e,t){return parseFloat(e+t)}(t,r):(Pe=e,e=n),e===n&&(e=Pe,(t=xt())!==n&&(t=function(e){return parseFloat(e)}(t)),e=t))),e}())!==n?(r=Pe,Ge++,s=ot(),Ge--,s===n?r=void 0:(Pe=r,r=n),r!==n?e=t=function(e){return{type:"number",value:e}}(t):(Pe=e,e=n)):(Pe=e,e=n),e}())===n&&(e=function(){var e,t;return e=Pe,(t=Ft())!==n&&(t={type:"bool",value:!0}),(e=t)===n&&(e=Pe,(t=Mt())!==n&&(t={type:"bool",value:!1}),e=t),e}())===n&&(e=function(){var e;return(e=Tt())!==n&&(e={type:"null",value:null}),e}())===n&&(e=function(){var e,t;return e=Pe,Qt()!==n&&hr()!==n&&(t=mt())!==n?e=function(e){return{type:"date",value:e.value}}(t):(Pe=e,e=n),e}())===n&&(e=function(){var e,t;return e=Pe,Vt()!==n&&hr()!==n&&(t=mt())!==n?e=function(e){return{type:"timestamp",value:e.value}}(t):(Pe=e,e=n),e}())===n&&(e=ht()),e}())===n&&(e=function(){var e,t,r;return e=Pe,Lt()!==n&&hr()!==n&&cr()!==n&&hr()!==n&&(t=function(){var e;return(e=$t())===n&&(e=Wt())===n&&(e=Kt())===n&&(e=er())===n&&(e=tr())===n&&(e=rr()),e}())!==n&&hr()!==n&&zt()!==n&&hr()!==n&&(r=Je())!==n&&hr()!==n&&lr()!==n?e=function(e,t){return{type:"function",name:"extract",args:{type:"expr_list",value:[{type:"string",value:e},t]}}}(t,r):(Pe=e,e=n),e}())===n&&(e=function(){var e,t,r,s,i,o,a,u;return e=Pe,Gt()!==n&&hr()!==n&&cr()!==n&&hr()!==n&&(t=Je())!==n&&hr()!==n&&zt()!==n&&hr()!==n&&(r=Je())!==n&&hr()!==n?(s=Pe,(i=Dt())!==n&&(o=hr())!==n&&(a=Je())!==n&&(u=hr())!==n?s=i=[i,o,a,u]:(Pe=s,s=n),s===n&&(s=null),s!==n&&(i=lr())!==n?e=function(e,t,r){return{type:"function",name:"substring",args:{type:"expr_list",value:r?[e,t,r[2]]:[e,t]}}}(t,r,s):(Pe=e,e=n)):(Pe=e,e=n),e}())===n&&(e=function(){var e,t,r,s;return e=Pe,Ut()!==n&&hr()!==n&&cr()!==n&&hr()!==n?((t=lt())===n&&(t=null),t!==n&&hr()!==n&&(r=Je())!==n&&hr()!==n&&zt()!==n&&hr()!==n&&(s=Je())!==n&&hr()!==n&&lr()!==n?e=function(e,t,r){return{type:"function",name:"trim",args:{type:"expr_list",value:[{type:"string",value:null==e?"BOTH":e},t,r]}}}(t,r,s):(Pe=e,e=n)):(Pe=e,e=n),e===n&&(e=Pe,Ut()!==n&&hr()!==n&&cr()!==n&&hr()!==n?((t=lt())===n&&(t=null),t!==n&&hr()!==n&&(r=Je())!==n&&hr()!==n&&lr()!==n?e=function(e,t){return{type:"function",name:"trim",args:{type:"expr_list",value:[{type:"string",value:null==e?"BOTH":e},t]}}}(t,r):(Pe=e,e=n)):(Pe=e,e=n)),e}())===n&&(e=function(){var e,t,r;return e=Pe,Bt()!==n&&hr()!==n&&cr()!==n&&hr()!==n&&(t=Je())!==n&&hr()!==n&&kt()!==n&&hr()!==n&&(r=Je())!==n&&hr()!==n&&lr()!==n?e=function(e,t){return{type:"function",name:"position",args:{type:"expr_list",value:[e,t]}}}(t,r):(Pe=e,e=n),e}())===n&&(e=function(){var e,t,r;return e=Pe,(t=fr())!==n&&hr()!==n&&cr()!==n&&hr()!==n?((r=Xe())===n&&(r=null),r!==n&&hr()!==n&&lr()!==n?e=t=function(e,t){return{type:"function",name:e,args:t||{type:"expr_list",value:[]}}}(t,r):(Pe=e,e=n)):(Pe=e,e=n),e}())===n&&(e=function(){var e;return(e=function(){var e,t,r,s,i;if(e=Pe,sr()!==n)if(hr()!==n)if((t=Je())!==n)if(hr()!==n){for(r=[],s=_t();s!==n;)r.push(s),s=_t();r!==n&&(s=hr())!==n&&(i=nr())!==n?e=function(e,t){return{type:"case_expression",format:"simple",operand:e,clauses:t,else:null}}(t,r):(Pe=e,e=n)}else Pe=e,e=n;else Pe=e,e=n;else Pe=e,e=n;else Pe=e,e=n;if(e===n)if(e=Pe,sr()!==n)if(hr()!==n)if((t=Je())!==n)if(hr()!==n){for(r=[],s=_t();s!==n;)r.push(s),s=_t();r!==n&&(s=hr())!==n&&(i=vt())!==n&&hr()!==n&&nr()!==n?e=function(e,t,r){return{type:"case_expression",format:"simple",operand:e,clauses:t,else:r.value}}(t,r,i):(Pe=e,e=n)}else Pe=e,e=n;else Pe=e,e=n;else Pe=e,e=n;else Pe=e,e=n;return e}())===n&&(e=function(){var e,t,r,s;if(e=Pe,sr()!==n)if(hr()!==n){for(t=[],r=bt();r!==n;)t.push(r),r=bt();t!==n&&(r=hr())!==n&&(s=nr())!==n?e=function(e){return{type:"case_expression",format:"searched",clauses:e,else:null}}(t):(Pe=e,e=n)}else Pe=e,e=n;else Pe=e,e=n;if(e===n)if(e=Pe,sr()!==n)if(hr()!==n){for(t=[],r=bt();r!==n;)t.push(r),r=bt();t!==n&&(r=hr())!==n&&(s=vt())!==n&&hr()!==n&&nr()!==n?e=function(e,t){return{type:"case_expression",format:"searched",clauses:e,else:t.value}}(t,s):(Pe=e,e=n)}else Pe=e,e=n;else Pe=e,e=n;return e}()),e}())===n&&(e=function(){var e;return(e=function(){var e;return(e=function(){var e,t,r,s;if(e=Pe,(t=ot())!==n){for(r=[],s=ut();s!==n;)r.push(s),s=ut();r!==n?e=t=w(t,r):(Pe=e,e=n)}else Pe=e,e=n;return e}())!==n&&(e=e),e}())!==n&&(e=function(e){return/^CURRENT_DATE$/i.test(e)?{type:"current_time",mode:"date"}:/^CURRENT_TIMESTAMP$/i.test(e)?{type:"current_time",mode:"timestamp"}:{type:"column_ref",table:"",column:e}}(e)),e}())===n&&(e=ct())===n&&(e=Pe,cr()!==n&&hr()!==n&&(t=Je())!==n&&hr()!==n&&lr()!==n?e=function(e){return e.paren=!0,e}(t):(Pe=e,e=n)),e}function it(){var e,t,r,s;if(e=Pe,(t=ot())!==n){for(r=[],s=at();s!==n;)r.push(s),s=at();r!==n?e=t=w(t,r):(Pe=e,e=n)}else Pe=e,e=n;return e}function ot(){var e;return O.test(t.charAt(Pe))?(e=t.charAt(Pe),Pe++):(e=n,0===Ge&&Qe(j)),e}function at(){var e;return I.test(t.charAt(Pe))?(e=t.charAt(Pe),Pe++):(e=n,0===Ge&&Qe(S)),e}function ut(){var e;return T.test(t.charAt(Pe))?(e=t.charAt(Pe),Pe++):(e=n,0===Ge&&Qe(F)),e}function ct(){var e,r,s;return e=Pe,64===t.charCodeAt(Pe)?(r="@",Pe++):(r=n,0===Ge&&Qe(M)),r!==n&&(s=it())!==n?e=r=[r,s]:(Pe=e,e=n),e!==n&&(e=function(e){return{type:"param",value:e[1]}}(e)),e}function lt(){var e;return(e=Yt())===n&&(e=Xt())===n&&(e=Jt()),e}function ht(){var e,r,s,i;return e=Pe,Ht()!==n&&hr()!==n?(45===t.charCodeAt(Pe)?(r="-",Pe++):(r=n,0===Ge&&Qe(_)),r===n&&(43===t.charCodeAt(Pe)?(r="+",Pe++):(r=n,0===Ge&&Qe(b))),r!==n&&hr()!==n&&(s=mt())!==n&&hr()!==n&&(i=dt())!==n?e=function(e,t,r){return{type:"interval",value:t,qualifier:r,op:e}}(r,s,i):(Pe=e,e=n)):(Pe=e,e=n),e===n&&(e=Pe,Ht()!==n&&hr()!==n&&(r=mt())!==n&&hr()!==n&&(s=dt())!==n?e=function(e,t){return{type:"interval",value:e,qualifier:t,op:""}}(r,s):(Pe=e,e=n)),e}function dt(){var e,t,r;return e=Pe,(t=function(){var e,t,r;return e=Pe,(t=ft())!==n&&hr()!==n&&cr()!==n&&hr()!==n&&(r=gt())!==n&&hr()!==n&&lr()!==n?e=t=function(e,t){return{type:"interval-period",period:e.value,precision:t,secondary:null}}(t,r):(Pe=e,e=n),e===n&&(e=Pe,(t=ft())!==n&&(t=k(t)),e=t),e}())!==n&&hr()!==n&&Zt()!==n&&hr()!==n&&(r=function(){var e,t,r,s;return e=Pe,(t=ft())!==n&&(t=function(e){return{type:"interval-period",period:e.value,precision:null,secondary:null}}(t)),(e=t)===n&&(e=Pe,(t=rr())!==n&&hr()!==n&&cr()!==n&&hr()!==n&&(r=gt())!==n&&hr()!==n&&ur()!==n&&hr()!==n&&(s=pt())!==n&&hr()!==n&&lr()!==n?e=t=C(r,s):(Pe=e,e=n),e===n&&(e=Pe,(t=rr())!==n&&hr()!==n&&cr()!==n&&hr()!==n&&(r=gt())!==n&&hr()!==n&&lr()!==n?e=t=function(e){return{type:"interval-period",period:"second",precision:e,secondary:null}}(r):(Pe=e,e=n),e===n&&(e=Pe,(t=rr())!==n&&(t={type:"interval-period",period:"second",precision:null,secondary:null}),e=t))),e}())!==n?e=t=function(e,t){return{type:"interval-qualifier",start:e,end:t}}(t,r):(Pe=e,e=n),e===n&&(e=function(){var e,t,r,s;return e=Pe,(t=ft())!==n&&hr()!==n&&cr()!==n&&hr()!==n&&(r=pt())!==n&&hr()!==n&&lr()!==n?e=t=function(e,t){return{type:"interval-period",period:e.value,precision:t,secondary:null}}(t,r):(Pe=e,e=n),e===n&&(e=Pe,(t=ft())!==n&&(t=k(t)),(e=t)===n&&(e=Pe,(t=rr())!==n&&hr()!==n&&cr()!==n&&hr()!==n&&(r=gt())!==n&&hr()!==n&&ur()!==n&&hr()!==n&&(s=pt())!==n&&hr()!==n&&lr()!==n?e=t=C(r,s):(Pe=e,e=n),e===n&&(e=Pe,(t=rr())!==n&&hr()!==n&&cr()!==n&&hr()!==n&&(r=pt())!==n&&hr()!==n&&lr()!==n?e=t=function(e){return{type:"interval-period",period:"second",precision:e,secondary:null}}(r):(Pe=e,e=n),e===n&&(e=Pe,(t=rr())!==n&&(t={type:"interval-period",period:"second",precision:null,secondary:null}),e=t)))),e}()),e}function ft(){var e,t;return e=Pe,(t=Kt())!==n&&(t={type:"string",value:"day"}),(e=t)===n&&(e=Pe,(t=er())!==n&&(t={type:"string",value:"hour"}),(e=t)===n&&(e=Pe,(t=tr())!==n&&(t={type:"string",value:"minute"}),(e=t)===n&&(e=Pe,(t=Wt())!==n&&(t={type:"string",value:"month"}),(e=t)===n&&(e=Pe,(t=$t())!==n&&(t={type:"string",value:"year"}),e=t)))),e}function pt(){var e;return(e=jt())!==n&&(e=R(e)),e}function gt(){var e;return(e=jt())!==n&&(e=R(e)),e}function mt(){var e;return(e=yt())===n&&(e=ct()),e}function yt(){var e,r,s,i,o;if(e=Pe,39===t.charCodeAt(Pe)?(r="'",Pe++):(r=n,0===Ge&&Qe(A)),r===n&&("N'"===t.substr(Pe,2)?(r="N'",Pe+=2):(r=n,0===Ge&&Qe(E))),r!==n){for(s=[],i=Pe,t.substr(Pe,2)===N?(o=N,Pe+=2):(o=n,0===Ge&&Qe(P)),o!==n&&(o="'"),(i=o)===n&&(q.test(t.charAt(Pe))?(i=t.charAt(Pe),Pe++):(i=n,0===Ge&&Qe(z)));i!==n;)s.push(i),i=Pe,t.substr(Pe,2)===N?(o=N,Pe+=2):(o=n,0===Ge&&Qe(P)),o!==n&&(o="'"),(i=o)===n&&(q.test(t.charAt(Pe))?(i=t.charAt(Pe),Pe++):(i=n,0===Ge&&Qe(z)));s!==n?(39===t.charCodeAt(Pe)?(i="'",Pe++):(i=n,0===Ge&&Qe(A)),i!==n?e=r=function(e){return{type:"string",value:e.join("")}}(s):(Pe=e,e=n)):(Pe=e,e=n)}else Pe=e,e=n;return e}function bt(){var e,t,r;return e=Pe,ir()!==n&&hr()!==n&&(t=Je())!==n&&hr()!==n&&or()!==n&&hr()!==n&&(r=Je())!==n?e=D(t,r):(Pe=e,e=n),e}function _t(){var e,t,r;return e=Pe,ir()!==n&&hr()!==n&&(t=Je())!==n&&hr()!==n&&or()!==n&&hr()!==n&&(r=Je())!==n?e=D(t,r):(Pe=e,e=n),e}function vt(){var e,t;return e=Pe,ar()!==n&&hr()!==n&&(t=Je())!==n?e=function(e){return{type:"else_clause",value:e}}(t):(Pe=e,e=n),e}function xt(){var e,r,s;return(e=jt())===n&&(e=Pe,45===t.charCodeAt(Pe)?(r="-",Pe++):(r=n,0===Ge&&Qe(_)),r===n&&(43===t.charCodeAt(Pe)?(r="+",Pe++):(r=n,0===Ge&&Qe(b))),r!==n&&(s=jt())!==n?e=r=function(e,t){return e[0]+t}(r,s):(Pe=e,e=n)),e}function wt(){var e,r,s;return e=Pe,46===t.charCodeAt(Pe)?(r=".",Pe++):(r=n,0===Ge&&Qe(G)),r!==n?((s=jt())===n&&(s=null),s!==n?e=r=function(e){return"."+(null!=e?e:"")}(s):(Pe=e,e=n)):(Pe=e,e=n),e}function Ot(){var e,t,r;return e=Pe,(t=St())!==n&&(r=jt())!==n?e=t=function(e,t){return e+t}(t,r):(Pe=e,e=n),e}function jt(){var e,t;if(e=[],(t=It())!==n)for(;t!==n;)e.push(t),t=It();else e=n;return e!==n&&(e=function(e){return e.join("")}(e)),e}function It(){var e;return L.test(t.charAt(Pe))?(e=t.charAt(Pe),Pe++):(e=n,0===Ge&&Qe(U)),e}function St(){var e,r,s;return e=Pe,B.test(t.charAt(Pe))?(r=t.charAt(Pe),Pe++):(r=n,0===Ge&&Qe(V)),r!==n?(Q.test(t.charAt(Pe))?(s=t.charAt(Pe),Pe++):(s=n,0===Ge&&Qe(Y)),s===n&&(s=null),s!==n?e=r=function(e,t){return"e"+(null===t?"":t)}(0,s):(Pe=e,e=n)):(Pe=e,e=n),e}function Tt(){var e,r,s,i;return e=Pe,"null"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(X)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r=[r,s]:(Pe=e,e=n)):(Pe=e,e=n),e}function Ft(){var e,r,s,i;return e=Pe,"true"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(J)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r=[r,s]:(Pe=e,e=n)):(Pe=e,e=n),e}function Mt(){var e,r,s,i;return e=Pe,"false"===t.substr(Pe,5).toLowerCase()?(r=t.substr(Pe,5),Pe+=5):(r=n,0===Ge&&Qe(Z)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r=[r,s]:(Pe=e,e=n)):(Pe=e,e=n),e}function kt(){var e,r,s,i;return e=Pe,"in"===t.substr(Pe,2).toLowerCase()?(r=t.substr(Pe,2),Pe+=2):(r=n,0===Ge&&Qe(H)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="IN":(Pe=e,e=n)):(Pe=e,e=n),e}function Ct(){var e,r,s,i;return e=Pe,"is"===t.substr(Pe,2).toLowerCase()?(r=t.substr(Pe,2),Pe+=2):(r=n,0===Ge&&Qe($)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="IS":(Pe=e,e=n)):(Pe=e,e=n),e}function Rt(){var e,r,s,i;return e=Pe,"like"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(W)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="LIKE":(Pe=e,e=n)):(Pe=e,e=n),e}function At(){var e,r,s,i;return e=Pe,"escape"===t.substr(Pe,6).toLowerCase()?(r=t.substr(Pe,6),Pe+=6):(r=n,0===Ge&&Qe(K)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="ESCAPE":(Pe=e,e=n)):(Pe=e,e=n),e}function Et(){var e,r,s,i;return e=Pe,"not"===t.substr(Pe,3).toLowerCase()?(r=t.substr(Pe,3),Pe+=3):(r=n,0===Ge&&Qe(ee)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="NOT":(Pe=e,e=n)):(Pe=e,e=n),e}function Nt(){var e,r,s,i;return e=Pe,"and"===t.substr(Pe,3).toLowerCase()?(r=t.substr(Pe,3),Pe+=3):(r=n,0===Ge&&Qe(te)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="AND":(Pe=e,e=n)):(Pe=e,e=n),e}function Pt(){var e,r,s,i;return e=Pe,"or"===t.substr(Pe,2).toLowerCase()?(r=t.substr(Pe,2),Pe+=2):(r=n,0===Ge&&Qe(re)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="OR":(Pe=e,e=n)):(Pe=e,e=n),e}function qt(){var e,r,s,i;return e=Pe,"between"===t.substr(Pe,7).toLowerCase()?(r=t.substr(Pe,7),Pe+=7):(r=n,0===Ge&&Qe(se)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="BETWEEN":(Pe=e,e=n)):(Pe=e,e=n),e}function zt(){var e,r,s,i;return e=Pe,"from"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(ne)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="FROM":(Pe=e,e=n)):(Pe=e,e=n),e}function Dt(){var e,r,s,i;return e=Pe,"for"===t.substr(Pe,3).toLowerCase()?(r=t.substr(Pe,3),Pe+=3):(r=n,0===Ge&&Qe(ie)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="FOR":(Pe=e,e=n)):(Pe=e,e=n),e}function Gt(){var e,r,s,i;return e=Pe,"substring"===t.substr(Pe,9).toLowerCase()?(r=t.substr(Pe,9),Pe+=9):(r=n,0===Ge&&Qe(oe)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="SUBSTRING":(Pe=e,e=n)):(Pe=e,e=n),e}function Lt(){var e,r,s,i;return e=Pe,"extract"===t.substr(Pe,7).toLowerCase()?(r=t.substr(Pe,7),Pe+=7):(r=n,0===Ge&&Qe(ae)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="EXTRACT":(Pe=e,e=n)):(Pe=e,e=n),e}function Ut(){var e,r,s,i;return e=Pe,"trim"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(ue)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="TRIM":(Pe=e,e=n)):(Pe=e,e=n),e}function Bt(){var e,r,s,i;return e=Pe,"position"===t.substr(Pe,8).toLowerCase()?(r=t.substr(Pe,8),Pe+=8):(r=n,0===Ge&&Qe(ce)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="POSITION":(Pe=e,e=n)):(Pe=e,e=n),e}function Vt(){var e,r,s,i;return e=Pe,"timestamp"===t.substr(Pe,9).toLowerCase()?(r=t.substr(Pe,9),Pe+=9):(r=n,0===Ge&&Qe(le)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="TIMESTAMP":(Pe=e,e=n)):(Pe=e,e=n),e}function Qt(){var e,r,s,i;return e=Pe,"date"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(he)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="DATE":(Pe=e,e=n)):(Pe=e,e=n),e}function Yt(){var e,r,s,i;return e=Pe,"leading"===t.substr(Pe,7).toLowerCase()?(r=t.substr(Pe,7),Pe+=7):(r=n,0===Ge&&Qe(de)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="LEADING":(Pe=e,e=n)):(Pe=e,e=n),e}function Xt(){var e,r,s,i;return e=Pe,"trailing"===t.substr(Pe,8).toLowerCase()?(r=t.substr(Pe,8),Pe+=8):(r=n,0===Ge&&Qe(fe)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="TRAILING":(Pe=e,e=n)):(Pe=e,e=n),e}function Jt(){var e,r,s,i;return e=Pe,"both"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(pe)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="BOTH":(Pe=e,e=n)):(Pe=e,e=n),e}function Zt(){var e,r,s,i;return e=Pe,"to"===t.substr(Pe,2).toLowerCase()?(r=t.substr(Pe,2),Pe+=2):(r=n,0===Ge&&Qe(ge)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="TO":(Pe=e,e=n)):(Pe=e,e=n),e}function Ht(){var e,r,s,i;return e=Pe,"interval"===t.substr(Pe,8).toLowerCase()?(r=t.substr(Pe,8),Pe+=8):(r=n,0===Ge&&Qe(me)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="INTERVAL":(Pe=e,e=n)):(Pe=e,e=n),e}function $t(){var e,r,s,i;return e=Pe,"year"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(ye)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="YEAR":(Pe=e,e=n)):(Pe=e,e=n),e}function Wt(){var e,r,s,i;return e=Pe,"month"===t.substr(Pe,5).toLowerCase()?(r=t.substr(Pe,5),Pe+=5):(r=n,0===Ge&&Qe(be)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="MONTH":(Pe=e,e=n)):(Pe=e,e=n),e}function Kt(){var e,r,s,i;return e=Pe,"day"===t.substr(Pe,3).toLowerCase()?(r=t.substr(Pe,3),Pe+=3):(r=n,0===Ge&&Qe(_e)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="DAY":(Pe=e,e=n)):(Pe=e,e=n),e}function er(){var e,r,s,i;return e=Pe,"hour"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(ve)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="HOUR":(Pe=e,e=n)):(Pe=e,e=n),e}function tr(){var e,r,s,i;return e=Pe,"minute"===t.substr(Pe,6).toLowerCase()?(r=t.substr(Pe,6),Pe+=6):(r=n,0===Ge&&Qe(xe)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="MINUTE":(Pe=e,e=n)):(Pe=e,e=n),e}function rr(){var e,r,s,i;return e=Pe,"second"===t.substr(Pe,6).toLowerCase()?(r=t.substr(Pe,6),Pe+=6):(r=n,0===Ge&&Qe(we)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="SECOND":(Pe=e,e=n)):(Pe=e,e=n),e}function sr(){var e,r,s,i;return e=Pe,"case"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(Oe)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="CASE":(Pe=e,e=n)):(Pe=e,e=n),e}function nr(){var e,r,s,i;return e=Pe,"end"===t.substr(Pe,3).toLowerCase()?(r=t.substr(Pe,3),Pe+=3):(r=n,0===Ge&&Qe(je)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="END":(Pe=e,e=n)):(Pe=e,e=n),e}function ir(){var e,r,s,i;return e=Pe,"when"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(Ie)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="WHEN":(Pe=e,e=n)):(Pe=e,e=n),e}function or(){var e,r,s,i;return e=Pe,"then"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(Se)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="THEN":(Pe=e,e=n)):(Pe=e,e=n),e}function ar(){var e,r,s,i;return e=Pe,"else"===t.substr(Pe,4).toLowerCase()?(r=t.substr(Pe,4),Pe+=4):(r=n,0===Ge&&Qe(Te)),r!==n?(s=Pe,Ge++,i=at(),Ge--,i===n?s=void 0:(Pe=s,s=n),s!==n?e=r="ELSE":(Pe=e,e=n)):(Pe=e,e=n),e}function ur(){var e;return 44===t.charCodeAt(Pe)?(e=",",Pe++):(e=n,0===Ge&&Qe(Fe)),e}function cr(){var e;return 40===t.charCodeAt(Pe)?(e="(",Pe++):(e=n,0===Ge&&Qe(Me)),e}function lr(){var e;return 41===t.charCodeAt(Pe)?(e=")",Pe++):(e=n,0===Ge&&Qe(ke)),e}function hr(){var e,t;for(e=[],t=dr();t!==n;)e.push(t),t=dr();return e}function dr(){var e;return Ce.test(t.charAt(Pe))?(e=t.charAt(Pe),Pe++):(e=n,0===Ge&&Qe(Re)),e}function fr(){var e,r,s,i;if(e=Pe,(r=it())!==n&&(r=r),(e=r)===n)if(e=Pe,96===t.charCodeAt(Pe)?(r="`",Pe++):(r=n,0===Ge&&Qe(Ae)),r!==n){if(s=[],Ee.test(t.charAt(Pe))?(i=t.charAt(Pe),Pe++):(i=n,0===Ge&&Qe(Ne)),i!==n)for(;i!==n;)s.push(i),Ee.test(t.charAt(Pe))?(i=t.charAt(Pe),Pe++):(i=n,0===Ge&&Qe(Ne));else s=n;s!==n?(96===t.charCodeAt(Pe)?(i="`",Pe++):(i=n,0===Ge&&Qe(Ae)),i!==n?e=r=function(e){return e.join("")}(s):(Pe=e,e=n)):(Pe=e,e=n)}else Pe=e,e=n;return e}function pr(e,t,r,s){var n={type:"binary_expr",operator:e,left:t,right:r};return void 0!==s&&(n.escape=s),n}function gr(e,t){for(var r=e,s=0;s<t.length;s++)r=pr(t[s][1],r,t[s][3]);return r}if((s=o())!==n&&Pe===t.length)return s;throw s!==n&&Pe<t.length&&Qe({type:"end"}),function(t,r,s){return new e(e.buildMessage(t,r),t,r,s)}(De,ze<t.length?t.charAt(ze):null,ze<t.length?Ve(ze,ze+1):Ve(ze,ze))}}},e.exports&&(e.exports=t())}));const f=/^(\d{4})-(\d{1,2})-(\d{1,2})$/,p=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)$/,g=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2}):(\d{1,2}(\.[0-9]+)?)(\+|\-)(\d{1,2}):(\d{1,2})$/,m=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})(\+|\-)(\d{1,2}):(\d{1,2})$/,y=/^(\d{4})-(\d{1,2})-(\d{1,2}) (\d{1,2}):(\d{1,2})$/;function b(e,t){return(e+="").length>=t?e:new Array(t-e.length+1).join("0")+e}function _(e,t,r="0",s="0",n="0",i="0",o="",a="0",u="0"){if("+"===o||"-"===o){const c=`${b(parseInt(e,10),4)}-${b(parseInt(t,10),2)}-${b(parseInt(r,10),2)}`;let l="";parseFloat(i)<10&&(l="0");const h=`${b(parseInt(s,10),2)}:${b(parseInt(n,10),2)}:${l+parseFloat(i).toString()}`,d=`${o}${b(parseInt(a,10),2)}:${b(parseInt(u,10),2)}`;return new Date(c+"T"+h+d)}return new Date(parseInt(e,10),parseInt(t,10)-1,parseInt(r,10),parseInt(s,10),parseInt(n,10),parseFloat(i))}class v{static makeBool(e){return j(e)}static featureValue(e,t,r,s){return N(e,t,r,s)}static equalsNull(e){return null===e}static applyLike(e,t,r){return k(e,t,r)}static ensureArray(e){return I(e)}static applyIn(e,t){return M(e,t)}static currentDate(){const e=new Date;return e.setHours(0,0,0,0),e}static makeSqlInterval(e,t,r){return u.createFromValueAndQualifer(e,t,r)}static convertInterval(e){return e instanceof u?e.valueInMilliseconds():e}static currentTimestamp(){return new Date}static compare(e,t,r){return R(e,t,r)}static calculate(e,t,r){return E(e,t,r)}static makeComparable(e){return C(e)}static evaluateFunction(e,t){return c(e,t)}static lookup(e,t){const r=t[e];return void 0===r?null:r}static between(e,t){return null==e||null==t[0]||null==t[1]?null:e>=t[0]&&e<=t[1]}static notbetween(e,t){return null==e||null==t[0]||null==t[1]?null:e<t[0]||e>t[1]}static ternaryNot(e){return S(e)}static ternaryAnd(e,t){return T(e,t)}static ternaryOr(e,t){return F(e,t)}}class x{constructor(e,t){this.fieldsIndex=t,this.datefields={},this.parameters={},this.parseTree=class{static parse(e){return d.parse(e)}}.parse(e);const{isStandardized:r,isAggregate:s,referencedFieldNames:n}=this.extractExpressionInfo(t);this.referencedFieldNames=n,this.isStandardized=r,this.isAggregate=s}static create(e,t){return new x(e,t)}get fieldNames(){return this.referencedFieldNames}testSet(e,t=P){const r={};for(const s of this.fieldNames)r[s]=e.map((e=>t.getAttribute(e,s)));return!!this.evaluateNode(this.parseTree,{attributes:r},P)}calculateValue(e,t=P){const r=this.evaluateNode(this.parseTree,e,t);return r instanceof u?r.valueInMilliseconds()/864e5:r}calculateValueCompiled(e,t=P){return null!=this.parseTree._compiledVersion?this.parseTree._compiledVersion(e,this.parameters,t,this.datefields):Object(s.a)("csp-restrictions")?this.calculateValue(e,t):(this.compileMe(),this.parseTree._compiledVersion(e,this.parameters,t,this.datefields))}testFeature(e,t=P){return!!this.evaluateNode(this.parseTree,e,t)}testFeatureCompiled(e,t=P){return null!=this.parseTree._compiledVersion?!!this.parseTree._compiledVersion(e,this.parameters,t,this.datefields):Object(s.a)("csp-restrictions")?this.testFeature(e,t):(this.compileMe(),!!this.parseTree._compiledVersion(e,this.parameters,t,this.datefields))}getFunctions(){const e=[];return this.visitAll(this.parseTree,(t=>{"function"===t.type&&e.push(t.name.toLowerCase())})),A(e)}getExpressions(){const e=new Map;return this.visitAll(this.parseTree,(t=>{if("function"===t.type){const r=t.name.toLowerCase(),s=t.args.value[0];if("column_ref"===s.type){const t=s.column,n=`${r}-${t}`;e.has(n)||e.set(n,{aggregateType:r,field:t})}}})),[...e.values()]}getVariables(){const e=[];return this.visitAll(this.parseTree,(t=>{"param"===t.type&&e.push(t.value.toLowerCase())})),A(e)}compileMe(){const e="return this.convertInterval("+this.evaluateNodeToJavaScript(this.parseTree)+")";this.parseTree._compiledVersion=new Function("feature","lookups","attributeAdapter","datefields",e).bind(v)}extractExpressionInfo(e){const t=[];let r=!0,s=!0;return this.visitAll(this.parseTree,(i=>{switch(i.type){case"column_ref":{const r=e.get(i.column),s=r&&r.name;!r||"date"!==r.type&&"esriFieldTypeDate"!==r.type||(this.datefields[r.name]=1),void 0!==s?(t.push(s),i.column=s):t.push(i.column);break}case"function":{const{name:e,args:t}=i,o=t.value.length;r&&(r=function(e,t){const r=l[e.toLowerCase()];return null!=r&&t>=r.minParams&&t<=r.maxParams}(e,o)),s&&(s=function(e,t){const r=n[e.toLowerCase()];return null!=r&&t>=r.minParams&&t<=r.maxParams}(e,o));break}}})),{referencedFieldNames:A(t),isStandardized:r,isAggregate:s}}visitAll(e,t){if(null!=e)switch(t(e),e.type){case"when_clause":this.visitAll(e.operand,t),this.visitAll(e.value,t);break;case"case_expression":for(const r of e.clauses)this.visitAll(r,t);"simple"===e.format&&this.visitAll(e.operand,t),null!==e.else&&this.visitAll(e.else,t);break;case"expr_list":for(const r of e.value)this.visitAll(r,t);break;case"unary_expr":this.visitAll(e.expr,t);break;case"binary_expr":this.visitAll(e.left,t),this.visitAll(e.right,t);break;case"function":this.visitAll(e.args,t)}}evaluateNodeToJavaScript(e){switch(e.type){case"interval":return"this.makeSqlInterval("+this.evaluateNodeToJavaScript(e.value)+", "+JSON.stringify(e.qualifier)+","+JSON.stringify(e.op)+")";case"case_expression":{let t="";if("simple"===e.format){const r="this.makeComparable("+this.evaluateNodeToJavaScript(e.operand)+")";t="( ";for(let s=0;s<e.clauses.length;s++)t+=" ("+r+" === this.makeComparable("+this.evaluateNodeToJavaScript(e.clauses[s].operand)+")) ? ("+this.evaluateNodeToJavaScript(e.clauses[s].value)+") : ";null!==e.else?t+=this.evaluateNodeToJavaScript(e.else):t+="null",t+=" )"}else{t="( ";for(let r=0;r<e.clauses.length;r++)t+=" this.makeBool("+this.evaluateNodeToJavaScript(e.clauses[r].operand)+")===true ? ("+this.evaluateNodeToJavaScript(e.clauses[r].value)+") : ";null!==e.else?t+=this.evaluateNodeToJavaScript(e.else):t+="null",t+=" )"}return t}case"param":return"this.lookup("+JSON.stringify(e.value.toLowerCase())+",lookups)";case"expr_list":{let t="[";for(const r of e.value)"["!==t&&(t+=","),t+=this.evaluateNodeToJavaScript(r);return t+="]",t}case"unary_expr":return"this.ternaryNot("+this.evaluateNodeToJavaScript(e.expr)+")";case"binary_expr":switch(e.operator){case"AND":return"this.ternaryAnd("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"OR":return"this.ternaryOr("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+" )";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return"this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return"(!(this.equalsNull("+this.evaluateNodeToJavaScript(e.left)+")))";case"IN":return"this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+"))";case"NOT IN":return"this.ternaryNot(this.applyIn("+this.evaluateNodeToJavaScript(e.left)+",this.ensureArray("+this.evaluateNodeToJavaScript(e.right)+")))";case"BETWEEN":return"this.between("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"NOTBETWEEN":return"this.notbetween("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"LIKE":return"this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+")";case"NOT LIKE":return"this.ternaryNot(this.applyLike("+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+","+JSON.stringify(e.escape)+"))";case"<>":case"<":case">":case">=":case"<=":case"=":return"this.compare("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")";case"*":case"-":case"+":case"/":return"this.calculate("+JSON.stringify(e.operator)+","+this.evaluateNodeToJavaScript(e.left)+","+this.evaluateNodeToJavaScript(e.right)+")"}throw new Error("Not Supported Operator "+e.operator);case"null":case"bool":case"string":case"number":return JSON.stringify(e.value);case"date":return"(new Date("+O(e.value).getTime().toString()+"))";case"timestamp":return"(new Date("+w(e.value).getTime().toString()+"))";case"current_time":return"date"===e.mode?"this.currentDate()":"this.currentTimestamp()";case"column_ref":return"this.featureValue(feature,"+JSON.stringify(e.column)+",datefields,attributeAdapter)";case"function":return"this.evaluateFunction("+JSON.stringify(e.name)+","+this.evaluateNodeToJavaScript(e.args)+")"}throw new Error("Unsupported sql syntax "+e.type)}evaluateNode(e,t,r){switch(e.type){case"interval":{const s=this.evaluateNode(e.value,t,r);return u.createFromValueAndQualifer(s,e.qualifier,e.op)}case"case_expression":if("simple"===e.format){const s=C(this.evaluateNode(e.operand,t,r));for(let n=0;n<e.clauses.length;n++)if(s===C(this.evaluateNode(e.clauses[n].operand,t,r)))return this.evaluateNode(e.clauses[n].value,t,r);if(null!==e.else)return this.evaluateNode(e.else,t,r)}else{for(let s=0;s<e.clauses.length;s++)if(j(this.evaluateNode(e.clauses[s].operand,t,r)))return this.evaluateNode(e.clauses[s].value,t,r);if(null!==e.else)return this.evaluateNode(e.else,t,r)}return null;case"param":return this.parameters[e.value.toLowerCase()];case"expr_list":{const s=[];for(const n of e.value)s.push(this.evaluateNode(n,t,r));return s}case"unary_expr":return S(this.evaluateNode(e.expr,t,r));case"binary_expr":switch(e.operator){case"AND":return T(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r));case"OR":return F(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r));case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null===this.evaluateNode(e.left,t,r);case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null!==this.evaluateNode(e.left,t,r);case"IN":{const s=I(this.evaluateNode(e.right,t,r));return M(this.evaluateNode(e.left,t,r),s)}case"NOT IN":{const s=I(this.evaluateNode(e.right,t,r));return S(M(this.evaluateNode(e.left,t,r),s))}case"BETWEEN":{const s=this.evaluateNode(e.left,t,r),n=this.evaluateNode(e.right,t,r);return null==s||null==n[0]||null==n[1]?null:s>=C(n[0])&&s<=C(n[1])}case"NOTBETWEEN":{const s=this.evaluateNode(e.left,t,r),n=this.evaluateNode(e.right,t,r);return null==s||null==n[0]||null==n[1]?null:s<C(n[0])||s>C(n[1])}case"LIKE":return k(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r),e.escape);case"NOT LIKE":return S(k(this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r),e.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return R(e.operator,this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r));case"-":case"+":case"*":case"/":return E(e.operator,this.evaluateNode(e.left,t,r),this.evaluateNode(e.right,t,r))}case"null":case"bool":case"string":case"number":return e.value;case"date":return O(e.value);case"timestamp":return w(e.value);case"current_time":{const t=new Date;return"date"===e.mode&&t.setHours(0,0,0,0),t}case"column_ref":return N(t,e.column,this.datefields,r);case"function":{const s=this.evaluateNode(e.args,t,r);return this.isAggregate?function(e,t){const r=n[e.toLowerCase()];if(null==r)throw new Error("Function Not Recognised");if(t.length<r.minParams||t.length>r.maxParams)throw new Error(`Invalid Parameter count for call to ${e.toUpperCase()}`);return r.evaluate(t)}(e.name,s):c(e.name,s)}}throw new Error("Unsupported sql syntax "+e.type)}}function w(e){let t=p.exec(e);if(null!==t){const[,e,r,s,n,i,o]=t;return _(e,r,s,n,i,o)}if(t=g.exec(e),null!==t){const[,e,r,s,n,i,o,a,u,c]=t;return _(e,r,s,n,i,o,a,u,c)}if(t=m.exec(e),null!==t){const[,e,r,s,n,i,o,a,u]=t;return _(e,r,s,n,i,"0",o,a,u)}if(t=y.exec(e),null!==t){const[,e,r,s,n,i]=t;return _(e,r,s,n,i)}if(t=f.exec(e),null!==t){const[,e,r,s]=t;return _(e,r,s)}throw new Error("SQL Invalid Timestamp")}function O(e){const t=f.exec(e);if(null===t)throw new Error("SQL Invalid Date");const[,r,s,n]=t;return new Date(parseInt(r,10),parseInt(s,10)-1,parseInt(n,10))}function j(e){return!0===e}function I(e){return Array.isArray(e)?e:[e]}function S(e){return null!==e?!0!==e:null}function T(e,t){return null!=e&&null!=t?!0===e&&!0===t:!1!==e&&!1!==t&&null}function F(e,t){return null!=e&&null!=t?!0===e||!0===t:!0===e||!0===t||null}function M(e,t){if(null==e)return null;let r=!1;for(const s of t)if(null==s)r=null;else if(e===s){r=!0;break}return r}function k(e,t,r){if(null==e)return null;const s=t,n=r;let i="";const o="-[]/{}()*+?.\\^$|";let a=0;for(let u=0;u<s.length;u++){const e=s.charAt(u);switch(a){case 0:e===n?a=1:o.indexOf(e)>=0?i+="\\"+e:i+="%"===e?".*":"_"===e?".":e;break;case 1:o.indexOf(e)>=0?i+="\\"+e:i+=e,a=0}}return new RegExp("^"+i+"$").test(e)}function C(e){return e instanceof Date?e.valueOf():e}function R(e,t,r){if(null==t||null==r)return null;const s=C(t),n=C(r);switch(e){case"<>":return s!==n;case"=":return s===n;case">":return s>n;case"<":return s<n;case">=":return s>=n;case"<=":return s<=n}}function A(e){const t=[],r={};for(const s of e){const e=s.toLowerCase();void 0===r[e]&&(t.push(s),r[e]=1)}return t}function E(e,t,r){if(t instanceof u)if(r instanceof Date)switch(e){case"+":return new Date(t.valueInMilliseconds()+r.getTime());case"-":return t.valueInMilliseconds()-r.getTime();case"*":return t.valueInMilliseconds()*r.getTime();case"/":return t.valueInMilliseconds()/r.getTime()}else if(r instanceof u)switch(e){case"+":return u.createFromMilliseconds(t.valueInMilliseconds()+r.valueInMilliseconds());case"-":return u.createFromMilliseconds(t.valueInMilliseconds()-r.valueInMilliseconds());case"*":return t.valueInMilliseconds()*r.valueInMilliseconds();case"/":return t.valueInMilliseconds()/r.valueInMilliseconds()}else t=t.valueInMilliseconds();else if(r instanceof u)if(t instanceof Date)switch(e){case"+":return new Date(r.valueInMilliseconds()+t.getTime());case"-":return new Date(t.getTime()-r.valueInMilliseconds());case"*":return t.getTime()*r.valueInMilliseconds();case"/":return t.getTime()/r.valueInMilliseconds()}else r=r.valueInMilliseconds();else if(t instanceof Date&&"number"==typeof r)switch(r=24*r*60*60*1e3,t=t.getTime(),e){case"+":return new Date(t+r);case"-":return new Date(t-r);case"*":return new Date(t*r);case"/":return new Date(t/r)}else if(r instanceof Date&&"number"==typeof t)switch(t=24*t*60*60*1e3,r=r.getTime(),e){case"+":return new Date(t+r);case"-":return new Date(t-r);case"*":return new Date(t*r);case"/":return new Date(t/r)}switch(e){case"+":return t+r;case"-":return t-r;case"*":return t*r;case"/":return t/r}}function N(e,t,r,s){const n=s.getAttribute(e,t);return null!=n&&1===r[t]?new Date(n):n}const P={getAttribute:(e,t)=>(function(e){return e&&"object"==typeof e.attributes}(e)?e.attributes:e)[t]}},276:function(e,t,r){"use strict";r.d(t,"a",(function(){return T})),r.d(t,"b",(function(){return f})),r.d(t,"c",(function(){return m})),r.d(t,"d",(function(){return n})),r.d(t,"e",(function(){return w})),r.d(t,"f",(function(){return S})),r.d(t,"g",(function(){return o})),r.d(t,"h",(function(){return u})),r.d(t,"i",(function(){return c})),r.d(t,"j",(function(){return a})),r.d(t,"k",(function(){return O})),r.d(t,"l",(function(){return i})),r.d(t,"m",(function(){return b})),r.d(t,"n",(function(){return I})),r.d(t,"o",(function(){return g})),r.d(t,"p",(function(){return y})),r.d(t,"q",(function(){return x})),r.d(t,"r",(function(){return v})),r.d(t,"s",(function(){return _})),r.d(t,"t",(function(){return p}));var s=r(88);r(101),r(122);function n(e=F){return[e[0],e[1],e[2],e[3],e[4],e[5]]}function i(e,t,r,s,i,o,a=n()){return a[0]=e,a[1]=t,a[2]=r,a[3]=s,a[4]=i,a[5]=o,a}function o(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.min(e[2],t[2]),e[3]=Math.max(e[3],t[3]),e[4]=Math.max(e[4],t[4]),e[5]=Math.max(e[5],t[5])}function a(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.min(e[2],t[2]),e[3]=Math.max(e[3],t[0]),e[4]=Math.max(e[4],t[1]),e[5]=Math.max(e[5],t[2])}function u(e,t,r=0,s=t.length/3){let n=e[0],i=e[1],o=e[2],a=e[3],u=e[4],c=e[5];for(let l=0;l<s;l++)n=Math.min(n,t[r+3*l]),i=Math.min(i,t[r+3*l+1]),o=Math.min(o,t[r+3*l+2]),a=Math.max(a,t[r+3*l]),u=Math.max(u,t[r+3*l+1]),c=Math.max(c,t[r+3*l+2]);e[0]=n,e[1]=i,e[2]=o,e[3]=a,e[4]=u,e[5]=c}function c(e,t,r){const s=t.length;let n=e[0],i=e[1],o=e[2],a=e[3],u=e[4],c=e[5];if(r)for(let l=0;l<s;l++){const e=t[l];n=Math.min(n,e[0]),i=Math.min(i,e[1]),o=Math.min(o,e[2]),a=Math.max(a,e[0]),u=Math.max(u,e[1]),c=Math.max(c,e[2])}else for(let l=0;l<s;l++){const e=t[l];n=Math.min(n,e[0]),i=Math.min(i,e[1]),a=Math.max(a,e[0]),u=Math.max(u,e[1])}e[0]=n,e[1]=i,e[2]=o,e[3]=a,e[4]=u,e[5]=c}function l(e){return e[0]>=e[3]?0:e[3]-e[0]}function h(e){return e[1]>=e[4]?0:e[4]-e[1]}function d(e){return e[2]>=e[5]?0:e[5]-e[2]}function f(e,t=[0,0,0]){return t[0]=e[0]+l(e)/2,t[1]=e[1]+h(e)/2,t[2]=e[2]+d(e)/2,t}function p(e,t=[0,0,0]){return t[0]=l(e),t[1]=h(e),t[2]=d(e),t}function g(e){return Math.max(l(e),d(e),h(e))}function m(e,t){return t[0]>=e[0]&&t[1]>=e[1]&&t[2]>=e[2]&&t[0]<=e[3]&&t[1]<=e[4]&&t[2]<=e[5]}function y(e,t,r=e){const s=e[0]+l(e)/2,n=e[1]+h(e)/2,i=e[2]+d(e)/2;return r[0]=s+(e[0]-s)*t,r[1]=n+(e[1]-n)*t,r[2]=i+(e[2]-i)*t,r[3]=s+(e[3]-s)*t,r[4]=n+(e[4]-n)*t,r[5]=i+(e[5]-i)*t,r}function b(e,t){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function _(e,t,r=e){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r!==e&&(r[3]=e[3],r[4]=e[4],r[5]=e[5]),r}function v(e,t,r=e){return r[3]=t[0],r[4]=t[1],r[5]=t[2],r!==e&&(r[0]=e[0],r[1]=e[1],r[2]=e[2]),e}function x(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function w(e){return e?x(e,T):n(T)}function O(e,t){return e[0]=t[0],e[1]=t[1],e[2]=Number.NEGATIVE_INFINITY,e[3]=t[2],e[4]=t[3],e[5]=Number.POSITIVE_INFINITY,e}function j(e){return 6===e.length}function I(e){return 0===l(e)&&0===h(e)&&0===d(e)}function S(e,t,r){if(Object(s.j)(e)||Object(s.j)(t))return e===t;if(!j(e)||!j(t))return!1;if(r){for(let s=0;s<e.length;s++)if(!r(e[s],t[s]))return!1}else for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0}const T=[1/0,1/0,1/0,-1/0,-1/0,-1/0],F=[0,0,0,0,0,0];n()},279:function(e,t,r){"use strict";r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return o})),r.d(t,"c",(function(){return i})),r.d(t,"d",(function(){return a})),r.d(t,"e",(function(){return u})),r.d(t,"f",(function(){return l})),r.d(t,"g",(function(){return c}));const s=[252,146,31,255],n={type:"esriSMS",style:"esriSMSCircle",size:6,color:s,outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[153,153,153,255]}},i={type:"esriSLS",style:"esriSLSSolid",width:.75,color:s},o={type:"esriSFS",style:"esriSFSSolid",color:[252,146,31,196],outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[255,255,255,191]}},a={type:"esriTS",color:[255,255,255,255],font:{family:"arial-unicode-ms",size:10,weight:"bold"},horizontalAlignment:"center",kerning:!0,haloColor:[0,0,0,255],haloSize:1,rotated:!1,text:"",xoffset:0,yoffset:0,angle:0},u={type:"esriSMS",style:"esriSMSCircle",color:[0,0,0,255],outline:null,size:10.5},c={type:"esriSLS",style:"esriSLSSolid",color:[0,0,0,255],width:1.5},l={type:"esriSFS",style:"esriSFSSolid",color:[0,0,0,255],outline:null}},289:function(e,t,r){"use strict";class s{constructor(e=null,t={},r,s){this.displayId=0,this.geohashX=0,this.geohashY=0,this.geometry=e,t&&(this.attributes=t),r&&(this.centroid=r),null!=s&&(this.objectId=s)}get hasGeometry(){return!(!this.geometry||!this.geometry.coords||!this.geometry.coords.length)}weakClone(){const e=new s(this.geometry,this.attributes,this.centroid,this.objectId);return e.displayId=this.displayId,e.geohashX=this.geohashX,e.geohashY=this.geohashY,e}}t.a=s},294:function(e,t,r){"use strict";r.d(t,"a",(function(){return f}));var s=r(81),n=r(88),i=r(237),o=r(84),a=r(83),u=r(238),c=r(341),l=r(95),h=r(113),d=r(106);let f=class extends l.a{constructor(){super(...arguments),this.updating=!1,this.handleId=0,this.handles=new h.a,this.scheduleHandleId=0,this.pendingPromises=new Set}destroy(){this.removeAll(),this.handles.destroy()}add(e,t,r,s=0){const n=0!=(1&s),i=++this.handleId;n||this.installSyncUpdatingWatch(e,t,i);const o=0!=(2&s)?Object(d.a)(e,t,r,n):e.watch(t,r,n);return this.handles.add(o,i),{remove:()=>{this.handles.remove(i)}}}addOnCollectionPropertyChange(e,t,r,s=0){const n=0!=(2&s),i=++this.handleId;return this.handles.add([Object(d.b)(e,t,"after-changes",this.createSyncUpdatingCallback()),Object(d.b)(e,t,"change",r,n?e=>{r({added:e.items,removed:[],moved:[],target:e})}:void 0)],i),{remove:()=>{this.handles.remove(i)}}}addOnCollectionChange(e,t,r=0){const s=0!=(2&r),n=++this.handleId;return this.handles.add([e.on("after-changes",this.createSyncUpdatingCallback()),e.on("change",t)],n),s&&t({added:e.items,removed:[],moved:[],target:e}),{remove:()=>{this.handles.remove(n)}}}addPromise(e){if(Object(n.j)(e))return e;const t=++this.handleId;this.handles.add({remove:()=>{this.pendingPromises.delete(e)&&(0!==this.pendingPromises.size||this.handles.has(p)||this._set("updating",!1))}},t),this.pendingPromises.add(e),this._set("updating",!0);const r=()=>this.handles.remove(t);return e.then(r,r),e}removeAll(){this.pendingPromises.clear(),this.handles.removeAll(),this._set("updating",!1)}installSyncUpdatingWatch(e,t,r){const s=this.createSyncUpdatingCallback(),n=Object(c.a)((()=>Object(i.c)(e,t)),s);return this.handles.add(n,r),n}createSyncUpdatingCallback(){return()=>{this.handles.remove(p),++this.scheduleHandleId;const e=this.scheduleHandleId;this._get("updating")||this._set("updating",!0),this.handles.add(Object(u.b)((()=>{e===this.scheduleHandleId&&(this._set("updating",this.pendingPromises.size>0),this.handles.remove(p))})),p)}}};Object(s.a)([Object(o.b)({readOnly:!0})],f.prototype,"updating",void 0),f=Object(s.a)([Object(a.a)("esri.views.support.WatchUpdatingTracking")],f);const p=-42},308:function(e,t,r){"use strict";r.d(t,"a",(function(){return _})),r.d(t,"b",(function(){return m})),r.d(t,"c",(function(){return a})),r.d(t,"d",(function(){return v})),r.d(t,"e",(function(){return x})),r.d(t,"f",(function(){return w})),r.d(t,"g",(function(){return O}));var s=r(98);const n=(e,t,r)=>[t,r],i=(e,t,r)=>[t,r,e[2]],o=(e,t,r)=>[t,r,e[2],e[3]];function a(e){return e?{originPosition:"upper-left"===e.originPosition?"upperLeft":"lower-left"===e.originPosition?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance]:[1,1],translate:e.extent?[e.extent.xmin,e.extent.ymax]:[0,0]}:null}function u({scale:e,translate:t},r){return Math.round((r-t[0])/e[0])}function c({scale:e,translate:t},r){return Math.round((t[1]-r)/e[1])}function l(e,t,r){const s=[];let n,i,o,a;for(let l=0;l<r.length;l++){const h=r[l];l>0?(o=u(e,h[0]),a=c(e,h[1]),o===n&&a===i||(s.push(t(h,o-n,a-i)),n=o,i=a)):(n=u(e,h[0]),i=c(e,h[1]),s.push(t(h,n,i)))}return s.length>0?s:null}function h({scale:e,translate:t},r){return r*e[0]+t[0]}function d({scale:e,translate:t},r){return t[1]-r*e[1]}function f(e,t,r){const s=new Array(r.length);if(!r.length)return s;const[n,i]=e.scale;let o=h(e,r[0][0]),a=d(e,r[0][1]);s[0]=t(r[0],o,a);for(let u=1;u<r.length;u++){const e=r[u];o+=e[0]*n,a-=e[1]*i,s[u]=t(e,o,a)}return s}function p(e,t,r){const s=new Array(r.length);for(let n=0;n<r.length;n++)s[n]=f(e,t,r[n]);return s}function g(e,t,r,s,a){return t.points=function(e,t,r,s){return l(e,r?s?o:i:s?i:n,t)}(e,r.points,s,a),t}function m(e,t,r,s,n){return t.x=u(e,r.x),t.y=c(e,r.y),t!==r&&(s&&(t.z=r.z),n&&(t.m=r.m)),t}function y(e,t,r,s,a){const u=function(e,t,r,s){const a=[],u=r?s?o:i:s?i:n;for(let n=0;n<t.length;n++){const r=l(e,u,t[n]);r&&r.length>=3&&a.push(r)}return a.length?a:null}(e,r.rings,s,a);return u?(t.rings=u,t):null}function b(e,t,r,s,a){const u=function(e,t,r,s){const a=[],u=r?s?o:i:s?i:n;for(let n=0;n<t.length;n++){const r=l(e,u,t[n]);r&&r.length>=2&&a.push(r)}return a.length?a:null}(e,r.paths,s,a);return u?(t.paths=u,t):null}function _(e,t){return e&&t?Object(s.f)(t)?m(e,{},t,!1,!1):Object(s.h)(t)?b(e,{},t,!1,!1):Object(s.g)(t)?y(e,{},t,!1,!1):Object(s.e)(t)?g(e,{},t,!1,!1):Object(s.d)(t)?(o=!1,a=!1,(n={}).xmin=u(r=e,(i=t).xmin),n.ymin=c(r,i.ymin),n.xmax=u(r,i.xmax),n.ymax=c(r,i.ymax),n!==i&&(o&&(n.zmin=i.zmin,n.zmax=i.zmax),a&&(n.mmin=i.mmin,n.mmax=i.mmax)),n):null:null;var r,n,i,o,a}function v(e,t,r,s,a){return t.points=function(e,t,r,s){return f(e,r?s?o:i:s?i:n,t)}(e,r.points,s,a),t}function x(e,t,r,s,n){return t.x=h(e,r.x),t.y=d(e,r.y),t!==r&&(s&&(t.z=r.z),n&&(t.m=r.m)),t}function w(e,t,r,s,a){return t.rings=function(e,t,r,s){return p(e,r?s?o:i:s?i:n,t)}(e,r.rings,s,a),t}function O(e,t,r,s,a){return t.paths=function(e,t,r,s){return p(e,r?s?o:i:s?i:n,t)}(e,r.paths,s,a),t}},313:function(e,t,r){"use strict";class s{constructor(){this.objectIdFieldName=null,this.globalIdFieldName=null,this.geohashFieldName=null,this.geometryProperties=null,this.geometryType=null,this.spatialReference=null,this.hasZ=!1,this.hasM=!1,this.features=[],this.fields=[],this.transform=null,this.exceededTransferLimit=!1,this.uniqueIdField=null,this.queryGeometryType=null,this.queryGeometry=null}weakClone(){const e=new s;return e.objectIdFieldName=this.objectIdFieldName,e.globalIdFieldName=this.globalIdFieldName,e.geohashFieldName=this.geohashFieldName,e.geometryProperties=this.geometryProperties,e.geometryType=this.geometryType,e.spatialReference=this.spatialReference,e.hasZ=this.hasZ,e.hasM=this.hasM,e.features=this.features,e.fields=this.fields,e.transform=this.transform,e.exceededTransferLimit=this.exceededTransferLimit,e.uniqueIdField=this.uniqueIdField,e.queryGeometry=this.queryGeometry,e.queryGeometryType=this.queryGeometryType,e}}t.a=s},314:function(e,t,r){"use strict";r.d(t,"a",(function(){return g})),r.d(t,"b",(function(){return f})),r.d(t,"c",(function(){return p}));var s=r(88),n=r(123),i=r(95),o=r(105);const a=["esri.Color","esri.portal.Portal","esri.symbols.support.Symbol3DAnchorPosition2D","esri.symbols.support.Symbol3DAnchorPosition3D"];function u(e){return e instanceof i.a}function c(e){return e instanceof o.a?Object.keys(e.items):u(e)?Object(n.a)(e).keys():e?Object.keys(e):[]}function l(e,t){return e instanceof o.a?e.items[t]:e[t]}function h(e){return e?e.declaredClass:null}function d(e,t){const r=e.diff;if(r&&"function"==typeof r)return r(e,t);const n=c(e),i=c(t);if(0===n.length&&0===i.length)return;if(!n.length||!i.length||function(e,t){return!(!Array.isArray(e)||!Array.isArray(t))&&e.length!==t.length}(e,t))return{type:"complete",oldValue:e,newValue:t};const o=i.filter((e=>-1===n.indexOf(e))),f=n.filter((e=>-1===i.indexOf(e))),p=n.filter((r=>i.indexOf(r)>-1&&l(e,r)!==l(t,r))).concat(o,f).sort(),g=h(e);if(g&&a.indexOf(g)>-1&&p.length)return{type:"complete",oldValue:e,newValue:t};let m;const y=u(e)&&u(t);for(const a of p){const n=l(e,a),i=l(t,a);let o;(y||"function"!=typeof n&&"function"!=typeof i)&&n!==i&&(null==n&&null==i||(o=r&&r[a]&&"function"==typeof r[a]?r[a](n,i):"object"==typeof n&&"object"==typeof i&&h(n)===h(i)?d(n,i):{type:"complete",oldValue:n,newValue:i},Object(s.k)(o)&&(Object(s.k)(m)?m.diff[a]=o:m={type:"partial",diff:{[a]:o}})))}return m}function f(e,t){if(Object(s.j)(e))return!1;const r=t.split(".");let n=e;for(const s of r){if("complete"===n.type)return!0;if("partial"!==n.type)return!1;{const e=n.diff[s];if(!e)return!1;n=e}}return!0}function p(e,t){for(const r of t)if(f(e,r))return!0;return!1}function g(e,t){if("function"!=typeof e&&"function"!=typeof t&&(e||t))return!e||!t||"object"==typeof e&&"object"==typeof t&&h(e)!==h(t)?{type:"complete",oldValue:e,newValue:t}:d(e,t)}},333:function(e,t,r){"use strict";var s,n=r(81),i=(r(79),r(80),r(87)),o=r(84),a=r(93),u=r(96),c=r(83),l=r(94),h=(r(82),r(85),r(86),r(89)),d=r(110),f=r(97),p=r(158),g=r(111),m=(r(99),r(115)),y=r(122),b=r(457);const _=new a.a({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"});let v=s=class extends h.a{constructor(e){super(e),this.dpi=96,this.format=null,this.origin=null,this.minScale=0,this.maxScale=0,this.size=null,this.spatialReference=null}static create(e={size:256,spatialReference:f.a.WebMercator}){const t=e.resolutionFactor||1,r=e.scales,n=e.size||256,i=e.spatialReference||f.a.WebMercator;if(!Object(d.i)(i)){const e=[];if(r)for(let t=0;t<r.length;t++){const s=r[t];e.push({level:t,scale:s,resolution:s})}else{let t=5e-4;for(let r=23;r>=0;r--)e.unshift({level:r,scale:t,resolution:t}),t*=2}return new s({dpi:96,lods:e,origin:new g.a(0,0,i),size:[n,n],spatialReference:i})}const o=Object(d.d)(i),a=e.origin?new g.a({x:e.origin.x,y:e.origin.y,spatialReference:i}):new g.a(o?{x:o.origin[0],y:o.origin[1],spatialReference:i}:{x:0,y:0,spatialReference:i}),u=1/(39.37*Object(m.f)(i)*96),c=[];if(r)for(let s=0;s<r.length;s++){const e=r[s],t=e*u;c.push({level:s,scale:e,resolution:t})}else{let e=Object(d.f)(i)?512/n*591657527.5917094:256/n*591657527.591555;const r=Math.ceil(24/t);c.push({level:0,scale:e,resolution:e*u});for(let s=1;s<r;s++){const r=e/2**t,n=r*u;c.push({level:s,scale:r,resolution:n}),e=r}}return new s({dpi:96,lods:c,origin:a,size:[n,n],spatialReference:i})}get isWrappable(){const{spatialReference:e,origin:t}=this;if(e&&t){const r=Object(d.d)(e);return e.isWrappable&&Math.abs(r.origin[0]-t.x)<=r.dx}return!1}readOrigin(e,t){return g.a.fromJSON({spatialReference:t.spatialReference,...e})}set lods(e){let t=0,r=0;const s=[];this._levelToLOD={},e&&(t=-1/0,r=1/0,e.forEach((e=>{s.push(e.scale),t=e.scale>t?e.scale:t,r=e.scale<r?e.scale:r,this._levelToLOD[e.level]=e}))),this._set("scales",s),this._set("minScale",t),this._set("maxScale",r),this._set("lods",e),this._initializeUpsampleLevels()}readSize(e,t){return[t.cols,t.rows]}writeSize(e,t){t.cols=e[0],t.rows=e[0]}zoomToScale(e){const t=this.scales;if(e<=0)return t[0];if(e>=t.length)return t[t.length-1];{const r=Math.round(e-.5),s=Math.round(e);return t[s]+(s-e)*(t[r]-t[s])}}scaleToZoom(e){const t=this.scales,r=t.length-1;let s=0;for(;s<r;s++){const r=t[s],n=t[s+1];if(r<=e)return s;if(n===e)return s+1;if(r>e&&n<e)return s+1-(e-n)/(r-n)}return s}snapScale(e,t=.95){const r=this.scaleToZoom(e);return r%Math.floor(r)>=t?this.zoomToScale(Math.ceil(r)):this.zoomToScale(Math.floor(r))}tileAt(e,t,r,s){const n=this.lodAt(e);if(!n)return null;let i,o;if("number"==typeof t)i=t,o=r;else if(Object(d.c)(t.spatialReference,this.spatialReference))i=t.x,o=t.y,s=r;else{const e=Object(p.d)(t,this.spatialReference);if(!e)return null;i=e.x,o=e.y,s=r}const a=n.resolution*this.size[0],u=n.resolution*this.size[1];return s||(s={id:null,level:0,row:0,col:0,extent:Object(y.i)()}),s.level=e,s.row=Math.floor((this.origin.y-o)/u+.001),s.col=Math.floor((i-this.origin.x)/a+.001),this.updateTileInfo(s),s}updateTileInfo(e,t=0){let r=this.lodAt(e.level);if(!r&&1===t){const t=this.lods[this.lods.length-1];t.level<e.level&&(r=t)}if(!r)return;const s=e.level-r.level,n=r.resolution*this.size[0]/2**s,i=r.resolution*this.size[1]/2**s;e.id=`${e.level}/${e.row}/${e.col}`,e.extent||(e.extent=Object(y.i)()),e.extent[0]=this.origin.x+e.col*n,e.extent[1]=this.origin.y-(e.row+1)*i,e.extent[2]=e.extent[0]+n,e.extent[3]=e.extent[1]+i}upsampleTile(e){const t=this._upsampleLevels[e.level];return!(!t||-1===t.parentLevel)&&(e.level=t.parentLevel,e.row=Math.floor(e.row/t.factor+.001),e.col=Math.floor(e.col/t.factor+.001),this.updateTileInfo(e),!0)}getTileBounds(e,t){const{resolution:r}=this.lodAt(t.level),s=r*this.size[0],n=r*this.size[1];return e[0]=this.origin.x+t.col*s,e[1]=this.origin.y-(t.row+1)*n,e[2]=e[0]+s,e[3]=e[1]+n,e}lodAt(e){return this._levelToLOD&&this._levelToLOD[e]||null}clone(){return s.fromJSON(this.write({}))}_initializeUpsampleLevels(){const e=this.lods;this._upsampleLevels=[];let t=null;for(let r=0;r<e.length;r++){const s=e[r];this._upsampleLevels[s.level]={parentLevel:t?t.level:-1,factor:t?t.resolution/s.resolution:0},t=s}}};Object(n.a)([Object(o.b)({type:Number,json:{write:!0}})],v.prototype,"compressionQuality",void 0),Object(n.a)([Object(o.b)({type:Number,json:{write:!0}})],v.prototype,"dpi",void 0),Object(n.a)([Object(o.b)({type:String,json:{read:_.read,write:_.write,origins:{"web-scene":{read:!1,write:!1}}}})],v.prototype,"format",void 0),Object(n.a)([Object(o.b)({readOnly:!0})],v.prototype,"isWrappable",null),Object(n.a)([Object(o.b)({type:g.a,json:{write:!0}})],v.prototype,"origin",void 0),Object(n.a)([Object(u.a)("origin")],v.prototype,"readOrigin",null),Object(n.a)([Object(o.b)({type:[b.a],value:null,json:{write:!0}})],v.prototype,"lods",null),Object(n.a)([Object(o.b)({readOnly:!0})],v.prototype,"minScale",void 0),Object(n.a)([Object(o.b)({readOnly:!0})],v.prototype,"maxScale",void 0),Object(n.a)([Object(o.b)({readOnly:!0})],v.prototype,"scales",void 0),Object(n.a)([Object(o.b)({cast:e=>Array.isArray(e)?e:"number"==typeof e?[e,e]:[256,256]})],v.prototype,"size",void 0),Object(n.a)([Object(u.a)("size",["rows","cols"])],v.prototype,"readSize",null),Object(n.a)([Object(l.a)("size",{cols:{type:i.a},rows:{type:i.a}})],v.prototype,"writeSize",null),Object(n.a)([Object(o.b)({type:f.a,json:{write:!0}})],v.prototype,"spatialReference",void 0),v=s=Object(n.a)([Object(c.a)("esri.layers.support.TileInfo")],v);var x=v;t.a=x},359:function(e,t,r){"use strict";var s=r(79),n=r(218);const i=4294967296,o=Object(s.a)("esri-text-decoder")?new TextDecoder("utf-8"):null,a=Object(s.a)("safari")||Object(s.a)("ios")?6:Object(s.a)("ff")?12:32;class u{constructor(e,t,r=0,s=(e?e.byteLength:0)){this._tag=0,this._dataType=99,this.init(e,t,r,s)}init(e,t,r,s){this._data=e,this._dataView=t,this._pos=r,this._end=s}clone(){return new u(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(e){this._pos=e}nextTag(e){for(;;){if(this._pos===this._end)return!1;const t=this._decodeVarint();if(this._tag=t>>3,this._dataType=7&t,!e||e===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const e=this._decodeVarint();return this._tag=e>>3,this._dataType=7&e,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let e=4294967295;return e=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128?e:(e=(e|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128?e:(e=(e|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128?e:(e=(e|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128?e:(e=(e|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128?e:void 0))))}getUInt64(){return this._decodeVarint()}getSInt32(){const e=this.getUInt32();return e>>>1^-(1&e)|0}getSInt64(){return this._decodeSVarint()}getBool(){const e=0!==this._data[this._pos];return this._skip(1),e}getEnum(){return this._decodeVarint()}getFixed64(){const e=this._dataView,t=this._pos,r=e.getUint32(t,!0)+e.getUint32(t+4,!0)*i;return this._skip(8),r}getSFixed64(){const e=this._dataView,t=this._pos,r=e.getUint32(t,!0)+e.getInt32(t+4,!0)*i;return this._skip(8),r}getDouble(){const e=this._dataView.getFloat64(this._pos,!0);return this._skip(8),e}getFixed32(){const e=this._dataView.getUint32(this._pos,!0);return this._skip(4),e}getSFixed32(){const e=this._dataView.getInt32(this._pos,!0);return this._skip(4),e}getFloat(){const e=this._dataView.getFloat32(this._pos,!0);return this._skip(4),e}getString(){const e=this._getLength(),t=this._pos,r=this._toString(this._data,t,t+e);return this._skip(e),r}getBytes(){const e=this._getLength(),t=this._pos,r=this._toBytes(this._data,t,t+e);return this._skip(e),r}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(e,t,r,s){const n=this.getMessage(),i=e(n,t,r,s);return n.release(),i}processMessage(e){const t=this.getMessage(),r=e(t);return t.release(),r}getMessage(){const e=this._getLength(),t=u.pool.acquire();return t.init(this._data,this._dataView,this._pos,this._pos+e),this._skip(e),t}release(){u.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case 0:this._decodeVarint();break;case 1:this._skip(8);break;case 2:this._skip(this._getLength());break;case 5:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(e){this._skip(e)}_skip(e){if(this._pos+e>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=e}_decodeVarint(){const e=this._data;let t,r=this._pos,s=0;if(this._end-r>=10)do{if(t=e[r++],s|=127&t,0==(128&t))break;if(t=e[r++],s|=(127&t)<<7,0==(128&t))break;if(t=e[r++],s|=(127&t)<<14,0==(128&t))break;if(t=e[r++],s|=(127&t)<<21,0==(128&t))break;if(t=e[r++],s+=268435456*(127&t),0==(128&t))break;if(t=e[r++],s+=34359738368*(127&t),0==(128&t))break;if(t=e[r++],s+=4398046511104*(127&t),0==(128&t))break;if(t=e[r++],s+=562949953421312*(127&t),0==(128&t))break;if(t=e[r++],s+=72057594037927940*(127&t),0==(128&t))break;if(t=e[r++],s+=0x8000000000000000*(127&t),0==(128&t))break;throw new Error("Varint too long!")}while(0);else{let n=1;for(;r!==this._end&&(t=e[r],0!=(128&t));)++r,s+=(127&t)*n,n*=128;if(r===this._end)throw new Error("Varint overrun!");++r,s+=t*n}return this._pos=r,s}_decodeSVarint(){const e=this._decodeVarint();return e%2?-(e+1)/2:e/2}_getLength(){if(2!==this._dataType)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(e,t,r){if((r=Math.min(this._end,r))-t>a&&o){const s=e.subarray(t,r);return o.decode(s)}let s="",n="";for(let i=t;i<r;++i){const t=e[i];128&t?n+="%"+t.toString(16):(s+=decodeURIComponent(n)+String.fromCharCode(t),n="")}return n.length&&(s+=decodeURIComponent(n)),s}_toBytes(e,t,r){return r=Math.min(this._end,r),new Uint8Array(e.buffer,t,r-t)}}u.pool=new n.a(u,null,(e=>{e._data=null,e._dataView=null})),t.a=u},363:function(e,t,r){"use strict";r.d(t,"b",(function(){return b})),r.d(t,"c",(function(){return _}));var s=r(79),n=r(88),i=r(80),o=r(91),a=r(92),u=r(108),c=r(314),l=r(204),h=r(119),d=r(148),f=r(426),p=r(517);const g=i.a.getLogger("esri.views.layers.2d.features.support.AttributeStore"),m=Object(f.b)(f.a,g),y=e=>(2147483648&e)>>>31,b=e=>2147483647&e;function _(e){return 1===y(e)}const v={sharedArrayBuffer:Object(s.a)("esri-shared-array-buffer"),atomics:Object(s.a)("esri-atomics")};function x(e,t){return r=>t(e(r))}class w{constructor(e,t,r,s){this.size=0,this.texelSize=4;const{pixelType:n,layout:i,textureOnly:o}=s;this.textureOnly=o||!1,this.pixelType=n,this._ctype=t,this.layout=i,this._resetRange(),this._shared=e,this.size=r,o||(this.data=this._initData(n,r,e,t))}get buffer(){return Object(n.b)(this.data,(e=>e.buffer))}unsetComponentAllTexels(e,t){const r=Object(n.q)(this.data);for(let s=0;s<this.size*this.size;s++)r[s*this.texelSize+e]&=~t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(e,t){const r=Object(n.q)(this.data);for(let s=0;s<this.size*this.size;s++)r[s*this.texelSize+e]|=255&t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(e,t,r){const s=Object(n.q)(this.data);for(const n of r)s[n*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,n),this.dirtyEnd=Math.max(this.dirtyEnd,n)}setComponentTexel(e,t,r){Object(n.q)(this.data)[r*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}unsetComponentTexel(e,t,r){Object(n.q)(this.data)[r*this.texelSize+e]&=~t,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r)}getData(e,t){const r=b(e);return Object(n.q)(this.data)[r*this.texelSize+t]}setData(e,t,r){const s=b(e),n=1<<t;0!=(this.layout&n)?(this.data[s*this.texelSize+t]=r,this.dirtyStart=Math.min(this.dirtyStart,s),this.dirtyEnd=Math.max(this.dirtyEnd,s)):g.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}lock(){5121===this.pixelType&&this._shared&&v.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}unlock(){5121===this.pixelType&&this._shared&&v.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}expand(e){if(this.size=e,!this.textureOnly){const t=this._initData(this.pixelType,e,this._shared,this._ctype),r=Object(n.q)(this.data);t.set(r),this.data=t}}toMessage(){const e=this.dirtyStart,t=this.dirtyEnd,r=this.texelSize;if(e>t)return null;this._resetRange();const s=!(this._shared||"local"===this._ctype),i=this.pixelType,o=this.layout,a=Object(n.q)(this.data);return a.slice?{start:e,end:t,data:s&&a.slice(e*r,(t+1)*r)||null,pixelType:i,layout:o}:s?{start:e,end:t,data:new(Object(d.j)(this.pixelType))(Array.prototype.slice.call(this.data,e*r,(t+1)*r)),pixelType:i,layout:o}:{start:e,end:t,data:null,pixelType:i,layout:o}}_initData(e,t,r,s){const n=r&&"local"!==s?SharedArrayBuffer:ArrayBuffer,i=Object(d.j)(e),o=new i(new n(t*t*4*i.BYTES_PER_ELEMENT));for(let a=0;a<o.length;a+=4)o[a+1]=255;return o}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}t.a=class{constructor(e,t){this._client=e,this.config=t,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(h.m),this._targetType=0,this._abortController=Object(a.d)(),this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;const r=t.supportsTextureFloat?5126:5121;m(`Creating AttributeStore ${v.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:5121,layout:1},{pixelType:5121,layout:15,textureOnly:!0},{pixelType:r,layout:15},{pixelType:r,layout:15}],this._blocks=this._blockDescriptors.map((()=>null))}destroy(){this._abortController.abort()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}update(e,t){this.config=t;const r=t.schema.processors[0].storage,i=Object(c.a)(this._schema,r);if((e.targets.feature||e.targets.aggregate)&&(e.storage.data=!0),i&&(Object(s.a)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",i),e.storage.data=!0,this._schema=r,this._attributeComputeMap.clear(),!Object(n.j)(r))){switch(r.target){case"feature":this._targetType=0;break;case"aggregate":this._targetType=1}for(const e of r.mapping)this._bindAttribute(e)}}onTileData(e,t){if(Object(n.j)(t.addOrUpdate))return;const r=t.addOrUpdate.getCursor();for(;r.next();){const e=r.getDisplayId();this.setAttributeData(e,r)}}invalidateResources(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=Object(a.d)()}async setHighlight(e,t){const r=this._getBlock(0),s=t.map((e=>b(e)));r.lock(),r.unsetComponentAllTexels(0,1),r.setComponent(0,1,s),r.unlock(),this._idsToHighlight.clear();for(const n of e)this._idsToHighlight.add(n);await this.sendUpdates()}async updateFilters(e,t){const{config:r,service:n,spatialReference:i}=t,{filters:o}=r,a=o.map(((e,t)=>this._updateFilter(e,t,n,i)));(await Promise.all(a)).some((e=>e))&&(e.storage.filters=!0,Object(s.a)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"))}setData(e,t,r,s){const n=b(e);this._ensureSizeForTexel(n),this._getBlock(t).setData(e,r,s)}getData(e,t,r){return this._getBlock(t).getData(e,r)}getHighlightFlag(e){return this._idsToHighlight.has(e)?h.j:0}unsetAttributeData(e){const t=b(e);this._getBlock(0).setData(t,0,0)}setAttributeData(e,t){const r=b(e);if(this._ensureSizeForTexel(r),this._getBlock(0).setData(r,0,this.getFilterFlags(t)),this._targetType!==y(e))return;const s=this._attributeComputeMap,n=this.config.supportsTextureFloat?1:2;s.size&&s.forEach(((e,s)=>{const i=s*n%4,o=Math.floor(s*n/4),a=this._getBlock(o+h.b),c=e(t);if(this.config.supportsTextureFloat)a.setData(r,i,c);else if(c===h.n)a.setData(r,i,255),a.setData(r,i+1,255);else{const e=Object(u.d)(Math.round(c),-32767,32766)+32768,t=255&e,s=(65280&e)>>8;a.setData(r,i,t),a.setData(r,i+1,s)}}))}sendUpdates(){if(this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=Object(a.g)(),this._nextUpdate.promise;const e={blocks:this._blocks.map((e=>Object(n.k)(e)?e.toMessage():null))};return this._currUpdate=this._createResources().then((()=>{const t=()=>{if(this._currUpdate=null,this._nextUpdate){const e=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then((()=>e.resolve()))}},r=this._client.update(e,this._signal).then(t).catch(t);return this._client.render(this._signal),r})).catch((e=>Object(a.m)(e)?(this._createResourcesPromise=null,this._createResources()):(g.error(new o.a("mapview-attribute-store","Encountered an error during client update",e)),Promise.resolve()))),this._currUpdate}_ensureSizeForTexel(e){for(;e>=this._size*this._size;)if(this._expand())return}_bindAttribute(e){let t;if(null!=e.fieldIndex)e.normalizationField&&g.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),t=t=>t.getComputedNumericAtIndex(e.fieldIndex);else{if(!e.field)return;t=e.normalizationField?t=>{const r=t.readAttribute(e.normalizationField);return r?t.readAttribute(e.field)/r:null}:t=>t.readAttribute(e.field)}e.valueRepresentation&&(t=x(t,(t=>Object(p.b)(t,e.valueRepresentation))));this._attributeComputeMap.set(e.binding,x(t,(e=>null===e||isNaN(e)||e===1/0?h.n:e)))}_createResources(){if(Object(n.k)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(h.a),m("Initializing AttributeStore");const e={shared:v.sharedArrayBuffer&&!("local"===this._client.type),size:this._size,blocks:Object(n.m)(this._blocks,(e=>({textureOnly:e.textureOnly,buffer:e.buffer,pixelType:e.pixelType})))},t=this._client.initialize(e,this._signal).catch((e=>{Object(a.m)(e)?this._createResourcesPromise=null:g.error(new o.a("mapview-attribute-store","Encountered an error during client initialization",e))}));return this._createResourcesPromise=t,t.then((()=>Object(n.j)(this._createResourcesPromise)?this._createResources():void 0)),t}_getBlock(e){const t=this._blocks[e];if(Object(n.k)(t))return t;m(`Initializing AttributeBlock at index ${e}`);const r=v.sharedArrayBuffer,s=this._client.type,i=new w(r,s,this._size,this._blockDescriptors[e]);return this._blocks[e]=i,this._createResourcesPromise=null,i}_expand(){if(this._size<this.config.maxTextureSize){const e=this._size<<=1;return m("Expanding block size to",e,this._blocks),Object(n.h)(this._blocks,(t=>t.expand(e))),this._createResourcesPromise=null,this._size=e,0}return g.error(new o.a("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}async _updateFilter(e,t,r,s){const i=this._filters[t],o=Object(n.k)(i)&&i.hash;if(!i&&!e)return!1;if(o===JSON.stringify(e))return!1;if(Object(n.j)(e)){const e=1<<t+1,r=this._getBlock(0);return this._filters[t]=null,r.setComponentAllTexels(0,e),this.sendUpdates(),!0}const a=await this._getFilter(t,r);return await a.update(e,s),!0}async _getFilter(e,t){const s=this._filters[e];if(Object(n.k)(s))return s;const{default:i}=await r.e(122).then(r.bind(null,706)),o=new i({geometryType:t.geometryType,hasM:!1,hasZ:!1,timeInfo:t.timeInfo,fieldsIndex:new l.a(t.fields)});return this._filters[e]=o,o}isVisible(e){return!!(2&this._getBlock(0).getData(e,0))}getFilterFlags(e){let t=0;const r=(e=>1===y(e)?254:255)(e.getDisplayId());for(let i=0;i<this._filters.length;i++){const s=!!(r&1<<i),o=this._filters[i];t|=(!s||Object(n.j)(o)||o.check(e)?1:0)<<i}let s=0;if(this._idsToHighlight.size){const t=e.getObjectId();s=this.getHighlightFlag(t)}return t<<1|s}}},369:function(e,t,r){"use strict";r.d(t,"a",(function(){return u})),r.d(t,"b",(function(){return c}));var s=r(110),n=r(115),i=r(289),o=r(313),a=r(175);const u=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"];class c{constructor(e){this.options=e,this.geometryTypes=u,this._coordinatePtr=0,this._vertexDimension=0}createFeatureResult(){return new o.a}prepareFeatures(e){this._vertexDimension=2,e.hasZ&&this._vertexDimension++,e.hasM&&this._vertexDimension++}finishFeatureResult(e){if(!e||!e.features||!e.hasZ||!this.options.sourceSpatialReference||!e.spatialReference||Object(s.c)(e.spatialReference,this.options.sourceSpatialReference)||e.spatialReference.vcsWkid)return;const t=Object(n.g)(this.options.sourceSpatialReference)/Object(n.g)(e.spatialReference);if(1!==t)for(const r of e.features){if(!r.geometry||!r.geometry.coords)continue;const e=r.geometry.coords;for(let r=2;r<e.length;r+=3)e[r]*=t}}addFeature(e,t){e.features.push(t)}createFeature(){return new i.a}createSpatialReference(){return{wkid:0}}createGeometry(){return new a.a}addField(e,t){e.fields.push(t)}allocateCoordinates(e){e.coords.length=e.lengths.reduce(((e,t)=>e+t),0)*this._vertexDimension,this._coordinatePtr=0}addCoordinate(e,t){e.coords[this._coordinatePtr++]=t}addCoordinatePoint(e,t){e.coords.push(t)}addLength(e,t){e.lengths.push(t)}addQueryGeometry(e,t){e.queryGeometry=t.queryGeometry,e.queryGeometryType=t.queryGeometryType}createPointGeometry(){return new a.a}}},383:function(e,t,r){"use strict";r.d(t,"a",(function(){return n}));var s=r(384);function n(e,t){const r=Object(s.a)(e,t),n=r.queryResult.featureResult,i=r.queryResult.queryGeometry,o=r.queryResult.queryGeometryType;if(n&&n.features&&n.features.length&&n.objectIdFieldName){const e=n.objectIdFieldName;for(const t of n.features)t.attributes&&(t.objectId=t.attributes[e])}return n&&(n.queryGeometry=i,n.queryGeometryType=o),n}},384:function(e,t,r){"use strict";r.d(t,"a",(function(){return C})),r.d(t,"b",(function(){return f})),r.d(t,"c",(function(){return S}));var s=r(88),n=r(80),i=r(91),o=r(175),a=r(369),u=r(359);const c=n.a.getLogger("esri.tasks.operations.pbfFeatureServiceParser"),l=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],h=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],d=["upperLeft","lowerLeft"];function f(e){return e>=l.length?null:l[e]}function p(e){return e>=h.length?null:h[e]}function g(e){return e>=d.length?null:d[e]}function m(e,t){return t>=e.geometryTypes.length?null:e.geometryTypes[t]}function y(e,t,r){const s=t.createPointGeometry(r);for(;e.next();)switch(e.tag()){case 3:{const r=e.getUInt32(),n=e.pos()+r;let i=0;for(;e.pos()<n;)t.addCoordinatePoint(s,e.getSInt64(),i++);break}case 1:case 2:default:e.skip()}return s}function b(e,t,r){const s=t.createGeometry(r),n=2+(r.hasZ?1:0)+(r.hasM?1:0);for(;e.next();)switch(e.tag()){case 2:{const r=e.getUInt32(),n=e.pos()+r;let i=0;for(;e.pos()<n;)t.addLength(s,e.getUInt32(),i++);break}case 3:{const r=e.getUInt32(),i=e.pos()+r;let o=0;for(t.allocateCoordinates(s);e.pos()<i;)t.addCoordinate(s,e.getSInt64(),o),o++,o===n&&(o=0);break}case 1:default:e.skip()}return s}function _(e){const t=new o.a;let r="esriGeometryPoint";for(;e.next();)switch(e.tag()){case 2:{const r=e.getUInt32(),s=e.pos()+r;for(;e.pos()<s;)t.lengths.push(e.getUInt32());break}case 3:{const r=e.getUInt32(),s=e.pos()+r;for(;e.pos()<s;)t.coords.push(e.getSInt64());break}case 1:r=a.a[e.getEnum()];break;default:e.skip()}return{queryGeometry:t,queryGeometryType:r}}function v(e){for(;e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}function x(e){const t={type:f(0)};for(;e.next();)switch(e.tag()){case 1:t.name=e.getString();break;case 2:t.type=f(e.getEnum());break;case 3:t.alias=e.getString();break;case 4:t.sqlType=p(e.getEnum());break;case 5:try{t.domain=JSON.parse(e.getString())}catch(g){c.error(new i.a("query:parsing-pbf","Failed to parse domain",{error:g})),t.domain=null}break;case 6:t.defaultValue=e.getString();break;default:e.skip()}return t}function w(e){const t={};for(;e.next();)switch(e.tag()){case 1:t.name=e.getString();break;case 2:t.isSystemMaintained=e.getBool();break;default:e.skip()}return t}function O(e,t,r,s){const n=t.createFeature(r);let i=0;for(;e.next();)switch(e.tag()){case 1:{const t=s[i++].name;n.attributes[t]=e.processMessage(v);break}case 2:n.geometry=e.processMessageWithArgs(b,t,r);break;case 4:n.centroid=e.processMessageWithArgs(y,t,r);break;default:e.skip()}return n}function j(e){const t=[1,1,1,1];for(;e.next();)switch(e.tag()){case 1:t[0]=e.getDouble();break;case 2:t[1]=e.getDouble();break;case 4:t[2]=e.getDouble();break;case 3:t[3]=e.getDouble();break;default:e.skip()}return t}function I(e){const t=[0,0,0,0];for(;e.next();)switch(e.tag()){case 1:t[0]=e.getDouble();break;case 2:t[1]=e.getDouble();break;case 4:t[2]=e.getDouble();break;case 3:t[3]=e.getDouble();break;default:e.skip()}return t}function S(e){const t={originPosition:g(0)};for(;e.next();)switch(e.tag()){case 1:t.originPosition=g(e.getEnum());break;case 2:t.scale=e.processMessage(j);break;case 3:t.translate=e.processMessage(I);break;default:e.skip()}return t}function T(e){const t={};for(;e.next();)switch(e.tag()){case 1:t.shapeAreaFieldName=e.getString();break;case 2:t.shapeLengthFieldName=e.getString();break;case 3:t.units=e.getString();break;default:e.skip()}return t}function F(e,t){const r=t.createSpatialReference();for(;e.next();)switch(e.tag()){case 1:r.wkid=e.getUInt32();break;case 5:r.wkt=e.getString();break;case 2:r.latestWkid=e.getUInt32();break;case 3:r.vcsWkid=e.getUInt32();break;case 4:r.latestVcsWkid=e.getUInt32();break;default:e.skip()}return r}function M(e,t){const r=t.createFeatureResult();r.geometryType=m(t,0);let s=!1;for(;e.next();)switch(e.tag()){case 1:r.objectIdFieldName=e.getString();break;case 3:r.globalIdFieldName=e.getString();break;case 4:r.geohashFieldName=e.getString();break;case 5:r.geometryProperties=e.processMessage(T);break;case 7:r.geometryType=m(t,e.getEnum());break;case 8:r.spatialReference=e.processMessageWithArgs(F,t);break;case 10:r.hasZ=e.getBool();break;case 11:r.hasM=e.getBool();break;case 12:r.transform=e.processMessage(S);break;case 9:{const t=e.getBool();r.exceededTransferLimit=t;break}case 13:t.addField(r,e.processMessage(x));break;case 15:s||(t.prepareFeatures(r),s=!0),t.addFeature(r,e.processMessageWithArgs(O,t,r,r.fields));break;case 2:r.uniqueIdField=e.processMessage(w);break;case 6:default:e.skip()}return t.finishFeatureResult(r),r}function k(e,t){const r={};let n=null;for(;e.next();)switch(e.tag()){case 4:n=e.processMessageWithArgs(_);break;case 1:r.featureResult=e.processMessageWithArgs(M,t);break;case 2:case 3:default:e.skip()}return Object(s.k)(n)&&r.featureResult&&t.addQueryGeometry(r,n),r}function C(e,t){try{const r=2,s=new u.a(new Uint8Array(e),new DataView(e)),n={};for(;s.next();)switch(s.tag()){case r:n.queryResult=s.processMessageWithArgs(k,t);break;default:s.skip()}return n}catch(r){throw new i.a("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:r})}}},397:function(e,t,r){"use strict";r.d(t,"a",(function(){return h})),r.d(t,"b",(function(){return p})),r.d(t,"c",(function(){return m}));var s=r(110),n=r(158),i=r(220),o=r(425);const a=[0,0];function u(e,t){if(!t)return null;if("x"in t){const r={x:0,y:0};return[r.x,r.y]=e(t.x,t.y,a),null!=t.z&&(r.z=t.z),null!=t.m&&(r.m=t.m),r}if("xmin"in t){const r={xmin:0,ymin:0,xmax:0,ymax:0};return[r.xmin,r.ymin]=e(t.xmin,t.ymin,a),[r.xmax,r.ymax]=e(t.xmax,t.ymax,a),t.hasZ&&(r.zmin=t.zmin,r.zmax=t.zmax,r.hasZ=!0),t.hasM&&(r.mmin=t.mmin,r.mmax=t.mmax,r.hasM=!0),r}return"rings"in t?{rings:c(t.rings,e),hasM:t.hasM,hasZ:t.hasZ}:"paths"in t?{paths:c(t.paths,e),hasM:t.hasM,hasZ:t.hasZ}:"points"in t?{points:l(t.points,e),hasM:t.hasM,hasZ:t.hasZ}:void 0}function c(e,t){const r=[];for(const s of e)r.push(l(s,t));return r}function l(e,t){const r=[];for(const s of e){const e=t(s[0],s[1],[0,0]);r.push(e),s.length>2&&e.push(s[2]),s.length>3&&e.push(s[3])}return r}async function h(e,t){if(!t)return;const r=Array.isArray(e)?e.map((e=>{var t;return null==(t=e.geometry)?void 0:t.spatialReference})):[e];await Object(i.f)(r.map((e=>({source:e,dest:t}))))}const d=u.bind(null,n.c),f=u.bind(null,n.g);function p(e,t,r){return e?(r||(r=t,t=e.spatialReference),Object(s.i)(t)&&Object(s.i)(r)&&!Object(s.c)(t,r)?Object(n.a)(t,r)?Object(s.m)(r)?d(e):f(e):Object(i.m)(o.a,[e],t,r,null)[0]:e):e}const g=new class{constructor(){this._jobs=[],this._timer=null,this._process=this._process.bind(this)}async push(e,t,r){!e||!e.length||!t||!r||Object(s.c)(t,r);const n={geometries:e,inSpatialReference:t,outSpatialReference:r,resolve:null};return this._jobs.push(n),new Promise((e=>{n.resolve=e,null===this._timer&&(this._timer=setTimeout(this._process,10))}))}_process(){this._timer=null;const e=this._jobs.shift();if(!e)return;const{geometries:t,inSpatialReference:r,outSpatialReference:a,resolve:u}=e;Object(n.a)(r,a)?Object(s.m)(a)?u(t.map(d)):u(t.map(f)):u(Object(i.m)(o.a,t,r,a,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}};async function m(e,t,r){return g.push(e,t,r)}},400:function(e,t,r){"use strict";var s=r(210);t.a=class{constructor(e,t){this._storage=new s.b,this._storage.maxSize=e,t&&this._storage.registerRemoveFunc("",t)}put(e,t){this._storage.put(e,t,1,1)}pop(e){return this._storage.pop(e)}get(e){return this._storage.get(e)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}}},402:function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));class s{constructor(e,t){this._mask=0,this._buf=e,this._mask=t}static fromBuffer(e,t){return new s(e,t)}static create(e,t=4294967295){const r=new Uint32Array(Math.ceil(e/32));return new s(r,t)}_getIndex(e){return Math.floor(e/32)}has(e){const t=this._mask&e;return!!(this._buf[this._getIndex(t)]&1<<t%32)}hasRange(e,t){let r=e,s=t;for(;r%32&&r!==s;){if(this.has(r))return!0;r++}for(;s%32&&r!==s;){if(this.has(r))return!0;s--}if(r===s)return!1;for(let n=r/32;n!==s/32;n++)if(this._buf[n])return!0;return!1}set(e){const t=this._mask&e,r=this._getIndex(t),s=1<<t%32;this._buf[r]|=s}setRange(e,t){let r=e,s=t;for(;r%32&&r!==s;)this.set(r++);for(;s%32&&r!==s;)this.set(s--);if(r!==s)for(let n=r/32;n!==s/32;n++)this._buf[n]=4294967295}unset(e){const t=this._mask&e,r=this._getIndex(t),s=1<<t%32;this._buf[r]&=4294967295^s}resize(e){const t=this._buf,r=new Uint32Array(Math.ceil(e/32));r.set(t),this._buf=r}or(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=e._buf[t];return this}and(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=e._buf[t];return this}xor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=e._buf[t];return this}ior(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=~e._buf[t];return this}iand(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=~e._buf[t];return this}ixor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=~e._buf[t];return this}any(){for(let e=0;e<this._buf.length;e++)if(this._buf[e])return!0;return!1}copy(e){for(let t=0;t<this._buf.length;t++)this._buf[t]=e._buf[t];return this}clone(){return new s(this._buf.slice(),this._mask)}clear(){for(let e=0;e<this._buf.length;e++)this._buf[e]=0}forEachSet(e){for(let t=0;t<this._buf.length;t++){let r=this._buf[t],s=32*t;if(r)for(;r;)1&r&&e(s),r>>>=1,s++}}countSet(){let e=0;return this.forEachSet((t=>{e++})),e}}},403:function(e,t,r){"use strict";r.d(t,"a",(function(){return u}));var s=r(80),n=r(91),i=r(124),o=r(148);const a=s.a.getLogger("esri.views.2d.engine.webgl");function u(e){return Object(o.o)(e.minDataValue)&&Object(o.o)(e.maxDataValue)&&null!=e.minSize&&null!=e.maxSize?i.e.SIZE_MINMAX_VALUE:(e.expression&&"view.scale"===e.expression||e.valueExpression&&"$view.scale"===e.valueExpression)&&Array.isArray(e.stops)?i.e.SIZE_SCALE_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&(Array.isArray(e.stops)||"levels"in e&&e.levels)?i.e.SIZE_FIELD_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&null!=e.valueUnit?i.e.SIZE_UNIT_VALUE:(a.error(new n.a("mapview-bad-type","Found invalid size VisualVariable",e)),i.e.NONE)}},404:function(e,t,r){"use strict";r.d(t,"a",(function(){return l}));r(79);var s=r(88),n=r(98),i=(r(99),r(175)),o=r(165),a=r(466),u=r(402);let c=0;class l{constructor(e){this.type="FeatureSetReader",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._xmin=-1,this._xmax=0,this._ymin=0,this._ymax=0,this._deleted=null,this._joined=[],this.instance=e}static createInstance(){return c++,c=c>65535?0:c,c}get isEmpty(){return Object(s.k)(this._deleted)&&this._deleted.countSet()===this.getApproximateSize()}get _hasFilter(){return-1!==this._xmin}setArcadeSpatialReference(e){this._arcadeSpatialReference=e}attachStorage(e){this._storage=e}getQuantizationTransform(){throw new Error("Unable to find transform for featureSet")}getStorage(){return this._storage}getComputedNumeric(e){return this.getComputedNumericAtIndex(0)}setComputedNumeric(e,t){return this.setComputedNumericAtIndex(t,0)}getComputedString(e){return this.getComputedStringAtIndex(0)}setComputedString(e,t){return this.setComputedStringAtIndex(0,t)}getComputedNumericAtIndex(e){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),e)}setComputedNumericAtIndex(e,t){this._storage.setComputedNumericAtIndex(this.getDisplayId(),e,t)}getComputedStringAtIndex(e){return this._storage.getComputedStringAtIndex(this.getDisplayId(),e)}setComputedStringAtIndex(e,t){return this._storage.setComputedStringAtIndex(this.getDisplayId(),e,t)}transform(e,t,r,s){const n=this.copy();return n._tx+=e,n._ty+=t,n._sx*=r,n._sy*=s,n}extent(e,t,r,s){const n=this.copy();return n._xmin=e,n._xmax=r,n._ymin=t,n._ymax=s,n}hasFilter(){return this._hasFilter}readAttribute(e,t=!1){const r=this._readAttribute(e,t);if(void 0!==r)return r;for(const s of this._joined){s.setIndex(this.getIndex());const r=s._readAttribute(e,t);if(void 0!==r)return r}}readAttributes(){return this._readAttributes()}joinAttributes(e){this._joined.push(e)}readArcadeFeature(){return this}geometry(){const e=this.readHydratedGeometry(),t=Object(o.k)(e,this.geometryType,this.hasZ,this.hasM),r=Object(n.a)(t);return r.spatialReference=this._arcadeSpatialReference,r}field(e){return this.readAttribute(e,!0)}hasField(e){return!0}setField(e,t){}keys(){return[]}castToText(){return""}removeAtIndex(e){Object(s.j)(this._deleted)&&(this._deleted=u.a.create(this.getApproximateSize())),this._deleted.set(e)}_getExists(){return Object(s.j)(this._deleted)||!this._deleted.has(this.getIndex())}_computeCentroid(){if("esriGeometryPolygon"!==this.geometryType)return null;const e=this.readUnquantizedGeometry();if(!e||e.hasIndeterminateRingOrder)return null;const t=Object(s.r)(this.getQuantizationTransform(),null);return Object(a.a)(new i.a,e,this.hasM,this.hasZ,t)}copyInto(e){e.seen=this.seen,e._storage=this._storage,e._arcadeSpatialReference=this._arcadeSpatialReference,e._joined=this._joined,e._tx=this._tx,e._ty=this._ty,e._sx=this._sx,e._sy=this._sy,e._xmin=this._xmin,e._xmax=this._xmax,e._ymin=this._ymin,e._ymax=this._ymax}}},417:function(e,t,r){"use strict";r.d(t,"a",(function(){return n}));var s=r(494);function n(e,t){if(!(this instanceof n))return new n(e,t);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this.toBBox=t:this._initFormat(t)),this.clear()}function i(e,t,r){if(!r)return t.indexOf(e);for(var s=0;s<t.length;s++)if(r(e,t[s]))return s;return-1}function o(e,t){a(e,0,e.children.length,t,e)}function a(e,t,r,s,n){n||(n=y(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(var i,o=t;o<r;o++)i=e.children[o],u(n,e.leaf?s(i):i);return n}function u(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function c(e,t){return e.minX-t.minX}function l(e,t){return e.minY-t.minY}function h(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function d(e){return e.maxX-e.minX+(e.maxY-e.minY)}function f(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function p(e,t){var r=Math.max(e.minX,t.minX),s=Math.max(e.minY,t.minY),n=Math.min(e.maxX,t.maxX),i=Math.min(e.maxY,t.maxY);return Math.max(0,n-r)*Math.max(0,i-s)}function g(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function m(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function y(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function b(e,t,r,n,i){for(var o,a=[t,r];a.length;)(r=a.pop())-(t=a.pop())<=n||(o=t+Math.ceil((r-t)/n/2)*n,Object(s.a)(e,o,t,r,i),a.push(t,o,o,r))}n.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,r=[],s=this.toBBox;if(!m(e,t))return r;for(var n,i,o,a,u=[];t;){for(n=0,i=t.children.length;n<i;n++)o=t.children[n],m(e,a=t.leaf?s(o):o)&&(t.leaf?r.push(o):g(e,a)?this._all(o,r):u.push(o));t=u.pop()}return r},collides:function(e){var t=this.data,r=this.toBBox;if(!m(e,t))return!1;for(var s,n,i,o,a=[];t;){for(s=0,n=t.children.length;s<n;s++)if(i=t.children[s],m(e,o=t.leaf?r(i):i)){if(t.leaf||g(e,o))return!0;a.push(i)}t=a.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,r=e.length;t<r;t++)this.insert(e[t]);return this}var s=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===s.height)this._splitRoot(this.data,s);else{if(this.data.height<s.height){var n=this.data;this.data=s,s=n}this._insert(s,this.data.height-s.height-1,!0)}else this.data=s;return this},insert:function(e){return e&&this._insert(e,this.data.height-1),this},clear:function(){return this.data=y([]),this},remove:function(e,t){if(!e)return this;for(var r,s,n,o,a=this.data,u=this.toBBox(e),c=[],l=[];a||c.length;){if(a||(a=c.pop(),s=c[c.length-1],r=l.pop(),o=!0),a.leaf&&-1!==(n=i(e,a.children,t)))return a.children.splice(n,1),c.push(a),this._condense(c),this;o||a.leaf||!g(a,u)?s?(r++,a=s.children[r],o=!1):a=null:(c.push(a),l.push(r),r=0,s=a,a=a.children[0])}return this},toBBox:function(e){return e},compareMinX:c,compareMinY:l,toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var r=[];e;)e.leaf?t.push.apply(t,e.children):r.push.apply(r,e.children),e=r.pop();return t},_build:function(e,t,r,s){var n,i=r-t+1,a=this._maxEntries;if(i<=a)return o(n=y(e.slice(t,r+1)),this.toBBox),n;s||(s=Math.ceil(Math.log(i)/Math.log(a)),a=Math.ceil(i/Math.pow(a,s-1))),(n=y([])).leaf=!1,n.height=s;var u,c,l,h,d=Math.ceil(i/a),f=d*Math.ceil(Math.sqrt(a));for(b(e,t,r,f,this.compareMinX),u=t;u<=r;u+=f)for(b(e,u,l=Math.min(u+f-1,r),d,this.compareMinY),c=u;c<=l;c+=d)h=Math.min(c+d-1,l),n.children.push(this._build(e,c,h,s-1));return o(n,this.toBBox),n},_chooseSubtree:function(e,t,r,s){for(var n,i,o,a,u,c,l,d;s.push(t),!t.leaf&&s.length-1!==r;){for(l=d=1/0,n=0,i=t.children.length;n<i;n++)u=h(o=t.children[n]),(c=f(e,o)-u)<d?(d=c,l=u<l?u:l,a=o):c===d&&u<l&&(l=u,a=o);t=a||t.children[0]}return t},_insert:function(e,t,r){var s=this.toBBox,n=r?e:s(e),i=[],o=this._chooseSubtree(n,this.data,t,i);for(o.children.push(e),u(o,n);t>=0&&i[t].children.length>this._maxEntries;)this._split(i,t),t--;this._adjustParentBBoxes(n,i,t)},_split:function(e,t){var r=e[t],s=r.children.length,n=this._minEntries;this._chooseSplitAxis(r,n,s);var i=this._chooseSplitIndex(r,n,s),a=y(r.children.splice(i,r.children.length-i));a.height=r.height,a.leaf=r.leaf,o(r,this.toBBox),o(a,this.toBBox),t?e[t-1].children.push(a):this._splitRoot(r,a)},_splitRoot:function(e,t){this.data=y([e,t]),this.data.height=e.height+1,this.data.leaf=!1,o(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,r){var s,n,i,o,u,c,l,d;for(c=l=1/0,s=t;s<=r-t;s++)o=p(n=a(e,0,s,this.toBBox),i=a(e,s,r,this.toBBox)),u=h(n)+h(i),o<c?(c=o,d=s,l=u<l?u:l):o===c&&u<l&&(l=u,d=s);return d},_chooseSplitAxis:function(e,t,r){var s=e.leaf?this.compareMinX:c,n=e.leaf?this.compareMinY:l;this._allDistMargin(e,t,r,s)<this._allDistMargin(e,t,r,n)&&e.children.sort(s)},_allDistMargin:function(e,t,r,s){e.children.sort(s);var n,i,o=this.toBBox,c=a(e,0,t,o),l=a(e,r-t,r,o),h=d(c)+d(l);for(n=t;n<r-t;n++)i=e.children[n],u(c,e.leaf?o(i):i),h+=d(c);for(n=r-t-1;n>=t;n--)i=e.children[n],u(l,e.leaf?o(i):i),h+=d(l);return h},_adjustParentBBoxes:function(e,t,r){for(var s=r;s>=0;s--)u(t[s],e)},_condense:function(e){for(var t,r=e.length-1;r>=0;r--)0===e[r].children.length?r>0?(t=e[r-1].children).splice(t.indexOf(e[r]),1):this.clear():o(e[r],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}},425:function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));const s={convertToGEGeometry:function(e,t){return null==t?null:e.convertJSONToGeometry(t)},exportPoint:function(e,t,r){const s=new n(e.getPointX(t),e.getPointY(t),r),i=e.hasZ(t),o=e.hasM(t);return i&&(s.z=e.getPointZ(t)),o&&(s.m=e.getPointM(t)),s},exportPolygon:function(e,t,r){return new i(e.exportPaths(t),r,e.hasZ(t),e.hasM(t))},exportPolyline:function(e,t,r){return new o(e.exportPaths(t),r,e.hasZ(t),e.hasM(t))},exportMultipoint:function(e,t,r){return new a(e.exportPoints(t),r,e.hasZ(t),e.hasM(t))},exportExtent:function(e,t,r){const s=e.hasZ(t),n=e.hasM(t),i=new u(e.getXMin(t),e.getYMin(t),e.getXMax(t),e.getYMax(t),r);if(s){const r=e.getZExtent(t);i.zmin=r.vmin,i.zmax=r.vmax}if(n){const r=e.getMExtent(t);i.mmin=r.vmin,i.mmax=r.vmax}return i}};class n{constructor(e,t,r){this.x=e,this.y=t,this.spatialReference=r,this.z=void 0,this.m=void 0}}class i{constructor(e,t,r,s){this.rings=e,this.spatialReference=t,this.hasZ=void 0,this.hasM=void 0,r&&(this.hasZ=r),s&&(this.hasM=s)}}class o{constructor(e,t,r,s){this.paths=e,this.spatialReference=t,this.hasZ=void 0,this.hasM=void 0,r&&(this.hasZ=r),s&&(this.hasM=s)}}class a{constructor(e,t,r,s){this.points=e,this.spatialReference=t,this.hasZ=void 0,this.hasM=void 0,r&&(this.hasZ=r),s&&(this.hasM=s)}}class u{constructor(e,t,r,s,n){this.xmin=e,this.ymin=t,this.xmax=r,this.ymax=s,this.spatialReference=n,this.zmin=void 0,this.zmax=void 0,this.mmin=void 0,this.mmax=void 0}}},426:function(e,t,r){"use strict";r.d(t,"a",(function(){return n})),r.d(t,"b",(function(){return s}));const s=(e,t)=>e&&((...e)=>t.warn("DEBUG:",...e))||(()=>null),n=!1},427:function(e,t,r){"use strict";r.d(t,"a",(function(){return u}));var s=r(312),n=r(101),i=r(122),o=r(247),a=r(242);class u{constructor(e,t){this.key=new a.a(0,0,0,0),this.bounds=Object(i.i)(),this.objectIds=new Set,this.key.set(t);const r=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=r.resolution,this.scale=r.scale,this.level=r.level,this.needsClear=!0}get id(){return this.key.id}get extent(){return n.a.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}get bbox(){const e=this.bounds;return{minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}}clone(){return new u(this.tileInfoView,this.key)}createChildTiles(){const e=this.key.getChildKeys(),t=s.a.acquire();for(let r=0;r<e.length;r++)t[r]=new u(this.tileInfoView,e[r]);return t}getQuantizationParameters(){return o.a.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}},456:function(e,t,r){"use strict";var s=r(88);t.a=class{constructor(e=(e=>e.values().next().value)){this._peeker=e,this._items=new Set}get length(){return this._items.size}clear(){this._items.clear()}peek(){if(0!==this._items.size)return this._peeker(this._items)}push(e){this.contains(e)||this._items.add(e)}contains(e){return this._items.has(e)}pop(){if(0===this.length)return;const e=this.peek();return this._items.delete(Object(s.d)(e)),e}remove(e){this._items.delete(e)}filter(e){return this._items.forEach((t=>{e(t)||this._items.delete(t)})),this}}},457:function(e,t,r){"use strict";var s,n=r(81),i=(r(79),r(80),r(87)),o=r(84),a=r(83),u=(r(82),r(85),r(86),r(89));let c=s=class extends u.a{constructor(e){super(e),this.level=0,this.levelValue=null,this.resolution=0,this.scale=0}clone(){return new s({level:this.level,levelValue:this.levelValue,resolution:this.resolution,scale:this.scale})}};Object(n.a)([Object(o.b)({type:i.a,json:{write:!0}})],c.prototype,"level",void 0),Object(n.a)([Object(o.b)({type:String,json:{write:!0}})],c.prototype,"levelValue",void 0),Object(n.a)([Object(o.b)({type:Number,json:{write:!0}})],c.prototype,"resolution",void 0),Object(n.a)([Object(o.b)({type:Number,json:{write:!0}})],c.prototype,"scale",void 0),c=s=Object(n.a)([Object(a.a)("esri.layers.support.LOD")],c);var l=c;t.a=l},466:function(e,t,r){"use strict";function s(e,t){return e?t?4:3:t?3:2}function n(e,t,r,n,a){if(!t||!t.lengths.length)return null;const u="upperLeft"===(null==a?void 0:a.originPosition)?-1:1;e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0);const c=e.coords,l=[],h=r?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],{lengths:d,coords:f}=t,p=s(r,n);let g=0;for(const s of d){const e=i(h,f,g,s,r,n,u);e&&l.push(e),g+=s*p}if(l.sort(((e,t)=>{let s=u*e[2]-u*t[2];return 0===s&&r&&(s=e[4]-t[4]),s})),l.length){let e=6*l[0][2];c[0]=l[0][0]/e,c[1]=l[0][1]/e,r&&(e=6*l[0][4],c[2]=0!==e?l[0][3]/e:0),(c[0]<h[0]||c[0]>h[1]||c[1]<h[2]||c[1]>h[3]||r&&(c[2]<h[4]||c[2]>h[5]))&&(c.length=0)}if(!c.length){const e=t.lengths[0]?o(f,0,d[0],r,n):null;if(!e)return null;c[0]=e[0],c[1]=e[1],r&&e.length>2&&(c[2]=e[2])}return e}function i(e,t,r,n,i,o,a=1){const u=s(i,o);let c=r,l=r+u,h=0,d=0,f=0,p=0,g=0;for(let s=0,y=n-1;s<y;s++,c+=u,l+=u){const r=t[c],s=t[c+1],n=t[c+2],o=t[l],a=t[l+1],u=t[l+2];let m=r*a-o*s;p+=m,h+=(r+o)*m,d+=(s+a)*m,i&&(m=r*u-o*n,f+=(n+u)*m,g+=m),r<e[0]&&(e[0]=r),r>e[1]&&(e[1]=r),s<e[2]&&(e[2]=s),s>e[3]&&(e[3]=s),i&&(n<e[4]&&(e[4]=n),n>e[5]&&(e[5]=n))}if(p*a>0&&(p*=-1),g*a>0&&(g*=-1),!p)return null;const m=[h,d,.5*p];return i&&(m[3]=f,m[4]=.5*g),m}function o(e,t,r,n,i){const o=s(n,i);let h=t,d=t+o,f=0,p=0,g=0,m=0;for(let s=0,y=r-1;s<y;s++,h+=o,d+=o){const t=e[h],r=e[h+1],s=e[h+2],i=e[d],o=e[d+1],y=e[d+2],b=n?u(t,r,s,i,o,y):a(t,r,i,o);if(b)if(f+=b,n){const e=l(t,r,s,i,o,y);p+=b*e[0],g+=b*e[1],m+=b*e[2]}else{const e=c(t,r,i,o);p+=b*e[0],g+=b*e[1]}}return f>0?n?[p/f,g/f,m/f]:[p/f,g/f]:r>0?n?[e[t],e[t+1],e[t+2]]:[e[t],e[t+1]]:null}function a(e,t,r,s){const n=r-e,i=s-t;return Math.sqrt(n*n+i*i)}function u(e,t,r,s,n,i){const o=s-e,a=n-t,u=i-r;return Math.sqrt(o*o+a*a+u*u)}function c(e,t,r,s){return[e+.5*(r-e),t+.5*(s-t)]}function l(e,t,r,s,n,i){return[e+.5*(s-e),t+.5*(n-t),r+.5*(i-r)]}r.d(t,"a",(function(){return n}))},493:function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var s=r(88),n=r(165),i=r(404);class o extends i.a{constructor(e,t,r){super(e),this._featureIndex=-1,this._dateFields=new Set,this._geometryType=r,this._features=t}static fromFeatures(e,t,r){const s=Object(n.c)([],e,t,!1,!1,r);for(let n=0;n<s.length;n++)s[n].displayId=e[n].displayId;return o.fromOptimizedFeatures(s,t)}static fromFeatureSet(e,t){const r=Object(n.b)(e,t);return o.fromOptimizedFeatureSet(r)}static fromOptimizedFeatureSet(e){const{features:t,geometryType:r}=e,s=o.fromOptimizedFeatures(t,r);s._exceededTransferLimit=e.exceededTransferLimit,s._transform=e.transform;for(const n of e.fields)"esriFieldTypeDate"===n.type&&s._dateFields.add(n.name);return s}static fromOptimizedFeatures(e,t,r){const s=i.a.createInstance(),n=new o(s,e,t);return n._transform=r,n}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}getApproximateSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let e="";for(const t in this._current.attributes)e+=this._current.attributes[t];return e}getIndex(){return this._featureIndex}setIndex(e){this._featureIndex=e}getObjectId(){return this._current.objectId}getDisplayId(){return this._current.displayId}setDisplayId(e){this._current.displayId=e}getGroupId(){return this._current.groupId}setGroupId(e){this._current.groupId=e}copy(){const e=new o(this.instance,this._features,this.geometryType);return this.copyInto(e),e}next(){for(;++this._featureIndex<this._features.length&&!this._passesFilter()&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return Object(n.i)(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){const e=this.readGeometry();return Object(n.k)(e,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const e=this.readCentroid();return e?{x:e.coords[0]*this._sx+this._tx,y:e.coords[1]*this._sy+this._ty}:null}readGeometryArea(){return Object(n.s)(this._current.geometry,2)}readUnquantizedGeometry(){const e=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!e)return e;const t=e.clone();return function({coords:e,lengths:t}){let r=0;for(const s of t){for(let t=1;t<s;t++)e[2*(r+t)]+=e[2*(r+t)-2],e[2*(r+t)+1]+=e[2*(r+t)-1];r+=s}}(t),t}readHydratedGeometry(){const e=this._current.geometry;if(!e)return null;const t=e.clone();return Object(s.k)(this._transform)&&Object(n.z)(t,t,this.hasZ,this.hasM,this._transform),t}getXHydrate(){const e=this._current.geometry.coords[0],t=this.getQuantizationTransform();return Object(s.j)(t)?e:e*t.scale[0]+t.translate[0]}getYHydrate(){const e=this._current.geometry.coords[1],t=this.getQuantizationTransform();return Object(s.j)(t)?e:t.translate[1]-e*t.scale[1]}getX(){return this._current.geometry.coords[0]*this._sx+this._tx}getY(){return this._current.geometry.coords[1]*this._sy+this._ty}readGeometry(){if(!this._current.hasGeometry)return null;const e=this._current.geometry.clone();if(e.isPoint)return e.coords[0]=e.coords[0]*this._sx+this._tx,e.coords[1]=e.coords[1]*this._sy+this._ty,e;let t=0;for(const r of e.lengths)e.coords[2*t]=e.coords[2*t]*this._sx+this._tx,e.coords[2*t+1]=e.coords[2*t+1]*this._sy+this._ty,t+=r;return e}readCentroid(){if(!this._current.hasGeometry)return null;if(!this._current.centroid){const e=this._computeCentroid();if(!e)return null;e.coords[0]=(e.coords[0]-this._tx)/this._sx,e.coords[1]=(e.coords[1]-this._ty)/this._sy,this._current.centroid=e}const e=this._current.centroid.clone();return e.coords[0]=e.coords[0]*this._sx+this._tx,e.coords[1]=e.coords[1]*this._sx+this._ty,e}_readAttribute(e,t){const r=this._current.attributes[e];if(void 0!==r)return null!=r&&t&&this._dateFields.has(e)?new Date(r):r;const s=this.readAttributes(),n=e.toLocaleLowerCase().trim();for(const i in s)if(i.toLocaleLowerCase().trim()===n){const e=this._current.attributes[i];return null!=e&&t&&this._dateFields.has(i)?new Date(e):e}}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._dateFields=this._dateFields}_readAttributes(){return this._current.attributes}_passesFilter(){if(!this._hasFilter)return!0;let e=0,t=0;switch(this.geometryType){case"esriGeometryPoint":{const r=this._current.geometry;if(!r)return!1;[e,t]=r.coords;break}case"esriGeometryPolygon":{const r=this.readCentroid();if(!r)return!1;[e,t]=r.coords,e-=this._tx,t-=this._ty;break}default:return!1}return e>=this._xmin&&e<=this._xmax&&t>=this._ymin&&t<=this._ymax}}},494:function(e,t,r){"use strict";r.d(t,"a",(function(){return n}));var s=r(130),n=Object(s.b)((function(e){var t;void 0!==(t=function(){function e(r,s,n,i,o){for(;i>n;){if(i-n>600){var a=i-n+1,u=s-n+1,c=Math.log(a),l=.5*Math.exp(2*c/3),h=.5*Math.sqrt(c*l*(a-l)/a)*(u-a/2<0?-1:1);e(r,s,Math.max(n,Math.floor(s-u*l/a+h)),Math.min(i,Math.floor(s+(a-u)*l/a+h)),o)}var d=r[s],f=n,p=i;for(t(r,n,s),o(r[i],d)>0&&t(r,n,i);f<p;){for(t(r,f,p),f++,p--;o(r[f],d)<0;)f++;for(;o(r[p],d)>0;)p--}0===o(r[n],d)?t(r,n,p):t(r,++p,i),p<=s&&(n=p+1),s<=p&&(i=p-1)}}function t(e,t,r){var s=e[t];e[t]=e[r],e[r]=s}function r(e,t){return e<t?-1:e>t?1:0}return function(t,s,n,i,o){e(t,s,n||0,i||t.length-1,o||r)}}())&&(e.exports=t)}))},505:function(e,t,r){"use strict";var s=r(110),n=r(242);function i(e,t){return[e,t]}function o(e,t,r){return e[0]=t,e[1]=r,e}const a=new n.a("0/0/0/0");class u{constructor(e,t,r,s,n,i,o,a,u,c,l,h){this.level=e,this.resolution=t,this.scale=r,this.origin=s,this.first=n,this.last=i,this.size=o,this.norm=a,this.worldStart=u,this.worldEnd=c,this.worldSize=l,this.wrap=h}static create(e,t,r){const n=Object(s.d)(e.spatialReference),a=i(e.origin.x,e.origin.y),c=i(e.size[0]*t.resolution,e.size[1]*t.resolution),l=i(-1/0,-1/0),h=i(1/0,1/0),d=i(1/0,1/0);let f,p,g,m;return r&&(o(l,Math.max(0,Math.floor((r.xmin-a[0])/c[0])),Math.max(0,Math.floor((a[1]-r.ymax)/c[1]))),o(h,Math.max(0,Math.floor((r.xmax-a[0])/c[0])),Math.max(0,Math.floor((a[1]-r.ymin)/c[1]))),o(d,h[0]-l[0]+1,h[1]-l[1]+1)),e.isWrappable?(f=i(Math.ceil(Math.round((n.valid[1]-n.valid[0])/t.resolution)/e.size[0]),d[1]),p=i(Math.floor((n.origin[0]-a[0])/c[0]),l[1]),g=i(f[0]+p[0]-1,h[1]),m=!0):(p=l,g=h,f=d,m=!1),new u(t.level,t.resolution,t.scale,a,l,h,d,c,p,g,f,m)}normalizeCol(e){if(!this.wrap)return e;const t=this.worldSize[0];return e<0?t-1-Math.abs((e+1)%t):e%t}denormalizeCol(e,t){return this.wrap?this.worldSize[0]*t+e:e}getWorldForColumn(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}getFirstColumnForWorld(e){return e*this.worldSize[0]+this.first[0]}getLastColumnForWorld(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(e){return(e-this.origin[0])/this.norm[0]}getXForColumn(e){return this.origin[0]+e*this.norm[0]}getRowForY(e){return(this.origin[1]-e)/this.norm[1]}getYForRow(e){return this.origin[1]-e*this.norm[1]}getTileBounds(e,t,r=!1){a.set(t);const s=r?a.col:this.denormalizeCol(a.col,a.world),n=a.row;return function(e,t,r,s,n){e[0]=t,e[1]=r,e[2]=s,e[3]=n}(e,this.getXForColumn(s),this.getYForRow(n+1),this.getXForColumn(s+1),this.getYForRow(n)),e}getTileCoords(e,t,r=!1){a.set(t);const s=r?a.col:this.denormalizeCol(a.col,a.world);return Array.isArray(e)?o(e,this.getXForColumn(s),this.getYForRow(a.row)):(e.x=this.getXForColumn(s),e.y=this.getYForRow(a.row)),e}}var c=u,l=r(510);var h=class{constructor(e,t,r){this.row=e,this.colFrom=t,this.colTo=r}};const d=new n.a("0/0/0/0");class f{constructor(e,t,r,s,n,i,o,a){this.x=e,this.ymin=t,this.ymax=r,this.invM=s,this.leftAdjust=n,this.rightAdjust=i,this.leftBound=o,this.rightBound=a}static create(e,t){e[1]>t[1]&&([e,t]=[t,e]);const[r,s]=e,[n,i]=t,o=n-r,a=i-s,u=0!==a?o/a:0,c=(Math.ceil(s)-s)*u,l=(Math.floor(s)-s)*u;return new f(r,Math.floor(s),Math.ceil(i),u,o<0?c:l,o<0?l:c,o<0?n:r,o<0?r:n)}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}const p=[[0,0],[0,0],[0,0],[0,0]];t.a=class{constructor(e,t){this.tileInfo=e,this.fullExtent=t,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};const r=e.lods.slice();r.sort((function(e,t){return t.scale-e.scale}));const s=this._lodInfos=r.map((r=>c.create(e,r,t)));r.forEach(((e,t)=>{this._infoByLevel[e.level]=s[t],this._infoByScale[e.scale]=s[t],this.scales[t]=e.scale}),this),this._wrap=e.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(e){return this._infoByLevel["number"==typeof e?e:e.level]}getTileBounds(e,t,r=!1){d.set(t);const s=this._infoByLevel[d.level];return s?s.getTileBounds(e,d,r):e}getTileCoords(e,t,r=!1){d.set(t);const s=this._infoByLevel[d.level];return s?s.getTileCoords(e,d,r):e}getTileCoverage(e,t=192,r="closest"){const s="closest"===r?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),n=l.a.pool.acquire(s),i=this._wrap;let o,a,u,c=1/0,d=-1/0;const g=n.spans;p[0][0]=p[0][1]=p[1][1]=p[3][0]=-t,p[1][0]=p[2][0]=e.size[0]+t,p[2][1]=p[3][1]=e.size[1]+t;for(const l of p)e.toMap(l,l),l[0]=s.getColumnForX(l[0]),l[1]=s.getRowForY(l[1]);const m=[];let y=3;for(let l=0;l<4;l++){if(p[l][1]===p[y][1]){y=l;continue}const e=f.create(p[l],p[y]);c=Math.min(e.ymin,c),d=Math.max(e.ymax,d),void 0===m[e.ymin]&&(m[e.ymin]=[]),m[e.ymin].push(e),y=l}if(null==c||null==d||d-c>100)return null;let b=[];for(o=c;o<d;){null!=m[o]&&(b=b.concat(m[o])),a=1/0,u=-1/0;for(let e=b.length-1;e>=0;e--){const t=b[e];a=Math.min(a,t.getLeftCol()),u=Math.max(u,t.getRightCol())}if(a=Math.floor(a),u=Math.floor(u),o>=s.first[1]&&o<=s.last[1])if(i)if(s.size[0]<s.worldSize[0]){const e=Math.floor(u/s.worldSize[0]);for(let t=Math.floor(a/s.worldSize[0]);t<=e;t++)g.push(new h(o,Math.max(s.getFirstColumnForWorld(t),a),Math.min(s.getLastColumnForWorld(t),u)))}else g.push(new h(o,a,u));else a>s.last[0]||u<s.first[0]||(a=Math.max(a,s.first[0]),u=Math.min(u,s.last[0]),g.push(new h(o,a,u)));o+=1;for(let e=b.length-1;e>=0;e--){const t=b[e];t.ymax>=o?t.incrRow():b.splice(e,1)}}return n}getTileParentId(e){d.set(e);const t=this._infoByLevel[d.level],r=this._lodInfos.indexOf(t)-1;return r<0?null:(this._getTileIdAtLOD(d,this._lodInfos[r],d),d.id)}getTileResolution(e){const t=this._infoByLevel["object"==typeof e?e.level:e];return t?t.resolution:-1}getTileScale(e){const t=this._infoByLevel[e.level];return t?t.scale:-1}intersects(e,t){d.set(t);const r=this._infoByLevel[d.level],s=e.lodInfo;if(s.resolution>r.resolution){this._getTileIdAtLOD(d,s,d);const t=s.denormalizeCol(d.col,d.world);for(const r of e.spans)if(r.row===d.row&&r.colFrom<=t&&r.colTo>=t)return!0}if(s.resolution<r.resolution){const[t,n,i,o]=e.spans.reduce(((e,t)=>(e[0]=Math.min(e[0],t.row),e[1]=Math.max(e[1],t.row),e[2]=Math.min(e[2],t.colFrom),e[3]=Math.max(e[3],t.colTo),e)),[1/0,-1/0,1/0,-1/0]),a=r.denormalizeCol(d.col,d.world),u=s.getColumnForX(r.getXForColumn(a)),c=s.getRowForY(r.getYForRow(d.row)),l=s.getColumnForX(r.getXForColumn(a+1))-1,h=s.getRowForY(r.getYForRow(d.row+1))-1;return!(u>o||l<i||c>n||h<t)}const n=s.denormalizeCol(d.col,d.world);return e.spans.some((e=>e.row===d.row&&e.colFrom<=n&&e.colTo>=n))}normalizeBounds(e,t,r){if(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],this._wrap){const t=Object(s.d)(this.tileInfo.spatialReference),n=-r*(t.valid[1]-t.valid[0]);e[0]+=n,e[2]+=n}return e}getSmallestInfoForScale(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>t[0])return this._infoByScale[t[0]];for(let r=1;r<t.length-1;r++)if(e>t[r]+1e-6)return this._infoByScale[t[r-1]];return this._infoByScale[t[t.length-1]]}getClosestInfoForScale(e){const t=this.scales;return this._infoByScale[e]||(e=t.reduce(((t,r)=>Math.abs(r-e)<Math.abs(t-e)?r:t),t[0])),this._infoByScale[e]}scaleToLevel(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(let r=t.length-1;r>=0;r--)if(e<t[r])return r===t.length-1?this._infoByScale[t[t.length-1]].level:this._infoByScale[t[r]].level+(t[r]-e)/(t[r]-t[r+1]);return this._infoByScale[t[0]].level}scaleToZoom(e){return this.tileInfo.scaleToZoom(e)}_getTileIdAtLOD(e,t,r){const s=this._infoByLevel[r.level];return e.set(r),t.resolution<s.resolution?null:(t.resolution===s.resolution||(e.level=t.level,e.col=Math.floor(r.col*s.resolution/t.resolution+.01),e.row=Math.floor(r.row*s.resolution/t.resolution+.01)),e)}}},510:function(e,t,r){"use strict";var s=r(218);class n{constructor(){this.spans=[]}acquire(e){this.lodInfo=e}release(){this.lodInfo=null,this.spans.length=0}forEach(e,t){const{spans:r,lodInfo:s}=this,{level:n}=s;if(0!==r.length)for(const{row:i,colFrom:o,colTo:a}of r)for(let r=o;r<=a;r++)e.call(t,n,i,s.normalizeCol(r),s.getWorldForColumn(r))}}n.pool=new s.a(n),t.a=n},517:function(e,t,r){"use strict";r.d(t,"a",(function(){return f})),r.d(t,"b",(function(){return c}));var s=r(88),n=r(103),i=r(119),o=r(124),a=r(184),u=r(403);function c(e,t){if(!e||!t)return e;switch(t){case"radius":case"distance":return 2*e;case"diameter":case"width":return e;case"area":return Math.sqrt(e)}return e}function l(e){return e.map((e=>function(e){return{value:e.value,size:Object(n.k)(e.size)}}(e)))}function h(e){if("string"==typeof e||"number"==typeof e)return Object(n.k)(e);const t=e;return{type:"size",expression:t.expression,stops:l(t.stops)}}const d=e=>{const t=[],r=[],s=l(e),o=s.length;for(let a=0;a<6;a++){const e=s[Math.min(a,o-1)];t.push(e.value),r.push(null==e.size?i.n:Object(n.h)(e.size))}return{values:new Float32Array(t),sizes:new Float32Array(r)}};function f(e){const t=e&&e.length>0?{}:null,r=t?{}:null;if(!t)return{vvFields:t,vvRanges:r};for(const s of e)if(s.field&&(t[s.type]=s.field),"size"===s.type){r.size||(r.size={});const e=s;switch(Object(u.a)(e)){case o.e.SIZE_MINMAX_VALUE:r.size.minMaxValue={minDataValue:e.minDataValue,maxDataValue:e.maxDataValue,minSize:h(e.minSize),maxSize:h(e.maxSize)};break;case o.e.SIZE_SCALE_STOPS:r.size.scaleStops={stops:l(e.stops)};break;case o.e.SIZE_FIELD_STOPS:if(e.levels){const t={};for(const r in e.levels)t[r]=d(e.levels[r]);r.size.fieldStops={type:"level-dependent",levels:t}}else r.size.fieldStops={type:"static",...d(e.stops)};break;case o.e.SIZE_UNIT_VALUE:r.size.unitValue={unit:e.valueUnit,valueRepresentation:e.valueRepresentation}}}else if("color"===s.type)r.color=m(s);else if("opacity"===s.type)r.opacity=p(s);else if("rotation"===s.type){const e=s;r.rotation={type:e.rotationType}}return{vvFields:t,vvRanges:r}}function p(e){const t={values:[0,0,0,0,0,0,0,0],opacities:[0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;{if(e.stops.length>8)return null;const r=e.stops;for(let e=0;e<8;++e){const s=r[Math.min(e,r.length-1)];t.values[e]=s.value,t.opacities[e]=s.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const r=e.stops&&e.stops.length>=0&&e.stops[0].opacity;for(let e=0;e<8;e++)t.values[e]=1/0,t.opacities[e]=r}}return t}function g(e,t,r){e[4*t+0]=r.r/255,e[4*t+1]=r.g/255,e[4*t+2]=r.b/255,e[4*t+3]=r.a}function m(e){if(Object(s.j)(e))return null;if(e.normalizationField)return null;const t={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;{if(e.stops.length>8)return null;t.field=e.field;const r=e.stops;for(let e=0;e<8;++e){const s=r[Math.min(e,r.length-1)];t.values[e]=s.value,g(t.colors,e,s.color)}}}else{if(!(e.stops&&e.stops.length>=0))return null;{const r=e.stops&&e.stops.length>=0&&e.stops[0].color;for(let e=0;e<8;e++)t.values[e]=1/0,g(t.colors,e,r)}}for(let r=0;r<32;r+=4)Object(a.b)(t.colors,r,!0);return t}},552:function(e,t,r){"use strict";var s=r(79),n=r(128),i=r(242),o=r(510),a=r(427),u=r(417);const c={added:[],removed:[]},l=new Set,h=new i.a(0,0,0,0);class d extends n.a{constructor(e){super(),this._tiles=new Map,this._index=Object(u.a)(9,Object(s.a)("csp-restrictions")?e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=e}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(e){return this._tiles.has(e)}get(e){return this._tiles.get(e)}findByKey(e){return this._tiles.get(e.id)}minLOD(){return Math.min(...this.tiles.map((e=>e.level)))}intersections(e,t){const r="string"==typeof e?this.get(e):e;if(!r)return[];const s=t*r.resolution,n=r.bounds[0]-s,i=r.bounds[1]-s,o=r.bounds[2]+s,a=r.bounds[3]+s,u=[];for(const c of this._index.search({minX:n,minY:i,maxX:o,maxY:a})){const e=c.bounds.slice();e[0]=Math.max(e[0],n),e[1]=Math.max(e[1],i),e[2]=Math.min(e[2],o),e[3]=Math.min(e[3],a),e[2]-e[0]>0&&e[3]-e[1]>0&&u.push({bounds:e,tile:c})}return u}boundsIntersections(e){return this._index.search({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]})}updateTiles(e){const t={added:[],removed:[]};for(const r of e.added)if(!this.has(r)){const e=new a.a(this.tileScheme,r);this._tiles.set(r,e),this._index.insert(e),t.added.push(e)}for(const r of e.removed)if(this.has(r)){const e=this.get(r);this._tiles.delete(r),this._index.remove(e),t.removed.push(e)}this.tiles.length=0,this._tiles.forEach((e=>this.tiles.push(e))),(t.added.length||t.removed.length)&&this.emit("update",t)}setViewState(e){const t=this.tileScheme.getTileCoverage(e,0);if(!t)return;const{spans:r,lodInfo:s}=t,{level:n}=s;if(r.length>0)for(const{row:i,colFrom:o,colTo:u}of r)for(let e=o;e<=u;e++){const t=h.set(n,i,s.normalizeCol(e),s.getWorldForColumn(e)).id;if(l.add(t),!this.has(t)){const e=new a.a(this.tileScheme,t);this._tiles.set(t,e),this._index.insert(e),this.tiles.push(e),c.added.push(e)}}for(let i=this.tiles.length-1;i>=0;i--){const e=this.tiles[i];l.has(e.id)||(this._tiles.delete(e.id),this.tiles.splice(i,1),this._index.remove(e),c.removed.push(e))}(c.added.length||c.removed.length)&&this.emit("update",c),o.a.pool.release(t),l.clear(),c.added.length=0,c.removed.length=0}}t.a=d},560:function(e,t,r){"use strict";r.d(t,"a",(function(){return u}));var s=r(402);const n=2147483648;class i{constructor(){this._freeIds=[],this._idCounter=1}createId(e=!1){return function(e,t){return((t?n:0)|e)>>>0}(this._getFreeId(),e)}releaseId(e){this._freeIds.push(e)}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}function o(e,t,r){if(!(e.length>t))for(;e.length<=t;)e.push(r)}const a=2147483647;class u{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new i,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}createBitset(){const e=this._bitsets.length;return this._bitsets.push(s.a.create(this._allocatedSize,a)),e+1}getBitset(e){return this._bitsets[e-1]}_expand(){this._allocatedSize<<=1;for(const e of this._bitsets)e.resize(this._allocatedSize)}_ensureNumeric(e,t){this._numerics[e]||(this._numerics[e]=[]),o(this._numerics[e],t,0)}_ensureInstanceId(e){o(this._instanceIds,e,0)}_ensureString(e,t){this._strings[e]||(this._strings[e]=[]),o(this._strings[e],t,null)}createDisplayId(e=!1){const t=this._idGenerator.createId();return t>this._allocatedSize&&this._expand(),((e,t)=>((t?2147483648:0)|e)>>>0)(t,e)}releaseDisplayId(e){for(const t of this._bitsets)t.unset(e);return this._idGenerator.releaseId(e&a)}getComputedNumeric(e,t){return this.getComputedNumericAtIndex(e&a,0)}setComputedNumeric(e,t,r){return this.setComputedNumericAtIndex(e&a,r,0)}getComputedString(e,t){return this.getComputedStringAtIndex(e&a,0)}setComputedString(e,t,r){return this.setComputedStringAtIndex(e&a,0,r)}getComputedNumericAtIndex(e,t){const r=e&a;return this._ensureNumeric(t,r),this._numerics[t][r]}setComputedNumericAtIndex(e,t,r){const s=e&a;this._ensureNumeric(t,s),this._numerics[t][s]=r}getInstanceId(e){const t=e&a;return this._ensureInstanceId(t),this._instanceIds[t]}setInstanceId(e,t){const r=e&a;this._ensureInstanceId(r),this._instanceIds[r]=t}getComputedStringAtIndex(e,t){const r=e&a;return this._ensureString(t,r),this._strings[t][r]}setComputedStringAtIndex(e,t,r){const s=e&a;this._ensureString(t,s),this._strings[t][s]=r}getXMin(e){return this._bounds[4*(e&a)]}getYMin(e){return this._bounds[4*(e&a)+1]}getXMax(e){return this._bounds[4*(e&a)+2]}getYMax(e){return this._bounds[4*(e&a)+3]}setBounds(e,t){const r=t.readHydratedGeometry();if(!r||!r.coords.length)return!1;let s=1/0,n=1/0,i=-1/0,u=-1/0;r.forEachVertex(((e,t)=>{s=Math.min(s,e),n=Math.min(n,t),i=Math.max(i,e),u=Math.max(u,t)}));const c=e&a;return o(this._bounds,4*c+4,0),this._bounds[4*c]=s,this._bounds[4*c+1]=n,this._bounds[4*c+2]=i,this._bounds[4*c+3]=u,!0}}},664:function(e,t,r){"use strict";var s=r(88);t.a=class{constructor(e=Number.POSITIVE_INFINITY){this.size=0,this._start=0,this.maxSize=e,this._buffer=isFinite(e)?new Array(e):[]}get entries(){return this._buffer}enqueue(e){if(this.size===this.maxSize){const t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return isFinite(this.maxSize)?this._buffer[(this._start+this.size++)%this.maxSize]=e:this._buffer[this._start+this.size++]=e,null}dequeue(){if(0===this.size)return null;const e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}peek(){return 0===this.size?null:this._buffer[this._start]}find(e){if(0===this.size)return null;for(const t of this._buffer)if(Object(s.k)(t)&&e(t))return t;return null}clear(e){let t=this.dequeue();for(;Object(s.k)(t);)e&&e(t),t=this.dequeue()}}},666:function(e,t,r){"use strict";r.d(t,"a",(function(){return p})),r.d(t,"b",(function(){return O})),r.d(t,"c",(function(){return v})),r.d(t,"d",(function(){return x})),r.d(t,"e",(function(){return w})),r.d(t,"f",(function(){return _}));var s=r(88),n=r(93),i=r(110),o=r(368),a=r(98),u=r(115),c=r(233),l=r(175),h=r(165),d=(r(466),r(397));const f=new n.a({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"}),p=Object.freeze({}),g=new l.a,m=new l.a,y=new l.a,b={esriGeometryPoint:h.m,esriGeometryPolyline:h.o,esriGeometryPolygon:h.n,esriGeometryMultipoint:h.l};function _(e,t,r,s=e.hasZ,n=e.hasM){const i=e.hasZ&&s,o=e.hasM&&n;if(r){const a=Object(h.u)(y,t,e.hasZ,e.hasM,"esriGeometryPoint",r,s,n);return Object(h.m)(a,i,o)}return Object(h.m)(t,i,o)}function v(e,t,r,s,n,i,o=t,a=r){const u=t&&o,c=r&&a,l=s?"coords"in s?s:s.geometry:null;if(!l)return null;if(n){let s=Object(h.q)(m,l,t,r,e,n,o,a);return i&&(s=Object(h.u)(y,s,u,c,e,i)),b[e](s,u,c)}if(i){const s=Object(h.u)(y,l,t,r,e,i,o,a);return b[e](s,u,c)}return Object(h.x)(g,l,t,r,o,a),b[e](g,u,c)}async function x(e,t,r){const{outFields:s,orderByFields:n,groupByFieldsForStatistics:i,outStatistics:o}=e;if(s)for(let a=0;a<s.length;a++)s[a]=s[a].trim();if(n)for(let a=0;a<n.length;a++)n[a]=n[a].trim();if(i)for(let a=0;a<i.length;a++)i[a]=i[a].trim();if(o)for(let a=0;a<o.length;a++)o[a].onStatisticField&&(o[a].onStatisticField=o[a].onStatisticField.trim());return e.geometry&&!e.outSR&&(e.outSR=e.geometry.spatialReference),w(e,t,r)}async function w(e,t,n){if(!e)return null;let{where:l}=e;if(e.where=l=l&&l.trim(),(!l||/^1 *= *1$/.test(l)||t&&t===l)&&(e.where=null),!e.geometry)return e;let h=await async function(e){const{geometry:t,distance:s,units:n}=e;if(null==s||"vertexAttributes"in t)return t;const o=t.spatialReference,a=n?f.fromJSON(n):Object(u.h)(o),c=o&&(Object(i.f)(o)||Object(i.m)(o))?t:await Object(d.a)(o,i.a).then((()=>Object(d.b)(t,i.a)));return(await async function(){return(await Promise.all([r.e(9),r.e(28)]).then(r.bind(null,785))).geodesicBuffer}())(c.spatialReference,c,s,a)}(e);if(e.distance=0,e.units=null,"esriSpatialRelEnvelopeIntersects"===e.spatialRel){const{spatialReference:t}=e.geometry;h=Object(o.a)(h),h.spatialReference=t}e.geometry=h,await Object(d.a)(h.spatialReference,n);const g=(await Object(c.a)(Object(a.a)(h)))[0];if(Object(s.j)(g))throw p;const m=g.toJSON(),y=await Object(d.b)(m,m.spatialReference,n);if(!y)throw p;return y.spatialReference=n,e.geometry=y,e}function O(e){return e&&j in e?JSON.parse(JSON.stringify(e,I)):e}const j="_geVersion",I=(e,t)=>e!==j?t:void 0},708:function(e,t,r){"use strict";r.d(t,"a",(function(){return u}));var s=r(88),n=r(92),i=r(238),o=r(456);class a{constructor(e,t){this.item=e,this.controller=t,this.promise=null}}class u{constructor(e){this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new o.a(e.peeker),this.process=e.process;const t=e.scheduler;e.task&&Object(s.k)(t)&&(this._task=t.registerTask(e.task,(e=>this.update(e)),(()=>this.needsUpdate())))}destroy(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}get length(){return this._processingItems.size+this._queue.length}abort(e){const t=this._controllers.get(e);t&&t.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach((t=>e.push(t))),this._controllers.clear(),e.forEach((e=>e.abort())),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach(((t,r)=>e(r)))}get(e){const t=this._deferreds.get(e);return t?t.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext())}push(e,t){const r=this.get(e);if(r)return r;const i=Object(n.d)();let o=null;t&&(o=Object(n.p)(t,(()=>i.abort())));const a=()=>{u.remove(),Object(s.k)(o)&&o.remove(),this._deferreds.delete(e),this._controllers.delete(e),this._queue.remove(e),this._processingItems.delete(e),this._scheduleNext()},u=Object(n.q)(i.signal,(()=>{const t=this._processingItems.get(e);t&&t.controller.abort(),a(),c.reject(Object(n.e)())})),c=Object(n.f)();return this._deferreds.set(e,c),this._controllers.set(e,i),c.promise.then(a,a),this._queue.push(e),this._scheduleNext(),c.promise}reset(){const e=[];this._processingItems.forEach((t=>e.push(t))),this._processingItems.clear();for(const t of e)this._queue.push(t.item),t.controller.abort();this._scheduleNext()}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}needsUpdate(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}update(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_scheduleNext(){this._task||this._isPaused||this._schedule||(this._schedule=Object(i.b)((()=>{this._schedule=null,this._next()})))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))}_processError(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(Object(s.j)(e))return;let t;const r=Object(n.d)(),i=new a(e,r);this._processingItems.set(e,i);try{t=this.process(e,r.signal)}catch(o){this._processError(i,o)}Object(n.o)(t)?(i.promise=t,t.then((e=>this._processResult(i,e)),(e=>this._processError(i,e)))):this._processResult(i,t)}get test(){return{update:e=>this.update(e)}}}},752:function(e,t,r){"use strict";function s(e,t){if(!e)return null;const r=t.featureAdapter,{startTimeField:s,endTimeField:n}=e;let i=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;if(s&&n)t.forEach((e=>{const t=r.getAttribute(e,s),a=r.getAttribute(e,n);null==t||isNaN(t)||(i=Math.min(i,t)),null==a||isNaN(a)||(o=Math.max(o,a))}));else{const e=s||n;t.forEach((t=>{const s=r.getAttribute(t,e);null==s||isNaN(s)||(i=Math.min(i,s),o=Math.max(o,s))}))}return{start:i,end:o}}function n(e,t,r){if(!t||!e)return null;const{startTimeField:s,endTimeField:n}=e;if(!s&&!n)return null;const{start:i,end:o}=t;return null===i&&null===o?null:void 0===i&&void 0===o?()=>!1:s&&n?function(e,t,r,s,n){return null!=s&&null!=n?i=>{const o=e.getAttribute(i,t),a=e.getAttribute(i,r);return(null==o||o<=n)&&(null==a||a>=s)}:null!=s?t=>{const n=e.getAttribute(t,r);return null==n||n>=s}:null!=n?r=>{const s=e.getAttribute(r,t);return null==s||s<=n}:void 0}(r,s,n,i,o):function(e,t,r,s){return null!=r&&null!=s&&r===s?s=>e.getAttribute(s,t)===r:null!=r&&null!=s?n=>{const i=e.getAttribute(n,t);return i>=r&&i<=s}:null!=r?s=>e.getAttribute(s,t)>=r:null!=s?r=>e.getAttribute(r,t)<=s:void 0}(r,s||n,i,o)}r.d(t,"a",(function(){return s})),r.d(t,"b",(function(){return n}))},763:function(e,t,r){"use strict";var s=r(90),n=r(88),i=r(91),o=r(110),a=r(207),u=r(98),c=r(115),l=r(122),h=r(320),d=r(233),f=r(210),p=r(204),g=r(834),m=r(276),y=r(397),b=r(400),_=r(269);const v=new class{constructor(e,t){this._cache=new b.a(e),this._invalidCache=new b.a(t)}get(e,t){const r=`${t.uid}:${e}`,s=this._cache.get(r);if(s)return s;if(void 0!==this._invalidCache.get(r))return null;try{const s=_.WhereClause.create(e,t);return this._cache.put(r,s),s}catch{return this._invalidCache.put(r,null),null}}}(50,500),x="feature-store:unsupported-query",w=" as ",O=new Set(["esriFieldTypeOID","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeDate"]);function j(e,t){return e?v.get(e,t):null}function I(e,t,r,s=!0){const n=[];for(const a of t)if("*"!==a&&!e.has(a))if(s){const t=S(a);try{const r=j(t,e);if(!r)throw new i.a(x,"invalid SQL expression",{where:t});if(!r.isStandardized)throw new i.a(x,"expression is not standard",{clause:r});I(e,r.fieldNames,"expression contains missing fields")}catch(o){const e=o&&o.details;if(e&&(e.clause||e.where))throw o;e&&e.missingFields?n.push(...e.missingFields):n.push(a)}}else n.push(a);if(n.length)throw new i.a(x,r,{missingFields:n})}function S(e){return e.split(w)[0]}function T(e,t){const r=t.get(e);return!!r&&!O.has(r.type)}var F=r(666),M=r(874),k=r(752),C=r(165),R=r(308);var A=class{constructor(e,t,r){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=e.returnDistinctValues,this.fieldsIndex=r,this.featureAdapter=t;const s=e.outFields;if(s&&-1===s.indexOf("*")){this.outFields=s;let e=0;for(const t of s){const s=S(t),n=this.fieldsIndex.get(s),i=n?null:j(s,r),o=n?n.name:t.split(w)[1]||"FIELD_EXP_"+e++;this._fieldDataCache.set(t,{alias:o,clause:i})}}}countDistinctValues(e){return this.returnDistinctValues?(e.forEach((e=>this.getAttributes(e))),this._returnDistinctMap.size):e.length}getAttributes(e){const t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}getFieldValue(e,t,r){const s=r?r.name:t;let n=null;return this._fieldDataCache.has(s)?n=this._fieldDataCache.get(s).clause:r||(n=j(t,this.fieldsIndex),this._fieldDataCache.set(s,{alias:s,clause:n})),r?this.featureAdapter.getAttribute(e,s):n.calculateValue(e,this.featureAdapter)}validateItem(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:j(t,this.fieldsIndex)}),this._fieldDataCache.get(t).clause.testFeature(e,this.featureAdapter)}validateItems(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:j(t,this.fieldsIndex)}),this._fieldDataCache.get(t).clause.testSet(e,this.featureAdapter)}_processAttributesForOutFields(e){const t=this.outFields;if(!t||!t.length)return this.featureAdapter.getAttributes(e);const r={};for(const s of t){const{alias:t,clause:n}=this._fieldDataCache.get(s);r[t]=n?n.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,t)}return r}_processAttributesForDistinctValues(e){if(Object(n.j)(e)||!this.returnDistinctValues)return e;const t=this.outFields,r=[];if(t)for(const n of t){const{alias:t}=this._fieldDataCache.get(n);r.push(e[t])}else for(const n in e)r.push(e[n]);const s=`${(t||["*"]).join(",")}=${r.join(",")}`;let i=this._returnDistinctMap.get(s)||0;return this._returnDistinctMap.set(s,++i),i>1?null:e}};function E(e){return e.substr(24,12)+e.substr(19,4)+e.substr(16,2)+e.substr(14,2)+e.substr(11,2)+e.substr(9,2)+e.substr(6,2)+e.substr(4,2)+e.substr(2,2)+e.substr(0,2)}function N(e,t,r){return(r?e>t:e<t)?-1:(r?e<t:e>t)?1:0}function P(e,t,r){return r?t-e:e-t}function q(e,t,r,s){if(r&&"esriFieldTypeDate"===r.type){const r=new Date(e).getTime(),n=new Date(t).getTime();if(!isNaN(r)&&!isNaN(n))return P(r,n,s)}if("number"==typeof e&&"number"==typeof t)return P(e,t,s);if("string"==typeof e&&"string"==typeof t){const n=e.toUpperCase(),i=t.toUpperCase();return!r||"esriFieldTypeGUID"!==r.type&&"esriFieldTypeGlobalID"!==r.type?N(n,i,s):N(E(n),E(i),s)}return s?1:-1}class z{constructor(e,t,r){this.items=e,this.queryGeometry=t,this.definitionExpression=r.definitionExpression,this.geometryType=r.geometryType,this.hasM=r.hasM,this.hasZ=r.hasZ,this.objectIdField=r.objectIdField,this.spatialReference=r.spatialReference,this.fieldsIndex=r.fieldsIndex,this.timeInfo=r.timeInfo,this.featureAdapter=r.featureAdapter,this.aggregateAdapter=r.aggregateAdapter}get size(){return this.items.length}createQueryResponseForCount(e){const t=new A(e,this.featureAdapter,this.fieldsIndex);if(!e.outStatistics)return t.countDistinctValues(this.items);const{groupByFieldsForStatistics:r,having:s}=e;if(!(null==r?void 0:r.length))return 1;const n=new Map,i=new Map,o=new Set,a=e.outStatistics;for(const u of a){const{statisticType:e}=u,a="exceedslimit"!==e?u.onStatisticField:void 0;if(!i.has(a)){const e=[];for(const s of r){const r=this._getAttributeValues(t,s,n);e.push(r)}i.set(a,this._calculateUniqueValues(e))}const c=i.get(a);for(const r in c){const{data:e,items:n}=c[r],i=e.join(",");s&&!t.validateItems(n,s)||o.add(i)}}return o.size}createQueryResponse(e){let t;return t=e.outStatistics?e.outStatistics.some((e=>"exceedslimit"===e.statisticType))?this._createExceedsLimitQueryResponse(e):this._createStatisticsQueryResponse(e):this._createFeatureQueryResponse(e),e.returnQueryGeometry&&(Object(o.i)(e.outSR)&&!Object(o.c)(this.queryGeometry.spatialReference,e.outSR)?t.queryGeometry=Object(F.b)({spatialReference:e.outSR,...Object(y.b)(this.queryGeometry,this.queryGeometry.spatialReference,e.outSR)}):t.queryGeometry=Object(F.b)({spatialReference:e.outSR,...this.queryGeometry})),t}createSnappingResponse(e,t){const r=this.featureAdapter,s=function(e,t){return e?t?4:3:t?3:2}(this.hasZ,this.hasM),{x:n,y:i}=e.point,o="number"==typeof e.distance?e.distance:e.distance.x,a="number"==typeof e.distance?e.distance:e.distance.y,u={candidates:[]},c="esriGeometryPolygon"===this.geometryType,l=this.getPointCreator(e.point,this.spatialReference,t);for(const h of this.items){const t=r.getGeometry(h);if(!t)continue;const{coords:d,lengths:f}=t;if(1&e.types){let e=0;for(let t=0;t<f.length;t++){const c=f[t];for(let t=0;t<c;t++,e+=s){const f=d[e],p=d[e+1];if(t!==c-1){const t=d[e+s],c=d[e+s+1],{x:g,y:m}=D(n,i,f,p,t,c),y=(n-g)/o,b=(i-m)/a,_=y*y+b*b;_<=1&&u.candidates.push({type:"edge",objectId:r.getObjectId(h),distance:Math.sqrt(_),target:l(g,m),start:l(f,p),end:l(t,c)})}}}}if(2&e.types){const e=c?d.length-s:d.length;for(let t=0;t<e;t+=s){const e=d[t],s=d[t+1],c=(n-e)/o,f=(i-s)/a,p=c*c+f*f;p<=1&&u.candidates.push({type:"vertex",objectId:r.getObjectId(h),distance:Math.sqrt(p),target:l(e,s)})}}}return u.candidates.sort(((e,t)=>e.distance-t.distance)),u}getPointCreator(e,t,r){const s=Object(n.k)(r)&&!Object(o.c)(t,r)?e=>Object(y.b)(e,t,r):e=>e;return null!=e.z&&null!=e.m?(t,r)=>s({x:t,y:r,z:e.z,m:e.m}):null!=e.z?(t,r)=>s({x:t,y:r,z:e.z}):null!=e.m?(t,r)=>s({x:t,y:r,m:e.m}):(e,t)=>s({x:e,y:t})}executeAttributesQuery(e){const t=j(e.where,this.fieldsIndex);if(!t)return Promise.resolve(this);if(t.isStandardized){let r=0;const s=[];for(const e of this.items)t.testFeature(e,this.featureAdapter)&&(s[r++]=e);const n=new z(s,this.queryGeometry,this);return n.definitionExpression=e.where,Promise.resolve(n)}return Promise.reject(new TypeError("Where clause is not standardized"))}executeAggregateIdsQuery(e){if(!e.aggregateIds||!e.aggregateIds.length||Object(n.j)(this.aggregateAdapter))return Promise.resolve(this);const t=new Set;for(const s of e.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(s).forEach((e=>t.add(e)));const r=this.featureAdapter.getObjectId;return Promise.resolve(new z(this.items.filter((e=>t.has(r(e)))),this.queryGeometry,this))}executeObjectIdsQuery(e){if(!e.objectIds||!e.objectIds.length)return Promise.resolve(this);const t=new Set(e.objectIds),r=this.featureAdapter.getObjectId;return Promise.resolve(new z(this.items.filter((e=>t.has(r(e)))),this.queryGeometry,this))}executeTimeQuery(e){const t=Object(k.b)(this.timeInfo,e.timeExtent,this.featureAdapter);if(!Object(n.k)(t))return Promise.resolve(this);const r=this.items.filter(t);return Promise.resolve(new z(r,this.queryGeometry,this))}filterLatest(){const{trackIdField:e,startTimeField:t,endTimeField:r}=this.timeInfo,s=r||t,n=new Map,i=this.featureAdapter.getAttribute;for(const a of this.items){const t=i(a,e),r=i(a,s),o=n.get(t);(!o||r>i(o,s))&&n.set(t,a)}const o=Array.from(n.values());return Promise.resolve(new z(o,this.queryGeometry,this))}async project(e){if(!e||Object(o.c)(this.spatialReference,e))return this;const t=this.featureAdapter,r=(await Object(y.c)(this.items.map((e=>Object(F.c)(this.geometryType,this.hasZ,this.hasM,t.getGeometry(e)))),this.spatialReference,e)).map(((e,r)=>t.cloneWithGeometry(this.items[r],Object(C.d)(e,this.hasZ,this.hasM))));return new z(r,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:e,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})}_sortFeatures(e,t,r){if(e.length>1&&t&&t.length)for(const s of t.reverse()){const t=s.split(" "),n=t[0],i=this.fieldsIndex.get(n),o=t[1]&&"desc"===t[1].toLowerCase();e.sort(((e,t)=>q(r(e,n,i),r(t,n,i),i,o)))}}_createFeatureQueryResponse(e){const t=this.items,{geometryType:r,hasM:s,hasZ:n,objectIdField:i,spatialReference:o}=this,{outFields:a,outSR:u,quantizationParameters:c,resultRecordCount:l,resultOffset:h,returnZ:d,returnM:f}=e,p=null!=l&&t.length>(h||0)+l,g=a&&(a.indexOf("*")>-1?[...this.fieldsIndex.fields]:a.map((e=>this.fieldsIndex.get(e))));return{exceededTransferLimit:p,features:this._createFeatures(e,t),fields:g,geometryType:r,hasM:s&&f,hasZ:n&&d,objectIdFieldName:i,spatialReference:Object(F.b)(u||o),transform:c&&Object(R.c)(c)||null}}_createFeatures(e,t){const r=new A(e,this.featureAdapter,this.fieldsIndex),{hasM:s,hasZ:n}=this,{orderByFields:i,quantizationParameters:o,returnGeometry:a,returnCentroid:u,maxAllowableOffset:c,resultOffset:l,resultRecordCount:h,returnZ:d=!1,returnM:f=!1}=e,p=n&&d,g=s&&f;let m=[],y=0;const b=[...t];if(this._sortFeatures(b,i,((e,t,s)=>r.getFieldValue(e,t,s))),a||u){const e=Object(R.c)(o);if(a&&!u)for(const t of b)m[y++]={attributes:r.getAttributes(t),geometry:Object(F.c)(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),c,e,p,g)};else if(!a&&u)for(const t of b)m[y++]={attributes:r.getAttributes(t),centroid:Object(F.f)(this,this.featureAdapter.getCentroid(t,this),e)};else for(const t of b)m[y++]={attributes:r.getAttributes(t),centroid:Object(F.f)(this,this.featureAdapter.getCentroid(t,this),e),geometry:Object(F.c)(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(t),c,e,p,g)}}else for(const v of b){const e=r.getAttributes(v);e&&(m[y++]={attributes:e})}const _=l||0;if(null!=h){const e=_+h;m=m.slice(_,Math.min(m.length,e))}return m}_createExceedsLimitQueryResponse(e){let t=!1,r=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,n=Number.POSITIVE_INFINITY;for(const i of e.outStatistics)if("exceedslimit"===i.statisticType){r=null!=i.maxPointCount?i.maxPointCount:Number.POSITIVE_INFINITY,s=null!=i.maxRecordCount?i.maxRecordCount:Number.POSITIVE_INFINITY,n=null!=i.maxVertexCount?i.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)t=this.items.length>r;else if(this.items.length>s)t=!0;else{const e=this.hasZ?this.hasM?4:3:this.hasM?3:2,r=this.featureAdapter;t=this.items.reduce(((e,t)=>{const s=r.getGeometry(t);return e+(s&&s.coords.length||0)}),0)/e>n}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(t)}}]}}_createStatisticsQueryResponse(e){const t={attributes:{}},r=[],s=new Map,n=new Map,i=new Map,o=new Map,a=new A(e,this.featureAdapter,this.fieldsIndex),u=e.outStatistics,{groupByFieldsForStatistics:c,having:l,orderByFields:h}=e,d=c&&c.length,f=!!d,p=f&&c[0],g=f&&!this.fieldsIndex.get(p);for(const y of u){const{outStatisticFieldName:e,statisticType:u}=y,h=y,m="exceedslimit"!==u?y.onStatisticField:void 0,b="percentile_disc"===u||"percentile_cont"===u,_=f&&1===d&&(m===p||g)&&"count"===u;if(f){if(!i.has(m)){const e=[];for(const t of c){const r=this._getAttributeValues(a,t,s);e.push(r)}i.set(m,this._calculateUniqueValues(e,a.returnDistinctValues))}const t=i.get(m);for(const r in t){const{count:n,data:i,items:u,itemPositions:d}=t[r],f=i.join(",");if(!l||a.validateItems(u,l)){const t=o.get(f)||{attributes:{}};let r=null;if(_)r=n;else{const e=this._getAttributeValues(a,m,s),t=d.map((t=>e[t]));r=b&&"statisticParameters"in h?this._getPercentileValue(h,t):this._getStatisticValue(h,t)}t.attributes[e]=r,c.forEach(((e,r)=>t.attributes[this.fieldsIndex.get(e)?e:`EXPR_${r+1}`]=i[r])),o.set(f,t)}}}else{const r=this._getAttributeValues(a,m,s);t.attributes[e]=b&&"statisticParameters"in h?this._getPercentileValue(h,r):this._getStatisticValue(h,r,n)}r.push({name:e,alias:e,type:"esriFieldTypeDouble"})}const m=f?Array.from(o.values()):[t];return this._sortFeatures(m,h,((e,t)=>e.attributes[t])),{fields:r,features:m}}_getStatisticValue(e,t,r){const{onStatisticField:s,statisticType:n}=e,i=r&&r.has(s)?r.get(s):this._calculateStatistics(t);return r&&r.set(s,i),i["var"===n?"variance":n]}_getPercentileValue(e,t){const{onStatisticField:r,statisticParameters:s,statisticType:n}=e,{value:i,orderBy:o}=s,a="desc"===o,u=this.fieldsIndex.get(r),c=[...t].filter((e=>null!=e)).sort(((e,t)=>q(e,t,u,a)));return this._calculatePercentile(c,i,"percentile_disc"===n)}_getAttributeValues(e,t,r){if(r.has(t))return r.get(t);const s=this.fieldsIndex.get(t),n=this.items.map((r=>e.getFieldValue(r,t,s)));return r.set(t,n),n}_calculateStatistics(e){let t=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY,s=null,n=null,i=null,o=null;const a=[];let u=0;for(const c of e)"string"==typeof c?u++:null==c||isNaN(c)||(s+=c,t=Math.min(t,c),r=Math.max(r,c),a.push(c),u++);if(u){n=s/u;let e=0;for(const t of a)e+=(t-n)**2;o=u>1?e/(u-1):0,i=Math.sqrt(o)}else t=null,r=null;return{avg:n,count:u,max:r,min:t,stddev:i,sum:s,variance:o}}_calculateUniqueValues(e,t){const r={},s=this.items,n=s.length;for(let i=0;i<n;i++){const n=s[i],o=[];for(const t of e)o.push(t[i]);const a=o.join(",");t?null==r[a]&&(r[a]={count:1,data:o,items:[n],itemPositions:[i]}):null==r[a]?r[a]={count:1,data:o,items:[n],itemPositions:[i]}:(r[a].count++,r[a].items.push(n),r[a].itemPositions.push(i))}return r}_calculatePercentile(e,t,r){if(0===e.length)return null;if(t<=0)return e[0];if(t>=1)return e[e.length-1];const s=(e.length-1)*t,n=Math.floor(s),i=n+1,o=s%1,a=e[n],u=e[i];return i>=e.length||r||"string"==typeof a||"string"==typeof u?a:a*(1-o)+u*o}}function D(e,t,r,s,n,i){const o=n-r,a=i-s,u=o*o+a*a,c=(e-r)*o+(t-s)*a,l=Math.min(1,Math.max(0,c/u));return{x:r+o*l,y:s+a*l}}var G=z;const L="feature-store:unsupported-query";const U=new Set,B=new f.b(2e6);let V=0;const Q=Object(m.d)(),Y=Object(m.d)();t.a=class{constructor(e){this.capabilities={query:g.a},this.geometryType=e.geometryType,this.hasM=e.hasM,this.hasZ=e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._changeHandle=this.featureStore.events.on("changed",(()=>this.clearCache())),this.timeInfo=e.timeInfo,e.cacheSpatialQueries&&(this._geometryQueryCache=new f.a(V+++"$$",B)),this.fieldsIndex=new p.a(e.fields),e.scheduler&&e.task&&(this._frameQueue=new h.a,this._frameTask=e.scheduler.registerTask(e.task,(e=>this._update(e)),(()=>this._frameQueue.length>0)))}destroy(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null),this.clearCache(),this._geometryQueryCache&&this._geometryQueryCache.destroy(),this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null),this.fieldsIndex.destroy()}get featureAdapter(){return this.featureStore.featureAdapter}get fullExtent(){const e=this.featureStore.fullBounds;return e?{xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:Object(F.b)(this.spatialReference)}:null}get timeExtent(){return this.timeInfo?(this._timeExtent||(this._timeExtent=Object(k.a)(this.timeInfo,this.featureStore)),this._timeExtent):null}clearCache(){this._geometryQueryCache&&this._geometryQueryCache.clear(),this._allItems=null,this._timeExtent=null}async executeQuery(e={},t){let r,n=Object(s.a)(e);try{n=await this._schedule((()=>Object(F.d)(n,this.definitionExpression,this.spatialReference)),t),n=await this._reschedule((()=>this._checkQuerySupport(n)),t),r=await this._reschedule((()=>this._executeGeometryQuery(n,t)),t),r=await this._reschedule((()=>r.executeAggregateIdsQuery(n)),t),r=await this._reschedule((()=>r.executeObjectIdsQuery(n)),t),r=await this._reschedule((()=>r.executeTimeQuery(n)),t),r=await this._reschedule((()=>r.executeAttributesQuery(n)),t)}catch(i){if(i!==F.a)throw i;r=new G([],null,this)}return r.createQueryResponse(n)}async executeQueryForCount(e={},t){let r,n=Object(s.a)(e);n.returnGeometry=!1,n.returnCentroid=!1,n.outSR=null;try{n=await this._schedule((()=>Object(F.d)(n,this.definitionExpression,this.spatialReference)),t),n=await this._reschedule((()=>this._checkQuerySupport(n)),t),r=await this._reschedule((()=>this._executeGeometryQuery(n,t)),t),r=await this._reschedule((()=>r.executeAggregateIdsQuery(n)),t),r=await this._reschedule((()=>r.executeObjectIdsQuery(n)),t),r=await this._reschedule((()=>r.executeTimeQuery(n)),t),r=await this._reschedule((()=>r.executeAttributesQuery(n)),t)}catch(i){if(i!==F.a)throw i;return 0}return r.createQueryResponseForCount(n)}async executeQueryForExtent(e={},t){let r,n=Object(s.a)(e);const i=n.outSR;try{n=await this._schedule((()=>Object(F.d)(n,this.definitionExpression,this.spatialReference)),t),n=await this._reschedule((()=>this._checkQuerySupport(n)),t),n.returnGeometry=!0,n.returnCentroid=!1,n.outSR=null,r=await this._reschedule((()=>this._executeGeometryQuery(n,t)),t),r=await this._reschedule((()=>r.executeAggregateIdsQuery(n)),t),r=await this._reschedule((()=>r.executeObjectIdsQuery(n)),t),r=await this._reschedule((()=>r.executeTimeQuery(n)),t),r=await this._reschedule((()=>r.executeAttributesQuery(n)),t);const e=r.size;if(!e)return{count:e,extent:null};Object(m.q)(Y,m.a),this.featureStore.forEachBounds(r.items,(e=>Object(m.g)(Y,e)),Q);const s={xmin:Y[0],ymin:Y[1],xmax:Y[3],ymax:Y[4],spatialReference:Object(F.b)(this.spatialReference)};this.hasZ&&isFinite(Y[2])&&isFinite(Y[5])&&(s.zmin=Y[2],s.zmax=Y[5]);const o=Object(y.b)(s,r.spatialReference,i);if(o.spatialReference=Object(F.b)(i||this.spatialReference),o.xmax-o.xmin==0){const e=Object(c.f)(o.spatialReference);o.xmin-=e,o.xmax+=e}if(o.ymax-o.ymin==0){const e=Object(c.f)(o.spatialReference);o.ymin-=e,o.ymax+=e}if(this.hasZ&&null!=o.zmin&&null!=o.zmax&&o.zmax-o.zmin==0){const e=Object(c.f)(o.spatialReference);o.zmin-=e,o.zmax+=e}return{count:e,extent:o}}catch(o){if(o===F.a)return{count:0,extent:null};throw o}}async executeQueryForIds(e={},t){return this.executeQueryForIdSet(e,t).then((e=>Array.from(e)))}async executeQueryForIdSet(e={},t){let r,n=Object(s.a)(e);n.returnGeometry=!1,n.returnCentroid=!1,n.outSR=null;try{n=await this._schedule((()=>Object(F.d)(n,this.definitionExpression,this.spatialReference)),t),n=await this._reschedule((()=>this._checkQuerySupport(n)),t),r=await this._reschedule((()=>this._executeGeometryQuery(n,t)),t),r=await this._reschedule((()=>r.executeAggregateIdsQuery(n)),t),r=await this._reschedule((()=>r.executeObjectIdsQuery(n)),t),r=await this._reschedule((()=>r.executeTimeQuery(n)),t),r=await this._reschedule((()=>r.executeAttributesQuery(n)),t);const e=r.items,s=new Set;return await this._reschedule((()=>{for(const t of e)s.add(r.featureAdapter.getObjectId(t))}),t),s}catch(i){if(i===F.a)return new Set;throw i}}async executeQueryForSnapping(e,t){const{point:r,distance:s,types:i}=e;if(0===i)return{candidates:[]};const a=await this._reschedule((()=>this._checkQuerySupport(e.query)),t),c=!Object(o.c)(r.spatialReference,this.spatialReference);c&&await Object(y.a)(r.spatialReference,this.spatialReference);const l="number"==typeof s?s:s.x,h="number"==typeof s?s:s.y,f={xmin:r.x-l,xmax:r.x+l,ymin:r.y-h,ymax:r.y+h,spatialReference:r.spatialReference},p=c?Object(y.b)(f,this.spatialReference):f;if(!p)return{candidates:[]};const g=(await Object(d.a)(Object(u.a)(r),null,{signal:t}))[0],m=(await Object(d.a)(Object(u.a)(p),null,{signal:t}))[0];if(Object(n.j)(g)||Object(n.j)(m))return{candidates:[]};let b=new G(this._searchFeatures(this._getQueryBBoxes(m.toJSON())),null,this);b=await this._reschedule((()=>b.executeObjectIdsQuery(a)),t),b=await this._reschedule((()=>b.executeTimeQuery(a)),t),b=await this._reschedule((()=>b.executeAttributesQuery(a)),t);const _=g.toJSON(),v=c?Object(y.b)(_,this.spatialReference):_,x=c?Math.max(p.xmax-p.xmin,p.ymax-p.ymin)/2:s;return b.createSnappingResponse({...e,point:v,distance:x},r.spatialReference)}async executeQueryForLatestObservations(e={},t){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new i.a(L,"Missing timeInfo or timeInfo.trackIdField",{query:e,timeInfo:this.timeInfo});let r,n=Object(s.a)(e);try{n=await this._schedule((()=>Object(F.d)(n,this.definitionExpression,this.spatialReference)),t),n=await this._reschedule((()=>this._checkQuerySupport(n)),t),r=await this._reschedule((()=>this._executeGeometryQuery(n,t)),t),r=await this._reschedule((()=>r.executeAggregateIdsQuery(n)),t),r=await this._reschedule((()=>r.executeObjectIdsQuery(n)),t),r=await this._reschedule((()=>r.executeTimeQuery(n)),t),r=await this._reschedule((()=>r.executeAttributesQuery(n)),t),r=await this._reschedule((()=>r.filterLatest()),t)}catch(o){if(o!==F.a)throw o;r=new G([],null,this)}return r.createQueryResponse(n)}async _schedule(e,t){return this._frameQueue?this._frameQueue.push(e,t):e()}async _reschedule(e,t){return this._frameQueue?this._frameQueue.unshift(e,t):e()}_update(e){for(this._budget=e;!e.done&&this._frameQueue&&this._frameQueue.process();)e.madeProgress();this._budget=null}_getAll(){if(!this._allItems){const e=[];this.featureStore.forEach((t=>e.push(t))),this._allItems=new G(e,null,this)}return this._allItems}async _executeGeometryQuery(e,t){const{geometry:r,outSR:s,spatialRel:i,returnGeometry:a,returnCentroid:u}=e,c=a||u,l=Object(o.i)(s)&&!Object(o.c)(this.spatialReference,s),h=this._geometryQueryCache?l&&c?JSON.stringify({geometry:r,spatialRelationship:i,outSpatialReference:s}):JSON.stringify({geometry:r,spatialRelationship:i}):null;if(h){const e=this._geometryQueryCache.get(h);if(!Object(n.l)(e))return e}const d=async e=>{if(l&&c){const t=await e.project(s);return h&&this._geometryQueryCache.put(h,t,t.size||1),t}return h&&this._geometryQueryCache.put(h,e,e.size||1),e};if(!r)return d(this._getAll());const f=this.featureAdapter;if("esriSpatialRelDisjoint"===i){const e=this._searchFeatures(this._getQueryBBoxes(r));if(!e.length)return d(this._getAll());let s,n;const o=new Set;for(const t of e)o.add(f.getObjectId(t));return await this._reschedule((()=>{let e=0;s=new Array(o.size),this.featureStore.forEach((t=>s[e++]=t)),n=o}),t),d(await this._reschedule((async()=>{const e=await Object(M.c)(i,r,this.geometryType,this.hasZ,this.hasM);return new G(await this._runSpatialFilter(s,(t=>!n.has(f.getObjectId(t))||e(f.getGeometry(t))),t),r,this)}),t))}const p=this._searchFeatures(this._getQueryBBoxes(r));if(!p.length){const e=new G([],r,this);return h&&this._geometryQueryCache.put(h,e,e.size||1),e}if(this._canExecuteSoloPass(r,e))return d(new G(p,r,this));const g=await Object(M.c)(i,r,this.geometryType,this.hasZ,this.hasM),m=await this._runSpatialFilter(p,(e=>g(f.getGeometry(e))),t);return d(new G(m,r,this))}async _runSpatialFilter(e,t,r){if(!t)return e;if(!this._budget)return e.filter((e=>t(e)));let s=0;const n=new Array,i=async()=>{for(;s<e.length;){const o=e[s];t(o)&&n.push(o),this._budget.done&&await this._reschedule((()=>i()),r),++s}};return this._reschedule((()=>i()),r).then((()=>n))}_canExecuteSoloPass(e,t){const{geometryType:r}=this,{spatialRel:s}=t;return Object(M.a)(e)&&("esriSpatialRelEnvelopeIntersects"===s||"esriGeometryPoint"===r&&("esriSpatialRelIntersects"===s||"esriSpatialRelContains"===s||"esriSpatialRelWithin"===s))}_getQueryBBoxes(e){if(Object(M.a)(e)){if(Object(u.d)(e))return[Object(l.n)(e.xmin,e.ymin,e.xmax,e.ymax)];if(Object(u.g)(e))return e.rings.map((e=>Object(l.n)(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1]))))}return[Object(a.a)(Object(l.i)(),e)]}_searchFeatures(e){for(const s of e)this.featureStore.forEachInBounds(s,(e=>{U.add(e)}));const t=new Array(U.size);let r=0;return U.forEach((e=>t[r++]=e)),U.clear(),t}async _checkQuerySupport(e){if(e.distance<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new i.a(L,"Unsupported query options",{query:e});return Promise.all([this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),Object(M.b)(e,this.geometryType,this.spatialReference),Object(y.a)(this.spatialReference,e.outSR)]).then((()=>e))}_checkAttributesQuerySupport(e){const{outFields:t,orderByFields:r,returnDistinctValues:s,outStatistics:n}=e,o=n?n.map((e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase())):[];if(r&&r.length>0){const e=" asc",t=" desc",s=r.map((r=>{const s=r.toLowerCase();return s.indexOf(e)>-1?s.split(e)[0]:s.indexOf(t)>-1?s.split(t)[0]:r})).filter((e=>-1===o.indexOf(e)));I(this.fieldsIndex,s,"orderByFields contains missing fields")}if(t&&t.length>0)I(this.fieldsIndex,t,"outFields contains missing fields");else if(s)throw new i.a(L,"outFields should be specified for returnDistinctValues",{query:e});!function(e,t){if(!t)return!0;const r=v.get(t,e);if(!r)throw new i.a(x,"invalid SQL expression",{where:t});if(!r.isStandardized)throw new i.a(x,"where clause is not standard",{where:t});I(e,r.fieldNames,"where clause contains missing fields")}(this.fieldsIndex,e.where)}async _checkStatisticsQuerySupport(e){const{outStatistics:t,groupByFieldsForStatistics:r,having:s}=e,n=r&&r.length,o=t&&t.length;if(s){if(!n||!o)throw new i.a(L,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:e});!function(e,t,r){if(!t)return!0;const s=v.get(t,e);if(!s)throw new i.a(x,"invalid SQL expression",{having:t});if(!s.isAggregate)throw new i.a(x,"having does not contain a valid aggregate function",{having:t});const n=s.fieldNames;if(I(e,n,"having contains missing fields"),!s.getExpressions().every((t=>{const{aggregateType:s,field:n}=t,i=e.has(n)&&e.get(n).name;return r.some((t=>{const{onStatisticField:r,statisticType:n}=t;return(e.has(r)&&e.get(r).name)===i&&n.toLowerCase().trim()===s}))})))throw new i.a(x,"expressions in having should also exist in outStatistics",{having:t})}(this.fieldsIndex,s,t)}if(o){if(!function(e){return e.every((e=>"exceedslimit"!==e.statisticType))}(t))return;const s=t.map((e=>e.onStatisticField));I(this.fieldsIndex,s,"onStatisticFields contains missing fields"),n&&I(this.fieldsIndex,r,"groupByFieldsForStatistics contains missing fields");for(const r of t){const{onStatisticField:t,statisticType:s}=r;if("percentile_disc"!==s&&"percentile_cont"!==s||!("statisticParameters"in r)){if("count"!==s&&t&&T(t,this.fieldsIndex))throw new i.a(L,"outStatistics contains non-numeric fields",{definition:r,query:e})}else{const{statisticParameters:t}=r;if(!t)throw new i.a(L,"statisticParamters should be set for percentile type",{definition:r,query:e})}}}}}},779:function(e,t,r){"use strict";r.d(t,"a",(function(){return a})),r.d(t,"b",(function(){return u})),r.d(t,"c",(function(){return o}));var s=r(79),n=r(90),i=r(279);function o(e){return{renderer:{type:"simple",symbol:"esriGeometryPoint"===e||"esriGeometryMultipoint"===e?i.a:"esriGeometryPolyline"===e?i.c:i.b}}}function a(e,t){if(Object(s.a)("csp-restrictions"))return()=>({[t]:null,...e});try{let r=`this.${t} = null;`;for(const t in e)r+=`this${t.indexOf(".")?`["${t}"]`:`.${t}`} = ${JSON.stringify(e[t])};`;const s=new Function(r);return()=>new s}catch(r){return()=>({[t]:null,...e})}}function u(e={}){return[{name:"New Feature",description:"",prototype:{attributes:Object(n.a)(e)}}]}},834:function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));const s={supportsStatistics:!0,supportsPercentileStatistics:!0,supportsCentroid:!0,supportsCacheHint:!1,supportsDistance:!0,supportsDistinct:!0,supportsExtent:!0,supportsGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQuantization:!0,supportsQuantizationEditMode:!1,supportsQueryGeometry:!0,supportsResultType:!1,supportsSqlExpression:!0,supportsMaxRecordCountFactor:!1,supportsStandardizedQueriesOnly:!0,supportsQueryByOthers:!0,supportsHistoricMoment:!1,supportsFormatPBF:!1,supportsDisjointSpatialRelationship:!0,maxRecordCountFactor:void 0,maxRecordCount:void 0,standardMaxRecordCount:void 0,tileMaxRecordCount:void 0}},874:function(e,t,r){"use strict";r.d(t,"a",(function(){return w})),r.d(t,"b",(function(){return x})),r.d(t,"c",(function(){return v}));var s=r(91),n=r(110),i=r(306),o=r(351),a=r(98),u=r(175),c=r(165);function l(e,t){return e?t?4:3:t?3:2}function h(e,t,r,s,n){if(!e)return!1;const i=l(t,r),{coords:o,lengths:a}=e;let u=!1,c=0;for(const l of a)u=d(u,o,i,c,l,s,n),c+=l*i;return u}function d(e,t,r,s,n,i,o){let a=e,u=s;for(let c=s,l=s+n*r;c<l;c+=r){u=c+r,u===l&&(u=s);const e=t[c],n=t[c+1],h=t[u],d=t[u+1];(n<o&&d>=o||d<o&&n>=o)&&e+(o-n)/(d-n)*(h-e)<i&&(a=!a)}return a}var f=r(397),p=r(666);const g="feature-store:unsupported-query",m={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},y={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},b={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},_={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1};function v(e,t,s,n,d){if(Object(a.g)(t)&&"esriGeometryPoint"===s&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=Object(c.g)(new u.a,t,!1,!1);return Promise.resolve((t=>function(e,t,r,s){return h(e,t,r,s.coords[0],s.coords[1])}(e,!1,!1,t)))}if(Object(a.g)(t)&&"esriGeometryMultipoint"===s){const r=Object(c.g)(new u.a,t,!1,!1);if("esriSpatialRelContains"===e)return Promise.resolve((e=>function(e,t,r,s,n,i){const o=l(n,i),{coords:a,lengths:u}=s;if(!u)return!1;for(let c=0,l=0;c<u.length;c++,l+=o)if(!h(e,t,r,a[l],a[l+1]))return!1;return!0}(r,!1,!1,e,n,d)))}if(Object(a.d)(t)&&"esriGeometryPoint"===s&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return Promise.resolve((e=>Object(i.e)(t,Object(p.c)(s,n,d,e))));if(Object(a.d)(t)&&"esriGeometryMultipoint"===s&&"esriSpatialRelContains"===e)return Promise.resolve((e=>Object(i.d)(t,Object(p.c)(s,n,d,e))));if(Object(a.d)(t)&&"esriSpatialRelIntersects"===e){const e=Object(o.b)(s);return Promise.resolve((r=>e(t,Object(p.c)(s,n,d,r))))}return Promise.all([r.e(9),r.e(28)]).then(r.bind(null,785)).then((r=>{const i=r[m[e]].bind(null,t.spatialReference,t);return e=>i(Object(p.c)(s,n,d,e))}))}async function x(e,t,r){const{spatialRel:i,geometry:o}=e;if(o){if(!0!==y[i])throw new s.a(g,"Unsupported query spatial relationship",{query:e});if(Object(n.i)(o.spatialReference)&&Object(n.i)(r)){if(!function(e){return!0===b[Object(a.c)(e)]}(o))throw new s.a(g,"Unsupported query geometry type",{query:e});if(!function(e){return!0===_[e]}(t))throw new s.a(g,"Unsupported layer geometry type",{query:e});if(e.outSR)return Object(f.a)(e.geometry&&e.geometry.spatialReference,e.outSR)}}}function w(e){if(Object(a.d)(e))return!0;if(Object(a.g)(e)){for(const t of e.rings){if(5!==t.length)return!1;if(t[0][0]!==t[1][0]||t[0][0]!==t[4][0]||t[2][0]!==t[3][0]||t[0][1]!==t[3][1]||t[0][1]!==t[4][1]||t[1][1]!==t[2][1])return!1}return!0}return!1}},901:function(e,t,r){"use strict";r.d(t,"a",(function(){return n}));var s=r(404);class n extends s.a{constructor(e,t){super(s.a.createInstance()),this._currentIndex=-1,this._reader=e,this._indices=t}static from(e,t){return new n(e.copy(),t)}get hasNext(){return this._currentIndex+1<this._indices.length}getApproximateSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const e=new n(this._reader.copy(),this._indices);return e._currentIndex=this._currentIndex,e}next(){for(;this._nextIndex()&&!this._reader._passesFilter()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}setArcadeSpatialReference(e){this._reader.setArcadeSpatialReference(e)}attachStorage(e){this._reader.attachStorage(e)}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}getStorage(){return this._reader.getStorage()}getComputedNumeric(e){return this._reader.getComputedNumericAtIndex(0)}setComputedNumeric(e,t){return this._reader.setComputedNumericAtIndex(t,0)}getComputedString(e){return this._reader.getComputedStringAtIndex(0)}setComputedString(e,t){return this._reader.setComputedStringAtIndex(0,t)}getComputedNumericAtIndex(e){return this._reader.getComputedNumericAtIndex(e)}setComputedNumericAtIndex(e,t){this._reader.setComputedNumericAtIndex(e,t)}getComputedStringAtIndex(e){return this._reader.getComputedStringAtIndex(e)}setComputedStringAtIndex(e,t){return this._reader.setComputedStringAtIndex(e,t)}transform(e,t,r,s){const n=this.copy();return n._reader=this._reader.transform(e,t,r,s),n}extent(e,t,r,s){const n=this.copy();return n._reader=this._reader.extent(e,t,r,s),n}hasFilter(){return this._reader.hasFilter()}readAttribute(e,t=!1){return this._reader.readAttribute(e,t)}readAttributes(){return this._reader.readAttributes()}joinAttributes(e){return this._reader.joinAttributes(e)}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(e){return this.readAttribute(e,!0)}hasField(e){return this._reader.hasField(e)}setField(e,t){return this._reader.setField(e,t)}keys(){return this._reader.keys()}castToText(){return this._reader.castToText()}getQuantizationTransform(){return this._reader.getQuantizationTransform()}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(e){return this._reader.setDisplayId(e)}getGroupId(){return this._reader.getGroupId()}setGroupId(e){return this._reader.setGroupId(e)}getXHydrate(){return this._reader.getXHydrate()}getYHydrate(){return this._reader.getYHydrate()}getX(){return this._reader.getX()}getY(){return this._reader.getY()}setIndex(e){return this._reader.setIndex(e)}getIndex(){return this._reader.getIndex()}readLegacyFeature(){return this._reader.readLegacyFeature()}readOptimizedFeature(){return this._reader.readOptimizedFeature()}readLegacyPointGeometry(){return this._reader.readLegacyPointGeometry()}readLegacyGeometry(){return this._reader.readLegacyGeometry()}readLegacyCentroid(){return this._reader.readLegacyCentroid()}readGeometryArea(){return this._reader.readGeometryArea()}readUnquantizedGeometry(){return this._reader.readUnquantizedGeometry()}readHydratedGeometry(){return this._reader.readHydratedGeometry()}readGeometry(){return this._reader.readGeometry()}readCentroid(){return this._reader.readCentroid()}_passesFilter(){return this._reader._passesFilter()}_readAttribute(e,t){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}}},927:function(e,t,r){"use strict";r.d(t,"a",(function(){return l}));var s=r(79),n=r(88),i=r(149),o=r(314),a=r(80);var u=function(e,t,r){e.referencesGeometry();const s=t.readArcadeFeature();try{return e.evaluate({...r,$feature:s})}catch(n){return a.a.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",n),null}};const c=r.e(263).then(r.bind(null,1203));class l{constructor(e,t){this._canCacheExpressionValue=!1,this._sourceInfo=e,this._bitsets={computed:t.getBitset(t.createBitset())}}invalidate(){this._bitsets.computed.clear()}async updateSchema(e,t){const r=Object(o.a)(this._schema,t);if(this._schema=t,!t||Object(n.j)(r)||!Object(o.b)(r,"attributes"))return;Object(s.a)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",r),this._bitsets.computed.clear(),e.targets[t.name]=!0;const i=t.attributes,a=[],u=[];for(const s in i){const e=i[s];switch(e.type){case"field":break;case"expression":a.push(this._createArcadeComputedField(e));break;case"label-expression":a.push(this._createLabelArcadeComputedField(e));break;case"statistic":u.push(e)}}this._computedFields=await Promise.all(a),this._canCacheExpressionValue=!this._computedFields.some((e=>"expression"===e.type&&e.expression.referencesScale())),this._statisticFields=u}setComputedAttributes(e,t,r,s){const n=this._bitsets.computed;if(!this._canCacheExpressionValue||!n.has(r)){n.set(r);for(const n of this._computedFields){const i=this._evaluateField(t,n,s);switch(n.resultType){case"numeric":e.setComputedNumericAtIndex(r,n.fieldIndex,i);break;case"string":e.setComputedStringAtIndex(r,n.fieldIndex,i)}}}}async _createArcadeComputedField(e){const t=this._sourceInfo.spatialReference,r=this._sourceInfo.fieldsIndex;return{...e,expression:await Object(i.d)(e.valueExpression,t,r)}}async _createLabelArcadeComputedField(e){const t=this._sourceInfo.spatialReference,r=this._sourceInfo.fields,{createLabelFunction:s}=await c,n=await s(e.label,r,t);return{...e,builder:n}}_evaluateField(e,t,r){switch(t.type){case"label-expression":{const r=e.readArcadeFeature();return t.builder.evaluate(r)||""}case"expression":{const{expression:s}=t;return u(s,e,{$view:{scale:r}})}}}}},964:function(e,t,r){"use strict";r.d(t,"a",(function(){return w})),r.d(t,"b",(function(){return x})),r.d(t,"c",(function(){return v}));var s=r(91),n=r(289),i=r(175);function o(e){const t=[];return e.forEach((e=>t.push(e))),t}const a={LineString:"esriGeometryPolyline",MultiLineString:"esriGeometryPolyline",MultiPoint:"esriGeometryMultipoint",Point:"esriGeometryPoint",Polygon:"esriGeometryPolygon",MultiPolygon:"esriGeometryPolygon"};function*u(e){switch(e.type){case"Feature":yield e;break;case"FeatureCollection":for(const t of e.features)t&&(yield t)}}function*c(e){if(!e)return null;switch(e.type){case"Point":yield e.coordinates;break;case"LineString":case"MultiPoint":yield*e.coordinates;break;case"MultiLineString":case"Polygon":for(const t of e.coordinates)yield*t;break;case"MultiPolygon":for(const t of e.coordinates)for(const e of t)yield*e}}function l(e){for(;;){const{value:t,done:r}=e.next();if(r)return!1;if(t.length>2)return!0}}function h(e){let t=0;for(let r=0;r<e.length;r++){const s=e[r],n=e[(r+1)%e.length];t+=s[0]*n[1]-n[0]*s[1]}return t<=0}function d(e){const t=e[0],r=e[e.length-1];return t[0]===r[0]&&t[1]===r[1]&&t[2]===r[2]||e.push(t),e}function f(e,t,r){switch(t.type){case"LineString":return function(e,t,r){return m(e,t.coordinates,r),e}(e,t,r);case"MultiLineString":return function(e,t,r){for(const s of t.coordinates)m(e,s,r);return e}(e,t,r);case"MultiPoint":return function(e,t,r){return m(e,t.coordinates,r),e}(e,t,r);case"MultiPolygon":return function(e,t,r){for(const s of t.coordinates){p(e,s[0],r);for(let t=1;t<s.length;t++)g(e,s[t],r)}return e}(e,t,r);case"Point":return function(e,t,r){return b(e,t.coordinates,r),e}(e,t,r);case"Polygon":return function(e,t,r){const s=t.coordinates;p(e,s[0],r);for(let n=1;n<s.length;n++)g(e,s[n],r);return e}(e,t,r)}}function p(e,t,r){const s=d(t);!function(e){return!h(e)}(s)?m(e,s,r):y(e,s,r)}function g(e,t,r){const s=d(t);!function(e){return h(e)}(s)?m(e,s,r):y(e,s,r)}function m(e,t,r){for(const s of t)b(e,s,r);e.lengths.push(t.length)}function y(e,t,r){for(let s=t.length-1;s>=0;s--)b(e,t[s],r);e.lengths.push(t.length)}function b(e,t,r){const[s,n,i]=t;e.coords.push(s,n),r.hasZ&&e.coords.push(i||0)}function _(e){switch(typeof e){case"string":return"esriFieldTypeString";case"number":return"esriFieldTypeDouble";default:return"unknown"}}function v(e){if(!e)throw new s.a("geojson-layer:empty","GeoJSON data is empty");if("Feature"!==e.type&&"FeatureCollection"!==e.type)throw new s.a("geojson-layer:unsupported-geojson-object","missing or not supported GeoJSON object type",{data:e});const{crs:t}=e;if(!t)return;const r="string"==typeof t?t:"name"===t.type?t.properties.name:null,n=new RegExp(".*(CRS84H?|4326)$","i");if(!r||!n.test(r))throw new s.a("geojson-layer:unsupported-crs","unsupported GeoJSON 'crs' member",{crs:t})}function x(e,t={}){const r=u(e),s=[],n=new Set,i=new Set;let h,d=!1,f=Number.NEGATIVE_INFINITY,p=null,g=!1,{geometryType:m=null}=t,y=!1;for(;;){const{value:e,done:t}=r.next();if(t){const e=p&&1===p.length&&p[0]||null;if(e)for(const t of s)t.name===e&&(t.type="esriFieldTypeOID");return{fields:s,geometryType:m,hasZ:d,maxObjectId:Math.max(0,f),objectIdFieldName:e,objectIdFieldType:h,unknownFields:o(i)}}const{geometry:u,properties:b,id:v}=e;if((!u||(m||(m=a[u.type]),a[u.type]===m))&&(d||(d=l(c(u))),g||(g=null!=v,g&&(h=typeof v,"number"===h&&(p=Object.keys(b).filter((e=>b[e]===v))))),g&&"number"===h&&null!=v&&(f=Math.max(f,v),p.length>1?p=p.filter((e=>b[e]===v)):1===p.length&&(p=b[p[0]]===v?p:[])),!y&&b)){let e=!0;for(const t in b){if(n.has(t))continue;const r=b[t];if(null==r){e=!1,i.add(t);continue}const o=_(r);"unknown"!==o?(i.delete(t),n.add(t),s.push({name:t,alias:t,type:o})):i.add(t)}y=e}}}function w(e,t){return function(e){const t=[];for(;;){const{value:r,done:s}=e.next();if(s)return t;t.push(r)}}(function*(e,t={}){const{geometryType:r,objectIdFieldName:s}=t;for(;;){const{value:o,done:u}=e.next();if(u)return;const{geometry:c,properties:l,id:h}=o;if(c&&a[c.type]!==r)continue;const d=l||{};s&&null!=h&&!d[s]&&(d[s]=h);const p=new n.a(c?f(new i.a,c,t):null,d);yield p}}(u(e),t))}},966:function(e,t,r){"use strict";r.d(t,"a",(function(){return p})),r.d(t,"b",(function(){return f}));r(79);var s=r(88),n=r(128),i=r(664),o=r(276),a=r(417),u=r(927),c=r(901);function l(e,t){return e<<16|t}function h(e){return(4294901760&e)>>>16}function d(e){return 65535&e}const f={getObjectId:e=>e.getObjectId(),getAttributes:e=>e.readAttributes(),getAttribute:(e,t)=>e.readAttribute(t),cloneWithGeometry:(e,t)=>e,getGeometry:e=>e.readHydratedGeometry(),getCentroid:(e,t)=>e.readCentroid()};class p extends u.a{constructor(e,t,r){super(e,t),this.featureAdapter=f,this.events=new n.a,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._indexSearchCache=new i.a(50),this._index=Object(a.a)(9,(e=>({minX:this._storage.getXMin(e),minY:this._storage.getYMin(e),maxX:this._storage.getXMax(e),maxY:this._storage.getYMax(e)}))),this._storage=t,this.mode=r}get storage(){return this._storage}get storeStatistics(){return{featureCount:0,vertexCount:0}}hasInstance(e){return this._featureSetsByInstance.has(e)}onTileData(e,t){if(Object(s.j)(t.addOrUpdate))return t;if(t.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){const r=t.addOrUpdate.getCursor();for(;r.next();){const t=r.getDisplayId();this.setComputedAttributes(this._storage,r,t,e.scale)}return t}this._featureSetsByInstance.set(t.addOrUpdate.instance,t.addOrUpdate);const r=t.addOrUpdate.getCursor();for(;r.next();)this._insertFeature(r,e.scale);return this._spatialIndexInvalid=!0,this.events.emit("changed"),t}search(e){this._rebuildIndex();const t=e.id,r=this._indexSearchCache.find((e=>e.tileId===t));if(Object(s.k)(r))return r.readers;const n=new Map,i=this._searchIndex(e.bounds),o=[];for(const s of i){const e=this._storage.getInstanceId(s),t=h(e),r=d(e);n.has(t)||n.set(t,[]),n.get(t).push(r)}return n.forEach(((e,t)=>{const r=this._featureSetsByInstance.get(t);o.push(c.a.from(r,e))})),this._indexSearchCache.enqueue({tileId:t,readers:o}),o}insert(e){const t=e.getCursor(),r=this._storage;for(;t.next();){var s;const e=l(t.instance,t.getIndex()),n=t.getObjectId(),i=null!=(s=this._objectIdToDisplayId.get(n))?s:this._storage.createDisplayId();t.setDisplayId(i),r.setInstanceId(i,e),this._objectIdToDisplayId.set(n,i)}this._featureSetsByInstance.set(e.instance,e),this._spatialIndexInvalid=!0}remove(e){const t=this._objectIdToDisplayId.get(e);if(!t)return;const r=this._storage.getInstanceId(t),s=d(r),n=h(r),i=this._featureSetsByInstance.get(n);this._objectIdToDisplayId.delete(e),this._storage.releaseDisplayId(t),i.removeAtIndex(s),i.isEmpty&&this._featureSetsByInstance.delete(n),this._spatialIndexInvalid=!0}forEach(e){this._objectIdToDisplayId.forEach((t=>{const r=this._storage.getInstanceId(t),s=this._lookupFeature(r);e(s)}))}forEachUnsafe(e){this._objectIdToDisplayId.forEach((t=>{const r=this._storage.getInstanceId(t),s=h(r),n=d(r),i=this._getFeatureSet(s);i.setIndex(n),e(i)}))}forEachInBounds(e,t){const r=this._searchIndex(e);for(const n of r){const e=this.lookupFeatureByDisplayId(n,this._storage);t(Object(s.q)(e))}}forEachBounds(e,t,r){this._rebuildIndex();const s=[0,0,0,0];for(const n of e){if(!n.readGeometry())continue;const e=n.getDisplayId();s[0]=this._storage.getXMin(e),s[1]=this._storage.getYMin(e),s[2]=this._storage.getXMax(e),s[3]=this._storage.getYMax(e),t(Object(o.k)(r,s))}}sweepFeatures(e,t,r){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach(((s,n)=>{e.has(s)||(t.releaseDisplayId(s),r&&r.unsetAttributeData(s),this._objectIdToDisplayId.delete(n))})),this.events.emit("changed")}sweepFeatureSets(e){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach(((t,r)=>{e.has(r)||this._featureSetsByInstance.delete(r)}))}lookupObjectId(e,t){const r=this.lookupFeatureByDisplayId(e,t);return Object(s.j)(r)?null:r.getObjectId()}lookupDisplayId(e){return this._objectIdToDisplayId.get(e)}lookupFeatureByDisplayId(e,t){const r=t.getInstanceId(e);return this._lookupFeature(r)}lookupByDisplayIdUnsafe(e){const t=this._storage.getInstanceId(e),r=h(t),s=d(t),n=this._getFeatureSet(r);return n?(n.setIndex(s),n):null}_insertFeature(e,t){const r=this._storage,s=e.getObjectId(),n=l(e.instance,e.getIndex());r.getInstanceId(e.getDisplayId());let i=this._objectIdToDisplayId.get(s);i||(i=r.createDisplayId(),this._objectIdToDisplayId.set(s,i),this._spatialIndexInvalid=!0),e.setDisplayId(i),r.setInstanceId(i,n),this.setComputedAttributes(r,e,i,t)}_searchIndex(e){this._rebuildIndex();const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this._index.search(t)}_rebuildIndex(){if(!this._spatialIndexInvalid)return;const e=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach((t=>{const r=t.getCursor();for(;r.next();){const t=r.getDisplayId();this._storage.setBounds(t,r)&&e.push(t)}})):this._objectIdToDisplayId.forEach((t=>{const r=this._storage.getInstanceId(t);this._storage.setBounds(t,this._lookupFeature(r))&&e.push(t)})),this._index.clear(),this._index.load(e),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}_lookupFeature(e){const t=h(e),r=d(e),s=this._getFeatureSet(t);if(!s)return null;const n=s.getCursor();return n.setIndex(r),n}_getFeatureSet(e){return this._featureSetsByInstance.get(e)}}}}]);
//# sourceMappingURL=75.46750c04.chunk.js.map