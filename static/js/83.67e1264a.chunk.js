(this.webpackJsonpimaps=this.webpackJsonpimaps||[]).push([[83,33,38],{1011:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(714),n=i(136);function a(e){e.extensions.add("GL_EXT_shader_texture_lod"),e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(n.a`#ifndef GL_EXT_shader_texture_lod
float calcMipMapLevel(const vec2 ddx, const vec2 ddy) {
float deltaMaxSqr = max(dot(ddx, ddx), dot(ddy, ddy));
return max(0.0, 0.5 * log2(deltaMaxSqr));
}
#endif
vec4 textureAtlasLookup(sampler2D texture, vec2 textureSize, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
#ifdef GL_EXT_shader_texture_lod
return texture2DGradEXT(texture, uvAtlas, dUVdx, dUVdy);
#else
vec2 dUVdxAuto = dFdx(uvAtlas);
vec2 dUVdyAuto = dFdy(uvAtlas);
float mipMapLevel = calcMipMapLevel(dUVdx * textureSize, dUVdy * textureSize);
float autoMipMapLevel = calcMipMapLevel(dUVdxAuto * textureSize, dUVdyAuto * textureSize);
return texture2D(texture, uvAtlas, mipMapLevel - autoMipMapLevel);
#endif
}`)}function s(e,t){e.include(r.a,t),e.fragment.code.add(n.a`
  struct TextureLookupParameter {
    vec2 uv;
    ${t.supportsTextureAtlas?"vec2 size;":""}
  } vtc;
  `),1===t.attributeTextureCoordinates&&e.fragment.code.add(n.a`vec4 textureLookup(sampler2D tex, TextureLookupParameter params) {
return texture2D(tex, params.uv);
}`),2===t.attributeTextureCoordinates&&(e.include(a),e.fragment.code.add(n.a`vec4 textureLookup(sampler2D tex, TextureLookupParameter params) {
return textureAtlasLookup(tex, params.size, params.uv, vuvRegion);
}`))}},1012:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));var r=i(401),n=i(136);function a(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMat","mat4"),e.fragment.uniforms.add("rpProjectionMat","mat4"),e.fragment.code.add(n.a`vec2 reprojectionCoordinate(vec3 projectionCoordinate)
{
vec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
vec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
reprojectedCoord.xy /= reprojectedCoord.w;
return reprojectedCoord.xy * 0.5 + 0.5;
}`)}function s(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("ssrViewMat","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.fragment.include(r.a),e.include(a),e.fragment.code.add(n.a`
  const int maxSteps = ${t.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function o(e,t){var i,r;t.ssrEnabled&&(e.bindTexture(t.linearDepthTexture,"depthMapView"),e.setUniform2fv("nearFar",t.camera.nearFar),e.setUniformMatrix4fv("ssrViewMat",t.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/t.camera.height),r=t,(i=e).bindTexture(r.lastFrameColorTexture,"lastFrameColorMap"),i.setUniformMatrix4fv("reprojectionMat",r.reprojectionMatrix),i.setUniformMatrix4fv("rpProjectionMat",r.camera.projectionMatrix))}},1035:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r,n=i(331),a=i(431);!function(e){e.Default={vvSizeEnabled:!1,vvSizeMinSize:Object(a.c)(1,1,1),vvSizeMaxSize:Object(a.c)(100,100,100),vvSizeOffset:Object(a.c)(0,0,0),vvSizeFactor:Object(a.c)(1,1,1),vvSizeValue:Object(a.c)(1,1,1),vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvOpacityEnabled:!1,vvOpacityValues:[0,0,0,0,0,0,0,0],vvOpacityOpacities:[1,1,1,1,1,1,1,1],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:Object(n.b)()}}(r||(r={}));const s=r},1036:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(136);function n(e,t){e.vertex.uniforms.add("intrinsicWidth","float"),t.vvSize?(e.attributes.add("sizeFeatureAttribute","float"),e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(r.a`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(e.attributes.add("size","float"),e.vertex.code.add(r.a`float getSize(){
return intrinsicWidth * size;
}`)),t.vvOpacity?(e.attributes.add("opacityFeatureAttribute","float"),e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(r.a`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):e.vertex.code.add(r.a`vec4 applyOpacity( vec4 color ){
return color;
}`),t.vvColor?(e.attributes.add("colorFeatureAttribute","float"),e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(r.a`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 interpolateColor( float value ) {
if (value <= vvColorValues[0]) {
return vvColorColors[0];
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return mix(vvColorColors[i-1], vvColorColors[i], f);
}
}
return vvColorColors[vvColorNumber - 1];
}
vec4 getColor(){
return applyOpacity(interpolateColor(colorFeatureAttribute));
}`)):(e.attributes.add("color","vec4"),e.vertex.code.add(r.a`vec4 getColor(){
return applyOpacity(color);
}`))}},1037:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i(401),n=i(815),a=i(633),s=i(136);function o(e,t){t.multipassGeometryEnabled&&e.vertex.include(n.b),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),e.vertex.code.add(s.a`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${t.multipassGeometryEnabled?s.a`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${t.multipassTerrainEnabled?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),t.multipassTerrainEnabled&&e.fragment.include(r.a),e.fragment.uniforms.add("terrainDepthTexture","sampler2D"),e.fragment.uniforms.add("cameraNearFar","vec2"),e.fragment.uniforms.add("inverseViewport","vec2"),e.fragment.include(a.a),e.fragment.code.add(s.a`
  void main() {
    gl_FragColor = vec4(1, 1, 1, 1);
    ${t.multipassTerrainEnabled?s.a`

          vec2 uv = gl_FragCoord.xy * inverseViewport;

          //Read the rgba data from the texture linear depth
          vec4 terrainDepthData = texture2D(terrainDepthTexture, uv);

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), cameraNearFar);

          //If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          //Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            gl_FragColor.g = 0.5;
          }`:""}
  }
  `)}},1038:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));var r=i(85);const n={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},a={dash:n.dash,"dash-dot":[...n.dash,...n.dot],dot:n.dot,"long-dash":n["long-dash"],"long-dash-dot":[...n["long-dash"],...n.dot],"long-dash-dot-dot":[...n["long-dash"],...n.dot,...n.dot],none:null,"short-dash":n["short-dash"],"short-dash-dot":[...n["short-dash"],...n["short-dot"]],"short-dash-dot-dot":[...n["short-dash"],...n["short-dot"],...n["short-dot"]],"short-dot":n["short-dot"],solid:null};function s(e,t=2){return{pattern:[e,e],pixelRatio:t}}function o(e){return Object(r.l)(e)&&"style"===e.type?function(e,t=2){return Object(r.k)(e)?e:{pattern:e.slice(),pixelRatio:t}}(a[e.style],8):null}},1039:function(e,t,i){"use strict";i.d(t,"a",(function(){return f}));var r=i(85),n=i(251),a=i(199),s=i(116),o=i(106),c=i(207),l=i(566),d=i(960),h=i(607),u=i(718),p=i(719);class f{constructor(e,t=125e4){this._originSR=e,this._gridSize=t,this._origins=new Map,this._objects=new Map,this._rootOriginId="root/"+Object(n.a)()}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){if(Object(r.l)(b))return this._origins.set(this._rootOriginId,Object(d.a)(b[0],b[1],b[2],this._rootOriginId)),this.getOrigin(e);const t=Object(d.a)(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,t),t}const i=this._gridSize,n=Math.round(e[0]/i),a=Math.round(e[1]/i),o=Math.round(e[2]/i),c=`${n}/${a}/${o}`;let l=this._origins.get(c);const h=.5*i;if(Object(s.j)(m,e,t.vec3),m[0]=Math.abs(m[0]),m[1]=Math.abs(m[1]),m[2]=Math.abs(m[2]),m[0]<h&&m[1]<h&&m[2]<h){if(l){const t=Math.max(...m);if(Object(s.j)(m,e,l.vec3),m[0]=Math.abs(m[0]),m[1]=Math.abs(m[1]),m[2]=Math.abs(m[2]),Math.max(...m)<t)return l}return t}return l||(l=Object(d.a)(n*i,a*i,o*i,c),this._origins.set(c,l)),l}_drawOriginBox(e,t=[1,1,0,1]){const i=window.view,r=i._stage,n=t.toString();if(!this._objects.has(n)){this._material=new p.a({width:2,color:t}),r.add(this._material);const e=new u.a({isPickable:!1}),i=new h.a({castShadow:!1});r.add(i),e.add(i),r.add(e),this._objects.set(n,i)}const s=this._objects.get(n),o=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],d=o.length,f=new Array(3*d),b=new Uint16Array(2*(d-1)),m=.5*this._gridSize;for(let a=0;a<d;a++)f[3*a+0]=e[0]+(1&o[a]?m:-m),f[3*a+1]=e[1]+(2&o[a]?m:-m),f[3*a+2]=e[2]+(4&o[a]?m:-m),a>0&&(b[2*a+0]=a-1,b[2*a+1]=a);Object(c.l)(f,this._originSR,0,f,i.renderSpatialReference,0,d);const g=new l.a([["position",{size:3,data:f,exclusive:!0}]],[["position",b]],2);r.add(g),s.addGeometry(g,this._material,a.a)}}let b=null;const m=Object(o.f)()},1040:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return s}));var r=i(224),n=i(481);const a={waveStrength:.06,waveTextureRepeat:32,waveDirection:Object(r.e)(1,0),waveVelocity:.05,flowStrength:.015,flowOffset:-.5,animationSpeed:.35,color:[0,0,0,0],transparent:!0,writeDepth:!0,slicePlaneEnabled:!1,isDraped:!1,receiveShadows:!0,ssrEnabled:!1,...n.b},s={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}}},1041:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return u})),i.d(t,"c",(function(){return d}));var r,n=i(306),a=i(906),s=i(779),o=i(815),c=i(136),l=i(342);function d(e){const t=new l.a;return t.include(a.a),t.include(s.a,e),t.include(n.a,e),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("lineSize","float").add("pixelToNDC","vec2").add("borderSize","float").add("screenOffset","vec2"),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),e.multipassGeometryEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(c.a`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${e.occlusionTestEnabled?c.a`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${e.screenSizePerspectiveEnabled?c.a`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:c.a`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${e.multipassGeometryEnabled?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${e.depthHudEnabled?e.depthHudAlignStartEnabled?c.a`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:c.a`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.screenSizePerspectiveEnabled?c.a`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:c.a`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),t.fragment.uniforms.add("color","vec4"),t.fragment.uniforms.add("borderColor","vec4"),e.multipassGeometryEnabled&&(t.fragment.include(o.b,e),t.fragment.uniforms.add("inverseViewport","vec2")),t.fragment.code.add(c.a`
    void main() {
      ${e.multipassGeometryEnabled?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = color.a * borderColor.a * coverage.y;
      float colorAlpha = color.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${e.depthHudEnabled?c.a`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:c.a`
      // Compute the finalRgb, but keep it pre-multiplied (for unpre-multiplied you
      // need to divide by finalAlpha). We avoid the division here by setting the
      // appropriate blending function in the material.
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, color.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),t}function h(e,t,i){3===i.length?e.setUniform4f(t,i[0],i[1],i[2],1):e.setUniform4fv(t,i)}(r||(r={})).bindUniforms=function(e,t,i){h(e,"color",t.color),e.setUniform1f("pixelRatio",i),e.setUniform2f("screenOffset",t.screenOffset[0]*i,t.screenOffset[1]*i),null!==t.borderColor?(h(e,"borderColor",t.borderColor),e.setUniform1f("borderSize",i)):(e.setUniform4f("borderColor",0,0,0,0),e.setUniform1f("borderSize",0))};const u=Object.freeze({__proto__:null,build:d,get LineCallout(){return r}})},1042:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(1011),n=i(136);function a(e,t){const i=e.fragment;t.vertexTangents?(e.attributes.add("tangent","vec4"),e.varyings.add("vTangent","vec4"),2===t.doubleSidedMode?i.code.add(n.a`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`):i.code.add(n.a`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = vTangent.w;
vec3 tangent = normalize(vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`)):(e.extensions.add("GL_OES_standard_derivatives"),i.code.add(n.a`mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {
vec3 Q1 = dFdx(pos);
vec3 Q2 = dFdy(pos);
vec2 stx = dFdx(st);
vec2 sty = dFdy(st);
float det = stx.t * sty.s - sty.t * stx.s;
vec3 T = stx.t * Q2 - sty.t * Q1;
T = T - normal * dot(normal, T);
T *= inversesqrt(max(dot(T,T), 1.e-10));
vec3 B = sign(det) * cross(normal, T);
return mat3(T, B, normal);
}`)),0!==t.attributeTextureCoordinates&&(e.include(r.a,t),i.uniforms.add("normalTexture","sampler2D"),i.uniforms.add("normalTextureSize","vec2"),i.code.add(n.a`
    vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
      vtc.uv = uv;
      ${t.supportsTextureAtlas?"vtc.size = normalTextureSize;":""}
      vec3 rawNormal = textureLookup(normalTexture, vtc).rgb * 2.0 - 1.0;
      return tangentSpace * rawNormal;
    }
  `))}},1043:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(136),n=i(257);function a(e,t){const i=r.a`
  /*
  *  ${t.name}
  *  ${0===t.output?"RenderOutput: Color":1===t.output?"RenderOutput: Depth":3===t.output?"RenderOutput: Shadow":2===t.output?"RenderOutput: Normal":4===t.output?"RenderOutput: Highlight":""}
  */
  `;Object(n.c)()&&(e.fragment.code.add(i),e.vertex.code.add(i))}},1044:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return a})),i.d(t,"c",(function(){return n}));var r=i(1098);function n(e,t,i){if(e.count!==t.count)return void r.a.error("source and destination buffers need to have the same number of elements");const n=e.count,a=i[0],s=i[1],o=i[2],c=i[3],l=i[4],d=i[5],h=i[6],u=i[7],p=i[8],f=e.typedBuffer,b=e.typedBufferStride,m=t.typedBuffer,g=t.typedBufferStride;for(let r=0;r<n;r++){const e=r*b,t=r*g,i=m[t],n=m[t+1],v=m[t+2],y=m[t+3];f[e]=a*i+c*n+h*v,f[e+1]=s*i+l*n+u*v,f[e+2]=o*i+d*n+p*v,f[e+3]=y}}function a(e,t,i){const r=Math.min(e.count,t.count),n=e.typedBuffer,a=e.typedBufferStride,s=t.typedBuffer,o=t.typedBufferStride;for(let c=0;c<r;c++){const e=c*a,t=c*o;n[e]=i*s[t],n[e+1]=i*s[t+1],n[e+2]=i*s[t+2],n[e+3]=i*s[t+3]}}function s(e,t,i){const r=Math.min(e.count,t.count),n=e.typedBuffer,a=e.typedBufferStride,s=t.typedBuffer,o=t.typedBufferStride;for(let c=0;c<r;c++){const e=c*a,t=c*o;n[e]=s[t]>>i,n[e+1]=s[t+1]>>i,n[e+2]=s[t+2]>>i,n[e+3]=s[t+3]>>i}}Object.freeze({__proto__:null,transformMat4:function(e,t,i){if(e.count!==t.count)return void r.a.error("source and destination buffers need to have the same number of elements");const n=e.count,a=i[0],s=i[1],o=i[2],c=i[3],l=i[4],d=i[5],h=i[6],u=i[7],p=i[8],f=i[9],b=i[10],m=i[11],g=i[12],v=i[13],y=i[14],O=i[15],x=e.typedBuffer,j=e.typedBufferStride,_=t.typedBuffer,S=t.typedBufferStride;for(let r=0;r<n;r++){const e=r*j,t=r*S,i=_[t],n=_[t+1],w=_[t+2],C=_[t+3];x[e]=a*i+l*n+p*w+g*C,x[e+1]=s*i+d*n+f*w+v*C,x[e+2]=o*i+h*n+b*w+y*C,x[e+3]=c*i+u*n+m*w+O*C}},transformMat3:n,scale:a,shiftRight:s})},1045:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var r=i(102),n=i(287),a=i(88),s=i(85),o=i(91),c=i(100);class l{constructor(e){this.streamDataRequester=e}async loadJSON(e,t){return this.load("json",e,t)}async loadBinary(e,t){return Object(c.u)(e)?(Object(o.u)(t),Object(c.j)(e)):this.load("binary",e,t)}async loadImage(e,t){return this.load("image",e,t)}async load(e,t,i){if(Object(s.k)(this.streamDataRequester))return(await Object(r.default)(t,{responseType:d[e]})).data;const c=await Object(n.c)(this.streamDataRequester.request(t,e,i));if(!0===c.ok)return c.value;throw Object(o.t)(c.error),new a.a("",`Request for resource failed: ${c.error}`)}}const d={image:"image",binary:"array-buffer",json:"json"}},1046:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return a}));var r=i(554),n=i(541);function a(e,t=n.d){return"number"==typeof e?t(e):Object(r.i)(e)||Object(r.k)(e)?new Uint32Array(e):e}function s(e){const t="number"==typeof e?e:e.length;if(t<3)return new Uint16Array(0);const i=t-2,r=i<=65536?new Uint16Array(3*i):new Uint32Array(3*i);if("number"==typeof e){let e=0;for(let t=0;t<i;t+=1)t%2==0?(r[e++]=t,r[e++]=t+1,r[e++]=t+2):(r[e++]=t+1,r[e++]=t,r[e++]=t+2)}else{let t=0;for(let n=0;n<i;n+=1)if(n%2==0){const i=e[n],a=e[n+1],s=e[n+2];r[t++]=i,r[t++]=a,r[t++]=s}else{const i=e[n+1],a=e[n],s=e[n+2];r[t++]=i,r[t++]=a,r[t++]=s}}return r}function o(e){const t="number"==typeof e?e:e.length;if(t<3)return new Uint16Array(0);const i=t-2,r=i<=65536?new Uint16Array(3*i):new Uint32Array(3*i);if("number"==typeof e){let e=0;for(let t=0;t<i;++t)r[e++]=0,r[e++]=t+1,r[e++]=t+2;return r}{const t=e[0];let n=e[1],a=0;for(let s=0;s<i;++s){const i=e[s+2];r[a++]=t,r[a++]=n,r[a++]=i,n=i}return r}}},1047:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));const r=2.1},1058:function(e,t,i){"use strict";i.d(t,"a",(function(){return I}));var r=i(85),n=i(199),a=i(88);const s=i(87).a.getLogger("esri.views.3d.glTF");var o=i(211),c=i(408),l=i(100),d=i(640),h=i(149),u=i(550),p=i(400),f=i(403),b=i(864);class m{constructor(e){this.data=e,this.offset4=0,this.dataUint32=new Uint32Array(this.data,0,Math.floor(this.data.byteLength/4))}readUint32(){const e=this.offset4;return this.offset4+=1,this.dataUint32[e]}readUint8Array(e){const t=4*this.offset4;return this.offset4+=e/4,new Uint8Array(this.data,t,e)}remainingBytes(){return this.data.byteLength-4*this.offset4}}const g={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1},v={pbrMetallicRoughness:g,emissiveFactor:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1},y={ESRI_externalColorMixMode:"tint"},O=(e={})=>{const t={...g,...e.pbrMetallicRoughness},i=function(e){switch(e.ESRI_externalColorMixMode){case"multiply":case"tint":case"ignore":case"replace":break;default:Object(o.a)(e.ESRI_externalColorMixMode),e.ESRI_externalColorMixMode="tint"}return e}({...y,...e.extras});return{...v,...e,pbrMetallicRoughness:t,extras:i}};const x={magFilter:9729,minFilter:9987,wrapS:10497,wrapT:10497};const j=1179937895,_=1313821514,S=5130562;class w{constructor(e,t,i,r,n){this.context=e,this.errorContext=t,this.uri=i,this.json=r,this.glbBuffer=n,this.bufferLoaders=new Map,this.textureLoaders=new Map,this.textureCache=new Map,this.materialCache=new Map,this.nodeParentMap=new Map,this.nodeTransformCache=new Map,this.baseUri=function(e){let t,i;return e.replace(/^(.*\/)?([^/]*)$/,((e,r,n)=>(t=r||"",i=n||"",""))),{dirPart:t,filePart:i}}(this.uri).dirPart,this.checkVersionSupported(),this.checkRequiredExtensionsSupported(),t.errorUnsupportedIf(null==r.scenes,"Scenes must be defined."),t.errorUnsupportedIf(null==r.meshes,"Meshes must be defined"),t.errorUnsupportedIf(null==r.nodes,"Nodes must be defined."),this.computeNodeParents()}static async load(e,t,i,r){if(Object(l.u)(i)){const r=Object(l.i)(i);if("model/gltf-binary"!==r.mediaType)try{const n=JSON.parse(r.isBase64?atob(r.data):r.data);return new w(e,t,i,n)}catch{}const n=Object(l.j)(i);if(w.isGLBData(n))return this.fromGLBData(e,t,i,n)}if(i.endsWith(".gltf")){const n=await e.loadJSON(i,r);return new w(e,t,i,n)}const n=await e.loadBinary(i,r);if(w.isGLBData(n))return this.fromGLBData(e,t,i,n);const a=await e.loadJSON(i,r);return new w(e,t,i,a)}static isGLBData(e){const t=new m(e);return t.remainingBytes()>=4&&t.readUint32()===j}static async fromGLBData(e,t,i,r){const n=await w.parseGLBData(t,r);return new w(e,t,i,n.json,n.binaryData)}static async parseGLBData(e,t){const i=new m(t);e.assert(i.remainingBytes()>=12,"GLB binary data is insufficiently large.");const r=i.readUint32(),n=i.readUint32(),a=i.readUint32();e.assert(r===j,"Magic first 4 bytes do not fit to expected GLB value."),e.assert(t.byteLength>=a,"GLB binary data is smaller than header specifies."),e.errorUnsupportedIf(2!==n,"An unsupported GLB container version was detected. Only version 2 is supported.");let s,o,c=0;for(;i.remainingBytes()>=8;){const t=i.readUint32(),r=i.readUint32();0===c?(e.assert(r===_,"First GLB chunk must be JSON."),e.assert(t>=0,"No JSON data found."),s=await R(i.readUint8Array(t))):1===c?(e.errorUnsupportedIf(r!==S,"Second GLB chunk expected to be BIN."),o=i.readUint8Array(t)):e.warnUnsupported("More than 2 GLB chunks detected. Skipping."),c+=1}return s||e.error("No GLB JSON chunk detected."),{json:s,binaryData:o}}async getBuffer(e,t){const i=this.json.buffers[e],r=this.errorContext;if(null==i.uri)return r.assert(null!=this.glbBuffer,"GLB buffer not present"),this.glbBuffer;const n=await this.getBufferLoader(e,t);return r.assert(n.byteLength===i.byteLength,"Buffer byte lengths should match."),n}async getBufferLoader(e,t){const i=this.bufferLoaders.get(e);if(i)return i;const r=this.json.buffers[e],n=this.context.loadBinary(this.resolveUri(r.uri),t).then((e=>new Uint8Array(e)));return this.bufferLoaders.set(e,n),n}async getAccessor(e,t){const i=this.errorContext;i.errorUnsupportedIf(!this.json.accessors,"Accessors missing.");const r=this.json.accessors[e];i.errorUnsupportedIf(null==(null==r?void 0:r.bufferView),"Some accessor does not specify a bufferView."),i.errorUnsupportedIf(r.type in["MAT2","MAT3","MAT4"],`AttributeType ${r.type} is not supported`);const n=this.json.bufferViews[r.bufferView],a=await this.getBuffer(n.buffer,t),s=E[r.type],o=A[r.componentType],c=s*o,l=n.byteStride||c;return{raw:a.buffer,byteStride:l,byteOffset:a.byteOffset+(n.byteOffset||0)+(r.byteOffset||0),entryCount:r.count,isDenselyPacked:l===c,componentCount:s,componentByteSize:o,componentType:r.componentType,min:r.min,max:r.max,normalized:!!r.normalized}}async getIndexData(e,t){if(null==e.indices)return null;const i=await this.getAccessor(e.indices,t);if(i.isDenselyPacked)switch(i.componentType){case 5121:return new Uint8Array(i.raw,i.byteOffset,i.entryCount);case 5123:return new Uint16Array(i.raw,i.byteOffset,i.entryCount);case 5125:return new Uint32Array(i.raw,i.byteOffset,i.entryCount)}else switch(i.componentType){case 5121:return Object(b.a)(this.wrapAccessor(f.l,i));case 5123:return Object(b.a)(this.wrapAccessor(f.j,i));case 5125:return Object(b.a)(this.wrapAccessor(f.k,i))}}async getPositionData(e,t){const i=this.errorContext;i.errorUnsupportedIf(null==e.attributes.POSITION,"No POSITION vertex data found.");const r=await this.getAccessor(e.attributes.POSITION,t);return i.errorUnsupportedIf(5126!==r.componentType,"Expected type FLOAT for POSITION vertex attribute, but found "+D[r.componentType]),i.errorUnsupportedIf(3!==r.componentCount,"POSITION vertex attribute must have 3 components, but found "+r.componentCount.toFixed()),this.wrapAccessor(f.u,r)}async getNormalData(e,t){const i=this.errorContext;i.assert(null!=e.attributes.NORMAL,"No NORMAL vertex data found.");const r=await this.getAccessor(e.attributes.NORMAL,t);return i.errorUnsupportedIf(5126!==r.componentType,"Expected type FLOAT for NORMAL vertex attribute, but found "+D[r.componentType]),i.errorUnsupportedIf(3!==r.componentCount,"NORMAL vertex attribute must have 3 components, but found "+r.componentCount.toFixed()),this.wrapAccessor(f.u,r)}async getTangentData(e,t){const i=this.errorContext;i.assert(null!=e.attributes.TANGENT,"No TANGENT vertex data found.");const r=await this.getAccessor(e.attributes.TANGENT,t);return i.errorUnsupportedIf(5126!==r.componentType,"Expected type FLOAT for TANGENT vertex attribute, but found "+D[r.componentType]),i.errorUnsupportedIf(4!==r.componentCount,"TANGENT vertex attribute must have 4 components, but found "+r.componentCount.toFixed()),new f.C(r.raw,r.byteOffset,r.byteStride,r.byteOffset+r.byteStride*r.entryCount)}async getTextureCoordinates(e,t){const i=this.errorContext;i.assert(null!=e.attributes.TEXCOORD_0,"No TEXCOORD_0 vertex data found.");const r=await this.getAccessor(e.attributes.TEXCOORD_0,t);return i.errorUnsupportedIf(2!==r.componentCount,"TEXCOORD_0 vertex attribute must have 2 components, but found "+r.componentCount.toFixed()),5126===r.componentType?this.wrapAccessor(f.m,r):(i.errorUnsupportedIf(!r.normalized,"Integer component types are only supported for a normalized accessor for TEXCOORD_0."),function(e){switch(e.componentType){case 5120:return new f.q(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5121:return new f.t(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5122:return new f.o(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5123:return new f.r(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5125:return new f.s(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case 5126:return new f.m(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);default:return void Object(o.a)(e.componentType)}}(r))}async getVertexColors(e,t){const i=this.errorContext;i.assert(null!=e.attributes.COLOR_0,"No COLOR_0 vertex data found.");const r=await this.getAccessor(e.attributes.COLOR_0,t);if(i.errorUnsupportedIf(4!==r.componentCount&&3!==r.componentCount,"COLOR_0 attribute must have 3 or 4 components, but found "+r.componentCount.toFixed()),4===r.componentCount){if(5126===r.componentType)return this.wrapAccessor(f.C,r);if(5121===r.componentType)return this.wrapAccessor(f.J,r);if(5123===r.componentType)return this.wrapAccessor(f.H,r)}else if(3===r.componentCount){if(5126===r.componentType)return this.wrapAccessor(f.u,r);if(5121===r.componentType)return this.wrapAccessor(f.B,r);if(5123===r.componentType)return this.wrapAccessor(f.z,r)}i.errorUnsupported("Unsupported component type for COLOR_0 attribute: "+D[r.componentType])}hasPositions(e){return void 0!==e.attributes.POSITION}hasNormals(e){return void 0!==e.attributes.NORMAL}hasVertexColors(e){return void 0!==e.attributes.COLOR_0}hasTextureCoordinates(e){return void 0!==e.attributes.TEXCOORD_0}hasTangents(e){return void 0!==e.attributes.TANGENT}async getMaterial(e,t,i){let r=this.materialCache.get(e.material);if(!r){const n=null!=e.material?O(this.json.materials[e.material]):O(),a=n.pbrMetallicRoughness,s=this.hasVertexColors(e),o=this.getTexture(a.baseColorTexture,t),c=this.getTexture(n.normalTexture,t),l=i?this.getTexture(n.occlusionTexture,t):null,d=i?this.getTexture(n.emissiveTexture,t):null,h=i?this.getTexture(a.metallicRoughnessTexture,t):null,u=null!=e.material?e.material:-1;r={alphaMode:n.alphaMode,alphaCutoff:n.alphaCutoff,color:a.baseColorFactor,doubleSided:!!n.doubleSided,colorTexture:await o,normalTexture:await c,name:n.name,id:u,occlusionTexture:await l,emissiveTexture:await d,emissiveFactor:n.emissiveFactor,metallicFactor:a.metallicFactor,roughnessFactor:a.roughnessFactor,metallicRoughnessTexture:await h,vertexColors:s,ESRI_externalColorMixMode:n.extras.ESRI_externalColorMixMode}}return r}async getTexture(e,t){if(!e)return null;this.errorContext.errorUnsupportedIf(0!==(e.texCoord||0),"Only TEXCOORD with index 0 is supported.");const i=e.index,r=this.errorContext,n=this.json.textures[i],a=(e=>({...x,...e}))(null!=n.sampler?this.json.samplers[n.sampler]:{});r.errorUnsupportedIf(null==n.source,"Source is expected to be defined for a texture.");const s=this.json.images[n.source],o=await this.loadTextureImageData(i,n,t);return Object(c.b)(this.textureCache,i,(()=>{const e=e=>33071===e||33648===e||10497===e,t=e=>(r.error(`Unexpected TextureSampler WrapMode: ${e}. Using default REPEAT(10497).`),10497);return{data:o,wrapS:e(a.wrapS)?a.wrapS:t(a.wrapS),wrapT:e(a.wrapT)?a.wrapT:t(a.wrapT),minFilter:a.minFilter,name:s.name,id:i}}))}getNodeTransform(e){if(void 0===e)return P;let t=this.nodeTransformCache.get(e);if(!t){const i=this.getNodeTransform(this.getNodeParent(e)),r=this.json.nodes[e];r.matrix?t=Object(h.n)(Object(n.d)(),i,r.matrix):r.translation||r.rotation||r.scale?(t=Object(n.c)(i),r.translation&&Object(h.b)(t,t,r.translation),r.rotation&&(T[3]=Object(u.b)(T,r.rotation),Object(h.f)(t,t,T[3],T)),r.scale&&Object(h.g)(t,t,r.scale)):t=i,this.nodeTransformCache.set(e,t)}return t}wrapAccessor(e,t){return new e(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*(t.entryCount-1)+t.componentByteSize*t.componentCount)}resolveUri(e){return Object(l.A)(e,this.baseUri)}getNodeParent(e){return this.nodeParentMap.get(e)}checkVersionSupported(){const e=d.a.parse(this.json.asset.version,"glTF");C.validate(e)}checkRequiredExtensionsSupported(){const e=this.json,t=this.errorContext;e.extensionsRequired&&0!==e.extensionsRequired.length&&t.errorUnsupported("gltf loader was not able to load unsupported feature. Required extensions: "+e.extensionsRequired.join(", "))}computeNodeParents(){this.json.nodes.forEach(((e,t)=>{e.children&&e.children.forEach((e=>{this.nodeParentMap.set(e,t)}))}))}async loadTextureImageData(e,t,i){const r=this.textureLoaders.get(e);if(r)return r;const n=this.createTextureLoader(t,i);return this.textureLoaders.set(e,n),n}async createTextureLoader(e,t){const i=this.json.images[e.source];if(i.uri)return this.context.loadImage(this.resolveUri(i.uri),t);const r=this.errorContext;r.errorUnsupportedIf(null==i.bufferView,"Image bufferView must be defined."),r.errorUnsupportedIf(null==i.mimeType,"Image mimeType must be defined.");const n=this.json.bufferViews[i.bufferView],a=await this.getBuffer(n.buffer,t);return r.errorUnsupportedIf(null!=n.byteStride,"byteStride not supported for image buffer"),async function(e,t){return new Promise(((i,r)=>{const n=new Blob([e],{type:t}),a=URL.createObjectURL(n),s=new Image;s.addEventListener("load",(()=>{URL.revokeObjectURL(a),"decode"in s?s.decode().then((()=>i(s)),(()=>i(s))):i(s)})),s.addEventListener("error",(e=>{URL.revokeObjectURL(a),r(e)})),s.src=a}))}(new Uint8Array(a.buffer,a.byteOffset+(n.byteOffset||0),n.byteLength),i.mimeType)}}const C=new d.a(2,0,"glTF"),P=Object(h.u)(Object(n.d)(),Math.PI/2),T=Object(p.b)(),E={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},A={5120:1,5121:1,5122:2,5123:2,5126:4,5125:4};async function R(e){return new Promise(((t,i)=>{const r=new Blob([e]),n=new FileReader;n.onload=()=>{const e=n.result;t(JSON.parse(e))},n.onerror=e=>{i(e)},n.readAsText(r)}))}const D={5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5125:"UNSIGNED_INT",5126:"FLOAT"};let M=0;async function I(e,t,i={},a=!0){const s=await w.load(e,V,t,i),o="gltf_"+M++,c={lods:[],materials:new Map,textures:new Map,meta:z(s)},l=!(!s.json.asset.extras||"symbolResource"!==s.json.asset.extras.ESRI_type),d=new Map;await async function(e,t){const i=e.json,r=i.scenes[i.scene||0].nodes,n=r.length>1,a=[];for(const o of r){const e=i.nodes[o];a.push(s(o,0)),L(e)&&!n&&e.extensions.MSFT_lod.ids.forEach(((e,t)=>s(e,t+1)))}async function s(r,n){const o=i.nodes[r],c=e.getNodeTransform(r);if(V.warnUnsupportedIf(null!=o.weights,"Morph targets are not supported."),null!=o.mesh){const e=i.meshes[o.mesh];for(const i of e.primitives)a.push(t(i,c,n,e.name))}for(const e of o.children||[])a.push(s(e,n))}await Promise.all(a)}(s,(async(e,t,l,h)=>{var u;const p=null!=(u=d.get(l))?u:0;d.set(l,p+1);const f=void 0!==e.mode?e.mode:4,b=4===f||5===f||6===f?f:null;if(Object(r.k)(b))return void V.warnUnsupported("Unsupported primitive mode ("+U[f]+"). Skipping primitive.");if(!s.hasPositions(e))return void V.warn("Skipping primitive without POSITION vertex attribute.");const m=s.getPositionData(e,i),g=s.getMaterial(e,i,a),v=s.hasNormals(e)?s.getNormalData(e,i):null,y=s.hasTangents(e)?s.getTangentData(e,i):null,O=s.hasTextureCoordinates(e)?s.getTextureCoordinates(e,i):null,x=s.hasVertexColors(e)?s.getVertexColors(e,i):null,j=s.getIndexData(e,i),_={transform:Object(n.c)(t),attributes:{position:await m,normal:v?await v:null,texCoord0:O?await O:null,color:x?await x:null,tangent:y?await y:null},indices:await j,primitiveType:b,material:F(c,await g,o)};let S=null;Object(r.l)(c.meta)&&Object(r.l)(c.meta.ESRI_lod)&&"screenSpaceRadius"===c.meta.ESRI_lod.metric&&(S=c.meta.ESRI_lod.thresholds[l]),c.lods[l]=c.lods[l]||{parts:[],name:h,lodThreshold:S},c.lods[l].parts[p]=_}));for(const r of c.lods)r.parts=r.parts.filter((e=>!!e));return{model:c,meta:{isEsriSymbolResource:l,uri:s.uri},customMeta:{}}}function z(e){const t=e.json;let i=null;return t.nodes.forEach((e=>{const t=e.extras;Object(r.l)(t)&&(t.ESRI_proxyEllipsoid||t.ESRI_lod)&&(i=t)})),i}function L(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function F(e,t,i){const r=t=>{const r=`${i}_tex_${t&&t.id}${t&&t.name?"_"+t.name:""}`;if(t&&!e.textures.has(r)){const i=function(e,t={}){return{data:e,parameters:{wrap:{s:10497,t:10497,...t.wrap},noUnpackFlip:!0,mipmap:!1,...t}}}(t.data,{wrap:{s:t.wrapS,t:t.wrapT},mipmap:G.some((e=>e===t.minFilter)),noUnpackFlip:!0});e.textures.set(r,i)}return r},n=`${i}_mat_${t.id}_${t.name}`;if(!e.materials.has(n)){const i=function(e={}){return{color:[1,1,1],opacity:1,alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1,castShadows:!0,receiveShadows:!0,receiveAmbientOcclustion:!0,textureColor:null,textureNormal:null,textureOcclusion:null,textureEmissive:null,textureMetallicRoughness:null,emissiveFactor:[0,0,0],metallicFactor:1,roughnessFactor:1,colorMixMode:"multiply",...e}}({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?r(t.colorTexture):void 0,textureNormal:t.normalTexture?r(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?r(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?r(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(n,i)}return n}const V=new class{error(e){throw new a.a("gltf-loader-error",e)}errorUnsupported(e){throw new a.a("gltf-loader-unsupported-feature",e)}errorUnsupportedIf(e,t){e&&this.errorUnsupported(t)}assert(e,t){e||this.error(t)}warn(e){s.warn(e)}warnUnsupported(e){this.warn("[Unsupported Feature] "+e)}warnUnsupportedIf(e,t){e&&this.warnUnsupported(t)}},G=[9987,9985],U=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"]},1059:function(e,t,i){"use strict";i.d(t,"a",(function(){return R}));var r=i(85),n=i(444);class a{constructor(){this.enabled=!0,this._time=0}get time(){return Object(n.a)(this._time)}advance(e){return Object(r.l)(e.forcedTime)?this._time!==e.forcedTime&&(this._time=e.forcedTime,!0):!(!this.enabled||0===e.dt)&&(this._time+=e.dt,!0)}}var s=i(564),o=i(481),c=i(430),l=i(577),d=i(79),h=i(306),u=i(402),p=i(352),f=i(604),b=i(1012),m=i(907),g=i(530),v=i(419),y=i(432),O=i(433),x=i(434),j=i(420),_=i(962),S=i(393);class w extends y.a{constructor(e,t,i){super(e,t,i),this._textureRepository=e.waterTextureRepository}initializeProgram(e){const t=w.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:i.useSSR,highStepCount:!0,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new j.a(e.rctx,r,x.a)}bindPass(e,t){Object(g.c)(this.program,t.camera.projectionMatrix),t.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(p.a)(this.program,t)),0===this.configuration.output&&(t.lighting.setUniforms(this.program,!1),Object(b.b)(this.program,t)),0!==this.configuration.output&&2!==this.configuration.output||(Object(m.b)(this.program,e),this._textureRepository.bind(this.program)),this.program.setUniform4fv("waterColor",e.color),4===this.configuration.output&&Object(u.b)(this.program,t)}bindDraw(e){Object(g.d)(this.program,e),this.program.rebindTextures(),0!==this.configuration.output&&7!==this.configuration.output||Object(g.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&Object(f.b)(this.program,e),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||Object(h.c)(this.program,this.configuration,e)}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e;return Object(S.f)({blending:2!==t.output&&4!==t.output&&t.transparent?i?c.g:Object(c.a)(e):null,depthTest:{func:Object(c.b)(e)},depthWrite:i?t.writeDepth&&S.d:Object(c.c)(e),colorWrite:S.c,polygonOffset:i||r?null:Object(c.h)(t.enableOffset)})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}w.shader=new v.a(_.a,(()=>i.e(335).then(i.bind(null,1354))));class C extends O.a{constructor(){super(...arguments),this.output=0,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(d.a)([Object(O.b)({count:8})],C.prototype,"output",void 0),Object(d.a)([Object(O.b)()],C.prototype,"receiveShadows",void 0),Object(d.a)([Object(O.b)()],C.prototype,"slicePlaneEnabled",void 0),Object(d.a)([Object(O.b)()],C.prototype,"transparent",void 0),Object(d.a)([Object(O.b)()],C.prototype,"enableOffset",void 0),Object(d.a)([Object(O.b)()],C.prototype,"writeDepth",void 0),Object(d.a)([Object(O.b)()],C.prototype,"useSSR",void 0),Object(d.a)([Object(O.b)()],C.prototype,"isDraped",void 0),Object(d.a)([Object(O.b)({count:4})],C.prototype,"transparencyPassType",void 0),Object(d.a)([Object(O.b)()],C.prototype,"multipassTerrainEnabled",void 0),Object(d.a)([Object(O.b)()],C.prototype,"cullAboveGround",void 0);class P extends l.a{updateParameters(e){return this.ensureTechnique(w,e)}setElapsedTimeUniform(e){const t=.001*this._material.animation.time;e.setUniform1f("timeElapsed",t*this._material.parameters.animationSpeed)}_updateShadowState(e){e.shadowMappingEnabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMappingEnabled})}_updateSSRState(e){e.ssrEnabled!==this._material.parameters.ssrEnabled&&this._material.setParameters({ssrEnabled:e.ssrEnabled})}ensureResources(e){const t=this._techniqueRep.constructionContext.waterTextureRepository;return t.ready||t.updating||t.loadTextures(e),t.ready?2:1}beginSlot(e){return 0===this._output&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.parameters,e),2!==this._output&&0!==this._output||this.setElapsedTimeUniform(t.program)}}var T=i(661),E=i(425),A=i(1040);class R extends o.a{constructor(e){super(e,A.a),this._techniqueConfig=new C,this.animation=new a}getTechniqueConfig(e,t){return this._techniqueConfig.output=e,this._techniqueConfig.writeDepth=this.parameters.writeDepth,this._techniqueConfig.receiveShadows=this.parameters.receiveShadows,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.transparent=this.parameters.transparent,this._techniqueConfig.useSSR=this.parameters.ssrEnabled,this._techniqueConfig.isDraped=this.parameters.isDraped,this._techniqueConfig.transparencyPassType=t.transparencyPassType,this._techniqueConfig.enableOffset=t.camera.relativeElevation<c.e,this._techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this._techniqueConfig.cullAboveGround=t.cullAboveGround,this._techniqueConfig}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<D;const i=this.animation.advance(e);return this.animation.enabled&&i}intersect(e,t,i,r,n,a,s){Object(E.f)(e,t,r,n,a,void 0,s)}requiresSlot(e,t){switch(Object(s.b)(t)){case 2:return 21===e;case 0:if(this.parameters.isDraped)return 20===e;break;case 4:return 2===e||20===e}let i=2;return this.parameters.transparent&&(i=this.parameters.writeDepth?4:7),e===i}createGLMaterial(e){if(0===e.output&&this.parameters.isDraped)return e.output=5,new P(e);switch(e.output){case 0:case 2:case 4:case 7:return new P(e)}return null}createBufferWriter(){return new T.a(T.d)}}const D=35e3},1061:function(e,t,i){"use strict";i.d(t,"a",(function(){return Y}));var r=i(113),n=i(85),a=i(101),s=i(271),o=i(331),c=i(149),l=i(199),d=i(145),h=i(224),u=i(116),p=i(106);function f(e){return(t=e)instanceof Float32Array&&t.length>=16||function(e){return Array.isArray(e)&&e.length>=16}(e);var t}var b=i(118),m=i(514),g=i(541),v=i(564),y=i(957),O=i(481),x=i(858),j=i(315),_=i(602),S=i(425),w=i(529),C=i(778),P=i(79),T=i(306),E=i(709),A=i(779),R=i(402),D=i(815),M=i(352),I=i(623),z=i(814),L=i(530),F=i(419),V=i(432),G=i(433),U=i(434),B=i(430),N=i(420),k=i(393);class H extends V.a{initializeProgram(e){const t=H.shader.get(),i=this.configuration,r=t.build({output:i.output,FrontFacePass:2===i.transparencyPassType,viewingMode:e.viewingMode,occlusionTestEnabled:i.occlusionTestEnabled,signedDistanceFieldEnabled:i.sdf,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,debugDrawBorder:i.debugDrawBorder,binaryHighlightOcclusionEnabled:i.binaryHighlightOcclusion,screenCenterOffsetUnitsEnabled:i.screenCenterOffsetUnitsEnabled,screenSizePerspectiveEnabled:i.screenSizePerspective,verticalOffsetEnabled:i.verticalOffset,pixelSnappingEnabled:i.pixelSnappingEnabled,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!1,isDraped:i.isDraped,multipassGeometryEnabled:i.multipassGeometryEnabled,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new N.a(e.rctx,r,U.a)}bindPass(e,t){Object(L.c)(this.program,t.camera.projectionMatrix),this.program.setUniform1f("cameraGroundRelative",t.camera.aboveGround?1:-1),this.program.setUniform1f("perDistancePixelRatio",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix),this.program.setUniform1f("polygonOffset",e.shaderPolygonOffset),Object(E.b)(this.program,e,t),Object(z.b)(this.program,e),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio||1),Object(L.f)(this.program,t),6===this.configuration.output?(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(D.a)(this.program,t),Object(M.a)(this.program,t)):(Object(A.b)(this.program,t),Object(C.c)(this.program,e,t.camera.pixelRatio||1),Object(I.b)(this.program,e),this.configuration.occlusionTestEnabled&&this.program.bindTexture(t.hudVisibilityTexture,"hudVisibilityTexture")),4===this.configuration.output&&Object(R.b)(this.program,t)}bindDraw(e){Object(L.d)(this.program,e),Object(L.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),Object(T.c)(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e,n=this.configuration.polygonOffsetEnabled&&q,a=(i||r)&&4!==t.output?(t.depthEnabled||6===t.output)&&k.d:null;return Object(k.f)({blending:0===t.output||7===t.output||4===t.output?i?W:Object(B.a)(e):null,depthTest:{func:515},depthWrite:a,colorWrite:k.c,polygonOffset:n})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return 6===this.configuration.output?0:4}}H.shader=new F.a(C.a,(()=>i.e(324).then(i.bind(null,1352))));const q={factor:0,units:-4},W=Object(k.h)(1,771);class $ extends G.a{constructor(){super(...arguments),this.output=0,this.occlusionTestEnabled=!0,this.sdf=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.screenSizePerspective=!1,this.screenCenterOffsetUnitsEnabled=0,this.debugDrawBorder=!1,this.binaryHighlightOcclusion=!0,this.slicePlaneEnabled=!1,this.polygonOffsetEnabled=!1,this.depthEnabled=!0,this.transparencyPassType=3,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.multipassGeometryEnabled=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(P.a)([Object(G.b)({count:8})],$.prototype,"output",void 0),Object(P.a)([Object(G.b)()],$.prototype,"occlusionTestEnabled",void 0),Object(P.a)([Object(G.b)()],$.prototype,"sdf",void 0),Object(P.a)([Object(G.b)()],$.prototype,"vvSize",void 0),Object(P.a)([Object(G.b)()],$.prototype,"vvColor",void 0),Object(P.a)([Object(G.b)()],$.prototype,"verticalOffset",void 0),Object(P.a)([Object(G.b)()],$.prototype,"screenSizePerspective",void 0),Object(P.a)([Object(G.b)({count:2})],$.prototype,"screenCenterOffsetUnitsEnabled",void 0),Object(P.a)([Object(G.b)()],$.prototype,"debugDrawBorder",void 0),Object(P.a)([Object(G.b)()],$.prototype,"binaryHighlightOcclusion",void 0),Object(P.a)([Object(G.b)()],$.prototype,"slicePlaneEnabled",void 0),Object(P.a)([Object(G.b)()],$.prototype,"polygonOffsetEnabled",void 0),Object(P.a)([Object(G.b)()],$.prototype,"depthEnabled",void 0),Object(P.a)([Object(G.b)({count:4})],$.prototype,"transparencyPassType",void 0),Object(P.a)([Object(G.b)()],$.prototype,"pixelSnappingEnabled",void 0),Object(P.a)([Object(G.b)()],$.prototype,"isDraped",void 0),Object(P.a)([Object(G.b)()],$.prototype,"multipassGeometryEnabled",void 0),Object(P.a)([Object(G.b)()],$.prototype,"multipassTerrainEnabled",void 0),Object(P.a)([Object(G.b)()],$.prototype,"cullAboveGround",void 0);class Y extends O.a{constructor(e){super(e,be),this.techniqueConfig=new $}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.verticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits?1:0,this.techniqueConfig.polygonOffsetEnabled=this.parameters.polygonOffset,this.techniqueConfig.isDraped=this.parameters.isDraped,this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this.techniqueConfig.sdf=this.parameters.textureIsSignedDistanceField,this.techniqueConfig.vvSize=!!this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=!!this.parameters.vvColorEnabled,0===e&&(this.techniqueConfig.debugDrawBorder=!!this.parameters.debugDrawBorder),4===e&&(this.techniqueConfig.binaryHighlightOcclusion=this.parameters.binaryHighlightOcclusion),this.techniqueConfig.depthEnabled=this.parameters.depthEnabled,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.multipassGeometryEnabled=t.multipassGeometryEnabled,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,r,a,s,o,c,l){Object(n.l)(l)?this.intersectDrapedHudGeometry(e,s,o,c,l):this.intersectHudGeometry(e,t,i,r,o,c)}intersectDrapedHudGeometry(e,t,i,r,a){const s=e.vertexAttributes.get("position"),o=e.vertexAttributes.get("size"),c=this.parameters,l=Object(C.d)(c);let d=1,h=1;if(Object(n.l)(r)){const e=r(de);d=e[0],h=e[5]}d*=e.screenToWorldRatio,h*=e.screenToWorldRatio;const u=ue*e.screenToWorldRatio;for(let n=0;n<s.data.length/s.size;n++){const r=n*s.size,p=s.data[r],f=s.data[r+1],b=n*o.size;let m;pe[0]=o.data[b]*d,pe[1]=o.data[b+1]*h,c.textureIsSignedDistanceField&&(m=c.outlineSize*e.screenToWorldRatio/2),Q(t,p,f,pe,u,m,c,l)&&i(a.dist,a.normal,-1,!0)}}intersectHudGeometry(e,t,i,r,a,o){if(!r.options.selectionMode||!r.options.hud||Object(w.d)(t))return;const l=this.parameters;let d=1,h=1;if(Object(s.f)(ae,i),Object(n.l)(o)){const e=o(de);d=e[0],h=e[5],function(e){const t=e[0],i=e[1],r=e[2],n=e[3],a=e[4],s=e[5],o=e[6],c=e[7],l=e[8],d=1/Math.sqrt(t*t+i*i+r*r),h=1/Math.sqrt(n*n+a*a+s*s),u=1/Math.sqrt(o*o+c*c+l*l);e[0]=t*d,e[1]=i*d,e[2]=r*d,e[3]=n*h,e[4]=a*h,e[5]=s*h,e[6]=o*u,e[7]=c*u,e[8]=l*u}(ae)}const f=e.vertexAttributes.get("position"),b=e.vertexAttributes.get("size"),m=e.vertexAttributes.get("normal"),g=e.vertexAttributes.get("auxpos1");Object(j.a)(f.size>=3);const v=r.point,y=r.camera,O=Object(C.d)(l);d*=y.pixelRatio,h*=y.pixelRatio;const _="screen"===this.parameters.centerOffsetUnits;for(let n=0;n<f.data.length/f.size;n++){const e=n*f.size;Object(u.w)(ee,f.data[e],f.data[e+1],f.data[e+2]),Object(u.q)(ee,ee,i);const t=n*b.size;pe[0]=b.data[t]*d,pe[1]=b.data[t+1]*h,Object(u.q)(ee,ee,y.viewMatrix);const s=n*g.size;if(Object(u.w)(ce,g.data[s+0],g.data[s+1],g.data[s+2]),!_&&(ee[0]+=ce[0],ee[1]+=ce[1],0!==ce[2])){const e=ce[2];Object(u.r)(ce,ee),Object(u.j)(ee,ee,Object(u.e)(ce,ce,e))}const o=n*m.size;if(Object(u.w)(te,m.data[o],m.data[o+1],m.data[o+2]),this.normalAndViewAngle(te,ae,y,le),this.applyVerticalOffsetTransformationView(ee,le,y,J),y.applyProjection(ee,ie),ie[0]>-1){let e=Math.floor(ie[0])+this.parameters.screenOffset[0],t=Math.floor(ie[1])+this.parameters.screenOffset[1];_&&(e+=ce[0],0!==ce[1]&&(t+=Object(x.b)(ce[1],J.factorAlignment))),Object(x.a)(pe,J.factor,pe);const i=he*y.pixelRatio;let n;if(l.textureIsSignedDistanceField&&(n=l.outlineSize*y.pixelRatio/2),Q(v,e,t,pe,i,n,l,O)){const e=r.ray;if(Object(u.q)(ne,ee,Object(c.c)(oe,y.viewMatrix)),ie[0]=v[0],ie[1]=v[1],y.unprojectFromRenderScreen(ie,ee)){const t=Object(p.f)();Object(u.k)(t,e.direction);const i=1/Object(u.p)(t);Object(u.e)(t,t,i),a(Object(u.m)(e.origin,ee)*i,t,-1,!0,1,ne)}}}}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return!1;const r=i.get("position"),n=e.indices.get("position");return Object(g.b)(r,n,t)}createBufferWriter(){return new ge(this)}normalAndViewAngle(e,t,i,r){return f(t)&&(t=Object(s.f)(se,t)),Object(u.x)(r.normal,e,t),Object(u.q)(r.normal,r.normal,i.viewInverseTransposeMatrix),r.cosAngle=Object(u.h)(re,fe),r}updateScaleInfo(e,t,i){const r=this.parameters;r.screenSizePerspective?Object(x.c)(i,t,r.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),r.screenSizePerspectiveAlignment?Object(x.c)(i,t,r.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)}applyShaderOffsetsView(e,t,i,r,n,a,s){const o=this.normalAndViewAngle(t,i,n,le);return this.applyVerticalGroundOffsetView(e,o,n,s),this.applyVerticalOffsetTransformationView(s,o,n,a),this.applyPolygonOffsetView(s,o,r[3],n,s),this.applyCenterOffsetView(s,r,s),s}applyShaderOffsetsNDC(e,t,i,r,a){return this.applyCenterOffsetNDC(e,t,i,r),Object(n.l)(a)&&Object(u.k)(a,r),this.applyPolygonOffsetNDC(r,t,i,r),r}applyPolygonOffsetView(e,t,i,n,a){const s=n.aboveGround?1:-1;let o=Math.sign(i);0===o&&(o=s);const c=s*o;if(this.parameters.shaderPolygonOffset<=0)return Object(u.k)(a,e);const l=Object(r.e)(Math.abs(t.cosAngle),.01,1),d=1-Math.sqrt(1-l*l)/l/n.viewport[2];return Object(u.e)(a,e,c>0?d:1/d),a}applyVerticalGroundOffsetView(e,t,i,r){const n=Object(u.p)(e),a=i.aboveGround?1:-1,s=.5*i.computeRenderPixelSizeAtDist(n),o=Object(u.e)(ee,t.normal,a*s);return Object(u.f)(r,e,o),r}applyVerticalOffsetTransformationView(e,t,i,r){const n=this.parameters;if(!n.verticalOffset||!n.verticalOffset.screenLength){if(n.screenSizePerspective||n.screenSizePerspectiveAlignment){const i=Object(u.p)(e);this.updateScaleInfo(r,i,t.cosAngle)}else r.factor.scale=1,r.factorAlignment.scale=1;return e}const a=Object(u.p)(e),s=n.screenSizePerspectiveAlignment||n.screenSizePerspective,o=Object(S.i)(i,a,n.verticalOffset,t.cosAngle,s);return this.updateScaleInfo(r,a,t.cosAngle),Object(u.e)(t.normal,t.normal,o),Object(u.f)(e,e,t.normal)}applyCenterOffsetView(e,t,i){const r="screen"!==this.parameters.centerOffsetUnits;return i!==e&&Object(u.k)(i,e),r&&(i[0]+=t[0],i[1]+=t[1],t[2]&&(Object(u.r)(te,i),Object(u.f)(i,i,Object(u.e)(te,te,t[2])))),i}applyCenterOffsetNDC(e,t,i,r){const n="screen"!==this.parameters.centerOffsetUnits;return r!==e&&Object(u.k)(r,e),n||(r[0]+=t[0]/i.fullWidth*2,r[1]+=t[1]/i.fullHeight*2),r}applyPolygonOffsetNDC(e,t,i,r){const n=this.parameters.shaderPolygonOffset;if(e!==r&&Object(u.k)(r,e),n){const e=i.aboveGround?1:-1,a=e*Math.sign(t[3]);r[2]-=(a||e)*n}return r}requiresSlot(e,t){const i=Object(v.b)(t);if(0===i||7===i){if(20===e)return!0;const t=this.parameters.drawInSecondSlot?17:16;return this.parameters.occlusionTest&&11===e||e===t}return e===(this.parameters.drawInSecondSlot?17:16)||20===e}createGLMaterial(e){return 0===e.output||7===e.output?new X(e):4===e.output?new Z(e):null}calculateRelativeScreenBounds(e,t,i=Object(b.l)()){return function(e,t,i,r=K){Object(d.c)(r,e.anchorPos),r[0]*=-t[0],r[1]*=-t[1],r[0]+=e.screenOffset[0]*i,r[1]+=e.screenOffset[1]*i}(this.parameters,e,t,i),i[2]=i[0]+e[0],i[3]=i[1]+e[1],i}}class Z extends y.a{constructor(e){super({...e,...e.material.parameters})}updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this.selectProgram(e)}selectProgram(e){return this.ensureTechnique(H,e)}beginSlot(e){return this.updateParameters(e)}bind(e,t){this.bindTextures(t.program),this.bindTextureScale(t.program),t.bindPass(this._material.parameters,e)}}class X extends Z{isOcclusionSlot(e){return 11===e.slot&&this._material.parameters.occlusionTest&&(0===this._output||7===this._output)}selectProgram(e){return this.ensureTechnique(H,e,this.isOcclusionSlot(e)?6:this._output)}bind(e,t){this.isOcclusionSlot(e)||(this.bindTextures(t.program),this.bindTextureScale(t.program)),t.bindPass(this._material.parameters,e)}}function Q(e,t,i,r,n,a,s,o){let c=t-n-(o[0]>0?r[0]*o[0]:0),l=c+r[0]+2*n,d=i-n-(o[1]>0?r[1]*o[1]:0),h=d+r[1]+2*n;if(s.textureIsSignedDistanceField){const e=s.distanceFieldBoundingBox;c+=r[0]*e[0],d+=r[1]*e[1],l-=r[0]*(1-e[2]),h-=r[1]*(1-e[3]),c-=a,l+=a,d-=a,h+=a}return e[0]>c&&e[0]<l&&e[1]>d&&e[1]<h}const J={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},K=Object(h.a)(),ee=Object(p.f)(),te=Object(p.f)(),ie=Object(a.d)(),re=Object(p.f)(),ne=Object(p.f)(),ae=Object(o.b)(),se=Object(o.b)(),oe=Object(l.d)(),ce=Object(p.f)(),le={normal:re,cosAngle:0},de=Object(l.d)(),he=1,ue=2,pe=[0,0],fe=Object(p.h)(0,0,1),be={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:Object(h.e)(.5,.5),shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,pixelSnappingEnabled:!0,debugDrawBorder:!1,isDraped:!1,...O.b},me=Object(m.a)().vec3f("position").vec3f("normal").vec2f("uv0").vec4u8("color").vec2f("size").vec4f("auxpos1").vec4f("auxpos2");class ge{constructor(e){this.material=e,this.vertexBufferLayout=me}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get("position").length}write(e,t,i,r){Object(_.e)(t.indices.get("position"),t.vertexAttributes.get("position").data,e.transformation,i.position,r,6),Object(_.d)(t.indices.get("normal"),t.vertexAttributes.get("normal").data,e.invTranspTransformation,i.normal,r,6);{const e=t.vertexAttributes.get("uv0").data;let n,a,s,o;if(null==e||e.length<4){const e=this.material.parameters;n=0,a=0,s=e.texCoordScale[0],o=e.texCoordScale[1]}else n=e[0],a=e[1],s=e[2],o=e[3];s=Math.min(1.99999,s+1),o=Math.min(1.99999,o+1);const c=t.indices.get("position").length,l=i.uv0;let d=r;for(let t=0;t<c;++t)l.set(d,0,n),l.set(d,1,a),d+=1,l.set(d,0,s),l.set(d,1,a),d+=1,l.set(d,0,s),l.set(d,1,o),d+=1,l.set(d,0,s),l.set(d,1,o),d+=1,l.set(d,0,n),l.set(d,1,o),d+=1,l.set(d,0,n),l.set(d,1,a),d+=1}Object(_.b)(t.indices.get("color"),t.vertexAttributes.get("color").data,4,i.color,r,6);{const e=t.indices.get("size"),n=t.vertexAttributes.get("size").data,a=e.length,s=i.size;let o=r;for(let t=0;t<a;++t){const i=n[2*e[t]],r=n[2*e[t]+1];for(let e=0;e<6;++e)s.set(o,0,i),s.set(o,1,r),o+=1}}t.indices.get("auxpos1")&&t.vertexAttributes.get("auxpos1")&&Object(_.a)(t.indices.get("auxpos1"),t.vertexAttributes.get("auxpos1").data,i.auxpos1,r,6),t.indices.get("auxpos2")&&t.vertexAttributes.get("auxpos2")&&Object(_.a)(t.indices.get("auxpos2"),t.vertexAttributes.get("auxpos2").data,i.auxpos2,r,6)}}},1062:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(681);Object.freeze({__proto__:null,copy:function(e,t,i){const r=e.typedBuffer,n=e.typedBufferStride,a=t.typedBuffer,s=t.typedBufferStride,o=i?i.count:t.count;let c=(i&&i.dstIndex?i.dstIndex:0)*n,l=(i&&i.srcIndex?i.srcIndex:0)*s;for(let d=0;d<o;++d){for(let e=0;e<9;++e)r[c+e]=a[l+e];c+=n,l+=s}}});Object.freeze({__proto__:null,copy:function(e,t,i){const r=e.typedBuffer,n=e.typedBufferStride,a=t.typedBuffer,s=t.typedBufferStride,o=i?i.count:t.count;let c=(i&&i.dstIndex?i.dstIndex:0)*n,l=(i&&i.srcIndex?i.srcIndex:0)*s;for(let d=0;d<o;++d){for(let e=0;e<16;++e)r[c+e]=a[l+e];c+=n,l+=s}}});i(864),i(817),i(770),i(818);function n(e,t){return new e(new ArrayBuffer(t*e.ElementCount*Object(r.a)(e.ElementType)))}},1068:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r=i(961),n=i(136);function a(e){e.fragment.code.add(n.a`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}var s=i(752),o=i(1012);function c(e,t){e.include(s.a,t),e.include(a),e.include(r.a),t.ssrEnabled&&e.include(o.a,t),e.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.775).add("waterSeeColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]),e.fragment.code.add(n.a`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),e.fragment.code.add(n.a`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {
float reflectionHit = 0.;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}`),t.ssrEnabled?e.fragment.code.add(n.a`vec4 viewPosition = vec4(positionView.xyz, 1.0);
vec3 viewDir = normalize(viewPosition.xyz);
vec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = ssrViewMat *vec4(localUp, 0.0);
float correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);
vec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));
vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
reflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;
reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;
}
float seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);
return tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);
}`):e.fragment.code.add(n.a`return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);
}`)}},1083:function(e,t,i){"use strict";i.d(t,"a",(function(){return d})),i.d(t,"b",(function(){return f})),i.d(t,"c",(function(){return o}));i(82);var r=i(88),n=i(85),a=i(356),s=i(225);function o(e,t,i){const n=d(e),s=t,o=c(n,s,i);{let t=null;if(n){const s=a.a.deriveUnitFromSR(n,e.spatialReference).heightUnit;i||s===n.heightUnit||(t=new r.a("layerview:unmatched-height-unit",`The vertical units of the layer must match the horizontal units (${s})`,{horizontalUnit:s}))}if(!("heightModelInfo"in(l=e)&&null!=l.heightModelInfo||null!=l.spatialReference)&&p(l)||4===o||t)return new r.a("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:n,error:t})}var l;{let e=null;switch(o){case 1:{const t=n.heightUnit||"unknown",i=s.heightUnit||"unknown";e=new r.a("layerview:incompatible-height-unit",`The vertical units of the layer (${t}) must match the vertical units of the scene (${i})`,{layerUnit:t,sceneUnit:i});break}case 2:{const t=n.heightModel||"unknown",i=s.heightModel||"unknown";e=new r.a("layerview:incompatible-height-model",`The height model of the layer (${t}) must match the height model of the scene (${i})`,{layerHeightModel:t,sceneHeightModel:i});break}case 3:{const t=n.vertCRS||"unknown",i=s.vertCRS||"unknown";e=new r.a("layerview:incompatible-vertical-datum",`The vertical datum of the layer (${t}) must match the vertical datum of the scene (${i})`,{layerDatum:t,sceneDatum:i});break}}if(e)return new r.a("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:n,sceneHeightModelInfo:s,error:e})}return null}function c(e,t,i){if(!l(e)||!l(t))return 4;if(null==e||null==t)return 0;if(!i&&e.heightUnit!==t.heightUnit)return 1;if(e.heightModel!==t.heightModel)return 2;switch(e.heightModel){case"gravity-related-height":return 0;case"ellipsoidal":return e.vertCRS===t.vertCRS?0:3;default:return 4}}function l(e){return null==e||null!=e.heightModel&&null!=e.heightUnit}function d(e){const t=e.url&&Object(s.f)(e.url);return null==(e.spatialReference&&e.spatialReference.vcsWkid)&&Object(n.l)(t)&&"ImageServer"===t.serverType||!h(e)||!e.heightModelInfo?p(e)?a.a.deriveUnitFromSR(m,e.spatialReference):null:e.heightModelInfo}function h(e){return"heightModelInfo"in e}function u(e){if("unknown"===e.type||!("capabilities"in e))return!1;switch(e.type){case"csv":case"feature":case"geojson":case"subtype-group":case"ogc-feature":case"wfs":return!0;default:return!1}}function p(e){return u(e)?!!(e.capabilities&&e.capabilities.data&&e.capabilities.data.supportsZ):b(e)}function f(e){return null!=e.layers||b(e)||u(e)||h(e)}function b(e){switch(e.type){case"building-scene":case"elevation":case"integrated-mesh":case"point-cloud":case"scene":case"voxel":return!0;case"analysis":case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"csv":case"geojson":case"feature":case"subtype-group":case"geo-rss":case"graphics":case"group":case"imagery":case"imagery-tile":case"kml":case"map-image":case"map-notes":case"ogc-feature":case"open-street-map":case"route":case"stream":case"tile":case"unknown":case"unsupported":case"vector-tile":case"wcs":case"web-tile":case"wfs":case"wms":case"wmts":case null:return!1}return!1}const m=new a.a({heightModel:"gravity-related-height"})},1106:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return o})),i.d(t,"d",(function(){return s})),i.d(t,"e",(function(){return d})),i.d(t,"f",(function(){return n})),i.d(t,"g",(function(){return l}));i(82);var r=i(398);function n(e,t,i){switch(e){default:return a(t,i);case"square":return s(t,i);case"cross":return c(t,i);case"x":return l(t,i);case"kite":return o(t,i);case"triangle":return d(t,i)}}function a(e,t){const i=e,n=new Uint8Array(4*i*i),a=i/2-.5,s=t/2;for(let o=0;o<i;o++)for(let t=0;t<i;t++){const c=t+i*o,l=t-a,d=o-a;let h=Math.sqrt(l*l+d*d)-s;h=h/e+.5,Object(r.a)(h,n,4*c)}return n}function s(e,t){return h(e,t,!1)}function o(e,t){return h(e,t,!0)}function c(e,t){return u(e,t,!1)}function l(e,t){return u(e,t,!0)}function d(e,t){const i=new Uint8Array(4*e*e),n=-.5,a=Math.sqrt(1.25),s=(e-t)/2;for(let o=0;o<e;o++)for(let c=0;c<e;c++){const l=o*e+c,d=(c-s)/t,h=(o-s+.75)/t,u=-(1*d+n*h)/a,p=(1*(d-1)+n*-h)/a,f=-h,b=Math.max(u,p,f);Object(r.a)(b*t/e+.5,i,4*l)}return i}function h(e,t,i){i&&(t/=Math.SQRT2);const n=new Uint8Array(4*e*e);for(let a=0;a<e;a++)for(let s=0;s<e;s++){let o=s-.5*e+.25,c=.5*e-a-.75;const l=a*e+s;if(i){const e=(o+c)/Math.SQRT2;c=(c-o)/Math.SQRT2,o=e}let d=Math.max(Math.abs(o),Math.abs(c))-.5*t;d=d/e+.5,Object(r.a)(d,n,4*l)}return n}function u(e,t,i){i&&(t*=Math.SQRT2);const n=.5*t,a=new Uint8Array(4*e*e);for(let s=0;s<e;s++)for(let t=0;t<e;t++){let o=t-.5*e,c=.5*e-s-1;const l=s*e+t;if(i){const e=(o+c)/Math.SQRT2;c=(c-o)/Math.SQRT2,o=e}let d;o=Math.abs(o),c=Math.abs(c),d=o>c?o>n?Math.sqrt((o-n)*(o-n)+c*c):c:c>n?Math.sqrt(o*o+(c-n)*(c-n)):o,d=d/e+.5,Object(r.a)(d,a,4*l)}return a}},1109:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return s}));var r=i(746),n=i(136);function a(e,t){e.attributes.add("featureValue","vec4"),e.vertex.code.add(n.a`bool isCapVertex() {
return featureValue.w == 1.0;
}`),e.vertex.uniforms.add("size","vec3"),t.vvSize?(e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(n.a`vec2 getSize() {
return size.xy*clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
}`)):e.vertex.code.add(n.a`vec2 getSize(){
return size.xy;
}`),t.vvOpacity?(e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(n.a`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
vec4 applyOpacity(vec4 color) {
float value = featureValue.z;
if (value <= vvOpacityValues[0]) {
return vec4( color.xyz, vvOpacityOpacities[0]);
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
}
}
return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
}`)):e.vertex.code.add(n.a`vec4 applyOpacity(vec4 color){
return color;
}`),t.vvColor?(e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(n.a`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 getColor() {
float value = featureValue.y;
if (value <= vvColorValues[0]) {
return applyOpacity(vvColorColors[0]);
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
}
}
return applyOpacity(vvColorColors[vvColorNumber - 1]);
}`)):e.vertex.code.add(n.a`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),e.include(r.a),e.attributes.add("profileRight","vec4"),e.attributes.add("profileUp","vec4"),e.attributes.add("profileVertexAndNormal","vec4"),e.vertex.code.add(n.a`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),e.vertex.code.add(n.a`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),e.vertex.code.add(n.a`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),e.vertex.code.add(n.a`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}function s(e,t){t.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors)),t.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",t.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",t.vvOpacityOpacities))}},1110:function(e,t,i){"use strict";i.d(t,"a",(function(){return O})),i.d(t,"b",(function(){return y}));var r=i(711),n=i(306),a=i(441),s=i(1109),o=i(634),c=i(402),l=i(401),d=i(715),h=i(790),u=i(352),p=i(911),f=i(908),b=i(604),m=i(467),g=i(136),v=i(342);function y(e){const t=new v.a;return t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),t.varyings.add("vpos","vec3"),t.include(s.a,e),0!==e.output&&7!==e.output||(t.include(a.a,{linearDepth:!1}),e.receiveShadows&&t.include(b.a,e),t.include(r.a,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vcolor","vec4"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(g.a`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${0===e.output?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(l.a),t.include(u.b,e)),7===e.output&&(t.include(n.a,e),t.fragment.uniforms.add("camPos","vec3"),t.fragment.uniforms.add("localOrigin","vec3"),t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(g.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `)),0===e.output&&(t.include(n.a,e),t.include(h.a,e),t.include(d.a,e),e.receiveShadows&&t.include(b.a,e),t.include(p.a,e),t.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("specular","vec3").add("opacity","float"),t.fragment.include(m.a),t.fragment.code.add(g.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

        shadingParams.viewDirection = normalize(vpos - camPos);
        shadingParams.normalView = vnormal;
        vec3 normal = shadingNormal(shadingParams);
        float ssao = evaluateAmbientOcclusionInverse();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":1===e.viewingMode?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
        float combinedOpacity = vcolor.a * opacity;
        albedo += 0.25 * specular; // don't completely ignore specular for now

        vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
        gl_FragColor = vec4(shadedColor, combinedOpacity);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),1!==e.output&&3!==e.output||(t.include(a.a,{linearDepth:!0}),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("depth","float"),t.vertex.code.add(g.a`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),t.include(n.a,e),t.include(o.a,e),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(g.a`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`)),2===e.output&&(t.include(a.a,{linearDepth:!1}),t.include(f.a,e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(g.a`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(n.a,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(g.a`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`)),4===e.output&&(t.include(a.a,{linearDepth:!1}),t.include(f.a,e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(g.a`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(n.a,e),t.include(c.a),t.fragment.code.add(g.a`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}const O=Object.freeze({__proto__:null,build:y})},1111:function(e,t,i){"use strict";i.d(t,"a",(function(){return g})),i.d(t,"b",(function(){return m}));var r=i(306),n=i(441),a=i(603),s=i(634),o=i(402),c=i(401),l=i(352),d=i(406),h=i(467),u=i(136),p=i(342);const f=.70710678118,b=f;function m(e){const t=new p.a;e.draped||t.extensions.add("GL_OES_standard_derivatives");const i=1===e.output;t.include(n.a,{linearDepth:i}),t.include(a.a,e),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("view","mat4"),i&&(t.include(s.a,e),t.vertex.uniforms.add("cameraNearFar","vec2"),t.varyings.add("linearDepth","float")),e.draped?t.vertex.uniforms.add("worldToScreenRatio","float"):(t.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),t.vertex.uniforms.add("camPos","vec3"),t.attributes.add("boundingRect","mat3")),t.attributes.add("position","vec3"),t.attributes.add("uvMapSpace","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),e.multipassTerrainEnabled&&t.varyings.add("depth","float");const m=3===e.style||4===e.style||5===e.style;return m&&t.vertex.code.add(u.a`
      const mat2 rotate45 = mat2(${u.a.float(f)}, ${u.a.float(-b)},
                                 ${u.a.float(b)}, ${u.a.float(f)});
    `),e.draped||(t.vertex.code.add(u.a`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),t.vertex.code.add(u.a`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),t.vertex.code.add(u.a`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${u.a.float(.08715574274)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, camPos, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - camPos);
      }
    `)),t.vertex.code.add(u.a`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${m?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${m?" * rotate45":""};

      ${e.draped?"":u.a`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${u.a.float(e.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `),t.vertex.code.add(u.a`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${i?u.a`transformPositionWithDepth(proj, view, vpos, cameraNearFar, linearDepth);`:u.a`transformPosition(proj, view, vpos);`}
    }
  `),t.include(r.a,e),t.fragment.include(h.a),t.fragment.uniforms.add("matColor","vec4"),e.draped&&t.fragment.uniforms.add("texelSize","float"),4===e.output&&t.include(o.a),e.multipassTerrainEnabled&&(t.fragment.include(c.a),t.include(l.b,e)),4!==e.output&&(t.fragment.code.add(u.a`
      const float lineWidth = ${u.a.float(e.lineWidth)};
      const float spacing = ${u.a.float(e.patternSpacing)};
      const float spacingINV = ${u.a.float(1/e.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),e.draped||t.fragment.code.add(u.a`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),t.fragment.code.add(u.a`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${e.attributeColor?"vColor * matColor;":"matColor;"}
      color = highlightSlice(color, vpos);

      ${4!==e.output?u.a`color.a *= ${function(e){function t(t){return e.draped?u.a`coverage(vuv.${t}, texelSize)`:u.a`sample(vuv.${t})`}switch(e.style){case 3:case 0:return t("y");case 4:case 1:return t("x");case 5:case 2:return u.a`
        1.0 - (1.0 - ${t("x")}) * (1.0 - ${t("y")})
      `;default:return"0.0"}}(e)};`:""}

      if (color.a < ${u.a.float(d.c)}) {
        discard;
      }

      ${7===e.output?u.a`gl_FragColor = vec4(color.a);`:""}

      ${0===e.output?u.a`gl_FragColor = color; ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${4===e.output?u.a`outputHighlight();`:""}
      ${1===e.output?u.a`outputDepth(linearDepth);`:""};
    }
  `),t}const g=Object.freeze({__proto__:null,build:m})},1139:function(e,t,i){"use strict";i.d(t,"a",(function(){return z}));var r=i(87),n=i(85),a=i(101),s=i(145),o=i(116),c=i(106),l=i(456),d=i(362),h=i(403),u=i(541),p=i(577),f=i(481),b=i(315),m=i(602),g=i(661),v=i(425),y=i(529),O=i(79),x=i(306),j=i(402),_=i(530),S=i(419),w=i(432),C=i(433),P=i(434),T=i(420),E=i(651),A=i(964),R=i(393);class D extends w.a{constructor(e,t,i){super(e,t,i),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&4!==this.configuration.output}initializeProgram(e){const t=D.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:i.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleRequiresClamp:!1,stippleScaleWithLineWidth:!1,stipplePreferContinuous:i.stipplePreferContinuous});return new T.a(e.rctx,r,P.a)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,t){if(Object(_.c)(this.program,t.camera.projectionMatrix),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.stippleEnabled){const{pixelSize:e,sdfNormalizer:i,pixels:r}=Object(n.l)(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};this.program.setUniform1f("stipplePatternSDFNormalizer",i),this.program.setUniform1f("stipplePatternTextureSize",r),this.program.setUniform1f("stipplePatternPixelSize",e),this.program.setUniform1f("stipplePatternPixelSizeInv",1/e),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/t.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/t.camera.perScreenPixelRatio),this.program.setUniform2f("ndcToPixel",t.camera.fullViewport[2]/2,t.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",e.color),this.program.setUniform1f("alphaCoverage",Math.min(1,e.width*t.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const t=Object(n.t)(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}4===this.configuration.output&&Object(j.b)(this.program,t)}bindDraw(e){Object(_.d)(this.program,e),this.stippleEnabled&&!this.configuration.draped&&Object(_.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),Object(x.c)(this.program,this.configuration,e),this.program.rebindTextures()}initializePipeline(){const e=this.configuration,t=Object(R.g)(770,1,771,771),i=(t,i=null,r=null)=>Object(R.f)({blending:i,depthTest:E.b,depthWrite:r,colorWrite:R.c,stencilWrite:e.sceneHasOcludees?E.h:null,stencilTest:e.sceneHasOcludees?t?E.d:E.c:null});return 0===e.output?(this._occludeePipelineState=i(!0,e.transparent||this.stippleEnabled?t:null,R.d),i(!1,e.transparent||this.stippleEnabled?t:null,R.d)):i(!1)}get primitiveType(){return 1}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}D.shader=new S.a(A.a,(()=>i.e(329).then(i.bind(null,1359))));class M extends C.a{constructor(){super(...arguments),this.output=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.sceneHasOcludees=!1}}Object(O.a)([Object(C.b)({count:8})],M.prototype,"output",void 0),Object(O.a)([Object(C.b)()],M.prototype,"slicePlaneEnabled",void 0),Object(O.a)([Object(C.b)()],M.prototype,"vertexColors",void 0),Object(O.a)([Object(C.b)()],M.prototype,"transparent",void 0),Object(O.a)([Object(C.b)()],M.prototype,"draped",void 0),Object(O.a)([Object(C.b)()],M.prototype,"stippleEnabled",void 0),Object(O.a)([Object(C.b)()],M.prototype,"stippleOffColorEnabled",void 0),Object(O.a)([Object(C.b)()],M.prototype,"stipplePreferContinuous",void 0),Object(O.a)([Object(C.b)()],M.prototype,"sceneHasOcludees",void 0);const I=r.a.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");class z extends f.a{constructor(e){super(e,V),this._techniqueConfig=new M}getTechniqueConfig(e,t){this._techniqueConfig.output=e,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.vertexColors=this.parameters.vertexColors,this._techniqueConfig.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._techniqueConfig.draped=20===t.slot;const i=Object(n.l)(this.parameters.stipplePattern);return this._techniqueConfig.stippleEnabled=i,this._techniqueConfig.stippleOffColorEnabled=i&&Object(n.l)(this.parameters.stippleOffColor),this._techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this._techniqueConfig.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._techniqueConfig}getPassParameters(){return this.parameters}intersect(e,t,i,r,a,s,o,c,l){Object(n.l)(l)?Object(v.e)(e,r,l,s,1,o):this.intersectLineGeometry(e,t,i,r,o)}intersectLineGeometry(e,t,i,r,n){if(!r.options.selectionMode||Object(y.d)(t))return;if(!Object(b.g)(i))return void I.error("intersection assumes a translation-only matrix");const a=e.vertexAttributes.get("position").data,c=r.camera,h=Z;Object(s.c)(h,r.point);Object(o.w)(X[0],h[0]-2,h[1]+2,0),Object(o.w)(X[1],h[0]+2,h[1]+2,0),Object(o.w)(X[2],h[0]+2,h[1]-2,0),Object(o.w)(X[3],h[0]-2,h[1]-2,0);for(let s=0;s<4;s++)if(!c.unprojectFromRenderScreen(X[s],Q[s]))return;Object(d.f)(c.eye,Q[0],Q[1],J),Object(d.f)(c.eye,Q[1],Q[2],K),Object(d.f)(c.eye,Q[2],Q[3],ee),Object(d.f)(c.eye,Q[3],Q[0],te);let u=Number.MAX_VALUE,p=0;for(let s=0;s<a.length-5;s+=3){if(G[0]=a[s]+i[12],G[1]=a[s+1]+i[13],G[2]=a[s+2]+i[14],U[0]=a[s+3]+i[12],U[1]=a[s+4]+i[13],U[2]=a[s+5]+i[14],Object(d.t)(J,G)<0&&Object(d.t)(J,U)<0||Object(d.t)(K,G)<0&&Object(d.t)(K,U)<0||Object(d.t)(ee,G)<0&&Object(d.t)(ee,U)<0||Object(d.t)(te,G)<0&&Object(d.t)(te,U)<0)continue;if(c.projectToRenderScreen(G,k),c.projectToRenderScreen(U,H),k[2]<0&&H[2]>0){Object(o.j)(B,G,U);const e=c.frustum,t=-Object(d.t)(e[4],G)/Object(o.h)(B,Object(d.q)(e[4]));Object(o.e)(B,B,t),Object(o.f)(G,G,B),c.projectToRenderScreen(G,k)}else if(k[2]>0&&H[2]<0){Object(o.j)(B,U,G);const e=c.frustum,t=-Object(d.t)(e[4],U)/Object(o.h)(B,Object(d.q)(e[4]));Object(o.e)(B,B,t),Object(o.f)(U,U,B),c.projectToRenderScreen(U,H)}else if(k[2]<0&&H[2]<0)continue;k[2]=0,H[2]=0;const e=Object(l.e)(Object(l.f)(k,H,$),h);e<u&&(u=e,Object(o.k)(q,G),Object(o.k)(W,U),p=s/3)}const f=r.rayBegin,m=r.rayEnd;if(u<4){let e=Number.MAX_VALUE;if(Object(l.a)(Object(l.f)(q,W,$),Object(l.f)(f,m,Y),N)){Object(o.j)(N,N,f);const t=Object(o.p)(N);Object(o.e)(N,N,1/t),e=t/Object(o.m)(f,m)}n(e,N,p,!1)}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return!1;const r=i.get("position");return Object(u.a)(r,null,!1,t)}requiresSlot(e){return 2===e||20===e}createGLMaterial(e){return 0===e.output||4===e.output?new L(e):null}createBufferWriter(){const e=this.parameters.vertexColors?g.b:g.c;return Object(n.k)(this.parameters.stipplePattern)?new g.a(e):new F(e.clone().vec3f("auxpos1").vec2f("uv0"))}}class L extends p.a{updateParameters(e){return this.ensureTechnique(D,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return 0===this._output&&this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}class F{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,r){Object(m.c)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r),this.writeAuxpos1(e,t,i,r),this.writeUV0(e,t,i,r)}writeAuxpos1(e,t,i,r){const n=i.getField("auxpos1",h.u),a=t.indices.get("position"),s=t.vertexAttributes.get("position").data,o=e.transformation,c=n.typedBufferStride,l=n.typedBuffer;r*=c;for(let d=0;d<a.length-1;d+=2)for(const e of[1,0]){const t=3*a[d+e],i=s[t],n=s[t+1],h=s[t+2],u=o[0]*i+o[4]*n+o[8]*h+o[12],p=o[1]*i+o[5]*n+o[9]*h+o[13],f=o[2]*i+o[6]*n+o[10]*h+o[14];l[r]=u,l[r+1]=p,l[r+2]=f,r+=c}}writeUV0(e,t,i,r){var n;const a=i.getField("uv0",h.m),s=t.indices.get("position"),c=t.vertexAttributes.get("position").data,l=null==(n=t.vertexAttributes.get("distanceToStart"))?void 0:n.data,d=e.transformation,u=a.typedBufferStride,p=a.typedBuffer;let f=0;p[r*=u]=0,p[r+1]=f,r+=u;const b=3*s[0],m=Object(o.w)(G,c[b],c[b+1],c[b+2]);d&&Object(o.q)(m,m,d);const g=U,v=s.length-1;let y=1;const O=l?(e,t,i)=>f=l[i]:(e,t,i)=>f+=Object(o.m)(e,t);for(let h=1;h<v;h+=2){const e=3*s[h];Object(o.w)(g,c[e],c[e+1],c[e+2]),d&&Object(o.q)(g,g,d),O(m,g,y++);for(let t=0;t<2;++t)p[r]=1-t,p[r+1]=f,r+=u;Object(o.k)(m,g)}const x=3*s[v];Object(o.w)(g,c[x],c[x+1],c[x+2]),d&&Object(o.q)(g,g,d),O(m,g,y),p[r]=1,p[r+1]=f}}const V={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleOffColor:null,stipplePreferContinuous:!0,sceneHasOcludees:!1,...f.b},G=Object(c.f)(),U=Object(c.f)(),B=Object(c.f)(),N=Object(c.f)(),k=Object(a.d)(),H=Object(a.d)(),q=Object(c.f)(),W=Object(c.f)(),$=Object(l.d)(),Y=Object(l.d)(),Z=Object(c.f)(),X=[Object(a.d)(),Object(a.d)(),Object(a.d)(),Object(a.d)()],Q=[Object(c.f)(),Object(c.f)(),Object(c.f)(),Object(c.f)()],J=Object(d.d)(),K=Object(d.d)(),ee=Object(d.d)(),te=Object(d.d)()},1140:function(e,t,i){"use strict";i.r(t),i.d(t,"fetch",(function(){return N})),i.d(t,"gltfToEngineResources",(function(){return H})),i.d(t,"parseUrl",(function(){return k}));var r=i(436),n=i(85),a=i(271),s=i(331),o=i(149),c=i(199),l=i(116),d=i(106),h=i(223),u=i(403),p=i(682),f=i(1044),b=i(1062),m=i(1045),g=i(1058),v=i(1046),y=i(102),O=i(287),x=i(88),j=i(87),_=i(91),S=i(640),w=i(949),C=i(566),P=i(821),T=i(750);const E=j.a.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function A(e,t){const i=await async function(e,t){const i=Object(n.l)(t)&&t.streamDataRequester;if(i)return async function(e,t,i){const r=await Object(O.c)(t.request(e,"json",i));if(!0===r.ok)return r.value;Object(_.t)(r.error),R(r.error.details.url)}(e,i,t);const r=await Object(O.c)(Object(y.default)(e,Object(n.t)(t)));if(!0===r.ok)return r.value.data;Object(_.t)(r.error),R(r.error)}(e,t);return{resource:i,textures:await I(i.textureDefinitions,t)}}function R(e){throw new x.a("",`Request for object resource failed: ${e}`)}function D(e){const t=e.params,i=t.topology;let r=!0;switch(t.vertexAttributes||(E.warn("Geometry must specify vertex attributes"),r=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const e=t.faces;if(e){if(t.vertexAttributes)for(const i in t.vertexAttributes){const t=e[i];t&&t.values?(null!=t.valueType&&"UInt32"!==t.valueType&&(E.warn(`Unsupported indexed geometry indices type '${t.valueType}', only UInt32 is currently supported`),r=!1),null!=t.valuesPerElement&&1!==t.valuesPerElement&&(E.warn(`Unsupported indexed geometry values per element '${t.valuesPerElement}', only 1 is currently supported`),r=!1)):(E.warn(`Indexed geometry does not specify face indices for '${i}' attribute`),r=!1)}}else E.warn("Indexed geometries must specify faces"),r=!1;break}default:E.warn(`Unsupported topology '${i}'`),r=!1}e.params.material||(E.warn("Geometry requires material"),r=!1);const n=e.params.vertexAttributes;for(const a in n)n[a].values||(E.warn("Geometries with externally defined attributes are not yet supported"),r=!1);return r}function M(e){const t=Object(h.h)();return e.forEach((e=>{const i=e.boundingInfo;Object(n.l)(i)&&(Object(h.n)(t,i.getBBMin()),Object(h.n)(t,i.getBBMax()))})),t}async function I(e,t){const i=[];for(const s in e){const r=e[s],a=r.images[0].data;if(!a){E.warn("Externally referenced texture data is not yet supported");continue}const o=r.encoding+";base64,"+a,c="/textureDefinitions/"+s,l="rgba"===r.channels?r.alphaChannelUsage||"transparency":"none",d={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:1!==z(l)},h=Object(n.l)(t)&&t.disableTextures?Promise.resolve(null):Object(w.a)(o,t);i.push(h.then((e=>({refId:c,image:e,params:d,alphaChannelUsage:l}))))}const r=await Promise.all(i),a={};for(const n of r)a[n.refId]=n;return a}function z(e){switch(e){case"mask":return 2;case"maskAndTransparency":return 3;case"none":return 1;default:return 0}}function L(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const F=new S.a(1,2,"wosr");var V=i(1047),G=i(817),U=i(818),B=i(770);async function N(e,t){const i=k(Object(r.a)(e));if("wosr"===i.fileType){const e=await(t.cache?t.cache.loadWOSR(i.url,t):A(i.url,t)),r=function(e,t){const i=[],r=[],a=[],s=[],o=e.resource,c=S.a.parse(o.version||"1.0","wosr");F.validate(c);const l=o.model.name,h=o.model.geometries,u=o.materialDefinitions,p=e.textures;let f=0;const b=new Map;for(let m=0;m<h.length;m++){const e=h[m];if(!D(e))continue;const o=L(e),c=e.params.vertexAttributes,l=[];for(const t in c){const e=c[t],i=e.values;l.push([t,{data:i,size:e.valuesPerElement,exclusive:!0}])}const g=[];if("PerAttributeArray"!==e.params.topology){const t=e.params.faces;for(const e in t)g.push([e,new Uint32Array(t[e].values)])}const v=p&&p[o.texture];if(v&&!b.has(o.texture)){const{image:e,params:t}=v,i=new P.a(e,t);s.push(i),b.set(o.texture,i)}const y=b.get(o.texture),O=y?y.id:void 0;let x=a[o.material]?a[o.material][o.texture]:null;if(!x){const e=u[o.material.substring(o.material.lastIndexOf("/")+1)].params;1===e.transparency&&(e.transparency=0);const i=v&&v.alphaChannelUsage,r=e.transparency>0||"transparency"===i||"maskAndTransparency"===i,s=v?z(v.alphaChannelUsage):void 0,c={ambient:Object(d.g)(e.diffuse),diffuse:Object(d.g)(e.diffuse),opacity:1-(e.transparency||0),transparent:r,textureAlphaMode:s,textureAlphaCutoff:.33,textureId:O,initTextureTransparent:!0,doubleSided:!0,cullFace:0,colorMixMode:e.externalColorMixMode||"tint",textureAlphaPremultiplied:!!v&&!!v.params.preMultiplyAlpha};Object(n.l)(t)&&t.materialParamsMixin&&Object.assign(c,t.materialParamsMixin),x=new T.a(c),a[o.material]||(a[o.material]={}),a[o.material][o.texture]=x}r.push(x);const j=new C.a(l,g);f+=g.position?g.position.length:0,i.push(j)}return{name:l,stageResources:{textures:s,materials:r,geometries:i},pivotOffset:o.model.pivotOffset,boundingBox:M(i),numberOfVertices:f,lodThreshold:null}}(e,t);return{lods:[r],referenceBoundingBox:r.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:e.remove}}const a=await(t.cache?t.cache.loadGLTF(i.url,t,t.usePBR):Object(g.a)(new m.a(t.streamDataRequester),i.url,t,t.usePBR)),s=Object(n.j)(a.model.meta,"ESRI_proxyEllipsoid");a.meta.isEsriSymbolResource&&Object(n.l)(s)&&-1!==a.meta.uri.indexOf("/RealisticTrees/")&&function(e,t){for(let i=0;i<e.model.lods.length;++i){const r=e.model.lods[i];e.customMeta.esriTreeRendering=!0;for(const a of r.parts){const r=a.attributes.normal;if(Object(n.k)(r))return;const s=a.attributes.position,h=s.count,p=Object(d.f)(),f=Object(d.f)(),m=Object(d.f)(),g=Object(b.a)(u.J,h),v=Object(b.a)(u.u,h),y=Object(o.c)(Object(c.d)(),a.transform);for(let n=0;n<h;n++){s.getVec(n,f),r.getVec(n,p),Object(l.q)(f,f,a.transform),Object(l.j)(m,f,t.center),Object(l.b)(m,m,t.radius);const o=m[2],c=Object(l.p)(m),d=Math.min(.45+.55*c*c,1);Object(l.b)(m,m,t.radius),Object(l.q)(m,m,y),Object(l.r)(m,m),i+1!==e.model.lods.length&&e.model.lods.length>1&&Object(l.i)(m,m,p,o>-1?.2:Math.min(-4*o-3.8,1)),v.setVec(n,m),g.set(n,0,255*d),g.set(n,1,255*d),g.set(n,2,255*d),g.set(n,3,255)}a.attributes.normal=v,a.attributes.color=g}}}(a,s);const h=a.meta.isEsriSymbolResource?{usePBR:t.usePBR,isSchematic:!1,treeRendering:a.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:t.usePBR,isSchematic:!1,mrrFactors:[0,1,.5]},p={...t.materialParamsMixin,treeRendering:a.customMeta.esriTreeRendering};if(null!=i.specifiedLodIndex){const e=H(a,h,p,i.specifiedLodIndex);let t=e[0].boundingBox;return 0!==i.specifiedLodIndex&&(t=H(a,h,p,0)[0].boundingBox),{lods:e,referenceBoundingBox:t,isEsriSymbolResource:a.meta.isEsriSymbolResource,isWosr:!1,remove:a.remove}}const f=H(a,h,p);return{lods:f,referenceBoundingBox:f[0].boundingBox,isEsriSymbolResource:a.meta.isEsriSymbolResource,isWosr:!1,remove:a.remove}}function k(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function H(e,t,i,r){const o=e.model,c=Object(s.b)(),l=new Array,d=new Map,m=new Map;return o.lods.forEach(((e,s)=>{if(void 0!==r&&s!==r)return;const g={name:e.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:Object(n.l)(e.lodThreshold)?e.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:Object(h.h)()};l.push(g),e.parts.forEach((e=>{const r=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),s=o.materials.get(e.material),l=Object(n.l)(e.attributes.texCoord0),y=Object(n.l)(e.attributes.normal),O=function(e){switch(e){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":case null:case void 0:return 1}}(s.alphaMode);if(!d.has(r)){if(l){if(Object(n.l)(s.textureColor)&&!m.has(s.textureColor)){const e=o.textures.get(s.textureColor),t={...e.parameters,preMultiplyAlpha:1!==O};m.set(s.textureColor,new P.a(e.data,t))}if(Object(n.l)(s.textureNormal)&&!m.has(s.textureNormal)){const e=o.textures.get(s.textureNormal);m.set(s.textureNormal,new P.a(e.data,e.parameters))}if(Object(n.l)(s.textureOcclusion)&&!m.has(s.textureOcclusion)){const e=o.textures.get(s.textureOcclusion);m.set(s.textureOcclusion,new P.a(e.data,e.parameters))}if(Object(n.l)(s.textureEmissive)&&!m.has(s.textureEmissive)){const e=o.textures.get(s.textureEmissive);m.set(s.textureEmissive,new P.a(e.data,e.parameters))}if(Object(n.l)(s.textureMetallicRoughness)&&!m.has(s.textureMetallicRoughness)){const e=o.textures.get(s.textureMetallicRoughness);m.set(s.textureMetallicRoughness,new P.a(e.data,e.parameters))}}const a=s.color[0]**(1/V.a),c=s.color[1]**(1/V.a),h=s.color[2]**(1/V.a),u=s.emissiveFactor[0]**(1/V.a),p=s.emissiveFactor[1]**(1/V.a),f=s.emissiveFactor[2]**(1/V.a),b=Object(n.l)(s.textureColor)&&l?m.get(s.textureColor):null;d.set(r,new T.a({...t,transparent:0===O,textureAlphaMode:O,textureAlphaCutoff:s.alphaCutoff,diffuse:[a,c,h],ambient:[a,c,h],opacity:s.opacity,doubleSided:s.doubleSided,doubleSidedType:"winding-order",cullFace:s.doubleSided?0:2,vertexColors:!!e.attributes.color,vertexTangents:!!e.attributes.tangent,normals:y?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:Object(n.l)(b)?b.id:void 0,colorMixMode:s.colorMixMode,normalTextureId:Object(n.l)(s.textureNormal)&&l?m.get(s.textureNormal).id:void 0,textureAlphaPremultiplied:Object(n.l)(b)&&!!b.params.preMultiplyAlpha,occlusionTextureId:Object(n.l)(s.textureOcclusion)&&l?m.get(s.textureOcclusion).id:void 0,emissiveTextureId:Object(n.l)(s.textureEmissive)&&l?m.get(s.textureEmissive).id:void 0,metallicRoughnessTextureId:Object(n.l)(s.textureMetallicRoughness)&&l?m.get(s.textureMetallicRoughness).id:void 0,emissiveFactor:[u,p,f],mrrFactors:[s.metallicFactor,s.roughnessFactor,t.mrrFactors[2]],isSchematic:!1,...i}))}const x=function(e,t){switch(t){case 4:return Object(v.c)(e);case 5:return Object(v.b)(e);case 6:return Object(v.a)(e)}}(e.indices||e.attributes.position.count,e.primitiveType),j=e.attributes.position.count,_=Object(b.a)(u.u,j);Object(p.e)(_,e.attributes.position,e.transform);const S=[["position",{data:_.typedBuffer,size:_.elementCount,exclusive:!0}]],w=[["position",x]];if(Object(n.l)(e.attributes.normal)){const t=Object(b.a)(u.u,j);Object(a.a)(c,e.transform),Object(p.a)(t,e.attributes.normal,c),S.push(["normal",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),w.push(["normal",x])}if(Object(n.l)(e.attributes.tangent)){const t=Object(b.a)(u.C,j);Object(a.a)(c,e.transform),Object(f.c)(t,e.attributes.tangent,c),S.push(["tangent",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),w.push(["tangent",x])}if(Object(n.l)(e.attributes.texCoord0)){const t=Object(b.a)(u.m,j);Object(G.b)(t,e.attributes.texCoord0),S.push(["uv0",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),w.push(["uv0",x])}if(Object(n.l)(e.attributes.color)){const t=Object(b.a)(u.J,j);if(4===e.attributes.color.elementCount)e.attributes.color instanceof u.C?Object(f.b)(t,e.attributes.color,255):e.attributes.color instanceof u.J?Object(U.a)(t,e.attributes.color):e.attributes.color instanceof u.H&&Object(f.b)(t,e.attributes.color,1/256);else{Object(U.b)(t,255,255,255,255);const i=new u.B(t.buffer,0,4);e.attributes.color instanceof u.u?Object(p.d)(i,e.attributes.color,255):e.attributes.color instanceof u.B?Object(B.a)(i,e.attributes.color):e.attributes.color instanceof u.z&&Object(p.d)(i,e.attributes.color,1/256)}S.push(["color",{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),w.push(["color",x])}const E=new C.a(S,w);g.stageResources.geometries.push(E),g.stageResources.materials.push(d.get(r)),l&&(Object(n.l)(s.textureColor)&&g.stageResources.textures.push(m.get(s.textureColor)),Object(n.l)(s.textureNormal)&&g.stageResources.textures.push(m.get(s.textureNormal)),Object(n.l)(s.textureOcclusion)&&g.stageResources.textures.push(m.get(s.textureOcclusion)),Object(n.l)(s.textureEmissive)&&g.stageResources.textures.push(m.get(s.textureEmissive)),Object(n.l)(s.textureMetallicRoughness)&&g.stageResources.textures.push(m.get(s.textureMetallicRoughness))),g.numberOfVertices+=j;const A=E.boundingInfo;Object(n.l)(A)&&(Object(h.n)(g.boundingBox,A.getBBMin()),Object(h.n)(g.boundingBox,A.getBBMax()))}))})),l}},1161:function(e,t,i){"use strict";i.r(t),i.d(t,"getGeometryServiceURL",(function(){return c})),i.d(t,"projectGeometry",(function(){return l}));var r=i(146),n=i(88),a=i(172),s=i(664),o=i(592);async function c(e=null,t){var i,s;if(r.a.geometryServiceUrl)return r.a.geometryServiceUrl;if(!e)throw new n.a("internal:geometry-service-url-not-configured");let o;o="portal"in e?e.portal||a.a.getDefault():e,await o.load({signal:t});const c=null==(i=o.helperServices)||null==(s=i.geometry)?void 0:s.url;if(!c)throw new n.a("internal:geometry-service-url-not-configured");return c}async function l(e,t,i=null,r){const a=await c(i,r),l=new o.a;l.geometries=[e],l.outSpatialReference=t;const d=await Object(s.a)(a,l,{signal:r});if(d&&Array.isArray(d)&&1===d.length)return d[0];throw new n.a("internal:geometry-service-projection-failed")}},1366:function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return el}));var r=i(79),n=i(85),a=i(112),s=i(81),o=i(84),c=i(82),l=(i(83),i(80)),d=i(1083);const h=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(e){super.postscript(e),Object(d.b)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=Object(a.l)(this.view.defaultsFromMap,"heightModelInfoReady");this.handles.add(e),await e;const t=Object(d.c)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(t)throw t}};return Object(r.a)([Object(s.b)()],t.prototype,"view",void 0),Object(r.a)([Object(s.b)()],t.prototype,"slicePlaneEnabled",void 0),t=Object(r.a)([Object(l.a)("esri.views.3d.layers.LayerView3D")],t),t};var u=i(99),p=i(121),f=i(197),b=i(211),m=i(113),g=i(149),v=i(199),y=i(116),O=i(106),x=i(207),j=i(223),_=i(118),S=i(456),w=i(362),C=i(332),P=i(224);function T(e,t,i,r){return D(e,t,i,A(r,t,i,!0))}const E={dir:Object(O.f)(),len:0,clip:Object(P.a)()};function A(e,t,i,r){const n=E;return e?(i&&r&&(n.len=Object(y.m)(t,i)),Object(y.k)(n.dir,e)):r?(n.len=Object(y.m)(t,i),Object(y.j)(n.dir,i,t),Object(y.e)(n.dir,n.dir,1/n.len)):(Object(y.j)(n.dir,i,t),Object(y.r)(n.dir,n.dir)),n}function R(e,t,i){const r=Object(y.h)(Object(w.q)(e),i.dir),n=-Object(w.t)(e,t);if(n<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return n>0;if((n<0||r<0)&&!(n<0&&r<0))return!0;const a=n/r;return r>0?a<i.clip[1]&&(i.clip[1]=a):a>i.clip[0]&&(i.clip[0]=a),i.clip[0]<=i.clip[1]}function D(e,t,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let n=0;n<e.length;n++)if(!R(e[n],t,r))return!1;return!0}const M=.5*Math.PI,I=M/Math.PI*180;class z{constructor(e){this.renderCoordsHelper=e.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:Object(O.f)(),direction:Object(O.f)()};for(let t=0;t<4;t++)this.extent[t]={origin:Object(O.f)(),direction:Object(O.f)(),cap:{next:null,direction:Object(O.f)()}},this.planes[t]=Object(w.d)();this.planes[4]=Object(w.d)(),this.planes[5]=Object(w.d)(),this.planesWithoutFar=this.planes.slice(0,5)}update(e,t,i,r=!0){const n=this.extent;this.toRenderBoundingExtent(e,t,i),Object(y.f)(this.center.origin,n[0].origin,n[2].origin),Object(y.e)(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),r||Object(y.e)(this.center.direction,this.center.direction,-1);for(let a=0;a<4;a++){const e=n[a];this.renderCoordsHelper.worldUpAtPosition(e.origin,e.direction);const t=n[3===a?0:a+1];e.cap.next=t.origin,Object(y.v)(e.cap.direction,e.origin,t.origin),Object(w.i)(e.direction,e.cap.direction,e.origin,this.planes[a]),r||Object(y.e)(e.direction,e.direction,-1)}Object(w.i)(n[0].cap.direction,n[1].cap.direction,n[0].origin,this.planes[4]),r?Object(w.p)(this.planes[4],this.planes[5]):(Object(w.c)(this.planes[4],this.planes[5]),Object(w.p)(this.planes[4],this.planes[4])),this.maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this.maxSpanSpatialReference=t,this.minGlobalAltitude=.9*Object(f.e)(this.maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,i=!1){if(null==e)return!1;if(1===this.renderCoordsHelper.viewingMode){const i=this.maxSpanSpatialReference.isGeographic?I:M*t;if(this.maxSpan>i)return!0;if(e.altitude>=this.minGlobalAltitude)return this.isVisibleInFrustumGlobal(e)}if(0===this.maxSpan){const t=this.extent[0];return!(i||!e.intersectsRay(Object(C.g)(t.origin,t.direction)))}for(let n=0;n<this.extent.length;n++){const t=this.extent[n];if(!i&&e.intersectsRay(Object(C.g)(t.origin,t.direction)))return!0;if(e.intersectsLineSegment(Object(S.f)(t.origin,t.cap.next,N),t.cap.direction))return!0}const r=i?this.planes:this.planesWithoutFar;for(let n=0;n<e.lines.length;n++){const t=e.lines[n];if(T(r,t.origin,t.endpoint,t.direction))return!0}return!1}toRenderBoundingExtentGlobal(e,t,i){Object(_.d)(e,F),F[2]=i,Object(x.d)(t,F,V,this.renderCoordsHelper.spatialReference),Object(g.c)(G,V),Object(j.h)(U);for(const{x0:r,x1:n,y0:a,y1:s}of L)for(let o=0;o<5;o++){const c=o/4;F[0]=Object(m.k)(e[r],e[n],c),F[1]=Object(m.k)(e[a],e[s],c),F[2]=i,Object(x.t)(F,t,F,this.renderCoordsHelper.spatialReference),Object(y.q)(F,F,G),Object(j.n)(U,F)}Object(y.w)(this.extent[0].origin,U[0],U[1],U[2]),Object(y.w)(this.extent[1].origin,U[3],U[1],U[2]),Object(y.w)(this.extent[2].origin,U[3],U[4],U[2]),Object(y.w)(this.extent[3].origin,U[0],U[4],U[2]);for(let r=0;r<4;++r)Object(y.q)(this.extent[r].origin,this.extent[r].origin,V)}toRenderBoundingExtentLocal(e,t,i){Object(x.k)(e,t,B,this.renderCoordsHelper.spatialReference),Object(y.w)(this.extent[0].origin,B[0],B[1],i),Object(y.w)(this.extent[1].origin,B[2],B[1],i),Object(y.w)(this.extent[2].origin,B[2],B[3],i),Object(y.w)(this.extent[3].origin,B[0],B[3],i)}toRenderBoundingExtent(e,t,i){switch(this.renderCoordsHelper.viewingMode){case 1:this.toRenderBoundingExtentGlobal(e,t,i);break;case 2:this.toRenderBoundingExtentLocal(e,t,i);break;default:Object(b.a)(this.renderCoordsHelper.viewingMode)}}isVisibleInFrustumGlobal(e){if(Object(y.h)(this.center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const i=this.extent[t];if(Object(y.h)(i.direction,e.direction)<0)return!0}return!1}}const L=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],F=Object(O.f)(),V=Object(v.d)(),G=Object(v.d)(),U=Object(j.f)(),B=Object(_.l)(),N=Object(S.d)();var k=i(502);let H=class extends u.a{constructor(){super(...arguments),this.suspended=!1,this.extent=null,this.extentIntersectionDirty=!0,this._isVisibleBelowSurface=!1,this.handles=new p.a,this.layerView=null,this.updating=!0}setup(e){this.layerView=e,this.extentIntersection=new z({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,i=t.basemapTerrain,r=t.resourceController.scheduler;this.handles.add([t.on("resize",(()=>this.viewChange())),t.state.watch("camera",(()=>this.viewChange()),!0),r.registerTask(k.b.FRUSTUM_VISIBILITY,this),i.on("elevation-bounds-change",(()=>this.elevationBoundsChange()))]),"local"===t.viewingMode?this.isVisibleBelowSurface=!0:this.handles.add([Object(a.a)(i,["opacity","wireframe"],(()=>this.updateIsVisibleBelowSurface())),Object(a.a)(t,"map.ground.navigationConstraint.type",(()=>this.updateIsVisibleBelowSurface()))])}destroy(){this.layerView=null,this.extent=null,this.extentIntersection=null,this.handles&&(this.handles.destroy(),this.handles=null)}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this.extent=e,this.extentIntersectionDirty=!0,this._setDirty()}viewChange(){this._setDirty()}elevationBoundsChange(){this._setDirty(),this.extentIntersectionDirty=!0}set isVisibleBelowSurface(e){this._isVisibleBelowSurface=e,this._setDirty(),this.extentIntersectionDirty=!0}updateIsVisibleBelowSurface(){const e=this.layerView.view,t=e.basemapTerrain,i="local"===e.viewingMode,r=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this.isVisibleBelowSurface=i||!t.opaque||r}updateExtentIntersection(){if(!this.extentIntersectionDirty)return;this.extentIntersectionDirty=!1;const e=this.layerView.view;let t;if(this._isVisibleBelowSurface)t=-.3*Object(f.e)(e.spatialReference).radius;else{const{min:i,max:r}=e.basemapTerrain.elevationBounds;t=i-Math.max(1,(r-i)*(1.2-1))}this.extentIntersection.update(this.extent,e.spatialReference,t)}get running(){return this.updating}runTask(){if(this._set("updating",!1),!this.extent)return void this._set("suspended",!1);this.updateExtentIntersection();const e=this.layerView.view.frustum,t=Object(f.e)(this.layerView.view.spatialReference).radius;this._set("suspended",!this.extentIntersection.isVisibleInFrustum(e,t))}};Object(r.a)([Object(s.b)({readOnly:!0})],H.prototype,"suspended",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],H.prototype,"updating",void 0),H=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],H);const q=H;var W=i(122),$=i(107),Y=i(91),Z=i(252),X=i(191),Q=i(590),J=i(135),K=i(959),ee=(i(97),i(192),i(208),i(219),i(218),i(117),i(214),i(195)),te=(i(273),i(111),i(88)),ie=i(87),re=i(408),ne=i(215),ae=i(236),se=i(416),oe=i(942),ce=i(126),le=i(921),de=i(410),he=i(1022),ue=i(405),pe=i(285),fe=i(1153),be=i(297),me=i(274);const ge=ue.a.fromSimpleMarkerSymbol(be.a),ve=de.a.fromSimpleLineSymbol(be.c),ye=pe.a.fromSimpleFillSymbol(be.b),Oe=new he.a({symbolLayers:[new le.a({material:{color:me.a},edges:new fe.a({size:"1px",color:me.b})})]});function xe(e){if(Object(n.k)(e))return null;switch(e.type){case"mesh":return Oe;case"point":case"multipoint":return ge;case"polyline":return ve;case"polygon":case"extent":return ye}return null}var je=i(286);i(189);class _e{constructor(e,t){this.spatialReference=e,this.view=t}getElevation(e,t,i){return this.view.elevationProvider.getElevation(e,t,0,this.spatialReference,i)}async queryElevation(e,t,i,r,n){return this.view.elevationProvider.queryElevation(e,t,0,this.spatialReference,n,i,r)}}var Se=i(813),we=i(129),Ce=i(261),Pe=i(188),Te=i(769);let Ee=class extends u.a{constructor(e){super(e),this.events=new we.a,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.spatialReference=null,this.featureAdapter={getAttribute:(e,t)=>"graphic"in e?e.graphic.attributes[t]:Te.a.getAttribute(e,t),getAttributes:e=>"graphic"in e?e.graphic.attributes:Te.a.getAttributes(e),getObjectId:e=>"graphic"in e?Object(se.e)(e.graphic,this.objectIdField):Te.a.getObjectId(e),getGeometry:e=>"graphic"in e?e.getAsOptimizedGeometry(this.hasZ,this.hasM):Te.a.getGeometry(e),getCentroid:(e,t)=>{if("graphic"in e){let i=null;Object(n.l)(e.centroid)?i=e.centroid:"point"===e.graphic.geometry.type&&Object(x.n)(e.graphic.geometry,Ae,this.spatialReference)&&(i=Ae);const r=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return Object(n.k)(i)?(r[0]=0,r[1]=0,r[2]=0,r[3]=0):(r[0]=i.x,r[1]=i.y,t.hasZ&&(r[2]=i.hasZ?i.z:0),t.hasM&&(r[t.hasZ?3:2]=i.hasM?i.m:0)),new Pe.a([],r)}return Te.a.getCentroid(e,t)},cloneWithGeometry:(e,t)=>"graphic"in e?new Ce.b(t,this.featureAdapter.getAttributes(e),null,this.featureAdapter.getObjectId(e)):Te.a.cloneWithGeometry(e,t)}}forEach(e){this.forAllGraphics((t=>{e(t)}))}forEachInBounds(e,t){this.getSpatialIndex().forEachInBounds(e,t)}forEachBounds(e,t,i){const r=this.getSpatialIndex();for(const a of e){const e=this.featureAdapter.getObjectId(a);Object(n.l)(r.getBounds(e,i))&&t(i)}}};Object(r.a)([Object(s.b)({constructOnly:!0})],Ee.prototype,"getSpatialIndex",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Ee.prototype,"forAllGraphics",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Ee.prototype,"hasZ",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Ee.prototype,"hasM",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Ee.prototype,"objectIdField",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Ee.prototype,"spatialReference",void 0),Ee=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],Ee);const Ae={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null},Re=Ee;class De{constructor(e,t,i){this.graphic=e,this.renderingInfo=t,this.layer=i}}class Me{constructor(e){this.schedule=e,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.layerView=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.isAsync=!1}}var Ie=i(287),ze=i(1019),Le=i(103),Fe=i(101),Ve=i(565),Ge=i(515),Ue=i(816),Be=i(684);function Ne(e,t,i,r){const n=e.stageObject,a=i.spatialReference,s=n.geometryRecords,o="absolute-height"!==t.mode;let c=0;for(const l of s){const e=l.geometry,s=l.getShaderTransformation();Ye[0]=s[12],Ye[1]=s[13],Ye[2]=s[14],e.invalidateBoundingInfo();const d=e.getMutableAttribute("position"),h=d.data,u=e.vertexAttributes.get("mapPos").data,p=d.size,f=h.length/p,b=new Be.a(u,a);let m=0,g=!1,v=0;for(let n=0;n<f;n++){if(Ze[0]=h[m],Ze[1]=h[m+1],Ze[2]=h[m+2],Object(Ve.g)(b,i,t,r,Je),o&&(v+=Je.sampledElevation),Ue.a.TESTS_DISABLE_OPTIMIZATIONS)h[m]=b.array[b.offset],h[m+1]=b.array[b.offset+1],h[m+2]=Je.z,Object(x.l)(h,a,m,h,r.spatialReference,m,1),h[m]-=Ye[0],h[m+1]-=Ye[1],h[m+2]-=Ye[2],g=!0;else{$e[0]=h[m]+Ye[0],$e[1]=h[m+1]+Ye[1],$e[2]=h[m+2]+Ye[2],r.setAltitude($e,Je.z),h[m]=$e[0]-Ye[0],h[m+1]=$e[1]-Ye[1],h[m+2]=$e[2]-Ye[2];const e=We/r.unitInMeters;(Math.abs(Ze[0]-h[m])>=e||Math.abs(Ze[1]-h[m+1])>=e||Math.abs(Ze[2]-h[m+2])>=e)&&(g=!0)}m+=p,b.offset+=3}c+=v/f,g&&n.geometryVertexAttrsUpdated(l)}return c/s.length}function ke(e,t,i,r){const n=e.stageObject,a=t.centerPointInElevationSR;let s=0;n.metadata.usesVerticalDistanceToGround?(Object(Ve.g)(a,i,t,r,Je),Object(Ge.i)(n,Je.verticalDistanceToGround),s=Je.sampledElevation):(Object(Ve.g)(a,i,t,r,Je),"absolute-height"!==t.mode&&(s=Je.sampledElevation));const o=Object(g.d)(He,n.transformation),c=Object(y.w)(Qe,o[12],o[13],o[14]);Ue.a.TESTS_DISABLE_OPTIMIZATIONS?($e[0]=a.x,$e[1]=a.y,$e[2]=Je.z,Object(x.d)(a.spatialReference,$e,o,r.spatialReference)&&(n.transformation=o)):r.setAltitudeOfTransformation(Je.z,o);const l=We/r.unitInMeters;return(Math.abs(o[12]-c[0])>=l||Math.abs(o[13]-c[1])>=l||Math.abs(o[14]-c[2])>=l)&&(n.transformation=o),s}const He=Object(v.d)();function qe(e,t,i,r){const a=e.graphics3DSymbolLayer.lodRenderer;if(Object(n.k)(a))return 0;const s=t.centerPointInElevationSR;Object(Ve.g)(s,i,t,r,Je);const o="absolute-height"!==t.mode?Je.sampledElevation:0,c=a.instanceData,l=e.instanceIndex,d=Xe;c.getGlobalTransform(l,d);const h=Object(y.w)(Qe,d[12],d[13],d[14]);Ue.a.TESTS_DISABLE_OPTIMIZATIONS?($e[0]=s.x,$e[1]=s.y,$e[2]=Je.z,Object(x.d)(s.spatialReference,$e,d,r.spatialReference)&&c.setGlobalTransform(l,d)):r.setAltitudeOfTransformation(Je.z,d);const u=We/r.unitInMeters;return(Ue.a.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(d[12]-h[0])>=u||Math.abs(d[13]-h[1])>=u||Math.abs(d[14]-h[2])>=u)&&c.setGlobalTransform(l,d),o}const We=.01,$e=Object(O.f)(),Ye=Object(O.f)(),Ze=Object(O.f)(),Xe=Object(v.d)(),Qe=Object(O.f)(),Je=new Ve.a;var Ke=i(624),et=i(440);class tt{constructor(e,t,i,r,n,a,s,o=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=i,this._uniqueMaterials=r,this._uniqueTextures=n,this.elevationAligner=a,this.elevationContext=s,this._edgeState=o,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1,this.graphics3DSymbolLayer=e,this.stageObject=t}get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}initialize(e,t){this._stageLayer=t,this._stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.addMany(this._uniqueTextures),e.load(this._uniqueTextures),e.add(this.stageObject)}destroy(){const e=this._stage;this._stageLayer&&(e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries),e.removeMany(this._uniqueTextures)),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const t=this._stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),this._visible=!1,this._stageLayer=null,this._stage=null}layerOpacityChanged(e,t){if(Object(n.k)(this._edgeState))return;const i=it(this._edgeState.baseMaterial);let r=!1;for(const n of this._edgeState.edgeMaterials)n.objectTransparency!==i&&(n.objectTransparency=i,r=!0);r&&this.resetEdgeObject(t),this._stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,t){Object(n.k)(this._edgeState)||(this._stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:e},!t),this._edgeState.properties.slicePlaneEnabled=e)}setVisibility(e){if(null!=this._stage&&this._visible!==e&&(this._visible=e,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this._stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),Object(n.l)(this._edgeState))){const t=this._stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this.addOrUpdateEdgeObject(t,!1)}}get visible(){return this._visible}alignWithElevation(e,t,i,r){null!=this.elevationAligner&&(Object(n.l)(i)&&Object(Se.f)(this.elevationContext.featureExpressionInfoContext,i),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e,t),this.resetEdgeObject(r))}getCenterObjectSpace(e=Object(O.f)()){return Object(y.k)(e,Object(et.e)(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=Object(j.f)()){const t=this.stageObject.boundingVolumeObjectSpace;return Object(j.y)(e,t.min),Object(j.x)(e,t.max),e}computeAttachmentOrigin(e){if(this.useObjectOriginAsAttachmentOrigin){const t=this.stageObject.transformation;e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++}else for(const t of this.stageObject.geometryRecords)t.computeAttachmentOrigin(at)&&(Object(y.q)(at,at,this.stageObject.transformation),Object(y.f)(e.render.origin,e.render.origin,at),e.render.num++)}async getProjectedBoundingBox(e,t,i,r,a){const s=this.getBoundingBoxObjectSpace(a),o=st,c=Object(j.s)(s)?1:o.length;for(let n=0;n<c;n++){const e=o[n];nt[0]=s[e[0]],nt[1]=s[e[1]],nt[2]=s[e[2]],Object(y.q)(nt,nt,this.stageObject.transformation),rt[3*n+0]=nt[0],rt[3*n+1]=nt[1],rt[3*n+2]=nt[2]}if(!e(rt,0,c))return null;Object(j.h)(s);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let n=0;n<3*c;n+=3){for(let e=0;e<3;e++)s[e]=Math.min(s[e],rt[n+e]),s[e+3]=Math.max(s[e+3],rt[n+e]);l&&i.push({location:rt.slice(n,n+3),screenSpaceBoundingRect:l})}if(t&&t.service&&"absolute-height"!==this.elevationContext.mode){Object(j.d)(s,at);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i=0;if(t.useViewElevation)i=Object(n.u)(t.service.getElevation(at[0],at[1],e),0);else try{const a=Object(Ge.d)(s,t);i=Object(n.u)(await t.service.queryElevation(at[0],at[1],r,a,e),0)}catch(d){}Object(j.u)(s,0,0,-this.alignedSampledElevation+i)}return s}addObjectState(e,t){0===e&&t.addObject(this.stageObject,this.stageObject.highlight()),1===e&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}resetEdgeObject(e){if(Object(n.k)(this._edgeState))return;const t=this._stage.renderView.ensureEdgeView();this._visible?this.addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)}addOrUpdateEdgeObject(e,t){const i=this._edgeState;if(Object(n.k)(i))return;const r=it(i.baseMaterial);for(const n of i.edgeMaterials)n.objectTransparency=r;e.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!t).then((()=>{var e;return null==(e=this._stageLayer)?void 0:e.sync()}))}}function it(e){return e.isVisible?e.parameters.transparent?1:2:0}const rt=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],nt=Object(O.f)(),at=Object(O.f)(),st=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];var ot=i(245);class ct{constructor(e){this.schedule=e,this._loadStatus=0,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){return 1===this._loadStatus?(e&&e(),Object(n.t)(this._loader)):2===this._loadStatus?(t&&t(this._loadError),Object(n.t)(this._loader)):(Object(n.k)(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=1}),(e=>{throw this._loadError=e,this._abortController=null,this._loadStatus=2,!Object(Y.l)(e)&&this.logger&&e.message&&this.logger.warn(e.message),e}))),this._loader.then(e,t).catch((()=>{})),this._loader)}abortLoad(){Object(n.l)(this._abortController)?this._abortController=Object(n.a)(this._abortController):0===this._loadStatus&&(this._loadStatus=2),this._loader=null}}var lt=i(880),dt=i(553);function ht(e,t){const i=(e,i,r=!1)=>({levels:e.map((e=>{const n=i(e.tesselation);return r&&dt.a.cgToGIS(n),{components:[{geometry:n,material:t}],faceCount:n.indexCount/3,minScreenSpaceRadius:e.minScreenSpaceRadius}}))});switch(e){case"sphere":return i([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(e=>dt.a.createPolySphereGeometry(.5,e,!0)));case"cube":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>dt.a.createBoxGeometry(1)));case"cone":return i(ut,(e=>dt.a.createConeGeometry(1,.5,e,!1)),!0);case"inverted-cone":return i(ut,(e=>dt.a.createConeGeometry(1,.5,e,!0)),!0);case"cylinder":return i(ut,(e=>dt.a.createCylinderGeometry(1,.5,e,[0,0,1],[0,0,.5])));case"tetrahedron":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>dt.a.createTetrahedronGeometry(1)),!0);case"diamond":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>dt.a.createDiamondGeometry(1)),!0);default:return}}const ut=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];function pt(e,t){return function(e,t){if(Object(n.k)(e))return null;const i=Object(n.l)(e.color)?Object(ot.f)(Le.a.toUnitRGBA(e.color)):Object(ot.g)(0,0,0,0),r=Object(Fe.g)(e.size),a=Object(Fe.g)(e.extensionLength);switch(e.type){case"solid":return function(e){return{...ft,...e,type:"solid"}}({color:i,size:r,extensionLength:a,...t});case"sketch":return function(e){return{...bt,...e,type:"sketch"}}({color:i,size:r,extensionLength:a,...t});default:return}}(function(e){return e&&e.enabled&&e.edges||null}(e),t)}const ft={color:Object(ot.g)(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2},bt={color:Object(ot.g)(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:2};function mt(e){const t=[];return e.levels.forEach((e=>{e.components.forEach((e=>{t.push(e.material)}))})),Object(o.k)(t)}function gt(e){const t=[];return e.components.forEach((e=>{t.push(e.geometry)})),Object(o.k)(t)}const vt={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function yt(e){let t=0,i=0,r=0,a=!1,s=0;const o={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const c of e)Object(n.k)(c)||(t+=c.primitivesPerFeature,i+=c.primitivesPerCoordinate,r+=c.drawCallsPerFeature,o.bytesPerFeature+=c.memory.bytesPerFeature,o.bytesPerFeatureLabel+=c.memory.bytesPerFeatureLabel,o.bytesPerCoordinate+=c.memory.bytesPerCoordinate,o.draped.bytesPerFeature+=c.memory.bytesPerFeature,o.draped.bytesPerFeatureLabel+=c.memory.bytesPerFeatureLabel,o.draped.bytesPerCoordinate+=c.memory.bytesPerCoordinate,a=a||c.estimated,++s);return{primitivesPerFeature:t,primitivesPerCoordinate:i,drawCallsPerFeature:r,estimated:a,memory:o,numComplexities:s}}const Ot={};function xt(e,t){const i=jt(e,t),r=function(e){return e&&e.enabled&&("extrude"===e.type||(t=e,"fill"===t.type))&&Object(n.l)(e.edges);var t}(t)?2:0;switch(t.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:r,estimated:!1,memory:i};case"fill":return"mesh-3d"===e.type?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:r,estimated:!1,memory:i}:Object(n.l)(t.outline)&&t.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:i}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:i};case"object":return t.resource&&t.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:i}:{..._t(t.resource&&t.resource.primitive||lt.b),memory:i};case"path":{const e=3,r=3,n=10;let a=0,s=0;switch(t.profile){case"circle":a=n;break;case"quad":a=4;break;default:return void Object(b.a)(t.profile)}switch(t.join){case"round":s=e;break;case"miter":case"bevel":s=1;break;default:return void Object(b.a)(t.join)}const o=2*a,c=a*s*2;let l=-2*c-o;switch(t.cap){case"none":break;case"butt":case"square":l+=2*(a-1);break;case"round":l+=2*(a*(r-1)*2+a);break;default:return}return{primitivesPerFeature:l,primitivesPerCoordinate:c+o,drawCallsPerFeature:0,estimated:!1,memory:i}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:i};default:return}}function jt(e,t){const i="point-3d"===e.type;switch(t.type){case"extrude":return t.edges&&t.edges.size>0?St.EXTRUDE_EDGES:St.EXTRUDE;case"fill":return Object(n.l)(t.outline)&&t.outline.size>0?St.FILL_OUTLINE:St.FILL;case"water":return St.FILL;case"line":return"round"===t.join?St.LINE_ROUND:St.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return St.PATH_ROUND_CIRCLE;case"quad":return St.PATH_ROUND_QUAD;default:return void Object(b.a)(t.profile)}case"miter":case"bevel":switch(t.profile){case"circle":return St.PATH_MITER_CIRCLE;case"quad":return St.PATH_MITER_QUAD;default:return void Object(b.a)(t.profile)}default:return void Object(b.a)(t.join)}case"object":return i?St.OBJECT_POINT:St.OBJECT_POLYGON;case"icon":case"text":return i?St.ICON_POINT:St.ICON_POLYGON;default:return}}function _t(e){let t=Ot[e];if(t)return t;return t={primitivesPerFeature:gt(ht(e,null).levels[0]).reduce(((e,t)=>e+t.indices.get("position").length/3),0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},Ot[e]=t,t}const St={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}},wt=ie.a.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class Ct extends ct{constructor(e,t,i,r){super(i.schedule),this._context=i,this._elevationInfoOverride=null,this.complexity=null,this.logger=wt,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=e,this.symbolLayer=t,this._renderPriority=r.renderPriority,this._renderPriorityStep=r.renderPriorityStep,this._elevationContext=new Ke.a,this.complexity=this.computeComplexity(),this._updateDrivenProperties(r.ignoreDrivers),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,i,r){const n=e.projectionSuccess,a="polygons"in e?e.polygons:null,s=`${r} geometry failed to be created`;let o=null;n?!t.length||1===t.length&&!t[0].length?o=`${s} (no ${i} were defined)`:Array.isArray(t)&&Array.isArray(t[0])?a&&0===a.length&&"rings"===i&&t.length>0&&t[0].length>2&&(o=`${s} (filled rings should use clockwise winding - try reversing the order of vertices)`):o=`${s} (${i} should be defined as a 2D array)`:o=`${s} (failed to project geometry to view spatial reference)`,o&&wt.warnOncePerTick(o)}_validateGeometry(e,t=null,i=null){if(Object(n.l)(t)&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+` symbol: ${e.type}`),!1;if("point"===e.type){const t=e;if(!isFinite(t.x)||!isFinite(t.y))return wt.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return Tt}_defaultElevationInfoZ(){return Et}_updateElevationContext(){Object(n.l)(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t){const i=Object(n.t)(e.geometry),r=this.getDefaultElevationInfo(i);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:r.unit,t.mode=this.getGeometryElevationMode(i,r),t.offsetMeters=Object(n.u)(this._elevationContext.meterUnitOffset,Object(n.u)(r.offset,0));const a=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;a&&(t.mode="relative-to-ground",t.offsetMeters=0);const s=a?Se.g:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(s,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}onRemoveGraphic(e){}_updateDrivenProperties(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};if(e)return void(this._drivenProperties=t);const i=this._context.renderer;i&&"visualVariables"in i&&i.visualVariables&&i.visualVariables.forEach((e=>{switch(e.type){case"color":if(t.color=!0,e.stops)for(let i=0;i<e.stops.length;i++){const r=e.stops[i].color;r&&(t.opacity=!0,r.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}})),this._drivenProperties=t}_getLayerOpacity(){if(this._context.layerView&&"fullOpacity"in this._context.layerView)return this._context.layerView.fullOpacity;const e=this._context.layer.opacity;return null==e?1:e}_getCombinedOpacity(e,t=At){let i=1;return this.draped||(i*=this._getLayerOpacity()),this._drivenProperties.opacity||(Object(n.l)(e)?i*=e.a:t.hasIntrinsicColor||(i=0)),i}_getCombinedOpacityAndColor(e,t=At){const i=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return Object(Ge.g)(null,i);const r=Object(n.l)(e)?Le.a.toUnitRGB(e):O.a;return Object(Ge.g)(r,i)}_getVertexOpacityAndColor(e,t=null){const i=this._drivenProperties.color?e.color:null,r=this._drivenProperties.opacity?e.opacity:null,a=Object(Ge.g)(i,r);return Object(n.l)(t)&&(a[0]*=t,a[1]*=t,a[2]*=t,a[3]*=t),a}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return xt(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,i){switch(e){case"opacity":return this.layerOpacityChanged(t,i);case"elevationInfo":{const e=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,i,e)!==Ve.b.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(e,t,i){let r=Ve.b.UPDATE;return e.forEach((e=>{const a=t(e);if(Object(n.l)(a)){const t=e.graphic;this.setGraphicElevationContext(t,a.elevationContext),a.needsElevationUpdates=i(a.elevationContext.mode)}else r=Ve.b.RECREATE})),r}applyRendererDiff(e,t){return 0}getFastUpdateAttrValues(e){if(!this._fastUpdates.enabled)return null;const t=this._fastUpdates.visualVariables,i=t.size?Pt(t.size.field,e):0,r=t.color?Pt(t.color.field,e):0,n=t.opacity?Pt(t.opacity.field,e):0;return Object(ot.g)(i,r,n,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&wt.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}}function Pt(e,t){const i=null!=e?t.attributes[e]:0;return null!=i&&isFinite(i)?i:0}const Tt={mode:"on-the-ground",offset:0,unit:"meters"},Et={mode:"absolute-height",offset:0,unit:"meters"},At={hasIntrinsicColor:!1};var Rt=i(910),Dt=i(566),Mt=i(481),It=i(235),zt=i(514),Lt=i(577),Ft=i(602),Vt=i(306),Gt=i(709),Ut=i(779),Bt=i(815),Nt=i(530),kt=i(419),Ht=i(432),qt=i(433),Wt=i(434),$t=i(420),Yt=i(425),Zt=i(1041),Xt=i(393);class Qt extends Ht.a{initializeProgram(e){const t=Qt.shader.get(),i=this.configuration,r=t.build({occlusionTestEnabled:i.occlusionTestEnabled,verticalOffsetEnabled:i.verticalOffset,screenSizePerspectiveEnabled:i.screenSizePerspective,depthHudEnabled:i.depthHudEnabled,depthHudAlignStartEnabled:i.depthHudAlignStartEnabled,screenCenterOffsetUnitsEnabled:i.screenCenterOffsetUnitsEnabled,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,viewingMode:e.viewingMode,isDraped:!1,multipassGeometryEnabled:i.multipassGeometryEnabled});return new $t.a(e.rctx,r,Wt.a)}bindPass(e,t){Object(Nt.c)(this.program,t.camera.projectionMatrix),Zt.a.bindUniforms(this.program,e,t.camera.pixelRatio||1),Object(Gt.b)(this.program,e,t),Object(Ut.b)(this.program,t),this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(Bt.a)(this.program,t),this.program.bindTexture(t.hudVisibilityTexture,"hudVisibilityTexture"),this.program.setUniform1f("cameraGroundRelative",t.camera.aboveGround?1:-1),this.program.setUniform1f("polygonOffset",e.shaderPolygonOffset),Object(Nt.f)(this.program,t),this.program.setUniform1f("perDistancePixelRatio",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix),this.program.setUniform2f("pixelToNDC",2/t.camera.fullViewport[2],2/t.camera.fullViewport[3]);const i=t.camera.pixelRatio||1;this.program.setUniform1f("lineSize",Math.ceil(e.size)*i),Object(Yt.a)(e.screenSizePerspective,this.program,"screenSizePerspectiveAlignment")}bindDraw(e){Object(Nt.d)(this.program,e),Object(Nt.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),Object(Vt.c)(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e){const t=e?519:513;return this.configuration.depthHudEnabled?Object(Xt.f)({depthTest:{func:t},depthWrite:Xt.d}):Object(Xt.f)({blending:Object(Xt.g)(1,770,771,771),depthTest:{func:t},colorWrite:Xt.c})}initializePipeline(){return this.setPipelineState(this.configuration.multipassGeometryEnabled)}}Qt.shader=new kt.a(Zt.b,(()=>i.e(328).then(i.bind(null,1360))));class Jt extends qt.a{constructor(){super(...arguments),this.occlusionTestEnabled=!0,this.verticalOffset=!1,this.screenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.screenCenterOffsetUnitsEnabled=0,this.slicePlaneEnabled=!1,this.multipassGeometryEnabled=!1}}Object(r.a)([Object(qt.b)()],Jt.prototype,"occlusionTestEnabled",void 0),Object(r.a)([Object(qt.b)()],Jt.prototype,"verticalOffset",void 0),Object(r.a)([Object(qt.b)()],Jt.prototype,"screenSizePerspective",void 0),Object(r.a)([Object(qt.b)()],Jt.prototype,"depthHudEnabled",void 0),Object(r.a)([Object(qt.b)()],Jt.prototype,"depthHudAlignStartEnabled",void 0),Object(r.a)([Object(qt.b)({count:2})],Jt.prototype,"screenCenterOffsetUnitsEnabled",void 0),Object(r.a)([Object(qt.b)()],Jt.prototype,"slicePlaneEnabled",void 0),Object(r.a)([Object(qt.b)()],Jt.prototype,"multipassGeometryEnabled",void 0);class Kt extends Mt.a{constructor(e){super(e,ti),this.techniqueConfig=new Jt,this._uniqueMaterialIdentifier=Kt.uniqueMaterialIdentifier(this.parameters)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}getPassParameters(){return this.parameters}getTechniqueConfig(e,t){const i=18!==(null==t?void 0:t.slot);return this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.verticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.depthHudEnabled=i,this.techniqueConfig.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits?1:0,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.multipassGeometryEnabled=!!t&&t.multipassGeometryEnabled,this.techniqueConfig}intersect(){}requiresSlot(e){switch(e){case 18:case 19:return!0}return!1}createGLMaterial(e){return 0===e.output?new ei(e):null}createBufferWriter(){return new ni}validateParameters(e){const t=Kt.uniqueMaterialIdentifier(e);t!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=t)}static uniqueMaterialIdentifier(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}}class ei extends Lt.a{updateParameters(e){return this.ensureTechnique(Qt,e)}beginSlot(e){return this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}const ti={verticalOffset:null,screenSizePerspective:null,screenOffset:[0,0],color:[0,0,0,1],size:1,borderColor:null,occlusionTest:!1,shaderPolygonOffset:1e-5,depthHUDAlignStart:!1,centerOffsetUnits:"world",slicePlaneEnabled:!1,...Mt.b},ii=Object(zt.a)().vec3f("position").vec3f("normal").vec2f("uv0").vec4f("auxpos1"),ri=[Object(It.b)(0,0),Object(It.b)(1,0),Object(It.b)(0,1),Object(It.b)(1,0),Object(It.b)(1,1),Object(It.b)(0,1)];class ni{constructor(){this.vertexBufferLayout=ii}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get("position").length}write(e,t,i,r){Object(Ft.e)(t.indices.get("position"),t.vertexAttributes.get("position").data,e.transformation,i.position,r,6),Object(Ft.d)(t.indices.get("normal"),t.vertexAttributes.get("normal").data,e.invTranspTransformation,i.normal,r,6),Object(Ft.a)(t.indices.get("auxpos1"),t.vertexAttributes.get("auxpos1").data,i.auxpos1,r,6);for(let n=0;n<ri.length;++n)i.uv0.setVec(r+n,ri[n])}}class ai extends Ct{constructor(e,t){super(e,null,t,li),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new Kt(this.materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}perInstanceMaterialParameters(e){const t=this.materialParameters;return t.screenOffset=e.screenOffset||[0,0],t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get materialParameters(){const e=this.symbol,t=e.callout,i=Object(n.l)(t.color)?Le.a.toUnitRGBA(t.color):[0,0,0,0];i[3]*=this._getLayerOpacity();const r=Object(Fe.g)(t.size||0);let a=null;if(e.verticalOffset){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e.verticalOffset;a={screenLength:Object(Fe.g)(t),minWorldLength:i||0,maxWorldLength:null!=r?r:1/0}}const s=Object(n.l)(t.border)&&Object(n.l)(t.border.color)?Le.a.toUnitRGBA(t.border.color):null,o="object"===e.symbolLayers.getItemAt(0).type,c=!o,l=o?0:void 0,d="label-3d"===e.type;return{color:i,size:r,verticalOffset:a,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:s,occlusionTest:c,shaderPolygonOffset:l,depthHUDAlignStart:d,slicePlaneEnabled:this._context.slicePlaneEnabled,renderOccluded:Mt.b.renderOccluded}}_defaultElevationInfoNoZ(){return ci}createGraphics3DGraphic(e){const t=e.renderingInfo,i=e.graphic,r=this.setGraphicElevationContext(i,new Ke.a,t.elevationOffset||0),a=t.symbol,s="on-the-ground"===this._elevationContext.mode&&("cim"===a.type||!a.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==a.type&&s)return null;const o=Object(Ge.a)(i.geometry);return Object(n.k)(o)?null:this._createAs3DShape(o,r,t,i.uid)}layerOpacityChanged(){return Object(n.k)(this._material)||this._material.setParameters(this.materialParameters),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=Object(Ve.e)(ai.elevationModeChangeTypes,i,r);return a!==Ve.b.UPDATE||e.forEach((e=>{const i=t(e);Object(n.l)(i)&&this.updateGraphicElevationContext(e.graphic,i)})),a}slicePlaneEnabledChanged(){return Object(n.k)(this._material)||this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}setGraphicElevationContext(e,t,i=0){const r=super.setGraphicElevationContext(e,t);return r.addOffsetRenderUnits(i),r}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=Object(Ve.h)(t.elevationContext.mode)}updateGeometry(e,t){return!1}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:vt.memory}}createVertexData(e){const{translation:t,centerOffset:i}=e;return[["position",t?{size:3,data:[t[0],t[1],t[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0}],["normal",{size:3,data:[0,0,1],exclusive:!0}],["auxpos1",i?{size:4,data:[i[0],i[1],i[2],i[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0}]]}_getOrCreateMaterial(e){const t=this.perInstanceMaterialParameters(e),i=Kt.uniqueMaterialIdentifier(t);if(Object(n.l)(this._material)&&i===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(e.materialCollection){let r=e.materialCollection.get(i);return Object(n.k)(r)&&(r=new Kt(t),e.materialCollection.add(i,r)),{material:r,isUnique:!1}}return{material:new Kt(t),isUnique:!0}}_createAs3DShape(e,t,i,r){const n=[new Dt.a(this.createVertexData(i),oi,1)],a=this._getOrCreateMaterial(i),s=Object(Rt.a)(this._context,e,n,[a.material],t,this._context.layer.uid,r);if(null===s)return null;const o=new tt(this,s.object,n,a.isUnique?[a.material]:null,null,ke,t);return o.metadata={elevationOffset:i.elevationOffset||0},o.alignedSampledElevation=s.sampledElevation,o.needsElevationUpdates=Object(Ve.h)(t.mode),Object(Rt.b)(o,e,this._context.elevationProvider),o}}ai.elevationModeChangeTypes={definedChanged:Ve.b.UPDATE,staysOnTheGround:Ve.b.UPDATE,onTheGroundChanged:Ve.b.RECREATE};const si=new Uint16Array([0]),oi=[["position",si],["normal",si],["auxpos1",si]],ci={mode:"relative-to-ground",offset:0},li={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},di=ie.a.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");const hi={line:ai};var ui=i(598),pi=i(222),fi=i(145),bi=i(125),mi=i(180);const gi=new pi.a(Array,(e=>Object(j.w)(e,j.b)),null,10,5),vi=Object(_.l)();class yi{constructor(e,t,i,r,a){this.graphic=e,this.graphics3DSymbol=t,this.graphics=i,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=function(e,t){const i=new Array(e);for(let r=0;r<i.length;r++)i[r]=new Array(t);return i}(2,4),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++t.referenced,this._featureExpressionFeature=a?Object(Se.c)(a,e,r):null;for(const s of i)Object(n.l)(s)&&(this.isElevationSource=this.isElevationSource||s.isElevationSource)}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(e,t,i){this._layer=t,this._stage=e,this.forEachSymbolLayerGraphic((r=>{r.initialize(e,t,i),r.setVisibility(this.isVisible())}))}destroy(){this.forEachSymbolLayerGraphic((e=>e.destroy())),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.graphics}clearLabelGraphics(){this.forEachLabelGraphic((e=>e.destroy())),this._labelGraphics.length=0}addLabelGraphic(e,t,i){this._labelGraphics.push(e),e.initialize(t,i),e.setVisibility(this.isVisible(1))}addAuxiliaryGraphic(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))}get isDraped(){let e=!1;return this.forEachSymbolLayerGraphic((t=>{"draped"===t.type&&(e=!0)})),e}isVisible(e=0,t){for(let i=0;i<=e;i++){const e=this._visibilityFlags[i];for(let i=0;i<e.length;++i)if(!1===e[i]&&i!==t)return!1}return!0}hasVisibilityFlag(e,t){return null!=this._visibilityFlags[t][e]}setVisibilityFlag(e,t,i){const r=this.isVisible(i);this._visibilityFlags[i][e]=t;const n=this.isVisible(i);if(r===n)return!1;if(1===i)this.forEachLabelGraphic((e=>e.setVisibility(n)));else{this.forEachSymbolLayerGraphic((e=>e.setVisibility(n)));const e=this.isVisible(1);this.forEachLabelGraphic((t=>t.setVisibility(e)))}return!0}clearVisibilityFlag(e,t=0){return this.setVisibilityFlag(e,void 0,t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(Object(n.k)(t))return!1;this._extent=Object(_.l)(),Object(se.d)(t,this._extent);const i=t.spatialReference;if(!i.equals(e)&&!Object(x.k)(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return Object(n.l)(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===t||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=t),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(e,t,i){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=bi.a.fromExtent("mesh"===r.type?r.extent:r)),Object(mi.d)(r,t,i)}get usedMemory(){let e=Object(ui.a)(this.graphic.attributes);return this.forEachSymbolLayerGraphic((t=>{const i=t.graphics3DSymbolLayer.complexity;if(Object(n.k)(i))return;const r="draped"===t.type?i.memory.draped:i.memory;e+=r.bytesPerFeature,r.bytesPerCoordinate&&(e+=Object(se.h)(this.graphic.geometry)*r.bytesPerCoordinate)})),e}computeAttachmentOrigin(){const e={render:{origin:Object(O.f)(),num:0},draped:{origin:Object(P.a)(),num:0}};for(const t of this.graphics)Object(n.k)(t)||t.computeAttachmentOrigin(e);return e.render.num&&Object(y.e)(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&Object(fi.g)(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,i,r,a){return a||(a={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),a.boundingBox?Object(j.h)(a.boundingBox):a.boundingBox=Object(j.h)(),a.requiresDrapedElevation=!1,await Object(Ie.a)(this.graphics,(async s=>{if(Object(n.k)(s))return;const o="draped"===s.type?t:e,c=gi.acquire(),l=await s.getProjectedBoundingBox(o,i,a.screenSpaceObjects,r,c);isFinite(l[2])&&isFinite(l[5])||(a.requiresDrapedElevation=!0),l&&Object(j.j)(a.boundingBox,c),gi.release(c)})),Object(j.c)(a.boundingBox)||Object(_.b)(Object(j.A)(a.boundingBox,vi))?a:null}needsElevationUpdates(){for(const e of this.graphics)if(Object(n.l)(e)&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;for(const e of this._labelGraphics)if(e&&e.needsElevationUpdates)return!0;return!1}alignWithElevation(e,t,i){this.forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,t,this._featureExpressionFeature,i)}))}addObjectStateSet(e,t){this.forEachSymbolLayerGraphic((i=>i.addObjectState(e,t)))}removeObjectState(e){this.forEachSymbolLayerGraphic((t=>t.removeObjectState(e)))}forEachGraphicList(e,t){e.forEach((e=>e&&t(e)))}forEachSymbolLayerGraphic(e){this.forEachGraphicList(this.graphics,e),this.forEachGraphicList(this._auxiliaryGraphics,e)}forEachLabelGraphic(e){this.forEachGraphicList(this._labelGraphics,e)}forEachRenderedGraphic(e){this.forEachSymbolLayerGraphic(e),this.forEachLabelGraphic(e)}}var Oi=i(558),xi=i(271),ji=i(331),_i=i(403),Si=i(682);i(243);var wi=i(901),Ci=i(981),Pi=i(96);function Ti(e){const t=[["position",e.indices]],i=[["position",{size:3,data:e.attributeData.position,exclusive:!0}]];return Object(n.l)(e.attributeData.color)&&(i.push(["color",{size:4,data:e.attributeData.color,exclusive:!0}]),t.push(["color",new Uint32Array(e.indices.length)])),Object(n.l)(e.attributeData.uvMapSpace)&&(i.push(["uvMapSpace",{size:4,data:e.attributeData.uvMapSpace,exclusive:!0}]),t.push(["uvMapSpace",e.indices])),Object(n.l)(e.attributeData.boundingRect)&&(i.push(["boundingRect",{size:9,data:e.attributeData.boundingRect,exclusive:!0}]),t.push(["boundingRect",e.indices])),Object(n.l)(e.attributeData.mapPosition)&&(i.push(["mapPos",{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push(["mapPos",e.indices])),new Dt.a(i,t)}function Ei(e){const t=[["position",e.indices],["uv0",e.indices]],i=[["position",{size:3,data:e.attributeData.position,exclusive:!0}],["uv0",{size:2,data:e.attributeData.uv0,exclusive:!0}]];return Object(n.l)(e.attributeData.mapPosition)&&(i.push(["mapPos",{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push(["mapPos",e.indices])),new Dt.a(i,t)}function Ai(e){switch(e.type){case"extent":if(e instanceof Pi.a)return bi.a.fromExtent(e);break;case"polygon":return e}return null}function Ri(e,t,i,r){const n=Object(wi.a)(e.rings,e.hasZ,1),a=new Float64Array(n.position.length),s=Object(Ve.d)(n.position,e.spatialReference,0,a,0,n.position,0,n.position.length/3,t,i,r),o=null!=s;return{position:n.position,mapPosition:a,polygons:Ii(n.polygons,n.position,a),outlines:Mi(n.outlines,n.position,a),projectionSuccess:o,sampledElevation:s}}function Di(e,t){const i=Object(wi.a)(e.rings,!1,1),r=Object(x.l)(i.position,e.spatialReference,0,i.position,t,0,i.position.length/3);for(let n=2;n<i.position.length;n+=3)i.position[n]=Ci.a;return{position:i.position,polygons:Ii(i.polygons,i.position),outlines:Mi(i.outlines,i.position),projectionSuccess:r}}function Mi(e,t,i){const r=new Array;for(const{index:n,count:a}of e){if(a<=1)continue;const e=3*n,s=e+3*a;r.push({index:n,count:a,position:t.subarray(e,s),mapPosition:i?i.subarray(e,s):void 0})}return r}function Ii(e,t,i){const r=new Array;for(const{index:n,count:a,holeIndices:s,pathLengths:o}of e){if(a<=1)continue;const e=3*n,c=e+3*a,l=s.map((e=>e-n));r.push({index:n,count:a,holeIndices:l,pathLengths:o,position:t.subarray(e,c),mapPosition:i?i.subarray(e,c):void 0})}return r}var zi=i(607),Li=i(750);const Fi=["polygon","extent"];function Vi(e,t,i,r,n,a,s,o,c,l,d,h,u,p){const f=i.length/3;let b=0,m=2*r.count;(function(e,t,i,r,n,a,s,o,c,l,d,h,u,p,f,b,m,g){Object(y.k)(Qi,m);const v=b>0?1:-1;let O=3*i,x=h,j=3*x,_=h+r,S=3*_;for(let P=0;P<r;++P)g&&(Qi[0]=e[O+0],Qi[1]=e[O+1],Qi[2]=e[O+2],Object(y.r)(Qi,Qi)),o[j+0]=e[O+0],o[j+1]=e[O+1],o[j+2]=e[O+2],c[j+0]=t[O+0],c[j+1]=t[O+1],c[j+2]=t[O+2],l[j+0]=-v*Qi[0],l[j+1]=-v*Qi[1],l[j+2]=-v*Qi[2],d[x]=0,o[S+0]=e[O+0]+b*Qi[0],o[S+1]=e[O+1]+b*Qi[1],o[S+2]=e[O+2]+b*Qi[2],c[S+0]=t[O+0],c[S+1]=t[O+1],c[S+2]=t[O+2],l[S+0]=v*Qi[0],l[S+1]=v*Qi[1],l[S+2]=v*Qi[2],d[_]=b,j+=3,S+=3,O+=3,x+=1,_+=1;O=3*a,j=0,S=3*f;const w=b<0?er:Ki,C=b<0?Ki:er;for(let y=0;y<s;++y)p[j+0]=n[O+w[0]],p[j+1]=n[O+w[1]],p[j+2]=n[O+w[2]],u[S+0]=n[O+C[0]]+r,u[S+1]=n[O+C[1]]+r,u[S+2]=n[O+C[2]]+r,j+=3,S+=3,O+=3})(e,t,r.index,r.count,i,0,f,n,a,s,o,c,l,d,m,h,u,p),c+=2*r.count,m=0,Bi(n,a,o,s,b,r.pathLengths[0],r.count,c,l,m,h),c+=4*r.pathLengths[0],m+=2*r.pathLengths[0],b+=r.pathLengths[0];for(let g=1;g<r.pathLengths.length;++g)Bi(n,a,o,s,b,r.pathLengths[g],r.count,c,l,m,h),c+=4*r.pathLengths[g],m+=2*r.pathLengths[g],b+=r.pathLengths[g]}function Gi(e,t,i,r,n,a,s){r[a]=r[s],s*=3,e[0+(a*=3)]=e[s+0],e[a+1]=e[s+1],e[a+2]=e[s+2],t[a+0]=t[s+0],t[a+1]=t[s+1],t[a+2]=t[s+2],i[a+0]=n[0],i[a+1]=n[1],i[a+2]=n[2]}const Ui=Object(O.f)();function Bi(e,t,i,r,n,a,s,o,c,l,d){let h=n,u=n+1,p=n+s,f=n+s+1,b=o,m=o+1,g=o+2*a,v=o+2*a+1;d<0&&(h=n+s+1,f=n),l*=3;for(let y=0;y<a;++y)y===a-1&&(d>0?(u=n,f=n+s):(u=n,h=n+s)),$i(e,h,u,p,Ui),Gi(e,t,r,i,Ui,b,h),Gi(e,t,r,i,Ui,m,u),Gi(e,t,r,i,Ui,g,p),Gi(e,t,r,i,Ui,v,f),c[l++]=b,c[l++]=g,c[l++]=v,c[l++]=b,c[l++]=v,c[l++]=m,h++,u++,p++,f++,b+=2,m+=2,g+=2,v+=2}const Ni=Object(O.f)(),ki=Object(O.f)(),Hi=Object(O.f)(),qi=Object(O.f)(),Wi=Object(O.f)();function $i(e,t,i,r,n){t*=3,i*=3,r*=3,Object(y.w)(Ni,e[t++],e[t++],e[t++]),Object(y.w)(ki,e[i++],e[i++],e[i++]),Object(y.w)(Hi,e[r++],e[r++],e[r++]),Object(y.j)(qi,ki,Ni),Object(y.j)(Wi,Hi,Ni),Object(y.g)(n,Wi,qi),Object(y.r)(n,n)}const Yi=Object(O.f)();function Zi(e,t,i,r){const n=e.stageObject,a=n.geometryRecords,s=a.length,o="absolute-height"!==t.mode;let c=0;const l=n.transformation,d=Object(g.c)(Object(v.d)(),l);for(let h=0;h<s;h+=2){const e=a[h].geometry,s=e.getMutableAttribute("position").data,u=e.vertexAttributes.get("size").data,p=e.vertexAttributes.get("mapPos").data,f=new Be.a(p),b=s.length/3;let m=0,g=!1,v=0;const O=i.spatialReference;for(let n=0;n<b;n++){Yi[0]=s[m],Yi[1]=s[m+1],Yi[2]=s[m+2],Object(Ve.g)(f,i,t,r,Ji),o&&(v+=Ji.sampledElevation),Ue.a.TESTS_DISABLE_OPTIMIZATIONS?(Object(y.w)(Xi,f.array[f.offset+0],f.array[f.offset+1],Ji.z+u[m/3]),r.toRenderCoords(Xi,O,Xi),Object(y.q)(Xi,Xi,d)):(Object(y.w)(Xi,s[m+0],s[m+1],s[m+2]),Object(y.q)(Xi,Xi,l),r.setAltitude(Xi,Ji.z+u[m/3]),Object(y.q)(Xi,Xi,d)),s[m]=Xi[0],s[m+1]=Xi[1],s[m+2]=Xi[2];const e=tr/r.unitInMeters;(Math.abs(Yi[0]-s[m])>=e||Math.abs(Yi[1]-s[m+1])>=e||Math.abs(Yi[2]-s[m+2])>=e)&&(g=!0),f.offset+=3,m+=3}g&&(e.invalidateBoundingInfo(),n.geometryVertexAttrsUpdated(a[h]),a[h+1].geometry.invalidateBoundingInfo(),n.geometryVertexAttrsUpdated(a[h+1])),c+=v/b}return c/s}const Xi=Object(O.f)(),Qi=Object(O.f)(),Ji=new Ve.a,Ki=[0,2,1],er=[0,1,2],tr=.01;var ir=i(100),rr=i(237),nr=i(931),ar=i(396),sr=i(447);class or{constructor(e,t,i){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this._layerView=null,this.isElevationSource=!1}initialize(e,t,i){this.stage=e,this._layerView=i,this._overlayRenderer=this._layerView.view.basemapTerrain.overlayManager.renderer}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._overlayRenderer.addGeometries(this.renderGeometries,this._layerView,1);if(e||this._addedToStage){for(const e of this.renderGeometries)e.instanceParameters.visible=this._visible;this._overlayRenderer.updateGeometries(this.renderGeometries,this._layerView,1)}}}destroy(){this.stage&&this._addedToStage&&this._overlayRenderer.removeGeometries(this.renderGeometries,this._layerView,4),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=Object(O.f)()){return Object(y.w)(e,0,0,0)}getBoundingBoxObjectSpace(e=Object(j.f)()){return Object(j.h)(e)}addObjectState(e,t){0===e&&(this.renderGeometries.forEach((e=>{const i=e.addHighlight();t.addRenderGeometry(e,i,this)})),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView))}removeObjectState(e){this.renderGeometries.forEach((t=>{e.removeRenderGeometry(t)}))}removeRenderGeometryObjectState(e,t){e.removeHighlight(t),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._layerView)}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.computeAttachmentOrigin(dr)&&(e.draped.origin[0]+=dr[0],e.draped.origin[1]+=dr[1],e.draped.num++)}async getProjectedBoundingBox(e,t,i,r,a){Object(j.h)(a);for(let n=0;n<this.renderGeometries.length;n++){const t=this.renderGeometries[n];this._getRenderGeometryProjectedBoundingRect(t,e,cr,i),Object(j.m)(a,cr)}if(t){let e;Object(j.d)(a,dr);const i=Object(Ge.d)(a,t);try{e=await t.service.queryElevation(dr[0],dr[1],r,i,"ground")}catch(s){}Object(n.l)(e)&&(a[2]=Math.min(a[2],e),a[5]=Math.max(a[5],e))}return a}_getRenderGeometryProjectedBoundingRect(e,t,i,r){if(this.boundingBox)Object(j.w)(lr,this.boundingBox);else{const t=e.boundingSphere,i=t[3];lr[0]=t[0]-i,lr[1]=t[1]-i,lr[2]=t[2]-i,lr[3]=t[0]+i,lr[4]=t[1]+i,lr[5]=t[2]+i}return t(lr,0,2),this.calculateRelativeScreenBounds&&r.push({location:Object(j.d)(lr),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),Object(j.A)(lr,i)}}const cr=Object(_.l)(),lr=Object(j.f)(),dr=Object(O.f)();var hr,ur=i(1106),pr=i(227);function fr(e){return null!=e}function br(e){return"number"==typeof e}function mr(e){return"string"==typeof e}function gr(e,t){e&&e.push(t)}function vr(e,t,i,r,n){const a=e.minSize,s=e.maxSize;if(e.expression)return gr(n,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){const e=r.symbolSize[i];return t.minSize[i]=e,t.maxSize[i]=e,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=1,!0}if(fr(e.field))return fr(e.stops)?2===e.stops.length&&br(e.stops[0].size)&&br(e.stops[1].size)?(yr(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=1,!0):(gr(n,"Could not convert size info: stops only supported with 2 elements"),!1):br(a)&&br(s)&&fr(e.minDataValue)&&fr(e.maxDataValue)?(yr(a,s,e.minDataValue,e.maxDataValue,t,i),t.type[i]=1,!0):null!=pr.a[e.valueUnit]?(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/pr.a[e.valueUnit],t.type[i]=1,!0):"unknown"===e.valueUnit?(gr(n,"Could not convert size info: proportional size not supported"),!1):(gr(n,"Could not convert size info: scale-dependent size not supported"),!1);if(!fr(e.field)){if(e.stops&&e.stops[0]&&br(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=1,!0;if(br(a))return t.minSize[i]=a,t.maxSize[i]=a,t.offset[i]=a,t.factor[i]=0,t.type[i]=1,!0}return gr(n,"Could not convert size info: unsupported variant of sizeInfo"),!1}function yr(e,t,i,r,n,a){const s=Math.abs(r-i)>0?(t-e)/(r-i):0;n.minSize[a]=s>0?e:t,n.maxSize[a]=s>0?t:e,n.offset[a]=e-i*s,n.factor[a]=s}function Or(e,t,i,r){if(e.normalizationField||e.valueRepresentation)return gr(r,"Could not convert size info: unsupported property"),null;if(!function(e){return null==e||mr(e)}(e.field))return gr(r,"Could not convert size info: field is not a string"),null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return gr(r,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[0,0,0]};let n;switch(e.axis){case"width":return n=vr(e,t.size,0,i,r),n?t:null;case"height":return n=vr(e,t.size,2,i,r),n?t:null;case"depth":return n=vr(e,t.size,1,i,r),n?t:null;case"width-and-depth":return n=vr(e,t.size,0,i,r),n&&vr(e,t.size,1,i,r),n?t:null;case null:case void 0:case"all":return n=vr(e,t.size,0,i,r),n=n&&vr(e,t.size,1,i,r),n=n&&vr(e,t.size,2,i,r),n?t:null;default:return gr(r,`Could not convert size info: unknown axis "${e.axis}""`),null}}function xr(e,t,i){e[4*t+0]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function jr(e,t,i){const r=2===i&&"arithmetic"===e.rotationType;t.offset[i]=r?90:0,t.factor[i]=r?-1:1,t.type[i]=1}function _r(e,t,i){if(!e)return null;const r=!t.supportedTypes||!!t.supportedTypes.size,n=!t.supportedTypes||!!t.supportedTypes.color,a=!t.supportedTypes||!!t.supportedTypes.rotation,s=!!t.supportedTypes&&!!t.supportedTypes.opacity,o=e.reduce(((e,o)=>{if(!e)return e;if(o.valueExpression)return gr(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(o.type){case"size":return r?Or(o,e,t,i):e;case"color":return n?function(e,t,i){if(e.normalizationField)return gr(i,"Could not convert color info: unsupported property"),null;if(mr(e.field)){if(!e.stops)return gr(i,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return gr(i,"Could not convert color info: too many color stops"),null;t.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const r=e.stops;for(let e=0;e<8;++e){const i=r[Math.min(e,r.length-1)];t.color.values[e]=i.value,xr(t.color.colors,e,i.color)}}}else{if(!(e.stops&&e.stops.length>=0))return gr(i,"Could not convert color info: no field and no colors/stops"),null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.color.values[e]=1/0,xr(t.color.colors,e,i)}}return t}(o,e,i):e;case"opacity":return s?function(e,t,i){if(e.normalizationField)return gr(i,"Could not convert opacity info: unsupported property"),null;if(mr(e.field)){if(!e.stops)return gr(i,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return gr(i,"Could not convert opacity info: too many opacity stops"),null;t.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const r=e.stops;for(let e=0;e<8;++e){const i=r[Math.min(e,r.length-1)];t.opacity.values[e]=i.value,t.opacity.opacityValues[e]=i.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return gr(i,"Could not convert opacity info: no field and no opacities/stops"),null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].opacity;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.opacity.values[e]=1/0,t.opacity.opacityValues[e]=i}}return t}(o,e,i):null;case"rotation":return a?function(e,t,i){if(!mr(e.field))return gr(i,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return gr(i,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return jr(e,t.rotation,0),t;case"roll":return jr(e,t.rotation,1),t;case null:case void 0:case"heading":return jr(e,t.rotation,2),t;default:return gr(i,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}(o,e,i):e;default:return null}}),{size:null,color:null,opacity:null,rotation:null});return!(e.length>0&&o)||o.size||o.color||o.opacity||o.rotation?o&&o.size&&!function(e,t,i){for(let n=0;n<3;++n){let i=t.unitInMeters;1===e.type[n]&&(i*=t.modelSize[n],e.type[n]=2),e.minSize[n]=e.minSize[n]/i,e.maxSize[n]=e.maxSize[n]/i,e.offset[n]=e.offset[n]/i,e.factor[n]=e.factor[n]/i}let r;if(0!==e.type[0])r=0;else if(0!==e.type[1])r=1;else{if(0===e.type[2])return gr(i,"No size axis contains a valid size or scale"),!1;r=2}for(let n=0;n<3;++n)0===e.type[n]&&(e.minSize[n]=e.minSize[r],e.maxSize[n]=e.maxSize[r],e.offset[n]=e.offset[r],e.factor[n]=e.factor[r],e.type[n]=e.type[r]);return!0}(o.size,t,i)?null:o:null}function Sr(e){return e&&null!=e.size}function wr(e,t){if(!e)return{enabled:!1};if(Ue.a.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};const i=_r(e.visualVariables,t);return i?{enabled:!0,visualVariables:i,materialParameters:Tr(i,t),requiresShaderTransformation:Sr(i)}:{enabled:!1}}function Cr(e,t,i){if(!t||!e.enabled)return!1;const r=e.visualVariables,n=_r(t.visualVariables,i);return!!n&&!!(Pr(r.size,n.size,"size")&&Pr(r.color,n.color,"color")&&Pr(r.rotation,n.rotation,"rotation")&&Pr(r.opacity,n.opacity,"opacity"))&&(e.visualVariables=n,e.materialParameters=Tr(n,i),e.requiresShaderTransformation=Sr(n),!0)}function Pr(e,t,i){if(!!e!=!!t)return!1;if(e&&e.field!==t.field)return!1;if(e&&"rotation"===i){const i=e,r=t;for(let e=0;e<3;e++)if(i.type[e]!==r.type[e]||i.offset[e]!==r.offset[e]||i.factor[e]!==r.factor[e])return!1}return!0}function Tr(e,t){const i={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},r=Sr(e);return e&&e.size?(i.vvSizeEnabled=!0,i.vvSizeMinSize=e.size.minSize,i.vvSizeMaxSize=e.size.maxSize,i.vvSizeOffset=e.size.offset,i.vvSizeFactor=e.size.factor):e&&r&&(i.vvSizeValue=t.transformation.scale),e&&r&&(i.vvSymbolAnchor=t.transformation.anchor,i.vvSymbolRotationMatrix=Object(ji.b)(),Object(g.j)(Er),function(e,t,i,r=Object(v.d)()){const n=e||0,a=t||0,s=i||0;0!==n&&Object(g.r)(r,r,-n/180*Math.PI),0!==a&&Object(g.e)(r,r,a/180*Math.PI),0!==s&&Object(g.k)(r,r,s/180*Math.PI)}(t.transformation.rotation[2],t.transformation.rotation[0],t.transformation.rotation[1],Er),Object(xi.f)(i.vvSymbolRotationMatrix,Er)),e&&e.color&&(i.vvColorEnabled=!0,i.vvColorValues=e.color.values,i.vvColorColors=e.color.colors),e&&e.opacity&&(i.vvOpacityEnabled=!0,i.vvOpacityValues=e.opacity.values,i.vvOpacityOpacities=e.opacity.opacityValues),i}!function(e){const t=Object(v.d)(),i=Object(O.f)();e.evaluateModelTransform=function(e,r,n){if(!e.vvSizeEnabled)return n;Object(g.d)(t,n);const a=e.vvSymbolRotationMatrix;Object(g.s)(Er,a[0],a[1],a[2],0,a[3],a[4],a[5],0,a[6],a[7],a[8],0,0,0,0,1),Object(g.n)(t,t,Er);for(let t=0;t<3;++t){const n=e.vvSizeOffset[t]+r[0]*e.vvSizeFactor[t];i[t]=Object(m.e)(n,e.vvSizeMinSize[t],e.vvSizeMaxSize[t])}return Object(g.g)(t,t,i),Object(g.b)(t,t,e.vvSymbolAnchor),t},e.evaluateModelTransformScale=function(e,t,i){if(!t.vvSizeEnabled)return Object(y.w)(e,1,1,1);for(let r=0;r<3;++r){const n=t.vvSizeOffset[r]+i[0]*t.vvSizeFactor[r];e[r]=Object(m.e)(n,t.vvSizeMinSize[r],t.vvSizeMaxSize[r])}return e}}(hr||(hr={}));const Er=Object(v.d)(),Ar=hr.evaluateModelTransform,Rr=hr.evaluateModelTransformScale;var Dr=i(909),Mr=i(821),Ir=i(1061),zr=i(428);const Lr=Object(v.d)(),Fr=Object(O.h)(0,0,1),Vr=128,Gr=.5,Ur=[.25,.25,.75,.75],Br=[64,64];class Nr extends Ct{constructor(e,t,i,r){super(e,t,i,r),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}getCachedSize(){return{size:this._getIconSize()}}async doLoad(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),i=this._getPrimitive();if(Object(n.l)(i))this._prepareResourcesPrimitive(t,i);else{const i=Object(ar.g)(this.symbol,this.symbolLayer),r=Object(ir.i)(i);r&&"application/json"===r.mediaType?await this._prepareResourcesCIM(t,JSON.parse(r.data),e):await this._prepareResourcesHref(t,i,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=Object(Ge.j)(this._getIconSize());if(e)throw new te.a("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,t=Math.round(null!=e.size?Object(Fe.g)(e.size):16);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e){const t=this._getGraphicHash(e);let i=""===t?null:this._cimSymbolTextures.get(t);if(!i){const r={scaleFactor:this._cimScaleFactorOrFunction},n=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,e,"esriGeometryPoint",r,null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",n.anchorPosition);const a={width:n.imageData.width,height:n.imageData.height,powerOfTwoResizeMode:2};i=new Mr.a(n.imageData,a),this._cimSymbolTextures.set(t,i),this._context.stage.add(i)}return i}_computeSize(e,t){const i=e.width/e.height;return i>1?[t,Math.round(t/i)]:[Math.round(t*i),t]}_prepareMaterialParameters(){const e={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(function(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}(t)){const{screenLength:i,minWorldLength:r,maxWorldLength:n}=t.verticalOffset;e.verticalOffset={screenLength:Object(Fe.g)(i),minWorldLength:r||0,maxWorldLength:null!=n?n:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){const i=this._getOutlineSize();if(kr(t)&&0===i)throw new Error("Nothing to render");this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;const r=this._context.sharedResources.textures.fromData(t,(()=>function(e){let t;const i=Vr,r=i*Gr;switch(e){case"circle":t=Object(ur.a)(i,r);break;case"square":t=Object(ur.d)(i,r);break;case"kite":t=Object(ur.c)(i,r);break;case"cross":t=Object(ur.b)(i,r);break;case"x":t=Object(ur.g)(i,r);break;case"triangle":t=Object(ur.e)(i,r)}return new Mr.a(t,{mipmap:!1,wrap:{s:33071,t:33071},width:Vr,height:Vr,components:4,noUnpackFlip:!0})}(t)));this._texture=r.texture,this._releaseTexture=r,e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=Ur,e.textureId=this._texture.id;const n=this._getIconSize();this._size=[n,n],this._symbolTextureRatio=2,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(e,t,i){if(!Object(c.a)("esri-canvas-svg-support")&&Object(ir.x)(t))throw new te.a("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const r=this._getIconSize(),n=r*this._context.layerView.view.pixelRatio,a=await Object(Ie.c)(this._context.sharedResources.textures.fromUrl(t,n,{signal:i}));if(!1===a.ok)throw Object(Y.t)(a.error),new te.a("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${t})`);this._releaseTexture=a.value;const s=a.value.texture,o=s.params;this._size=this._computeSize(o,r),e.textureId=s.id,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesCIM(e,t,r){const n=new zr.a({data:t});if(!this._context.sharedResources.cimSymbolRasterizer){const e=(await Promise.all([i.e(14),i.e(50)]).then(i.bind(null,1192))).CIMSymbolRasterizer;Object(Y.u)(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference,!0))}const a=this._context.layer.fields?this._context.layer.fields.map((e=>e.toJSON())):null;let s,o;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(n,a,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(isNaN(e.scaleExpression)){const t=e.scaleExpression,i=await Object(ce.d)(t,this._context.layer.spatialReference,a);o=(e,t,r)=>{const n=Object(sr.a)(i,e,{$view:r},"esriGeometryPoint",t);return null!==n?n:1}}else s=Number(e.scaleExpression)}this._cimScaleFactorOrFunction=s||o||1;const c=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];Object(Y.u)(r);const l=this._context.layer.fieldsIndex;this._cimRequiredFields=c.map((e=>l.get(e).name)),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||nr.b}_getOutlineSize(){let e=0;const t=this.symbolLayer;return Object(n.l)(t.outline)&&null!=t.outline.size?Math.max(Object(Fe.g)(t.outline.size),0):(e=kr(this._getPrimitive())?1.5:0,Math.max(e,0))}_getOutlineColor(){const e=this._getLayerOpacity(),t=this.symbolLayer,i=Object(n.j)(t,"outline","color");if(Object(n.l)(i)){const t=Le.a.toUnitRGB(i),r=i.a*e;return[t[0],t[1],t[2],r]}return[0,0,0,0]}_getFillColor(){if(kr(this._getPrimitive()))return K.b;const e=Object(n.k)(this._getPrimitive()),t=Object(n.j)(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}_getAnchorPos(e,t){return"relative"===e?Object(P.e)((t.x||0)+.5,.5-(t.y||0)):e in Ge.h?Ge.h[e]:Ge.h.center}_createMaterialAndAddToStage(e,t){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=wr(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(e,this._fastUpdates.materialParameters),this._cimLayers){let i=this._cimSymbolMaterials.get(e.textureId);return i||(i=new Ir.a(e),this._cimSymbolMaterials.set(e.textureId,i),t.add(i)),i}return this._material=new Ir.a(e),t.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial((e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped})})),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial((e=>this._context.stage.remove(e))),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((e=>this._context.stage.remove(e))),this._cimSymbolTextures.clear(),this._releaseTexture=Object(n.r)(this._releaseTexture)}_getScaleFactor(e,t){if(this._drivenProperties.size&&e.size){for(let t=0;t<3;t++){const i=e.size[t];i&&"symbol-value"!==i&&"proportional"!==i&&(e.size[t]=Object(Fe.g)(i))}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let i,r;if(this._cimLayers){if(!this._cimLayers.length)return null;const e=this._generateTextureCIM(t),n={textureId:e.id,...this._cimMaterialParametersInfo};r=this._createMaterialAndAddToStage(n,this._context.stage),i=[e.params.width,e.params.height]}else i=this._size,r=Object(n.t)(this._material);const a=Object(Rt.d)(t.geometry);if(Object(n.k)(a))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const s=e.renderingInfo,o=this._getVertexOpacityAndColor(s);let c=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const e=i[0]>i[1]?i[0]:i[1];c=this._getScaleFactor(s,e)}c*=this._symbolTextureRatio;const l=[i[0]*c,i[1]*c],d=this.setGraphicElevationContext(t,new Ke.a);return this.ensureDrapedStatus("on-the-ground"===d.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,a,r,o,l,e.layer.uid):this._createAs3DShape(t,a,r,o,l,d,t.uid)}layerOpacityChanged(){const e=this._getFillColor(),t=this._getOutlineColor();return this._forEachMaterial((i=>{i.setParameters({color:e}),i.setParameters({outlineColor:t})})),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=Object(Ve.e)(Nr.elevationModeChangeTypes,i,r);if(n!==Ve.b.UPDATE)return n;const a=Object(Ve.h)(r)||"absolute-height"===r;return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial((e=>{e.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return 0;if(!Cr(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return 0;Object(n.l)(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters)}return 2}_defaultElevationInfoNoZ(){return Hr}_createAs3DShape(e,t,i,r,n,a,s){const o=this.getFastUpdateAttrValues(e),c=o?e=>Ar(this._fastUpdates.materialParameters,o,e):null,l=[dt.a.createPointGeometry(Fr,null,r,n,qr,null,o)],d=Object(Rt.a)(this._context,t,l,[i],a,this._context.layer.uid,s,c);if(null===d)return null;const h=new tt(this,d.object,l,null,null,ke,a);return h.alignedSampledElevation=d.sampledElevation,h.needsElevationUpdates=Object(Ve.h)(a.mode)||"absolute-height"===a.mode,h.getScreenSize=this._createScreenSizeGetter(n,c),h.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(h.getScreenSize(),1,e),Object(Rt.b)(h,t,this._context.elevationProvider),h}_createAsOverlay(e,t,i,r,a,s){i.renderPriority=this._renderPriority;const o=Object(ot.e)();Object(x.o)(t,o,this._context.overlaySR),o[2]=Ci.a;const c=this._context.clippingExtent;if(Object(n.l)(c)&&!Object(j.e)(c,o))return null;const l=this.getFastUpdateAttrValues(e),d=l?e=>Ar(this._fastUpdates.materialParameters,l,e):null,h=dt.a.createPointGeometry(Fr,o,r,a,null,null,l),u=new Dr.a(h,i,s,e.uid);o[3]=0,Object(rr.c)(u.boundingSphere,o),u.calculateShaderTransformation=d;const p=new or(this,[u],null);return p.getScreenSize=this._createScreenSizeGetter(a,d),p.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(p.getScreenSize(),1,e),p}_createScreenSizeGetter(e,t){const i=this._outlineSize+2;if(this._fastUpdates.enabled){const r=e[0]/this._symbolTextureRatio,n=e[1]/this._symbolTextureRatio;return(e=Object(P.a)())=>{const a=t(Lr);return e[0]=a[0]*r+i,e[1]=a[5]*n+i,e}}{const t=e[0]/this._symbolTextureRatio+i,r=e[1]/this._symbolTextureRatio+i;return(e=Object(P.a)())=>(e[0]=t,e[1]=r,e)}}_fastVisualVariableConvertOptions(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=Object(O.h)(e,e,e),i=Object(Fe.h)(1),r=e*i;return{modelSize:t,symbolSize:Object(O.h)(r,r,r),unitInMeters:i,transformation:{anchor:O.c,scale:O.a,rotation:O.c}}}_getGraphicHash(e){let t="";for(const i of this._cimRequiredFields)t+=i+e.attributes[i];return t}_forEachMaterial(e){Object(n.l)(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)}}function kr(e){return!!Object(n.l)(e)&&("cross"===e||"x"===e)}Nr.PRIMITIVE_SIZE=Br,Nr.elevationModeChangeTypes={definedChanged:Ve.b.UPDATE,staysOnTheGround:Ve.b.NONE,onTheGroundChanged:Ve.b.RECREATE};const Hr={mode:"relative-to-ground",offset:0},qr=Object(ot.g)(0,0,0,1);var Wr=i(958),$r=i(1038),Yr=i(719);const Zr=["polyline","polygon","extent"];class Xr extends Ct{constructor(e,t,i,r){super(e,t,i,r),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=wr(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const e=null!=this.symbolLayer.size?this.symbolLayer.size:Object(Fe.h)(1);if(e<0)throw new te.a("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=e}}getMaterialParameters(e){const t=Object(n.j)(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t);this._patternHidesLine&&(i[3]=0);const r=i[3],a={width:1,color:i,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:Object(Wr.d)(this.symbolLayer.cap||"butt"),transparent:r<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:Object($r.b)(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};if(this._drivenProperties.size)this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size&&(a.width=Object(Fe.g)(1));else{const e=null!=this.symbolLayer.size?this.symbolLayer.size:Object(Fe.h)(1);a.width=Object(Fe.g)(e)}return this._fastUpdates&&this._fastUpdates.visualVariables?{...a,...this._fastUpdates.materialParameters}:a}get lineMaterial(){return Object(n.k)(this._lineMaterial)&&(this._lineMaterial=new Yr.a(this.getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}get ringMaterial(){return Object(n.k)(this._ringMaterial)&&(this._ringMaterial=new Yr.a(this.getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}destroy(){super.destroy(),this._context.stage.remove(this._lineMaterial),this._lineMaterial=null,this._context.stage.remove(this._ringMaterial),this._ringMaterial=null}getDrivenSize(e){return this._drivenProperties.size&&e.size?Object(Fe.g)(function(e){for(let t=0;t<3;t++){const i=e[t];if("number"==typeof i)return isFinite(i)?i:0}return 0}(e.size)):1}getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?Pt(this._fastUpdates.visualVariables.size.field,e):null}getDrivenColor(e){const t=Object(ot.g)(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?Pt(this._fastUpdates.visualVariables.color.field,e):null}getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?Pt(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Zr,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new Ke.a);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,t.uid)}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return 0;if(!Cr(this._fastUpdates,t,this._vvConvertOptions))return 0;Object(n.l)(this._lineMaterial)&&this._lineMaterial.setParameters(this._fastUpdates.materialParameters),Object(n.l)(this._ringMaterial)&&this._ringMaterial.setParameters(this._fastUpdates.materialParameters)}return 2}layerOpacityChanged(){return Object(n.l)(this._lineMaterial)&&this.updateMaterialLayerOpacity(this._lineMaterial),Object(n.l)(this._ringMaterial)&&this.updateMaterialLayerOpacity(this._ringMaterial),!0}updateMaterialLayerOpacity(e){const t=e.parameters.color,i=Object(n.j)(this.symbolLayer,"material","color"),r=this._patternHidesLine?0:this._getCombinedOpacity(i),a=r<1||this.needsDrivenTransparentPass,s=[t[0],t[1],t[2],r];e.setParameters({color:s,transparent:a})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=Object(Ve.e)(Xr.elevationModeChangeTypes,i,r);if(n!==Ve.b.UPDATE)return n;const a=Object(Ve.h)(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){return Object(n.l)(this._lineMaterial)&&this._lineMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),Object(n.l)(this._ringMaterial)&&this._ringMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof Pi.a)return bi.a.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,i){const r=e.graphic,a=this._getGeometryAsPolygonOrPolyline(r.geometry),s="polygon"===a.type?a.rings:a.paths,o=new Array,c=new Array,l=new Array,d=Object(j.f)(),h=Object(Wr.b)(a,this._context.elevationProvider,this._context.renderCoordsHelper,t),u="polygon"===a.type?"rings":"paths";this._logGeometryCreationWarnings(h,s,u,"LineSymbol3DLayer");for(let b=0;b<h.lines.length;b++){const{position:t,mapPosition:i}=h.lines[b];if(Object(n.l)(this._context.clippingExtent)&&(Object(j.h)(d),Object(j.k)(d,i),!Object(j.r)(d,this._context.clippingExtent)))continue;const r=this._createGeometry(e,t,i,a.type,1);o.push(r),c.push("polygon"===a.type?this.ringMaterial:this.lineMaterial),l.push(v.a)}if(0===o.length)return null;const p=new zi.a({geometries:o,materials:c,transformations:l,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),f=new tt(this,p,o,null,null,Ne,t);return f.alignedSampledElevation=h.sampledElevation,f.needsElevationUpdates=Object(Ve.h)(t.mode),f}_createGeometry(e,t,i,r,n){const a="polygon"===r?1:0,s=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,o=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return Object(Wr.a)({overlayInfo:0===n?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:a,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:i,size:o?null:this.getDrivenSize(e.renderingInfo),color:s?null:this.getDrivenColor(e.renderingInfo),sizeFeature:this.getSizeFeatureAttributeData(e.graphic),colorFeature:this.getColorFeatureAttributeData(e.graphic),opacityFeature:this.getOpacityFeatureAttributeData(e.graphic)}})}_createAsOverlay(e,t){const i=e.graphic,r=this._getGeometryAsPolygonOrPolyline(i.geometry),n="polygon"===r.type?r.rings:r.paths,a="polygon"===r.type?this.ringMaterial:this.lineMaterial;a.renderPriority=this._renderPriority;const s=new Array,o=Object(j.f)(),c=Object(j.h)(),l=Object(Wr.c)(r,this._context.overlaySR),d="polygon"===r.type?"rings":"paths";this._logGeometryCreationWarnings(l,n,d,"LineSymbol3DLayer");for(const h of l.lines){if(Object(j.h)(o),Object(j.k)(o,h.position),!Object(j.r)(o,this._context.clippingExtent))continue;Object(j.j)(c,o);const n=this._createGeometry(e,h.position,null,r.type,0),l=new Dr.a(n,a,t,i.uid);Object(rr.l)(l.boundingSphere,.5*(o[0]+o[3]),.5*(o[1]+o[4]),0,.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1]))),s.push(l)}return new or(this,s,c)}get _patternHidesLine(){const e=this.symbolLayer.pattern;return Object(n.l)(e)&&"style"===e.type&&"none"===e.style}}Xr.elevationModeChangeTypes={definedChanged:Ve.b.RECREATE,staysOnTheGround:Ve.b.NONE,onTheGroundChanged:Ve.b.RECREATE};var Qr=i(955),Jr=i(899),Kr=i(802);const en=255,tn=85,rn=tn,nn=2*tn;var an=i(541),sn=i(1139);const on=["mesh"];const cn=Object(O.f)(),ln=Object(O.f)(),dn=Object(O.f)(),hn=Object(O.f)(),un=Object(O.f)(),pn=Object(v.d)(),fn=Object(ji.b)(),bn=Object(j.f)(),mn=[new Qr.a];var gn=i(930),vn=i(743);class yn{constructor(e,t,i,r){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=r,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const t=this.lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){null!=this.instanceIndex&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,i){if(this.elevationAligner){Object(Se.f)(this.elevationContext.featureExpressionInfoContext,i);const r=this.elevationAligner(this,this.elevationContext,e,t);Object(n.l)(r)&&(this.alignedSampledElevation=r)}}getCenterObjectSpace(e=Object(O.f)()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,Sn),Object(y.q)(e,this.lodRenderer.baseBoundingSphere.center,Sn)}getBoundingBoxObjectSpace(e=Object(j.f)()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,Sn);const t=this.lodRenderer.baseBoundingBox;Object(j.h)(e);for(let i=0;i<8;++i)Object(y.w)(xn,0==(1&i)?t[0]:t[3],0==(2&i)?t[1]:t[4],0==(4&i)?t[2]:t[5]),Object(y.q)(xn,xn,Sn),Object(j.n)(e,xn);return e}computeAttachmentOrigin(e){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,Sn),e.render.origin[0]+=Sn[12],e.render.origin[1]+=Sn[13],e.render.origin[2]+=Sn[14],e.render.num++}async getProjectedBoundingBox(e,t,i,r,a){const s=this.getBoundingBoxObjectSpace(a),o=_n,c=Object(j.s)(s)?1:o.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,Sn);for(let n=0;n<c;n++){const e=o[n];xn[0]=s[e[0]],xn[1]=s[e[1]],xn[2]=s[e[2]],Object(y.q)(xn,xn,Sn),On[3*n+0]=xn[0],On[3*n+1]=xn[1],On[3*n+2]=xn[2]}if(!e(On,0,c))return null;Object(j.h)(s);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let n=0;n<3*c;n+=3){for(let e=0;e<3;e++)s[e]=Math.min(s[e],On[n+e]),s[e+3]=Math.max(s[e+3],On[n+e]);l&&i.push({location:On.slice(n,n+3),screenSpaceBoundingRect:l})}if(t&&(Object(j.d)(s,jn),"absolute-height"!==this.elevationContext.mode)){let e;const i=Object(Ge.d)(s,t);try{e=await t.service.queryElevation(jn[0],jn[1],r,i,"ground")}catch(d){}Object(n.l)(e)&&Object(j.u)(s,0,0,-this.alignedSampledElevation+e)}return s}addObjectState(e,t){if(0===e){const i=new vn.a(e);this.addHighlightId(i),t.addExternal((e=>{this.removeHighlightId(e)}),i)}}removeObjectState(e){this._highlights.forEach((t=>e.remove(t)))}addHighlightId(e){this._highlights.add(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}removeHighlightId(e){this._highlights.delete(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const On=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],xn=Object(O.f)(),jn=Object(O.f)(),_n=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],Sn=Object(v.d)();function wn(e,t=Cn){const i=gt(e).reduce(((e,t)=>e+t.indexCount/3),0);return Math.sqrt(i/(t*Math.PI))}const Cn=.05;var Pn,Tn,En=i(1140),An=i(670),Rn=i(402),Dn=i(685),Mn=i(315),In=i(580);(Tn=Pn||(Pn={}))[Tn.ALLOCATED=1]="ALLOCATED",Tn[Tn.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",Tn[Tn.VISIBLE=4]="VISIBLE",Tn[Tn.HIGHLIGHT=8]="HIGHLIGHT",Tn[Tn.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",Tn[Tn.REMOVE=32]="REMOVE",Tn[Tn.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",Tn[Tn.ACTIVE=18]="ACTIVE";class zn{constructor(e){this.localTransform=e.getField("localTransform",_i.i),this.globalTransform=e.getField("globalTransform",_i.i),this.modelOrigin=e.getField("modelOrigin",_i.v),this.model=e.getField("model",_i.f),this.modelNormal=e.getField("modelNormal",_i.f),this.modelScaleFactors=e.getField("modelScaleFactors",_i.m),this.boundingSphere=e.getField("boundingSphere",_i.D),this.color=e.getField("color",_i.C),this.featureAttribute=e.getField("featureAttribute",_i.C),this.state=e.getField("state",_i.l),this.lodLevel=e.getField("lodLevel",_i.l)}}class Ln extends we.a{constructor(e,t){super(),this._capacity=0,this._size=0,this._next=0,this._layout=function(e){let t=Object(zt.a)().mat4f64("localTransform").mat4f64("globalTransform").vec4f64("boundingSphere").vec3f64("modelOrigin").mat3f("model").mat3f("modelNormal").vec2f("modelScaleFactors");return e.indexOf("color")>=0&&(t=t.vec4f("color")),e.indexOf("featureAttribute")>=0&&(t=t.vec4f("featureAttribute")),t=t.u8("state").u8("lodLevel").alignTo(8),t}(e),this._shaderTransformation=t}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this.grow();const e=this.findSlot();return this._view.state.set(e,Pn.ALLOCATED),this._size++,this.emit("instance-added",{index:e}),e}removeInstance(e){const t=this._view.state;Object(Mn.a)(e>=0&&e<this._capacity&&t.get(e)&Pn.ALLOCATED,"invalid instance handle"),this.getStateFlag(e,Pn.ACTIVE)?this.setStateFlags(e,Pn.REMOVE):this.freeInstance(e),this.emit("instance-removed",{index:e})}freeInstance(e){const t=this._view.state;Object(Mn.a)(e>=0&&e<this._capacity&&t.get(e)&Pn.ALLOCATED,"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,i=!0){this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,i=!0){this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,i=Gn,r=Un;t.localTransform.getMat(e,Bn),t.globalTransform.getMat(e,Nn);const n=Object(g.n)(Nn,Nn,Bn);Object(y.w)(i,n[12],n[13],n[14]),t.modelOrigin.setVec(e,i),Object(xi.f)(r,n),t.model.setMat(e,r);const a=Object(In.e)(Gn,n);a.sort(),t.modelScaleFactors.set(e,0,a[1]),t.modelScaleFactors.set(e,1,a[2]),Object(xi.e)(r,r),Object(xi.m)(r,r),t.modelNormal.setMat(e,r),this.setStateFlags(e,Pn.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const i=this._view;i.model.getMat(e,Un),i.modelOrigin.getVec(e,Gn),t[0]=Un[0],t[1]=Un[1],t[2]=Un[2],t[3]=0,t[4]=Un[3],t[5]=Un[4],t[6]=Un[5],t[7]=0,t[8]=Un[6],t[9]=Un[7],t[10]=Un[8],t[11]=0,t[12]=Gn[0],t[13]=Gn[1],t[14]=Gn[2],t[15]=1}applyShaderTransformation(e,t){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){return this._view.localTransform.getMat(e,t),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t),t}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);if(this._shaderTransformation){const i=this._shaderTransformation.scaleFactor(Gn,this,e);t*=Math.max(i[0],i[1],i[2])}return t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);if(this._shaderTransformation){const i=this._shaderTransformation.scaleFactor(Gn,this,e);i.sort(),t*=i[1]}return t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}getColor(e,t){this._view.color.getVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this.setStateFlag(e,Pn.VISIBLE,t),this.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this.getStateFlag(e,Pn.VISIBLE)}setHighlight(e,t){t!==this.getHighlight(e)&&(this.setStateFlag(e,Pn.HIGHLIGHT,t),this.emit("instance-highlight-changed",{index:e}))}getHighlight(e){return this.getStateFlag(e,Pn.HIGHLIGHT)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++t;return t}setStateFlags(e,t){const i=this._view.state;t=i.get(e)|t,i.set(e,t)}clearStateFlags(e,t){const i=this._view.state;t=i.get(e)&~t,i.set(e,t)}setStateFlag(e,t,i){i?this.setStateFlags(e,t):this.clearStateFlags(e,t)}getStateFlag(e,t){return!!(this._view.state.get(e)&t)}grow(){const e=Math.max(Fn,Math.floor(this._capacity*Vn)),t=this._layout.createBuffer(e);if(this._buffer){const e=new Uint8Array(this._buffer.buffer);new Uint8Array(t.buffer).set(e)}this._capacity=e,this._buffer=t,this._view=new zn(this._buffer)}findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&Pn.ALLOCATED;)t=(t+1)%this._capacity;return this._next=(t+1)%this._capacity,t}}const Fn=1024,Vn=2,Gn=Object(O.f)(),Un=Object(ji.b)(),Bn=Object(v.d)(),Nn=Object(v.d)();var kn=i(811);class Hn extends kn.a{constructor(e,t){super((e=>Object(et.h)(this._instanceData.view.boundingSphere.getVec(e,this._tmpSphere))),{maximumDepth:25}),this._tmpSphere=Object(et.c)(),this._tmpMat4=Object(v.d)(),this._instanceData=e,this._boundingSphere=t}addInstance(e){const t=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);Object(y.q)(this._tmpSphere,this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*Object(In.c)(i),t.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class qn{constructor(e,t){this.thresholdScale=1,this._camera=new Dn.a,this._worldSpaceRadius=e,this._thresholds=t.map((e=>e))}updateCamera(e){this._camera.copyFrom(e)}selectLevel(e,t){const i=this._camera.computeScreenPixelSizeAt(e),r=this._worldSpaceRadius*t/i,n=this._thresholds;let a=-1;for(let s=0;s<n.length;++s)r>=n[s]*this.thresholdScale&&(a=s);return a}}var Wn=i(564),$n=i(688),Yn=i(249),Zn=i(250);class Xn{constructor(e,t){const i=e.renderContext.rctx,{geometry:r,material:n}=t;this._materialRepository=e.materialRep,n.setParameters({instancedDoublePrecision:!0});const a=n.createBufferWriter(),s=a.vertexBufferLayout,o=a.elementCount(r),c=a.allocate(o);a.write({},r,c,0),this.geometry=r,this.material=n,this.glMaterials=new Wn.a(n,this._materialRepository),this.vertexBufferLayout=s,this.vbo=Yn.a.createVertex(i,35044,c.buffer),this.vao=new Zn.a(i,Wt.a,{geometry:Object(An.a)(s)},{geometry:this.vbo}),this.vertexCount=o}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,t,i,r,n,a){const s=this.geometry.id;this.material.intersect(this.geometry,null,e.transform.transform,e,i,r,((i,r,o,c,l)=>{if(i>=0){if(null!=t&&!t(e.rayBegin,e.rayEnd,i))return;const c={layerUid:a.layerUid,graphicUid:a.graphicUid(n),geometryId:s,triangleNr:o};if((null==e.results.min.drapedLayerOrder||l>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||i<e.results.min.dist)&&e.results.min.set(6,c,i,r,e.transform.transform,l),0!==e.options.store&&(null==e.results.max.drapedLayerOrder||l>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||i>e.results.max.dist)&&e.results.max.set(6,c,i,r,e.transform.transform,l),2===e.options.store){const t=Object($n.b)(e.results.min.ray);t.set(6,c,i,r,e.transform.transform,l),e.results.all.push(t)}}}))}}class Qn{constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}static async create(e,t,i){const r=await Promise.allSettled(t.components.map((t=>e.schedule((()=>new Xn(e,t)),i)))),n=r.map((e=>"fulfilled"===e.status?e.value:null)).filter((e=>e));if(Object(Y.m)(i)||n.length!==r.length){n.forEach((e=>e.destroy())),Object(Y.u)(i);for(const e of r)if("rejected"===e.status)throw e.reason}return new Qn(t.minScreenSpaceRadius,n)}destroy(){this.components.forEach((e=>e.destroy()))}intersect(e,t,i,r,n,a){this.components.forEach((s=>s.intersect(e,t,i,r,n,a)))}get boundingBox(){if(Object(n.k)(this._boundingBox)){const e=Object(j.h)();this.components.forEach((t=>{Object(n.l)(t.boundingInfo)&&(Object(j.n)(e,t.boundingInfo.bbMin),Object(j.n)(e,t.boundingInfo.bbMax))})),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(Object(n.k)(this._boundingSphere)){const e=this.boundingBox,t=Object(O.f)();Object(j.d)(e,t),this._boundingSphere={center:t,radius:.5*Object(j.g)(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((e,t)=>e+t.triangleCount),0)}}class Jn{constructor(e,t,i){this._elementSize=t,this._buffer=Yn.a.createVertex(e,35044),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(e,t,i,r=0){const n=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(i.array,r*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const i=e*this._elementSize,r=t*this._elementSize;this._buffer.setSubData(this._array,i,i,r)}resize(e){const t=e*this._elementSize,i=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setData(t),this._capacity=e}}class Kn{constructor(e){this.modelOriginHi=e.getField("modelOriginHi",_i.u),this.modelOriginLo=e.getField("modelOriginLo",_i.u),this.model=e.getField("model",_i.f),this.modelNormal=e.getField("modelNormal",_i.f),this.color=e.getField("instanceColor",_i.C),this.featureAttribute=e.getField("instanceFeatureAttribute",_i.C)}}class ea{constructor(e,t){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=e,this._instanceBufferLayout=t,this._elementSize=t.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCylce(){this._captureFirstIndex=!0}beginUpdate(){Object(Mn.a)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){Object(Mn.a)(this._updating,"not updating"),this.size<ra*this.capacity&&this.shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this.transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){Object(Mn.a)(this._updating,"not updating"),this.isFull&&this.grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this.incrementHead(),Object(Mn.a)(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){Object(Mn.a)(this._updating,"not updating"),Object(Mn.a)(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this.incrementTail(),e&&(this._firstIndex=this._tailIndex)}grow(){const e=Math.max(ta,Math.floor(this._capacity*ia));this.resize(e)}shrink(){const e=Math.max(ta,Math.floor(this._capacity*na));this.resize(e)}resize(e){if(Object(Mn.a)(this._updating,"not updating"),e===this._capacity)return;const t=new Jn(this._rctx,this._elementSize,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const e=this.size,i=this.compactInstances(t);Object(Mn.a)(i===e,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=i,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new Kn(this._instanceBufferLayout.createView(this._buffer.array))}compactInstances(e){const t=this._headIndex,i=this._tailIndex;return i<t?(this._buffer.copyRange(i,t,e),t-i):i>t?(this._buffer.copyRange(i,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-i),t+(this._capacity-i)):0}incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}}const ta=1024,ia=2,ra=.3,na=.5;var aa=i(529),sa=i(766);let oa=function(e){const t=e.baseBoundingSphere.radius,i=e.levels.map((e=>e.minScreenSpaceRadius));return new qn(t,i)};class ca{constructor(e,t,i,r){this.type=6,this.isGround=!1,this._inverseViewport=Object(P.a)(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new Dn.a,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=i,this._instanceBufferLayout=Object(Li.b)({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=Object(An.a)(this._instanceBufferLayout,1),this._instanceData=new Ln(this._optionalFields,r),this._instanceData.on("instance-added",(()=>this.requestUpdateCycle())),this._instanceData.on("instance-removed",(()=>this.requestUpdateCycle())),this._instanceData.on("instance-transform-changed",(e=>{this.requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index)})),this._instanceData.on("instance-visibility-changed",(e=>{this.requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index)})),this._instanceData.on("instance-highlight-changed",(()=>this.requestUpdateCycle(!0))),this._enableLevelSelection=this._symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const i=t.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu})),this._highlightRenderInstanceData.forEach((t=>{const i=t.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu})),e}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,i)=>{const r=this._defaultRenderInstanceData[i],n=this._highlightRenderInstanceData[i],a=r.size+n.size,s=e.triangleCount;t.push({renderedInstances:a,renderedTriangles:a*s,trianglesPerInstance:s})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}async initializeRenderContext(e,t){this._context=e;const i=e.renderContext.rctx,r=await Promise.allSettled(this._symbol.levels.map((r=>(this._defaultRenderInstanceData.push(new ea(i,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new ea(i,this._instanceBufferLayout)),Qn.create(e,r,t))))),n=r.map((e=>"fulfilled"===e.status?e.value:null)).filter((e=>e));if(Object(Y.m)(t)||n.length!==r.length){n.forEach((e=>e.destroy())),Object(Y.u)(t);for(const e of r)if("rejected"===e.status)throw e.reason}this._levels=n,this._levelSelector=oa(this)}uninitializeRenderContext(){this.invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceData.forEach((e=>e.destroy()))}get slots(){return[3,5]}get needsHighlight(){return this._highlightRenderInstanceData.reduce(((e,t)=>e+t.size),0)>0}prepareRender(e,t){if(Ue.a.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const e=t.equals(this._lastCamera);this._lastCamera.copyFrom(t),e||this.requestUpdateCycle()}const i=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this.updateInstances(t,i),this.needsUpdates&&this._context.requestRender()}render(e){var t,i;const r=3===e.slot?2:5===e.slot?4:null;if(!r||!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return!1;const n=e.camera;this._inverseViewport[0]=1/n.fullViewport[2],this._inverseViewport[1]=1/n.fullViewport[3];const a={slot:r,origin:[0,0,0],camera:n,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:e.shadowMap.enabled,ssaoHelper:e.ssaoHelper,ssaoEnabled:e.ssaoHelper.enabled,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:e.offscreenRenderingHelper?e.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:null!=(t=null==(i=e.offscreenRenderingHelper)?void 0:i.depthTexture)?t:null,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:v.a,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType,terrainLinearDepthTexture:e.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:e.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:e.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:e.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:e.multipassGeometryParams.multipassGeometryEnabled,highlightColorTexture:null};e.rctx.bindVAO();const s=5!==e.pass&&7!==e.pass,o=6!==e.pass;return s&&this._renderComponents(e,r,a,this._defaultRenderInstanceData),o&&this._renderComponents(e,r,a,this._highlightRenderInstanceData),s||o}intersect(e,t,i,r){if(!this.baseMaterial.isVisible())return;const n=Object(O.f)();Object(y.j)(n,r,i);const a=n=>{this._instanceData.getCombinedModelTransform(n,ua),e.transform.set(ua),Object(y.q)(pa,i,e.transform.inverse),Object(y.q)(fa,r,e.transform.inverse);const a=this._instanceData.getState(n),s=this._instanceData.getLodLevel(n);Object(Mn.a)(a&Pn.ACTIVE,"invalid instance state"),Object(Mn.a)(s>=0&&s<this._levels.length,"invaid lod level"),this._levels[s].intersect(e,t,pa,fa,n,this._metadata)};this.baseMaterial.parameters.verticalOffset?this.octree.forEach(a):this.octree.forEachAlongRay(i,n,a)}queryDepthRange(e){return this.queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this.invalidateOctree()}requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}get octree(){return this._octree||(this._octree=this.buildOctree()),this._octree}invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null)}buildOctree(){const e=new Hn(this._instanceData,this.baseBoundingSphere),t=this._instanceData,i=t.view?t.view.state:null;for(let r=0;r<this._instanceData.capacity;++r)i.get(r)&Pn.ACTIVE&&e.addInstance(r);return e}queryDepthRangeOctree(e){const t=e.eye,i=e.viewForward,r=this.octree.findClosest(i,1,e.frustum),n=this.octree.findClosest(i,-1,e.frustum);if(null!=r&&null!=n){this._instanceData.view.boundingSphere.getVec(r,ha),Object(y.j)(ha,ha,t);const a=Object(y.h)(ha,i)-ha[3];this._instanceData.view.boundingSphere.getVec(n,ha),Object(y.j)(ha,ha,t);const s=Object(y.h)(ha,i)+ha[3];return{near:Math.max(e.near,a),far:Math.min(e.far,s)}}return{near:1/0,far:-1/0}}startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this.needsUpdates&&this._context.requestRender()}updateInstances(e,t){const i=this._enableLevelSelection,r=this._levelSelector;r.updateCamera(e),this._defaultRenderInstanceData.forEach((e=>{e.beginUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.beginUpdate()}));const n=this._instanceData,a=this._instanceData.view,s=n.size,o=n.capacity;let c=this._instanceIndex;t=Math.min(s,t);for(let l=0;l<t;++l){0===c&&this.startUpdateCycle();const e=a.state.get(c);let s=0;if(!(e&Pn.ALLOCATED)){c=(c+1)%o,t++;continue}const l=a.lodLevel.get(c);if(e&Pn.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[l].freeTail(),e&Pn.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[l].freeTail(),e&Pn.REMOVE)n.freeInstance(c);else if(e&Pn.VISIBLE){let t=0;i&&(a.modelOrigin.getVec(c,da),t=r.selectLevel(da,n.getCombinedMedianScaleFactor(c))),s=e&~(Pn.ACTIVE|Pn.TRANSFORM_CHANGED),t>=0&&(e&Pn.HIGHLIGHT?(la(this._highlightRenderInstanceData[t],a,c),s|=Pn.HIGHLIGHT_ACTIVE):(la(this._defaultRenderInstanceData[t],a,c),s|=Pn.DEFAULT_ACTIVE)),a.state.set(c,s),a.lodLevel.set(c,t)}else s=e&~(Pn.ACTIVE|Pn.TRANSFORM_CHANGED),a.state.set(c,s);if(this._octree){const t=!!(e&Pn.ACTIVE),i=!!(s&Pn.ACTIVE);!t&&i?this._octree.addInstance(c):t&&!i?this._octree.removeInstance(c):t&&i&&e&Pn.TRANSFORM_CHANGED&&(this._octree.removeInstance(c),this._octree.addInstance(c))}c=(c+1)%o}this._instanceIndex=c,this._defaultRenderInstanceData.forEach((e=>{e.endUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.endUpdate()}))}_renderComponents(e,t,i,r){this.levels.forEach(((n,a)=>{n.components.forEach((n=>{this._renderComponent(e,t,i,r[a],n,a)}))}))}_renderComponent(e,t,i,r,a,s){if(0===r.size||!a.material.requiresSlot(t))return;const{rctx:o,pass:c}=e,l=a.glMaterials.load(o,c);if(Object(n.k)(l))return;const d=o.capabilities.instancing,h=l.beginSlot(i),u=h.program;h.bindPipelineState(o,t),o.useProgram(u),l.bind(i,h),o.bindVAO(a.vao),h.ensureAttributeLocations(a.vao),e.isHighlightPass&&Object(Rn.b)(u,i),h.bindDraw(i),Ue.a.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.pass&&(u.setUniform4fv("externalColor",ba[Math.min(s,ba.length-1)]),u.setUniform1i("colorMixMode",Yt.b.replace));const p=r.capacity,f=r.headIndex,b=r.tailIndex,m=r.firstIndex,g=this._glInstanceBufferLayout,v=(e,t)=>{Object(sa.a)(o,Wt.a,r.buffer,g,e),d.drawArraysInstanced(h.primitiveType,0,a.vertexCount,t-e),Object(sa.d)(o,Wt.a,r.buffer,g)};a.material.parameters.transparent&&null!=m?f>b?(Object(Mn.a)(m>=b&&m<=f,"invalid firstIndex"),v(m,f),v(b,m)):f<b&&(m<=f?(Object(Mn.a)(m>=0&&m<=f,"invalid firstIndex"),v(m,f),v(b,p),v(0,m)):(Object(Mn.a)(m>=b&&m<=p,"invalid firstIndex"),v(m,p),v(0,f),v(b,m))):f>b?v(b,f):f<b&&(v(0,f),v(b,p)),o.bindVAO(null)}}function la(e,t,i){const r=e.allocateHead();!function(e,t,i,r){Object(aa.c)(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,e.model,t),i.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(r,e.color,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,e.featureAttribute,t)}(t,i,e.view,r)}const da=Object(O.f)(),ha=Object(ot.e)(),ua=Object(v.d)(),pa=Object(O.f)(),fa=Object(O.f)(),ba=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];const ma=Object(O.f)(),ga=Object(v.d)(),va=Object(v.d)(),ya=Object(ot.e)(),Oa=new Ve.a;var xa=i(176);function ja(e,t,i,r,n){return e[0]=t,e[1]=i,e[2]=r,e[3]=n,e}function _a(e,t,i){const r=t[0],n=t[1],a=t[2],s=t[3],o=i[0],c=i[1],l=i[2],d=i[3];return e[0]=r*o+a*c,e[1]=n*o+s*c,e[2]=r*l+a*d,e[3]=n*l+s*d,e}function Sa(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}const wa=_a,Ca=Sa;Object.freeze({__proto__:null,copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},set:ja,transpose:function(e,t){if(e===t){const i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},invert:function(e,t){const i=t[0],r=t[1],n=t[2],a=t[3];let s=i*a-n*r;return s?(s=1/s,e[0]=a*s,e[1]=-r*s,e[2]=-n*s,e[3]=i*s,e):null},adjoint:function(e,t){const i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e},determinant:function(e){return e[0]*e[3]-e[2]*e[1]},multiply:_a,rotate:function(e,t,i){const r=t[0],n=t[1],a=t[2],s=t[3],o=Math.sin(i),c=Math.cos(i);return e[0]=r*c+a*o,e[1]=n*c+s*o,e[2]=r*-o+a*c,e[3]=n*-o+s*c,e},scale:function(e,t,i){const r=t[0],n=t[1],a=t[2],s=t[3],o=i[0],c=i[1];return e[0]=r*o,e[1]=n*o,e[2]=a*c,e[3]=s*c,e},fromRotation:function(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},str:function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},frob:function(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)},LDU:function(e,t,i,r){return e[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-e[2]*i[1],[e,t,i]},add:function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},subtract:Sa,exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},equals:function(e,t){const i=e[0],r=e[1],n=e[2],a=e[3],s=t[0],o=t[1],c=t[2],l=t[3];return Math.abs(i-s)<=xa.a*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(r-o)<=xa.a*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(n-c)<=xa.a*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(a-l)<=xa.a*Math.max(1,Math.abs(a),Math.abs(l))},multiplyScalar:function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e},multiplyScalarAndAdd:function(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e},mul:wa,sub:Ca});var Pa=i(431);class Ta extends Dt.a{constructor(e,t,i,r,n,a){super(e,t),this.path=i,this.geometrySR=r,this.upVectorAlignment=n,this.stencilWidth=a}}function Ea(e){return"upVectorAlignment"in e}function Aa(){return[1,0,0,1]}Object.freeze({__proto__:null,create:Aa,clone:function(e){return[e[0],e[1],e[2],e[3]]},fromValues:function(e,t,i,r){return[e,t,i,r]},createView:function(e,t){return new Float64Array(e,t,4)}});function Ra(){return{up:Object(O.f)(),right:Object(O.f)()}}function Da(e,t,i){Object(y.q)(e.up,t.up,i),Object(y.q)(e.right,t.right,i)}function Ma(e,t,i){Object(fi.s)(e,Object(y.h)(i,t.right),Object(y.h)(i,t.up))}class Ia{constructor(){this.pos=Object(O.f)(),this.posES=Object(O.f)(),this.posGS=Object(O.f)(),this.vRight=Object(O.f)(),this.vLeft=Object(O.f)(),this.frame=Ra(),this.rotationFrame=Ra(),this.rotationRight=Object(P.a)(),this.rotationAngle=0,this.miterStretch=[1,0,0,1]}setFrameFromUpVector(e){Object(y.k)(this.frame.up,e),Object(y.f)(Ka,this.vLeft,this.vRight),Object(y.r)(Ka,Ka),Object(y.e)(Ja,this.frame.up,Object(y.h)(Ka,this.frame.up)),Object(y.j)(is,Ka,Ja),Object(y.r)(is,is),Object(y.g)(this.frame.right,is,this.frame.up)}computeRotationAxisAndAngleFromUpVector(){Object(y.k)(this.rotationFrame.up,this.frame.up),Object(y.k)(this.rotationFrame.right,this.frame.right),Object(fi.s)(this.rotationRight,1,0),Object(y.e)(Ja,this.frame.up,Object(y.h)(this.frame.up,this.vLeft)),Object(y.j)(Ja,this.vLeft,Ja),Object(y.s)(Ja,Ja),Object(y.r)(Ja,Ja),Object(y.e)(Ka,this.frame.up,Object(y.h)(this.frame.up,this.vRight)),Object(y.j)(Ka,this.vRight,Ka),Object(y.r)(Ka,Ka),Object(y.g)(es,this.rotationFrame.up,this.vLeft);const e=Math.sign(Object(y.h)(es,this.vRight));if(this.rotationAngle=e*(Math.PI-Object(m.b)(Object(y.h)(Ja,Ka))),Math.abs(this.rotationAngle)>0){const e=Object(m.o)(Math.cos(.5*this.rotationAngle));ja(this.miterStretch,e-1+1,0,0,1)}const t=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*t))}}class za{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null}addVertex(e,t){return this.vertices.push(Object(P.b)(e)),this.vertexNormals.push(Object(P.b)(t)),this.vertices.length-1}addUV(e){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(e),this.uvs.length-1}addPole(e,t=null){return this.poles.push({position:Object(P.b)(e),normal:t?Object(P.b)(t):null}),this.poles.length-1}addSegment(e,t=null,i=null){this.vertexIndices.push(e.v0),this.vertexIndices.push(e.v1),t&&(this.uvIndices.push(t.v0),this.uvIndices.push(t.v1)),i&&(this.poleIndices.push(i.v0),this.poleIndices.push(i.v1))}get numSegments(){return this.vertexIndices.length/2}hasUV(){return null!=this.uvs}translate(e,t){for(const i of this.vertices)i[0]+=e,i[1]+=t;for(const i of this.poles)i.position[0]+=e,i.position[1]+=t}static circle(e=20){const t=new za,i={v0:0,v1:0};t.addPole(Object(P.e)(0,0));for(let a=0;a<e;++a){const i=2*a*Math.PI/e,r=Math.cos(i),n=Math.sin(i),s=Object(P.e)(.5*r,.5*n),o=Object(P.e)(r,n);t.addVertex(s,o),t.addUV(a/e)}t.addUV(1);for(let a=0;a<e-1;++a){const e={v0:a,v1:a+1},r=e;t.addSegment(e,r,i)}const r={v0:e-1,v1:0},n={v0:e-1,v1:e};return t.addSegment(r,n,i),t}static rect(){const e=new za,t=Object(P.e)(-.5,-.5),i=Object(P.e)(.5,-.5),r=Object(P.e)(.5,.5),n=Object(P.e)(-.5,.5),a=Object(P.e)(0,-1),s=Object(P.e)(1,0),o=Object(P.e)(0,1),c=Object(P.e)(-1,0);e.addUV(0),e.addUV(1),e.addPole(Object(P.e)(0,.5),o),e.addPole(Object(P.e)(0,.5)),e.addPole(Object(P.e)(0,-.5)),e.addPole(Object(P.e)(0,-.5),a);const l={v0:0,v1:1};return e.addVertex(t,a),e.addVertex(i,a),e.addSegment({v0:0,v1:1},l,{v0:3,v1:3}),e.addVertex(i,s),e.addVertex(r,s),e.addSegment({v0:2,v1:3},l,{v0:2,v1:1}),e.addVertex(r,o),e.addVertex(n,o),e.addSegment({v0:4,v1:5},l,{v0:0,v1:0}),e.addVertex(n,c),e.addVertex(t,c),e.addSegment({v0:6,v1:7},l,{v0:1,v1:2}),e}}class La{constructor(e){this.vertices=[],this.offset=Object(O.f)(),this.xform=Object(v.d)(),this.vertices=e;const t=Math.floor((e.length-1)/2);Object(y.k)(this.offset,this.vertices[t].pos);for(const i of this.vertices)Object(y.j)(i.pos,i.pos,this.offset);Object(g.b)(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const e=this.vertices.length;let t=this.vertices[0];t.index=0,Object(y.w)(t.vLeft,0,0,0),t.vLeftLength=0,Object(y.j)(t.vRight,this.vertices[1].pos,t.pos),t.vRightLength=Object(y.p)(t.vRight),Object(y.r)(t.vRight,t.vRight);let i=t;for(let r=1;r<e;++r)t=this.vertices[r],t.index=r,Object(y.k)(t.vLeft,i.vRight),t.vLeftLength=i.vRightLength,r<e-1?(Object(y.j)(t.vRight,this.vertices[r+1].pos,t.pos),t.vRightLength=Object(y.p)(t.vRight),Object(y.r)(t.vRight,t.vRight)):(Object(y.k)(t.vRight,t.vLeft),t.vRightLength=t.vLeftLength),i=t}}class Fa{numProfilesPerJoin(){return 1}extrude(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],!1)}}class Va{constructor(e=.8*Math.PI,t=1){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,i){const r=rs;if(Math.abs(e.rotationAngle)>=this.cutoffAngle)for(let n=0;n<this.numBendSubdivisions+1;++n){Object(g.j)(ns),Object(g.f)(ns,ns,.5*-e.rotationAngle+n*e.rotationAngle/this.numBendSubdivisions,e.rotationFrame.up),Da(r,e.frame,ns);for(let n=0;n<t.vertices.length;++n)Object(fi.k)(t.vertices[n],e.rotationRight)*e.rotationAngle>=0?i(e.index,r,t.vertices[n],t.vertexNormals[n],!1):(Object(fi.p)(Za,t.vertices[n],e.miterStretch),i(e.index,e.frame,Za,t.vertexNormals[n],!0))}else for(let n=0;n<this.numBendSubdivisions+1;++n)for(let r=0;r<t.vertices.length;++r){const n=Object(fi.k)(t.vertices[r],e.rotationRight)*e.rotationAngle>=0;Object(fi.p)(Za,t.vertices[r],e.miterStretch),i(e.index,e.frame,Za,t.vertexNormals[r],!n)}}}const Ga={generateUV:!1};class Ua{rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],0,0)}}class Ba extends Ua{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}}class Na extends Ua{constructor(e,t=0,i=!1){super(),this.profile=e,this.profilePlaneOffset=t,this.flip=i}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],this.profilePlaneOffset,0)}rebuildCapGeometry(e,t){const i=Xa;Object(fi.s)(i,0,0);const r=this.flip?1:-1;for(let n=0;n<this.profile.vertices.length;++n)t(e.index,e.frame,this.profile.vertices[n],i,this.profilePlaneOffset,r)}buildTopology(e,t){const i=this.vertexBufferStart+this.profile.vertexIndices[0];for(let r=1;r<this.profile.numSegments;++r){const e=this.profile.vertexIndices[2*r+0],n=this.profile.vertexIndices[2*r+1],a=this.vertexBufferStart+e,s=this.vertexBufferStart+n;this.flip?t(s,a,i):t(i,a,s)}}}class ka extends Ua{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}getNumVertices(){let e=0;return e=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(e+=this.profile.vertices.length),e+=this.profile.poles.length,e}getNumIndices(){let e=0;e+=2*this.profile.numSegments*(this.numSegments-1);for(let t=0;t<this.profile.numSegments;++t){const i=this.profile.vertexIndices[2*t+0],r=this.profile.vertexIndices[2*t+1];this.profile.poleIndices[i]===this.profile.poleIndices[r]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){const i=e.frame,r=.5*this.sign,n=Za,a=Xa;Object(fi.s)(a,0,0);for(let s=0;s<this.profile.poles.length;++s){const n=this.profile.poles[s];n.normal?t(e.index,i,n.position,n.normal,r,0):t(e.index,i,n.position,a,r,this.sign)}if(this.breakNormals)for(let s=0;s<this.profile.vertices.length;++s)t(e.index,i,this.profile.vertices[s],this.profile.vertexNormals[s],0,0);for(let s=0;s<this.numSegments-1;++s){const o=(1-(s+1)/this.numSegments)*Math.PI*.5,c=Math.sin(o),l=Math.cos(o);for(let s=0;s<this.profile.vertices.length;++s){const o=this.profile.poles[this.profile.poleIndices[s]];Object(fi.f)(n,this.profile.vertices[s],o.position),Object(fi.g)(n,n,c),o.normal?(Object(fi.m)(n,n,o.position),t(e.index,i,n,o.normal,r*l,0)):(Object(fi.i)(a,n),Object(fi.g)(a,a,c),Object(fi.m)(n,n,o.position),t(e.index,i,n,a,r*l,this.sign*l))}}}buildTopology(e,t){const i=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,r=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let n=0;n<this.profile.numSegments;++n){const e=this.profile.vertexIndices[2*n+0],a=this.profile.vertexIndices[2*n+1],s=this.vertexBufferStart+this.profile.poleIndices[e],o=this.vertexBufferStart+this.profile.poleIndices[a];let c=i+e,l=i+a;for(let i=0;i<this.numSegments-1;++i){const n=r+i*this.profile.vertices.length+e,s=r+i*this.profile.vertices.length+a;this.flip?(t(n,l,c),t(l,n,s)):(t(c,l,n),t(s,n,l)),c=n,l=s}this.flip?(t(s,l,c),s!==o&&t(s,o,l)):(t(c,l,s),s!==o&&t(l,o,s))}}}class Ha{constructor(e,t,i,r,n,a=Ga){this.options=a,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=t,this.path=e,this.extruder=i,this.startCap=r,this.endCap=n;const s=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*s+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const o=this.startCap.getNumVertices();this.numVerticesTotal+=o,this.numNormalsTotal+=o,this.endCap.vertexBufferStart=this.numVerticesTotal;const c=this.endCap.getNumVertices();this.numVerticesTotal+=c,this.numNormalsTotal+=c,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this.rebuildGeometry(),this.buildTopology()}emitVertex(e,t,i,r,n){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,n){const t=this.path.vertices[e];this.profileRightAxisData[4*this._extrusionVertexCount+3]=t.rotationRight[0]*t.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=t.rotationRight[1]*t.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(e,t,i,r,n,a){this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,this.profileRightAxisData[4*this._extrusionVertexCount+3]=n,this.profileUpAxisData[4*this._extrusionVertexCount+3]=a,++this._extrusionVertexCount}emitTriangle(e,t,i){this.vertexIndices[3*this._triangleCount+0]=e,this.vertexIndices[3*this._triangleCount+1]=t,this.vertexIndices[3*this._triangleCount+2]=i,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[e],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[t],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[i],this.normalIndices[3*this._triangleCount+0]=e,this.normalIndices[3*this._triangleCount+1]=t,this.normalIndices[3*this._triangleCount+2]=i,++this._triangleCount}rebuildGeometry(){const e=(e,t,i,r,n)=>this.emitVertex(e,t,i,r,n),t=(e,t,i,r,n,a)=>this.emitCapVertex(e,t,i,r,n,a);this._extrusionVertexCount=0;for(const i of this.path.vertices)this.originData[3*i.index+0]=i.pos[0],this.originData[3*i.index+1]=i.pos[1],this.originData[3*i.index+2]=i.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,t);for(let i=1;i<this.path.vertices.length-1;++i)this.extruder.extrude(this.path.vertices[i],this.profile,e);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,t),this.startCap.rebuildCapGeometry(this.path.vertices[0],t),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],t),this.profile.hasUV()&&this.options.generateUV)for(let i=0;i<this.profile.uvs.length;++i)this.uvData[2*i+0]=this.profile.uvs[i],this.uvData[2*i+1]=0}buildTopology(){const e=(e,t,i)=>this.emitTriangle(e,t,i);this._triangleCount=0;const t=this.profile.vertices.length,i=this.profile.numSegments,r=this.numExtrusionProfiles-1;let n=i*r*2*3;this.startCap.indexBufferStart=n,this.startCap.firstProfileVertexIndex=0,n+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=n,this.endCap.firstProfileVertexIndex=t*(this.numExtrusionProfiles-1),n+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(n),this.normalIndices=new Uint32Array(n),this.pathVertexIndices=new Uint32Array(n),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(n));for(let a=0;a<i;++a){const i=this.profile.vertexIndices[2*a],n=this.profile.vertexIndices[2*a+1];for(let a=0;a<r;++a){const r=a*t+i,s=(a+1)*t+n,o=a*t+n;e(r,(a+1)*t+i,s),e(r,s,o)}}this.startCap.buildTopology(this.path.vertices[0],e),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],e)}onPathChanged(){this.rebuildGeometry()}}class qa{constructor(e){this.builder=e}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}}class Wa extends qa{constructor(e){super(e),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=new Float32Array(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Float32Array(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;for(let t=0;t<this.builder.numVerticesTotal;++t){let i=this.builder.pathVertexData[t];const r=0===i||i===this.builder.path.vertices.length-1;i*=3;const n=Ya;Object(y.w)(n,this.builder.originData[i++],this.builder.originData[i++],this.builder.originData[i]);const a=4*t,s=Ja,o=Za,c=Ka,l=es,d=ts;let h=0,u=0;if(Object(y.w)(l,this.builder.profileRightAxisData[a],this.builder.profileRightAxisData[a+1],this.builder.profileRightAxisData[a+2]),Object(y.w)(d,this.builder.profileUpAxisData[a],this.builder.profileUpAxisData[a+1],this.builder.profileUpAxisData[a+2]),Object(fi.s)(o,this.builder.profileVertexAndNormalData[a]*e[0],this.builder.profileVertexAndNormalData[a+1]*e[1]),r)Object(y.g)(c,d,l),h=this.builder.profileRightAxisData[a+3]*e[0],u=this.builder.profileUpAxisData[a+3];else{const e=Xa,t=Qa;Object(fi.s)(e,this.builder.profileRightAxisData[a+3],this.builder.profileUpAxisData[a+3]);const i=Object(fi.l)(e);Object(fi.i)(e,e);const r=Object(fi.k)(o,e);if(Math.abs(r)>i){Object(fi.s)(t,-e[1],e[0]);const n=Object(fi.k)(o,t);Object(fi.g)(e,e,i*Math.sign(r)),Object(fi.g)(t,t,n),Object(fi.m)(o,e,t)}Object(y.w)(c,0,0,0)}Object(y.w)(s,l[0]*o[0]+d[0]*o[1],l[1]*o[0]+d[1]*o[1],l[2]*o[0]+d[2]*o[1]),this.vertexAttributePosition[3*t+0]=n[0]+s[0]+c[0]*h,this.vertexAttributePosition[3*t+1]=n[1]+s[1]+c[1]*h,this.vertexAttributePosition[3*t+2]=n[2]+s[2]+c[2]*h;const p=Za;Object(fi.s)(p,this.builder.profileVertexAndNormalData[a+2],this.builder.profileVertexAndNormalData[a+3]),this.vertexAttributeNormal[3*t+0]=l[0]*p[0]+d[0]*p[1]+c[0]*u,this.vertexAttributeNormal[3*t+1]=l[1]*p[0]+d[1]*p[1]+c[1]*u,this.vertexAttributeNormal[3*t+2]=l[2]*p[0]+d[2]*p[1]+c[2]*u}}createGeometryData(){const e=[["position",this.builder.vertexIndices],["normal",this.builder.normalIndices]],t=[["position",{size:3,data:this.vertexAttributePosition,exclusive:!0}],["normal",{size:3,data:this.vertexAttributeNormal,exclusive:!0}]];if(this.vertexAttributeColor){const i=this.builder.vertexIndices.length;e.push(["color",new Uint32Array(i)]),t.push(["color",{size:4,data:this.vertexAttributeColor}])}return{vertexAttributes:t,indices:e}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(e,t,i){const r=this.builder.vertexIndices,n={size:3,data:this.vertexAttributePosition},a=r.length/3;Object(Yt.g)(e,t,0,a,r,n,void 0,void 0,i)}}class $a extends qa{constructor(e,t,i,r){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=i,this.opacityAttributeValue=r,this.vvData=null,this.baked=new Wa(e),this.vvData=new Float32Array(4*this.builder.path.vertices.length);for(let n=0;n<this.builder.path.vertices.length;++n){this.vvData[4*n+0]=t,this.vvData[4*n+1]=i,this.vvData[4*n+2]=r;const e=0===n||n===this.builder.path.vertices.length-1;this.vvData[4*n+3]=e?1:0}}createGeometryData(){return{vertexAttributes:[["position",{size:3,data:this.builder.originData,exclusive:!0}],["profileRight",{size:4,data:this.builder.profileRightAxisData,exclusive:!0}],["profileUp",{size:4,data:this.builder.profileUpAxisData,exclusive:!0}],["profileVertexAndNormal",{size:4,data:this.builder.profileVertexAndNormalData,exclusive:!0}],["featureValue",{size:4,data:this.vvData,exclusive:!0}]],indices:[["position",this.builder.pathVertexIndices],["profileRight",this.builder.vertexIndices],["profileUp",this.builder.vertexIndices],["profileVertexAndNormal",this.builder.vertexIndices],["featureValue",this.builder.pathVertexIndices]]}}}const Ya=Object(O.f)(),Za=Object(P.a)(),Xa=Object(P.a)(),Qa=Object(P.a)(),Ja=Object(O.f)(),Ka=Object(O.f)(),es=Object(O.f)(),ts=Object(O.f)(),is=Object(O.f)(),rs=Ra(),ns=Object(v.d)();var as=i(1109),ss=i(877),os=i(352),cs=i(604),ls=i(430),ds=i(651),hs=i(1110);const us=new Map([["position",0],["profileRight",1],["profileUp",2],["profileVertexAndNormal",3],["featureValue",4]]);class ps extends Ht.a{initializeProgram(e){const t=ps.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,pbrMode:0,useCustomDTRExponentForWater:!1,receiveAmbientOcclusion:i.receiveSSAO,doubleSidedMode:i.doubleSidedMode,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new $t.a(e.rctx,r,us)}bindPass(e,t){var i,r;Object(Nt.c)(this.program,t.camera.projectionMatrix),this.program.setUniform3fv("size",e.size),t.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(os.a)(this.program,t)),0!==this.configuration.output&&7!==this.configuration.output||this.program.setUniform1f("opacity",e.opacity),0===this.configuration.output?(t.lighting.setUniforms(this.program,!1),this.program.setUniform3fv("ambient",e.ambient),this.program.setUniform3fv("diffuse",e.diffuse),this.program.setUniform3fv("specular",e.specular),this.program.setUniform1f("opacity",e.opacity)):1!==this.configuration.output&&3!==this.configuration.output||Object(Nt.b)(this.program,t.camera.nearFar),Object(as.b)(this.program,e),null==(i=t.shadowMap)||i.bind(this.program),null==(r=t.ssaoHelper)||r.bind(this.program,t.camera)}bindDraw(e){Object(Nt.d)(this.program,e),Object(Vt.c)(this.program,this.configuration,e),this.program.rebindTextures(),0!==this.configuration.output&&7!==this.configuration.output||Object(Nt.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&Object(cs.c)(this.program,e),2===this.configuration.output&&ss.a.bindUniforms(this.program,e.camera.viewInverseTransposeMatrix)}setPipelineState(e){const t=this.configuration,i=3===e,r=2===e;return Object(Xt.f)({blending:0!==t.output&&7!==t.output||!t.transparent?null:i?ls.g:Object(ls.a)(e),culling:(e=>!e.slicePlaneEnabled&&!(e.transparent||0===e.doubleSidedMode))(t)&&Xt.e,depthTest:{func:Object(ls.b)(e)},depthWrite:i||r?Xt.d:null,colorWrite:Xt.c,stencilWrite:t.sceneHasOcludees?ds.h:null,stencilTest:t.sceneHasOcludees?ds.c:null,polygonOffset:i||r?null:ls.d})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}ps.shader=new kt.a(hs.a,(()=>i.e(330).then(i.bind(null,1363))));class fs extends qt.a{constructor(){super(...arguments),this.output=0,this.doubleSidedMode=0,this.receiveShadows=!1,this.receiveSSAO=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(r.a)([Object(qt.b)({count:8})],fs.prototype,"output",void 0),Object(r.a)([Object(qt.b)({count:3})],fs.prototype,"doubleSidedMode",void 0),Object(r.a)([Object(qt.b)()],fs.prototype,"receiveShadows",void 0),Object(r.a)([Object(qt.b)()],fs.prototype,"receiveSSAO",void 0),Object(r.a)([Object(qt.b)()],fs.prototype,"vvSize",void 0),Object(r.a)([Object(qt.b)()],fs.prototype,"vvColor",void 0),Object(r.a)([Object(qt.b)()],fs.prototype,"vvOpacity",void 0),Object(r.a)([Object(qt.b)()],fs.prototype,"slicePlaneEnabled",void 0),Object(r.a)([Object(qt.b)()],fs.prototype,"transparent",void 0),Object(r.a)([Object(qt.b)()],fs.prototype,"sceneHasOcludees",void 0),Object(r.a)([Object(qt.b)({count:4})],fs.prototype,"transparencyPassType",void 0),Object(r.a)([Object(qt.b)()],fs.prototype,"multipassTerrainEnabled",void 0),Object(r.a)([Object(qt.b)()],fs.prototype,"cullAboveGround",void 0);var bs=i(1035);const ms=Mn.a;class gs extends Mt.a{constructor(e){super(e,ys),this.supportsEdges=!0,this._vertexAttributeLocations=us,this.techniqueConfig=new fs,this.vertexBufferLayout=gs.getVertexBufferLayout(this.parameters)}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,0!==e&&7!==e||(this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?1:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?2:0,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows,this.techniqueConfig.receiveSSAO=!!t.ssaoEnabled&&this.parameters.receiveSSAO),this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}isVisibleInPass(e){return 4!==e&&6!==e&&7!==e||this.parameters.castShadows}isVisible(){const e=this.parameters;return!!super.isVisible()&&e.opacity>0}intersect(e,t,i,r,a,s,o){const c=e;if(!Ea(c))return;const l=c.path,d=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const e=this.parameters.vvSizeOffset,t=this.parameters.vvSizeFactor,i=this.parameters.vvSizeMinSize,r=this.parameters.vvSizeMaxSize,n=l.sizeAttributeValue;d[0]*=Object(m.e)(e[0]+n*t[0],i[0],r[0]),d[1]*=Object(m.e)(e[2]+n*t[2],i[2],r[2])}const h=Math.max(d[0],d[1]),u=e.boundingInfo;if(Object(n.k)(u))return void this._intersectTriangles(l,d,a,s,o);const p=Object(j.p)(u.bbMin[0]-h,u.bbMin[1]-h,u.bbMin[2]-h,u.bbMax[0]+h,u.bbMax[1]+h,u.bbMax[2]+h),f=[s[0]-a[0],s[1]-a[1],s[2]-a[2]],b=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]),g=[b/f[0],b/f[1],b/f[2]];Object(Yt.d)(p,a,g,r.tolerance)&&this._intersectTriangles(l,d,a,s,o)}_intersectTriangles(e,t,i,r,n){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(i,r,n)}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return null;const r=i.get("position");return Object(an.a)(r,null,!1,t)}createBufferWriter(){return new Os(this.vertexBufferLayout)}requiresSlot(e){return e===(this.parameters.transparent?4:2)||20===e}createGLMaterial(e){return 0===e.output||7===e.output||1===e.output||2===e.output||4===e.output||3===e.output&&this.parameters.castShadows?new vs(e):null}static getVertexBufferLayout(e){let t=Object(zt.a)().vec3f("position").vec4f("profileRight").vec4f("profileUp").vec4f("profileVertexAndNormal");return(e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&(t=t.vec4f("featureValue")),t}}class vs extends Lt.a{updateParameters(e){return this.ensureTechnique(ps,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}_updateShadowState(e){(Object(n.k)(this.technique)||e.shadowMappingEnabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:e.shadowMappingEnabled})}beginSlot(e){return 0!==this._output&&7!==this._output||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}const ys={size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1,...bs.a.Default,...Mt.b};class Os{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,r){const n=e=>{if(t.vertexAttributes.has(e)){const n=t.vertexAttributes.get(e),a=t.indices.get(e);ms(4===n.size);const s=i.getField(e,_i.C);if(!s)throw new Error("unable to acquire view for "+e);Object(Ft.a)(a,n.data,s,r)}};n("profileRight"),n("profileUp"),n("profileVertexAndNormal"),this.vertexBufferLayout.hasField("featureValue")&&n("featureValue"),Object(Ft.c)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)}}const xs=["polyline"];function js(e,t,i){switch(t){case"world":for(const t of e.vertices)Object(y.f)(Es,t.pos,e.offset),i.worldUpAtPosition(Es,Ts),t.setFrameFromUpVector(Ts),t.computeRotationAxisAndAngleFromUpVector();break;case"path":Object(y.f)(Es,e.vertices[0].pos,e.offset),i.worldUpAtPosition(Es,Ts),function(e,t){let i=null;const r=e.vertices.length,n=.99619469809,a=Object(O.f)(),s=Object(O.f)(),o=Object(O.f)(),c=Object(O.f)(),l=Object(O.f)(),d=Object(O.f)(),h=Object(w.d)();let u=e.vertices[0];Object(y.k)(s,t),Object(y.w)(a,0,1,0),dt.a.makeOrthoBasisDirUpFallback(u.vRight,s,a,a,o,s,n),Object(y.k)(u.frame.up,s),Object(y.k)(u.frame.right,o),i=u;for(let p=1;p<r;++p){u=e.vertices[p],Object(y.f)(l,u.vLeft,u.vRight);let t=Object(y.p)(l);t>0?(t=1/Math.sqrt(t),l[0]=l[0]*t,l[1]=l[1]*t,l[2]=l[2]*t):(l[0]=u.vRight[0],l[1]=u.vRight[1],l[2]=u.vRight[2]),Object(y.f)(d,i.pos,i.frame.up),Object(w.g)(u.pos,l,h),Object(w.m)(h,Object(C.g)(d,u.vLeft),c)?(Object(y.j)(c,c,u.pos),Object(y.r)(s,c),Object(y.g)(o,l,s),Object(y.r)(o,o)):dt.a.makeOrthoBasisDirUpFallback(l,i.frame.up,i.frame.right,a,o,s,n),Object(y.k)(u.frame.up,s),Object(y.k)(u.frame.right,o),i=u}}(e,Ts);for(const t of e.vertices){const e=Math.sign(Object(y.h)(t.frame.right,t.vRight));Object(y.g)(t.rotationFrame.up,t.vRight,t.vLeft),Object(y.e)(t.rotationFrame.up,t.rotationFrame.up,e),Object(y.r)(t.rotationFrame.up,t.rotationFrame.up);const i=Object(y.h)(t.rotationFrame.up,t.frame.up),r=Object(y.h)(t.rotationFrame.up,t.frame.right);if(Object(y.e)(Es,t.frame.up,-r),Object(y.e)(As,t.frame.right,i),Object(y.f)(Es,Es,As),Object(y.r)(t.rotationFrame.right,Es),Ma(t.rotationRight,t.frame,t.rotationFrame.right),Object(y.s)(Es,t.vLeft),t.rotationAngle=-e*(Math.PI-Object(m.b)(Object(y.h)(Es,t.vRight))),Math.abs(t.rotationAngle)>0){const e=Object(m.o)(Math.cos(.5*t.rotationAngle));ja(t.miterStretch,1+(e-1)*t.rotationRight[0]*t.rotationRight[0],(e-1)*t.rotationRight[0]*t.rotationRight[1],(e-1)*t.rotationRight[0]*t.rotationRight[1],1+(e-1)*t.rotationRight[1]*t.rotationRight[1])}const n=Math.PI-t.rotationAngle;t.maxStretchDistance=Math.abs(Math.min(t.vLeftLength,t.vRightLength)*Object(m.o)(Math.cos(.5*n)))}}}function _s(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function Ss(e,t,i,r){let n=0;for(const a of e.vertices)Object(Ve.g)(a.posES,i,t,r,Rs),n+=Rs.sampledElevation,Object(y.f)(Ts,a.pos,e.offset),r.setAltitude(Ts,Rs.z),Object(y.j)(a.pos,Ts,e.offset);return e.updatePathVertexInformation(),n/e.vertices.length}function ws(e,t,i,r){const n=e.stageObject,a=n.geometryRecords;let s=0;Cs.spatialReference=r.spatialReference;for(const o of a){const e=o.geometry;if(!Ea(e))continue;const a=e.path,c=a.builder.path,l=e.geometrySR;Ps.spatialReference=l,s+=Ss(c,t,i,r),"world"!==e.upVectorAlignment&&js(c,e.upVectorAlignment,r),a.onPathChanged(),e.invalidateBoundingInfo(),n.geometryVertexAttrsUpdated(o)}return s/a.length}const Cs=Object(se.g)(0,0,0,null),Ps=Object(se.g)(0,0,0,null),Ts=Object(O.f)(),Es=Object(Pa.b)(),As=Object(Pa.b)(),Rs=new Ve.a,Ds=3,Ms=3,Is=10;function zs(e,t,i,r,a=1){Object(y.w)(Gs,1,0,0),Object(y.w)(Us,0,1,0),Object(y.w)(Bs,0,0,1),function(e,t){Object(y.w)(Js,0,0,0);for(let i=0;i<t.count-1;i++)t.getVec(i,Fs),Object(y.f)(Js,Js,Fs);Object(y.e)(e,Js,1/(t.count-1))}(Ls,t),function(e,t){const i=e.count-1;return Object(w.e)(e,t,0,Math.floor(i/3),Math.floor(i*(2/3)))}(t,Vs)&&function(e,t,i,r,a,s){Object(n.l)(a)?(a.basisMatrixAtPosition(s,Ys),Object(y.w)(Zs,Ys[0],Ys[1],Ys[2]),Object(y.w)(Xs,Ys[4],Ys[5],Ys[6]),Object(y.w)(Qs,Ys[8],Ys[9],Ys[10])):(Object(y.w)(Zs,1,0,0),Object(y.w)(Xs,0,1,0),Object(y.w)(Qs,0,0,1));const o=Object(w.q)(e);Object(y.h)(o,Qs)<0&&Object(y.e)(o,o,-1),Object(y.k)(r,o);const c=Object(y.h)(o,Xs),l=Object(y.h)(o,Zs);Math.abs(c)<Math.abs(l)?(Object(y.c)(t,Zs,o,-l),Object(y.r)(t,t),Object(y.g)(i,t,o),Object(y.r)(i,i),Object(y.e)(i,i,-1)):(Object(y.c)(i,Xs,o,-c),Object(y.r)(i,i),Object(y.g)(t,i,o),Object(y.r)(t,t))}(Vs,Gs,Us,Bs,i,Ls),Object(fi.s)(Ns,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),Object(fi.s)(ks,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let n=0;n<t.count;n++){t.getVec(n,Fs);const e=Object(y.h)(Gs,Fs),i=Object(y.h)(Us,Fs);Ns[0]=Math.min(Ns[0],e),Ns[1]=Math.min(Ns[1],i),ks[0]=Math.max(ks[0],e),ks[1]=Math.max(ks[1],i)}const s=Object(y.h)(Bs,Ls);Ks(qs,Ns[0],Ns[1],s,Gs,Us,Bs),Ks(Ws,ks[0],Ns[1],s,Gs,Us,Bs),Ks($s,Ns[0],ks[1],s,Gs,Us,Bs),Object(y.j)(Ws,Ws,qs),Object(y.e)(Ws,Ws,.5),Object(y.j)($s,$s,qs),Object(y.e)($s,$s,.5),Object(y.f)(qs,qs,Ws),Object(y.f)(qs,qs,$s);const o=Ns[0]%a,c=Ns[1]%a;Hs[0]=Ns[0]-o,Hs[1]=Ns[1]-c;for(let n=0;n<t.count;n++){t.getVec(n,Fs),e.setValues(n,(Object(y.h)(Gs,Fs)-Hs[0])/a,(Object(y.h)(Us,Fs)-Hs[1])/a,Hs[0]/a,Hs[1]/a);for(let e=0;e<3;e++)r.set(n,e,qs[e]),r.set(n,e+3,Ws[e]),r.set(n,e+6,$s[e])}}const Ls=Object(O.f)(),Fs=Object(O.f)(),Vs=Object(w.d)(),Gs=Object(O.f)(),Us=Object(O.f)(),Bs=Object(O.f)(),Ns=Object(P.a)(),ks=Object(P.a)(),Hs=Object(P.a)(),qs=Object(O.f)(),Ws=Object(O.f)(),$s=Object(O.f)();const Ys=Object(v.d)(),Zs=Object(O.f)(),Xs=Object(O.f)(),Qs=Object(O.f)();const Js=Object(O.f)();function Ks(e,t,i,r,n,a,s){Object(y.w)(e,t*n[0]+i*a[0]+r*s[0],t*n[1]+i*a[1]+r*s[1],t*n[2]+i*a[2]+r*s[2])}var eo=i(690),to=i(661),io=i(1111);class ro extends Ht.a{initializeProgram(e){const t=ro.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,style:i.style,patternSpacing:i.patternSpacing,lineWidth:i.lineWidth,draped:i.draped,OITEnabled:0===i.transparencyPassType,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new $t.a(e.rctx,r,so)}bindPass(e,t){Object(Nt.c)(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("matColor",e.color),this.configuration.draped?(this.program.setUniform1f("worldToScreenRatio",1/t.screenToPCSRatio),this.program.setUniform1f("texelSize",1/t.camera.pixelRatio)):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/t.camera.perScreenPixelRatio),4===this.configuration.output&&Object(Rn.b)(this.program,t),(1===this.configuration.output||t.multipassTerrainEnabled)&&this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(os.a)(this.program,t))}bindDraw(e){Object(Nt.d)(this.program,e),Object(Nt.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),Object(Vt.c)(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e,t){const i=this.configuration,r=3===e,n=2===e;return Object(Xt.f)({blending:0===i.output||7===i.output?r?ls.g:Object(ls.a)(e):null,culling:Object(Xt.b)(i.cullFace),depthTest:{func:Object(ls.b)(e)},depthWrite:r?i.writeDepth&&Xt.d:Object(ls.c)(e),colorWrite:Xt.c,stencilWrite:i.sceneHasOcludees?ds.h:null,stencilTest:i.sceneHasOcludees?t?ds.d:ds.c:null,polygonOffset:r||n?i.polygonOffset&&no:Object(ls.h)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipelineState(this.configuration.transparencyPassType,!0),this.setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}ro.shader=new kt.a(io.a,(()=>i.e(331).then(i.bind(null,1364))));const no={factor:1,units:1};class ao extends qt.a{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.enableOffset=!0,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(r.a)([Object(qt.b)({count:8})],ao.prototype,"output",void 0),Object(r.a)([Object(qt.b)({count:3})],ao.prototype,"cullFace",void 0),Object(r.a)([Object(qt.b)()],ao.prototype,"slicePlaneEnabled",void 0),Object(r.a)([Object(qt.b)()],ao.prototype,"vertexColors",void 0),Object(r.a)([Object(qt.b)()],ao.prototype,"polygonOffset",void 0),Object(r.a)([Object(qt.b)()],ao.prototype,"writeDepth",void 0),Object(r.a)([Object(qt.b)()],ao.prototype,"sceneHasOcludees",void 0),Object(r.a)([Object(qt.b)({count:6})],ao.prototype,"style",void 0),Object(r.a)([Object(qt.b)()],ao.prototype,"patternSpacing",void 0),Object(r.a)([Object(qt.b)()],ao.prototype,"lineWidth",void 0),Object(r.a)([Object(qt.b)()],ao.prototype,"enableOffset",void 0),Object(r.a)([Object(qt.b)()],ao.prototype,"draped",void 0),Object(r.a)([Object(qt.b)({count:4})],ao.prototype,"transparencyPassType",void 0),Object(r.a)([Object(qt.b)()],ao.prototype,"multipassTerrainEnabled",void 0),Object(r.a)([Object(qt.b)()],ao.prototype,"cullAboveGround",void 0);const so=new Map([["position",0],["color",3],["uvMapSpace",4],["boundingRect",5]]);class oo extends Mt.a{constructor(e){super(e,ho),this.supportsEdges=!0,this._vertexAttributeLocations=so,this.techniqueConfig=new ao}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.style=this.parameters.style,this.techniqueConfig.patternSpacing=this.parameters.patternSpacing,this.techniqueConfig.lineWidth=this.parameters.lineWidth,this.techniqueConfig.draped=this.parameters.draped,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.enableOffset=t.camera.relativeElevation<ls.e,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(e,t,i,r,n,a,s){Object(Yt.f)(e,t,r,n,a,void 0,s)}requiresSlot(e,t){return 20===e||(4===Object(Wn.b)(t)?2===e:e===(this.parameters.writeDepth?4:7))}createGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output&&this.parameters.writeLinearDepth?new co(e):null}createBufferWriter(){const e=Object(zt.a)().vec3f("position").vec4u8("color").vec4f("uvMapSpace");return this.parameters.draped||e.mat3f("boundingRect"),new lo(e)}}class co extends Lt.a{updateParameters(e){return this.ensureTechnique(ro,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return 0!==this._output&&7!==this._output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}class lo extends to.a{write(e,t,i,r){for(const n of this.vertexBufferLayout.fieldNames){const a=t.vertexAttributes.get(n),s=t.indices.get(n);if(a&&s)switch(n){case"position":{Object(Mn.a)(3===a.size);const t=i.getField(n,_i.u);t&&Object(Ft.e)(s,a.data,e.transformation,t,r);break}case"color":{Object(Mn.a)(3===a.size||4===a.size);const e=i.getField(n,_i.J);e&&Object(Ft.b)(s,a.data,a.size,e,r);break}case"uvMapSpace":{Object(Mn.a)(4===a.size);const e=i.getField(n,_i.C);e&&Object(Ft.a)(s,a.data,e,r);break}case"boundingRect":{Object(Mn.a)(9===a.size);const t=i.getField(n,_i.f);t&&this.writeBoundingRect(s,a.data,e.transformation,t,r);break}}}}writeBoundingRect(e,t,i,r,n){const a=i,s=r.typedBuffer,o=r.typedBufferStride,c=e.length;n*=o;for(let l=0;l<c;++l){const i=9*e[l],r=t[i],c=t[i+1],d=t[i+2];s[n]=a[0]*r+a[4]*c+a[8]*d+a[12],s[n+1]=a[1]*r+a[5]*c+a[9]*d+a[13],s[n+2]=a[2]*r+a[6]*c+a[10]*d+a[14];for(let e=3;e<9;++e)s[n+e]=t[i+e];n+=o}}}const ho={color:[1,1,1,1],writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,style:2,patternSpacing:10,lineWidth:1,draped:!0,...Mt.b};function uo(e,t,i){return function(e,t,i){return Object(n.l)(e)?"none"===e.style||"solid"===e.style?("none"===e.style&&(t.color=Object(ot.g)(0,0,0,0),t.transparent=!0),new eo.a(t)):(t.style=function(e){switch(e){case"horizontal":return 0;case"vertical":return 1;case"cross":return 2;case"forward-diagonal":return 3;case"backward-diagonal":return 4;case"diagonal-cross":return 5;default:return}}(e.style),t.draped=i.isDraped,new oo(t)):new eo.a(t)}(function(e){return e&&e.pattern||null}(e),t,i)}function po(e,t){if(function(e){return e.material instanceof oo&&!e.material.parameters.draped}(e)){const i=e.geometry.vertexAttributes,r=i.get("position").data,n=i.get("uvMapSpace").data,a=i.get("boundingRect").data;zs(_i.C.fromTypedArray(n),_i.v.fromTypedArray(r),t,_i.g.fromTypedArray(a))}}function fo(e,t,i,r){const n=Ne(e,t,i,r),a=e.stageObject.geometryRecords;for(let s=0;s<a.length;s++)po(a[s],r);return n}const bo=["polyline","polygon","extent"];class mo extends Ct{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}ensureMaterials(){this.ensureFillMaterial(),this.ensureOutlineMaterial()}ensureFillMaterial(){if(Object(n.l)(this._material))return;const e=Object(n.j)(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=uo(this.symbolLayer,{color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof oo,this._context.stage.add(this._material)}ensureOutlineMaterial(){const e=this.symbolLayer.outline;if(Object(n.l)(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;this._outlineMaterial=(t=>{const i=Object($r.b)(e.pattern);return new Yr.a({width:t,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:i,stippleScaleWithLineWidth:!0,cap:Object(Wr.d)(e.patternCap||"butt")})})(Object(Fe.g)(e.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(e){return Object(n.l)(e)&&e.size&&e.size>0&&Object(n.l)(e.color)&&(Object(n.k)(e.pattern)||"style"!==e.pattern.type||"none"!==e.pattern.style)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,bo,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new Ke.a);return this.ensureDrapedStatus("on-the-ground"===r.mode),this.ensureMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}layerOpacityChanged(){if(Object(n.l)(this._material)){const e=this._material.parameters.color,t=Object(n.j)(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t);this._material.setParameters({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(Object(n.l)(this._outlineMaterial)){const e=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=Object(Ve.e)(mo.elevationModeChangeTypes,i,r);if(n!==Ve.b.UPDATE)return n;const a=Object(Ve.h)(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){if(Object(n.l)(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),Object(n.l)(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,i){const r=Ai(e.geometry);if(Object(n.k)(r))return null;vo.renderData=Ri(r,this._context.elevationProvider,this._context.renderCoordsHelper,i),vo.color=t;const a=vo.renderData.position.length/3;if(this._needsUV&&(vo.uvMapSpace=new Float32Array(4*a),vo.boundingRect=new Float64Array(9*a)),vo.outNum=0,vo.outGeometries=[],vo.outTransforms=[],vo.outMaterials=[],this._createAs3DShapeFill(vo),this._hasOutline&&this._createAs3DShapeOutline(vo),this._logGeometryCreationWarnings(vo.renderData,r.rings,"rings","FillSymbol3DLayer"),0===vo.outNum)return null;this._needsUV&&zs(_i.C.fromTypedArray(vo.uvMapSpace),_i.v.fromTypedArray(vo.renderData.position),this._context.renderCoordsHelper,_i.g.fromTypedArray(vo.boundingRect));const s=new zi.a({geometries:vo.outGeometries,materials:vo.outMaterials,transformations:vo.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),o=new tt(this,s,vo.outGeometries,null,null,fo,i);return o.alignedSampledElevation=vo.renderData.sampledElevation,o.needsElevationUpdates=Object(Ve.h)(i.mode),o}_createAs3DShapeFill(e){const t=e.renderData.polygons;for(const{position:i,mapPosition:r,holeIndices:a,index:s,count:o}of t){if(Object(n.l)(this._context.clippingExtent)&&(Object(j.h)(go),Object(j.k)(go,r),!Object(j.r)(go,this._context.clippingExtent)))continue;const t=Object(Oi.a)(r,a,3);if(0===t.length)continue;const c=Ti({indices:new Uint32Array(t),attributeData:{position:i,color:e.color,mapPosition:r,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*s*e.uvMapSpace.BYTES_PER_ELEMENT,4*o):null,boundingRect:this._needsUV?new Float64Array(e.boundingRect.buffer,9*s*e.boundingRect.BYTES_PER_ELEMENT,9*o):null}});e.outGeometries.push(c),e.outMaterials.push(Object(n.t)(this._material)),e.outTransforms.push(v.a),e.outNum++}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{mapPosition:r,position:a}=t[i];if(Object(n.l)(this._context.clippingExtent)&&(Object(j.h)(go),Object(j.k)(go,r),!Object(j.r)(go,this._context.clippingExtent)))continue;const s=Object(Wr.a)({overlayInfo:null,removeDuplicateStartEnd:1,attributeData:{position:a,mapPosition:r}}),o=s.vertexAttributes.get("position");o.data===a&&(o.data=new Float64Array(a)),e.outGeometries.push(s),e.outMaterials.push(Object(n.t)(this._outlineMaterial)),e.outTransforms.push(v.a),e.outNum++}}_createAsOverlay(e,t){const i=Ai(e.geometry);if(Object(n.k)(i))return null;Object(n.t)(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,Object(n.l)(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),yo.renderData=Di(i,this._context.overlaySR),yo.color=t;const r=yo.renderData.position.length/3;return this._needsUV&&(yo.uvMapSpace=new Float32Array(4*r)),yo.outNum=0,yo.outGeometries=[],yo.outBoundingBox=Object(j.h)(),yo.layerUid=this._context.layer.uid,yo.graphicsUid=e.uid,this._createAsOverlayFill(yo),this._hasOutline&&this._createAsOverlayOutline(yo),this._logGeometryCreationWarnings(yo.renderData,i.rings,"rings","FillSymbol3DLayer"),0===yo.outNum?null:(this._needsUV&&function(e,t,i,r,n=1){if(i.isGeographic&&2!==r){const e=new Float64Array(t.typedBuffer.length),r=3*t.count,n=Object(f.e)(i);for(let i=0;i<r;i+=3)Object(x.i)(t.typedBuffer,i,e,i,n);t=_i.v.fromTypedArray(e)}Object(fi.s)(Ns,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let o=0;o<t.count;o++)t.getVec(o,Fs),Ns[0]=Math.min(Ns[0],Fs[0]),Ns[1]=Math.min(Ns[1],Fs[1]);const a=Ns[0]%n,s=Ns[1]%n;Hs[0]=Ns[0]-a,Hs[1]=Ns[1]-s;for(let o=0;o<t.count;o++)t.getVec(o,Fs),e.setValues(o,(Fs[0]-Hs[0])/n,(Fs[1]-Hs[1])/n,Hs[0]/n,Hs[1]/n)}(_i.C.fromTypedArray(yo.uvMapSpace),_i.v.fromTypedArray(yo.renderData.position),this._context.overlaySR,this._context.layerView.view.state.viewingMode),yo.outNum>0?new or(this,yo.outGeometries,yo.outBoundingBox):null)}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:r,index:a,count:s}of t){if(Object(j.h)(go),Object(j.k)(go,i),!Object(j.r)(go,this._context.clippingExtent))continue;const t=Object(Oi.a)(i,r,3);if(0===t.length)continue;Object(j.j)(e.outBoundingBox,go);const o=Ti({indices:new Uint32Array(t),attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*a*e.uvMapSpace.BYTES_PER_ELEMENT,4*s):null}}),c=new Dr.a(o,Object(n.t)(this._material),e.layerUid,e.graphicsUid),l=go;Object(rr.l)(c.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),e.outGeometries.push(c),e.outNum++}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if(Object(j.h)(go),Object(j.k)(go,r),!Object(j.r)(go,this._context.clippingExtent))continue;Object(j.j)(e.outBoundingBox,go);const a=Object(Wr.a)({overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:1,attributeData:{position:r}}),s=new Dr.a(a,Object(n.t)(this._outlineMaterial),e.layerUid,e.graphicsUid),o=go;Object(rr.l)(s.boundingSphere,.5*(o[0]+o[3]),.5*(o[1]+o[4]),0,.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1]))),e.outGeometries.push(s),e.outNum++}}_getOutlineOpacity(){const e=Object(n.j)(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(Object(n.l)(e)?e.a:0)}_getOutlineColor(){const e=Object(n.j)(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return Object(Ge.g)(Object(n.l)(e)?Le.a.toUnitRGB(e):null,t)}get test(){return{createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}mo.elevationModeChangeTypes={definedChanged:Ve.b.RECREATE,staysOnTheGround:Ve.b.NONE,onTheGroundChanged:Ve.b.RECREATE};const go=Object(j.f)(),vo={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},yo={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};class Oo{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.fillStyle=this.colorToRGBA(e.color),this.haloStyle=this.colorToRGB(e.halo.color)}colorToRGB(e){return`rgb(${e.slice(0,3).map((e=>Math.floor(255*e))).toString()})`}colorToRGBA(e){return`rgba(${e.slice(0,3).map((e=>Math.floor(255*e))).toString()},${e[3]})`}static fromSymbol(e,t=1){const i=Object(n.j)(e,"material","color"),r=Object(n.l)(i)?Le.a.toUnitRGBA(i):ot.b,a=e.halo,s=null!=e.size?Object(Fe.g)(e.size):12,o={family:e.font&&e.font.family?e.font.family:"sans-serif",weight:e.font&&e.font.weight?e.font.weight:"normal",style:e.font&&e.font.style?e.font.style:"normal"},c=Object(n.l)(a)&&Object(n.l)(a.color)&&a.size>0?{size:Object(Fe.g)(a.size),color:Le.a.toUnitRGBA(a.color)}:{size:0,color:ot.b};return new Oo({size:s,color:r,font:o,halo:c,pixelRatio:t})}}var xo=i(601);class jo{constructor(e,t,i=2048){this.text=e,this._parameters=t,this.maxSize=i,this._lineWidths=new Array,this._renderPixelRatio=null,this._displayWidth=null,this.key=`${this._parameters.key}--${e}`,this._lines=e.split(/\r?\n/),this._lineHeight=this.computeLineHeight()}get displayWidth(){return this._ensureTextWidth()}get displayHeight(){return this._lineHeight*this._lines.length}get renderedWidth(){return Math.round(this.displayWidth*this.renderPixelRatio)}get renderedHeight(){return Math.round(this.displayHeight*this.renderPixelRatio)}get renderedLineHeight(){return Math.round(this._lineHeight*this.renderPixelRatio)}get renderedFontSize(){return this._parameters.definition.size*this.renderPixelRatio}get renderedHaloSize(){return this._parameters.haloSize*this.renderPixelRatio}get renderPixelRatio(){if(Object(n.k)(this._renderPixelRatio)){const e=this._parameters.definition.pixelRatio;this.maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this.maxSize/(this.displayWidth*e),this.maxSize/(this.displayHeight*e))):this._renderPixelRatio=e}return this._renderPixelRatio}getLineXOffset(e){return Math.round((this.renderedWidth-this._lineWidths[e]*this.renderPixelRatio)/2)}render(e,t=0,i=0){const r=this.renderedLineHeight,n=this.renderedHaloSize,a=function(e,t){return"center"===e?.5*t:"right"===e?t:0}(e.textAlign,this.renderedWidth)+n,s=n+_o;e.save(),n>0&&this.renderHalo(e,a,s,t,i),this.setFontProperties(e,this.renderedFontSize),i+=s,t+=a;for(let o=0;o<this._lines.length;++o){e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)";const n=this._lines[o],a=this.getLineXOffset(o);e.fillText(n,t+a,i),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.fillStyle,e.fillText(n,t+this.getLineXOffset(o),i),i+=r}e.restore()}renderHalo(e,t,i,r,n){const a=this.renderedWidth,s=this.renderedHeight,o=wo(Co,Math.max(a,Po),Math.max(s,Po)),c=o.getContext("2d");c.clearRect(0,0,a,s),this.setFontProperties(c,this.renderedFontSize),c.fillStyle=this._parameters.haloStyle,c.strokeStyle=this._parameters.haloStyle;const l=this.renderedHaloSize<3;c.lineJoin=l?"miter":"round",l?this.renderHaloEmulated(c,t,i):this.renderHaloNative(c,t,i),e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(o,0,0,a,s,r,n,a,s),e.globalAlpha=1}renderHaloEmulated(e,t,i){const r=this.renderedLineHeight,n=this.renderedHaloSize;for(let a=0;a<this._lines.length;++a){const s=this._lines[a],o=this.getLineXOffset(a);for(const[r,a]of So)e.fillText(s,t+o+n*r,i+n*a);i+=r}}renderHaloNative(e,t,i){const r=this.renderedLineHeight,n=this.renderedHaloSize;for(let a=0;a<this._lines.length;++a){const s=2*n,o=this._lines[a],c=this.getLineXOffset(a),l=5,d=.1;for(let r=0;r<l;r++){const n=1-(l-1)*d+r*d;e.lineWidth=n*s,e.strokeText(o,t+c,i)}i+=r}}setFontProperties(e,t){const i=this._parameters.definition.font,r=`${i.style} ${i.weight} ${t}px ${i.family}, sans-serif`;e.font=r,e.textAlign="left",e.textBaseline="top"}_ensureTextWidth(){if(Object(n.l)(this._displayWidth))return this._displayWidth;const e=wo(Co,Po,Po).getContext("2d");this.setFontProperties(e,this._parameters.definition.size);let t=0,i=2*this._parameters.haloSize;this._lineWidths.length=0;const r=this._parameters.definition.font;("italic"===r.style||"oblique"===r.style||"string"==typeof r.weight&&("bold"===r.weight||"bolder"===r.weight)||"number"==typeof r.weight&&r.weight>600)&&(i+=.3*e.measureText("A").width);for(const n of this._lines){const r=Math.round(e.measureText(n).width+i);this._lineWidths.push(r),t=Math.max(t,r)}return this._displayWidth=t,this._displayWidth}computeLineHeight(){const e=1.275*this._parameters.definition.size;return Math.ceil(e+2*this._parameters.haloSize)+_o}}const _o=1,So=[];{const e=16;for(let t=0;t<360;t+=360/e)So.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}function wo(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}const Co={canvas:null},Po=512;var To=i(209),Eo=i(583);class Ao extends xo.a{constructor(e,t,i){super(),this.type=4,this._glTexture=null,this.events=new we.a,this._requiresPowerOfTwo=!Object(Eo.a)(e.gl),this._renderer=new jo(t,i)}get width(){return this._renderer.renderedWidth}get height(){return this._renderer.renderedHeight}get textureWidth(){const e=this.width;return this._requiresPowerOfTwo?Object(m.l)(e):e}get textureHeight(){const e=this.height;return this._requiresPowerOfTwo?Object(m.l)(e):e}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}get texcoordScale(){return[this._renderer.renderedWidth/this.textureWidth,this._renderer.renderedHeight/this.textureHeight]}get requiresFrameUpdates(){return!1}createDescriptor(e){return{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(e){if(Object(n.l)(this._glTexture))return this._glTexture;const t=wo(Ro,this.textureWidth,this.textureHeight),i=t.getContext("2d");return i.save(),this._renderer.render(i,0,this.textureHeight-this._renderer.renderedHeight),this._glTexture=new To.a(e,this.createDescriptor(e),t),i.restore(),this._glTexture}unload(){Object(n.l)(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),this.events.emit("unloaded")}}const Ro={canvas:null},Do=[0,0,1];function Mo(e,t,i){e&&e.forEach((e=>{const r=t(e);Object(n.l)(r)&&i(r,e.graphic)}))}const Io={mode:"relative-to-ground",offset:0},zo={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],anchor:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawBorder:!1,displayWidth:0,displayHeight:0};var Lo=i(114),Fo=i(1059),Vo=i(1040);const Go=["polyline","polygon","extent"];class Uo extends Ct{constructor(e,t,i,r){super(e,t,i,r)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Go,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new Ke.a);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,i,t.uid)}ensureMaterial(){if(Object(n.l)(this._material))return;const e={...Vo.a},t=this.symbolLayer.color;Object(n.l)(t)&&(e.color=Le.a.toUnitRGBA(t));const i=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=Object(n.l)(this.symbolLayer.waveDirection)?Uo.headingVectorFromAngle(this.symbolLayer.waveDirection):Object(P.e)(0,0);const r=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,a=Vo.b[r];e.waveStrength=a.waveStrength,e.waveTextureRepeat=a.textureRepeat,e.waveVelocity=a.waveVelocity,e.flowStrength=a.perturbationStrength,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new Fo.a(e),this._context.stage.add(this._material)}layerOpacityChanged(){if(Object(n.k)(this._material))return!0;const e=this._material.parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),i=t<1||this.needsDrivenTransparentPass;return this._material.setParameters({color:[e[0],e[1],e[2],t],transparent:i}),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=Object(Ve.e)(Uo.elevationModeChangeTypes,i,r);if(n!==Ve.b.UPDATE)return n;const a=Object(Ve.h)(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>a))}slicePlaneEnabledChanged(){return Object(n.l)(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,i){const r=Ai(e.geometry);if(Object(n.k)(r))return null;qo.renderData=Ri(r,this._context.elevationProvider,this._context.renderCoordsHelper,t);const a=qo.renderData.position.length/3;if(qo.uvCoords=new Float64Array(2*a),qo.outNum=0,qo.outGeometries=[],qo.outTransforms=[],qo.outMaterials=[],this._create3DShapeGeometries(qo),this._logGeometryCreationWarnings(qo.renderData,r.rings,"rings","WaterSymbol3DLayer"),0===qo.outNum)return null;this._createUVCoordsFromVertices(qo.uvCoords,qo.renderData.mapPosition,a,this._context.elevationProvider.spatialReference);const s=new zi.a({geometries:qo.outGeometries,materials:qo.outMaterials,transformations:qo.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),o=new tt(this,s,qo.outGeometries,null,null,Ne,t);return o.alignedSampledElevation=qo.renderData.sampledElevation,o.needsElevationUpdates=Object(Ve.h)(t.mode),o}_createUVCoordsFromVertices(e,t,i,r){const n=Object(Lo.e)(r);Object(_.m)(No);for(let o=0;o<i;o++)Object(fi.s)(ko,t[3*o+0],t[3*o+1]),Object(_.o)(No,ko);Object(rr.b)(No,No,n);const a=No[0]%Uo.unitSizeOfTexture,s=No[1]%Uo.unitSizeOfTexture;Bo[0]=No[0]-a,Bo[1]=No[1]-s;for(let o=0;o<i;o++)e[2*o+0]=(t[3*o+0]*n-Bo[0])/Uo.unitSizeOfTexture,e[2*o+1]=(t[3*o+1]*n-Bo[1])/Uo.unitSizeOfTexture}_create3DShapeGeometries(e){const t=e.renderData.polygons,i=e.uvCoords;for(const{count:r,index:a,position:s,mapPosition:o,holeIndices:c}of t){if(Object(n.l)(this._context.clippingExtent)&&(Object(j.h)(Ho),Object(j.k)(Ho,o),!Object(j.r)(Ho,this._context.clippingExtent)))continue;const t=Object(Oi.a)(o,c,3);if(0===t.length)continue;const l=Ei({indices:new Uint32Array(t),attributeData:{position:s,uv0:new Float64Array(i.buffer,2*a*i.BYTES_PER_ELEMENT,2*r),mapPosition:o}});e.outGeometries.push(l),e.outMaterials.push(Object(n.t)(this._material)),e.outTransforms.push(v.a),e.outNum++}}_createAsOverlay(e){const t=Ai(e.geometry);if(Object(n.k)(t))return null;Object(n.t)(this._material).renderPriority=this._renderPriority,Wo.renderData=Di(t,this._context.overlaySR);const i=Wo.renderData.position.length/3;return Wo.uvCoords=new Float64Array(2*i),Wo.outNum=0,Wo.outGeometries=[],Wo.outBoundingBox=Object(j.h)(),Wo.layerUid=this._context.layer.uid,Wo.graphicsUid=e.uid,this._createAsOverlayWater(Wo),this._logGeometryCreationWarnings(Wo.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===Wo.outNum?null:(this._createUVCoordsFromVertices(Wo.uvCoords,Wo.renderData.position,i,this._context.overlaySR),Wo.outNum>0?new or(this,Wo.outGeometries,Wo.outBoundingBox):null)}_createAsOverlayWater(e){const t=e.uvCoords,i=e.renderData.polygons;for(const{position:r,holeIndices:a,index:s,count:o}of i){if(Object(j.h)(Ho),Object(j.k)(Ho,r),!Object(j.r)(Ho,this._context.clippingExtent))continue;Object(j.j)(e.outBoundingBox,Ho);const i=Object(Oi.a)(r,a,3);if(0===i.length)continue;const c=Ei({indices:new Uint32Array(i),attributeData:{position:r,uv0:new Float64Array(t.buffer,2*s*t.BYTES_PER_ELEMENT,2*o)}}),l=new Dr.a(c,Object(n.t)(this._material),e.layerUid,e.graphicsUid),d=Ho;Object(rr.l)(l.boundingSphere,.5*(d[0]+d[3]),.5*(d[1]+d[4]),0,.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1]))),e.outGeometries.push(l),e.outNum++}}static headingVectorFromAngle(e){const t=Object(P.a)(),i=Object(xa.d)(e);return t[0]=Math.sin(i),t[1]=Math.cos(i),t}get test(){return{create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}Uo.unitSizeOfTexture=100,Uo.elevationModeChangeTypes={definedChanged:Ve.b.RECREATE,staysOnTheGround:Ve.b.NONE,onTheGroundChanged:Ve.b.RECREATE};const Bo=Object(P.a)(),No=Object(_.l)(),ko=Object(P.a)(),Ho=Object(j.f)(),qo={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Wo={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},$o=ie.a.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory");function Yo(e,t,i,r){const n=Xo[e.type]&&Xo[e.type][t.type]||Zo[t.type];return n?new n(e,t,i,r):($o.error("GraphicsLayerFactory#make",`unknown symbol type ${t.type}`),null)}const Zo={icon:Nr,object:class extends Ct{constructor(e,t,i,r){super(e,t,i,r),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=i.physicalBasedRenderingEnabled}getCachedSize(){const[e,t,i]=Object(n.l)(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:i}}async doLoad(e){if(!this._drivenProperties.size&&Object(Ge.j)(this.symbolLayer))throw new Error;const t=this.symbolLayer;if(this.isPrimitive){const i=t.resource?t.resource.primitive:lt.b;this._resources=await this._createResourcesForPrimitive(i,e)}else this._resources=await this._createResourcesForUrl(t.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return Object(n.l)(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return Object(n.j)(this._resources,"lodRenderer")}setMaterialTransparencyParams(e,t=Object(n.j)(this.symbolLayer,"material","color")){const i=this._getCombinedOpacity(t),r=i<1||this.needsDrivenTransparentPass;return e.transparent=r,e.opacity=i,e.cullFace=r?0:2,e}async _createResourcesForPrimitive(e,t){if(!function(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}(e))throw new Error(`Unknown object symbol primitive: ${e}`);const i=this.symbolLayer,r=Object(j.f)(Object(gn.c)(e)),a=Object(O.g)(Object(j.z)(r)),s=Object(O.g)(Object(gn.d)(a,i)),o=Object(y.p)(s),c={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:O.a,diffuse:O.a,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},l=c.usePBR;this.setMaterialTransparencyParams(c);const d=this.symbol;if("point-3d"===d.type&&d.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=d.verticalOffset;c.verticalOffset={screenLength:Object(Fe.g)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},c.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(c.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)c.externalColor=ot.a;else{const e=Object(n.l)(i.material)&&i.material.color,t=Object(n.l)(e)?Le.a.toUnitRGBA(e):ot.a;c.externalColor=t}this._fastUpdates=wr(this._context.renderer,this._fastVisualVariableConvertOptions(r,s,a,n.p)),this._fastUpdates.enabled?(Object.assign(c,this._fastUpdates.materialParameters),c.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(c.instanced.push("color"),this._optionalFields.push("color"));const h=ht(e,new Li.a(c));if(!h)throw new Error(`Unknown object symbol primitive: ${e}`);const u=mt(h).map((e=>({opacity:1,transparent:e.parameters.transparent}))),p=await this._createStageResources(h,l);return{lodResources:h,lodRenderer:await this._createLodRenderer(h,t),stageResources:p,symbolSize:s,extentPadding:o,isEsriSymbolResource:!1,isWosr:!1,originalMaterialParameters:u,physicalBasedRenderingEnabled:l,resourceBoundingBox:r,resourceSize:a,dispose:n.p,pivotOffset:n.p}}async _createResourcesForUrl(e,t){const i=["transformation"],r={materialParamsMixin:{instanced:i,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=wr(this._context.renderer,this._fastVisualVariableConvertOptions(n.p,n.p,n.p,n.p)),this._fastUpdates.enabled?(Object.assign(r.materialParamsMixin,this._fastUpdates.materialParameters),i.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(i.push("color"),this._optionalFields.push("color"));const a=this.symbol;if("point-3d"===a.type&&a.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=a.verticalOffset;r.materialParamsMixin.verticalOffset={screenLength:Object(Fe.g)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},r.materialParamsMixin.castShadows=!1}r.signal=t,r.usePBR=this._context.physicalBasedRenderingEnabled;const s=r.usePBR,o=await Object(En.fetch)(e,r),c=o.isEsriSymbolResource,l=o.isWosr,d=o.remove,h=function(e){return{levels:e.map((e=>function(e){const t=[];return e.stageResources.geometries.forEach(((i,r)=>{const n=e.stageResources.materials[r],a=e.stageResources.textures;t.push({material:n,geometry:i,textures:a})})),{components:t,minScreenSpaceRadius:e.lodThreshold,pivotOffset:e.pivotOffset}}(e)))}}(o.lods);(function(e){e.levels.forEach((e=>{e.minScreenSpaceRadius||(e.minScreenSpaceRadius=wn(e))}))})(h),h.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),h.levels[0].minScreenSpaceRadius=Math.min(2,h.levels[0].minScreenSpaceRadius);const u=this._context,p=this.symbolLayer.material,f=this._getExternalColorParameters(p),b=Object(n.j)(this.symbolLayer,"material","color"),m=this._getCombinedOpacity(b,{hasIntrinsicColor:!0}),g=this.needsDrivenTransparentPass,v=mt(h),x=mt(h).map((e=>({opacity:e.parameters.opacity||1,transparent:e.parameters.transparent})));v.forEach((e=>{const t=e.parameters;e.setParameters(f);const i=t.opacity*m,r=i<1||g||t.transparent;e.setParameters({opacity:i,transparent:r}),u.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:u.sharedResources.screenSizePerspectiveSettings})}));const _=o.referenceBoundingBox,S=Object(O.g)(Object(j.z)(_)),w=Object(O.g)(h.levels[0].pivotOffset),C=Object(O.g)(Object(gn.d)(S,this.symbolLayer)),P=Object(y.p)(C);Cr(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(_,C,S,w))&&v.forEach((e=>e.setParameters(this._fastUpdates.materialParameters)));const T=await this._createStageResources(h,s);return{lodResources:h,lodRenderer:await this._createLodRenderer(h,t),stageResources:T,symbolSize:C,extentPadding:P,isEsriSymbolResource:c,isWosr:l,originalMaterialParameters:x,physicalBasedRenderingEnabled:s,resourceBoundingBox:_,resourceSize:S,dispose:d,pivotOffset:w}}async _createStageResources(e,t){const i=this._context.stage,r=mt(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),i.addMany(r);const n=function(e){const t=new Array;return e.levels.forEach((e=>{e.components.forEach((e=>{e.textures&&t.push(...e.textures)}))})),Object(o.k)(t)}(e);i.addMany(n),await i.load(n);const a=function(e){const t=[];return e.levels.forEach((e=>{e.components.forEach((e=>{t.push(e.geometry)}))})),Object(o.k)(t)}(e);return i.addMany(a),{materials:r,textures:n,geometries:a}}async _createLodRenderer(e,t){const i=this._context.stage,r={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},n=this._fastUpdates.enabled?{applyTransform:(e,t,i)=>{e.getFeatureAttribute(t,ya),Object(g.d)(i,Ar(this._fastUpdates.materialParameters,ya,i))},scaleFactor:(e,t,i)=>(t.getFeatureAttribute(i,ya),Rr(e,this._fastUpdates.materialParameters,ya))}:null,a=new ca(e,this._optionalFields,r,n);return a.slicePlaneEnabled=this._context.slicePlaneEnabled,await i.addRenderPlugin(a.slots,a,t),a}_getExternalColorParameters(e){const t={};return this._drivenProperties.color?t.externalColor=ot.a:Object(n.l)(e)&&Object(n.l)(e.color)?t.externalColor=Le.a.toUnitRGBA(e.color):(t.externalColor=ot.a,t.colorMixMode="ignore"),t}destroy(){if(super.destroy(),Object(n.l)(this._resources)){const e=this._context.stage;e.removeRenderPlugin(this._resources.lodRenderer);const t=this._resources.stageResources;e.removeMany(t.materials),e.removeMany(t.textures),e.removeMany(t.geometries),Object(n.l)(this._resources.dispose)&&this._resources.dispose(),this._resources=null}}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const i=Object(Rt.d)(t.geometry);if(Object(n.k)(i))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const r=this.setGraphicElevationContext(t,new Ke.a),a=e.renderingInfo;return this._createAs3DShape(t,i,a,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(Object(n.k)(this._resources))return!0;const e=this._drivenProperties.opacity,t=!this.isPrimitive,i=this._resources.stageResources.materials,r=this._resources.originalMaterialParameters;for(let a=0;a<i.length;a++){const s=i[a],o=Object(n.j)(this.symbolLayer,"material","color"),c=r[a],l=this._getCombinedOpacity(o,{hasIntrinsicColor:t})*c.opacity,d=l<1||e||c.transparent;s.setParameters({opacity:l,transparent:d}),this.isPrimitive&&s.setParameters({cullFace:d?0:2})}return!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Ve.i)}slicePlaneEnabledChanged(){if(Object(n.k)(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(Object(n.k)(this._resources))return!0;const{stageResources:e,isWosr:t}=this._resources;for(const i of e.materials)this.isPrimitive?i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this.hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}applyRendererDiff(e,t){if(Object(n.k)(this._resources))return 0;const{stageResources:{materials:i},lodRenderer:r,resourceBoundingBox:a,symbolSize:s,resourceSize:o,pivotOffset:c}=this._resources;for(const n in e.diff){if("visualVariables"!==n)return 0;if(!Cr(this._fastUpdates,t,this._fastVisualVariableConvertOptions(a,s,o,c)))return 0;for(const e of i)e.setParameters(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged()}return 2}computeComplexity(){return Object(n.k)(this._resources)?super.computeComplexity():{primitivesPerFeature:gt(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.indices.get("position").length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:jt(this.symbol,this.symbolLayer)}}hasLodRenderer(){return Object(n.l)(this._resources)}_createAs3DShape(e,t,i,r,a){if(!this.hasLodRenderer()||Object(n.k)(this._resources))return null;const s=this.getFastUpdateAttrValues(e),o=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?Object(Ge.g)(i.color,i.opacity):null,c=this._context.clippingExtent;if(Object(x.o)(t,ma,this._context.elevationProvider.spatialReference),Object(n.l)(c)&&!Object(j.e)(c,ma))return null;const l=this._requiresTerrainElevation(r),d=this._computeGlobalTransform(t,r,va,Oa),h=this._computeLocalTransform(this._resources,this.symbolLayer,i,ga),u=this._resources.lodRenderer.instanceData,p=u.addInstance();this._instanceIndexToGraphicUid.set(p,a),u.setLocalTransform(p,h,!1),u.setGlobalTransform(p,d),s&&u.setFeatureAttribute(p,s),o&&u.setColor(p,o);const f=new yn(this,p,qe,r);return l&&(f.alignedSampledElevation=Oa.sampledElevation),f.needsElevationUpdates=Object(Ve.i)(r.mode),Object(Rt.b)(f,t,this._context.elevationProvider),f}_computeGlobalTransform(e,t,i,r){return Object(Ve.g)(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r),ma[0]=e.x,ma[1]=e.y,ma[2]=r.z,Object(x.d)(e.spatialReference,ma,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(e,t,i,r){return Object(g.j)(r),this._applyObjectRotation(i,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,i,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,n=Object(Ge.c)(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===n[0]&&1===n[1]&&1===n[2]||Object(g.g)(i,i,n)}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(Object(n.k)(this._resources))return!0;const i=t&&Object(Rt.d)(t);if(Object(n.k)(i))return!1;const r=this.getGeometryElevationMode(t);return e.elevationContext.mode===r&&(this._computeGlobalTransform(i,e.elevationContext,va,Oa),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=Oa.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,va,!0),Object(Rt.b)(e,i,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(Object(n.k)(this._resources))return;const i=(e,t,i)=>Object(n.u)(null!=e&&"complete"===e.type?e.newValue:t,i),r=i(t.heading,this.symbolLayer.heading,0),a=i(t.tilt,this.symbolLayer.tilt,0),s=i(t.roll,this.symbolLayer.roll,0),o=i(t.width,this.symbolLayer.width,void 0),c=i(t.height,this.symbolLayer.height,void 0),l=i(t.depth,this.symbolLayer.depth,void 0),d=i(t.anchor,this.symbolLayer.anchor,void 0),h=i(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const u={heading:r,tilt:a,roll:s,anchor:d,anchorPosition:h},p=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push((()=>{p.symbolSize=Object(O.g)(Object(gn.d)(p.resourceSize,{width:o,height:c,depth:l,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const i=this._computeLocalTransform(p,u,t,ga),r=e.instanceIndex;p.lodRenderer.instanceData.setLocalTransform(r,i,!0)}))}_preparePatchColor(e,t){if(!t.material||"partial"!==t.material.type)return;const i=t.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const r=i.color.newValue,a=Object(n.l)(r)?Le.a.toUnitRGBA(r):ot.a;delete i.color;const s=this._resources;Object(n.k)(s)||e.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(s.lodRenderer.instanceData.setColor(e.instanceIndex,a),t=this.setMaterialTransparencyParams({},r)):t=this.setMaterialTransparencyParams({externalColor:a},r);for(const i of s.stageResources.materials)i.setParameters(t)}))}_requiresTerrainElevation(e){return"absolute-height"!==e.mode}_applyObjectRotation(e,t,i){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return Object(Ge.b)(e.heading,e.tilt,e.roll,i)}_computeAnchor(e,t,i){const r=Object(O.f)();switch(i.anchor){case"center":Object(y.k)(r,Object(j.d)(e)),Object(y.s)(r,r);break;case"top":{const t=Object(j.d)(e);Object(y.w)(r,-t[0],-t[1],-e[5]);break}case"bottom":{const t=Object(j.d)(e);Object(y.w)(r,-t[0],-t[1],-e[2]);break}case"relative":{const t=Object(j.d)(e),n=Object(j.z)(e),a=i.anchorPosition,s=a?Object(O.h)(a.x,a.y,a.z):O.c;Object(y.a)(r,n,s),Object(y.f)(r,r,t),Object(y.s)(r,r);break}default:Object(n.l)(t)?Object(y.s)(r,t):Object(y.k)(r,O.c)}return r}_applyAnchor(e,t,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&Object(g.b)(i,i,r)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,t,i,r){const a=Object(n.l)(e)?Object(O.g)(Object(j.z)(e)):O.a,s=Object(n.l)(e)?this._computeAnchor(e,r,this.symbolLayer):O.c,o=this._context.renderCoordsHelper.unitInMeters,c=Object(Ge.c)(Object(n.l)(t)?t:void 0,t,i,o),l=Object(O.h)(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:a,symbolSize:Object(n.l)(t)?t:O.a,unitInMeters:o,transformation:{anchor:s,scale:c,rotation:l}}}},line:Xr,path:class extends Ct{constructor(e,t,i,r){super(e,t,i,r),this._intrinsicSize=Object(P.e)(1,1),this.upVectorAlignment="path",this.stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const e=Object(n.l)(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height,t=Object(n.l)(this.symbolLayer.height)?this.symbolLayer.height:e;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,t],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=wr(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const i=this.symbolLayer.anchor||"center";this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");const r=this.symbolLayer.profile||"circle";if("quad"===r)this._profile=za.rect();else this._profile=za.circle(Is);let a=[0,0];switch("center"!==i&&(a={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[i],this._profile.translate(a[0],a[1])),this.symbolLayer.join||"simple"){case"round":this._extruder=new Va(0,Ds);break;case"bevel":this._extruder=new Va(0,1);break;case"miter":this._extruder=new Va(.8*Math.PI,1);break;default:this._extruder=new Fa}const s=this.symbolLayer.cap||"butt";switch(s){case"none":this._startCap=new Ba,this._endCap=new Ba;break;default:this._startCap=new Na(this._profile,0),this._endCap=new Na(this._profile,0,!0);break;case"square":this._startCap=new Na(this._profile,-.5),this._endCap=new Na(this._profile,.5,!0);break;case"round":{const e="quad"===r;this._startCap=new ka({profile:this._profile,flip:!1,breakNormals:e,subdivisions:Ms}),this._endCap=new ka({profile:this._profile,flip:!0,breakNormals:e,subdivisions:Ms});break}}const o=Object(n.j)(this.symbolLayer,"material","color"),c=this._getCombinedOpacityAndColor(o),l=Object(O.g)(c),d=c[3],h=d<1||this.needsDrivenTransparentPass,u={diffuse:l,ambient:l,opacity:d,transparent:h,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:h||"none"===s?0:2,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(Object(fi.s)(this._intrinsicSize,e,t),!Object(Ge.f)(this._intrinsicSize[0])||!Object(Ge.f)(this._intrinsicSize[1])))throw new te.a("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||Object(fi.g)(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(Object.assign(u,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new gs(u)):(u.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new Li.a(u)),this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,xs,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new Ke.a),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}layerOpacityChanged(){const e=Object(n.j)(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),i=t<1||this.needsDrivenTransparentPass;return this._material.setParameters({opacity:t,transparent:i}),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Ve.i)}slicePlaneEnabledChanged(){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return 0;if(!Cr(this._fastUpdates,t,this._vvConvertOptions))return 0;this._material.setParameters(this._fastUpdates.materialParameters)}return 2}getVertexData(e){let t=0;const i=e.paths,r=[],n=e.spatialReference,a=this._context.elevationProvider.spatialReference,s=this._context.renderCoordsHelper.spatialReference;for(const u of i)t+=u.length;const o=new Float64Array(3*t),c=new Float64Array(3*t),l=new Float64Array(3*t);let d=0;for(const u of i){r.push({index:d,numVertices:u.length});for(const t of u)o[d++]=t[0],o[d++]=t[1],o[d++]=e.hasZ?t[2]:0}let h=!0;return n.equals(a)?this._copyVertices(o,0,c,0,t):h=Object(x.l)(o,n,0,c,a,0,t),a.equals(s)?this._copyVertices(c,0,l,0,t):Object(x.l)(c,a,0,l,s,0,t),{pathVertexDataInfos:r,vertexDataGS:o,vertexDataES:c,vertexDataRS:l,projectionSuccess:h,terrainElevation:0}}_copyVertices(e,t,i,r,n){t*=3,r*=3;for(let a=0;a<n;++a)i[r++]=e[t++],i[r++]=e[t++],i[r++]=e[t++]}_createAs3DShape(e,t,i,r){const a=e.geometry,s=new Array,o=new Array,c=new Array,l=a.spatialReference,d=Object(j.f)(),h=this._context.renderCoordsHelper;Ps.spatialReference=l;const u=this.getVertexData(a);if(!u.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(u.pathVertexDataInfos.length>0){for(let r=0;r<u.pathVertexDataInfos.length;++r){const a=u.pathVertexDataInfos[r],p=a.index,f=a.numVertices;if(f<2)continue;if(Object(n.l)(this._context.clippingExtent)&&(Object(j.h)(d),Object(j.k)(d,u.vertexDataES,3*p,f),!Object(j.r)(d,this._context.clippingExtent)))continue;const b=[];for(let e=p;e<p+3*f;){const t=e++,r=e++,n=e++,a=new Ia;Object(y.w)(a.posGS,u.vertexDataGS[t],u.vertexDataGS[r],u.vertexDataGS[n]),Object(y.w)(a.posES,u.vertexDataES[t],u.vertexDataES[r],u.vertexDataES[n]);const s=Object(Ve.f)(a.posES,this._context.elevationProvider,i,h);Object(y.w)(Ts,u.vertexDataRS[t],u.vertexDataRS[r],u.vertexDataRS[n]),h.setAltitude(Ts,s),Object(y.w)(a.pos,Ts[0],Ts[1],Ts[2]),b.push(a)}const m=new La(b);js(m,this.upVectorAlignment,this._context.renderCoordsHelper);const g=new Ha(m,this._profile,this._extruder,this._startCap,this._endCap);let v=null;if(this._fastUpdates.enabled){const t=this._fastUpdates.visualVariables,i=t.size?Pt(t.size.field,e):0,r=t.color?Pt(t.color.field,e):0,n=t.opacity?Pt(t.opacity.field,e):0;v=new $a(g,i,r,n)}else{const e=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(e[0]*=_s(t.size[0],"symbol-value"===t.size[2]?this.symbolLayer.height||0:t.size[2],this.symbolLayer.width||0),e[1]*=_s(t.size[2],"symbol-value"===t.size[0]?this.symbolLayer.width||0:t.size[0],this.symbolLayer.height||0));let i=null;this._drivenProperties.color&&(i=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(i=i?[i[0],i[1],i[2],t.opacity]:[1,1,1,t.opacity]);const r=new Wa(g);r.bake(e),i&&r.bakeVertexColors(i),v=r}const{vertexAttributes:O,indices:x}=v.createGeometryData(),_=new Ta(O,x,v,l,this.upVectorAlignment,this.stencilWidth);s.push(_),o.push(this._material),c.push(v.xform)}if(s.length>0){const e={layerUid:this._context.layer.uid,graphicUid:r},t=new zi.a({geometries:s,materials:o,transformations:c,metadata:e}),n=new tt(this,t,s,null,null,ws,i);return n.alignedSampledElevation=u.terrainElevation,n.needsElevationUpdates=Object(Ve.i)(i.mode),n}}else 0!==a.paths.length&&a.paths.some((e=>e.length>0))||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}},fill:mo,extrude:class extends Ct{constructor(e,t,i,r){super(e,t,i,r),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=Object(Ge.j)(this._getSymbolSize());if(e)throw new te.a("graphics3dextrudesymbollayer:invalid-size",e)}const e=Object(n.j)(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e),i=Object(O.g)(t),r=t[3],a=r<1||this.needsDrivenTransparentPass,s={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:r,transparent:a,cullFace:a?0:2,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new Li.a(s),this._bottomMaterial=new Li.a({...s,cullFace:2}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Fi,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new Ke.a);return this._createAs3DShape(t,e.renderingInfo,i,r,t.uid)}layerOpacityChanged(e,t){const i=Object(n.j)(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i),a=r<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:r,transparent:a}),this._bottomMaterial.setParameters({opacity:r,transparent:a});const s=this._getLayerOpacity();return e.forEach((e=>{const i=t(e);Object(n.l)(i)&&i.layerOpacityChanged(s,this._context.isAsync)})),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Ve.i)}slicePlaneEnabledChanged(e,t){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach((e=>{const i=t(e);Object(n.l)(i)&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}_getExtrusionSize(e){let t;var i;return t=e.size&&this._drivenProperties.size?null!=(i=function(e,t=0){const i=e[t];return"number"==typeof i&&isFinite(i)?i:null}(e.size,2))?i:0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}applyRendererDiff(){return 1}_getSymbolSize(){var e;return null!=(e=this.symbolLayer.size)?e:1}_createAs3DShape(e,t,i,r,a){const s=Ai(e.geometry);if(Object(n.k)(s))return null;const o=Ri(s,this._context.elevationProvider,this._context.renderCoordsHelper,r);if(this._logGeometryCreationWarnings(o,s.rings,"rings","ExtrudeSymbol3DLayer"),0===s.rings.length||!s.rings.some((e=>e.length>0)))return null;const c=Object(Ge.a)(s);if(Object(n.k)(c))return null;const l=new Array,d=new Array,h=new Array,u=Object(j.f)(),p=Object(v.d)(),f=Object(O.f)(),b=1===this._context.renderCoordsHelper.viewingMode;b||this._context.renderCoordsHelper.worldUpAtPosition(null,f),Object(x.d)(s.spatialReference,[c.x,c.y,0],p,this._context.renderCoordsHelper.spatialReference);const m=Object(v.d)();Object(g.c)(m,p);const y=Object(ji.b)();Object(xi.a)(y,m);const{polygons:_,mapPosition:S,position:w}=o,C=w.length/3,P=new Float64Array(3*C*6),T=new Float64Array(3*C*6),E=new Float64Array(3*C*6),A=new Float64Array(1*C*6);let R=0;for(let n=0;n<_.length;++n){const e=_[n],r=e.count;if(this._context.clippingExtent&&(Object(j.h)(u),Object(j.k)(u,e.mapPosition),!Object(j.r)(u,this._context.clippingExtent)))continue;const a=Object(Oi.a)(e.mapPosition,e.holeIndices,3);if(0===a.length)continue;const s=3*r*2+a.length,o=new Uint32Array(s),c=new Uint32Array(a.length),p=6*r,g=3*P.BYTES_PER_ELEMENT,O=new _i.v(P.buffer,R*g,g,(R+p)*g),x=3*T.BYTES_PER_ELEMENT,C=new _i.v(T.buffer,R*x,x,(R+p)*x),D=new Float64Array(E.buffer,3*R*E.BYTES_PER_ELEMENT,3*p),M=new Float64Array(A.buffer,1*R*A.BYTES_PER_ELEMENT,1*p),I=this._getExtrusionSize(t);Vi(w,S,a,e,O.typedBuffer,D,C.typedBuffer,M,0,o,c,I,f,b),Object(Si.e)(O,O,m),Object(Si.a)(C,C,y),R+=6*r;const z=this._createExtrudeGeometry(o,o.length-c.length,{positions:O.typedBuffer,elevation:D,normals:C.typedBuffer,heights:M},i);l.push(z),d.push(this._material),h.push(v.a);const L=this._createExtrudeGeometry(c,0,{positions:O.typedBuffer,elevation:D,normals:C.typedBuffer,heights:M},i);l.push(L),d.push(this._bottomMaterial),h.push(v.a)}if(0===l.length)return null;const D=new zi.a({geometries:l,materials:d,transformations:h,metadata:{layerUid:this._context.layer.uid,graphicUid:a,isElevationSource:!0}});D.transformation=p;const M=pt(this.symbolLayer,{opacity:this._getLayerOpacity()}),I=Object(n.l)(M)?{baseMaterial:this._material,edgeMaterials:[M],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,z=new tt(this,D,l,null,null,Zi,r,I);return z.alignedSampledElevation=o.sampledElevation,z.needsElevationUpdates=Object(Ve.i)(r.mode),z}_createExtrudeGeometry(e,t,i,r){const n=new Uint32Array(e.length),a=[["position",{size:3,data:i.positions,exclusive:!0}],["normal",{size:3,data:i.normals,exclusive:!0}],["color",{size:4,data:r,exclusive:!0}],["size",{size:1,data:i.heights,exclusive:!0}]],s=[["position",e],["normal",e],["color",n]];return i.elevation&&(a.push(["mapPos",{size:3,data:i.elevation}]),s.push(["mapPos",e])),new Dt.a(a,s,0,t)}},text:class extends Ct{constructor(e,t,i,r){super(e,t,i,r),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=Object(Ge.j)(this.symbolLayer.size);if(e)throw new te.a("graphics3dtextsymbollayer:invalid-size",e)}this._createTextRenderParameters()}_createTextRenderParameters(){const e=this._context.layerView.view.pixelRatio;this._textRenderParameters=Oo.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){const t=e.graphic,i=Object(Rt.d)(t.geometry);if(Object(n.k)(i))return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;const r=this.symbolLayer.text;if(!r)return null;const a=Object(ze.d)(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol:null;return this._createAs3DShape(t,i,r,a)}createLabel(e,t,i,r){const a=e.graphic,s=Object(Rt.d)(a.geometry);if(Object(n.k)(s))return this.logger.warn(`unsupported geometry type for label: ${a.geometry.type}`),null;const o=t.text;return!o||/^\s+$/.test(o)?null:this._createAs3DShape(a,s,o,t,t,i,r)}setGraphicElevationContext(e,t,i=0){const r=super.setGraphicElevationContext(e,t);return r.addOffsetRenderUnits(i),r}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,t){return Mo(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e)})),Ve.b.UPDATE}slicePlaneEnabledChanged(e,t){return Mo(e,t,(e=>{for(const t of e.stageObject.geometryRecords)t.material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=Object(Ve.h)(t.elevationContext.mode)||"absolute-height"===t.elevationContext.mode}_defaultElevationInfoNoZ(){return Io}_createAs3DShape(e,t,i,r,a=zo,s,o){const c=this.setGraphicElevationContext(e,new Ke.a,a.elevationOffset),l="polyline"===Object(n.j)(e.geometry,"type"),d=e.uid,h=this._context.stage.renderView.renderingContext,u=a.anchor in Ge.h?a.anchor:"center",p=Ge.h[u],f=Object(n.k)(o)?new Ao(h,i,this._textRenderParameters):null,b={occlusionTest:!0,screenOffset:a.screenOffset,anchorPos:p,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:a.centerOffsetUnits,debugDrawBorder:a.debugDrawBorder,drawInSecondSlot:!0};if(Object(n.l)(f)&&(b.textureId=f.id,b.texCoordScale=f.texcoordScale),Object(n.l)(o)&&(b.textureId=o.id),Object(n.l)(r)&&Object(n.l)(r.verticalOffset)){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=r.verticalOffset;b.verticalOffset={screenLength:Object(Fe.g)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources;b.screenSizePerspective=t.overridePadding(this._textRenderParameters.haloSize),b.screenSizePerspectiveAlignment=e}let m;if(l&&(b.shaderPolygonOffset=1e-4),b.slicePlaneEnabled=this._context.slicePlaneEnabled,Object(n.l)(s)){const e=JSON.stringify(b);m=s.get(e),Object(n.k)(m)&&(m=new Ir.a(b),s.add(e,m))}else m=new Ir.a(b);const g=[m],v=a.translation,y=Object(n.l)(f)?[f.displayWidth,f.displayHeight]:[0,0],O=a.centerOffset,x=Do,j=[dt.a.createPointGeometry(x,v,null,y,O,[0,0],null)],_=this._context.layer.uid,S=Object(Rt.a)(this._context,t,j,g,c,_,d);if(null===S)return null;const w=new tt(this,S.object,j,Object(n.k)(s)?g:null,Object(n.l)(f)?[f]:null,ke,c);w.alignedSampledElevation=S.sampledElevation,w.needsElevationUpdates=Object(Ve.h)(c.mode)||"absolute-height"===c.mode;const{displayWidth:C,displayHeight:T}=Object(n.l)(f)?f:a;w.getScreenSize=(e=Object(P.a)())=>(e[0]=C,e[1]=T,e);const E={labelText:i,elevationOffset:a.elevationOffset};return w.metadata=E,Object(Rt.b)(w,t,this._context.elevationProvider),w}},water:Uo};const Xo={"mesh-3d":{fill:class extends Ct{constructor(e,t,i,r){super(e,t,i,r),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){Ue.a.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new sn.a({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new sn.a({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),(e=>e.material))),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,on,"fill on mesh-3d"))return null;const i=this.setGraphicElevationContext(t,new Ke.a),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}layerOpacityChanged(e,t){const i=this._getLayerOpacity();return this._materials.forEach((e=>{e.material.setParameters({layerOpacity:i});const t=e.material.parameters;this._setMaterialTransparentParameter(t,e),e.material.setParameters({transparent:t.transparent})})),e.forEach((e=>{const r=t(e);Object(n.l)(r)&&r.layerOpacityChanged(i,this._context.isAsync)})),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Ve.i)}slicePlaneEnabledChanged(e,t){return this._materials.forEach((e=>{e.material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})})),e.forEach((e=>{const i=t(e);Object(n.l)(i)&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._materials.forEach((t=>t.material.setParameters({usePBR:e}))),!0}pixelRatioChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return Object(n.k)(e)?"-":e instanceof Le.a?e.toHex():e.contentHash}_materialPropertiesDefault(e,t){const i=this._requiresSymbolVertexColors(),r=!!e.vertexAttributes.color,n=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:r,hasVertexTangents:n,uid:`vc:${r},vt:${n},vct${t},svc:${i}`}}_materialProperties(e,t,i){const r=this._materialPropertiesDefault(e,i);if(!t.material)return r;const{color:n,colorTexture:a,normalTexture:s,doubleSided:o,alphaCutoff:c,alphaMode:l}=t.material,d=this._colorOrTextureUid(n),h=this._colorOrTextureUid(a),u=this._colorOrTextureUid(s);if(r.color=n,r.colorTexture=a,r.normalTexture=s,r.uid=`${r.uid},cmuid:${d},ctmuid:${h},ntmuid:${u},ds:${o},ac:${c},am:${l}`,t.material instanceof Jr.a){const{metallic:e,roughness:i,metallicRoughnessTexture:n,emissiveColor:a,emissiveTexture:s,occlusionTexture:o}=t.material,c=this._colorOrTextureUid(n),l=this._colorOrTextureUid(a),d=this._colorOrTextureUid(s),h=this._colorOrTextureUid(o);r.metallic=e,r.roughness=i,r.metallicRoughnessTexture=n,r.emissiveColor=a,r.emissiveTexture=s,r.occlusionTexture=o,r.uid=`${r.uid},mrm:${e},mrr:${i},mrt:${c},emuid:${l},etmuid:${d},otmuid:${h}`}return r}_setInternalColorValueParameters(e,t){t.diffuse=Le.a.toUnitRGB(e),t.opacity=e.a}_getLoadableTextureResource(e){return e.data?e.data:e.url}_getInternalTextureId(e){const t=this._getInternalTexture(e,1);return Object(n.l)(t)?t.id:null}_getInternalTexture(e,t){const i=this._getLoadableTextureResource(e);if(!i)return null;const r=`${e.contentHash}/${t}`;let n=this._textures.get(r);return n||(n=new Mr.a(i,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:1!==t}),this._textures.set(r,n),this._context.stage.add(n),this._context.stage.loadSynchronous(n)),n}_castTextureWrap(e="repeat"){if("string"==typeof e){const t=this._castTextureWrapIndividual(e);return{s:t,t:t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return 33071;case"mirror":return 33648;default:return 10497}}_setInternalMaterialParameters(e,t){if(Object(n.l)(e.color)&&this._setInternalColorValueParameters(e.color,t),Object(n.l)(e.colorTexture)){const i=this._getInternalTexture(e.colorTexture,t.textureAlphaMode);Object(n.l)(i)?(t.textureId=i.id,t.textureAlphaPremultiplied=!!i.params.preMultiplyAlpha):t.textureId=void 0}Object(n.l)(e.normalTexture)&&(t.normalTextureId=this._getInternalTextureId(e.normalTexture)),Object(n.l)(e.emissiveColor)&&(t.emissiveFactor=Le.a.toUnitRGB(e.emissiveColor)),Object(n.l)(e.emissiveTexture)&&(t.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),Object(n.l)(e.occlusionTexture)&&(t.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),Object(n.l)(e.metallicRoughnessTexture)&&(t.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture))}_setExternalMaterialParameters(e){const t=this._drivenProperties.color;let i=Object(n.l)(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(t)e.externalColor=ot.a;else{const t=Object(n.l)(this.symbolLayer.material)?this.symbolLayer.material.color:null;Object(n.l)(t)?e.externalColor=Le.a.toUnitRGBA(t):(i=null,e.externalColor=ot.a)}i&&(e.colorMixMode=i),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const t=e.vertexAttributes.color;if(Object(n.k)(t))return!1;for(let i=3;i<t.length;i+=4)if(255!==t[i])return!0;return!1}_getOrCreateMaterial(e,t){var i,r,a;const s=null==(i=t.material)?void 0:i.color,o=null==(r=t.material)?void 0:r.colorTexture,c=null==(a=t.material)?void 0:a.alphaMode,l="blend"===c,d=!("opaque"===c)&&(this._hasTransparentVertexColors(e)||Object(n.l)(s)&&s.a<1||Object(n.l)(o)&&o.transparent||l),h=this._materialProperties(e,t,d),u=this._materials.get(h.uid);if(u)return u.material;const p={material:null,isComponentTransparent:d,alphaMode:t.material?t.material.alphaMode:"opaque"},f=null==h.metallicRoughnessTexture&&null==h.metallic&&null==h.roughness,b={usePBR:this._usePBR(),isSchematic:f,vertexColors:h.hasVertexColors,symbolColors:h.hasSymbolVertexColors,vertexTangents:h.hasVertexTangents,ambient:O.c,diffuse:O.a,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:0,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};f||(b.mrrFactors=[null!=h.metallic?h.metallic:1,null!=h.roughness?h.roughness:1,.5]),t.material&&(b.doubleSided=t.material.doubleSided,b.cullFace=t.material.doubleSided?0:2,b.textureAlphaCutoff=t.material.alphaCutoff),this._setExternalMaterialParameters(b),this._setMaterialTransparentParameter(b,p),this._setInternalMaterialParameters(h,b);const m=new Li.a(b);return p.material=m,this._materials.set(h.uid,p),this._context.stage.add(m),m}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?3:1:e.textureAlphaMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:0}_addDebugNormals(e,t,i,r){const n=t.length,a=e.spatialReference.isGeographic?20015077/180:1,s=.1*Math.max(e.extent.width*a,e.extent.height*a,e.extent.zmax-e.extent.zmin),o=[],c=[],l=[],d=[];for(let p=0;p<n;p++){const e=t[p],i=e.vertexAttributes.get("position"),r=e.vertexAttributes.get("normal"),n=e.indices.get("position"),a=e.indices.get("normal"),h=i.data,u=r.data;for(let t=0;t<n.length;t++){const e=3*n[t],i=3*a[t];for(let t=0;t<3;t++)o.push(h[e+t]);for(let t=0;t<3;t++)o.push(h[e+t]+u[i+t]*s);if(c.push(c.length),c.push(c.length),t%3==0){this._calculateFaceNormal(h,n,t,un),this._getFaceVertices(h,n,t,ln,dn,hn),Object(y.f)(ln,ln,dn),Object(y.f)(ln,ln,hn),Object(y.e)(ln,ln,1/3);for(let e=0;e<3;e++)l.push(ln[e]);for(let e=0;e<3;e++)l.push(ln[e]+un[e]*s);d.push(d.length),d.push(d.length)}}}const h=new Dt.a([["position",{data:o,size:3,exclusive:!0}]],[["position",new Uint32Array(c)]],2);t.push(h),i.push(this._debugVertexNormalMaterial),r.push(Object(v.c)(r[0]));const u=new Dt.a([["position",{data:l,size:3,exclusive:!0}]],[["position",new Uint32Array(d)]],2);t.push(u),i.push(this._debugFaceNormalMaterial),r.push(Object(v.c)(r[0]))}_createAs3DShape(e,t,i,r){const a=e.geometry;if("mesh"!==a.type)return null;const s=this._createGeometryInfo(a,t);if(!s)return null;const{geometries:o,materials:c,transformations:l,objectTransformation:d}=s;Ue.a.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(a,o,c,l);const h=new zi.a({geometries:o,materials:c,transformations:l,metadata:{layerUid:this._context.layer.uid,graphicUid:r}});h.transformation=d;const u=this._createEdgeMaterial(),p=Object(n.l)(u)?{baseMaterial:c[0],edgeMaterials:[u],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,f=new tt(this,h,o,null,null,ke,i,p);return f.needsElevationUpdates=Object(Ve.i)(i.mode),f.useObjectOriginAsAttachmentOrigin=!0,f.elevationContext.centerPointInElevationSR=this.getCenterPointInElevationSR(h),f.alignedSampledElevation=ke(f,f.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),f}getCenterPointInElevationSR(e){const t=Object(se.g)(0,0,0,this._context.elevationProvider.spatialReference);return Object(x.r)([e.transformation[12],e.transformation[13],e.transformation[14]],this._context.renderCoordsHelper.spatialReference,t),t}_createComponentNormals(e,t,i,r){switch(i.shading||"flat"){case"source":return this._createComponentNormalsSource(e,t,i,r);case"flat":return this._createComponentNormalsFlat(e,r);case"smooth":return this._createComponentNormalsSmooth(e,r);default:return}}_createComponentNormalsSource(e,t,i,r){if(Object(n.k)(t))return this._createComponentNormalsFlat(e,r);let a=!1;if(!i.trustSourceNormals)for(let n=0;n<r.length;n+=3){this._calculateFaceNormal(e,r,n,un);for(let e=0;e<3;e++){const i=3*r[n+e];ln[0]=t[i+0],ln[1]=t[i+1],ln[2]=t[i+2],Object(y.h)(un,ln)<0&&(t[i+0]=-t[i+0],t[i+1]=-t[i+1],t[i+2]=-t[i+2],a=!0)}}return{normals:t,indices:r,didFlipNormals:a}}_createComponentNormalsFlat(e,t){const i=new Float32Array(t.length),r=new Uint32Array(3*t.length);for(let n=0;n<t.length;n+=3){const a=this._calculateFaceNormal(e,t,n,un);for(let e=0;e<3;e++)i[n+e]=a[e],r[n+e]=n/3}return{normals:i,indices:r,didFlipNormals:!1}}_createComponentNormalsSmooth(e,t){const i={};for(let a=0;a<t.length;a+=3){const r=this._calculateFaceNormal(e,t,a,un);for(let e=0;e<3;e++){const n=t[a+e];let s=i[n];s||(s={normal:Object(O.f)(),count:0},i[n]=s),Object(y.f)(s.normal,s.normal,r),s.count++}}const r=new Float32Array(3*t.length),n=new Uint32Array(3*t.length);for(let a=0;a<t.length;a++){const e=i[t[a]];1!==e.count&&(Object(y.r)(e.normal,e.normal),e.count=1);for(let t=0;t<3;t++)r[3*a+t]=e.normal[t];n[a]=a}return{normals:r,indices:n,didFlipNormals:!1}}_getFaceVertices(e,t,i,r,n,a){const s=3*t[i+0],o=3*t[i+1],c=3*t[i+2];r[0]=e[s+0],r[1]=e[s+1],r[2]=e[s+2],n[0]=e[o+0],n[1]=e[o+1],n[2]=e[o+2],a[0]=e[c+0],a[1]=e[c+1],a[2]=e[c+2]}_calculateFaceNormal(e,t,i,r){return this._getFaceVertices(e,t,i,ln,dn,hn),Object(y.j)(dn,dn,ln),Object(y.j)(hn,hn,ln),Object(y.g)(ln,dn,hn),Object(y.r)(r,ln),r}_getOrCreateComponents(e){return e.components?e.components:mn}_createPositionBuffer(e,t){let i=e.vertexAttributes.position;const r=1===t.reprojection?t.transformBeforeProject:null;if(Object(n.l)(r)&&(i=Object(Kr.h)(i,new Float64Array(i.length),r)),0===t.reprojection)return t.needsBufferCopy?new Float64Array(i):i;const a=Object(n.l)(r)?i:new Float64Array(i.length);return Object(x.l)(i,e.spatialReference,0,a,this._context.renderCoordsHelper.spatialReference,0,i.length/3),a}_createNormalBuffer(e,t,i){let r=e.vertexAttributes.normal;if(Object(n.k)(r))return null;const a=1===i.reprojection?i.transformBeforeProject:null;if(Object(n.l)(a)&&(r=Object(Kr.g)(r,new Float32Array(r.length),a)),"local"===this._context.layerView.view.viewingMode||0===i.reprojection)return i.needsBufferCopy&&e.vertexAttributes.normal===r?new Float32Array(r):r;const s=e.vertexAttributes.position,o=Object(n.l)(a)?r:new Float32Array(r.length);return Object(Kr.c)(r,s,t,e.spatialReference,o)}_createTangentBuffer(e,t,i){let r=e.vertexAttributes.tangent;if(Object(n.k)(r))return null;const a=1===i.reprojection?i.transformBeforeProject:null;if(Object(n.l)(a)&&(r=Object(Kr.i)(r,new Float32Array(r.length),a)),"local"===this._context.layerView.view.viewingMode||0===i.reprojection)return i.needsBufferCopy&&e.vertexAttributes.normal===r?new Float32Array(r):r;const s=e.vertexAttributes.position,o=Object(n.l)(a)?r:new Float32Array(r.length);return Object(Kr.e)(r,s,t,e.spatialReference,o)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const t=this._getVertexOpacityAndColor(e),i=function(e){switch(e){default:return 1;case"ignore":return 2;case"replace":return 3;case"tint":return 4}}(Object(n.j)(this.symbolLayer,"material","colorMixMode")),r=new Uint8Array(4);return function(e,t,i){if(Object(n.k)(e)||2===t)return i[0]=255,i[1]=255,i[2]=255,void(i[3]=255);const r=Object(m.e)(Math.round(e[3]*tn),0,tn),a=0===r||4===t?0:3===t?rn:nn;i[0]=Object(m.e)(Math.round(e[0]*en),0,en),i[1]=Object(m.e)(Math.round(e[1]*en),0,en),i[2]=Object(m.e)(Math.round(e[2]*en),0,en),i[3]=r+a}(t,i,r),r}return null}_createBuffers(e,t){const i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const r=e.vertexAttributes.normal,a=e.vertexAttributes.uv,s=e.vertexAttributes.tangent;if(Object(n.l)(r)&&r.length!==i.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(Object(n.l)(s)&&s.length/4!=i.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(Object(n.l)(a)&&a.length/2!=i.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const o=this._computeReprojectionInfo(e),c=this._createPositionBuffer(e,o),l=this._createColorBuffer(e),d=this._createSymbolColorBuffer(t),h=this._createNormalBuffer(e,c,o),u=this._createTangentBuffer(e,c,o);return{positionBuffer:c,normalBuffer:h,tangentBuffer:u,uvBuffer:a,colorBuffer:l,symbolColorBuffer:d,objectTransformation:0===o.reprojection&&Object(n.l)(o.objectTransformation)?o.objectTransformation:this._transformOriginLocal(e,c,h,u),geometryTransformation:0===o.reprojection&&Object(n.l)(o.geometryTransformation)?o.geometryTransformation:Object(v.d)()}}_computeReprojectionInfo(e){const t=Object(n.l)(e.transform)&&e.transform.geographic||2===this._context.renderCoordsHelper.viewingMode?0:1;let i=null;if(Object(n.l)(e.transform)){if(0===t){const i=Object(v.d)();return Object(x.d)(e.spatialReference,e.transform.origin,i,this._context.renderCoordsHelper.spatialReference),{reprojection:t,objectTransformation:i,geometryTransformation:Object(v.c)(e.transform.localMatrix),needsBufferCopy:!1}}return i=Object(g.v)(Object(v.d)(),e.transform.origin),Object(g.n)(i,i,e.transform.localMatrix),{reprojection:t,transformBeforeProject:i,needsBufferCopy:!0}}return{reprojection:t,needsBufferCopy:!0}}_transformOriginLocal(e,t,i,r){const a=this._context.renderCoordsHelper.spatialReference,s=e.anchor;cn[0]=s.x,cn[1]=s.y,cn[2]=s.z;const o=Object(v.d)();Object(x.d)(e.spatialReference,cn,o,a);const c=_i.v.fromTypedArray(t);if(Object(g.c)(pn,o),Object(Si.e)(c,c,pn),Object(n.l)(i)||Object(n.l)(r)){if(Object(xi.f)(fn,o),Object(xi.m)(fn,fn),Object(n.l)(i)){const e=_i.u.fromTypedArray(i);Object(Si.a)(e,e,fn)}if(Object(n.l)(r)){const e=_i.u.fromTypedArray(r,4*r.BYTES_PER_ELEMENT);Object(Si.a)(e,e,fn)}}return o}_validateFaces(e,t){const i=e.vertexAttributes.position.length/3,r=t.faces;if(r){let e=-1;for(let t=0;t<r.length;t++){const i=r[t];i>e&&(e=i)}if(i<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,t){return t.faces?t.faces:Object(an.d)(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;const t=e.vertexAttributes&&e.vertexAttributes.position;if(!t)return!1;const i=this._context.elevationProvider.spatialReference;let r;const n=t.length/3;return e.spatialReference.equals(i)?r=t:(r=new Float64Array(t.length),Object(x.l)(e.vertexAttributes.position,e.spatialReference,0,r,i,0,n)),Object(j.h)(bn),Object(j.k)(bn,r,0,n),!Object(j.r)(bn,this._context.clippingExtent)}_createGeometryInfo(e,t){if(!Object(x.b)(e.spatialReference,this._context.layerView.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const i=this._createBuffers(e,t);if(Object(n.k)(i))return null;const{positionBuffer:r,uvBuffer:a,colorBuffer:s,symbolColorBuffer:o,normalBuffer:c,tangentBuffer:l,objectTransformation:d,geometryTransformation:h}=i,u=this._getOrCreateComponents(e),p=[],f=[],b=[];let m=!1;for(const g of u){if(!this._validateFaces(e,g))return null;const t=this._getOrCreateFaces(e,g);if(0===t.length)continue;const i=this._createComponentNormals(r,c,g,t);i.didFlipNormals&&(m=!0);const d=[["position",{size:3,data:r,exclusive:!0}],["normal",{size:3,data:i.normals,exclusive:!0}]],u=[["position",t],["normal",i.indices]];Object(n.l)(s)&&(d.push(["color",{size:4,data:s,exclusive:!0}]),u.push(["color",t])),Object(n.l)(o)&&(d.push(["symbolColor",{size:4,data:o,exclusive:!0}]),u.push(["symbolColor",new Uint16Array(t.length)])),Object(n.l)(a)&&(d.push(["uv0",{size:2,data:a,exclusive:!0}]),u.push(["uv0",t])),Object(n.l)(l)&&(d.push(["tangent",{size:4,data:l,exclusive:!0}]),u.push(["tangent",t]));const v=new Dt.a(d,u);p.push(v),f.push(h),b.push(this._getOrCreateMaterial(e,g))}return m&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:p,transformations:f,materials:b,objectTransformation:d}}_createEdgeMaterial(){const e={opacity:this._getLayerOpacity()};return pt(this.symbolLayer,e)}}}};class Qo extends ct{constructor(e,t,i){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}set symbol(e){this._symbol=e;for(let t=0;t<e.symbolLayers.length;t++){const i=this.symbolLayers[t];Object(n.k)(i)||(i.symbol=e,i.symbolLayer=e.symbolLayers.items[t])}}get symbol(){return this._symbol}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const i=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const r=[];for(let n=0;n<i;n++){const a=t.getItemAt(n);if(!1===a.enabled)continue;Jo.renderPriority=1-(1+n)/i,Jo.renderPriorityStep=1/i,Jo.ignoreDrivers=a._ignoreDrivers;const s=Yo(this.symbol,a,this._context,Jo);r.push(Object(Y.q)(e,(()=>{this.symbolLayers[n]=null,s.destroy()}))),this.symbolLayers[n]=s}await Object(Ie.a)(this.symbolLayers,(async(e,t)=>{if(Object(n.l)(e))try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}}));for(const n of r)null==n||n.remove();if(r.length=0,Object(Y.u)(e),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return Object(n.l)(t)?t.getCachedSize():null}get extentPadding(){return this._extentPadding}createGraphics3DGraphic(e,t){const i=e.graphic,r=new Array(this.symbolLayers.length);for(let s=0;s<this.symbolLayers.length;s++){const t=this.symbolLayers[s];r[s]=Object(n.l)(t)?t.createGraphics3DGraphic(e):null}const a=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new yi(i,t||this,r,e.layer,a)}get complexity(){return yt(this.symbolLayers.map((e=>Object(n.j)(e,"complexity"))))}globalPropertyChanged(e,t){const i=this.symbolLayers.length;for(let r=0;r<i;r++){const i=this.symbolLayers[r],a=e=>{const t=e.graphics[r];return t instanceof tt?t:null};if(Object(n.l)(i)&&!i.globalPropertyChanged(e,t,a))return!1}return!0}applyRendererDiff(e,t){return 1!==this.loadStatus?0:this.symbolLayers.reduce(((i,r)=>0!==i&&Object(n.l)(r)?Math.min(i,r.applyRendererDiff(e,t)):i),2)}prepareSymbolPatch(e){if(2===this.loadStatus)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const i=t.symbolLayers.diff;this.symbolLayers.forEach(((t,r)=>{if(Object(n.k)(t))return;const a=i[r];if(a){const i={diff:a,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(i),e.symbolStatePatches.push(...i.symbolLayerStatePatches),i.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const a=e.graphics[r];Object(n.l)(a)&&i.graphics3DGraphicPatches.forEach((e=>e(a,t)))}))}}))}updateGeometry(e,t){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if(Object(n.k)(r))continue;const a=e.graphics[i];if(Object(n.k)(a)||!r.updateGeometry(a,t))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const i=this.symbolLayers[t];if(Object(n.k)(i))continue;const r=e.graphics[t];Object(n.l)(r)&&i.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=0,t=0,i=0;return this.symbolLayers.forEach((r=>{Object(n.k)(r)||(0===r.loadStatus?e++:r.isFastUpdatesEnabled()?i++:t++)})),{loading:e,slow:t,fast:i}}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const e of this.symbolLayers)Object(n.l)(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const Jo={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};class Ko extends Qo{constructor(e,t,i){super(e,t,i),this.calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this.calloutSymbolLayer=function(e,t){if(!Object(ze.d)(e))return di.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const i=hi[e.callout.type];return i?new i(e,t):(di.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)}(this.symbol,t))}async doLoad(e){const t=this.calloutSymbolLayer?Object(Ie.c)(this.calloutSymbolLayer.load()):null;try{await super.doLoad(e),Object(Y.u)(e)}catch(r){var i;throw null==(i=this.calloutSymbolLayer)||i.abortLoad(),r}t&&await t}destroy(){super.destroy(),this.calloutSymbolLayer=Object(n.e)(this.calloutSymbolLayer)}createGraphics3DGraphic(e,t){const i=super.createGraphics3DGraphic(e,t);if(this.calloutSymbolLayer){const t=this.createCalloutGraphic(e);t&&i.addAuxiliaryGraphic(t)}return i}globalPropertyChanged(e,t){return!!super.globalPropertyChanged(e,t)&&(!this.calloutSymbolLayer||this.calloutSymbolLayer.globalPropertyChanged(e,t,(e=>this._getCalloutGraphicLayer(e))))}updateGeometry(e,t){const i=super.updateGeometry(e,t);if(i&&this.calloutSymbolLayer){const i=this._getCalloutGraphicLayer(e);if(i)return this.calloutSymbolLayer.updateGeometry(i,t)}return i}createCalloutGraphic(e){const t=e.renderingInfo,i={renderer:t.renderer,symbol:t.symbol,translation:[0,0,0],centerOffset:[0,0,0,0],screenOffset:[0,0],centerOffsetUnits:"world",elevationOffset:0,materialCollection:null};return e.renderingInfo=i,this.calloutSymbolLayer.createGraphics3DGraphic(e)}_getCalloutGraphicLayer(e){for(const t of e._auxiliaryGraphics)if(t.graphics3DSymbolLayer===this.calloutSymbolLayer)return t}}class ec extends ct{constructor(e,t,i){super(t),this.symbol=e,this.convert=i,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return Object(n.l)(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return Object(n.l)(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return Object(n.l)(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this.convert(t),await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return Object(n.l)(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return Object(n.l)(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:vt}globalPropertyChanged(e,t){return!!Object(n.l)(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return Object(n.l)(this.graphics3DSymbol)?this.graphics3DSymbol.applyRendererDiff(e,t):0}prepareSymbolPatch(e){Object(n.l)(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return!!Object(n.l)(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(e,t)}onRemoveGraphic(){}getFastUpdateStatus(){return Object(n.l)(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){Object(n.l)(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}}class tc{constructor(e){this.graphicsCore=e,this.idToState=new Map,this.states=new Set;const t=e.owner.layer&&e.owner.layer.objectIdField;t?(this.getGraphicId=e=>Object(se.e)(e,t),this.getGraphics3DGraphicById=e=>this.graphicsCore.getGraphics3DGraphicByObjectId(e)):(this.getGraphicId=e=>e.uid,this.getGraphics3DGraphicById=e=>this.graphicsCore.getGraphics3DGraphicById(e))}destroy(){this.idToState.clear(),this.states.forEach(((e,t)=>this.remove(t)))}add(e){const t={remove:()=>this.remove(e)};if(this.states.has(e))return t;const i=this.getGraphicId(e.graphic),r=this.getGraphics3DGraphicById(i);return this.states.has(e)||this.states.add(e),this.ensureStateList(i).push(e),e.displaying=!!Object(n.l)(r)&&r.isVisible(),e.isDraped=!!Object(n.l)(r)&&r.isDraped,e.tracking=!0,Object(n.l)(r)&&e.emit("changed",{}),t}remove(e){if(this.states.has(e)){if(this.idToState.size){const t=this.getGraphicId(e.graphic),i=this.idToState.get(t);i&&(Object(o.h)(i,e),0===i.length&&this.idToState.delete(t))}this.states.delete(e),e.tracking=!1,e.displaying=!1}}addGraphic(e){this.forEachState(e,(t=>{t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed",{})}))}removeGraphic(e){this.forEachState(e,(e=>{e.displaying=!1,e.isDraped=!1}))}updateGraphicGeometry(e){this.forEachState(e,(e=>{e.emit("changed",{})}))}updateGraphicVisibility(e){this.forEachState(e,(t=>{t.displaying=e.isVisible()}))}allGraphicsDeleted(){this.states.forEach((e=>{e.displaying=!1}))}ensureStateList(e){const t=this.idToState.get(e);if(t)return t;const i=new Array;return this.idToState.set(e,i),i}forEachState(e,t){if(0===this.states.size||0===this.idToState.size)return;const i=this.getGraphicId(e.graphic),r=this.idToState.get(i);null!=r&&r.forEach(t)}}var ic=i(703);let rc=class extends u.a{constructor(e){super(e),this._index=new ic.a(9,Object(c.a)("esri-csp-restrictions")?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(e){this._addMany(e)}destroy(){this._missing.clear(),this._index.destroy(),this._index=null,this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(e,t,i){t.equals(this.spatialReference)&&(nc.minX=e[0],nc.minY=e[1],nc.maxX=e[2],nc.maxY=e[3],this.update(),this._index.search(nc,(e=>i(e.graphic.uid))))}add(e){this._missing.add(e),this.updating=!0}remove(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);this._index.remove(e);const t=Object(se.e)(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}_addMany(e){if(0===e.length)return;const t=this._get("objectIdField");for(const i of e){i.computeExtent(this.spatialReference);const e=Object(se.e)(i.graphic,t);null!=e&&this._boundsByFeature.set(e,i.extent)}this._index.load(e)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(e,t){nc.minX=e[0],nc.minY=e[1],nc.maxX=e[2],nc.maxY=e[3],this.update(),this._index.search(nc,(e=>{t(e)}))}getBounds(e,t){this.update();const i=this._boundsByFeature.get(e);return i?Object(j.o)(t,i):null}};Object(r.a)([Object(s.b)({constructOnly:!0})],rc.prototype,"spatialReference",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],rc.prototype,"hasZ",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],rc.prototype,"hasM",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],rc.prototype,"objectIdField",void 0),Object(r.a)([Object(s.b)()],rc.prototype,"updating",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],rc.prototype,"updatingRemaining",null),rc=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.SpatialIndex2D")],rc);const nc={minX:0,minY:0,maxX:0,maxY:0};var ac=i(594);const sc=ie.a.getLogger("esri.views.3d.layers.support.StageLayerElevationProvider");let oc=class extends(we.a.EventedMixin(u.a)){constructor(e){super(e),this.elevationOffset=0,this._layerHandes=new p.a}initialize(){this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=Object($n.a)(this.view.state.viewingMode),this.intersector.options.store=0;const e=this.computeLayerExtent(this.stageLayer);this.zmin=e[2],this.zmax=e[5];const t=this.stageLayer.events;this._layerHandes.add([t.on("layerObjectAdded",(e=>this.objectChanged(e.object))),t.on("layerObjectRemoved",(e=>this.objectChanged(e.object))),t.on("objectGeometryAdded",(e=>this.objectChanged(e.object))),t.on("objectGeometryRemoved",(e=>this.objectChanged(e.object))),t.on("vertexAttrsUpdated",(e=>this.objectChanged(e.object))),t.on("objectTransformation",(e=>this.objectChanged(e)))])}dispose(){this._layerHandes.destroy()}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=Object(Lo.f)(this.layer.spatialReference),i=Object(ac.a)(e.unit);this.elevationOffset=Object(n.u)(e.offset,0)*i/t}else this.elevationOffset=0}getElevation(e,t,i,r){if(hc[0]=e,hc[1]=t,hc[2]=i,!this.renderCoordsHelper.toRenderCoords(hc,r,hc))return sc.error("could not project point for elevation alignment"),null;const n=this.elevationOffset,a=this.zmin+n,s=this.zmax+n;this.renderCoordsHelper.setAltitude(uc,s,hc),this.renderCoordsHelper.setAltitude(pc,a,hc);return this.intersector.reset(uc,pc,null),this.intersector.intersect(this.intersectLayers,null,1,null,(e=>e.metadata&&e.metadata.isElevationSource)),this.intersector.results.min.getIntersectionPoint(hc)?this.renderCoordsHelper.getAltitude(hc):null}objectChanged(e){var t;if(null==(t=e.metadata)||!t.isElevationSource||!this.spatialReference)return;Object(j.h)(cc),e.metadata.lastValidElevationBB.isEmpty()||this.expandExtent(e.metadata.lastValidElevationBB.min,e.metadata.lastValidElevationBB.max,cc);const i=e.boundingVolumeWorldSpace.min,r=e.boundingVolumeWorldSpace.max;this.expandExtent(i,r,cc),Object(j.A)(cc,lc),this.zmin=Math.min(this.zmin,cc[2]),this.zmax=Math.max(this.zmax,cc[5]),dc.extent=lc,dc.spatialReference=this.spatialReference,this.emit("elevation-change",dc),Object(y.k)(e.metadata.lastValidElevationBB.min,i),Object(y.k)(e.metadata.lastValidElevationBB.max,r)}computeLayerExtent(e){return Object(j.h)(cc),e.objects.forAll((e=>this.expandExtent(e.boundingVolumeWorldSpace.min,e.boundingVolumeWorldSpace.max,cc))),cc}expandExtent(e,t,i){for(let r=0;r<8;++r)hc[0]=1&r?e[0]:t[0],hc[1]=2&r?e[1]:t[1],hc[2]=4&r?e[2]:t[2],this.renderCoordsHelper.fromRenderCoords(hc,hc,this.spatialReference),Object(j.n)(i,hc);return i}};Object(r.a)([Object(s.b)({constructOnly:!0})],oc.prototype,"layer",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],oc.prototype,"stageLayer",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],oc.prototype,"view",void 0),Object(r.a)([Object(s.b)({readOnly:!0,aliasOf:"view.spatialReference"})],oc.prototype,"spatialReference",void 0),oc=Object(r.a)([Object(l.a)("esri.views.3d.layers.support.StageLayerElevationProvider")],oc);const cc=Object(j.h)(),lc=Object(_.m)(),dc={spatialReference:null,extent:lc,context:"scene"},hc=Object(O.f)(),uc=Object(O.f)(),pc=Object(O.f)();const fc=Object(O.f)();var bc=i(569),mc=i(217);class gc{constructor(e,t){this.owner=t,this.properties={},this.afterDispatchHandle=null;for(const i in e){const t=e[i],r=new bc.a(t,null,null,2,2);this.properties[i]={pool:r,acquired:[]}}this.afterDispatchHandle=Object(mc.a)((()=>this.release()))}destroy(){this.afterDispatchHandle&&(this.afterDispatchHandle.remove(),this.afterDispatchHandle=null);for(const e in this.properties){const t=this.properties[e];for(const e of t.acquired)Object(mc.b)(e)||t.pool.release(e);t.pool.destroy(),t.pool=null,t.acquired=null}this.properties=null,this.owner=null}get(e){const t=this.owner._get(e),i=this.properties[e];let r=i.pool.acquire();for(i.acquired.push(r);r===t;)i.acquired.push(r),r=i.pool.acquire();return r}release(){for(const e in this.properties){const t=this.properties[e];let i=0;for(const e of t.acquired)Object(mc.b)(e)?t.acquired[i++]=e:t.pool.release(e);t.acquired.length=i}}}var vc,yc=i(1039),Oc=i(718),xc=i(109),jc=i(409),_c=i(277),Sc=i(204);const wc=Object(O.f)(),Cc=Object(j.f)(),Pc=ie.a.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");let Tc=vc=class extends u.a{constructor(e){super(e),this.propertiesPool=new gc({computedExtent:Pi.a},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this.graphicStateTracking=null,this.symbolCreationContext=new Me(((e,t)=>this._frameTask.schedule(e,t))),this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this.graphicsDrapedUids=new Set,this.graphicsBySymbol=new Map,this.symbolConversionCache=new Map,this.symbols=new Map,this.graphicsWithoutSymbol=new Map,this.graphicsWaitingForSymbol=new Map,this.graphicsUpdateId=0,this._handles=new p.a,this._frameTask=k.a,this.suspendSymbolCleanup=!1,this._spatialReference=null,this.arcadeOnDemand=null,this.rendererChangeAbortController=null,this.elevationInfoChangeAbortController=null,this.setupAbortController=null,this.elevationAlignment=null,this.scaleVisibility=null,this.filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this.featureStore=null,this.deconflictor=null,this.labeler=null,this.objectStates=null,this.viewElevationProvider=null,this.stageLayerElevationProvider=null,this.sharedSymbolResourcesOwnerHandle=null,this.whenGraphics3DGraphicRequests={},this.pendingUpdates=new Map,this.numberOfGraphics=0,this.numberOfGraphicsProvidingElevation=0,this.pendingAdds=0,this.pendingRemoves=0,this.pendingUpdatesPool=new ne.a({allocator:e=>e||new Ec,deallocator:e=>(e.clear(),e)}),this.symbolWarningLogged=!1,this.geometryWarningLogged=!1,this.objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new ne.a,this.preferredUpdatePolicy=1,this.forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=void 0,this._startCreateGraphics=!1}get spatialIndex(){var e;return this._spatialIndex||(this._spatialIndex=new rc({objectIdField:null==(e=this.owner.layer)?void 0:e.objectIdField,spatialReference:this._spatialReference,hasZ:this.hasZ,hasM:this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get effectiveUpdatePolicy(){return Object(n.l)(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?0:Object(n.u)(this.forcedUpdatePolicy,this.preferredUpdatePolicy)}get updating(){var e,t;return!!(this.graphicsWaitingForSymbol.size>0||this.running||null!=(e=this.elevationAlignment)&&e.updating||Object(n.l)(this.scaleVisibility)&&this.scaleVisibility.updating||null!=(t=this.filterVisibility)&&t.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating)}get running(){var e;return this.pendingUpdates.size>0||!(null==(e=this._spatialIndex)||!e.updating)}get suspendedOrOutsideOfView(){var e;return this.owner.suspended||(null==(e=this.owner.suspendInfo)?void 0:e.outsideOfView)}get updatingRemaining(){var e,t;return this.updating?this.pendingUpdates.size+.1*((null==(e=this._spatialIndex)?void 0:e.updatingRemaining)||0)+.1*((null==(t=this.elevationAlignment)?void 0:t.updatingRemaining)||0):0}get displayFeatureLimit(){const e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,a=this.averageSymbolComplexity,s=Math.max(1,Object(n.l)(a)?a.primitivesPerFeature:1),o=Object(n.l)(a)&&a.drawCallsPerFeature>0?i/a.drawCallsPerFeature*.3:i,c=Math.ceil(r/s),l=Math.max(t,Math.min(i,c,o)),d=this._get("displayFeatureLimit");return d&&d.minimumTotalNumberOfFeatures===t&&d.maximumTotalNumberOfFeatures===i&&d.maximumTotalNumberOfPrimitives===r&&d.averageSymbolComplexity===a&&d.maximumNumberOfFeatures===l?d:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,averageSymbolComplexity:a,maximumNumberOfFeatures:l}}get averageSymbolComplexity(){const e=function(e){const t=yt(e);return t.numComplexities>0&&(t.primitivesPerFeature/=t.numComplexities,t.primitivesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.bytesPerCoordinate/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities,t.memory.draped.bytesPerCoordinate/=t.numComplexities),t}(this.symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||Object(n.l)(t)&&(e.estimated&&(t.primitivesPerFeature>=e.primitivesPerFeature||t.primitivesPerCoordinate>=e.primitivesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.primitivesPerFeature===e.primitivesPerFeature&&t.primitivesPerCoordinate===e.primitivesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}get spatialReference(){return this._spatialReference}get usedMemory(){const e=Object(n.l)(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+e}get usedMemoryPerGraphic(){if(this._usedMemory&&this.numberOfGraphics)return Math.abs(this.pendingAdds-this.pendingRemoves)/this.numberOfGraphics>30?0:this._usedMemory/this.numberOfGraphics;if(Object(n.l)(this.averageSymbolComplexity)){const e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)}get symbolComplexities(){return this.currentRenderer?this.getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this.getSymbolComplexitiesUsed()}getConvertedSymbol(e){if("web-style"===e.type)return e.clone();const t=this.symbolConversionCache.get(e.id);if(Object(n.l)(t))return t;const i=Object(je.a)(e,{retainId:!0,hasLabelingContext:this.hasLabelingContext(e)}),r=i.symbol||null;return Object(n.k)(r)&&i.error&&Pc.error(i.error.message),this.symbolConversionCache.set(e.id,r),r}getSymbolComplexitiesUsedOrRenderer(e){if(Object(n.k)(e))return[];const t=e.getSymbols(),i="backgroundFillSymbol"in e&&e.backgroundFillSymbol;if(!(i||t&&t.length))return[];const r=[],a=this.getSymbolComplexityUsedOrRenderer(i);Object(n.l)(a)&&r.push(a);for(const s of t){const e=this.getSymbolComplexityUsedOrRenderer(s);Object(n.l)(e)&&r.push(e)}return r}getSymbolComplexityUsedOrRenderer(e){if(Object(n.k)(e))return null;const t=this.symbols.get(e.id);if(Object(n.l)(t))return t.complexity;const i=this.getConvertedSymbol(e);return Object(n.l)(i)?function(e){return"web-style"===e.type?vt:yt(e.symbolLayers.toArray().map((t=>xt(e,t))))}(i):null}getSymbolComplexitiesUsed(){const e=[];return this.symbols.forEach((t=>{Object(n.l)(t)&&e.push(t.complexity)})),e}initialize(){this._spatialReference=this.owner.view.spatialReference,this._set("featureStore",new Re({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,spatialReference:this._spatialReference,getSpatialIndex:()=>this.spatialIndex,forAllGraphics:e=>this.graphics3DGraphics.forEach(e)}))}async setup(e){this.setupAbortController=new AbortController;const t=this.setupAbortController.signal;this._set("elevationAlignment",e.elevationAlignment),this._set("scaleVisibility",e.scaleVisibility),this._set("filterVisibility",e.filterVisibility),this._set("deconflictor",e.deconflictor),this._set("labeler",e.labeler),this._set("objectStates",e.objectStates);const i=this.owner.view;this.viewElevationProvider=new _e(this._spatialReference,i),this.initializeStage(i,this.layer.uid),this.symbolCreationContext.sharedResources=i.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=i.sharedSymbolResources.addGraphicsOwner(this.owner),Object(n.l)(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=i.sharedSymbolResources.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=i.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerView=this.owner,this.symbolCreationContext.localOriginFactory=new yc.a(i.renderSpatialReference),this.symbolCreationContext.elevationProvider=i.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);const r=Object(Se.e)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await Object(Se.b)(r,this._spatialReference,Pc),Object(Y.u)(t),this.symbolCreationContext.screenSizePerspectiveEnabled=i.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled;const s="layer"in this.owner?["layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled"]:"view.screenSizePerspectiveEnabled";this._handles.add([this.watch("suspendedOrOutsideOfView",(()=>this._frameTask.reschedule((()=>this.updateLayerVisibility())))),this.owner.watch(s,(()=>{const e=i.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;var t;e!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=e,null==(t=this.labeler)||t.reset(),this.recreateAllGraphics())})),this.owner.watch("slicePlaneEnabled",(e=>this.slicePlaneEnabledChange(!!e))),this.owner.view.watch("pixelRatio",(()=>this.pixelRatioChange())),this.owner.view.watch("qualitySettings.physicallyBasedRenderingEnabled",(e=>this.physicalBasedRenderingChange(e))),Object(a.e)(i.basemapTerrain,"tilingScheme",(e=>{e.spatialReference.equals(this.symbolCreationContext.overlaySR)||(this.symbolCreationContext.overlaySR=i.basemapTerrain.spatialReference),this._handles.has("loaded-graphics")?this.recreateAllGraphics():this._handles.add([Object(a.b)(this.owner,"loadedGraphics","change",(e=>this.graphicsCollectionChanged(e)),(()=>this.recreateAllGraphics())),Object(a.b)(this.owner,"loadedGraphics","after-changes",(()=>this._signalUpdatingDuringAsyncLoadedGraphicsChange()),(()=>this._signalUpdatingDuringAsyncLoadedGraphicsChange()))],"loaded-graphics")})),Object(a.f)(this,"asyncUpdates",(()=>this.runTask(k.c)),!0),Object(a.a)(this,"effectiveUpdatePolicy",(e=>{Object(n.l)(this.stageLayer)&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=0===this.effectiveUpdatePolicy,1===e&&this.runTask(k.c)}),!0)]),this._frameTask=i.resourceController.scheduler.registerTask(k.b.GRAPHICS_CORE,this),this.owner.layer&&"featureReduction"in this.owner.layer&&this._handles.add(this.owner.watch("layer.featureReduction",(()=>this.deconflictor.featureReductionChange()))),this.notifyChange("averageSymbolComplexity");try{await this.rendererChange(this.layer.renderer)}catch{}Object(Y.u)(t),this.setupAbortController=null}abortSetup(){this.setupAbortController&&(this.setupAbortController.abort(),this.setupAbortController=null)}destroy(){this.abortSetup(),this.abortRendererChange(),this.abortElevationInfoChange(),this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._updatingPendingLoadedGraphicsChange=Object(n.s)(this._updatingPendingLoadedGraphicsChange),this.clear(),this.graphicStateTracking=Object(n.e)(this.graphicStateTracking),this.stage&&(this.stage.remove(this.stageLayer),this.stageLayer=null,this.stage=null),this._handles=Object(n.e)(this._handles),this._frameTask.remove(),this._frameTask=k.a,this._spatialReference=null,this._set("owner",null);for(const e in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[e].reject(new te.a("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle=Object(n.s)(this.sharedSymbolResourcesOwnerHandle),this.propertiesPool=Object(n.e)(this.propertiesPool),this.pendingUpdatesPool=null,this.symbolConversionCache.clear(),this.objectIdInvisibleSet.clear(),this._spatialIndex=Object(n.e)(this._spatialIndex),this._set("featureStore",Object(n.e)(this.featureStore))}clear(){var e,t;null==(e=this.objectStates)||e.allGraphicsDeleted(),Object(n.l)(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((e=>e.destroy())),null==(t=this._spatialIndex)||t.clear(),this.graphics3DGraphics.clear(),this.numberOfGraphics=0,this._usedMemory=0,this.updateLayerVisibility(),this.symbols.forEach(n.e),this.symbols.clear(),this.graphicsBySymbol.clear(),this.graphicsWithoutSymbol.clear(),this.graphicsWaitingForSymbol.clear(),this.pendingUpdates.clear(),this.pendingUpdatesPool.clear(),this.pendingAdds=0,this.pendingRemoves=0,this.notifyChange("updating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.featureStore.events.emit("changed")}initializeStage(e,t){this.stage=e._stage,this.stageLayer=new Oc.a({isPickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t),this.stage.add(this.stageLayer);const i=this.stageLayer.events;i.on("objectTransformation",(e=>this.notifyGraphicGeometryChanged(e.metadata.graphicUid))),i.on("visibilityChanged",(e=>this.notifyGraphicVisibilityChanged(e.metadata.graphicUid))),i.on("objectGeometryAdded",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid))),i.on("objectGeometryRemoved",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid))),i.on("vertexAttrsUpdated",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)))}notifyGraphicGeometryChanged(e){if(Object(n.k)(this.graphicStateTracking)||Object(n.k)(e))return;const t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicGeometry(t)}notifyGraphicVisibilityChanged(e){if(Object(n.k)(this.graphicStateTracking)||Object(n.k)(e))return;const t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicVisibility(t)}updateLayerVisibility(){const e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this.numberOfGraphics>e*Ac,i=!this.suspendedOrOutsideOfView&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this.hideAllGraphics()),this.updateStageLayerVisibility())}updateStageLayerVisibility(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)}getGraphics3DGraphicById(e){return this.graphics3DGraphics.get(e)}getGraphics3DGraphicByObjectId(e){var t;return null!=(t=this.owner.layer)&&t.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e,t=this.owner.layer&&this.owner.layer.objectIdField){return Object(se.e)(e,t)}get graphics3DGraphicsByObjectID(){const e=this.owner.layer&&this.owner.layer.objectIdField;if(!e)return null;const t=new Map;return this.graphics3DGraphics.forEach((i=>{if(!i)return;const r=i.graphic,a=this._getGraphicObjectID(r,e);Object(n.l)(a)&&t.set(a,i)})),t}get labelsEnabled(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())}async updateLabelingInfo(e){const t=this.deconflictor&&this.deconflictor.labelingInfoChange(e),i=this.labeler&&this.labeler.labelingInfoChange(e);await Object(Y.i)([t,i])}updateVisibilityInfo(){this.deconflictor&&this.deconflictor.labelingInfoChange(),this.labeler&&this.labeler.visibilityInfoChange()}get symbolUpdateType(){if(this.pendingUpdates.size>0)return"unknown";let e=0,t=0;return Object(re.c)(this.symbols,((i,r)=>{if(Object(n.l)(i)){const n=i.getFastUpdateStatus();if(n.loading>0)return!0;this.graphicsBySymbol.has(r)&&(t+=n.fast,e+=n.slow)}return!1}))?"unknown":t>=0&&0===e?"fast":e>=0&&0===t?"slow":"mixed"}runTask(e){this._frameTask.processQueue(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("updating"),this.notifyChange("updatingRemaining")}setObjectIdVisibility(e,t){t?this.objectIdInvisibleSet.delete(e):this.objectIdInvisibleSet.add(e);const i=this._findGraphics3DGraphicByObjectId(e);Object(n.l)(i)&&this._updateUserVisibility(i)}_findGraphics3DGraphicByObjectId(e){return Object(re.a)(this.graphics3DGraphics,(t=>this._getGraphicObjectID(t.graphic)===e))}_updateUserVisibility(e){if(Object(n.k)(e))return!1;const t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&(Object(n.k)(i)||!this.objectIdInvisibleSet.has(i));return e.setVisibilityFlag(0,r,0)}whenGraphics3DGraphic(e){const t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);const i=this.whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;const r=Object(Y.e)();return this.whenGraphics3DGraphicRequests[e.uid]=r,r.promise}async boundsForGraphics3DGraphic(e,t){const i=this._spatialReference,r=this.owner.view.renderSpatialReference,a=this.owner.view.basemapTerrain.spatialReference,s=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:Object(n.l)(t)&&t.useViewElevation,minDemResolution:Object(n.l)(t)&&t.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,o=await e.getProjectedBoundingBox(((e,t,n)=>Object(x.l)(e,r,t,e,i,t,n)),((e,t,r)=>Object(x.l)(e,a,t,e,i,t,r)),s,Object(n.j)(t,"signal"));if(!o)return null;const c=o.boundingBox;if(o.requiresDrapedElevation){const e=this.symbolCreationContext.elevationProvider;if(e){Object(j.d)(c,wc);const t=Object(n.u)(e.getElevation(wc[0],wc[1],0,i,"ground"),0);c[2]=Math.min(c[2],t),c[5]=Math.max(c[5],t)}}return{boundingBox:c,screenSpaceObjects:o.screenSpaceObjects}}async whenGraphicBounds(e,t){await Object(a.j)(this.owner,"loadedGraphics");const i=this.owner.layer&&this.owner.layer.objectIdField,r=this.owner.loadedGraphics.find((t=>t===e||i&&t.attributes&&e.attributes&&t.attributes[i]===e.attributes[i]));if(!r)throw new te.a("internal:graphic-not-part-of-view","Graphic is not part of this view");const n=await this.whenGraphics3DGraphic(r);return this.boundsForGraphics3DGraphic(n,t)}computeAttachmentOrigin(e,t){const i=this.graphics3DGraphics.get(e.uid);if(!i)return null;const r=i.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;Object(y.w)(Rc,0,0,0);let a=0;if(r.render.num>0){if(!Object(x.t)(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,Dc,t))return null;Object(y.f)(Rc,Rc,Dc),a++}if(r.draped.num>0){const[e,i]=r.draped.origin,s=Object(n.u)(this.viewElevationProvider.getElevation(e,i,"ground"),0);if(Object(y.w)(Dc,e,i,s),!Object(x.t)(Dc,this.viewElevationProvider.spatialReference,Dc,t))return null;Object(y.f)(Rc,Rc,Dc),a++}return a>1&&Object(y.e)(Rc,Rc,1/a),new xc.a({x:Rc[0],y:Rc[1],z:Rc[2],spatialReference:t})}getSymbolLayerSize(e,t){const i=this.symbols.get(e.id);if(Object(n.k)(i))throw new te.a("internal:symbol-not-part-of-view","Symbol is not part of this view");const r=e.symbolLayers.indexOf(t);if(-1===r)throw new te.a("internal:missing-symbol-layer","Symbol layer is not in symbol");const a=i.getSymbolLayerSize(r);if(null==a)throw new te.a("internal:missing-size","Symbol layer has no valid size");return a}graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}graphicUpdateHandler(e){const t=e.graphic.uid,i=this.graphics3DGraphics.get(t),r=this.graphicsWithoutSymbol.get(t);if(i||r)switch(e.property){case"visible":this.graphicUpdateVisibleHandler(i);break;case"geometry":this.graphicUpdateGeometryHandler(i,e);break;case"symbol":this.graphicUpdateSymbolHandler(i,e)}}graphicUpdateGeometryHandler(e,t){const i=t.graphic.geometry;if(Object(n.k)(i))return void this.recreateGraphic(t.graphic);if(Object(n.k)(e)){const e=t.graphic.symbol&&t.graphic.symbol.id;if(e){const t=this.symbols.get(e);if(Object(n.l)(t)&&0===t.loadStatus)return}return void this.recreateGraphic(t.graphic)}const r=e.graphics3DSymbol;!Object(n.k)(t.newValue)&&r.updateGeometry(e,t.newValue)||this.recreateGraphic(e.graphic),this.expandComputedExtent(i)}graphicUpdateSymbolHandler(e,t){const i=t.graphic,r=Object(n.l)(e)?e.graphics3DSymbol:Object(n.l)(t.oldValue)?this.symbols.get(t.oldValue.id):null;if(Object(n.k)(r)||Object(n.k)(t.newValue))return void this.recreateGraphic(i);const a=r.symbol,s=this.getConvertedSymbol(t.newValue);if(Object(n.l)(s)&&(s.type!==a.type||"web-style"===s.type)||"web-style"===a.type)return void this.recreateGraphic(i);const o=this.graphicsBySymbol.get(a.id);if(o&&1!==o.size)return void this.recreateGraphic(i);const c=Object(Z.a)(a,s);if(Object(n.k)(c))return void this.updateSymbolMapping(a.id,s);const l={diff:c,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),!Object(Z.d)(l.diff))return void this.recreateGraphic(i);const d=this._getRenderingInfo(i);if(Object(n.k)(d))return void this.recreateGraphic(i);const h=r.extentPadding;for(const n of l.symbolStatePatches)n();if(h!==r.extentPadding&&this.recomputeExtentPadding(),Object(n.l)(e))for(const n of l.graphics3DGraphicPatches)n(e,d);this.updateSymbolMapping(a.id,s)}graphicUpdateVisibleHandler(e){this._updateUserVisibility(e)&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}recreateGraphics(e){this.suspendSymbolCleanup=!0,this.remove(e),this.add(e),this.suspendSymbolCleanup=!1,1===this.effectiveUpdatePolicy&&this._cleanupSymbols()}recreateGraphic(e){this.recreateGraphics([e])}_beginGraphicUpdate(e){const t=this.graphicsUpdateId;return this.graphicsUpdateId++,this.graphicsWaitingForSymbol.set(e.uid,t),1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating"),t}_endGraphicUpdate(e){e&&(this.graphicsWaitingForSymbol.delete(e.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))}recomputeExtentPadding(){let e=0;this.symbols.forEach((t=>{Object(n.l)(t)&&(e=Math.max(e,t.extentPadding))})),this._set("extentPadding",e)}expandComputedExtent(e){const t=Cc,i=e.spatialReference;Object(se.c)(e,t);const r=this._spatialReference,n=vc.tmpVec;if(i.equals(r)||Object(x.v)(t[0],t[1],0,i,n,r)&&(t[0]=n[0],t[1]=n[1],Object(x.v)(t[3],t[4],0,i,n,r),t[3]=n[0],t[4]=n[1]),!(isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])))return;const a=this.computedExtent;let s=null;const o=isFinite(t[2])&&isFinite(t[5]),c=o&&(!a||null==a.zmin||t[2]<a.zmin),l=o&&(!a||null==a.zmax||t[5]>a.zmax);a?(t[0]<a.xmin||t[1]<a.ymin||t[3]>a.xmax||t[4]>a.ymax||c||l)&&(s=this.propertiesPool.get("computedExtent"),s.xmin=Math.min(t[0],a.xmin),s.ymin=Math.min(t[1],a.ymin),s.xmax=Math.max(t[3],a.xmax),s.ymax=Math.max(t[4],a.ymax),s.spatialReference=r):(s=this.propertiesPool.get("computedExtent"),s.xmin=t[0],s.ymin=t[1],s.xmax=t[3],s.ymax=t[4],s.spatialReference=r),s&&(c&&(s.zmin=t[2]),l&&(s.zmax=t[5]),this._set("computedExtent",s))}abortElevationInfoChange(){this.elevationInfoChangeAbortController&&(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)}async elevationInfoChange(){var e,t;this.abortElevationInfoChange();const i=new AbortController;this.elevationInfoChangeAbortController=i;const r=Object(Se.e)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await Object(Se.b)(r,this._spatialReference,Pc),Object(Y.u)(i),this.elevationInfoChangeAbortController=null,null==(e=this.labeler)||e.elevationInfoChange(),this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("elevationInfo",t)?t.forEach((e=>{const t=e.graphic,i=e.labelGraphics;for(const r of i)r.graphics3DSymbolLayer.updateGraphicElevationContext(t,r)})):this._recreateSymbol(i)})),this.updateStageLayerElevationProvider(),null==(t=this.elevationAlignment)||t.elevationInfoChange()}updateStageLayerElevationProvider(){this.stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this.numberOfGraphicsProvidingElevation>0&&(this.stageLayerElevationProvider=new oc({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))}clearSymbolsAndGraphics(){var e,t,i,r,n;this.clear(),null==(e=this.filterVisibility)||e.clear(),null==(t=this.labeler)||t.reset(),null==(i=this.deconflictor)||i.clear(),null==(r=this.elevationAlignment)||r.clear(),null==(n=this.stageLayer)||n.invalidateSpatialQueryAccelerator(),this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(e=!1){if(!this._startCreateGraphics)return;const{loadedGraphics:t,view:i}=this.owner,r=i.basemapTerrain.tilingScheme&&t&&t.length?t.toArray():null;!e&&r||this.clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),r&&(e?this.add(r):this.recreateGraphics(r))}_recreateSymbol(e){const t=this.graphicsBySymbol.get(e),i=[];t&&(t.forEach(((e,t)=>{var r;const n=e.usedMemory;this._conditionalRemove(e,t),null==(r=this._spatialIndex)||r.remove(e),i.push(e.graphic),e.destroy(),this.removeGraphics3DGraphic(t,n),this.updateLayerVisibility(),this.featureStore.events.emit("changed")})),this.graphicsBySymbol.set(e,new Map));const r=this.symbols.get(e);Object(n.e)(r),this.symbols.delete(e),this.add(i)}_recreateGraphicsForSymbol(e){const t=this.graphicsBySymbol.get(e);if(t){const e=[];t.forEach((t=>e.push(t.graphic))),this.recreateGraphics(e)}}_conditionalRemove(e,t){var i,r,a;this.graphicsDrapedUids.delete(t),null==(i=this.objectStates)||i.removeGraphic(e),null==(r=this.labeler)||r.removeGraphic(e),null==(a=this.deconflictor)||a.removeGraphic(e),Object(n.l)(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(e)}add(e){e&&0!==e.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(0===this._updatePolicyForGraphics(e)?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")):Pc.error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(e){if(1===this.effectiveUpdatePolicy&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const t of e)if(Object(n.l)(t.geometry)&&"mesh"===t.geometry.type&&!t.geometry.loaded)return 0;return this.effectiveUpdatePolicy}_addImmediate(e){this.geometryWarningLogged=!1,this.symbolWarningLogged=!1;for(const t of e)this._addGraphic(t,this._getRenderingInfo(t,Pc),1);this._cleanupSymbols(),this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()}_addDelayed(e){for(const t of e){const e=t.uid;let i=this.pendingUpdates.get(e);i?i.add?0!==i.state&&i.abortController.abort():this.pendingAdds++:(i=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(e,i)),i.add=t}this.notifyChange("running"),this.notifyChange("updatingRemaining")}remove(e){0===this.effectiveUpdatePolicy?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")}_removeImmediate(e){for(const t of e)this._removeGraphic(t);this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}_removeDelayed(e){for(const t of e){const e=t.uid,i=this.pendingUpdates.get(e);if(i)i.add&&(i.remove?i.add=null:this.pendingUpdates.delete(e),1===i.state&&i.abortController.abort(),this.pendingAdds--);else{const i=this.pendingUpdatesPool.pushNew();i.remove=t,this.pendingUpdates.set(e,i),this.pendingRemoves++}}0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining")}_finishPendingUpdates(){this.pendingUpdatesPool.clear(),this._cleanupSymbols(),(this.pendingAdds||this.pendingRemoves)&&Pc.warn("pendingAdds/Removes in inconsistent state!"),this.pendingAdds=0,this.pendingRemoves=0}_applyPendingUpdates(e){var t;if(this.geometryWarningLogged=!1,this.symbolWarningLogged=!1,0===this.pendingUpdates.size&&null!=(t=this._spatialIndex)&&t.updating)this._spatialIndex.update();else{for(const[t,i]of this.pendingUpdates){if(e.done)break;i.add&&0===i.state&&this._processPendingUpdateNew(i);let r=this.effectiveUpdatePolicy;if(!i.remove||i.add&&2!==i.state||(this.pendingRemoves--,e.madeProgress(),this._removeGraphic(i.remove),i.remove=null,r=1),i.add)switch(i.state){case 2:this._addGraphic(i.add,i.renderingInfo,r),i.add=null,this.pendingAdds--,e.madeProgress();break;case 3:i.add=null,this.pendingAdds--}null==i.remove&&null==i.add&&this.pendingUpdates.delete(t)}0===this.pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}}_processPendingUpdateNew(e){if(!e.add)return void(e.state=2);const t=e.add.geometry;Object(n.l)(t)&&"mesh"===t.type&&!t.loaded?this._processPendingUpdateNewMesh(e,t):this._processPendingUpdateNewRenderingInfo(e)}async _processPendingUpdateNewMesh(e,t){e.state=1,e.abortController=new AbortController;const i=e.abortController.signal;try{await t.load({signal:i})}catch(r){return this._processPendingUpdateNewError(e,r)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e)}_processPendingUpdateNewError(e,t){e.abortController=null,Object(Y.l)(t)?e.state=0:e.state=3}async _processPendingUpdateNewRenderingInfo(e){if(Object(n.k)(this.layer.renderer)||"dictionary"!==this.layer.renderer.type)return e.renderingInfo=this._getRenderingInfo(e.add,Pc),void(e.state=2);e.state=1,e.abortController=new AbortController;let t=null;try{t=await this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal})}catch(i){return e.abortController=null,void(Object(Y.l)(i)?e.state=0:e.state=3)}Object(n.k)(t)||Object(n.k)(t.symbol)?(Pc&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,Pc.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),e.renderingInfo=null):e.renderingInfo=t,e.state=2}_addGraphic(e,t,i){if(this.graphicsWithoutSymbol.set(e.uid,e),Object(n.k)(t)||Object(n.k)(t.symbol)||!Object(se.f)(e))return;const r=t.symbol,a=this.getOrCreateGraphics3DSymbol(r,t.renderer);if(Object(n.k)(a))return;this.expandComputedExtent(e.geometry);const s=this._beginGraphicUpdate(e),o=new De(e,t,this.layer);let c=!1;const l=e=>{e===a.symbol.id&&(c=!0)};this._whenSymbolRemoved.push(l);const d=()=>{if(!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(l),this.graphicsWaitingForSymbol.get(e.uid)!==s||c||a.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==a.symbol.id)--a.referenced;else{const t=this._createGraphics3DGraphic(a,o);this._spatialIndex&&Object(n.l)(t)&&this._spatialIndex.add(t),--a.referenced,this._endGraphicUpdate(e)}this.featureStore.events.emit("changed"),this.labeler&&this.owner.view.labeler.setDirty()}},h=t=>{this.destroyed||(this._whenSymbolRemoved.removeUnordered(l),c||(Object(Y.l)(t)?this.add([e]):a.destroyed||this._endGraphicUpdate(e)))};0===i?a.load((()=>this._frameTask.schedule(d)),(e=>this._frameTask.schedule((()=>h(e))))):a.load(d,h)}_removeGraphic(e){const t=e.uid,i=this.graphics3DGraphics.get(t);if(i){var r;i.graphics3DSymbol.onRemoveGraphic(i);const e=i.usedMemory,n=i.isElevationSource;this._conditionalRemove(i,t),null==(r=this._spatialIndex)||r.remove(i);const a=i.graphics3DSymbol.symbol.id;this.graphicsBySymbol.get(a).delete(t),this.graphicsWithoutSymbol.delete(t),this.removeGraphics3DGraphic(t,e,n),i.destroy(),this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(t),this.graphicsWaitingForSymbol.delete(t),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))}hasLabelingContext(e){if(e instanceof jc.a||e instanceof _c.a){const t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some((t=>t.symbol===e))}return!1}hasValidSymbolCreationContext(e){return!(e instanceof jc.a&&!this.hasLabelingContext(e))||(Pc.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)}_getRenderingInfo(e,t){const i=e.geometry;if(Object(n.k)(i))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!Object(x.b)(i.spatialReference,this._spatialReference))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&Object(n.l)(e.symbol))return t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?Object(Q.c)(e,this.layer):e;let a;return a=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||Object(n.l)(this.currentRenderer))?this.owner.getRenderingInfo(r,this.currentRenderer,Object(n.t)(this.arcadeOnDemand)):{symbol:r.symbol||xe(r.geometry)},Object(n.k)(a)||Object(n.k)(a.symbol)?(t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):a}_getRenderingInfoAsync(e,t){const i=e.geometry;if(Object(n.k)(i))return Pc&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,Pc.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&Object(n.l)(e.symbol))return Pc&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,Pc.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?Object(Q.c)(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,Object(n.t)(this.currentRenderer),Object(n.t)(this.arcadeOnDemand),t)}createGraphics3DSymbol(e,t){if(!this.hasValidSymbolCreationContext(e))return null;const i=this.getConvertedSymbol(e);if(!i)return null;let r;if(Object(n.l)(t)&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){const e=Object(je.a)(t.backgroundFillSymbol,{ignoreDrivers:!0});Object(n.l)(e.symbol)&&"web-style"!==e.symbol.type&&"cim"!==e.symbol.type&&(r=e.symbol.symbolLayers)}const a=function(e,t,i){let r;return r="point-3d"===e.type?Ko:Qo,new r(e,t,i)}(i,this.symbolCreationContext,r);return a.load((()=>{const e=a.extentPadding;e>this.extentPadding&&this._set("extentPadding",e),this.notifyChange("averageSymbolComplexity")}),(()=>{})),a}getOrCreateGraphics3DSymbol(e,t){let i=this.symbols.get(e.id);return void 0===i&&(i=e instanceof Sc.a?new ec(e,(e=>this._frameTask.schedule(e)),(e=>this.createGraphics3DSymbol(e,t))):this.createGraphics3DSymbol(e,t),this.symbols.set(e.id,i)),Object(n.l)(i)&&++i.referenced,i}trackGraphicState(e){return Object(n.k)(this.graphicStateTracking)&&(this.graphicStateTracking=new tc(this)),this.graphicStateTracking.add(e)}addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this.numberOfGraphics++,e.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this.updateLayerVisibility()}removeGraphics3DGraphic(e,t,i=!1){this._usedMemory-=t,this.graphics3DGraphics.delete(e),this.numberOfGraphics--,i&&(this.numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this.updateLayerVisibility()}_createGraphics3DGraphic(e,t){var i,r,a,s;const o=t.graphic;if(this.graphicsWithoutSymbol.delete(o.uid),!this.symbols.has(e.symbol.id))return this.add([o]),null;if(this.graphics3DGraphics.has(o.uid))return null;const c=e.createGraphics3DGraphic(t);if(Object(n.k)(c))return null;this.addGraphics3DGraphic(c);const l=e.symbol.id;this.graphicsBySymbol.has(l)||this.graphicsBySymbol.set(l,new Map),this.graphicsBySymbol.get(l).set(o.uid,c),c.isDraped&&this.graphicsDrapedUids.add(o.uid),c.centroid=null,Object(n.l)(o.geometry)&&"point"!==o.geometry.type&&(c.centroid=Object(Ge.a)(o.geometry,this._spatialReference)),this._updateUserVisibility(c),Object(n.l)(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(c),null==(i=this.filterVisibility)||i.updateVisibility(c),null==(r=this.deconflictor)||r.addGraphic(c),null==(a=this.labeler)||a.addGraphic(c),null==(s=this.objectStates)||s.addGraphic(c),this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,c),c.initialize(this.stage,this.stageLayer,this.owner),Object(n.l)(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(c);const d=this.whenGraphics3DGraphicRequests[o.uid];return d&&(delete this.whenGraphics3DGraphicRequests[o.uid],d.resolve(c)),c}abortRendererChange(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)}async rendererChange(e){if(this.abortRendererChange(),e!==this.currentRenderer)if(this.validateRenderer(e),Object(n.k)(e)&&this.currentRendererChange(null,!1),Object(oe.a)(e))if(Object(n.l)(e)&&e.arcadeRequired){const t=new AbortController;this.rendererChangeAbortController=t;const{arcadeUtils:i}=await this.ensureArcade();Object(Y.u)(t),i.hasGeometryOperations(e)&&(await i.enableGeometryOperations(),Object(Y.u)(t)),0===this.effectiveUpdatePolicy?await this._frameTask.schedule((()=>this.currentRendererChange(e,!0)),t.signal):this.currentRendererChange(e,!0),this.rendererChangeAbortController=null}else if(0===this.effectiveUpdatePolicy){const t=new AbortController;this.rendererChangeAbortController=t,await this._frameTask.schedule((()=>this.currentRendererChange(e,!1)),t.signal),this.rendererChangeAbortController=null}else this.currentRendererChange(e,!1);else this.currentRendererChange(e,!1)}async ensureArcade(){return Object(n.k)(this.arcadeOnDemand)?(this.arcadeOnDemand=await Object(ce.e)(),this.arcadeOnDemand):this.arcadeOnDemand}currentRendererChange(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=Object(n.t)(this.arcadeOnDemand);const i=this.symbolCreationContext.renderer;if(e===i)return;if(this.symbolConversionCache.clear(),Object(n.k)(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const r=Object(Z.a)(i,e);this.updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,Object(n.k)(r)||("complete"===r.type?this.recreateAllGraphicsAndSymbols():"partial"===r.type&&(this.applyRendererDiff(r,e,i)?this.volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}diffHasSymbolChange(e){for(const t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1}applySymbolSetDiff(e,t,i){e=e||[],t=t||[];const r=[];for(const a of t){const t=this.graphicsBySymbol.get(a.id);t&&t.forEach(((s,o)=>{const c=s.graphic,l=this.layer instanceof X.a?this.layer:null,d=Object(n.t)(this.arcadeOnDemand);if(a===i.defaultSymbol&&i.getSymbol(Object(Q.c)(c,l),{arcade:d})===i.defaultSymbol)return;const h=s.usedMemory;e.length||i.defaultSymbol?r.push(c):this.graphicsWithoutSymbol.set(o,c);const u=this.graphics3DGraphics.get(o);this._conditionalRemove(u,o),s.destroy(),t.delete(o),this.removeGraphics3DGraphic(o,h),this.updateLayerVisibility()})),this._whenSymbolRemoved.forAll((e=>e(a.id)))}(e.length||r.length)&&(this.graphicsWithoutSymbol.forEach((e=>r.push(e))),this.graphicsWithoutSymbol.clear(),this.add(r)),this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}applyUniqueValueRendererDiff(e,t,i){const r=e.diff.defaultSymbol,n=e.diff.uniqueValueInfos;if(r||n){const a=n?n.added.map((e=>e.symbol)):[],s=n?n.removed.map((e=>e.symbol)):[];if(n)for(let e=0;e<n.changed.length;e++)a.push(n.changed[e].newValue.symbol),s.push(n.changed[e].oldValue.symbol);return r?(i.defaultSymbol&&s.push(i.defaultSymbol),t.defaultSymbol&&a.push(t.defaultSymbol)):i.defaultSymbol&&a.length&&s.push(t.defaultSymbol),this.applySymbolSetDiff(a,s,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}calculateUnchangedSymbolMapping(e,t,i){const r=e=>Object(n.l)(e)?e.id:null;if(t instanceof ee.a&&i instanceof ee.a&&(Object(n.k)(e)||"partial"===e.type)){const n=e&&e.diff,a=n&&n.defaultSymbol,s=n&&n.uniqueValueInfos;let o;return o=s?s.unchanged.map((e=>({oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)}))):i.uniqueValueInfos.map(((e,i)=>({oldId:r(e.symbol),newId:r(t.uniqueValueInfos[i].symbol)}))),!a&&i.defaultSymbol&&o.push({oldId:r(i.defaultSymbol),newId:r(t.defaultSymbol)}),o}return[]}updateSymbolMapping(e,t){const i=Object(n.l)(t)&&t?"string"==typeof t?t:t.id:null,r="string"==typeof t?null:t;if(!e||e===i)return;const a=this.graphicsBySymbol.get(e);this.graphicsBySymbol.delete(e),void 0!==a&&this.graphicsBySymbol.set(i,a);const s=this.symbols.get(e);void 0!==s&&(this.symbols.delete(e),this.symbols.set(i,s),Object(n.l)(s)&&(Object(n.l)(r)?s.symbol=r:s.symbol.id=i))}updateUnchangedSymbolMappings(e,t,i){const r=this.calculateUnchangedSymbolMapping(e,t,i);for(const{oldId:n,newId:a}of r)this.updateSymbolMapping(n,a)}applyRendererDiff(e,t,i){if(this.diffHasSymbolChange(e))return!1;if(t instanceof ee.a&&i instanceof ee.a&&this.applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)return!0;for(const[r]of this.graphicsBySymbol){const i=this.symbols.get(r);if(Object(n.l)(i))switch(i.applyRendererDiff(e,t)){case 0:this._recreateSymbol(r);break;case 1:this._recreateGraphicsForSymbol(r)}}return!0}opacityChange(){this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("opacity",t))),this.updateStageLayerVisibility()}slicePlaneEnabledChange(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("slicePlaneEnabled",t))),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange())}physicalBasedRenderingChange(e){e!==this.symbolCreationContext.physicalBasedRenderingEnabled&&(this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("physicalBasedRenderingEnabled",t)||this._recreateSymbol(i)})))}pixelRatioChange(){this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("pixelRatio",t)||this._recreateSymbol(i)}))}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=Object(ae.b)((()=>{this._updatingPendingLoadedGraphicsChange=null}))}setClippingExtent(e,t){const i=this.symbolCreationContext.clippingExtent,r=Object(_.l)();return function(e,t,i){if(Object(n.k)(e)||Object(n.k)(i))return!1;let r=!0;return fc[0]=null!=e.xmin?e.xmin:0,fc[1]=null!=e.ymin?e.ymin:0,fc[2]=null!=e.zmin?e.zmin:0,r=r&&Object(x.l)(fc,e.spatialReference,0,fc,i,0,1),t[0]=fc[0],t[1]=fc[1],fc[0]=null!=e.xmax?e.xmax:0,fc[1]=null!=e.ymax?e.ymax:0,fc[2]=null!=e.zmax?e.zmax:0,r=r&&Object(x.l)(fc,e.spatialReference,0,fc,i,0,1),t[2]=fc[0],t[3]=fc[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),r}(e,r,t)?this.symbolCreationContext.clippingExtent=Object(j.o)(Object(j.f)(),r):this.symbolCreationContext.clippingExtent=null,!Object(j.i)(this.symbolCreationContext.clippingExtent,i)}modifyGraphics3DGraphicVisibilities(e){let t=!1;this.graphics3DGraphics.forEach((i=>{e(i)&&(t=!0)})),t&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}forEachGraphics3DSymbol(e){for(const[t,i]of this.symbols){if(Object(n.k)(i))return;e(i,this.graphicsBySymbol.get(t)||Mc,t)}}updateAllGraphicsVisibility(){this.filterVisibility&&(this.filterVisibility.dirty=!0),this.modifyGraphics3DGraphicVisibilities((e=>{const t=this._updateUserVisibility(e),i=Object(n.l)(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(e);return t||i}))}hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(0,!1,0)))}validateRenderer(e){const t=Object(oe.b)(e);if(t){const e=`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`;Pc.warn(e,t.message)}}volatileGraphicsUpdated(){var e;null==(e=this.labeler)||e.reset(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")}_cleanupSymbols(){if(this.graphicsWaitingForSymbol.size>0||this.suspendSymbolCleanup)return;let e=!1;this.symbols.forEach(((t,i)=>{if(Object(n.k)(t)||t.referenced>0)return;const r=this.graphicsBySymbol.get(i);r&&0!==r.size||(this.graphicsBySymbol.delete(i),this.symbols.delete(i),Object(n.e)(t),e=!0)})),e&&(this.recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}snapshotInternals(){return{graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this.symbols.keys()].sort(),graphicsBySymbol:[...this.graphicsBySymbol.keys()].sort().map((e=>({symbolId:e,graphics:[...this.graphicsBySymbol.get(e).keys()].sort()}))),graphicsWithoutSymbol:[...this.graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this.graphicsDrapedUids].sort(),pendingUpdates:this.pendingUpdates}}get test(){return{symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size,forceUpdatePolicy:e=>{this.forcedUpdatePolicy=e}}}get performanceInfo(){return{visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}}};Tc.tmpVec=Object(O.f)(),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"computedExtent",void 0),Object(r.a)([Object(s.b)()],Tc.prototype,"currentRenderer",void 0),Object(r.a)([Object(s.b)()],Tc.prototype,"rendererHasGeometryOperations",void 0),Object(r.a)([Object(s.b)()],Tc.prototype,"_frameTask",void 0),Object(r.a)([Object(s.b)()],Tc.prototype,"rendererChangeAbortController",void 0),Object(r.a)([Object(s.b)()],Tc.prototype,"elevationInfoChangeAbortController",void 0),Object(r.a)([Object(s.b)()],Tc.prototype,"setupAbortController",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"elevationAlignment",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"scaleVisibility",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"filterVisibility",void 0),Object(r.a)([Object(s.b)()],Tc.prototype,"_spatialIndex",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"extentPadding",void 0),Object(r.a)([Object(s.b)()],Tc.prototype,"_updatingPendingLoadedGraphicsChange",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"featureStore",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"deconflictor",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"labeler",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"objectStates",void 0),Object(r.a)([Object(s.b)()],Tc.prototype,"preferredUpdatePolicy",void 0),Object(r.a)([Object(s.b)()],Tc.prototype,"forcedUpdatePolicy",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"effectiveUpdatePolicy",null),Object(r.a)([Object(s.b)({constructOnly:!0})],Tc.prototype,"elevationFeatureExpressionEnabled",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Tc.prototype,"owner",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Tc.prototype,"layer",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Tc.prototype,"graphicSymbolSupported",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Tc.prototype,"getRenderingInfoWithoutRenderer",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"updating",null),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"running",null),Object(r.a)([Object(s.b)({readOnly:!0})],Tc.prototype,"suspendedOrOutsideOfView",null),Object(r.a)([Object(s.b)({readOnly:!0,dependsOn:[]})],Tc.prototype,"updatingRemaining",null),Object(r.a)([Object(s.b)({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],Tc.prototype,"displayFeatureLimit",null),Object(r.a)([Object(s.b)({readOnly:!0,dependsOn:[]})],Tc.prototype,"averageSymbolComplexity",null),Object(r.a)([Object(s.b)({constructOnly:!0})],Tc.prototype,"hasZ",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Tc.prototype,"hasM",void 0),Tc=vc=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.Graphics3DCore")],Tc);class Ec{constructor(){this.add=null,this.renderingInfo=null,this.state=0,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=0,this.abortController=null,this.remove=null}}const Ac=10,Rc=Object(O.f)(),Dc=Object(O.f)(),Mc=new Map;class Ic{constructor(){this._extents=new ne.a({allocator:e=>e||Object(_.l)()}),this._tmpExtent=Object(_.l)(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this.contains(e)||(this.removeContained(e),Object(_.k)(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this.mergeTight(),this._extents.pop()}merge(e){return this.mergeTight(e),e.hasProgressed}mergeTight(e=k.c){const t=this._extents,i=new Set;let r=0;for(;r!==t.length;){t.sort(((e,t)=>e[0]-t[0])),r=t.length,i.clear();for(let r=0;r<t.length;++r){if(e.done)return;const n=t.getItemAt(r);for(let e=r+1;e<t.length;++e){const r=t.getItemAt(e);if(r[0]>=n[2])break;i.add(r)}i.forEach((r=>{if(n===r)return;if(r[2]<=n[0])return void i.delete(r);const a=Object(_.c)(n),s=Object(_.c)(r),o=this._tmpExtent;Object(_.n)(n,r,o);const c=a+s;(Object(_.c)(o)-c)/c<.05&&(Object(_.k)(n,o),i.delete(r),t.remove(r),e.madeProgress())})),i.add(n)}}this._dirty=!1}contains(e){return this._extents.some((t=>Object(_.f)(t,e)))}removeContained(e){this._extents.filterInPlace((t=>!Object(_.f)(e,t)))}get test(){const e=this;return{containsPoint:t=>e._extents.some((e=>Object(_.g)(e,t)))}}}let zc=class extends u.a{constructor(){super(...arguments),this.dirtyExtents=new Ic,this.globalDirty=!1,this.averageExtentUpdateSize=0,this.dirtyGraphicsSet=new Set,this.handles=new p.a,this.updateElevation=!1,this.layerView=null,this.graphicsCore=null,this.events=new we.a}setup(e,t,i,r){this.layerView=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=i,this.elevationProvider=r;const n=this.layerView.view.resourceController.scheduler;this.handles.add([r.on("elevation-change",(e=>this._elevationChanged(e))),this.layerView.watch("suspended",(()=>this.suspendedChange())),n.registerTask(k.b.ELEVATION_ALIGNMENT,this)])}destroy(){this.dirtyGraphicsSet.clear(),this.handles.destroy(),this.handles=null,this.layerView=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null}clear(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating")}suspendedChange(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this.globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty}get updatingRemaining(){return this.dirtyGraphicsSet.size+this.dirtyExtents.size*this.averageExtentUpdateSize}runTask(e){for(this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress()),e.run((()=>this.dirtyExtents.merge(e)));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.layerView.view.deconflictor.setDirty(),this.notifyChange("updating")}_updateDirtyGraphics(e){const t=this.layerView.view.renderCoordsHelper,i=0===this.graphicsCore.effectiveUpdatePolicy;for(const r of this.dirtyGraphicsSet.keys()){const a=this.graphicsCore.getGraphics3DGraphicById(r);if(this.dirtyGraphicsSet.delete(r),Object(n.l)(a)&&(a.alignWithElevation(this.elevationProvider,t,i),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this.dirtyExtents.empty&&!e.done;){const t=this.dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});const r=this.dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,i,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);Object(n.l)(t)&&t.needsElevationUpdates()&&this.dirtyGraphicsSet.add(e)})),this.averageExtentUpdateSize=.1*(this.dirtyGraphicsSet.size-r)+.9*this.averageExtentUpdateSize,e.madeProgress()}}markAllGraphicsElevationDirty(){this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this.dirtyGraphicsSet.add(t)))}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:t,spatialReference:i}=e;if(this.layerView.suspended){if(!this.updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this.updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i})}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.notifyChange("updating")}};Object(r.a)([Object(s.b)({readOnly:!0})],zc.prototype,"updating",null),Object(r.a)([Object(s.b)({readOnly:!0})],zc.prototype,"updatingRemaining",null),zc=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],zc);const Lc=zc;var Fc=i(162);class Vc{constructor(){this.items=[]}addObject(e,t){this.items.push({type:0,objectStateId:t,object:e})}addRenderGeometry(e,t,i){this.items.push({type:1,objectStateId:t,renderGeometry:e,owner:i})}addExternal(e,t){this.items.push({type:2,objectStateId:t,remove:e})}remove(e){for(let t=this.items.length-1;t>=0;--t){const i=this.items[t];i.objectStateId===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}removeObject(e){for(let t=this.items.length-1;t>=0;--t){const i=this.items[t];0===i.type&&i.object===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}removeRenderGeometry(e){for(let t=this.items.length-1;t>=0;--t){const i=this.items[t];1===i.type&&i.renderGeometry===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}removeAll(){this.items.forEach((e=>{this._removeObjectStateItem(e)})),this.items=[]}_removeObjectStateItem(e){switch(e.type){case 0:0===e.objectStateId.channel?e.object.removeHighlight(e.objectStateId):1===e.objectStateId.channel&&e.object.removeOcclude(e.objectStateId);break;case 1:e.owner.removeRenderGeometryObjectState(e.renderGeometry,e.objectStateId);break;case 2:e.remove(e.objectStateId)}}}class Gc{constructor(e,t){this.stateType=e,this.objectIdField=t,this.objectStateSet=new Vc,this.ids=new Set,this.paused=!1}hasGraphic(e){if(this.objectIdField){const t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)}}class Uc{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this._stateSets&&this._stateSets.forEach((e=>e.objectStateSet.removeAll())),this._stateSets=null}acquireSet(e,t){const i=new Gc(e,t);this._stateSets.push(i);const r=Object(Fc.c)((()=>this.releaseSet(i)));return{set:i,handle:r}}releaseSet(e){e.objectStateSet.removeAll();const t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}_addObjectStateSet(e,t){e.addObjectStateSet(t.stateType,t.objectStateSet)}_removeObjectStateSet(e,t){e.removeObjectState(t.objectStateSet)}setUid(e,t){e.ids.add(t);const i=this._graphicsCore.graphics3DGraphics.get(t);i&&this._addObjectStateSet(i,e)}setUids(e,t){t.forEach((t=>this.setUid(e,t)))}setObjectIds(e,t){t.forEach((t=>e.ids.add(t))),this.initializeSet(e)}addGraphic(e){this._stateSets.forEach((t=>{!t.paused&&t.hasGraphic(e)&&this._addObjectStateSet(e,t)}))}removeGraphic(e){this._stateSets.forEach((t=>{t.hasGraphic(e)&&this._removeObjectStateSet(e,t)}))}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((e=>e.objectStateSet.removeAll()))}initializeSet(e){const t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach((t=>{t&&e.hasGraphic(t)&&this._addObjectStateSet(t,e)})):e.ids.forEach((i=>{const r=t.get(i);r&&this._addObjectStateSet(r,e)}))}get test(){return{states:this._stateSets}}}var Bc=i(546);let Nc=class extends u.a{constructor(){super(...arguments),this._scaleRangeActive=!1,this.layerScaleRangeVisibilityQuery=!1,this.handles=new p.a,this.layerView=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.extent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this.updating=!0}setup(e,t,i,r,n){this.layerView=e,this.layer=t,this.queryGraphicUIDsInExtent=i,this.graphicsCore=r,this.basemapTerrain=n,this.updateScaleRangeActive();const a=this.layerView.view.resourceController.scheduler;this.handles.add(a.registerTask(k.b.SCALE_VISIBILITY,this))}destroy(){this.handles.destroy(),this.handles=null,this.layerView=null,this.extent=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this.extent=e,this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const e=this.layer;let t=this.layerScaleEnabled&&kc(e.minScale,e.maxScale);e.labelingInfo&&!t&&(t=e.labelingInfo.some((e=>e&&kc(e.minScale,e.maxScale))));const i=this._scaleRangeActive!==t;return this._scaleRangeActive=t,t&&!this.handles.has(Hc)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",(e=>this.scaleUpdateHandler(e))),Hc),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",(()=>this._setDirty())),Hc)):!t&&this.handles.has(Hc)&&this.handles.remove(Hc),i}get running(){return!(!this.layerView.view.basemapTerrain||!this.updating)}runTask(){const e=this.layerView.view.basemapTerrain;this.extent&&e&&e.ready&&this._scaleRangeActive&&this.layerScaleEnabled?this.layerScaleRangeVisibilityQuery||(this.layerScaleRangeVisibilityQuery=!0,e.queryVisibleScaleRange(this.extent,this.layer.minScale,this.layer.maxScale,(e=>this.finishUpdate(e)))):this.finishUpdate(!0)}finishUpdate(e){this.layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._set("updating",!1)}visibleAtLayerScale(e){return!this.layerScaleEnabled||Object(Bc.b)(e,this.layer.minScale||0,this.layer.maxScale||0)}visibleAtLabelScale(e,t){return Object(Bc.b)(e,t.minScale||0,t.maxScale||0)}graphicScale(e){let t;return Object(n.l)(e.centroid)?t=e.centroid:Object(n.l)(e.graphic.geometry)&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.layerView.view.basemapTerrain?this.layerView.view.basemapTerrain.getScale(t):1:null}graphicVisible(e){if(!this.layerScaleEnabled)return!0;const t=this.graphicScale(e);return this.visibleAtLayerScale(t)}updateVisibility(e){if(this._scaleRangeActive){const t=this.graphicVisible(e);return e.setVisibilityFlag(1,t,0)}return!1}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive)return!1;if(!e.labelGraphics||0===e.labelGraphics.length)return!1;const t=this.graphicScale(e),i=this.updateLabelScaleVisibility(e,t);return i&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty()),i}updateLabelScaleVisibility(e,t){if(!e.labelGraphics||0===e.labelGraphics.length)return!1;const i=e.labelGraphics[0]._labelClass;if(i&&null!=i.minScale&&null!=i.maxScale){const r=this.visibleAtLabelScale(t,i);if(e.setVisibilityFlag(1,r,1))return!0}return!1}scaleUpdateHandler(e){if(this._setDirty(),this.layerView.suspended)return;const t=e.extent,i=e.scale,r=this.visibleAtLayerScale(i);let a=!1;this.queryGraphicUIDsInExtent(t,e.spatialReference,(e=>{const s=this.graphicsCore.getGraphics3DGraphicById(e);if(Object(n.k)(s))return;const o=s.centroid;Object(n.l)(o)&&(t[0]>o.x||t[1]>o.y||t[2]<o.x||t[3]<o.y)||(s.setVisibilityFlag(1,r,0)&&(a=!0),this.updateLabelScaleVisibility(s,i)&&(a=!0))})),a&&(this.layerView.view.deconflictor.setDirty(),this.layerView.view.labeler.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(1))):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}};function kc(e,t){return e>0||t>0}Object(r.a)([Object(s.b)({constructOnly:!0})],Nc.prototype,"layerScaleEnabled",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Nc.prototype,"suspended",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Nc.prototype,"updating",void 0),Nc=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],Nc);const Hc="terrain-events",qc=Nc;var Wc=i(264);let $c=class extends u.a{constructor(e){super(e),this.graphicsCore=null,this.elevationAlignment=new Lc,this.watchUpdatingTracking=new Wc.a,this.handles=new p.a,this.suspendResumeExtent=null}normalizeCtorArgs(e){let t=null;e.scaleVisibilityEnabled&&(delete(e={...e}).scaleVisibilityEnabled,t=new qc);const i=new Tc({owner:e.owner,layer:e.layer,preferredUpdatePolicy:1,graphicSymbolSupported:!0});return{...e,graphicsCore:i,scaleVisibility:t}}initialize(){const e=this.scaleVisibility;Object(n.l)(e)&&"minScale"in this.layer&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",(()=>e.layerMinMaxScaleChangeHandler())),"elevationInfo"in this.layer&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",((e,t)=>{Object(Z.a)(e,t)&&this.watchUpdatingTracking.addPromise(this.graphicsCore.elevationInfoChange())}))}async setup(){const e=(e,t,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i);if(this.elevationAlignment.setup(this.owner,e,this.graphicsCore,this.view.elevationProvider),Object(n.l)(this.scaleVisibility)&&"minScale"in this.layer){const t=this.owner.view.basemapTerrain;this.scaleVisibility.setup(this.owner,this.layer,e,this.graphicsCore,t)}this._set("objectStates",new Uc(this.graphicsCore));try{await this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,objectStates:this.objectStates})}catch(t){if(Object(Y.l)(t))return;throw t}this.destroyed||(this.handles.add(this.view.watch("clippingArea",(()=>this.updateClippingExtent()),!0)),this.updateClippingExtent(),this.setupSuspendResumeExtent(),this.graphicsCore.startCreateGraphics())}destroy(){this.handles=Object(n.e)(this.handles),this.watchUpdatingTracking.destroy(),this._set("elevationAlignment",Object(n.e)(this.elevationAlignment)),this._set("scaleVisibility",Object(n.e)(this.scaleVisibility)),this._set("objectStates",Object(n.e)(this.objectStates)),this._set("graphicsCore",Object(n.e)(this.graphicsCore))}get suspended(){return!(!Object(n.l)(this.scaleVisibility)||!this.scaleVisibility.suspended)}get updating(){var e,t;return!!(null!=(e=this.graphicsCore)&&e.updating||Object(n.l)(this.scaleVisibility)&&this.scaleVisibility.updating||null!=(t=this.watchUpdatingTracking)&&t.updating)}getGraphicFromGraphicUid(e){if(this.owner.loadedGraphics){const t=this.owner.loadedGraphics.find((t=>t.uid===e));if(t){const e=this.layer instanceof X.a?this.layer:null;return Object(Q.c)(t,e)}}}whenGraphicBounds(e,t){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(e,t):Promise.reject()}computeAttachmentOrigin(e,t){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(e,t):null}getSymbolLayerSize(e,t){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(e,t):null}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet(1,null);return this.objectStates.setUid(t,e.uid),i}highlight(e){if(e instanceof J.a)return Yc;if("number"==typeof e)return this.highlight([e]);if(e instanceof W.a)return this.highlight([e]);if(e instanceof $.a&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof W.a){const t=e.map((e=>e.uid)),{set:i,handle:r}=this.objectStates.acquireSet(0,null);return this.objectStates.setUids(i,t),r}if("number"==typeof e[0]){const t=e,{set:i,handle:r}=this.objectStates.acquireSet(0,null);return this.objectStates.setObjectIds(i,t),r}}return Yc}updateClippingExtent(){const e=this.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()}updateSuspendResumeExtent(){Object(n.k)(this.scaleVisibility)||(this.suspendResumeExtent=Object(Ge.e)(this.graphicsCore.computedExtent,this.suspendResumeExtent,K.a,this.graphicsCore.extentPadding),this.scaleVisibility.setExtent(this.suspendResumeExtent))}setupSuspendResumeExtent(){Object(n.k)(this.scaleVisibility)||(Object(a.a)(this.graphicsCore,"computedExtent",(e=>this.updateSuspendResumeExtent()),!0),this.graphicsCore.watch("extentPadding",(e=>this.updateSuspendResumeExtent())))}};Object(r.a)([Object(s.b)({constructOnly:!0})],$c.prototype,"owner",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],$c.prototype,"layer",void 0),Object(r.a)([Object(s.b)({readOnly:!0,aliasOf:"owner.view"})],$c.prototype,"view",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],$c.prototype,"graphicsCore",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],$c.prototype,"scaleVisibility",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],$c.prototype,"elevationAlignment",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],$c.prototype,"objectStates",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],$c.prototype,"watchUpdatingTracking",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],$c.prototype,"suspended",null),Object(r.a)([Object(s.b)({readOnly:!0})],$c.prototype,"updating",null),$c=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.Graphics3DGraphicLikeLayerView")],$c);const Yc={remove(){},pause(){},resume(){}},Zc=$c;var Xc=i(164),Qc=i(1161);var Jc=i(438);let Kc=class extends(h(Jc.a)){constructor(){super(...arguments),this.type="graphics-3d",this.frustumVisibility=new q,this.slicePlaneEnabled=!1,this.drapeSourceType=1,this.suspendResumeExtent=null,this.fullExtentInLocalViewSpatialReference=null}initialize(){this._set("graphics3d",new Zc({owner:this,layer:this.layer,scaleVisibilityEnabled:!0})),this.graphics3d.setup(),this.frustumVisibility.setup(this),this.setupSuspendResumeExtent(),this.updatingHandles.add(this,"fullOpacity",(()=>this.graphics3d.graphicsCore.opacityChange())),this.handles.add(this.layer.on("graphic-update",(e=>this.graphics3d.graphicsCore.graphicUpdateHandler(e)))),this.addResolvingPromise(function(e){const t=e.view.spatialReference,i=e.layer.fullExtent,r=Object(n.l)(i)&&i.spatialReference;if(Object(n.k)(i)||!r)return Promise.resolve(null);if(r.equals(t))return Promise.resolve(i.clone());const a=Object(Xc.d)(i,t);return Object(n.l)(a)?Promise.resolve(a):e.view.state.isLocal?Object(Qc.projectGeometry)(i,t,e.layer.portalItem).then((t=>!e.destroyed&&t?t:void 0)).catch((()=>null)):Promise.resolve(null)}(this).then((e=>this.fullExtentInLocalViewSpatialReference=e))),this.layer.internal?this.notifyChange("updating"):this.handles.add(Object(a.l)(this.view,"basemapTerrain.ready",(()=>this.notifyChange("updating"))))}destroy(){this.frustumVisibility&&(this.frustumVisibility.destroy(),this._set("frustumVisibility",null)),this.graphics3d&&(this.graphics3d.destroy(),this._set("graphics3d",null))}get legendEnabled(){return this.canResume()&&!this.frustumVisibility.suspended}get suspendInfo(){var e;const t={};return Object(n.l)(this.graphics3d.scaleVisibility)&&this.graphics3d.scaleVisibility.suspended&&(t.outsideScaleRange=!0),t.outsideOfView=!(null==(e=this.frustumVisibility)||!e.suspended),t}async fetchPopupFeatures(e,t){return Object(n.l)(t)?t.clientGraphics:null}notifyGraphicGeometryChanged(e){this.graphics3d.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphics3d.graphicsCore.notifyGraphicVisibilityChanged(e)}get graphics3DGraphics(){return this.graphics3d.graphicsCore.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphics3d?this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID:null}get symbolUpdateType(){return this.graphics3d.graphicsCore.symbolUpdateType}getGraphicFromGraphicUid(e){return this.graphics3d.getGraphicFromGraphicUid(e)}whenGraphicBounds(e,t){return this.graphics3d.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphics3d?this.graphics3d.graphicsCore.computeAttachmentOrigin(e,t):null}getSymbolLayerSize(e,t){return this.graphics3d.getSymbolLayerSize(e,t)}queryGraphics(){return Promise.resolve(this.loadedGraphics)}maskOccludee(e){return this.graphics3d.maskOccludee(e)}highlight(e){return this.graphics3d.highlight(e)}get updatePolicy(){var e;return(null==(e=this.graphics3d)?void 0:e.graphicsCore.effectiveUpdatePolicy)||1}canResume(){var e;return super.canResume()&&!(null!=(e=this.graphics3d)&&e.suspended)}isUpdating(){var e,t;return!(!(this.graphics3d&&this.graphics3d.updating||this.frustumVisibility&&this.frustumVisibility.updating)&&(this.layer.internal||null!=(e=this.view)&&null!=(t=e.basemapTerrain)&&t.ready))}setupSuspendResumeExtent(){const e=()=>{this.suspendResumeExtent=Object(Ge.e)(this.graphics3d.graphicsCore.computedExtent,this.suspendResumeExtent,1.2,this.graphics3d.graphicsCore.extentPadding),this.frustumVisibility.setExtent(this.suspendResumeExtent)};Object(a.a)(this.graphics3d.graphicsCore,"computedExtent",(()=>e()),!0),Object(a.d)(this.graphics3d.graphicsCore,"extentPadding",(()=>e()),!0)}get performanceInfo(){return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:-1,totalNumberOfFeatures:-1,nodes:0,core:null,updating:this.updating,elevationUpdating:this.graphics3d.elevationAlignment.updating,visibilityFrustum:!this.frustumVisibility.suspended}}};Object(r.a)([Object(s.b)({aliasOf:"layer.graphics"})],Kc.prototype,"loadedGraphics",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Kc.prototype,"suspended",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Kc.prototype,"legendEnabled",null),Object(r.a)([Object(s.b)({readOnly:!0})],Kc.prototype,"updating",void 0),Object(r.a)([Object(s.b)()],Kc.prototype,"layer",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Kc.prototype,"frustumVisibility",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Kc.prototype,"graphics3d",void 0),Object(r.a)([Object(s.b)({type:Boolean})],Kc.prototype,"slicePlaneEnabled",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Kc.prototype,"suspendInfo",null),Kc=Object(r.a)([Object(l.a)("esri.views.3d.layers.GraphicsLayerView3D")],Kc);const el=Kc},235:function(e,t,i){"use strict";function r(){return new Float32Array(2)}function n(e,t){const i=new Float32Array(2);return i[0]=e,i[1]=t,i}function a(){return r()}function s(){return n(1,1)}function o(){return n(1,0)}function c(){return n(0,1)}i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return n}));const l=a(),d=s(),h=o(),u=c();Object.freeze({__proto__:null,create:r,clone:function(e){const t=new Float32Array(2);return t[0]=e[0],t[1]=e[1],t},fromValues:n,createView:function(e,t){return new Float32Array(e,t,2)},zeros:a,ones:s,unitX:o,unitY:c,ZEROS:l,ONES:d,UNIT_X:h,UNIT_Y:u})},350:function(e,t,i){"use strict";i.d(t,"a",(function(){return O})),i.d(t,"b",(function(){return g})),i.d(t,"c",(function(){return c})),i.d(t,"d",(function(){return x})),i.d(t,"e",(function(){return j})),i.d(t,"f",(function(){return _})),i.d(t,"g",(function(){return S}));var r=i(85),n=i(98);const a=(e,t,i)=>[t,i],s=(e,t,i)=>[t,i,e[2]],o=(e,t,i)=>[t,i,e[2],e[3]];function c(e){return e?{originPosition:"upper-left"===e.originPosition?"upperLeft":"lower-left"===e.originPosition?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance]:[1,1],translate:Object(r.l)(e.extent)?[e.extent.xmin,e.extent.ymax]:[0,0]}:null}function l({scale:e,translate:t},i){return Math.round((i-t[0])/e[0])}function d({scale:e,translate:t},i){return Math.round((t[1]-i)/e[1])}function h(e,t,i){const r=[];let n,a,s,o;for(let c=0;c<i.length;c++){const h=i[c];c>0?(s=l(e,h[0]),o=d(e,h[1]),s===n&&o===a||(r.push(t(h,s-n,o-a)),n=s,a=o)):(n=l(e,h[0]),a=d(e,h[1]),r.push(t(h,n,a)))}return r.length>0?r:null}function u({scale:e,translate:t},i){return i*e[0]+t[0]}function p({scale:e,translate:t},i){return t[1]-i*e[1]}function f(e,t,i){const r=new Array(i.length);if(!i.length)return r;const[n,a]=e.scale;let s=u(e,i[0][0]),o=p(e,i[0][1]);r[0]=t(i[0],s,o);for(let c=1;c<i.length;c++){const e=i[c];s+=e[0]*n,o-=e[1]*a,r[c]=t(e,s,o)}return r}function b(e,t,i){const r=new Array(i.length);for(let n=0;n<i.length;n++)r[n]=f(e,t,i[n]);return r}function m(e,t,i,r,n){return t.points=function(e,t,i,r){return h(e,i?r?o:s:r?s:a,t)}(e,i.points,r,n),t}function g(e,t,i,r,n){return t.x=l(e,i.x),t.y=d(e,i.y),t!==i&&(r&&(t.z=i.z),n&&(t.m=i.m)),t}function v(e,t,i,r,n){const c=function(e,t,i,r){const n=[],c=i?r?o:s:r?s:a;for(let a=0;a<t.length;a++){const i=h(e,c,t[a]);i&&i.length>=3&&n.push(i)}return n.length?n:null}(e,i.rings,r,n);return c?(t.rings=c,t):null}function y(e,t,i,r,n){const c=function(e,t,i,r){const n=[],c=i?r?o:s:r?s:a;for(let a=0;a<t.length;a++){const i=h(e,c,t[a]);i&&i.length>=2&&n.push(i)}return n.length?n:null}(e,i.paths,r,n);return c?(t.paths=c,t):null}function O(e,t){return e&&t?Object(n.f)(t)?g(e,{},t,!1,!1):Object(n.h)(t)?y(e,{},t,!1,!1):Object(n.g)(t)?v(e,{},t,!1,!1):Object(n.e)(t)?m(e,{},t,!1,!1):Object(n.d)(t)?function(e,t,i,r,n){return t.xmin=l(e,i.xmin),t.ymin=d(e,i.ymin),t.xmax=l(e,i.xmax),t.ymax=d(e,i.ymax),t!==i&&(r&&(t.zmin=i.zmin,t.zmax=i.zmax),n&&(t.mmin=i.mmin,t.mmax=i.mmax)),t}(e,{},t,!1,!1):null:null}function x(e,t,i,n,c){return Object(r.l)(i)&&(t.points=function(e,t,i,r){return f(e,i?r?o:s:r?s:a,t)}(e,i.points,n,c)),t}function j(e,t,i,n,a){return Object(r.k)(i)||(t.x=u(e,i.x),t.y=p(e,i.y),t!==i&&(n&&(t.z=i.z),a&&(t.m=i.m))),t}function _(e,t,i,n,c){return Object(r.l)(i)&&(t.rings=function(e,t,i,r){return b(e,i?r?o:s:r?s:a,t)}(e,i.rings,n,c)),t}function S(e,t,i,n,c){return Object(r.l)(i)&&(t.paths=function(e,t,i,r){return b(e,i?r?o:s:r?s:a,t)}(e,i.paths,n,c)),t}},362:function(e,t,i){"use strict";i.d(t,"a",(function(){return A})),i.d(t,"b",(function(){return R})),i.d(t,"c",(function(){return d})),i.d(t,"d",(function(){return c})),i.d(t,"e",(function(){return f})),i.d(t,"f",(function(){return p})),i.d(t,"g",(function(){return u})),i.d(t,"h",(function(){return h})),i.d(t,"i",(function(){return _})),i.d(t,"j",(function(){return S})),i.d(t,"k",(function(){return C})),i.d(t,"l",(function(){return P})),i.d(t,"m",(function(){return w})),i.d(t,"n",(function(){return E})),i.d(t,"o",(function(){return T})),i.d(t,"p",(function(){return j})),i.d(t,"q",(function(){return z})),i.d(t,"r",(function(){return D})),i.d(t,"s",(function(){return x})),i.d(t,"t",(function(){return M})),i.d(t,"u",(function(){return l}));var r=i(113),n=i(85),a=i(116),s=i(106),o=(i(440),i(272));function c(e=L){return[e[0],e[1],e[2],e[3]]}function l(e,t,i,r){return h(e,t,i,r,o.e.get())}function d(e,t=c()){return h(e[0],e[1],e[2],e[3],t)}function h(e,t,i,r,n=c()){return n[0]=e,n[1]=t,n[2]=i,n[3]=r,n}function u(e,t,i){const r=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],n=Math.abs(r-1)>1e-5&&r>1e-12?1/Math.sqrt(r):1;return i[0]=t[0]*n,i[1]=t[1]*n,i[2]=t[2]*n,i[3]=-(i[0]*e[0]+i[1]*e[1]+i[2]*e[2]),i}function p(e,t,i,r=c()){const n=i[0]-t[0],a=i[1]-t[1],s=i[2]-t[2],o=e[0]-t[0],l=e[1]-t[1],d=e[2]-t[2],h=a*d-s*l,u=s*o-n*d,p=n*l-a*o,f=h*h+u*u+p*p,b=Math.abs(f-1)>1e-5&&f>1e-12?1/Math.sqrt(f):1;r[0]=h*b,r[1]=u*b,r[2]=p*b,r[3]=-(r[0]*e[0]+r[1]*e[1]+r[2]*e[2])}function f(e,t,i,r,n){if(e.count<3)return!1;e.getVec(i,m);let s=r,o=!1;for(;s<e.count-1&&!o;)e.getVec(s,g),s++,o=!Object(a.o)(m,g);if(!o)return!1;for(s=Math.max(s,n),o=!1;s<e.count&&!o;)e.getVec(s,v),s++,Object(a.j)(y,m,g),Object(a.r)(y,y),Object(a.j)(O,g,v),Object(a.r)(O,O),o=!Object(a.o)(m,v)&&!Object(a.o)(g,v)&&Math.abs(Object(a.h)(y,O))<b;return o?(p(m,g,v,t),!0):(0!==i||1!==r||2!==n)&&f(e,t,0,1,2)}const b=.99619469809,m=Object(s.f)(),g=Object(s.f)(),v=Object(s.f)(),y=Object(s.f)(),O=Object(s.f)();function x(e,t,i){return e!==i&&d(e,i),i[3]=-Object(a.h)(i,t),i}function j(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function _(e,t,i,r){return Object(a.g)(v,t,e),u(i,v,r)}function S(e,t,i,r){return I(e,t,Object(a.j)(o.d.get(),i,t),F,r)}function w(e,t,i){return!!Object(n.l)(t)&&I(e,t.origin,t.direction,V,i)}function C(e,t,i){return I(e,t.origin,t.vector,0,i)}function P(e,t,i){return I(e,t.origin,t.vector,1,i)}function T(e,t){return M(e,t)>=0}function E(e,t){const i=t[0],r=t[1],n=t[2],a=t[3],s=t[4],o=t[5];return e[0]*(e[0]>0?i:a)+e[1]*(e[1]>0?r:s)+e[2]*(e[2]>0?n:o)+e[3]>=0}function A(e,t){const i=Object(a.h)(e,t.ray.direction),r=-M(e,t.ray.origin);if(r<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return r>0;if((r<0||i<0)&&!(r<0&&i<0))return!0;const n=r/i;return i>0?n<t.c1&&(t.c1=n):n>t.c0&&(t.c0=n),t.c0<=t.c1}function R(e,t){const i=Object(a.h)(e,t.ray.direction),r=-M(e,t.ray.origin);if(i>-1e-6&&i<1e-6)return r>0;const n=r/i;return i>0?n<t.c1&&(t.c1=n):n>t.c0&&(t.c0=n),t.c0<=t.c1}function D(e,t,i){const r=Object(a.e)(o.d.get(),e,-e[3]),n=function(e,t,i){const r=Object(a.e)(o.d.get(),e,Object(a.h)(e,t));return Object(a.j)(i,t,r),i}(e,Object(a.j)(o.d.get(),t,r),o.d.get());return Object(a.f)(i,n,r),i}function M(e,t){return Object(a.h)(e,t)+e[3]}function I(e,t,i,n,s){const o=Object(a.h)(e,i);if(0===o)return!1;let c=-(Object(a.h)(e,t)+e[3])/o;return 1&n&&(c=Object(r.e)(c,0,1)),!(!(4&n)&&c<0||!(8&n)&&c>1)&&(Object(a.f)(s,t,Object(a.e)(s,i,c)),!0)}function z(e){return e}const L=[0,0,1,0],F=12,V=8},398:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return a}));var r=i(113);function n(e,t,i=0){const n=Object(r.e)(e,0,c);for(let r=0;r<4;r++)t[i+r]=Math.floor(256*l(n*s[r]))}function a(e,t=0){let i=0;for(let r=0;r<4;r++)i+=e[t+r]*o[r];return i}const s=[1,256,65536,16777216],o=[1/256,1/65536,1/16777216,1/4294967296],c=a(new Uint8ClampedArray([255,255,255,255]));function l(e){return e-Math.floor(e)}},416:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return h})),i.d(t,"d",(function(){return u})),i.d(t,"e",(function(){return p})),i.d(t,"f",(function(){return o})),i.d(t,"g",(function(){return l})),i.d(t,"h",(function(){return d}));i(598),i(82);var r=i(85),n=(i(554),i(251),i(94),i(223)),a=i(118);i(350),i(171),i(153),i(437);class s{constructor(e,t,i){this.uid=e,this.geometry=t,this.attributes=i,this.visible=!0,this.objectId=null,this.centroid=null}}function o(e){return Object(r.l)(e.geometry)}class c{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}}function l(e,t,i,r){return{x:e,y:t,z:i,hasZ:null!=i,hasM:!1,spatialReference:r,type:"point"}}function d(e){if(Object(r.k)(e))return 0;switch(e.type){case"point":return 1;case"polyline":{let t=0;for(const i of e.paths)t+=i.length;return t}case"polygon":{let t=0;for(const i of e.rings)t+=i.length;return t}case"multipoint":return e.points.length;case"extent":return 2;case"mesh":{const t=e.vertexAttributes&&e.vertexAttributes.position;return t?t.length/3:0}default:return}}function h(e,t){switch(Object(n.h)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(let i=0;i<e.paths.length;i++)Object(n.l)(t,e.paths[i],e.hasZ);break;case"polygon":for(let i=0;i<e.rings.length;i++)Object(n.l)(t,e.rings[i],e.hasZ);break;case"multipoint":Object(n.l)(t,e.points,e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,null!=e.zmin&&(t[2]=e.zmin),null!=e.zmax&&(t[5]=e.zmax)}}function u(e,t){switch(Object(a.m)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(let i=0;i<e.paths.length;i++)Object(a.p)(t,e.paths[i]);break;case"polygon":for(let i=0;i<e.rings.length;i++)Object(a.p)(t,e.rings[i]);break;case"multipoint":Object(a.p)(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}}function p(e,t){return null!=e.objectId?e.objectId:e.attributes&&t?e.attributes[t]:null}Object(n.f)(),Object(a.l)()},436:function(e,t,i){"use strict";function r(e){return e=e||globalThis.location.hostname,l.some((t=>{var i;return null!=(null==(i=e)?void 0:i.match(t))}))}function n(e,t){return e&&(t=t||globalThis.location.hostname)?null!=t.match(a)||null!=t.match(o)?e.replace("static.arcgis.com","staticdev.arcgis.com"):null!=t.match(s)||null!=t.match(c)?e.replace("static.arcgis.com","staticqa.arcgis.com"):e:e}i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return r}));const a=/^devext.arcgis.com$/,s=/^qaext.arcgis.com$/,o=/^[\w-]*\.mapsdevext.arcgis.com$/,c=/^[\w-]*\.mapsqa.arcgis.com$/,l=[/^([\w-]*\.)?[\w-]*\.zrh-dev-local.esri.com$/,a,s,/^jsapps.esri.com$/,o,c]},437:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));i(82),i(85);function r(e,t){return!!n(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function n(e,t){return e===t||e&&t&&e.equals(t)}},438:function(e,t,i){"use strict";i.d(t,"a",(function(){return f}));var r=i(79),n=i(99),a=i(129),s=i(131),o=i(178),c=i(87),l=i(85),d=i(260),h=i(81),u=(i(84),i(82),i(83),i(80));let p=class extends(Object(s.b)(Object(o.a)(Object(d.b)(a.a.EventedMixin(n.a))))){constructor(e){super(e),this.layer=null,this.parent=null}initialize(){this.when().catch((e=>{if("layerview:create-error"!==e.name){const t=this.layer&&this.layer.id||"no id",i=this.layer&&this.layer.title||"no title";throw c.a.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${i}', id: '${t}')`,e),e}}))}get fullOpacity(){return Object(l.u)(this.get("layer.opacity"),1)*Object(l.u)(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer.legendEnabled}get updating(){return!!(this.updatingHandles&&this.updatingHandles.updating||this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){var e;return!0===(null==(e=this.layer)?void 0:e.visible)}set visible(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")}canResume(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.get("layer.loaded")&&this.visible||!1}getSuspendInfo(){const e=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(e.viewNotReady=!0),this.layer&&this.layer.loaded||(e.layerNotLoaded=!0),this.visible||(e.layerInvisible=!0),e}isUpdating(){return!1}};Object(r.a)([Object(h.b)()],p.prototype,"fullOpacity",null),Object(r.a)([Object(h.b)()],p.prototype,"layer",void 0),Object(r.a)([Object(h.b)()],p.prototype,"parent",void 0),Object(r.a)([Object(h.b)({readOnly:!0})],p.prototype,"suspended",null),Object(r.a)([Object(h.b)({readOnly:!0})],p.prototype,"suspendInfo",null),Object(r.a)([Object(h.b)({readOnly:!0})],p.prototype,"legendEnabled",null),Object(r.a)([Object(h.b)({type:Boolean,readOnly:!0})],p.prototype,"updating",null),Object(r.a)([Object(h.b)({readOnly:!0})],p.prototype,"updatingProgress",null),Object(r.a)([Object(h.b)()],p.prototype,"visible",null),p=Object(r.a)([Object(u.a)("esri.views.layers.LayerView")],p);const f=p},447:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(88),n=i(87),a=i(350);function s(e,t,i,r,a){const s=e.referencesGeometry()&&a?c(t,r,a):t,o=e.repurposeFeature(s);try{return e.evaluate({...i,$feature:o})}catch(l){return n.a.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",l),null}}const o=new Map;function c(e,t,i){const{transform:s,hasZ:c,hasM:l}=i;o.has(t)||o.set(t,function(e){const t={};switch(e){case"esriGeometryPoint":return(e,i,r,n)=>Object(a.e)(i,t,e,r,n);case"esriGeometryPolygon":return(e,i,r,n)=>Object(a.f)(i,t,e,r,n);case"esriGeometryPolyline":return(e,i,r,n)=>Object(a.g)(i,t,e,r,n);case"esriGeometryMultipoint":return(e,i,r,n)=>Object(a.d)(i,t,e,r,n);default:return n.a.getLogger("esri.views.2d.support.arcadeOnDemand").error(new r.a("mapview-arcade",`Unable to handle geometryType: ${e}`)),e=>e}}(t));const d=o.get(t)(e.geometry,s,c,l);return{...e,geometry:d}}},480:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(85);function n(e,t){return e?t?4:3:t?3:2}function a(e,t,i,a,c){if(Object(r.k)(t)||!t.lengths.length)return null;const l="upperLeft"===(null==c?void 0:c.originPosition)?-1:1;e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0);const d=e.coords,h=[],u=i?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],{lengths:p,coords:f}=t,b=n(i,a);let m=0;for(const r of p){const e=s(u,f,m,r,i,a,l);e&&h.push(e),m+=r*b}if(h.sort(((e,t)=>{let r=l*e[2]-l*t[2];return 0===r&&i&&(r=e[4]-t[4]),r})),h.length){let e=6*h[0][2];d[0]=h[0][0]/e,d[1]=h[0][1]/e,i&&(e=6*h[0][4],d[2]=0!==e?h[0][3]/e:0),(d[0]<u[0]||d[0]>u[1]||d[1]<u[2]||d[1]>u[3]||i&&(d[2]<u[4]||d[2]>u[5]))&&(d.length=0)}if(!d.length){const e=t.lengths[0]?o(f,0,p[0],i,a):null;if(!e)return null;d[0]=e[0],d[1]=e[1],i&&e.length>2&&(d[2]=e[2])}return e}function s(e,t,i,r,a,s,o=1){const c=n(a,s);let l=i,d=i+c,h=0,u=0,p=0,f=0,b=0;for(let n=0,g=r-1;n<g;n++,l+=c,d+=c){const i=t[l],r=t[l+1],n=t[l+2],s=t[d],o=t[d+1],c=t[d+2];let m=i*o-s*r;f+=m,h+=(i+s)*m,u+=(r+o)*m,a&&(m=i*c-s*n,p+=(n+c)*m,b+=m),i<e[0]&&(e[0]=i),i>e[1]&&(e[1]=i),r<e[2]&&(e[2]=r),r>e[3]&&(e[3]=r),a&&(n<e[4]&&(e[4]=n),n>e[5]&&(e[5]=n))}if(f*o>0&&(f*=-1),b*o>0&&(b*=-1),!f)return null;const m=[h,u,.5*f];return a&&(m[3]=p,m[4]=.5*b),m}function o(e,t,i,r,a){const s=n(r,a);let o=t,u=t+s,p=0,f=0,b=0,m=0;for(let n=0,g=i-1;n<g;n++,o+=s,u+=s){const t=e[o],i=e[o+1],n=e[o+2],a=e[u],s=e[u+1],g=e[u+2],v=r?l(t,i,n,a,s,g):c(t,i,a,s);if(v)if(p+=v,r){const e=h(t,i,n,a,s,g);f+=v*e[0],b+=v*e[1],m+=v*e[2]}else{const e=d(t,i,a,s);f+=v*e[0],b+=v*e[1]}}return p>0?r?[f/p,b/p,m/p]:[f/p,b/p]:i>0?r?[e[t],e[t+1],e[t+2]]:[e[t],e[t+1]]:null}function c(e,t,i,r){const n=i-e,a=r-t;return Math.sqrt(n*n+a*a)}function l(e,t,i,r,n,a){const s=r-e,o=n-t,c=a-i;return Math.sqrt(s*s+o*o+c*c)}function d(e,t,i,r){return[e+.5*(i-e),t+.5*(r-t)]}function h(e,t,i,r,n,a){return[e+.5*(r-e),t+.5*(n-t),i+.5*(a-i)]}},502:function(e,t,i){"use strict";i.d(t,"a",(function(){return D})),i.d(t,"b",(function(){return O})),i.d(t,"c",(function(){return R}));var r=i(79),n=i(99),a=i(121),s=i(87),o=i(85),c=i(468),l=i(215),d=i(91),h=i(212),u=i(444),p=i(112),f=i(81),b=(i(84),i(82),i(83),i(80));let m=class extends n.a{constructor(){super(...arguments),this._tasks=new Array,this.running=!1}get length(){return this._tasks.length}destroy(){this.cancelAll()}runTask(e){for(;!e.done&&this._process(e);)e.madeProgress()}push(e,t,i){return this.running=!0,new Promise(((r,n)=>this._tasks.push(new g(r,n,e,t,i))))}unshift(e,t,i){return this.running=!0,new Promise(((r,n)=>this._tasks.unshift(new g(r,n,e,t,i))))}_process(e){if(0===this._tasks.length)return!1;const t=this._tasks.shift();try{const i=Object(d.m)(t.signal);if(i&&!t.abortCallback)t.reject(Object(d.d)());else{const r=i?t.abortCallback(Object(d.d)()):t.callback(e);Object(d.n)(r)?r.then(t.resolve,t.reject):t.resolve(r)}}catch(i){t.reject(i)}return this.running=this._tasks.length>0,!0}cancelAll(){const e=Object(d.d)();for(const t of this._tasks)if(t.abortCallback){const i=t.abortCallback(e);t.resolve(i)}else t.reject(e);this._tasks.length=0,this.running=!1}};Object(r.a)([Object(f.b)()],m.prototype,"running",void 0),m=Object(r.a)([Object(b.a)("esri.layers.support.PromiseQueue")],m);class g{constructor(e,t,i,r,n){this.resolve=e,this.reject=t,this.callback=i,this.signal=r,this.abortCallback=n}}var v=i(611);const y=s.a.getLogger("esri.views.support.Scheduler");var O,x;(x=O||(O={})).RESOURCE_CONTROLLER="schedule",x.SLIDE="slide",x.STREAM_DATA_LOADER="stream loader",x.ELEVATION_QUERY="elevation query",x.TERRAIN_SURFACE="terrain",x.SURFACE_GEOMETRY_UPDATES="surface geometry updates",x.GRAPHICS_CORE="Graphics3D",x.I3S_CONTROLLER="I3S",x.POINT_CLOUD_LAYER="point cloud",x.FEATURE_TILE_FETCHER="feature fetcher",x.OVERLAY="overlay",x.STAGE="stage",x.GRAPHICS_DECONFLICTOR="graphics deconflictor",x.FILTER_VISIBILITY="Graphics3D filter visibility",x.SCALE_VISIBILITY="Graphics3D scale visibility",x.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",x.POINT_OF_INTEREST_FREQUENT="POI frequent",x.POINT_OF_INTEREST_INFREQUENT="POI infrequent",x.LABELER="labeler",x.FEATURE_QUERY_ENGINE="feature query",x.FEATURE_TILE_TREE="feature tile tree",x.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",x.ELEVATION_ALIGNMENT="elevation alignment",x.TEXT_TEXTURE_ATLAS="text texture atlas",x.TEXTURE_UNLOAD="texture unload",x.LINE_OF_SIGHT_TOOL="line of sight tool",x.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",x.ELEVATION_PROFILE="elevation profile",x.SNAPPING="snapping",x.SHADOW_ACCUMULATOR="shadow accumulator",x.CLOUDS_GENERATOR="cloud generator",x[x.TEST_PRIO=1]="TEST_PRIO";const j=new Map([[O.RESOURCE_CONTROLLER,0],[O.SLIDE,0],[O.STREAM_DATA_LOADER,0],[O.ELEVATION_QUERY,0],[O.TERRAIN_SURFACE,1],[O.SURFACE_GEOMETRY_UPDATES,1],[O.GRAPHICS_CORE,2],[O.I3S_CONTROLLER,2],[O.POINT_CLOUD_LAYER,2],[O.FEATURE_TILE_FETCHER,2],[O.OVERLAY,4],[O.STAGE,4],[O.GRAPHICS_DECONFLICTOR,4],[O.FILTER_VISIBILITY,4],[O.SCALE_VISIBILITY,4],[O.FRUSTUM_VISIBILITY,4],[O.POINT_OF_INTEREST_FREQUENT,6],[O.POINT_OF_INTEREST_INFREQUENT,30],[O.LABELER,8],[O.FEATURE_QUERY_ENGINE,8],[O.FEATURE_TILE_TREE,16],[O.FEATURE_TILE_TREE_ACTIVE,0],[O.ELEVATION_ALIGNMENT,12],[O.TEXT_TEXTURE_ATLAS,12],[O.CLOUDS_GENERATOR,12],[O.TEXTURE_UNLOAD,12],[O.LINE_OF_SIGHT_TOOL,16],[O.LINE_OF_SIGHT_TOOL_INTERACTIVE,0],[O.SNAPPING,0],[O.SHADOW_ACCUMULATOR,30]]);function _(e){return j.has(e)?j.get(e):"number"==typeof e?e:1}const S=Object(u.a)(6.5),w=Object(u.a)(1),C=Object(u.a)(30),P=Object(u.a)(1e3/30),T=Object(u.a)(100);var E,A;!function(e){let t=class extends n.a{constructor(e){super(e),this.updating=!0,this._microTaskQueued=!1,this.performanceInfo={total:new c.a("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=null,this._state=1,this._tasks=new l.a,this._runQueue=new l.a,this._load=0,this._idleStateCallbacks=new l.a,this._idleUpdatesStartFired=!1,this._maxReschedule=M,this._forceTask=!1,this._debug=!1,this._debugHandle=Object(p.a)(v.a,"SCHEDULER_LOG_SLOW_TASKS",(e=>this._debug=e)),this._budget=new s(e.nowFunc);for(const r of Object.keys(O))this.performanceInfo.tasks.set(O[r],new c.a(O[r]));let t;const i=this;this._test={get state(){return Object(o.u)(t,i._state)},set state(e){t=e},FRAME_SAFETY_BUDGET:S,INTERACTING_BUDGET:P,IDLE_BUDGET:T,get budget(){return i._budget.budget},usedBudget:0,setBudget:e=>i._budget=e,updateTask:e=>this._updateTask(e),getState:e=>this._getState(e),getRuntime:e=>this._getRuntime(e),frameTaskTimes:this._frameTaskTimes,resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}destroy(){this._debugHandle&&this._debugHandle.remove(),this._microTaskQueued=!1}activate(){this._budget.done||this._microTaskQueued||(this._microTaskQueued=!0,queueMicrotask((()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.done||(this._maxReschedule=M,this._schedule(),this.frame()))})))}registerTask(e,t){const r=_(e),n=new i(this,e,t,r);return this._tasks.push(n),this.performanceInfo.tasks.has(e)||this.performanceInfo.tasks.set(e,new c.a(e)),n}registerIdleStateCallbacks(e,t){const i={idleBegin:e,idleEnd:t};this._idleStateCallbacks.push(i),2===this.state&&this._idleUpdatesStartFired&&i.idleBegin();const r=this;return{remove:()=>this._removeIdleStateCallbacks(i),set idleBegin(e){r._idleUpdatesStartFired&&(i.idleEnd(),2===r._state&&e()),i.idleBegin=e},set idleEnd(e){i.idleEnd=e}}}get now(){return this.nowFunc()}get load(){return this._load}set state(e){this._state!==e&&(this._state=e,2!==this.state&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll((e=>e.idleEnd()))))}get state(){return Object(o.k)(this._test.state)?this._state:this._test.state}updateBudget(e){this._test.usedBudget=0;let t=S,i=e.frameDuration,r=w;switch(this.state){case 2:t=Object(u.a)(0),i=Object(u.a)(Math.max(T,e.frameDuration)),r=C;break;case 1:i=Object(u.a)(Math.max(P,e.frameDuration))}return i=Object(u.a)(i-e.elapsedFrameTime-t),2!==this.state&&i<w&&!this._forceTask?(this._forceTask=!0,!1):(i=Object(u.a)(Math.max(i,r)),this._budget.reset(i,this.state),this._maxReschedule=M,this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case 2:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll((e=>e.idleBegin()))),this._runIdle();break;case 1:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed}stopFrame(){this._budget.reset(Object(u.a)(0),this._state),this._budget.madeProgress()}_removeIdleStateCallbacks(e){this._idleUpdatesStartFired&&e.idleEnd(),this._idleStateCallbacks.removeUnordered(e)}removeTask(e){this._tasks.removeUnordered(e),this._runQueue.removeUnordered(e)}_updateTask(e){this._tasks.forAll((t=>{t.name===e&&t.setPriority(e)}))}_getState(e){if(this._runQueue.some((t=>t.name===e)))return A.SCHEDULED;let t=A.IDLE;return this._tasks.forAll((i=>{i.name===e&&i.needsUpdate&&(i.schedulePriority<=1?t=A.READY:t!==A.READY&&(t=A.WAITING))})),t}_getRuntime(e){let t=0;return this._tasks.forAll((i=>{i.name===e&&(t+=i.runtime)})),t}_resetRuntimes(){this._tasks.forAll((e=>e.runtime=0))}_getRunning(){const e=new Map;if(this._tasks.forAll((t=>{t.needsUpdate&&e.set(t.name,(e.get(t.name)||0)+1)})),0===e.size)return null;let t="";return e.forEach(((e,i)=>{t+=e>1?` ${e}x ${i}`:` ${i}`})),t}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const e=this._tasks.reduce(((e,t)=>t.needsUpdate?++e:e),0);this._load=.9*this._load+e*(1-.9)}_schedule(){if(this._maxReschedule<=0)return!1;for(this._runQueue.filterInPlace((e=>!!e.needsUpdate||(e.schedulePriority=e.basePriority,!1))),this._tasks.forAll((e=>{0===e.basePriority&&e.needsUpdate&&!this._runQueue.some((t=>t===e))&&this._runQueue.unshift(e)}));0===this._runQueue.length;){let e=!1,t=0;if(this._tasks.forAll((i=>{i.needsUpdate&&0!==i.schedulePriority&&0!==i.basePriority&&(e=!0,t=Math.max(t,i.basePriority),1===i.schedulePriority?(i.schedulePriority=0,this._runQueue.push(i)):--i.schedulePriority)})),!e)return this.updating=!1,!1;this._maxReschedule===M&&(this._maxReschedule=t),--this._maxReschedule}return this.updating=!0,!0}_run(){const e=this._budget.now();this._startFrameTaskTimes();do{for(;this._runQueue.length>0;){const i=this._budget.now(),r=this._runQueue.pop();this._budget.resetProgress();try{r.task.runTask(this._budget)}catch(t){y.error(`Exception in task "${r.name}"`,t)}r.schedulePriority=r.basePriority;const n=this._budget.now()-i;if(r.runtime+=n,this._frameTaskTimes.set(r.priority,this._frameTaskTimes.get(r.priority)+n),this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",r.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return void this._recordFrameTaskTimes(this._budget.now()-e)}}while(this._schedule());this._recordFrameTaskTimes(this._budget.now()-e)}_startFrameTaskTimes(){for(const e of Object.keys(O))this._frameTaskTimes.set(O[e],0)}_recordFrameTaskTimes(e){this._frameTaskTimes.forEach(((e,t)=>this.performanceInfo.tasks.get(t).record(e))),this.performanceInfo.total.record(e)}get test(){return this._test}};Object(r.a)([Object(f.b)()],t.prototype,"updating",void 0),Object(r.a)([Object(f.b)()],t.prototype,"nowFunc",void 0),t=Object(r.a)([Object(b.a)("esri.views.support.Scheduler")],t),e.Scheduler=t;let i=class extends n.a{constructor(e,t,i,r){super({}),this._scheduler=e,this.name=t,this._basePriority=r,this.runtime=0,this._queue=new m,this._handles=new a.a,this.schedulePriority=this._basePriority,this.task=Object(o.l)(i)?i:this._queue,this._handles.add(Object(h.c)((()=>this.task.running),(()=>e.activate())))}get updating(){return this._queue.running}normalizeCtorArgs(){return{}}remove(){this.processQueue(R),this._scheduler.removeTask(this),this.schedule=D.schedule,this.reschedule=D.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(e){this.name=e;const t=_(e);0!==this._basePriority&&0===this.schedulePriority||(this.schedulePriority=t),this._basePriority=t}get priority(){return this.name}set priority(e){this.setPriority(e)}get needsUpdate(){return this.updating||this.task.running}schedule(e,t,i){return this._queue.push(e,t,i)}reschedule(e,t,i){return this._queue.unshift(e,t,i)}processQueue(e){this._queue.runTask(e)}};Object(r.a)([Object(f.b)({constructOnly:!0})],i.prototype,"task",void 0),Object(r.a)([Object(f.b)({readOnly:!0})],i.prototype,"updating",null),i=Object(r.a)([Object(b.a)("esri.views.support.SchedulerTask")],i);class s{constructor(e){this.now=e,this._begin=0,this._budget=0,this._state=2,this._didWork=!1,this._enabled=!0}run(e){return!this.done&&(!0===e()&&(this._didWork=!0),!0)}get done(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}get budget(){return this._budget}madeProgress(){this._didWork=!0}get state(){return this._state}get enabled(){return this._enabled}set enabled(e){this._enabled=e}reset(e,t){this._begin=this.now(),this._budget=e,this._state=t,this._didWork=!1}get remaining(){return Math.max(this._budget-this.elapsed,0)}get elapsed(){return this.now()-this._begin}resetProgress(){this._didWork=!1}get hasProgressed(){return this._didWork}}e.Budget=s}(E||(E={})),function(e){e.SCHEDULED="s",e.READY="r",e.WAITING="w",e.IDLE="i"}(A||(A={}));const R=(()=>{const e=new E.Budget((()=>performance.now()));return e.enabled=!1,e})();const D=new class{remove(){}processQueue(){}schedule(e,t,i){try{if(Object(d.m)(t)){const e=Object(d.d)();return i?Promise.resolve(i(e)):Promise.reject(e)}return Object(d.x)(e(R))}catch(r){return Promise.reject(r)}}reschedule(e,t,i){return this.schedule(e,t,i)}},M=Number.MAX_SAFE_INTEGER},515:function(e,t,i){"use strict";i.d(t,"a",(function(){return g})),i.d(t,"b",(function(){return C})),i.d(t,"c",(function(){return _})),i.d(t,"d",(function(){return P})),i.d(t,"e",(function(){return O})),i.d(t,"f",(function(){return w})),i.d(t,"g",(function(){return j})),i.d(t,"h",(function(){return T})),i.d(t,"i",(function(){return x})),i.d(t,"j",(function(){return S}));var r=i(85),n=i(149),a=i(199),s=i(224),o=i(106),c=i(237),l=i(245),d=i(207),h=i(223),u=i(118),p=i(404),f=i(246),b=i(416),m=i(590);function g(e,t){if("point"===e.type)return y(e,t,!1);if(Object(m.d)(e))switch(e.type){case"extent":return y(e.center,t,!1);case"polygon":return y(e.centroid,t,!1);case"polyline":return y(v(e),t,!0);case"mesh":return y(e.origin,t,!1)}else switch(e.type){case"extent":return y(function(e){const t=isFinite(e.zmin);return Object(b.g)(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),t?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}(e),t,!0);case"polygon":return y(function(e){const t=e.rings[0];if(!t||0===t.length)return null;const i=Object(p.b)(e.rings,e.hasZ);return Object(b.g)(i[0],i[1],i[2],e.spatialReference)}(e),t,!0);case"polyline":return y(v(e),t,!0)}}function v(e){const t=e.paths[0];if(!t||0===t.length)return null;const i=Object(f.f)(t,Object(f.e)(t)/2);return Object(b.g)(i[0],i[1],i[2],e.spatialReference)}function y(e,t,i){const r=i?e:Object(m.a)(e);return t&&e?Object(d.n)(e,r,t)?r:null:r}function O(e,t,i,r=0){if(e){t||(t=Object(u.l)());const n=e;let a=.5*n.width*(i-1),s=.5*n.height*(i-1);return n.width<1e-7*n.height?a+=s/20:n.height<1e-7*n.width&&(s+=a/20),Object(c.l)(t,n.xmin-a-r,n.ymin-s-r,n.xmax+a+r,n.ymax+s+r),t}return null}function x(e,t){for(let i=0;i<e.geometries.length;++i){const r=e.geometries[i].getMutableAttribute("auxpos1");r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttrsUpdated(e.geometryRecords[i]))}}function j(e,t){const i=Object(l.d)(l.a);return Object(r.l)(e)&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),Object(r.l)(t)?i[3]=t:Object(r.l)(e)&&e.length>3&&(i[3]=e[3]),i}function _(e=o.a,t,i,n=1){const a=new Array(3);if(Object(r.k)(t)||Object(r.k)(i))a[0]=1,a[1]=1,a[2]=1;else{let r,n=0;for(let s=2;s>=0;s--){const o=e[s];let c;const l=null!=o,d=0===s&&!r&&!l,h=i[s];"symbol-value"===o||d?c=0!==h?t[s]/h:1:l&&"proportional"!==o&&isFinite(o)&&(c=0!==h?o/h:1),null!=c&&(a[s]=c,r=c,n=Math.max(n,Math.abs(c)))}for(let e=2;e>=0;e--)null==a[e]?a[e]=r:0===a[e]&&(a[e]=.001*n)}for(let r=2;r>=0;r--)a[r]/=n;return Object(o.g)(a)}function S(e){return function(e){return null!=e.isPrimitive}(e)&&(e=[e.width,e.depth,e.height]),w(e)?null:"Symbol sizes may not be negative values"}function w(e){if(Array.isArray(e)){for(const t of e)if(!w(t))return!1;return!0}return null==e||e>=0}function C(e,t,i,r=Object(a.d)()){const s=e||0,o=t||0,c=i||0;return 0!==s&&Object(n.r)(r,r,-s/180*Math.PI),0!==o&&Object(n.e)(r,r,o/180*Math.PI),0!==c&&Object(n.k)(r,r,c/180*Math.PI),r}function P(e,t){return null!=t.minDemResolution?t.minDemResolution:Object(h.s)(e)?t.minDemResolutionForPoints:.01*Object(h.t)(e)}const T={"bottom-left":Object(s.e)(0,0),bottom:Object(s.e)(.5,0),"bottom-right":Object(s.e)(1,0),left:Object(s.e)(0,.5),center:Object(s.e)(.5,.5),right:Object(s.e)(1,.5),"top-left":Object(s.e)(0,1),top:Object(s.e)(.5,1),"top-right":Object(s.e)(1,1)}},553:function(e,t,i){"use strict";i.d(t,"a",(function(){return O}));var r,n,a=i(116),s=i(431),o=i(106),c=i(362),l=i(332);(n=r||(r={})).length=function(e,t){const i=e[t],r=e[t+1],n=e[t+2];return Math.sqrt(i*i+r*r+n*n)},n.normalize=function(e,t){const i=e[t],r=e[t+1],n=e[t+2],a=1/Math.sqrt(i*i+r*r+n*n);e[t]*=a,e[t+1]*=a,e[t+2]*=a},n.scale=function(e,t,i){e[t]*=i,e[t+1]*=i,e[t+2]*=i},n.add=function(e,t,i,r,n,a=t){(n=n||e)[a]=e[t]+i[r],n[a+1]=e[t+1]+i[r+1],n[a+2]=e[t+2]+i[r+2]},n.subtract=function(e,t,i,r,n,a=t){(n=n||e)[a]=e[t]-i[r],n[a+1]=e[t+1]-i[r+1],n[a+2]=e[t+2]-i[r+2]};var d=i(566),h=i(541),u=i(315);const p=r;var f,b,m,g;!function(e){const t=.5,i=[[-t,-t,t],[t,-t,t],[t,t,t],[-t,t,t],[-t,-t,-t],[t,-t,-t],[t,t,-t],[-t,t,-t]],r=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],n=[0,0,1,0,1,1,0,1],a=new Uint16Array([0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5]),s=new Uint16Array(36);for(let c=0;c<6;c++)for(let e=0;e<6;e++)s[6*c+e]=c;const o=new Uint16Array(36);for(let c=0;c<6;c++)o[6*c+0]=0,o[6*c+1]=1,o[6*c+2]=2,o[6*c+3]=2,o[6*c+4]=3,o[6*c+5]=0;e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(24);for(let r=0;r<8;r++)t[3*r]=i[r][0]*e[0],t[3*r+1]=i[r][1]*e[1],t[3*r+2]=i[r][2]*e[2];return new d.a([["position",{size:3,data:t,exclusive:!0}],["normal",{size:3,data:r}],["uv0",{size:2,data:n}]],[["position",a],["normal",s],["uv0",o]])}}(f||(f={})),function(e){const t=.5,i=[[-t,0,-t],[t,0,-t],[t,0,t],[-t,0,t],[0,-t,0],[0,t,0]],r=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],n=new Uint16Array([5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0]),a=new Uint16Array([0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7]);e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(18);for(let r=0;r<6;r++)t[3*r]=i[r][0]*e[0],t[3*r+1]=i[r][1]*e[1],t[3*r+2]=i[r][2]*e[2];return new d.a([["position",{size:3,data:t,exclusive:!0}],["normal",{size:3,data:r}]],[["position",n],["normal",a]])}}(b||(b={})),function(e){const t=.5,i=Object(s.c)(-t,0,-t),r=Object(s.c)(t,0,-t),n=Object(s.c)(0,0,t),o=Object(s.c)(0,.5,0),c=Object(s.b)(),l=Object(s.b)(),h=Object(s.b)(),u=Object(s.b)(),p=Object(s.b)();Object(a.j)(c,i,o),Object(a.j)(l,i,r),Object(a.g)(h,c,l),Object(a.r)(h,h),Object(a.j)(c,r,o),Object(a.j)(l,r,n),Object(a.g)(u,c,l),Object(a.r)(u,u),Object(a.j)(c,n,o),Object(a.j)(l,n,i),Object(a.g)(p,c,l),Object(a.r)(p,p);const f=[i,r,n,o],b=[0,-1,0,h[0],h[1],h[2],u[0],u[1],u[2],p[0],p[1],p[2]],m=[0,1,2,3,1,0,3,2,1,3,0,2],g=[0,0,0,1,1,1,2,2,2,3,3,3];e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(12);for(let i=0;i<4;i++)t[3*i]=f[i][0]*e[0],t[3*i+1]=f[i][1]*e[1],t[3*i+2]=f[i][2]*e[2];return new d.a([["position",{size:3,data:t,exclusive:!0}],["normal",{size:3,data:b}]],[["position",new Uint16Array(m)],["normal",new Uint16Array(g)]])}}(m||(m={})),function(e){e.createBoxGeometry=f.createGeometry,e.createDiamondGeometry=b.createGeometry,e.createTetrahedronGeometry=m.createGeometry,e.createSphereGeometry=function(e,t,i,r={uv:!0}){const n=-Math.PI,a=2*Math.PI,s=-Math.PI/2,o=Math.PI,c=Math.max(3,Math.floor(t)),l=Math.max(2,Math.floor(i)),h=(c+1)*(l+1),u=new Float32Array(3*h),p=new Float32Array(3*h),f=new Float32Array(2*h),b=[];let m=0;for(let d=0;d<=l;d++){const t=[],i=d/l,r=s+i*o,h=Math.cos(r);for(let s=0;s<=c;s++){const o=s/c,l=n+o*a,d=Math.cos(l)*h,b=Math.sin(r),g=-Math.sin(l)*h;u[3*m]=d*e,u[3*m+1]=b*e,u[3*m+2]=g*e,p[3*m]=d,p[3*m+1]=b,p[3*m+2]=g,f[2*m]=o,f[2*m+1]=i,t.push(m),++m}b.push(t)}const g=new Uint32Array(2*c*(l-1)*3);m=0;for(let d=0;d<l;d++)for(let e=0;e<c;e++){const t=b[d][e],i=b[d][e+1],r=b[d+1][e+1],n=b[d+1][e];0===d?(g[m++]=t,g[m++]=r,g[m++]=n):d===l-1?(g[m++]=t,g[m++]=i,g[m++]=r):(g[m++]=t,g[m++]=i,g[m++]=r,g[m++]=r,g[m++]=n,g[m++]=t)}const v=[["position",g],["normal",g]],y=[["position",{size:3,data:u,exclusive:!0}],["normal",{size:3,data:p,exclusive:!0}]];return r.uv&&(y.push(["uv0",{size:2,data:f,exclusive:!0}]),v.push(["uv0",g])),r.offset&&(v[0][0]="offset",y[0][0]="offset",v.push(["position",new Uint32Array(g.length)]),y.push(["position",{size:3,data:Float64Array.from(r.offset),exclusive:!0}])),new d.a(y,v)},e.createPolySphereGeometry=function(e,t,i){const r=e;let n,a;if(i)n=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],a=new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1]);else{const e=r*(1+Math.sqrt(5))/2;n=[-r,e,0,r,e,0,-r,-e,0,r,-e,0,0,-r,e,0,r,e,0,-r,-e,0,r,-e,e,0,-r,e,0,r,-e,0,-r,-e,0,r],a=new Uint32Array([0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1])}for(let d=0;d<n.length;d+=3)p.scale(n,d,e/p.length(n,d));let s={};function o(t,i){t>i&&([t,i]=[i,t]);const r=t.toString()+"."+i.toString();if(s[r])return s[r];let a=n.length;return n.length+=3,p.add(n,3*t,n,3*i,n,a),p.scale(n,a,e/p.length(n,a)),a/=3,s[r]=a,a}for(let d=0;d<t;d++){const e=a.length,t=new Uint32Array(4*e);for(let i=0;i<e;i+=3){const e=a[i],r=a[i+1],n=a[i+2],s=o(e,r),c=o(r,n),l=o(n,e),d=4*i;t[d]=e,t[d+1]=s,t[d+2]=l,t[d+3]=r,t[d+4]=c,t[d+5]=s,t[d+6]=n,t[d+7]=l,t[d+8]=c,t[d+9]=s,t[d+10]=c,t[d+11]=l}a=t,s={}}const c=new Float32Array(n);for(let d=0;d<c.length;d+=3)p.normalize(c,d);const l=[["position",a],["normal",a]],h=[["position",{size:3,data:new Float32Array(n),exclusive:!0}],["normal",{size:3,data:c,exclusive:!0}]];return new d.a(h,l)},e.createPointGeometry=function(e,t,i,r,n,a,s){const o=t?[t[0],t[1],t[2]]:[0,0,0],c=e?[e[0],e[1],e[2]]:[0,0,1];a=a||[0,0];const l=i?[255*i[0],255*i[1],255*i[2],i.length>3?255*i[3]:255]:[255,255,255,255],h=null!=r&&2===r.length?r:[1,1],u=[["position",{size:3,data:o,exclusive:!0}],["normal",{size:3,data:c,exclusive:!0}],["uv0",{size:a.length,data:a}],["color",{size:4,data:l,exclusive:!0}],["size",{size:2,data:h}]];if(null!=n){const e=new Float32Array([n[0],n[1],n[2],n[3]]);u.push(["auxpos1",{size:4,data:e}])}if(null!=s){const e=new Float32Array([s[0],s[1],s[2],s[3]]);u.push(["auxpos2",{size:4,data:e}])}return new d.a(u,null,1)},e.updatePointGeometry=function(e,t,i,r,n,a,s,o){if(null!=e){const{data:t}=o.getMutableAttribute("normal");t[0]=e[0],t[1]=e[1],t[2]=e[2]}if(null!=t){const{data:e}=o.getMutableAttribute("position");e[0]=t[0],e[1]=t[1],e[2]=t[2]}if(null!=i){const{data:e}=o.getMutableAttribute("color");e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3]}if(null!=r){const{data:e}=o.getMutableAttribute("size");e[0]=r[0],e[1]=r[1]}if(null!=n){const{data:e}=o.getMutableAttribute("auxpos1");e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3]}if(null!=a){const{data:e}=o.getMutableAttribute("uv0");e[0]=a[0],e[1]=a[1]}if(null!=s){const{data:e}=o.getMutableAttribute("auxpos2");e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3]}},e.createPointArrayGeometry=function(e,t){const i=new Float32Array(3*e.length),r=new Float32Array(t?3*e.length:3),n=new Uint32Array(e.length),a=new Uint32Array(e.length);for(let s=0;s<e.length;s++)i[3*s]=e[s][0],i[3*s+1]=e[s][1],i[3*s+2]=e[s][2],t&&(r[3*s]=t[s][0],r[3*s+1]=t[s][1],r[3*s+2]=t[s][2]),n[s]=s,a[s]=0;return t||(r[0]=0,r[1]=1,r[2]=0),new d.a([["position",{size:3,data:i,exclusive:!0}],["normal",{size:3,data:r,exclusive:!0}],["uv0",{size:2,data:[0,0],exclusive:!0}]],[["position",n],["normal",t?n:a],["uv0",a]],1)},e.createTriangleGeometry=function(){const e=new Uint16Array([0,1,2]),t=new Uint16Array([0,0,0]),i=new Uint16Array([0,0,0]);return new d.a([["position",{size:3,data:[0,0,0,0,0,100,100,0,0],exclusive:!0}],["normal",{size:3,data:[0,1,0],exclusive:!0}],["uv0",{size:2,data:[0,0],exclusive:!0}]],[["position",e],["normal",t],["uv0",i]])};const t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function i(e,t,i,r,n){return!(Math.abs(Object(a.h)(t,e))>n)&&(Object(a.g)(i,e,t),Object(a.r)(i,i),Object(a.g)(r,i,e),Object(a.r)(r,r),!0)}function r(e,t,r,n,a,s,o){return i(e,t,a,s,o)||i(e,r,a,s,o)||i(e,n,a,s,o)}e.createSquareGeometry=function(e=t){const i=new Array(12);for(let t=0;t<4;t++)for(let r=0;r<3;r++)i[3*t+r]=e[t][r];const r=new Uint32Array([0,1,2,2,3,0]),n=new Uint32Array([0,0,0,0,0,0]);return new d.a([["position",{size:3,data:i,exclusive:!0}],["normal",{size:3,data:[0,0,1],exclusive:!0}],["uv0",{size:2,data:[0,0,1,0,1,1,0,1],exclusive:!0}],["color",{size:4,data:[255,255,255,255],exclusive:!0}]],[["position",r],["normal",n],["uv0",r],["color",n]])},e.createConeGeometry=function(e,t,i,r,n=!0,a=!0){let o=0;const c=t,l=e;let h=Object(s.c)(0,o,0),u=Object(s.c)(0,o+l,0),p=Object(s.c)(0,-1,0),f=Object(s.c)(0,1,0);r&&(o=l,u=Object(s.c)(0,0,0),h=Object(s.c)(0,o,0),p=Object(s.c)(0,1,0),f=Object(s.c)(0,-1,0));const b=[u,h],m=[p,f],g=i+2,v=Math.sqrt(l*l+c*c);if(r)for(let d=i-1;d>=0;d--){const e=d*(2*Math.PI/i),t=Object(s.c)(Math.cos(e)*c,o,Math.sin(e)*c);b.push(t);const r=Object(s.c)(l*Math.cos(e)/v,-c/v,l*Math.sin(e)/v);m.push(r)}else for(let d=0;d<i;d++){const e=d*(2*Math.PI/i),t=Object(s.c)(Math.cos(e)*c,o,Math.sin(e)*c);b.push(t);const r=Object(s.c)(l*Math.cos(e)/v,c/v,l*Math.sin(e)/v);m.push(r)}const y=new Uint32Array(2*(i+2)*3),O=new Uint32Array(2*(i+2)*3);let x=0,j=0;if(n){for(let e=3;e<b.length;e++)y[x++]=1,y[x++]=e-1,y[x++]=e,O[j++]=0,O[j++]=0,O[j++]=0;y[x++]=b.length-1,y[x++]=2,y[x++]=1,O[j++]=0,O[j++]=0,O[j++]=0}if(a){for(let e=3;e<b.length;e++)y[x++]=e,y[x++]=e-1,y[x++]=0,O[j++]=e,O[j++]=e-1,O[j++]=1;y[x++]=0,y[x++]=2,y[x++]=b.length-1,O[j++]=1,O[j++]=2,O[j++]=m.length-1}const _=new Float32Array(3*g);for(let s=0;s<g;s++)_[3*s]=b[s][0],_[3*s+1]=b[s][1],_[3*s+2]=b[s][2];const S=new Float32Array(3*g);for(let s=0;s<g;s++)S[3*s]=m[s][0],S[3*s+1]=m[s][1],S[3*s+2]=m[s][2];return new d.a([["position",{size:3,data:_,exclusive:!0}],["normal",{size:3,data:S,exclusive:!0}]],[["position",y],["normal",O]])},e.createCylinderGeometry=function(e,t,i,r,n,o){const c=r?Object(s.a)(r):Object(s.c)(1,0,0),l=n?Object(s.a)(n):Object(s.c)(0,0,0);o=null==o||o;const h=Object(s.b)();Object(a.r)(h,c);const u=Object(s.b)();Object(a.e)(u,h,Math.abs(e));const p=Object(s.b)();Object(a.e)(p,u,-.5),Object(a.f)(p,p,l);const f=Object(s.c)(0,1,0);Math.abs(1-Object(a.h)(h,f))<.2&&Object(a.w)(f,0,0,1);const b=Object(s.b)();Object(a.g)(b,h,f),Object(a.r)(b,b),Object(a.g)(f,b,h);const m=2*i+(o?2:0),g=i+(o?2:0),v=new Float32Array(3*m),y=new Float32Array(3*g),O=new Float32Array(2*m),x=new Uint32Array(3*i*(o?4:2)),j=new Uint32Array(3*i*(o?4:2));o&&(v[3*(m-2)+0]=p[0],v[3*(m-2)+1]=p[1],v[3*(m-2)+2]=p[2],O[2*(m-2)]=0,O[2*(m-2)+1]=0,v[3*(m-1)+0]=v[3*(m-2)+0]+u[0],v[3*(m-1)+1]=v[3*(m-2)+1]+u[1],v[3*(m-1)+2]=v[3*(m-2)+2]+u[2],O[2*(m-1)]=1,O[2*(m-1)+1]=1,y[3*(g-2)+0]=-h[0],y[3*(g-2)+1]=-h[1],y[3*(g-2)+2]=-h[2],y[3*(g-1)+0]=h[0],y[3*(g-1)+1]=h[1],y[3*(g-1)+2]=h[2]);const _=function(e,t,i){x[e]=t,j[e]=i};let S=0;const w=Object(s.b)(),C=Object(s.b)();for(let s=0;s<i;s++){const e=s*(2*Math.PI/i);Object(a.e)(w,f,Math.sin(e)),Object(a.e)(C,b,Math.cos(e)),Object(a.f)(w,w,C),y[3*s+0]=w[0],y[3*s+1]=w[1],y[3*s+2]=w[2],Object(a.e)(w,w,t),Object(a.f)(w,w,p),v[3*s+0]=w[0],v[3*s+1]=w[1],v[3*s+2]=w[2],O[2*s+0]=s/i,O[2*s+1]=0,v[3*(s+i)+0]=v[3*s+0]+u[0],v[3*(s+i)+1]=v[3*s+1]+u[1],v[3*(s+i)+2]=v[3*s+2]+u[2],O[2*(s+i)+0]=s/i,O[2*s+1]=1;const r=(s+1)%i;_(S++,s,s),_(S++,s+i,s),_(S++,r,r),_(S++,r,r),_(S++,s+i,s),_(S++,r+i,r)}if(o){for(let e=0;e<i;e++){const t=(e+1)%i;_(S++,m-2,g-2),_(S++,e,g-2),_(S++,t,g-2)}for(let e=0;e<i;e++){const t=(e+1)%i;_(S++,e+i,g-1),_(S++,m-1,g-1),_(S++,t+i,g-1)}}return new d.a([["position",{size:3,data:v,exclusive:!0}],["normal",{size:3,data:y,exclusive:!0}],["uv0",{size:2,data:O,exclusive:!0}]],[["position",x],["normal",j],["uv0",x]])},e.createTubeGeometry=function(t,i,r,n,a){r=r||10,n=null==n||n,Object(u.a)(t.length>1);const s=[],o=[];for(let e=0;e<r;e++){s.push([0,-e-1,-(e+1)%r-1]);const t=e/r*2*Math.PI;o.push([Math.cos(t)*i,Math.sin(t)*i])}return e.createPathExtrusionGeometry(o,t,[[0,0,0]],s,n,a)},e.createPathExtrusionGeometry=function(e,t,i,n,h,u=Object(s.c)(0,0,0)){const p=e.length,f=new Float32Array(t.length*p*3+(6*i.length||0)),b=new Float32Array(t.length*p*3+(i?6:0)),m=(t.length-1)*p*6+3*n.length*2,g=new Uint32Array(m),y=new Uint32Array(m);let O=0,x=0,j=0,_=0;const S=Object(s.b)(),w=Object(s.b)(),C=Object(s.b)(),P=Object(s.b)(),T=Object(s.b)(),E=Object(s.b)(),A=Object(s.b)(),R=Object(o.f)(),D=Object(s.b)(),M=Object(s.b)(),I=Object(s.b)(),z=Object(s.b)(),L=Object(s.b)(),F=Object(c.d)();Object(a.w)(D,0,1,0),Object(a.j)(w,t[1],t[0]),Object(a.r)(w,w),h?(Object(a.f)(R,t[0],u),Object(a.r)(C,R)):Object(a.w)(C,0,0,1),r(w,C,D,D,T,C,v),Object(a.k)(P,C),Object(a.k)(z,T);for(let r=0;r<i.length;r++)Object(a.e)(E,T,i[r][0]),Object(a.e)(R,C,i[r][2]),Object(a.f)(E,E,R),Object(a.f)(E,E,t[0]),f[O++]=E[0],f[O++]=E[1],f[O++]=E[2];b[x++]=-w[0],b[x++]=-w[1],b[x++]=-w[2];for(let r=0;r<n.length;r++)g[j++]=n[r][0]>0?n[r][0]:-n[r][0]-1+i.length,g[j++]=n[r][1]>0?n[r][1]:-n[r][1]-1+i.length,g[j++]=n[r][2]>0?n[r][2]:-n[r][2]-1+i.length,y[_++]=0,y[_++]=0,y[_++]=0;let V=i.length;const G=i.length-1;for(let s=0;s<t.length;s++){let i=!1;s>0&&(Object(a.k)(S,w),s<t.length-1?(Object(a.j)(w,t[s+1],t[s]),Object(a.r)(w,w)):i=!0,Object(a.f)(M,S,w),Object(a.r)(M,M),Object(a.f)(I,t[s-1],P),Object(c.g)(t[s],M,F),Object(c.m)(F,Object(l.g)(I,S),R)?(Object(a.j)(R,R,t[s]),Object(a.r)(C,R),Object(a.g)(T,M,C),Object(a.r)(T,T)):r(M,P,z,D,T,C,v),Object(a.k)(P,C),Object(a.k)(z,T)),h&&(Object(a.f)(R,t[s],u),Object(a.r)(L,R));for(let r=0;r<p;r++)if(Object(a.e)(E,T,e[r][0]),Object(a.e)(R,C,e[r][1]),Object(a.f)(E,E,R),Object(a.r)(A,E),b[x++]=A[0],b[x++]=A[1],b[x++]=A[2],Object(a.f)(E,E,t[s]),f[O++]=E[0],f[O++]=E[1],f[O++]=E[2],!i){const e=(r+1)%p;g[j++]=V+r,g[j++]=V+p+r,g[j++]=V+e,g[j++]=V+e,g[j++]=V+p+r,g[j++]=V+p+e;for(let t=0;t<6;t++)y[_++]=g[j-6+t]-G}V+=p}const U=t[t.length-1];for(let r=0;r<i.length;r++)Object(a.e)(E,T,i[r][0]),Object(a.e)(R,C,i[r][1]),Object(a.f)(E,E,R),Object(a.f)(E,E,U),f[O++]=E[0],f[O++]=E[1],f[O++]=E[2];const B=x/3;b[x++]=w[0],b[x++]=w[1],b[x++]=w[2];const N=V-p;for(let r=0;r<n.length;r++)g[j++]=n[r][0]>=0?V+n[r][0]:-n[r][0]-1+N,g[j++]=n[r][2]>=0?V+n[r][2]:-n[r][2]-1+N,g[j++]=n[r][1]>=0?V+n[r][1]:-n[r][1]-1+N,y[_++]=B,y[_++]=B,y[_++]=B;return new d.a([["position",{size:3,data:f,exclusive:!0}],["normal",{size:3,data:b,exclusive:!0}]],[["position",g],["normal",y]])},e.createPolylineGeometry=function(e,t,i){Object(u.a)(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),Object(u.a)(3===e[0].length,"createPolylineGeometry(): malformed vertex"),Object(u.a)(null==t||t.length===e.length,"createPolylineGeometry: need same number of points and normals"),Object(u.a)(null==t||3===t[0].length,"createPolylineGeometry(): malformed normal");const r=new Float64Array(3*e.length),n=new Uint32Array(2*(e.length-1));let a=0,s=0;for(let l=0;l<e.length;l++){for(let t=0;t<3;t++)r[a++]=e[l][t];l>0&&(n[s++]=l-1,n[s++]=l)}const o=[],c=[];if(o.push(["position",n]),c.push(["position",{size:3,data:r,exclusive:!0}]),t){const i=new Float32Array(3*t.length);let r=0;for(let n=0;n<e.length;n++)for(let e=0;e<3;e++)i[r++]=t[n][e];o.push(["normal",n]),c.push(["normal",{size:3,data:i,exclusive:!0}])}return i&&(c.push(["color",{size:4,data:i}]),o.push(["color",Object(h.d)(i.length/4)])),new d.a(c,o,2)},e.createExtrudedTriangle=function(e,t,i,r,n=0){const a=new Array(18),s=[[-t,n,r/2],[i,n,r/2],[0,e+n,r/2],[-t,n,-r/2],[i,n,-r/2],[0,e+n,-r/2]],o=new Uint16Array([0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5]);for(let c=0;c<6;c++)a[3*c]=s[c][0],a[3*c+1]=s[c][1],a[3*c+2]=s[c][2];return new d.a([["position",{size:3,data:a,exclusive:!0}]],[["position",o]])},e.transformInPlace=function(e,t){const i=e.getMutableAttribute("position").data;for(let r=0;r<i.length;r+=3){const e=i[r],n=i[r+1],s=i[r+2];Object(a.w)(y,e,n,s),Object(a.q)(y,y,t),i[r]=y[0],i[r+1]=y[1],i[r+2]=y[2]}},e.cgToGIS=function(e,t=e){const i=e.vertexAttributes,r=i.get("position").data,n=i.get("normal").data;if(n){const e=t.getMutableAttribute("normal").data;for(let t=0;t<n.length;t+=3){const i=n[t+1];e[t+1]=-n[t+2],e[t+2]=i}}if(r){const e=t.getMutableAttribute("position").data;for(let t=0;t<r.length;t+=3){const i=r[t+1];e[t+1]=-r[t+2],e[t+2]=i}}return t},e.makeOrthoBasisDirUp=i,e.makeOrthoBasisDirUpFallback=r}(g||(g={}));const v=.99619469809,y=Object(s.b)(),O=g},558:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r,n,a,s={exports:{}};r=s,n=function(){function e(e,i,n){n=n||2;var a,s,o,l,d,h,u,p=i&&i.length,f=p?i[0]*n:e.length,b=t(e,0,f,n,!0),m=[];if(!b||b.next===b.prev)return m;if(p&&(b=c(e,i,b,n)),e.length>80*n){a=o=e[0],s=l=e[1];for(var g=n;g<f;g+=n)(d=e[g])<a&&(a=d),(h=e[g+1])<s&&(s=h),d>o&&(o=d),h>l&&(l=h);u=0!==(u=Math.max(o-a,l-s))?1/u:0}return r(b,m,n,a,s,u),m}function t(e,t,i,r,n){var a,s;if(n===T(e,t,i,r)>0)for(a=t;a<i;a+=r)s=w(a,e[a],e[a+1],s);else for(a=i-r;a>=t;a-=r)s=w(a,e[a],e[a+1],s);if(s&&y(s,s.next)){var o=s.next;C(s),s=o}return s}function i(e,t){if(!e)return e;t||(t=e);var i,r=e;do{if(i=!1,r.steiner||!y(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{var n=r.prev;if(C(r),(r=t=n)===r.next)break;i=!0}}while(i||r!==t);return t}function r(e,t,c,l,d,h,u){if(e){!u&&h&&p(e,l,d,h);for(var f,b,m=e;e.prev!==e.next;)if(f=e.prev,b=e.next,h?a(e,l,d,h):n(e))t.push(f.i/c),t.push(e.i/c),t.push(b.i/c),C(e),e=b.next,m=b.next;else if((e=b)===m){u?1===u?r(e=s(i(e),t,c),t,c,l,d,h,2):2===u&&o(e,t,c,l,d,h):r(i(e),t,c,l,d,h,1);break}}}function n(e){var t=e.prev,i=e,r=e.next;if(v(t,i,r)>=0)return!1;for(var n=e.next.next;n!==e.prev;){if(m(t.x,t.y,i.x,i.y,r.x,r.y,n.x,n.y)&&v(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function a(e,t,i,r){var n=e.prev,a=e,s=e.next;if(v(n,a,s)>=0)return!1;for(var o=n.x<a.x?n.x<s.x?n.x:s.x:a.x<s.x?a.x:s.x,c=n.y<a.y?n.y<s.y?n.y:s.y:a.y<s.y?a.y:s.y,l=n.x>a.x?n.x>s.x?n.x:s.x:a.x>s.x?a.x:s.x,d=n.y>a.y?n.y>s.y?n.y:s.y:a.y>s.y?a.y:s.y,h=f(o,c,t,i,r),u=f(l,d,t,i,r),p=e.prevZ,b=e.nextZ;p&&p.z>=h&&b&&b.z<=u;){if(p!==e.prev&&p!==e.next&&m(n.x,n.y,a.x,a.y,s.x,s.y,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,b!==e.prev&&b!==e.next&&m(n.x,n.y,a.x,a.y,s.x,s.y,b.x,b.y)&&v(b.prev,b,b.next)>=0)return!1;b=b.nextZ}for(;p&&p.z>=h;){if(p!==e.prev&&p!==e.next&&m(n.x,n.y,a.x,a.y,s.x,s.y,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;b&&b.z<=u;){if(b!==e.prev&&b!==e.next&&m(n.x,n.y,a.x,a.y,s.x,s.y,b.x,b.y)&&v(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function s(e,t,r){var n=e;do{var a=n.prev,s=n.next.next;!y(a,s)&&O(a,n,n.next,s)&&_(a,s)&&_(s,a)&&(t.push(a.i/r),t.push(n.i/r),t.push(s.i/r),C(n),C(n.next),n=e=s),n=n.next}while(n!==e);return i(n)}function o(e,t,n,a,s,o){var c=e;do{for(var l=c.next.next;l!==c.prev;){if(c.i!==l.i&&g(c,l)){var d=S(c,l);return c=i(c,c.next),d=i(d,d.next),r(c,t,n,a,s,o),void r(d,t,n,a,s,o)}l=l.next}c=c.next}while(c!==e)}function c(e,r,n,a){var s,o,c,d=[];for(s=0,o=r.length;s<o;s++)(c=t(e,r[s]*a,s<o-1?r[s+1]*a:e.length,a,!1))===c.next&&(c.steiner=!0),d.push(b(c));for(d.sort(l),s=0;s<d.length;s++)n=i(n=h(d[s],n),n.next);return n}function l(e,t){return e.x-t.x}function d(e){if(e.next.prev===e)return e;let t=e;for(;;){const i=t.next;if(i.prev===t||i===t||i===e)break;t=i}return t}function h(e,t){var r=function(e,t){var i,r=t,n=e.x,a=e.y,s=-1/0;do{if(a<=r.y&&a>=r.next.y&&r.next.y!==r.y){var o=r.x+(a-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(o<=n&&o>s){if(s=o,o===n){if(a===r.y)return r;if(a===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!i)return null;if(n===s)return i;var c,l=i,d=i.x,h=i.y,p=1/0;r=i;do{n>=r.x&&r.x>=d&&n!==r.x&&m(a<h?n:s,a,d,h,a<h?s:n,a,r.x,r.y)&&(c=Math.abs(a-r.y)/(n-r.x),_(r,e)&&(c<p||c===p&&(r.x>i.x||r.x===i.x&&u(i,r)))&&(i=r,p=c)),r=r.next}while(r!==l);return i}(e,t);if(!r)return t;var n=S(r,e),a=i(r,r.next);let s=d(n);return i(s,s.next),a=d(a),d(t===r?a:t)}function u(e,t){return v(e.prev,e,t.prev)<0&&v(t.next,e,e.next)<0}function p(e,t,i,r){var n=e;do{if(null===n.z&&(n.z=f(n.x,n.y,t,i,r)),n.prev.next!==n||n.next.prev!==n)return n.prev.next=n,n.next.prev=n,p(e,t,i,r);n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,function(e){var t,i,r,n,a,s,o,c,l=1;do{for(i=e,e=null,a=null,s=0;i;){for(s++,r=i,o=0,t=0;t<l&&(o++,r=r.nextZ);t++);for(c=l;o>0||c>0&&r;)0!==o&&(0===c||!r||i.z<=r.z)?(n=i,i=i.nextZ,o--):(n=r,r=r.nextZ,c--),a?a.nextZ=n:e=n,n.prevZ=a,a=n;i=r}a.nextZ=null,l*=2}while(s>1)}(n)}function f(e,t,i,r,n){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*n)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*n)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function b(e){var t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function m(e,t,i,r,n,a,s,o){return(n-s)*(t-o)-(e-s)*(a-o)>=0&&(e-s)*(r-o)-(i-s)*(t-o)>=0&&(i-s)*(a-o)-(n-s)*(r-o)>=0}function g(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&O(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&(_(e,t)&&_(t,e)&&function(e,t){var i=e,r=!1,n=(e.x+t.x)/2,a=(e.y+t.y)/2;do{i.y>a!=i.next.y>a&&i.next.y!==i.y&&n<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==e);return r}(e,t)&&(v(e.prev,e,t.prev)||v(e,t.prev,t))||y(e,t)&&v(e.prev,e,e.next)>0&&v(t.prev,t,t.next)>0)}function v(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function y(e,t){return e.x===t.x&&e.y===t.y}function O(e,t,i,r){var n=j(v(e,t,i)),a=j(v(e,t,r)),s=j(v(i,r,e)),o=j(v(i,r,t));return n!==a&&s!==o||!(0!==n||!x(e,i,t))||!(0!==a||!x(e,r,t))||!(0!==s||!x(i,e,r))||!(0!==o||!x(i,t,r))}function x(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function j(e){return e>0?1:e<0?-1:0}function _(e,t){return v(e.prev,e,e.next)<0?v(e,t,e.next)>=0&&v(e,e.prev,t)>=0:v(e,t,e.prev)<0||v(e,e.next,t)<0}function S(e,t){var i=new P(e.i,e.x,e.y),r=new P(t.i,t.x,t.y),n=e.next,a=t.prev;return e.next=t,t.prev=e,i.next=n,n.prev=i,r.next=i,i.prev=r,a.next=r,r.prev=a,r}function w(e,t,i,r){var n=new P(e,t,i);return r?(n.next=r.next,n.prev=r,r.next.prev=n,r.next=n):(n.prev=n,n.next=n),n}function C(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function P(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function T(e,t,i,r){for(var n=0,a=t,s=i-r;a<i;a+=r)n+=(e[s]-e[a])*(e[a+1]+e[s+1]),s=a;return n}return e.deviation=function(e,t,i,r){var n=t&&t.length,a=n?t[0]*i:e.length,s=Math.abs(T(e,0,a,i));if(n)for(var o=0,c=t.length;o<c;o++){var l=t[o]*i,d=o<c-1?t[o+1]*i:e.length;s-=Math.abs(T(e,l,d,i))}var h=0;for(o=0;o<r.length;o+=3){var u=r[o]*i,p=r[o+1]*i,f=r[o+2]*i;h+=Math.abs((e[u]-e[f])*(e[p+1]-e[u+1])-(e[u]-e[p])*(e[f+1]-e[u+1]))}return 0===s&&0===h?0:Math.abs((h-s)/s)},e.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},r=0,n=0;n<e.length;n++){for(var a=0;a<e[n].length;a++)for(var s=0;s<t;s++)i.vertices.push(e[n][a][s]);n>0&&(r+=e[n-1].length,i.holes.push(r))}return i},e},void 0!==(a=n())&&(r.exports=a);const o=s.exports},564:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return a}));var r=i(85);class n{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}destroy(){this._map.forEach(((e,t)=>{Object(r.l)(e)&&this._repository.release(this._material,a(t))}))}load(e,t){this._map.has(t)||this._map.set(t,this._repository.acquire(this._material,a(t)));const i=this._map.get(t);if(Object(r.l)(i)){if(2===i.ensureResources(e))return i;this._repository.requestRender()}return null}}function a(e){switch(e){default:return 0;case 1:return 7;case 4:case 7:case 6:return 3;case 3:return 2;case 2:return 1;case 5:return 4}}},565:function(e,t,i){"use strict";i.d(t,"a",(function(){return x})),i.d(t,"b",(function(){return r})),i.d(t,"c",(function(){return O})),i.d(t,"d",(function(){return f})),i.d(t,"e",(function(){return g})),i.d(t,"f",(function(){return m})),i.d(t,"g",(function(){return b})),i.d(t,"h",(function(){return v})),i.d(t,"i",(function(){return y}));var r,n,a=i(211),s=i(85),o=i(149),c=i(199),l=i(106),d=i(207),h=i(744),u=i(515),p=i(684);function f(e,t,i,r,n,a,s,o,c,l,h){const u=j[h.mode];let p,f,b=0;if(Object(d.l)(e,t,i,r,c.spatialReference,n,o))return u.requiresAlignment(h)?(b=u.applyElevationAlignmentBuffer(r,n,a,s,o,c,l,h),p=a,f=s):(p=r,f=n),Object(d.l)(p,c.spatialReference,f,a,l.spatialReference,s,o)?b:void 0}function b(e,t,i,r,n){const o=(Object(h.a)(e)?e.z:Object(p.c)(e)?e.array[e.offset+2]:e[2])||0;switch(i.mode){case"on-the-ground":{const i=Object(s.u)(Object(p.b)(t,e,"ground"),0);return n.verticalDistanceToGround=0,n.sampledElevation=i,void(n.z=i)}case"relative-to-ground":{const a=Object(s.u)(Object(p.b)(t,e,"ground"),0),c=i.geometryZWithOffset(o,r);return n.verticalDistanceToGround=c,n.sampledElevation=a,void(n.z=c+a)}case"relative-to-scene":{const a=Object(s.u)(Object(p.b)(t,e,"scene"),0),c=i.geometryZWithOffset(o,r);return n.verticalDistanceToGround=c,n.sampledElevation=a,void(n.z=c+a)}case"absolute-height":{const a=i.geometryZWithOffset(o,r),c=Object(s.u)(Object(p.b)(t,e,"ground"),0);return n.verticalDistanceToGround=a-c,n.sampledElevation=c,void(n.z=a)}default:return Object(a.a)(i.mode),void(n.z=0)}}function m(e,t,i,r){return b(e,t,i,r,S),S.z}function g(e,t,i){return null==t||null==i?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===i?e.staysOnTheGround:t===i||"on-the-ground"!==t&&"on-the-ground"!==i?r.UPDATE:e.onTheGroundChanged}function v(e){return"relative-to-ground"===e||"relative-to-scene"===e}function y(e){return"absolute-height"!==e}function O(e,t,i,r,n){b(t,i,n,r,S),Object(u.i)(e,S.verticalDistanceToGround);const a=S.sampledElevation,s=Object(o.d)(_,e.transformation);return w[0]=t.x,w[1]=t.y,w[2]=S.z,Object(d.d)(t.spatialReference,w,s,r.spatialReference)?e.transformation=s:console.warn("Could not locate symbol object properly, it might be misplaced"),a}class x{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}(n=r||(r={}))[n.NONE=0]="NONE",n[n.UPDATE=1]="UPDATE",n[n.RECREATE=2]="RECREATE";const j={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,i,r,n,a,s,o){const c=o.calculateOffsetRenderUnits(s),l=o.featureExpressionInfoContext;t*=3,r*=3;for(let d=0;d<n;++d){const n=e[t+0],a=e[t+1],s=e[t+2];i[r+0]=n,i[r+1]=a,i[r+2]=null==l?s+c:c,t+=3,r+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,i=e.featureExpressionInfoContext;return 0!==t||null!=i}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,i,r,n,a){let o=0;const c=a.spatialReference;t*=3,r*=3;for(let l=0;l<n;++l){const n=e[t+0],l=e[t+1],d=e[t+2],h=Object(s.u)(a.getElevation(n,l,d,c,"ground"),0);o+=h,i[r+0]=n,i[r+1]=l,i[r+2]=h,t+=3,r+=3}return o/n},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,i,r,n,a,o,c){let l=0;const d=c.calculateOffsetRenderUnits(o),h=c.featureExpressionInfoContext,u=a.spatialReference;t*=3,r*=3;for(let p=0;p<n;++p){const n=e[t+0],o=e[t+1],c=e[t+2],p=Object(s.u)(a.getElevation(n,o,c,u,"ground"),0);l+=p,i[r+0]=n,i[r+1]=o,i[r+2]=null==h?c+p+d:p+d,t+=3,r+=3}return l/n},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,i,r,n,a,o,c){let l=0;const d=c.calculateOffsetRenderUnits(o),h=c.featureExpressionInfoContext,u=a.spatialReference;t*=3,r*=3;for(let p=0;p<n;++p){const n=e[t+0],o=e[t+1],c=e[t+2],p=Object(s.u)(a.getElevation(n,o,c,u,"scene"),0);l+=p,i[r+0]=n,i[r+1]=o,i[r+2]=null==h?c+p+d:p+d,t+=3,r+=3}return l/n},requiresAlignment:()=>!0}},_=Object(c.d)(),S=new x,w=Object(l.f)()},580:function(e,t,i){"use strict";i.d(t,"a",(function(){return f})),i.d(t,"b",(function(){return p})),i.d(t,"c",(function(){return s})),i.d(t,"d",(function(){return l})),i.d(t,"e",(function(){return o}));var r=i(113),n=i(116),a=i(106);function s(e){const t=e[0]*e[0]+e[4]*e[4]+e[8]*e[8],i=e[1]*e[1]+e[5]*e[5]+e[9]*e[9],r=e[2]*e[2]+e[6]*e[6]+e[10]*e[10];return Math.sqrt(Math.max(t,i,r))}function o(e,t){const i=Math.sqrt(t[0]*t[0]+t[4]*t[4]+t[8]*t[8]),r=Math.sqrt(t[1]*t[1]+t[5]*t[5]+t[9]*t[9]),a=Math.sqrt(t[2]*t[2]+t[6]*t[6]+t[10]*t[10]);return Object(n.w)(e,i,r,a),e}class c{constructor(e,t){this.min=e,this.max=t,this.range=t-e}ndiff(e,t=0){return Math.ceil((e-t)/this.range)*this.range+t}_normalize(e,t,i,r=0,n=!1){return(i-=r)<e?i+=this.ndiff(e-i):i>t&&(i-=this.ndiff(i-t)),n&&i===t&&(i=e),i+r}normalize(e,t=0,i=!1){return this._normalize(this.min,this.max,e,t,i)}clamp(e,t=0){return Object(r.e)(e-t,this.min,this.max)+t}monotonic(e,t,i){return e<t?t:t+this.ndiff(e-t,i)}minimalMonotonic(e,t,i){return this._normalize(e,e+this.range,t,i)}center(e,t,i){return t=this.monotonic(e,t,i),this.normalize((e+t)/2,i)}diff(e,t,i){return this.monotonic(e,t,i)-e}shortestSignedDiff(e,t){e=this.normalize(e);const i=(t=this.normalize(t))-e,r=t<e?this.minimalMonotonic(e,t)-e:t-this.minimalMonotonic(t,e);return Math.abs(i)<Math.abs(r)?i:r}contains(e,t,i){return t=this.minimalMonotonic(e,t),(i=this.minimalMonotonic(e,i))>e&&i<t}}function l(e,t,i,r){Object(n.j)(d,t,e),Object(n.j)(h,i,e),Object(n.g)(r,d,h),Object(n.r)(r,r),r[3]=-Object(n.h)(e,r)}const d=Object(a.f)(),h=Object(a.f)();function u(e){for(const t in e){const i=e[t];i instanceof Function&&(e[t]=i.bind(e))}return e}u(new c(0,2*Math.PI));const p=u(new c(-Math.PI,Math.PI)),f=u(new c(0,360));Object(a.f)(),Object(a.f)(),Object(a.f)()},590:function(e,t,i){"use strict";i.d(t,"a",(function(){return m})),i.d(t,"b",(function(){return u})),i.d(t,"c",(function(){return h})),i.d(t,"d",(function(){return l}));var r=i(122),n=(i(82),i(89)),a=i(85),s=i(554),o=i(98),c=i(416);function l(e){return"declaredClass"in e}function d(e){return"declaredClass"in e}function h(e,t){if(!e)return null;if("declaredClass"in e)return e;const i=new r.a({layer:t,sourceLayer:t});return i.visible=e.visible,i.symbol=Object(n.a)(e.symbol),i.attributes=Object(n.a)(e.attributes),i.geometry=u(e.geometry),i}function u(e){return Object(a.k)(e)?null:l(e)?e:Object(o.a)(function(e){const t=e.spatialReference.toJSON();switch(e.type){case"point":{const{x:i,y:r,z:n,m:a}=e;return{x:i,y:r,z:n,m:a,spatialReference:t}}case"polygon":{const{rings:i,hasZ:r,hasM:n}=e;return{rings:p(i),hasZ:r,hasM:n,spatialReference:t}}case"polyline":{const{paths:i,hasZ:r,hasM:n}=e;return{paths:p(i),hasZ:r,hasM:n,spatialReference:t}}case"extent":{const{xmin:i,xmax:r,ymin:n,ymax:a,zmin:s,zmax:o,mmin:c,mmax:l,hasZ:d,hasM:h}=e;return{xmin:i,xmax:r,ymin:n,ymax:a,zmin:s,zmax:o,mmin:c,mmax:l,hasZ:d,hasM:h,spatialReference:t}}case"multipoint":{const{points:i,hasZ:r,hasM:n}=e;return{points:b(i)?f(i):i,hasZ:r,hasM:n,spatialReference:t}}default:return}}(e))}function p(e){return function(e){for(const t of e)if(0!==t.length)return b(t);return!1}(e)?e.map((e=>f(e))):e}function f(e){return e.map((e=>Object(s.n)(e)))}function b(e){return e.length&&(Object(s.d)(e[0])||Object(s.e)(e[0]))}function m(e,t){if(!e)return null;let i;if(d(e)){if(null==t)return e.clone();if(d(t))return t.copy(e)}return null!=t?(i=t,i.x=e.x,i.y=e.y,i.spatialReference=e.spatialReference,e.hasZ?(i.z=e.z,i.hasZ=e.hasZ):(i.z=null,i.hasZ=!1),e.hasM?(i.m=e.m,i.hasM=!0):(i.m=null,i.hasM=!1)):(i=Object(c.g)(e.x,e.y,e.z,e.spatialReference),e.hasM&&(i.m=e.m,i.hasM=!0)),i}},592:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var r=i(79),n=i(86),a=i(81),s=(i(84),i(82),i(83),i(80)),o=i(98);let c=class extends n.a{constructor(e){super(e),this.geometries=null,this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const e=this.geometries.map((function(e){return e.toJSON()})),t=this.geometries[0],i={};return i.outSR=this.outSpatialReference.wkid||JSON.stringify(this.outSpatialReference.toJSON()),i.inSR=t.spatialReference.wkid||JSON.stringify(t.spatialReference.toJSON()),i.geometries=JSON.stringify({geometryType:Object(o.c)(t),geometries:e}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),null!=this.transformForward&&(i.transformForward=this.transformForward),i}};Object(r.a)([Object(a.b)()],c.prototype,"geometries",void 0),Object(r.a)([Object(a.b)({json:{read:{source:"outSR"}}})],c.prototype,"outSpatialReference",void 0),Object(r.a)([Object(a.b)()],c.prototype,"transformation",void 0),Object(r.a)([Object(a.b)()],c.prototype,"transformForward",void 0),c=Object(r.a)([Object(s.a)("esri.rest.support.ProjectParameters")],c);const l=c},598:function(e,t,i){"use strict";function r(e){return 32+e.length}function n(e){if(!e)return 0;let t=32;for(const i in e)if(e.hasOwnProperty(i)){const n=e[i];switch(typeof n){case"string":t+=r(n);break;case"number":t+=16;break;case"boolean":t+=4}}return t}function a(e,t){return 32+e.length*t}i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return a}))},607:function(e,t,i){"use strict";i.d(t,"a",(function(){return g}));var r=i(85),n=i(149),a=i(199),s=i(116),o=i(106),c=i(440),l=i(580),d=i(601),h=i(222),u=i(251);class p{constructor(){this._disposed=!1}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(e,t,i,r,n,a){this.id=Object(u.a)(),this.geometry=e,this.material=t,this.transformation=i,this.instanceParameters=r,this.origin=n,this._shaderTransformation=a,this._disposed=!1}release(){this._disposed=!1}dispose(){this._disposed=!0}getStaticTransformation(){return this.transformation}getShaderTransformation(){return Object(r.l)(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(e){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,e):this.geometry.computeAttachmentOrigin(e))&&(Object(s.q)(e,e,this.getStaticTransformation()),!0)}}p.pool=new h.a(p);var f=i(743),b=i(315),m=i(529);class g extends d.a{constructor(e={}){super(),this.type=1,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=Object(a.d)(),this._bvObjectSpace=new y,this._bvWorldSpace=new y,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=null==e.castShadow||e.castShadow,this.metadata=e.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new v),this.transformation=Object(a.d)();const{geometries:t,materials:i,transformations:r,origins:n}=e;if(Array.isArray(t)){Object(b.a)(i.length===t.length,"Object3D: materials don't match geometries"),Object(b.a)(r.length===t.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=t.length,this._geometries.length=t.length;for(let e=0;e<t.length;e++)this._geometries[e]=t[e],this._geometryRecords[e]=p.pool.acquire(t[e],i[e],Object(a.c)(r[e]),{highlights:null,occludees:null,visible:this._visible},n&&n[e])}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(e){Object(n.d)(this._objectTransformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}dispose(){this._geometryRecords.length=0,this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){Object(b.a)(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e,t,i,n,s){i=i||a.a,this._geometries.push(e);const o=p.pool.acquire(e,t,i,{highlights:null,occludees:null,visible:this._visible},n,s);return this._geometryRecords.push(o),this._hasVolatileTransformation=this._hasVolatileTransformation||Object(r.l)(o.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:o}),this._invalidateBoundingVolume(),o}removeGeometry(e){const t=this._geometryRecords.splice(e,1)[0];return this._hasVolatileTransformation=Object(r.l)(t.shaderTransformation)?this._geometryRecords.some((e=>Object(r.l)(e.shaderTransformation))):this._hasVolatileTransformation,t.dispose(),this._geometries.splice(e,1),this._emit("objectGeometryRemoved",{object:this,record:t}),this._invalidateBoundingVolume(),t}removeAllGeometries(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(e){this._emit("vertexAttrsUpdated",{object:this,record:e}),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(e){if(this._visible!==e){this._visible=e;for(const e of this._geometryRecords)e.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new f.a(1);for(const t of this._geometryRecords)t.instanceParameters.occludees=Object(m.a)(t.instanceParameters.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometryRecords)t.instanceParameters.occludees=Object(m.e)(t.instanceParameters.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new f.a(0);for(const t of this._geometryRecords)t.instanceParameters.highlights=Object(m.a)(t.instanceParameters.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const t of this._geometryRecords)t.instanceParameters.highlights=Object(m.e)(t.instanceParameters.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,t){return Object(n.n)(Object(r.u)(t,Object(a.d)()),this.transformation,e.getStaticTransformation())}getCombinedShaderTransformation(e,t){return t=t||Object(a.d)(),Object(n.n)(t,this.transformation,e.getShaderTransformation()),t}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let n=0;n<this._geometryRecords.length;++n){const e=this._geometries[n],t=this._geometryRecords[n],i=e.boundingInfo;Object(r.l)(i)&&(this._calculateTransformedBoundingVolume(i,this._bvObjectSpace,t.getShaderTransformation()),this._calculateTransformedBoundingVolume(i,this._bvWorldSpace,this.getCombinedShaderTransformation(t)))}Object(s.i)(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),Object(s.i)(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const e=Object(o.f)(),t=Object(o.f)(),i=Object(l.c)(this.transformation);for(let n=0;n<this._geometryRecords.length;++n){const a=this._geometries[n].boundingInfo;if(Object(r.k)(a))continue;const o=this._geometryRecords[n].getShaderTransformation(),c=Object(l.c)(o);Object(s.q)(e,a.getCenter(),o);const d=Object(s.m)(e,this._bvObjectSpace.bounds),h=a.getBSRadius()*c;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],d+h),Object(s.q)(t,e,this.transformation);const u=Object(s.m)(t,this._bvWorldSpace.bounds),p=h*i;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],u+p)}this._bvDirty=!1}_calculateTransformedBoundingVolume(e,t,i){const r=e.getBBMin(),n=e.getBBMax(),a=Object(o.d)(r),c=Object(o.d)(n);Object(s.q)(a,a,i),Object(s.q)(c,c,i);for(let s=0;s<3;++s)t.min[s]=Math.min(t.min[s],a[s],c[s]),t.max[s]=Math.max(t.max[s],a[s],c[s]);for(let o=0;o<3;++o){Object(s.k)(a,r),Object(s.k)(c,n),a[o]=n[o],c[o]=r[o],Object(s.q)(a,a,i),Object(s.q)(c,c,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],a[e],c[e]),t.max[e]=Math.max(t.max[e],a[e],c[e])}}_invalidateBoundingVolume(){this._bvDirty=!0,Object(r.l)(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(e,t){Object(r.l)(this._parentLayer)&&this._parentLayer.events.emit(e,t)}get test(){const e=this;return{hasGeometry:t=>e._geometries.indexOf(t)>-1,getGeometryIndex:t=>e._geometries.indexOf(t)}}}class v{constructor(){this.min=Object(o.h)(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=Object(o.h)(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class y extends v{constructor(){super(...arguments),this.bounds=Object(c.c)()}init(){Object(s.w)(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),Object(s.w)(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),Object(c.a)(this.bounds)}}},609:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return n}));var r=i(98);function n(e){return{geometryType:Object(r.c)(e[0]),geometries:e.map((e=>e.toJSON()))}}function a(e,t,i){const n=Object(r.b)(t);return e.map((e=>{const t=n.fromJSON(e);return t.spatialReference=i,t}))}},611:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r=i(79),n=i(99),a=i(81),s=(i(84),i(82),i(83),i(80));let o=class extends n.a{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};Object(r.a)([Object(a.b)()],o.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),Object(r.a)([Object(a.b)()],o.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),o=Object(r.a)([Object(s.a)("esri.views.support.DebugFlags")],o);const c=new o},624:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(85),n=i(594),a=i(813);class s{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=Object(n.a)(e)}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const i=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?i:e+i}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return null!=i&&(t+=Object(a.d)(i)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=Object(n.c)(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=Object(r.u)(e.offset,0)}updateFeatureExpressionInfoContext(e,t,i){if(Object(r.k)(e))return void(this._featureExpressionInfoContext=null);const n=e&&e.arcade;n&&Object(r.l)(t)&&Object(r.l)(i)?(this._featureExpressionInfoContext=Object(a.a)(e),Object(a.f)(this._featureExpressionInfoContext,Object(a.c)(n.modules,t,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new s;return Object(r.l)(e)&&t.setFromElevationInfo(e),t}}},640:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(88);class n{constructor(e,t,i=""){this.major=e,this.minor=t,this._context=i}lessThan(e,t){return this.major<e||e===this.major&&this.minor<t}since(e,t){return!this.lessThan(e,t)}validate(e){if(this.major!==e.major){const t=this._context&&this._context+":",i=this._context&&this._context+" ";throw new r.a(t+"unsupported-version",`Required major ${i}version is '${this.major}', but got '\${version.major}.\${version.minor}'`,{version:e})}}clone(){return new n(this.major,this.minor,this._context)}static parse(e,t=""){const[i,a]=e.split("."),s=/^\s*\d+\s*$/;if(!i||!i.match||!i.match(s))throw new r.a((t&&t+":")+"invalid-version","Expected major version to be a number, but got '${version}'",{version:e});if(!a||!a.match||!a.match(s))throw new r.a((t&&t+":")+"invalid-version","Expected minor version to be a number, but got '${version}'",{version:e});const o=parseInt(i,10),c=parseInt(a,10);return new n(o,c,t)}}},650:function(e,t,i){"use strict";i.d(t,"a",(function(){return p})),i.d(t,"b",(function(){return u})),i.d(t,"c",(function(){return f})),i.d(t,"d",(function(){return m})),i.d(t,"e",(function(){return b}));var r=i(412),n=i(149),a=i(116),s=i(106),o=i(237),c=i(245),l=i(707),d=i(362),h=i(272);function u(e){return e?[Object(d.d)(e[0]),Object(d.d)(e[1]),Object(d.d)(e[2]),Object(d.d)(e[3]),Object(d.d)(e[4]),Object(d.d)(e[5])]:[Object(d.d)(),Object(d.d)(),Object(d.d)(),Object(d.d)(),Object(d.d)(),Object(d.d)()]}function p(e,t=u()){for(let i=0;i<6;i++)Object(d.c)(e[i],t[i])}function f(e,t,i,r=v){const s=Object(n.n)(h.a.get(),t,e);Object(n.c)(s,s);for(let n=0;n<8;++n){const e=Object(o.m)(h.e.get(),g[n],s);Object(a.w)(r[n],e[0]/e[3],e[1]/e[3],e[2]/e[3])}!function(e,t){Object(d.f)(t[4],t[0],t[3],e[0]),Object(d.f)(t[1],t[5],t[6],e[1]),Object(d.f)(t[4],t[5],t[1],e[2]),Object(d.f)(t[3],t[2],t[6],e[3]),Object(d.f)(t[0],t[1],t[2],e[4]),Object(d.f)(t[5],t[4],t[7],e[5])}(i,r)}function b(e,t){for(let i=0;i<6;i++){const r=e[i];if(r[0]*t[0]+r[1]*t[1]+r[2]*t[2]+r[3]>=t[3])return!1}return!0}function m(e,t){for(let i=0;i<6;i++){const r=e[i];if(!Object(d.b)(r,t))return!1}return!0}const g=[Object(c.g)(-1,-1,-1,1),Object(c.g)(1,-1,-1,1),Object(c.g)(1,1,-1,1),Object(c.g)(-1,1,-1,1),Object(c.g)(-1,-1,1,1),Object(c.g)(1,-1,1,1),Object(c.g)(1,1,1,1),Object(c.g)(-1,1,1,1)],v=(new r.a(l.a),[Object(s.f)(),Object(s.f)(),Object(s.f)(),Object(s.f)(),Object(s.f)(),Object(s.f)(),Object(s.f)(),Object(s.f)()])},661:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return o})),i.d(t,"c",(function(){return a})),i.d(t,"d",(function(){return s}));var r=i(514),n=i(602);const a=Object(r.a)().vec3f("position"),s=Object(r.a)().vec3f("position").vec2f("uv0"),o=Object(r.a)().vec3f("position").vec4u8("color");class c{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,r){Object(n.c)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)}}},664:function(e,t,i){"use strict";i.d(t,"a",(function(){return d}));var r=i(102),n=i(83),a=i(98),s=i(127),o=i(609),c=i(592);const l=Object(n.m)(c.a);async function d(e,t,i){t=l(t);const n=Object(s.c)(e),c={...n.query,f:"json",...t.toJSON()},d=t.outSpatialReference,h=Object(a.c)(t.geometries[0]),u=Object(s.a)(c,i);return Object(r.default)(n.path+"/project",u).then((({data:{geometries:e}})=>Object(o.a)(e,h,d)))}},670:function(e,t,i){"use strict";function r(e,t=0){const i=e.stride;return e.fieldNames.filter((t=>{const i=e.fields.get(t).optional;return!(i&&i.glPadding)})).map((r=>{const a=e.fields.get(r),s=a.constructor.ElementCount,o=n(a.constructor.ElementType),c=a.offset,l=!(!a.optional||!a.optional.glNormalized);return{name:r,stride:i,count:s,type:o,offset:c,normalized:l,divisor:t}}))}function n(e){const t=a[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}i.d(t,"a",(function(){return r}));const a={u8:5121,u16:5123,u32:5125,i8:5120,i16:5122,i32:5124,f32:5126}},675:function(e,t,i){"use strict";i.d(t,"a",(function(){return g})),i.d(t,"b",(function(){return q})),i.d(t,"c",(function(){return m})),i.d(t,"d",(function(){return E})),i.d(t,"e",(function(){return v})),i.d(t,"f",(function(){return T})),i.d(t,"g",(function(){return x})),i.d(t,"h",(function(){return j})),i.d(t,"i",(function(){return D})),i.d(t,"j",(function(){return R})),i.d(t,"k",(function(){return y}));i(82);var r=i(87),n=i(113),a=i(412),s=i(149),o=i(199),c=i(116),l=i(106),d=i(456),h=i(362),u=i(332),p=i(449),f=i(272);const b=r.a.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");function m(e=F){return{plane:Object(h.d)(e.plane),origin:Object(l.d)(e.origin),basis1:Object(l.d)(e.basis1),basis2:Object(l.d)(e.basis2)}}function g(e,t=m()){return v(e.origin,e.basis1,e.basis2,t)}function v(e,t,i,r=m()){return Object(c.k)(r.origin,e),Object(c.k)(r.basis1,t),Object(c.k)(r.basis2,i),y(r),function(e,t){Math.abs(Object(c.h)(e.basis1,e.basis2)/(Object(c.p)(e.basis1)*Object(c.p)(e.basis2)))>1e-6&&b.warn(t,"Provided basis vectors are not perpendicular"),Math.abs(Object(c.h)(e.basis1,D(e)))>1e-6&&b.warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-Object(c.h)(D(e),e.origin)-e.plane[3])>1e-6&&b.warn(t,"Plane offset is not consistent with plane origin")}(r,"fromValues()"),r}function y(e){Object(h.i)(e.basis2,e.basis1,e.origin,e.plane)}function O(e,t,i){e!==i&&g(e,i);const r=Object(c.e)(f.d.get(),D(e),t);return Object(c.f)(i.origin,i.origin,r),i.plane[3]-=t,i}function x(e,t=m()){const i=(e[2]-e[0])/2,r=(e[3]-e[1])/2;return Object(c.w)(t.origin,e[0]+i,e[1]+r,0),Object(c.w)(t.basis1,i,0,0),Object(c.w)(t.basis2,0,r,0),Object(h.h)(0,0,1,0,t.plane),t}function j(e,t,i){return!!Object(h.m)(e.plane,t,i)&&M(e,i)}function _(e,t,i){const r=V.get();L(e,t,r,V.get());let a=Number.POSITIVE_INFINITY;for(const s of N){const o=z(e,s,G.get()),l=f.d.get();if(Object(h.k)(r,o,l)){const e=Object(c.v)(f.d.get(),t.origin,l),r=Math.abs(Object(n.b)(Object(c.h)(t.direction,e)));r<a&&(a=r,Object(c.k)(i,l))}}return a===Number.POSITIVE_INFINITY?S(e,t,i):i}function S(e,t,i){if(j(e,t,i))return i;const r=V.get(),n=V.get();L(e,t,r,n);let a=Number.POSITIVE_INFINITY;for(const s of N){const o=z(e,s,G.get()),l=f.d.get();if(Object(h.l)(r,o,l)){const e=Object(u.d)(t,l);if(!Object(h.o)(n,l))continue;e<a&&(a=e,Object(c.k)(i,l))}}return P(e,t.origin)<a&&w(e,t.origin,i),i}function w(e,t,i){const r=Object(h.r)(e.plane,t,f.d.get()),n=Object(d.i)(I(e,e.basis1),r,-1,1,f.d.get()),a=Object(d.i)(I(e,e.basis2),r,-1,1,f.d.get());return Object(c.j)(i,Object(c.f)(f.d.get(),n,a),e.origin),i}function C(e,t,i){const{origin:r,basis1:n,basis2:a}=e,s=Object(c.j)(f.d.get(),t,r),o=Object(p.d)(n,s),l=Object(p.d)(a,s),d=Object(p.d)(D(e),s);return Object(c.w)(i,o,l,d)}function P(e,t){const i=C(e,t,f.d.get()),{basis1:r,basis2:n}=e,a=Object(c.p)(r),s=Object(c.p)(n),o=Math.max(Math.abs(i[0])-a,0),l=Math.max(Math.abs(i[1])-s,0),d=i[2];return o*o+l*l+d*d}function T(e,t){return Math.sqrt(P(e,t))}function E(e,t){return Object(h.o)(e.plane,t)&&M(e,t)}function A(e,t){const i=-e.plane[3];return Object(p.d)(D(e),t)-i}function R(e,t,i,r){return e!==r&&g(e,r),Object(s.f)(H,Object(s.j)(H),t,i),Object(c.q)(r.basis1,e.basis1,H),Object(c.q)(r.basis2,e.basis2,H),y(r),r}function D(e){return Object(h.q)(e.plane)}function M(e,t){const i=Object(c.j)(f.d.get(),t,e.origin),r=Object(c.t)(e.basis1),n=Object(c.t)(e.basis2),a=Object(c.h)(e.basis1,i),s=Object(c.h)(e.basis2,i);return-a-r<0&&a-r<0&&-s-n<0&&s-n<0}function I(e,t){const i=G.get();return Object(c.k)(i.origin,e.origin),Object(c.k)(i.vector,t),i}function z(e,t,i){const{basis1:r,basis2:n,origin:a}=e,s=Object(c.e)(f.d.get(),r,t.origin[0]),o=Object(c.e)(f.d.get(),n,t.origin[1]);Object(c.f)(i.origin,s,o),Object(c.f)(i.origin,i.origin,a);const l=Object(c.e)(f.d.get(),r,t.direction[0]),d=Object(c.e)(f.d.get(),n,t.direction[1]);return Object(c.e)(i.vector,Object(c.f)(l,l,d),2),i}function L(e,t,i,r){const n=D(e);Object(h.i)(n,t.direction,t.origin,i),Object(h.i)(Object(h.q)(i),n,t.origin,r)}const F={plane:Object(h.d)(),origin:Object(l.h)(0,0,0),basis1:Object(l.h)(1,0,0),basis2:Object(l.h)(0,1,0)},V=new a.a(h.d),G=new a.a(d.d),U=Object(l.f)(),B=new a.a((()=>({origin:null,basis1:null,basis2:null,plane:null}))),N=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],k=Object(o.d)(),H=Object(o.d)(),q=Object.freeze({__proto__:null,BoundedPlaneClass:class{constructor(){this.plane=Object(h.d)(),this.origin=Object(l.f)(),this.basis1=Object(l.f)(),this.basis2=Object(l.f)()}},create:m,wrap:function(e,t,i){const r=B.get();return r.origin=e,r.basis1=t,r.basis2=i,r.plane=Object(h.u)(0,0,0,0),y(r),r},copy:g,copyWithoutVerify:function(e,t){Object(c.k)(t.origin,e.origin),Object(c.k)(t.basis1,e.basis1),Object(c.k)(t.basis2,e.basis2),Object(h.c)(e.plane,t.plane)},fromValues:v,updateUnboundedPlane:y,elevate:O,setExtent:function(e,t,i){return x(t,i),O(i,A(e,e.origin),i),i},fromAABoundingRect:x,intersectRay:j,intersectRayClosestSilhouette:function(e,t,i){if(j(e,t,i))return i;const r=_(e,t,f.d.get());return Object(c.f)(i,t.origin,Object(c.e)(f.d.get(),t.direction,Object(c.m)(t.origin,r)/Object(c.p)(t.direction))),i},closestPointOnSilhouette:_,closestPoint:S,projectPoint:w,projectPointLocal:C,distance2:P,distance:T,distanceToSilhouette:function(e,t){let i=Number.NEGATIVE_INFINITY;for(const r of N){const n=z(e,r,G.get()),a=Object(d.e)(n,t);a>i&&(i=a)}return Math.sqrt(i)},extrusionContainsPoint:E,axisAt:function(e,t,i,r){return function(e,t,i){switch(t){case 0:Object(c.k)(i,e.basis1),Object(c.r)(i,i);break;case 1:Object(c.k)(i,e.basis2),Object(c.r)(i,i);break;case 2:Object(c.k)(i,D(e))}return i}(e,i,r)},altitudeAt:A,setAltitudeAt:function(e,t,i,r){const n=A(e,t),a=Object(c.e)(U,D(e),i-n);return Object(c.f)(r,t,a),r},equals:function(e,t){return Object(c.o)(e.basis1,t.basis1)&&Object(c.o)(e.basis2,t.basis2)&&Object(c.o)(e.origin,t.origin)},transform:function(e,t,i){return e!==i&&g(e,i),Object(s.c)(k,t),Object(s.t)(k,k),Object(c.q)(i.basis1,e.basis1,k),Object(c.q)(i.basis2,e.basis2,k),Object(c.q)(Object(h.q)(i.plane),Object(h.q)(e.plane),k),Object(c.q)(i.origin,e.origin,t),Object(h.s)(i.plane,i.origin,i.plane),i},rotate:R,normal:D,UP:F})},684:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return o})),i.d(t,"c",(function(){return s}));var r=i(85),n=i(744);class a{constructor(e,t=null,i=0){this.array=e,this.spatialReference=t,this.offset=i}}function s(e){return"array"in e}function o(e,t,i="ground"){if(Object(n.a)(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,i);if(s(t)){let n=t.offset;return e.getElevation(t.array[n++],t.array[n++],t.array[n]||0,Object(r.u)(t.spatialReference,e.spatialReference),i)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,i)}},685:function(e,t,i){"use strict";i.d(t,"a",(function(){return O}));var r=i(87),n=i(113),a=i(85),s=i(101),o=i(149),c=i(199),l=i(145),d=i(224),h=i(116),u=i(106),p=i(237),f=i(245),b=i(650),m=i(332),g=i(449),v=i(315);const y=r.a.getLogger("esri.views.3d.webgl-engine.lib.Camera");class O{constructor(e=null,t=null,i=null){this._viewUp=Object(u.f)(),this._viewForward=Object(u.f)(),this._viewRight=Object(u.f)(),this._ray=Object(m.c)(),this._viewport=Object(f.g)(0,0,1,1),this._padding=Object(f.g)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Object(d.e)(1,1e3),this._viewDirty=!0,this._viewMatrix=Object(c.d)(),this._projectionDirty=!0,this._projectionMatrix=Object(c.d)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Object(c.d)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Object(c.d)(),this._frustumDirty=!0,this._frustum=Object(b.b)(),this._fullViewport=Object(f.e)(),this.pixelRatio=1,this.relativeElevation=0,Object(a.l)(e)&&Object(h.k)(this._ray.origin,e),this._center=Object(a.l)(t)?Object(u.d)(t):Object(u.f)(),this._up=Object(a.l)(i)?Object(u.d)(i):Object(u.h)(0,0,1)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center)}get ray(){return Object(h.j)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){Object(o.d)(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get x(){return this._viewport[0]}set x(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(e){this.width=e-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(e){this.height=e-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){this._padding[0]===e[0]&&this._padding[1]===e[1]&&this._padding[2]===e[2]&&this._padding[3]===e[3]||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),Object(p.c)(this._padding,e),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&(Object(o.n)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const e=this.width,t=this.height,i=this.near*Math.tan(this.fovY/2),r=i*this.aspect;Object(o.i)(this._projectionMatrix,-r*(1+2*this._padding[3]/e),r*(1+2*this._padding[1]/e),-i*(1+2*this._padding[2]/t),i*(1+2*this._padding[0]/t),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}set projectionMatrix(e){Object(o.d)(this._projectionMatrix,e),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(e){this._fov=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Object(v.b)(this._fov,this.width,this.height)}set fovX(e){this._fov=Object(v.d)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Object(v.c)(this._fov,this.width,this.height)}set fovY(e){this._fov=Object(v.e)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return Object(h.m)(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Object(o.c)(this._viewInverseTransposeMatrix,this.viewMatrix),Object(o.t)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){Object(h.k)(this._ray.origin,e.eye),Object(h.k)(this._center,e.center),Object(h.k)(this._up,e.up),Object(p.c)(this._viewport,e.viewport),Object(p.c)(this._padding,e.padding),Object(l.c)(this._nearFar,e.nearFar),this._fov=e.fov,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||(Object(o.d)(this._viewMatrix,e.viewMatrix),Object(h.k)(this._viewRight,e.viewRight),Object(h.k)(this._viewUp,e.viewUp),Object(h.k)(this._viewForward,e.viewForward)),t._projectionDirty?this._projectionDirty=!0:(Object(o.d)(this._projectionMatrix,e.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(Object(b.a)(e.frustum,this._frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(Object(o.d)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Object(p.c)(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return(new O).copyFrom(this)}equals(e){return Object(h.o)(this.eye,e.eye)&&Object(h.o)(this._center,e.center)&&Object(h.o)(this._up,e.up)&&Object(p.g)(this._viewport,e.viewport)&&Object(p.g)(this._padding,e.padding)&&Object(l.e)(this._nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}almostEquals(e){if(this.pixelRatio!==e.pixelRatio||Math.abs(e.fov-this._fov)>=.001)return!1;const t=5e-4;Object(h.z)(_,e.eye,e.center),Object(h.z)(S,this.eye,this._center);const i=Object(h.h)(_,S),r=Object(h.A)(_),n=Object(h.A)(S);return i*i>=(1-1e-10)*r*n&&Object(h.B)(e.eye,this.eye)<Math.max(r,n)*t*t&&Object(p.i)(e.padding,this._padding)<.5&&Object(p.i)(e.viewport,this._viewport)<.5}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this.viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this.viewDirectionDistance(e))}viewDirectionDistance(e){return Math.abs(Object(g.d)(this.viewForward,Object(h.j)(_,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=Object(s.f)()){return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,i=.5){return e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*i,e[2]=.5,e}setGLViewport(e){const t=this.viewport,i=this.padding;e.setViewport(t[0]-i[3],t[1]-i[2],t[2]+i[1]+i[3],t[3]+i[0]+i[2])}applyProjection(e,t,i=!1){e!==x&&Object(h.k)(x,e),x[3]=1,i&&(t[2]=-x[2]),Object(p.m)(x,x,this.projectionMatrix),Object(h.e)(x,x,1/Math.abs(x[3]));const r=this.fullViewport;return t[0]=Object(n.k)(0,r[0]+r[2],.5+.5*x[0]),t[1]=Object(n.k)(0,r[1]+r[3],.5+.5*x[1]),i||(t[2]=.5*(x[2]+1)),t}projectToScreen(e,t){this.projectToRenderScreen(e,w),this.renderToScreen(w,t)}projectToRenderScreen(e,t){if(x[0]=e[0],x[1]=e[1],x[2]=e[2],x[3]=1,Object(p.m)(x,x,this.viewProjectionMatrix),0===x[3])return null;Object(h.e)(x,x,1/Math.abs(x[3]));const i=this.fullViewport;return"x"in t?(t.x=Object(n.k)(0,i[0]+i[2],.5+.5*x[0]),t.y=Object(n.k)(0,i[1]+i[3],.5+.5*x[1])):(t[0]=Object(n.k)(0,i[0]+i[2],.5+.5*x[0]),t[1]=Object(n.k)(0,i[1]+i[3],.5+.5*x[1]),t.length>2&&(t[2]=.5*(x[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,w),t)}unprojectFromRenderScreen(e,t){if(Object(o.n)(j,this.projectionMatrix,this.viewMatrix),!Object(o.c)(j,j))return null;const i=this.fullViewport;return x[0]=2*(e[0]-i[0])/i[2]-1,x[1]=2*(e[1]-i[1])/i[3]-1,x[2]=2*e[2]-1,x[3]=1,Object(p.m)(x,x,j),0===x[3]?null:(t[0]=x[0]/x[3],t[1]=x[1]/x[3],t[2]=x[2]/x[3],t)}constrainWindowSize(e,t,i,r=i){const n=e*this.pixelRatio,a=t*this.pixelRatio,s=Math.max(n-i/2,0),o=Math.max(this.fullHeight-a-r/2,0),c=-Math.min(n-i/2,0),l=-Math.min(this.fullHeight-a-r/2,0);return[s,o,i-c- -Math.min(this.fullWidth-n-i/2,0),r-l- -Math.min(a-r/2,0)]}computeUp(e){1===e?this.computeUpGlobal():this.computeUpLocal()}screenToRender(e,t){const i=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=i,t[1]=r,t}renderToScreen(e,t){const i=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;t[0]=i,t[1]=r}computeUpGlobal(){Object(h.j)(_,this.center,this.eye);const e=Object(h.p)(this.center);e<1?(Object(h.w)(this._up,0,0,1),this._markViewDirty()):Math.abs(Object(h.h)(_,this.center))>.9999*Object(h.p)(_)*e||(Object(h.g)(this._up,_,this.center),Object(h.g)(this._up,this._up,_),Object(h.r)(this._up,this._up),this._markViewDirty())}computeUpLocal(){Object(h.v)(_,this.eye,this.center),Math.abs(_[2])<=.9999&&(Object(h.e)(_,_,_[2]),Object(h.w)(this._up,-_[0],-_[1],1-_[2]),Object(h.r)(this._up,this._up),this._markViewDirty())}_compareAndSetView(e,t){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?Object(h.o)(e,t)||(Object(h.k)(t,e),this._markViewDirty()):y.warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(Object(b.c)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(Object(o.m)(this._viewMatrix,this.eye,this._center,this._up),Object(h.w)(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),Object(h.w)(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),Object(h.w)(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const x=Object(f.e)(),j=Object(c.d)(),_=Object(u.f)(),S=Object(u.f)(),w=Object(s.d)()},688:function(e,t,i){"use strict";i.d(t,"a",(function(){return g})),i.d(t,"b",(function(){return O}));var r=i(85),n=i(149),a=i(199),s=i(116),o=i(106),c=i(237),l=i(245),d=i(332);class h{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2}}i(675);function u(e){return Object(r.l)(e)&&Object(r.l)(e.dist)}Object(o.f)();var p=i(710),f=i(529);const b=1e-5;class m{constructor(e){this.options=new h,this._results=new v,this.transform=new p.a,this.tolerance=b,this.verticalOffset=null,this._ray=Object(d.c)(),this._rayEnd=Object(o.f)(),this._rayBeginTransformed=Object(o.f)(),this._rayEndTransformed=Object(o.f)(),this.viewingMode=null==e?1:e}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,i){this.resetWithRay(Object(d.e)(e,t,this._ray),i)}resetWithRay(e,t){this.camera=t,e!==this._ray&&Object(d.b)(e,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,Object(s.f)(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,t,i,n,a){this.point=t,this.filterPredicate=n,this.tolerance=null==i?b:i;const s=Object(p.c)(this.verticalOffset);if(Object(r.l)(e)&&e.length>0){const t=a?e=>{a(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(const i of e){const e=i.getSpatialQueryAccelerator&&i.getSpatialQueryAccelerator();Object(r.l)(e)?(Object(r.l)(s)?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,s):e.forEachAlongRay(this._ray.origin,this._ray.direction,t),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t)):i.objects.forAll((e=>t(e)))}}this.sortResults()}intersectObject(e){const t=e.geometryRecords;if(!t)return;const i=e.transformation,n=Object(p.c)(this.verticalOffset);for(const o of t){const{geometry:t,material:c,instanceParameters:l}=o;if(Object(f.d)(l))continue;const d=t.id;this.transform.setAndInvalidateLazyTransforms(i,o.getShaderTransformation()),Object(s.q)(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),Object(s.q)(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const h=this.transform.transform;Object(r.l)(n)&&(n.objectTransform=this.transform),c.intersect(t,l,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((t,i,n,s,o,c)=>{if(t>=0){if(Object(r.l)(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;if(s){if(null==this._results.hud.dist||t<this._results.hud.dist){const r={object:e,geometryId:d,triangleNr:n,center:c};this._results.hud.set(1,r,t,i,a.a,o)}return}const l=r=>r.set(0,{object:e,geometryId:d,triangleNr:n},t,i,h,o);if((null==this._results.min.drapedLayerOrder||o>=this._results.min.drapedLayerOrder)&&(null==this._results.min.dist||t<this._results.min.dist)&&l(this._results.min),0!==this.options.store&&(null==this._results.max.drapedLayerOrder||o<this._results.max.drapedLayerOrder)&&(null==this._results.max.dist||t>this._results.max.dist)&&l(this._results.max),2===this.options.store){const r=O(this._ray);r.set(0,{object:e,geometryId:d,triangleNr:n},t,i,h),this._results.all.push(r)}}}),o.shaderTransformation)}}sortResults(){this._results.all.sort(((e,t)=>e.dist!==t.dist?Object(r.u)(e.dist,0)-Object(r.u)(t.dist,0):e.drapedLayerOrder!==t.drapedLayerOrder?Object(r.u)(e.drapedLayerOrder,Number.MAX_VALUE)-Object(r.u)(t.drapedLayerOrder,Number.MAX_VALUE):Object(r.u)(t.drapedLayerGraphicOrder,Number.MIN_VALUE)-Object(r.u)(e.drapedLayerGraphicOrder,Number.MIN_VALUE)))}}function g(e){return new m(e)}class v{constructor(){this._min=new y(Object(d.c)()),this._max=new y(Object(d.c)()),this._hud=new y(Object(d.c)()),this._ground=new y(Object(d.c)())}get min(){return this._min}get max(){return this._max}get hud(){return this._hud}get ground(){return this._ground}init(e){this._min.init(e),this._max.init(e),this._hud.init(e),this._ground.init(e),this.all=[]}}class y{constructor(e){this.intersector=0,this.normal=Object(o.f)(),this.transformation=Object(a.d)(),this._ray=Object(d.c)(),this.init(e)}get ray(){return this._ray}get distanceInRenderSpace(){return Object(r.l)(this.dist)?(Object(s.e)(x,this.ray.direction,this.dist),Object(s.p)(x)):null}getIntersectionPoint(e){return!!u(this)&&(Object(s.e)(x,this.ray.direction,this.dist),Object(s.f)(e,this.ray.origin,x),!0)}getTransformedNormal(e){return Object(s.k)(j,this.normal),j[3]=0,Object(c.m)(j,j,this.transformation),Object(s.k)(e,j),Object(s.r)(e,e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=0,Object(d.b)(e,this._ray)}set(e,t,i,c,l,d,h){this.intersector=e,this.dist=i,Object(s.k)(this.normal,Object(r.u)(c,o.b)),Object(n.d)(this.transformation,Object(r.u)(l,a.a)),this.target=t,this.drapedLayerOrder=d,this.drapedLayerGraphicOrder=h}copy(e){Object(d.b)(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,Object(s.k)(this.normal,e.normal),Object(n.d)(this.transformation,e.transformation)}}function O(e){return new y(e)}const x=Object(o.f)(),j=Object(l.e)()},690:function(e,t,i){"use strict";i.d(t,"a",(function(){return w}));var r=i(577),n=i(564),a=i(481),s=i(430),o=i(661),c=i(425),l=i(79),d=i(306),h=i(402),u=i(352),p=i(530),f=i(419),b=i(432),m=i(433),g=i(434),v=i(420),y=i(651),O=i(780),x=i(393);class j extends b.a{initializeProgram(e){const t=j.shader.get(),i=this.configuration,r=t.build({output:i.output,OITEnabled:0===i.transparencyPassType,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new v.a(e.rctx,r,g.a)}bindPass(e,t){Object(p.c)(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("eColor",e.color),4===this.configuration.output&&Object(h.b)(this.program,t),(1===this.configuration.output||t.multipassTerrainEnabled)&&this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(u.a)(this.program,t))}bindDraw(e){Object(p.d)(this.program,e),this.program.rebindTextures(),Object(d.c)(this.program,this.configuration,e)}createPipeline(e,t){const i=this.configuration,r=3===e,n=2===e;return Object(x.f)({blending:0!==i.output&&7!==i.output||!i.transparent?null:r?s.g:Object(s.a)(e),culling:Object(x.b)(i.cullFace),depthTest:{func:Object(s.b)(e)},depthWrite:r||n?i.writeDepth&&x.d:null,colorWrite:x.c,stencilWrite:i.sceneHasOcludees?y.h:null,stencilTest:i.sceneHasOcludees?t?y.d:y.c:null,polygonOffset:r||n?i.polygonOffset&&_:Object(s.h)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.createPipeline(this.configuration.transparencyPassType,!0),this.createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}j.shader=new f.a(O.a,(()=>i.e(322).then(i.bind(null,1353))));const _={factor:1,units:1};class S extends m.a{constructor(){super(...arguments),this.output=0,this.cullFace=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(l.a)([Object(m.b)({count:8})],S.prototype,"output",void 0),Object(l.a)([Object(m.b)({count:3})],S.prototype,"cullFace",void 0),Object(l.a)([Object(m.b)()],S.prototype,"slicePlaneEnabled",void 0),Object(l.a)([Object(m.b)()],S.prototype,"vertexColors",void 0),Object(l.a)([Object(m.b)()],S.prototype,"transparent",void 0),Object(l.a)([Object(m.b)()],S.prototype,"polygonOffset",void 0),Object(l.a)([Object(m.b)()],S.prototype,"enableOffset",void 0),Object(l.a)([Object(m.b)()],S.prototype,"writeDepth",void 0),Object(l.a)([Object(m.b)()],S.prototype,"sceneHasOcludees",void 0),Object(l.a)([Object(m.b)({count:4})],S.prototype,"transparencyPassType",void 0),Object(l.a)([Object(m.b)()],S.prototype,"multipassTerrainEnabled",void 0),Object(l.a)([Object(m.b)()],S.prototype,"cullAboveGround",void 0);class w extends a.a{constructor(e){super(e,P),this.supportsEdges=!0,this.techniqueConfig=new S}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.enableOffset=t.camera.relativeElevation<s.e,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(e,t,i,r,n,a,s){Object(c.f)(e,t,r,n,a,void 0,s)}requiresSlot(e,t){return 20===e||(4===Object(n.b)(t)?2===e:e===(this.parameters.transparent?this.parameters.writeDepth?4:7:2))}createGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output&&this.parameters.writeLinearDepth?new C(e):null}createBufferWriter(){return new o.a(o.b)}}class C extends r.a{updateParameters(e){return this.ensureTechnique(j,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return 0!==this._output&&7!==this._output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}const P={color:[1,1,1,1],transparent:!1,writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:0,sceneHasOcludees:!1,...a.b}},698:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r,n,a,s={exports:{}};r=s,n=function(){function e(i,r,n,a,s){for(;a>n;){if(a-n>600){var o=a-n+1,c=r-n+1,l=Math.log(o),d=.5*Math.exp(2*l/3),h=.5*Math.sqrt(l*d*(o-d)/o)*(c-o/2<0?-1:1);e(i,r,Math.max(n,Math.floor(r-c*d/o+h)),Math.min(a,Math.floor(r+(o-c)*d/o+h)),s)}var u=i[r],p=n,f=a;for(t(i,n,r),s(i[a],u)>0&&t(i,n,a);p<f;){for(t(i,p,f),p++,f--;s(i[p],u)<0;)p++;for(;s(i[f],u)>0;)f--}0===s(i[n],u)?t(i,n,f):t(i,++f,a),f<=r&&(n=f+1),r<=f&&(a=f-1)}}function t(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}function i(e,t){return e<t?-1:e>t?1:0}return function(t,r,n,a,s){e(t,r,n||0,a||t.length-1,s||i)}},void 0!==(a=n())&&(r.exports=a);const o=s.exports},703:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i(84),n=i(85),a=i(215),s=i(698);class o{constructor(e=9,t){this.compareMinX=h,this.compareMinY=u,this.toBBox=function(e){return e},this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this.toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),O.prune(),x.prune(),j.prune(),_.prune()}all(e){this._all(this.data,e)}search(e,t){let i=this.data;const r=this.toBBox;if(v(e,i))for(O.clear();i;){for(let n=0,a=i.children.length;n<a;n++){const a=i.children[n],s=i.leaf?r(a):a;v(e,s)&&(i.leaf?t(a):g(e,s)?this._all(a,t):O.push(a))}i=O.pop()}}collides(e){let t=this.data;const i=this.toBBox;if(!v(e,t))return!1;for(O.clear();t;){for(let r=0,n=t.children.length;r<n;r++){const n=t.children[r],a=t.leaf?i(n):n;if(v(e,a)){if(t.leaf||g(e,a))return!0;O.push(n)}}t=O.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}let t=this._build(e.slice(0,e.length),0,e.length-1,0);if(this.data.children.length)if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const e=this.data;this.data=t,t=e}this._insert(t,this.data.height-t.height-1,!0)}else this.data=t;return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=new w([]),this}remove(e){if(!e)return this;let t,i=this.data,a=null,s=0,o=!1;const c=this.toBBox(e);for(j.clear(),_.clear();i||j.length>0;){var l;if(i||(i=Object(n.d)(j.pop()),a=j.data[j.length-1],s=null!=(l=_.pop())?l:0,o=!0),i.leaf&&(t=Object(r.e)(i.children,e,i.children.length,i.indexHint),-1!==t))return i.children.splice(t,1),j.push(i),this._condense(j),this;o||i.leaf||!g(i,c)?a?(s++,i=a.children[s],o=!1):i=null:(j.push(i),_.push(s),s=0,a=i,i=i.children[0])}return this}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){let i=e;for(x.clear();i;){var r;if(!0===i.leaf)for(const e of i.children)t(e);else x.pushArray(i.children);i=null!=(r=x.pop())?r:null}}_build(e,t,i,r){const n=i-t+1;let a=this._maxEntries;if(n<=a){const r=new w(e.slice(t,i+1));return c(r,this.toBBox),r}r||(r=Math.ceil(Math.log(n)/Math.log(a)),a=Math.ceil(n/a**(r-1)));const s=new C([]);s.height=r;const o=Math.ceil(n/a),l=o*Math.ceil(Math.sqrt(a));y(e,t,i,l,this.compareMinX);for(let c=t;c<=i;c+=l){const t=Math.min(c+l-1,i);y(e,c,t,o,this.compareMinY);for(let i=c;i<=t;i+=o){const n=Math.min(i+o-1,t);s.children.push(this._build(e,i,n,r-1))}}return c(s,this.toBBox),s}_chooseSubtree(e,t,i,r){for(;r.push(t),!0!==t.leaf&&r.length-1!==i;){let i,r=1/0,n=1/0;for(let a=0,s=t.children.length;a<s;a++){const s=t.children[a],o=p(s),c=b(e,s)-o;c<n?(n=c,r=o<r?o:r,i=s):c===n&&o<r&&(r=o,i=s)}t=i||t.children[0]}return t}_insert(e,t,i){const r=this.toBBox,n=i?e:r(e);j.clear();const a=this._chooseSubtree(n,this.data,t,j);for(a.children.push(e),d(a,n);t>=0&&j.data[t].children.length>this._maxEntries;)this._split(j,t),t--;this._adjustParentBBoxes(n,j,t)}_split(e,t){const i=e.data[t],r=i.children.length,n=this._minEntries;this._chooseSplitAxis(i,n,r);const a=this._chooseSplitIndex(i,n,r);if(!a)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const s=i.children.splice(a,i.children.length-a),o=i.leaf?new w(s):new C(s);o.height=i.height,c(i,this.toBBox),c(o,this.toBBox),t?e.data[t-1].children.push(o):this._splitRoot(i,o)}_splitRoot(e,t){this.data=new C([e,t]),this.data.height=e.height+1,c(this.data,this.toBBox)}_chooseSplitIndex(e,t,i){let r,n,a;r=n=1/0;for(let s=t;s<=i-t;s++){const t=l(e,0,s,this.toBBox),o=l(e,s,i,this.toBBox),c=m(t,o),d=p(t)+p(o);c<r?(r=c,a=s,n=d<n?d:n):c===r&&d<n&&(n=d,a=s)}return a}_chooseSplitAxis(e,t,i){const r=e.leaf?this.compareMinX:h,n=e.leaf?this.compareMinY:u;this._allDistMargin(e,t,i,r)<this._allDistMargin(e,t,i,n)&&e.children.sort(r)}_allDistMargin(e,t,i,r){e.children.sort(r);const n=this.toBBox,a=l(e,0,t,n),s=l(e,i-t,i,n);let o=f(a)+f(s);for(let c=t;c<i-t;c++){const t=e.children[c];d(a,e.leaf?n(t):t),o+=f(a)}for(let c=i-t-1;c>=t;c--){const t=e.children[c];d(s,e.leaf?n(t):t),o+=f(s)}return o}_adjustParentBBoxes(e,t,i){for(let r=i;r>=0;r--)d(t.data[r],e)}_condense(e){for(let t=e.length-1;t>=0;t--){const i=e.data[t];if(0===i.children.length)if(t>0){const n=e.data[t-1],a=n.children;a.splice(Object(r.e)(a,i,a.length,n.indexHint),1)}else this.clear();else c(i,this.toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}function c(e,t){l(e,0,e.children.length,t,e)}function l(e,t,i,r,n){n||(n=new w([])),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(let a,s=t;s<i;s++)a=e.children[s],d(n,e.leaf?r(a):a);return n}function d(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function h(e,t){return e.minX-t.minX}function u(e,t){return e.minY-t.minY}function p(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function f(e){return e.maxX-e.minX+(e.maxY-e.minY)}function b(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function m(e,t){const i=Math.max(e.minX,t.minX),r=Math.max(e.minY,t.minY),n=Math.min(e.maxX,t.maxX),a=Math.min(e.maxY,t.maxY);return Math.max(0,n-i)*Math.max(0,a-r)}function g(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function v(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function y(e,t,i,r,a){const o=[t,i];for(;o.length;){const t=Object(n.d)(o.pop()),i=Object(n.d)(o.pop());if(t-i<=r)continue;const c=i+Math.ceil((t-i)/r/2)*r;Object(s.a)(e,c,i,t,a),o.push(i,c,c,t)}}const O=new a.a,x=new a.a,j=new a.a,_=new a.a({deallocator:void 0});class S extends class{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}{constructor(){super(...arguments),this.height=1,this.indexHint=new r.a}}class w extends S{constructor(e){super(),this.children=e,this.leaf=!0}}class C extends S{constructor(e){super(),this.children=e,this.leaf=!1}}},707:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return o})),i.d(t,"d",(function(){return d})),i.d(t,"e",(function(){return l}));var r=i(412),n=i(116),a=i(332);i(272);function s(e){return e?{ray:Object(a.c)(e.ray),c0:e.c0,c1:e.c1}:{ray:Object(a.c)(),c0:0,c1:Number.MAX_VALUE}}function o(e,t=s()){return Object(a.b)(e,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function c(e,t,i=s()){const r=Object(n.p)(e.vector);return Object(a.f)(e.origin,t,i.ray),i.c0=0,i.c1=r,i}function l(e,t){return h(e,e.c0,t)}function d(e,t){return h(e,e.c1,t)}function h(e,t,i){return Object(n.f)(i,e.ray.origin,Object(n.e)(i,e.ray.direction,t))}new r.a((()=>({c0:0,c1:0,ray:null})))},714:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(136);function n(e,t){1===t.attributeTextureCoordinates&&(e.attributes.add("uv0","vec2"),e.varyings.add("vuv0","vec2"),e.vertex.code.add(r.a`void forwardTextureCoordinates() {
vuv0 = uv0;
}`)),2===t.attributeTextureCoordinates&&(e.attributes.add("uv0","vec2"),e.varyings.add("vuv0","vec2"),e.attributes.add("uvRegion","vec4"),e.varyings.add("vuvRegion","vec4"),e.vertex.code.add(r.a`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`)),0===t.attributeTextureCoordinates&&e.vertex.code.add(r.a`void forwardTextureCoordinates() {}`)}},715:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(136);function n(e,t){const i=e.fragment;t.receiveAmbientOcclusion?(i.uniforms.add("ssaoTex","sampler2D"),i.uniforms.add("viewportPixelSz","vec4"),i.code.add(r.a`float evaluateAmbientOcclusion() {
return 1.0 - texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
}
float evaluateAmbientOcclusionInverse() {
float ssao = texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
return viewportPixelSz.z < 0.0 ? 1.0 : ssao;
}`)):i.code.add(r.a`float evaluateAmbientOcclusion() { return 0.0; }
float evaluateAmbientOcclusionInverse() { return 1.0; }`)}},718:function(e,t,i){"use strict";i.d(t,"a",(function(){return d}));var r=i(129),n=i(121),a=i(85),s=i(215),o=i(601);const c=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"];var l=i(811);class d extends o.a{constructor(e,t=""){var i,a,o;super(),this.apiLayerUid=t,this.type=0,this.events=new r.a,this.isSliceable=!1,this._objects=new s.a,this._stageHandles=new n.a,this.apiLayerUid=t,this.isVisible=null==(i=null==e?void 0:e.isVisible)||i,this.isPickable=null==(a=null==e?void 0:e.isPickable)||a,this.updatePolicy=null!=(o=null==e?void 0:e.updatePolicy)?o:0}get objects(){return this._objects}destroy(){this.detachStage(),this._stage=null}attachStage(e){this.detachStage(),this._stage=e;for(const t of c)this._stageHandles.add(this.events.on(t,(i=>e.handleEvent(t,i))))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),Object(a.l)(this._octree)&&this._octree.add([e])}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),Object(a.l)(this._octree)&&this._octree.remove([e]))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),Object(a.l)(this._octree)&&this._octree.add(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),Object(a.l)(this._octree)&&this._octree.remove(t)}}sync(){Object(a.l)(this._stage)&&1!==this.updatePolicy&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){Object(a.l)(this._octree)&&this._octree.update(e,t)}getSpatialQueryAccelerator(){return Object(a.k)(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=Object(a.e)(this._octree)}_createOctree(){this._octree=new l.a((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)}}},719:function(e,t,i){"use strict";i.d(t,"a",(function(){return G}));var r=i(87),n=i(113),a=i(85),s=i(101),o=i(145),c=i(116),l=i(106),d=i(456),h=i(362),u=i(514),p=i(541),f=i(577),b=i(564),m=i(481),g=i(315),v=i(1035),y=i(529),O=i(812),x=i(79),j=i(306),_=i(402),S=i(352),w=i(623),C=i(530),P=i(419),T=i(432),E=i(433),A=i(430),R=i(420),D=i(651),M=i(393);const I=new Map([["position",0],["subdivisionFactor",1],["uv0",2],["auxpos1",3],["auxpos2",4],["size",6],["sizeFeatureAttribute",6],["color",5],["colorFeatureAttribute",5],["opacityFeatureAttribute",7]]);class z extends T.a{constructor(e,t,i){super(e,t,i),this.stippleTextureRepository=e.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&4!==this.configuration.output}initializeProgram(e){const t=z.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:i.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleRequiresClamp:!0,stippleScaleWithLineWidth:i.stippleScaleWithLineWidth,stipplePreferContinuous:i.stipplePreferContinuous,roundCaps:i.roundCaps,roundJoins:i.roundJoins,vvColor:i.vvColor,vvSize:i.vvSize,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,falloffEnabled:i.falloffEnabled,innerColorEnabled:i.innerColorEnabled,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new R.a(e.rctx,r,I)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,t){if(Object(C.c)(this.program,t.camera.projectionMatrix),4===this.configuration.output&&Object(_.b)(this.program,t),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(S.a)(this.program,t)),this.program.setUniform1f("intrinsicWidth",e.width),this.program.setUniform4fv("intrinsicColor",e.color),this.program.setUniform1f("miterLimit","miter"!==e.join?0:e.miterLimit),this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio),this.program.setUniform2f("screenSize",t.camera.fullViewport[2],t.camera.fullViewport[3]),Object(w.d)(this.program,e),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.stippleEnabled){const{pixelSize:i,sdfNormalizer:r,pixels:n}=Object(a.l)(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};if(this.program.setUniform1f("stipplePatternSDFNormalizer",r),this.program.setUniform1f("stipplePatternTextureSize",n),this.program.setUniform1f("stipplePatternPixelSize",i),this.program.setUniform1f("stipplePatternPixelSizeInv",1/i),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/t.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/t.camera.perScreenPixelRatio),this.configuration.stippleOffColorEnabled){const t=Object(a.t)(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",e.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",Object(a.u)(e.innerColor,e.color)),this.program.setUniform1f("innerWidth",e.innerWidth*t.camera.pixelRatio))}bindDraw(e){Object(C.d)(this.program,e),this.stippleEnabled&&!this.configuration.draped&&Object(C.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),Object(j.c)(this.program,this.configuration,e),this.program.rebindTextures()}makePipelineState(e,t){const i=this.configuration,r=3===e,n=2===e;return Object(M.f)({blending:0===i.output||7===i.output?r?A.g:Object(A.a)(e):null,depthTest:{func:Object(A.b)(e)},depthWrite:r?!i.transparent&&i.writeDepth&&M.d:Object(A.c)(e),colorWrite:M.c,stencilWrite:i.sceneHasOcludees?D.h:null,stencilTest:i.sceneHasOcludees?t?D.d:D.c:null,polygonOffset:r||n?i.polygonOffset&&L:A.d})}initializePipeline(){const e=this.configuration,t=e.polygonOffset&&L;return e.occluder&&(this._occluderPipelineTransparent=Object(M.f)({blending:A.g,polygonOffset:t,depthTest:D.a,depthWrite:null,colorWrite:M.c,stencilWrite:null,stencilTest:D.f}),this._occluderPipelineOpaque=Object(M.f)({blending:A.g,polygonOffset:t,depthTest:D.a,depthWrite:null,colorWrite:M.c,stencilWrite:D.g,stencilTest:D.e}),this._occluderPipelineMaskWrite=Object(M.f)({blending:null,polygonOffset:t,depthTest:D.b,depthWrite:null,colorWrite:null,stencilWrite:D.h,stencilTest:D.d})),this._occludeePipelineState=this.makePipelineState(this.configuration.transparencyPassType,!0),this.makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return 5}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?10===e?this._occluderPipelineTransparent:9===e?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,t)}}z.shader=new P.a(O.b,(()=>i.e(332).then(i.bind(null,1350))));const L={factor:0,units:-4};class F extends E.a{constructor(){super(...arguments),this.output=0,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.polygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.roundCaps=!1,this.roundJoins=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.sceneHasOcludees=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(x.a)([Object(E.b)({count:8})],F.prototype,"output",void 0),Object(x.a)([Object(E.b)()],F.prototype,"occluder",void 0),Object(x.a)([Object(E.b)()],F.prototype,"slicePlaneEnabled",void 0),Object(x.a)([Object(E.b)()],F.prototype,"transparent",void 0),Object(x.a)([Object(E.b)()],F.prototype,"polygonOffset",void 0),Object(x.a)([Object(E.b)()],F.prototype,"writeDepth",void 0),Object(x.a)([Object(E.b)()],F.prototype,"draped",void 0),Object(x.a)([Object(E.b)()],F.prototype,"stippleEnabled",void 0),Object(x.a)([Object(E.b)()],F.prototype,"stippleOffColorEnabled",void 0),Object(x.a)([Object(E.b)()],F.prototype,"stippleScaleWithLineWidth",void 0),Object(x.a)([Object(E.b)()],F.prototype,"stipplePreferContinuous",void 0),Object(x.a)([Object(E.b)()],F.prototype,"roundCaps",void 0),Object(x.a)([Object(E.b)()],F.prototype,"roundJoins",void 0),Object(x.a)([Object(E.b)()],F.prototype,"vvSize",void 0),Object(x.a)([Object(E.b)()],F.prototype,"vvColor",void 0),Object(x.a)([Object(E.b)()],F.prototype,"vvOpacity",void 0),Object(x.a)([Object(E.b)()],F.prototype,"falloffEnabled",void 0),Object(x.a)([Object(E.b)()],F.prototype,"innerColorEnabled",void 0),Object(x.a)([Object(E.b)()],F.prototype,"sceneHasOcludees",void 0),Object(x.a)([Object(E.b)({count:4})],F.prototype,"transparencyPassType",void 0),Object(x.a)([Object(E.b)()],F.prototype,"multipassTerrainEnabled",void 0),Object(x.a)([Object(E.b)()],F.prototype,"cullAboveGround",void 0);const V=r.a.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");class G extends m.a{constructor(e){super(e,B),this._vertexAttributeLocations=I,this.techniqueConfig=new F,this.layout=this.createLayout()}isClosed(e,t){return q(this.parameters,e,t)}dispose(){}getPassParameters(){return this.parameters}getTechniqueConfig(e,t){this.techniqueConfig.output=e,this.techniqueConfig.draped=20===t.slot;const i=Object(a.l)(this.parameters.stipplePattern);return this.techniqueConfig.stippleEnabled=i,this.techniqueConfig.stippleOffColorEnabled=i&&Object(a.l)(this.parameters.stippleOffColor),this.techniqueConfig.stippleScaleWithLineWidth=i&&this.parameters.stippleScaleWithLineWidth,this.techniqueConfig.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.roundJoins="round"===this.parameters.join,this.techniqueConfig.roundCaps=2===this.parameters.cap,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.parameters.innerWidth>0&&Object(a.l)(this.parameters.innerColor),this.techniqueConfig.falloffEnabled=this.parameters.falloff>0,this.techniqueConfig.occluder=8===this.parameters.renderOccluded,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,r,n,s,o,c,l){Object(a.l)(l)?this.intersectDrapedLineGeometry(e,r,l,s,o):this.intersectLineGeometry(e,t,i,r,o)}intersectDrapedLineGeometry(e,t,i,r,a){if(!t.options.selectionMode)return;const s=e.vertexAttributes.get("position").data,o=e.vertexAttributes.get("size");let c=this.parameters.width;if(this.parameters.vvSizeEnabled){const t=e.vertexAttributes.get("sizeFeatureAttribute").data[0];c*=Object(n.e)(this.parameters.vvSizeOffset[0]+t*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else o&&(c*=o.data[0]);const l=r[0],d=r[1],h=(c/2+4)*e.screenToWorldRatio;let u=Number.MAX_VALUE,p=0;for(let f=0;f<s.length-5;f+=3){const e=s[f],t=s[f+1],i=l-e,r=d-t,a=s[f+3]-e,o=s[f+4]-t,c=Object(n.e)((a*i+o*r)/(a*a+o*o),0,1),h=a*c-i,b=o*c-r,m=h*h+b*b;m<u&&(u=m,p=f/3)}u<h*h&&a(i.dist,i.normal,p,!1)}intersectLineGeometry(e,t,i,r,a){if(!r.options.selectionMode||Object(y.d)(t))return;if(!Object(g.g)(i))return void V.error("intersection assumes a translation-only matrix");const s=e.vertexAttributes,l=s.get("position").data;let u=this.parameters.width;if(this.parameters.vvSizeEnabled){const e=s.get("sizeFeatureAttribute").data[0];u*=Object(n.e)(this.parameters.vvSizeOffset[0]+e*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else s.has("size")&&(u*=s.get("size").data[0]);const p=r.camera,f=X;Object(o.c)(f,r.point);const b=u*p.pixelRatio/2+4*p.pixelRatio;Object(c.w)(se[0],f[0]-b,f[1]+b,0),Object(c.w)(se[1],f[0]+b,f[1]+b,0),Object(c.w)(se[2],f[0]+b,f[1]-b,0),Object(c.w)(se[3],f[0]-b,f[1]-b,0);for(let n=0;n<4;n++)if(!p.unprojectFromRenderScreen(se[n],oe[n]))return;Object(h.f)(p.eye,oe[0],oe[1],ce),Object(h.f)(p.eye,oe[1],oe[2],le),Object(h.f)(p.eye,oe[2],oe[3],de),Object(h.f)(p.eye,oe[3],oe[0],he);let m=Number.MAX_VALUE,v=0;const O=H(this.parameters,s,e.indices)?l.length-2:l.length-5;for(let n=0;n<O;n+=3){W[0]=l[n]+i[12],W[1]=l[n+1]+i[13],W[2]=l[n+2]+i[14];const e=(n+3)%l.length;if($[0]=l[e]+i[12],$[1]=l[e+1]+i[13],$[2]=l[e+2]+i[14],Object(h.t)(ce,W)<0&&Object(h.t)(ce,$)<0||Object(h.t)(le,W)<0&&Object(h.t)(le,$)<0||Object(h.t)(de,W)<0&&Object(h.t)(de,$)<0||Object(h.t)(he,W)<0&&Object(h.t)(he,$)<0)continue;if(p.projectToRenderScreen(W,Q),p.projectToRenderScreen($,J),Q[2]<0&&J[2]>0){Object(c.j)(Y,W,$);const e=p.frustum,t=-Object(h.t)(e[4],W)/Object(c.h)(Y,Object(h.q)(e[4]));Object(c.e)(Y,Y,t),Object(c.f)(W,W,Y),p.projectToRenderScreen(W,Q)}else if(Q[2]>0&&J[2]<0){Object(c.j)(Y,$,W);const e=p.frustum,t=-Object(h.t)(e[4],$)/Object(c.h)(Y,Object(h.q)(e[4]));Object(c.e)(Y,Y,t),Object(c.f)($,$,Y),p.projectToRenderScreen($,J)}else if(Q[2]<0&&J[2]<0)continue;Q[2]=0,J[2]=0;const t=Object(d.e)(Object(d.f)(Q,J,te),f);t<m&&(m=t,Object(c.k)(K,W),Object(c.k)(ee,$),v=n/3)}const x=r.rayBegin,j=r.rayEnd;if(m<b*b){let e=Number.MAX_VALUE;if(Object(d.a)(Object(d.f)(K,ee,te),Object(d.f)(x,j,ie),Z)){Object(c.j)(Z,Z,x);const t=Object(c.p)(Z);Object(c.e)(Z,Z,1/t),e=t/Object(c.m)(x,j)}a(e,Z,v,!1)}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return null;const r=e.indices,n=i.get("position");return Object(p.a)(n,r?r.get("position"):null,r&&H(this.parameters,i,r),t)}createLayout(){const e=Object(u.a)().vec3f("position").f32("subdivisionFactor").vec2f("uv0").vec3f("auxpos1").vec3f("auxpos2");return this.parameters.vvSizeEnabled?e.f32("sizeFeatureAttribute"):e.f32("size"),this.parameters.vvColorEnabled?e.f32("colorFeatureAttribute"):e.vec4f("color"),this.parameters.vvOpacityEnabled&&e.f32("opacityFeatureAttribute"),e}createBufferWriter(){return new N(this.layout,this.parameters)}requiresSlot(e,t){if(20===e)return!0;if(8===this.parameters.renderOccluded)return 2===e||9===e||10===e;const i=Object(b.b)(t);return 0===i||7===i?e===(this.parameters.writeDepth?4:7):2===e}createGLMaterial(e){return 0===e.output||7===e.output||4===e.output||1===e.output?new U(e):null}validateParameters(e){"miter"!==e.join&&(e.miterLimit=0),this.requiresTransparent(e)&&(e.transparent=!0)}requiresTransparent(e){return!!((e.color&&e.color[3])<1||e.innerWidth>0&&this.colorRequiresTransparent(e.innerColor)||e.stipplePattern&&this.colorRequiresTransparent(e.stippleOffColor)||e.falloff>0)}colorRequiresTransparent(e){return Object(a.l)(e)&&e[3]<1&&e[3]>0}}class U extends f.a{updateParameters(e){return this.ensureTechnique(z,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return 0!==this._output&&7!==this._output||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}const B={width:0,color:[1,1,1,1],join:"miter",cap:0,miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleOffColor:null,stippleScaleWithLineWidth:!1,stipplePreferContinuous:!0,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1,...m.b,...v.a.Default};class N{constructor(e,t){this.parameters=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const i=t.stipplePattern?1:0;switch(this.parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=O.a+i}}isClosed(e){return H(this.parameters,e.vertexAttributes,e.indices)}numCapSubdivisions(e){if(this.isClosed(e))return 0;switch(this.parameters.cap){case 1:case 2:return 1;default:return 0}}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=2*this.numCapSubdivisions(e)+2,i=e.indices.get("position").length/2+1,r=this.isClosed(e);let n=r?2:2*t;const a=r?0:1,s=r?i:i-1;if(e.vertexAttributes.has("subdivisions")){const t=e.vertexAttributes.get("subdivisions").data;for(let e=a;e<s;++e)n+=4+2*t[e]}else n+=(s-a)*(2*this.numJoinSubdivisions+4);return n+=2,n}write(e,t,i,r){var n;const a=re,s=ne,o=ae,l=t.vertexAttributes.get("position").data,d=t.indices&&t.indices.get("position"),h=null==(n=t.vertexAttributes.get("distanceToStart"))?void 0:n.data,u=this.numCapSubdivisions(t);d&&d.length!==2*(l.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let p=null;t.vertexAttributes.has("subdivisions")&&(p=t.vertexAttributes.get("subdivisions").data);let f=1,b=0;this.parameters.vvSizeEnabled?b=t.vertexAttributes.get("sizeFeatureAttribute").data[0]:t.vertexAttributes.has("size")&&(f=t.vertexAttributes.get("size").data[0]);let m=[1,1,1,1],g=0;this.parameters.vvColorEnabled?g=t.vertexAttributes.get("colorFeatureAttribute").data[0]:t.vertexAttributes.has("color")&&(m=t.vertexAttributes.get("color").data);let v=0;this.parameters.vvOpacityEnabled&&(v=t.vertexAttributes.get("opacityFeatureAttribute").data[0]);const y=l.length/3,O=e.transformation,x=new Float32Array(i.buffer),j=this.vertexBufferLayout.stride/4;let _=r*j;const S=_;let w=0;const C=(e,t,i,r,n,a,s)=>{if(x[_++]=t[0],x[_++]=t[1],x[_++]=t[2],x[_++]=r,x[_++]=s,x[_++]=n,x[_++]=e[0],x[_++]=e[1],x[_++]=e[2],x[_++]=i[0],x[_++]=i[1],x[_++]=i[2],this.parameters.vvSizeEnabled?x[_++]=b:x[_++]=f,this.parameters.vvColorEnabled)x[_++]=g;else{const e=Math.min(4*a,m.length-4);x[_++]=m[e+0],x[_++]=m[e+1],x[_++]=m[e+2],x[_++]=m[e+3]}this.parameters.vvOpacityEnabled&&(x[_++]=v)};_+=j,Object(c.w)(s,l[0],l[1],l[2]),O&&Object(c.q)(s,s,O);const P=this.isClosed(t);if(P){const e=l.length-3;Object(c.w)(a,l[e],l[e+1],l[e+2]),O&&Object(c.q)(a,a,O)}else{Object(c.k)(a,s),Object(c.w)(o,l[3],l[4],l[5]),O&&Object(c.q)(o,o,O);for(let e=0;e<u;++e){const t=1-e/u;C(a,s,o,t,-4,0,w),C(a,s,o,t,4,0,w)}C(a,s,o,0,-4,0,w),C(a,s,o,0,4,0,w),Object(c.k)(a,s),Object(c.k)(s,o)}const T=P?0:1,E=P?y:y-1,A=h?(e,t,i)=>w=h[i]:(e,t,i)=>w+=Object(c.m)(e,t);for(let R=T;R<E;R++){const e=(R+1)%y*3;Object(c.w)(o,l[e+0],l[e+1],l[e+2]),O&&Object(c.q)(o,o,O),A(a,s,R),C(a,s,o,0,-1,R,w),C(a,s,o,0,1,R,w);const t=p?p[R]:this.numJoinSubdivisions;for(let i=0;i<t;++i){const e=(i+1)/(t+1);C(a,s,o,e,-1,R,w),C(a,s,o,e,1,R,w)}C(a,s,o,1,-2,R,w),C(a,s,o,1,2,R,w),Object(c.k)(a,s),Object(c.k)(s,o)}if(P)Object(c.w)(o,l[3],l[4],l[5]),O&&Object(c.q)(o,o,O),w=A(a,s,E),C(a,s,o,0,-1,T,w),C(a,s,o,0,1,T,w);else{w=A(a,s,E),C(a,s,o,0,-5,E,w),C(a,s,o,0,5,E,w);for(let e=0;e<u;++e){const t=(e+1)/u;C(a,s,o,t,-5,E,w),C(a,s,o,t,5,E,w)}}k(x,S+j,x,S,j),_=k(x,_-j,x,_,j)}}function k(e,t,i,r,n){for(let a=0;a<n;a++)i[r++]=e[t++];return r}function H(e,t,i){return q(e,t.get("position").data,i?i.get("position"):null)}function q(e,t,i){return!!e.isClosed&&(i?i.length>2:t.length>6)}const W=Object(l.f)(),$=Object(l.f)(),Y=Object(l.f)(),Z=Object(l.f)(),X=Object(l.f)(),Q=Object(s.d)(),J=Object(s.d)(),K=Object(l.f)(),ee=Object(l.f)(),te=Object(d.d)(),ie=Object(d.d)(),re=Object(l.f)(),ne=Object(l.f)(),ae=Object(l.f)(),se=[Object(s.d)(),Object(s.d)(),Object(s.d)(),Object(s.d)()],oe=[Object(l.f)(),Object(l.f)(),Object(l.f)(),Object(l.f)()],ce=Object(h.d)(),le=Object(h.d)(),de=Object(h.d)(),he=Object(h.d)()},720:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(136);function n(e){const t=r.a`vec3 decodeNormal(vec2 f) {
float z = 1.0 - abs(f.x) - abs(f.y);
return vec3(f + sign(f) * min(z, 0.0), z);
}`;e.fragment.code.add(t),e.vertex.code.add(t)}function a(e,t){0===t.normalType&&(e.attributes.add("normal","vec3"),e.vertex.code.add(r.a`vec3 normalModel() {
return normal;
}`)),1===t.normalType&&(e.include(n),e.attributes.add("normalCompressed","vec2"),e.vertex.code.add(r.a`vec3 normalModel() {
return decodeNormal(normalCompressed);
}`)),3===t.normalType&&(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(r.a`vec3 screenDerivativeNormal(vec3 positionView) {
return normalize(cross(dFdx(positionView), dFdy(positionView)));
}`))}},742:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(136);function n(e){e.attributes.add("position","vec2"),e.varyings.add("uv","vec2"),e.vertex.code.add(r.a`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      uv = position * 0.5 + vec2(0.5);
    }
  `)}},743:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(251);class n{constructor(e){this.channel=e,this.id=Object(r.a)()}}},744:function(e,t,i){"use strict";function r(e){return"point"===e.type}i.d(t,"a",(function(){return r}))},746:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(136);function n(e){e.attributes.add("position","vec3"),e.vertex.code.add(r.a`vec3 positionModel() { return position; }`)}},750:function(e,t,i){"use strict";i.d(t,"a",(function(){return V})),i.d(t,"b",(function(){return N}));var r=i(331),n=i(116),a=i(106),s=i(514),o=i(406),c=i(957),l=i(481),d=i(430),h=i(710),u=i(602),p=i(425),f=i(79),b=i(306),m=i(782),g=i(709),v=i(402),y=i(352),O=i(784),x=i(604),j=i(623),_=i(783),S=i(530),w=i(419),C=i(432),P=i(433),T=i(434),E=i(420),A=i(651),R=i(965),D=i(393);class M extends C.a{initializeProgram(e){const t=M.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,receiveShadows:i.receiveShadows,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:i.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:i.symbolColors,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,instanced:i.instanced,instancedColor:i.instancedColor,instancedDoublePrecision:i.instancedDoublePrecision,pbrMode:i.usePBR?i.isSchematic?2:1:0,hasMetalnessAndRoughnessTexture:i.hasMetalnessAndRoughnessTexture,hasEmissionTexture:i.hasEmissionTexture,hasOcclusionTexture:i.hasOcclusionTexture,hasNormalTexture:i.hasNormalTexture,hasColorTexture:i.hasColorTexture,receiveAmbientOcclusion:i.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:i.normalsTypeDerivate?3:0,doubleSidedMode:i.doubleSidedMode,vertexTangents:i.vertexTangents,attributeTextureCoordinates:i.hasMetalnessAndRoughnessTexture||i.hasEmissionTexture||i.hasOcclusionTexture||i.hasNormalTexture||i.hasColorTexture?1:0,textureAlphaPremultiplied:i.textureAlphaPremultiplied,attributeColor:i.vertexColors,screenSizePerspectiveEnabled:i.screenSizePerspective,verticalOffsetEnabled:i.verticalOffset,offsetBackfaces:i.offsetBackfaces,doublePrecisionRequiresObfuscation:Object(_.b)(e.rctx),alphaDiscardMode:i.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new E.a(e.rctx,r,T.a)}bindPass(e,t){var i,r;Object(S.c)(this.program,t.camera.projectionMatrix);const n=this.configuration.output;(1===this.configuration.output||t.multipassTerrainEnabled||3===n)&&this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(y.a)(this.program,t)),7===n&&(this.program.setUniform1f("opacity",e.opacity),this.program.setUniform1f("layerOpacity",e.layerOpacity),this.program.setUniform4fv("externalColor",e.externalColor),this.program.setUniform1i("colorMixMode",p.b[e.colorMixMode])),0===n?(t.lighting.setUniforms(this.program,!1),this.program.setUniform3fv("ambient",e.ambient),this.program.setUniform3fv("diffuse",e.diffuse),this.program.setUniform4fv("externalColor",e.externalColor),this.program.setUniform1i("colorMixMode",p.b[e.colorMixMode]),this.program.setUniform1f("opacity",e.opacity),this.program.setUniform1f("layerOpacity",e.layerOpacity),this.configuration.usePBR&&Object(O.b)(this.program,e,this.configuration.isSchematic)):4===n&&Object(v.b)(this.program,t),Object(j.c)(this.program,e),Object(g.b)(this.program,e,t),Object(p.a)(e.screenSizePerspective,this.program,"screenSizePerspectiveAlignment"),2!==e.textureAlphaMode&&3!==e.textureAlphaMode||this.program.setUniform1f("textureAlphaCutoff",e.textureAlphaCutoff),null==(i=t.shadowMap)||i.bind(this.program),null==(r=t.ssaoHelper)||r.bind(this.program,t.camera)}bindDraw(e){const t=this.configuration.instancedDoublePrecision?Object(a.h)(e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11]):e.origin;Object(S.e)(this.program,t,e.camera.viewMatrix),this.program.rebindTextures(),(0===this.configuration.output||7===this.configuration.output||1===this.configuration.output&&this.configuration.screenSizePerspective||2===this.configuration.output&&this.configuration.screenSizePerspective||4===this.configuration.output&&this.configuration.screenSizePerspective)&&Object(S.a)(this.program,t,e.camera.viewInverseTransposeMatrix),2===this.configuration.output&&this.program.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),this.configuration.instancedDoublePrecision&&m.a.bindCustomOrigin(this.program,t),Object(b.b)(this.program,this.configuration,e.slicePlane,t),0===this.configuration.output&&Object(x.d)(this.program,e,t)}setPipeline(e,t){const i=this.configuration,r=3===e,n=2===e;return Object(D.f)({blending:0!==i.output&&7!==i.output||!i.transparent?null:r?d.g:Object(d.a)(e),culling:I(i)&&Object(D.b)(i.cullFace),depthTest:{func:Object(d.b)(e)},depthWrite:r||n?i.writeDepth&&D.d:null,colorWrite:D.c,stencilWrite:i.sceneHasOcludees?A.h:null,stencilTest:i.sceneHasOcludees?t?A.d:A.c:null,polygonOffset:r||n?null:Object(d.h)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this.setPipeline(this.configuration.transparencyPassType,!0),this.setPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}function I(e){return e.cullFace?0!==e.cullFace:!e.slicePlaneEnabled&&!e.transparent&&!e.doubleSidedMode}M.shader=new w.a(R.a,(()=>i.e(323).then(i.bind(null,1361))));class z extends P.a{constructor(){super(...arguments),this.output=0,this.alphaDiscardMode=1,this.doubleSidedMode=0,this.isSchematic=!1,this.vertexColors=!1,this.offsetBackfaces=!1,this.symbolColors=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.sliceHighlightDisabled=!1,this.receiveAmbientOcclusion=!1,this.screenSizePerspective=!1,this.textureAlphaPremultiplied=!1,this.hasColorTexture=!1,this.usePBR=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.instanced=!1,this.instancedColor=!1,this.instancedDoublePrecision=!1,this.vertexTangents=!1,this.normalsTypeDerivate=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparent=!1,this.enableOffset=!0,this.cullFace=0,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(f.a)([Object(P.b)({count:8})],z.prototype,"output",void 0),Object(f.a)([Object(P.b)({count:4})],z.prototype,"alphaDiscardMode",void 0),Object(f.a)([Object(P.b)({count:3})],z.prototype,"doubleSidedMode",void 0),Object(f.a)([Object(P.b)()],z.prototype,"isSchematic",void 0),Object(f.a)([Object(P.b)()],z.prototype,"vertexColors",void 0),Object(f.a)([Object(P.b)()],z.prototype,"offsetBackfaces",void 0),Object(f.a)([Object(P.b)()],z.prototype,"symbolColors",void 0),Object(f.a)([Object(P.b)()],z.prototype,"vvSize",void 0),Object(f.a)([Object(P.b)()],z.prototype,"vvColor",void 0),Object(f.a)([Object(P.b)()],z.prototype,"verticalOffset",void 0),Object(f.a)([Object(P.b)()],z.prototype,"receiveShadows",void 0),Object(f.a)([Object(P.b)()],z.prototype,"slicePlaneEnabled",void 0),Object(f.a)([Object(P.b)()],z.prototype,"sliceHighlightDisabled",void 0),Object(f.a)([Object(P.b)()],z.prototype,"receiveAmbientOcclusion",void 0),Object(f.a)([Object(P.b)()],z.prototype,"screenSizePerspective",void 0),Object(f.a)([Object(P.b)()],z.prototype,"textureAlphaPremultiplied",void 0),Object(f.a)([Object(P.b)()],z.prototype,"hasColorTexture",void 0),Object(f.a)([Object(P.b)()],z.prototype,"usePBR",void 0),Object(f.a)([Object(P.b)()],z.prototype,"hasMetalnessAndRoughnessTexture",void 0),Object(f.a)([Object(P.b)()],z.prototype,"hasEmissionTexture",void 0),Object(f.a)([Object(P.b)()],z.prototype,"hasOcclusionTexture",void 0),Object(f.a)([Object(P.b)()],z.prototype,"hasNormalTexture",void 0),Object(f.a)([Object(P.b)()],z.prototype,"instanced",void 0),Object(f.a)([Object(P.b)()],z.prototype,"instancedColor",void 0),Object(f.a)([Object(P.b)()],z.prototype,"instancedDoublePrecision",void 0),Object(f.a)([Object(P.b)()],z.prototype,"vertexTangents",void 0),Object(f.a)([Object(P.b)()],z.prototype,"normalsTypeDerivate",void 0),Object(f.a)([Object(P.b)()],z.prototype,"writeDepth",void 0),Object(f.a)([Object(P.b)()],z.prototype,"sceneHasOcludees",void 0),Object(f.a)([Object(P.b)()],z.prototype,"transparent",void 0),Object(f.a)([Object(P.b)()],z.prototype,"enableOffset",void 0),Object(f.a)([Object(P.b)({count:3})],z.prototype,"cullFace",void 0),Object(f.a)([Object(P.b)({count:4})],z.prototype,"transparencyPassType",void 0),Object(f.a)([Object(P.b)()],z.prototype,"multipassTerrainEnabled",void 0),Object(f.a)([Object(P.b)()],z.prototype,"cullAboveGround",void 0);var L=i(966);class F extends M{initializeProgram(e){const t=F.shader.get(),i=this.configuration,r=t.build({OITEnabled:0===i.transparencyPassType,output:i.output,viewingMode:e.viewingMode,receiveShadows:i.receiveShadows,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:i.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:i.symbolColors,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,instanced:i.instanced,instancedColor:i.instancedColor,instancedDoublePrecision:i.instancedDoublePrecision,pbrMode:i.usePBR?1:0,hasMetalnessAndRoughnessTexture:!1,hasEmissionTexture:!1,hasOcclusionTexture:!1,hasNormalTexture:!1,hasColorTexture:i.hasColorTexture,receiveAmbientOcclusion:i.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:0,doubleSidedMode:2,vertexTangents:!1,attributeTextureCoordinates:i.hasColorTexture?1:0,textureAlphaPremultiplied:i.textureAlphaPremultiplied,attributeColor:i.vertexColors,screenSizePerspectiveEnabled:i.screenSizePerspective,verticalOffsetEnabled:i.verticalOffset,offsetBackfaces:i.offsetBackfaces,doublePrecisionRequiresObfuscation:Object(_.b)(e.rctx),alphaDiscardMode:i.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new E.a(e.rctx,r,T.a)}}F.shader=new w.a(L.a,(()=>i.e(320).then(i.bind(null,1362))));class V extends l.a{constructor(e){super(e,U),this.supportsEdges=!0,this.techniqueConfig=new z,this.vertexBufferLayout=function(e){const t=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId,i=Object(s.a)().vec3f("position").vec3f("normal");return e.vertexTangents&&i.vec4f("tangent"),t&&i.vec2f("uv0"),e.vertexColors&&i.vec4u8("color"),e.symbolColors&&i.vec4u8("symbolColor"),i}(this.parameters),this.instanceBufferLayout=e.instanced?N(this.parameters):null}isVisibleInPass(e){return 4!==e&&6!==e&&7!==e||this.parameters.castShadows}isVisible(){const e=this.parameters;if(!super.isVisible()||0===e.layerOpacity)return!1;const t=e.instanced,i=e.vertexColors,r=e.symbolColors,n=!!t&&t.indexOf("color")>-1,a=e.vvColorEnabled,s="replace"===e.colorMixMode,o=e.opacity>0,c=e.externalColor&&e.externalColor[3]>0;return i&&(n||a||r)?!!s||o:i?s?c:o:n||a||r?!!s||o:s?c:o}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.hasNormalTexture=!!this.parameters.normalTextureId,this.techniqueConfig.hasColorTexture=!!this.parameters.textureId,this.techniqueConfig.vertexTangents=this.parameters.vertexTangents,this.techniqueConfig.instanced=!!this.parameters.instanced,this.techniqueConfig.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.verticalOffset=null!==this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=null!==this.parameters.screenSizePerspective,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sliceHighlightDisabled=this.parameters.sliceHighlightDisabled,this.techniqueConfig.alphaDiscardMode=this.parameters.textureAlphaMode,this.techniqueConfig.normalsTypeDerivate="screenDerivative"===this.parameters.normals,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.cullFace=this.parameters.slicePlaneEnabled?0:this.parameters.cullFace,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,0!==e&&7!==e||(this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.symbolColors=this.parameters.symbolColors,this.parameters.treeRendering?this.techniqueConfig.doubleSidedMode=2:this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?1:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?2:0,this.techniqueConfig.instancedColor=!!this.parameters.instanced&&this.parameters.instanced.indexOf("color")>-1,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this.techniqueConfig.receiveAmbientOcclusion=!!t.ssaoEnabled&&this.parameters.receiveSSAO,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this.techniqueConfig.usePBR=this.parameters.usePBR,this.techniqueConfig.hasMetalnessAndRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this.techniqueConfig.hasEmissionTexture=!!this.parameters.emissiveTextureId,this.techniqueConfig.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this.techniqueConfig.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this.techniqueConfig.isSchematic=this.parameters.usePBR&&this.parameters.isSchematic,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.enableOffset=t.camera.relativeElevation<d.e),this.techniqueConfig}intersect(e,t,i,r,a,s,o){if(null!==this.parameters.verticalOffset){const e=r.camera;Object(n.w)(Y,i[12],i[13],i[14]);let t=null;switch(r.viewingMode){case 1:t=Object(n.r)(W,Y);break;case 2:t=Object(n.k)(W,q)}let o=0;if(null!==this.parameters.verticalOffset){const i=Object(n.j)(Z,Y,e.eye),r=Object(n.p)(i),a=Object(n.e)(i,i,1/r);let s=null;this.parameters.screenSizePerspective&&(s=Object(n.h)(t,a)),o+=Object(p.i)(e,r,this.parameters.verticalOffset,s,this.parameters.screenSizePerspective)}Object(n.e)(t,t,o),Object(n.x)($,t,r.transform.inverseRotation),a=Object(n.j)(k,a,$),s=Object(n.j)(H,s,$)}Object(p.f)(e,t,r,a,s,Object(h.c)(r.verticalOffset),o)}requiresSlot(e){return e===(this.parameters.transparent?this.parameters.writeDepth?4:7:2)||20===e}createGLMaterial(e){return 0===e.output||7===e.output||1===e.output||2===e.output||3===e.output||4===e.output?new G(e):null}createBufferWriter(){return new B(this.vertexBufferLayout,this.instanceBufferLayout)}}class G extends c.a{constructor(e){super({...e,...e.material.parameters})}updateParameters(e){const t=this._material.parameters;return this.updateTexture(t.textureId),this.ensureTechnique(t.treeRendering?F:M,e)}_updateShadowState(e){e.shadowMappingEnabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMappingEnabled})}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return 0!==this._output&&7!==this._output||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.parameters,e),this.bindTextures(t.program)}}const U={textureId:void 0,initTextureTransparent:!1,isSchematic:!1,usePBR:!1,normalTextureId:void 0,vertexTangents:!1,occlusionTextureId:void 0,emissiveTextureId:void 0,metallicRoughnessTextureId:void 0,emissiveFactor:[0,0,0],mrrFactors:[0,1,.5],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:2,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,receiveShadows:!0,castShadows:!0,shadowMappingEnabled:!1,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,sliceHighlightDisabled:!1,offsetTransparentBackfaces:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:Object(r.b)(),transparent:!1,writeDepth:!0,textureAlphaMode:0,textureAlphaCutoff:o.b,textureAlphaPremultiplied:!1,sceneHasOcludees:!1,...l.b};class B{constructor(e,t){this.vertexBufferLayout=e,this.instanceBufferLayout=t}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,i,r){Object(u.c)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)}}function N(e){let t=Object(s.a)();return t=e.instancedDoublePrecision?t.vec3f("modelOriginHi").vec3f("modelOriginLo").mat3f("model").mat3f("modelNormal"):t.mat4f("model").mat4f("modelNormal"),e.instanced&&e.instanced.indexOf("color")>-1&&(t=t.vec4f("instanceColor")),e.instanced&&e.instanced.indexOf("featureAttribute")>-1&&(t=t.vec4f("instanceFeatureAttribute")),t}const k=Object(a.f)(),H=Object(a.f)(),q=Object(a.h)(0,0,1),W=Object(a.f)(),$=Object(a.f)(),Y=Object(a.f)(),Z=Object(a.f)()},769:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(480),n=i(261),a=i(188);const s={getObjectId:e=>e.objectId,getAttributes:e=>e.attributes,getAttribute:(e,t)=>e.attributes[t],cloneWithGeometry:(e,t)=>new n.b(t,e.attributes,null,e.objectId),getGeometry:e=>e.geometry,getCentroid:(e,t)=>(e.centroid||(e.centroid=Object(r.a)(new a.a,e.geometry,t.hasZ,t.hasM)),e.centroid)}},778:function(e,t,i){"use strict";i.d(t,"a",(function(){return j})),i.d(t,"b",(function(){return v})),i.d(t,"c",(function(){return y})),i.d(t,"d",(function(){return O}));var r=i(145),n=i(224),a=i(245),s=i(306),o=i(906),c=i(779),l=i(1037),d=i(402),h=i(623),u=i(406),p=i(467),f=i(633),b=i(814),m=i(136),g=i(342);function v(e){const t=new g.a,i=e.signedDistanceFieldEnabled;if(t.include(o.a),t.include(c.a,e),t.include(s.a,e),6===e.output)return t.include(l.a,e),t;t.include(b.a),t.fragment.include(f.a),t.fragment.include(p.a),t.include(h.a,e),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),e.binaryHighlightOcclusionEnabled&&t.varyings.add("voccluded","float"),t.vertex.uniforms.add("screenOffset","vec2").add("anchorPos","vec2").add("textureCoordinateScaleFactor","vec2").add("materialColor","vec4"),i&&t.vertex.uniforms.add("outlineColor","vec4"),e.screenSizePerspectiveEnabled&&t.vertex.uniforms.add("screenSizePerspective","vec4"),(e.debugDrawBorder||e.binaryHighlightOcclusionEnabled)&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add("uv0","vec2"),t.attributes.add("color","vec4"),t.attributes.add("size","vec2"),t.attributes.add("auxpos2","vec4"),t.vertex.code.add(m.a`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${e.screenSizePerspectiveEnabled?m.a`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:m.a`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${e.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${e.occlusionTestEnabled||e.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${e.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const r=m.a`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPos) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,n=e.pixelSnappingEnabled?i?m.a`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:m.a`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:m.a`posProj += quadOffset;`;t.vertex.code.add(m.a`
      ${e.occlusionTestEnabled?"if (visible) {":""}
      ${r}
      ${e.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

      bool alphaDiscard = vcolor.a < ${m.a.float(u.c)};
      ${i?`alphaDiscard = alphaDiscard && outlineColor.a < ${m.a.float(u.c)};`:""}
      if (alphaDiscard) {
        // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      } else {
        ${n}
        gl_Position = posProj;
      }

      vtc = uv * textureCoordinateScaleFactor;

      ${e.debugDrawBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
      vsize = inputSize;
      ${e.occlusionTestEnabled?m.a`} else { vtc = vec2(0.0);
        ${e.debugDrawBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
    }
    `),t.fragment.uniforms.add("tex","sampler2D"),i&&(t.fragment.uniforms.add("outlineColor","vec4"),t.fragment.uniforms.add("outlineSize","float"));const a=e.debugDrawBorder?m.a`(isBorder > 0.0 ? 0.0 : ${m.a.float(u.b)})`:m.a.float(u.b),v=m.a`
    ${e.debugDrawBorder?m.a`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${i?m.a`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = 128.0;
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${a} ||
          fillPixelColor.a + outlinePixelColor.a < ${m.a.float(u.c)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${a}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:m.a`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${a}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    ${e.debugDrawBorder?m.a`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder);`:""}
  `;return 7===e.output&&t.fragment.code.add(m.a`
      void main() {
        ${v}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),0===e.output&&t.fragment.code.add(m.a`
    void main() {
      ${v}
      ${e.FrontFacePass?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),4===e.output&&(t.include(d.a),t.fragment.code.add(m.a`
    void main() {
      ${v}
      ${e.binaryHighlightOcclusionEnabled?m.a`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),t}function y(e,t,i){e.setUniform4fv("materialColor",t.color),t.textureIsSignedDistanceField&&(t.outlineColor[3]<=0||t.outlineSize<=0?(e.setUniform4fv("outlineColor",a.b),e.setUniform1f("outlineSize",0)):(e.setUniform4fv("outlineColor",t.outlineColor),e.setUniform1f("outlineSize",t.outlineSize))),e.setUniform2f("screenOffset",2*t.screenOffset[0]*i,2*t.screenOffset[1]*i),e.setUniform2fv("anchorPos",O(t))}function O(e,t=x){return e.textureIsSignedDistanceField?function(e,t,i){i[0]=e[0]*(t[2]-t[0])+t[0],i[1]=e[1]*(t[3]-t[1])+t[1]}(e.anchorPos,e.distanceFieldBoundingBox,t):Object(r.c)(t,e.anchorPos),t}const x=Object(n.a)(),j=Object.freeze({__proto__:null,build:v,bindHUDMaterialUniforms:y,calculateAnchorPosForRendering:O})},779:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return s}));var r=i(814),n=i(136);function a(e,t){const i=e;i.include(r.a),i.attributes.add("position","vec3"),i.attributes.add("normal","vec3"),i.attributes.add("auxpos1","vec4"),i.vertex.uniforms.add("proj","mat4"),i.vertex.uniforms.add("view","mat4"),i.vertex.uniforms.add("viewNormal","mat4"),i.vertex.uniforms.add("viewport","vec4"),i.vertex.uniforms.add("camPos","vec3"),i.vertex.uniforms.add("polygonOffset","float"),i.vertex.uniforms.add("cameraGroundRelative","float"),i.vertex.uniforms.add("pixelRatio","float"),i.vertex.uniforms.add("perDistancePixelRatio","float"),i.vertex.uniforms.add("uRenderTransparentlyOccludedHUD","float"),t.verticalOffsetEnabled&&i.vertex.uniforms.add("verticalOffset","vec4"),t.screenSizePerspectiveEnabled&&i.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4"),i.vertex.uniforms.add("hudVisibilityTexture","sampler2D"),i.vertex.constants.add("smallOffsetAngle","float",.984807753012208),i.vertex.code.add(n.a`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),i.vertex.code.add(n.a`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),t.isDraped||i.vertex.code.add(n.a`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`),i.vertex.code.add(n.a`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${t.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(camPos - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${t.screenSizePerspectiveEnabled&&(t.verticalOffsetEnabled||1===t.screenCenterOffsetUnitsEnabled)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${t.verticalOffsetEnabled?t.screenSizePerspectiveEnabled?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${t.verticalOffsetEnabled?n.a`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${1!==t.screenCenterOffsetUnitsEnabled?n.a`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${1===t.screenCenterOffsetUnitsEnabled?t.screenSizePerspectiveEnabled?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${1===t.screenCenterOffsetUnitsEnabled?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),i.vertex.code.add(n.a`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (uRenderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * uRenderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}function s(e,t){e.setUniform1f("uRenderTransparentlyOccludedHUD",0===t.renderTransparentlyOccludedHUD?1:1===t.renderTransparentlyOccludedHUD?0:.75)}},780:function(e,t,i){"use strict";i.d(t,"a",(function(){return b})),i.d(t,"b",(function(){return f}));var r=i(306),n=i(441),a=i(603),s=i(634),o=i(402),c=i(401),l=i(352),d=i(406),h=i(467),u=i(136),p=i(342);function f(e){const t=new p.a,i=1===e.output;return t.include(n.a,{linearDepth:i}),t.include(a.a,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add("position","vec3"),t.varyings.add("vpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),i&&(t.include(s.a,e),t.vertex.uniforms.add("cameraNearFar","vec2"),t.varyings.add("linearDepth","float")),t.vertex.code.add(u.a`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${i?u.a`transformPositionWithDepth(proj, view, vpos, cameraNearFar, linearDepth);`:u.a`transformPosition(proj, view, vpos);`}
    }
  `),t.include(r.a,e),t.fragment.include(h.a),e.multipassTerrainEnabled&&(t.fragment.include(c.a),t.include(l.b,e)),t.fragment.uniforms.add("eColor","vec4"),4===e.output&&t.include(o.a),t.fragment.code.add(u.a`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 color = ${e.attributeColor?"vColor * eColor;":"eColor;"}

    if (color.a < ${u.a.float(d.c)}) {
      discard;
    }

    ${7===e.output?u.a`gl_FragColor = vec4(color.a);`:""}

    ${0===e.output?u.a`gl_FragColor = highlightSlice(color, vpos); ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${4===e.output?u.a`outputHighlight();`:""};
    ${1===e.output?u.a`outputDepth(linearDepth);`:""};
  }
  `),t}const b=Object.freeze({__proto__:null,build:f})},782:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r,n=i(106),a=i(783),s=i(136),o=i(767);function c(e,t){t.instanced&&t.instancedDoublePrecision&&(e.attributes.add("modelOriginHi","vec3"),e.attributes.add("modelOriginLo","vec3"),e.attributes.add("model","mat3"),e.attributes.add("modelNormal","mat3")),t.instancedDoublePrecision&&(e.vertex.include(a.a,t),e.vertex.uniforms.add("viewOriginHi","vec3"),e.vertex.uniforms.add("viewOriginLo","vec3"));const i=[s.a`
    vec3 calculateVPos() {
      ${t.instancedDoublePrecision?"return model * localPosition().xyz;":"return localPosition().xyz;"}
    }
    `,s.a`
    vec3 subtractOrigin(vec3 _pos) {
      ${t.instancedDoublePrecision?s.a`
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -modelOriginHi, -modelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `,s.a`
    vec3 dpNormal(vec4 _normal) {
      ${t.instancedDoublePrecision?"return normalize(modelNormal * _normal.xyz);":"return normalize(_normal.xyz);"}
    }
    `,s.a`
    vec3 dpNormalView(vec4 _normal) {
      ${t.instancedDoublePrecision?"return normalize((viewNormal * vec4(modelNormal * _normal.xyz, 1.0)).xyz);":"return normalize((viewNormal * _normal).xyz);"}
    }
    `,t.vertexTangents?s.a`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${t.instancedDoublePrecision?"return vec4(modelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}

    }
    `:s.a``];e.vertex.code.add(i[0]),e.vertex.code.add(i[1]),e.vertex.code.add(i[2]),2===t.output&&e.vertex.code.add(i[3]),e.vertex.code.add(i[4])}(r=c||(c={})).Uniforms=class{},r.bindCustomOrigin=function(e,t){Object(o.b)(t,l,d,3),e.setUniform3fv("viewOriginHi",l),e.setUniform3fv("viewOriginLo",d)};const l=Object(n.f)(),d=Object(n.f)()},783:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return s}));var r=i(82),n=i(136);function a({code:e},t){t.doublePrecisionRequiresObfuscation?e.add(n.a`vec3 dpPlusFrc(vec3 a, vec3 b) {
return mix(a, a + b, vec3(notEqual(b, vec3(0))));
}
vec3 dpMinusFrc(vec3 a, vec3 b) {
return mix(vec3(0), a - b, vec3(notEqual(a, b)));
}
vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = dpPlusFrc(hiA, hiB);
vec3 e = dpMinusFrc(t1, hiA);
vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
return t1 + t2;
}`):e.add(n.a`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = hiA + hiB;
vec3 e = t1 - hiA;
vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
return t1 + t2;
}`)}function s(e){return!!Object(r.a)("force-double-precision-obfuscation")||e.driverTest.doublePrecisionRequiresObfuscation}},784:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));var r=i(431),n=i(1011),a=i(136);Object(r.c)(0,.6,.2);function s(e,t){const i=e.fragment,r=t.hasMetalnessAndRoughnessTexture||t.hasEmissionTexture||t.hasOcclusionTexture;1===t.pbrMode&&r&&e.include(n.a,t),2!==t.pbrMode?(0===t.pbrMode&&i.code.add(a.a`float getBakedOcclusion() { return 1.0; }`),1===t.pbrMode&&(i.uniforms.add("emissionFactor","vec3"),i.uniforms.add("mrrFactors","vec3"),i.code.add(a.a`vec3 mrr;
vec3 emission;
float occlusion;`),t.hasMetalnessAndRoughnessTexture&&(i.uniforms.add("texMetallicRoughness","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texMetallicRoughnessSize","vec2"),i.code.add(a.a`void applyMetallnessAndRoughness(TextureLookupParameter params) {
vec3 metallicRoughness = textureLookup(texMetallicRoughness, params).rgb;
mrr[0] *= metallicRoughness.b;
mrr[1] *= metallicRoughness.g;
}`)),t.hasEmissionTexture&&(i.uniforms.add("texEmission","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texEmissionSize","vec2"),i.code.add(a.a`void applyEmission(TextureLookupParameter params) {
emission *= textureLookup(texEmission, params).rgb;
}`)),t.hasOcclusionTexture?(i.uniforms.add("texOcclusion","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texOcclusionSize","vec2"),i.code.add(a.a`void applyOcclusion(TextureLookupParameter params) {
occlusion *= textureLookup(texOcclusion, params).r;
}
float getBakedOcclusion() {
return occlusion;
}`)):i.code.add(a.a`float getBakedOcclusion() { return 1.0; }`),i.code.add(a.a`
    void applyPBRFactors() {
      mrr = mrrFactors;
      emission = emissionFactor;
      occlusion = 1.0;
      ${r?"vtc.uv = vuv0;":""}
      ${t.hasMetalnessAndRoughnessTexture?t.supportsTextureAtlas?"vtc.size = texMetallicRoughnessSize; applyMetallnessAndRoughness(vtc);":"applyMetallnessAndRoughness(vtc);":""}
      ${t.hasEmissionTexture?t.supportsTextureAtlas?"vtc.size = texEmissionSize; applyEmission(vtc);":"applyEmission(vtc);":""}
      ${t.hasOcclusionTexture?t.supportsTextureAtlas?"vtc.size = texOcclusionSize; applyOcclusion(vtc);":"applyOcclusion(vtc);":""}
    }
  `))):i.code.add(a.a`const vec3 mrr = vec3(0.0, 0.6, 0.2);
const vec3 emission = vec3(0.0);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`)}function o(e,t,i=!1){i||(e.setUniform3fv("mrrFactors",t.mrrFactors),e.setUniform3fv("emissionFactor",t.emissiveFactor))}},790:function(e,t,i){"use strict";i.d(t,"a",(function(){return d}));var r=i(136);function n(e,t){const i=e.fragment,n=void 0!==t.lightingSphericalHarmonicsOrder?t.lightingSphericalHarmonicsOrder:2;0===n?(i.uniforms.add("lightingAmbientSH0","vec3"),i.code.add(r.a`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
return ambientLight * (1.0 - ambientOcclusion);
}`)):1===n?(i.uniforms.add("lightingAmbientSH_R","vec4"),i.uniforms.add("lightingAmbientSH_G","vec4"),i.uniforms.add("lightingAmbientSH_B","vec4"),i.code.add(r.a`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec4 sh0 = vec4(
0.282095,
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y
);
vec3 ambientLight = vec3(
dot(lightingAmbientSH_R, sh0),
dot(lightingAmbientSH_G, sh0),
dot(lightingAmbientSH_B, sh0)
);
return ambientLight * (1.0 - ambientOcclusion);
}`)):2===n&&(i.uniforms.add("lightingAmbientSH0","vec3"),i.uniforms.add("lightingAmbientSH_R1","vec4"),i.uniforms.add("lightingAmbientSH_G1","vec4"),i.uniforms.add("lightingAmbientSH_B1","vec4"),i.uniforms.add("lightingAmbientSH_R2","vec4"),i.uniforms.add("lightingAmbientSH_G2","vec4"),i.uniforms.add("lightingAmbientSH_B2","vec4"),i.code.add(r.a`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
vec4 sh1 = vec4(
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y,
1.092548 * normal.x * normal.y
);
vec4 sh2 = vec4(
1.092548 * normal.y * normal.z,
0.315392 * (3.0 * normal.z * normal.z - 1.0),
1.092548 * normal.x * normal.z,
0.546274 * (normal.x * normal.x - normal.y * normal.y)
);
ambientLight += vec3(
dot(lightingAmbientSH_R1, sh1),
dot(lightingAmbientSH_G1, sh1),
dot(lightingAmbientSH_B1, sh1)
);
ambientLight += vec3(
dot(lightingAmbientSH_R2, sh2),
dot(lightingAmbientSH_G2, sh2),
dot(lightingAmbientSH_B2, sh2)
);
return ambientLight * (1.0 - ambientOcclusion);
}`),1!==t.pbrMode&&2!==t.pbrMode||i.code.add(r.a`const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);
vec3 calculateAmbientRadiance(float ambientOcclusion)
{
vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
}`))}var a=i(715);function s(e){const t=e.fragment;t.uniforms.add("lightingMainDirection","vec3"),t.uniforms.add("lightingMainIntensity","vec3"),t.uniforms.add("lightingFixedFactor","float"),t.code.add(r.a`vec3 evaluateMainLighting(vec3 normal_global, float shadowing) {
float dotVal = clamp(dot(normal_global, lightingMainDirection), 0.0, 1.0);
dotVal = mix(dotVal, 1.0, lightingFixedFactor);
return lightingMainIntensity * ((1.0 - shadowing) * dotVal);
}`)}var o=i(752),c=i(905),l=i(604);function d(e,t){const i=e.fragment;e.include(s),e.include(a.a,t),0!==t.pbrMode&&e.include(o.a,t),e.include(n,t),t.receiveShadows&&e.include(l.a,t),i.uniforms.add("lightingGlobalFactor","float"),i.uniforms.add("ambientBoostFactor","float"),e.include(c.a),i.code.add(r.a`
    const float GAMMA_SRGB = 2.1;
    const float INV_GAMMA_SRGB = 0.4761904;
    ${0===t.pbrMode?"":"const vec3 GROUND_REFLECTANCE = vec3(0.2);"}
  `),i.code.add(r.a`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${1===t.viewingMode?r.a`normalize(vPosWorld)`:r.a`vec3(0.0, 0.0, 1.0)`}, lightingMainDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),i.code.add(r.a`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * lightingMainIntensity;
}`),0===t.pbrMode||4===t.pbrMode?i.code.add(r.a`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight)
{
vec3 mainLighting = evaluateMainLighting(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`):1!==t.pbrMode&&2!==t.pbrMode||(i.code.add(r.a`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)
{
vec3 viewDirection = -viewDir;
vec3 mainLightDirection = lightingMainDirection;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);
inputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);
inputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),i.code.add(r.a`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),i.code.add(r.a`vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);
ambientDir = ambientDir != vec3(0.0)? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = abs(dot(normal, ambientDir));
vec3 mainLightIrradianceComponent = inputs.NdotL * (1.0 - shadow) * lightingMainIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * lightingMainIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),i.code.add(r.a`vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
vec3 mainLightRadianceComponent = normalDistribution(inputs.NdotH, inputs.roughness) * lightingMainIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * lightingMainIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = calculateAmbientRadiance(ssao) + additionalLight;
inputs.skyRadianceToSurface = ambientLightRadianceComponent + mainLightRadianceComponent + horizonLightRadianceComponent;
inputs.groundRadianceToSurface = GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);`),i.code.add(r.a`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = pow(_emission, vec3(GAMMA_SRGB));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${2===t.pbrMode?r.a`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:r.a`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `))}},802:function(e,t,i){"use strict";i.d(t,"a",(function(){return O})),i.d(t,"b",(function(){return v})),i.d(t,"c",(function(){return g})),i.d(t,"d",(function(){return w})),i.d(t,"e",(function(){return S})),i.d(t,"f",(function(){return y})),i.d(t,"g",(function(){return j})),i.d(t,"h",(function(){return x})),i.d(t,"i",(function(){return _}));var r=i(87),n=i(85),a=i(271),s=i(331),o=i(199),c=i(116),l=i(106),d=i(207),h=i(197),u=i(110),p=i(164),f=i(403),b=i(682);const m=r.a.getLogger("esri.geometry.support.meshUtils.normalProjection");function g(e,t,i,r,n){return P(r)?(C(0,f.u.fromTypedArray(e),f.v.fromTypedArray(t),f.v.fromTypedArray(i),r,f.u.fromTypedArray(n)),n):(m.error("Cannot convert spatial reference to PCPF"),n)}function v(e,t,i,r,n){return P(r)?(C(1,f.u.fromTypedArray(e),f.v.fromTypedArray(t),f.v.fromTypedArray(i),r,f.u.fromTypedArray(n)),n):(m.error("Cannot convert to spatial reference from PCPF"),n)}function y(e,t,i){return Object(d.l)(e,t,0,i,Object(h.g)(t),0,e.length/3),i}function O(e,t,i){return Object(d.l)(e,Object(h.g)(i),0,t,i,0,e.length/3),t}function x(e,t,i){if(Object(n.k)(e))return t;const r=f.v.fromTypedArray(e),a=f.v.fromTypedArray(t);return Object(b.e)(a,r,i),t}function j(e,t,i){if(Object(n.k)(e))return t;Object(a.a)(D,i);const r=f.u.fromTypedArray(e),s=f.u.fromTypedArray(t);return Object(b.a)(s,r,D),Object(a.g)(D)||Object(b.c)(s,s),t}function _(e,t,i){if(Object(n.k)(e))return t;Object(a.a)(D,i);const r=f.u.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),s=f.u.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT);if(Object(b.a)(s,r,D),Object(a.g)(D)||Object(b.c)(s,s),e!==t)for(let n=3;n<e.length;n+=4)t[n]=e[n];return t}function S(e,t,i,r,n){if(!P(r))return m.error("Cannot convert spatial reference to PCPF"),n;C(0,f.u.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),f.v.fromTypedArray(t),f.v.fromTypedArray(i),r,f.u.fromTypedArray(n,4*Float32Array.BYTES_PER_ELEMENT));for(let a=3;a<e.length;a+=4)n[a]=e[a];return n}function w(e,t,i,r,n){if(!P(r))return m.error("Cannot convert to spatial reference from PCPF"),n;C(1,f.u.fromTypedArray(e,16),f.v.fromTypedArray(t),f.v.fromTypedArray(i),r,f.u.fromTypedArray(n,16));for(let a=3;a<e.length;a+=4)n[a]=e[a];return n}function C(e,t,i,r,n,s){if(!t)return;const o=i.count,l=Object(h.g)(n);if(T(n))for(let h=0;h<o;h++)r.getVec(h,E),t.getVec(h,A),Object(d.d)(l,E,R,l),Object(a.f)(D,R),1===e&&Object(a.m)(D,D),Object(c.x)(A,A,D),s.setVec(h,A);else for(let h=0;h<o;h++){r.getVec(h,E),t.getVec(h,A),Object(d.d)(l,E,R,l),Object(a.f)(D,R);const n=Object(p.h)(i.get(h,1));let o=Math.cos(n);0===e&&(o=1/o),D[0]*=o,D[1]*=o,D[2]*=o,D[3]*=o,D[4]*=o,D[5]*=o,1===e&&Object(a.m)(D,D),Object(c.x)(A,A,D),Object(c.r)(A,A),s.setVec(h,A)}return s}function P(e){return T(e)||function(e){return e.isWebMercator}(e)}function T(e){return e.isWGS84||Object(u.f)(e)||Object(u.i)(e)||Object(u.j)(e)}const E=Object(l.f)(),A=Object(l.f)(),R=Object(o.d)(),D=Object(s.b)()},811:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r=i(85),n=i(222),a=i(215),s=i(116),o=i(106),c=i(650),l=i(332),d=i(440),h=i(315);class u{constructor(e,t){this._objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new p,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth))}get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}destroy(){this._degenerateObjects.clear(),p.clearPool(),S[0]=null,E.prune(),z.prune()}add(e,t=e.length){this._objectCount+=t,this._grow(e,t);const i=p.acquire();for(let r=0;r<t;r++){const t=e[r];this._isDegenerate(t)?this._degenerateObjects.add(t):(i.init(this._root),this._add(t,i))}p.release(i)}remove(e,t=null){this._objectCount-=e.length;const i=p.acquire();for(const n of e){const e=Object(r.l)(t)?t:Object(d.b)(this._objectToBoundingSphere(n),A);O(e[3])?(i.init(this._root),this._remove(n,e,i)):this._degenerateObjects.delete(n)}p.release(i),this._shrink()}update(e,t){if(!O(t[3])&&this._isDegenerate(e))return;const i=function(e){return S[0]=e,S}(e);this.remove(i,t),this.add(i)}forEachAlongRay(e,t,i){const r=Object(l.g)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNode(r,e))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObject(r,e)&&i(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObject(r,e)&&i(e)})),!0}))}forEachAlongRayWithVerticalOffset(e,t,i,r){const n=Object(l.g)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNodeWithOffset(n,e,r))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObjectWithOffset(n,e,r)&&i(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObjectWithOffset(n,e,r)&&i(e)})),!0}))}forEach(e){this._forEachNode(this._root,(t=>{const i=t.node;return i.terminals.forAll(e),null!==i.residents&&i.residents.forAll(e),!0})),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,i,r=(()=>!0),n=1/0){let a=1/0,o=1/0,l=null;const h=v(e,t),u=s=>{if(--n,!r(s))return;const h=this._objectToBoundingSphere(s);if(!Object(c.e)(i,h))return;const u=y(e,t,Object(d.e)(h)),p=u-h[3],f=u+h[3];p<a&&(a=p,o=f,l=s)};return this._forEachNodeDepthOrdered(this._root,(r=>{if(n<=0||!Object(c.e)(i,r.bounds))return!1;if(Object(s.e)(C,h,r.halfSize),Object(s.f)(C,C,r.bounds),y(e,t,C)>o)return!1;const a=r.node;return a.terminals.forAll((e=>u(e))),null!==a.residents&&a.residents.forAll((e=>u(e))),!0}),e,t),l}forEachInDepthRange(e,t,i,r,n,a,o){let l=-1/0,h=1/0;const u={setRange:e=>{1===i?(l=Math.max(l,e.near),h=Math.min(h,e.far)):(l=Math.max(l,-e.far),h=Math.min(h,-e.near))}};u.setRange(r);const p=y(t,i,e),f=v(t,i),b=v(t,-i),m=e=>{if(!o(e))return;const r=this._objectToBoundingSphere(e),s=Object(d.e)(r),f=y(t,i,s)-p,b=f-r[3],m=f+r[3];b>h||m<l||!Object(c.e)(a,r)||n(e,u)};this._forEachNodeDepthOrdered(this._root,(e=>{if(!Object(c.e)(a,e.bounds))return!1;if(Object(s.e)(C,f,e.halfSize),Object(s.f)(C,C,e.bounds),y(t,i,C)-p>h)return!1;if(Object(s.e)(C,b,e.halfSize),Object(s.f)(C,C,e.bounds),y(t,i,C)-p<l)return!1;const r=e.node;return r.terminals.forAll((e=>m(e))),null!==r.residents&&r.residents.forAll((e=>m(e))),!0}),t,i)}forEachNode(e){this._forEachNode(this._root,(t=>e(t.node,t.bounds,t.halfSize)))}_intersectsNode(e,t){return m(t.bounds,2*-t.halfSize,P),m(t.bounds,2*t.halfSize,T),Object(h.h)(e.origin,e.direction,P,T)}_intersectsNodeWithOffset(e,t,i){return m(t.bounds,2*-t.halfSize,P),m(t.bounds,2*t.halfSize,T),i.applyToMinMax(P,T),Object(h.h)(e.origin,e.direction,P,T)}_intersectsObject(e,t){const i=this._objectToBoundingSphere(t);return!(i[3]>0)||Object(d.f)(i,e)}_intersectsObjectWithOffset(e,t,i){const r=this._objectToBoundingSphere(t);return!(r[3]>0)||Object(d.f)(i.applyToBoundingSphere(r),e)}_forEachNode(e,t){let i=p.acquire().init(e);const r=[i];for(;0!==r.length;){if(i=r.pop(),t(i)&&!i.isLeaf())for(let e=0;e<i.node.children.length;e++)i.node.children[e]&&r.push(p.acquire().init(i).advance(e));p.release(i)}}_forEachNodeDepthOrdered(e,t,i,r=1){let n=p.acquire().init(e);const a=[n];for(function(e,t,i){if(!z.length)for(let r=0;r<8;++r)z.push({index:0,distance:0});for(let r=0;r<8;++r){const i=x[r];z.data[r].index=r,z.data[r].distance=y(e,t,i)}z.sort(((e,t)=>e.distance-t.distance));for(let r=0;r<8;++r)i[r]=z.data[r].index}(i,r,L);0!==a.length;){if(n=a.pop(),t(n)&&!n.isLeaf())for(let e=7;e>=0;--e){const t=L[e];n.node.children[t]&&a.push(p.acquire().init(n).advance(t))}p.release(n)}}_remove(e,t,i){E.clear();const r=i.advanceTo(t,((e,t)=>{E.push(e.node),E.push(t)}))?i.node.terminals:i.node.residents;if(r.removeUnordered(e),0===r.length)for(let n=E.length-2;n>=0;n-=2){const e=E.data[n],t=E.data[n+1];if(!this._purge(e,t))break}}_nodeIsEmpty(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}_purge(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new a.a({shrink:!0})),!0)}_add(e,t){t.advanceTo(this._objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let i=0;i<t.length;i++){const r=p.acquire().init(e);this._add(t.getItemAt(i),r),p.release(r)}}_grow(e,t){if(0!==t&&(g(e,t,(e=>this._objectToBoundingSphere(e)),R),O(R[3])&&!this._fitsInsideTree(R)))if(this._nodeIsEmpty(this._root.node))Object(d.b)(R,this._root.bounds),this._root.halfSize=1.25*R[3];else{const e=this._rootBoundsForRootAsSubNode(R);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(R,e):this._growRootAsSubNode(e),p.release(e)}}_rebuildTree(e,t){Object(s.k)(D,t.bounds),D[3]=t.halfSize,g([e,D],2,(e=>e),M);const i=p.acquire().init(this._root);this._root.initFrom(null,M,1.25*M[3]),this._forEachNode(i,(e=>(this.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&this.add(e.node.residents.data,e.node.residents.length),!0))),p.release(i)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let i=0;return this._forEachNode(this._root,(e=>(i=Math.max(i,e.depth),i+t<=this._maximumDepth))),i+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],i=e;let r=-1/0;const n=this._root.bounds,a=this._root.halfSize;for(let s=0;s<3;s++){const e=n[s]-a-(i[s]-t),o=i[s]+t-(n[s]+a),c=Math.max(0,Math.ceil(e/(2*a))),l=Math.max(0,Math.ceil(o/(2*a)))+1,d=2**Math.ceil(Math.log(c+l)*Math.LOG2E);r=Math.max(r,d),I[s].min=c,I[s].max=l}for(let s=0;s<3;s++){let e=I[s].min,t=I[s].max;const i=(r-(e+t))/2;e+=Math.ceil(i),t+=Math.floor(i);const o=n[s]-a-e*a*2;w[s]=o+(t+e)*a}return w[3]=r*a*_,p.acquire().initFrom(null,w,r*a,0)}_growRootAsSubNode(e){const t=this._root.node;Object(s.k)(R,this._root.bounds),R[3]=this._root.halfSize,this._root.init(e),e.advanceTo(R,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let i=0,r=0;for(;r<t.length&&null==e;)i=r++,e=t[i];for(;r<t.length;)if(t[r++])return-1;return i}_isDegenerate(e){return!O(this._objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,i=this._root.halfSize;return e[3]<=i&&e[0]>=t[0]-i&&e[0]<=t[0]+i&&e[1]>=t[1]-i&&e[1]<=t[1]+i&&e[2]>=t[2]-i&&e[2]<=t[2]+i}}class p{constructor(){this.bounds=Object(d.c)(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,i,n=this.depth){return this.node=Object(r.l)(e)?e:p.createEmptyNode(),Object(r.l)(t)&&Object(d.b)(t,this.bounds),this.halfSize=i,this.depth=n,this}advance(e){let t=this.node.children[e];t||(t=p.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const i=x[e];return this.bounds[0]+=i[0]*this.halfSize,this.bounds[1]+=i[1]*this.halfSize,this.bounds[2]+=i[2]*this.halfSize,this.bounds[3]=this.halfSize*_,this}advanceTo(e,t,i=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!i)return t&&t(this,-1),!1;this.node.residents=null}const r=this._childIndex(e);t&&t(this,r),this.advance(r)}}isLeaf(){return null!=this.node.residents}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new a.a({shrink:!0}),residents:new a.a({shrink:!0})}}static acquire(){return p._pool.acquire()}static release(e){p._pool.release(e)}static clearPool(){p._pool.prune()}}function f(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function b(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function m(e,t,i){i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t}function g(e,t,i,r){if(1===t){const t=i(e[0]);Object(d.b)(t,r)}else{P[0]=1/0,P[1]=1/0,P[2]=1/0,T[0]=-1/0,T[1]=-1/0,T[2]=-1/0;for(let r=0;r<t;r++){const t=i(e[r]);O(t[3])&&(f(P,t),b(T,t))}Object(s.i)(r,P,T,.5),r[3]=Math.max(T[0]-P[0],T[1]-P[1],T[2]-P[2])/2}}function v(e,t){let i=1/0,r=null;for(let n=0;n<8;++n){const a=y(e,t,j[n]);a<i&&(i=a,r=j[n])}return r}function y(e,t,i){return t*(e[0]*i[0]+e[1]*i[1]+e[2]*i[2])}function O(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}p._pool=new n.a(p);const x=[Object(o.h)(-1,-1,-1),Object(o.h)(1,-1,-1),Object(o.h)(-1,1,-1),Object(o.h)(1,1,-1),Object(o.h)(-1,-1,1),Object(o.h)(1,-1,1),Object(o.h)(-1,1,1),Object(o.h)(1,1,1)],j=[Object(o.h)(-1,-1,-1),Object(o.h)(-1,-1,1),Object(o.h)(-1,1,-1),Object(o.h)(-1,1,1),Object(o.h)(1,-1,-1),Object(o.h)(1,-1,1),Object(o.h)(1,1,-1),Object(o.h)(1,1,1)],_=Math.sqrt(3),S=[null];const w=Object(d.c)(),C=Object(o.f)(),P=Object(o.f)(),T=Object(o.f)(),E=new a.a,A=Object(d.c)(),R=Object(d.c)(),D=Object(d.c)(),M=Object(d.c)(),I=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],z=new a.a,L=[0,0,0,0,0,0,0,0]},812:function(e,t,i){"use strict";i.d(t,"a",(function(){return f})),i.d(t,"b",(function(){return m})),i.d(t,"c",(function(){return b}));var r=i(306),n=i(1036),a=i(634),s=i(401),o=i(859),c=i(352),l=i(905),d=i(406),h=i(467),u=i(136),p=i(342);const f=1;function b(e){const t=new p.a,i=e.stippleEnabled&&e.roundCaps,b=e.falloffEnabled||i,m=e.innerColorEnabled,g=e.stippleEnabled&&e.stippleScaleWithLineWidth||e.roundCaps,v=e.stippleEnabled&&e.stippleScaleWithLineWidth;return t.extensions.add("GL_OES_standard_derivatives"),t.include(l.a),t.include(n.a,e),t.include(o.a,{...e,stippleRequiresStretchMeasure:i}),1===e.output&&t.include(a.a,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraNearFar","vec2").add("pixelRatio","float").add("miterLimit","float").add("screenSize","vec2"),t.attributes.add("position","vec3"),t.attributes.add("subdivisionFactor","float"),t.attributes.add("uv0","vec2"),t.attributes.add("auxpos1","vec3"),t.attributes.add("auxpos2","vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("linearDepth","float"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),g&&t.varyings.add("vLineWidth","float"),v&&t.varyings.add("vLineSizeInv","float"),m&&t.varyings.add("vLineDistance","float"),b&&t.varyings.add("vLineDistanceNorm","float"),e.falloffEnabled&&t.fragment.uniforms.add("falloff","float"),e.innerColorEnabled&&(t.fragment.uniforms.add("innerColor","vec4"),t.fragment.uniforms.add("innerWidth","float")),e.roundCaps&&t.varyings.add("vCapPosition","vec2"),i&&t.varyings.add("vStipplePatternStretch","float"),t.vertex.code.add(u.a`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),t.vertex.code.add(u.a`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= screenSize / posNdc.w;
return posNdc;
}`),t.vertex.code.add(u.a`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = cameraNearFar[0] * 0.99;

      //current pos behind ncp --> we need to clip
      if(pos.z > -cameraNearFar[0]) {
        if (!isStartVertex) {
          //previous in front of ncp
          if(prev.z < -cameraNearFar[0]) {
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
        //next in front of ncp
        if(isStartVertex) {
          if(next.z < -cameraNearFar[0]) {
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        //previous behind ncp
        if (prev.z > -cameraNearFar[0]) {
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        //next behind ncp
        if (next.z > -cameraNearFar[0]) {
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${e.multipassTerrainEnabled?"depth = pos.z;":""}
      linearDepth = (-pos.z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
`),t.vertex.code.add(u.a`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;
    vpos = position;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${g?u.a`vLineWidth = lineWidth;`:""}
      ${v?u.a`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);

      clipAndTransform(pos, prev, next, isStartVertex);

      vec2 left = (pos.xy - prev.xy);
      vec2 right = (next.xy - pos.xy);

      float leftLen = length(left);
      float rightLen = length(right);
  `),e.stippleEnabled&&t.vertex.code.add(u.a`float isEndVertex = float(!isStartVertex);
vec4 segmentInfo = mix(vec4(pos.xy, right), vec4(prev.xy, left), isEndVertex);
vec2 segmentOrigin = segmentInfo.xy;
vec2 segment = segmentInfo.zw;`),t.vertex.code.add(u.a`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),e.roundJoins?t.vertex.code.add(u.a`
        vec2 startDir;
        vec2 endDir;

        if (leftLen < 0.001) {
          startDir = right;
        }
        else{
          startDir = left;
        }
        startDir = normalize(startDir);
        startDir = PERPENDICULAR(startDir);

        if (rightLen < 0.001) {
          endDir = left;
        }
        else{
          endDir = right;
        }
        endDir = normalize(endDir);
        endDir = PERPENDICULAR(endDir);

        float factor = ${e.stippleEnabled?u.a`min(1.0, subdivisionFactor * ${u.a.float((f+2)/(f+1))})`:u.a`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):t.vertex.code.add(u.a`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = normalize(joinDisplacementDir);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`),t.vertex.code.add(u.a`displacementLen = lineWidth;
}
} else {
if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = isStartVertex ? right : left;
}
joinDisplacementDir = normalize(joinDisplacementDir);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
displacementLen = lineWidth;
capDisplacementDir = isStartVertex ? -right : left;
capDisplacementDir *= subdivisionFactor;
}`),t.vertex.code.add(u.a`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${b||m?u.a`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${m?u.a`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${b?u.a`vLineDistanceNorm = lineDistNorm;`:""}

    ${e.roundCaps?u.a`vCapPosition = isJoin ? vec2(0.0) : dpos;`:""}

    pos.xy += dpos;
  `),e.stippleEnabled&&(e.draped||t.vertex.code.add(u.a`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),t.vertex.code.add(u.a`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));`),e.draped?t.vertex.code.add(u.a`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):t.vertex.code.add(u.a`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),t.vertex.code.add(u.a`
      float patternLength = ${e.stippleScaleWithLineWidth?"lineSize * ":""} stipplePatternPixelSize;

      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader
      // The 0.5 factor on the screen length is to correct for pixel ratio (it is calculated at double resolution)
      ${i?u.a`
            vec3 stippleSegmentInfo = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);
            vStippleDistanceLimits = stippleSegmentInfo.xy;
            vStipplePatternStretch = stippleSegmentInfo.z;`:u.a`
            vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);`}

      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);

      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)
      if (segmentLengthScreenDouble >= 0.001) {
        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the
        // original vertex positions, and slightly outside of that range at the displaced positions
        vec2 stippleDisplacement = pos.xy - segmentOrigin;
        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);

        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)
        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
      }

      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance
      vStippleDistanceLimits *= pos.w;
      vStippleDistance *= pos.w;
    `)),t.vertex.code.add(u.a`pos.xy = pos.xy / screenSize * pos.w;
vColor = getColor();
vColor.a *= coverage;
gl_Position = pos;
}
}`),e.multipassTerrainEnabled&&(t.fragment.include(s.a),t.include(c.b,e)),t.include(r.a,e),t.fragment.uniforms.add("intrinsicColor","vec4"),t.fragment.include(h.a),t.fragment.code.add(u.a`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
  `),e.roundCaps&&t.fragment.code.add(u.a`
    float fragmentRadius = length(vCapPosition);
    float fragmentSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
    float capCoverage = clamp(0.5 - fragmentSDF, 0.0, 1.0);
    if (capCoverage < ${u.a.float(d.c)}) {
      discard;
    }
  `),i?t.fragment.code.add(u.a`
      vec2 stipplePosition = vec2(
        max(1.0 - getStippleSDF() * 2.0 * vStipplePatternStretch, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${u.a.float(d.c)}, stippleCoverage);
    `):t.fragment.code.add(u.a`float stippleAlpha = getStippleAlpha();`),t.fragment.code.add(u.a`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);
vec4 color = intrinsicColor * vColor;`),t.fragment.uniforms.add("pixelRatio","float"),e.innerColorEnabled&&t.fragment.code.add(u.a`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`),t.fragment.code.add(u.a`vec4 finalColor = blendStipple(color, stippleAlpha);`),e.falloffEnabled&&t.fragment.code.add(u.a`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`),t.fragment.code.add(u.a`
    if (finalColor.a < ${u.a.float(d.c)}) {
      discard;
    }

    ${7===e.output?u.a`gl_FragColor = vec4(finalColor.a);`:""}
    ${0===e.output?u.a`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${0===e.output&&e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${4===e.output?u.a`gl_FragColor = vec4(1.0);`:""}
    ${1===e.output?u.a`outputDepth(linearDepth);`:""}
  }
  `),t}const m=Object.freeze({__proto__:null,NUM_ROUND_JOIN_SUBDIVISIONS:f,build:b})},813:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return l})),i.d(t,"d",(function(){return h})),i.d(t,"e",(function(){return u})),i.d(t,"f",(function(){return d})),i.d(t,"g",(function(){return p}));var r=i(87),n=i(590),a=i(126);const s=r.a.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function o(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}async function c(e,t,i){const r=e&&e.expression;if("string"!=typeof r)return null;const n=b(r);if(null!=n)return{cachedResult:n};const s=await Object(a.e)(),o=s.arcadeUtils,c=o.createSyntaxTree(r);return o.dependsOnView(c)?(null!=i&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:o.createFunction(c),context:o.createExecContext(null,{sr:t}),modules:s}}}function l(e,t,i){return e.arcadeUtils.createFeature(t.attributes,t.geometry,i)}function d(e,t){if(null!=e&&!f(e)){if(!t||!e.arcade)return void s.errorOncePerTick("Arcade support required but not provided");const i=t;i._geometry&&(i._geometry=Object(n.b)(i._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function h(e){if(null!=e){if(f(e))return e.cachedResult;const t=e.arcade;let i=e.arcade.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof i&&(e.cachedResult=0,i=0),i}return 0}function u(e,t=!1){let i=e&&e.featureExpressionInfo;const r=i&&i.expression;return t||"0"===r||(i=null),i}const p={cachedResult:0};function f(e){return null!=e.cachedResult}function b(e){return"0"===e?0:null}},815:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return a}));var r=i(401),n=i(136);function a(e){e.include(r.a),e.uniforms.add("geometryDepthTexture","sampler2D"),e.uniforms.add("cameraNearFar","vec2"),e.code.add(n.a`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, cameraNearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}function s(e,t){t.multipassGeometryEnabled&&t.geometryLinearDepthTexture&&e.bindTexture(t.geometryLinearDepthTexture,"geometryDepthTexture")}},816:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r=i(79),n=i(99),a=i(81),s=(i(84),i(82),i(83),i(80));let o=class extends n.a{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1}};Object(r.a)([Object(a.b)()],o.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),Object(r.a)([Object(a.b)()],o.prototype,"SCENEVIEW_LOCKING_LOG",void 0),Object(r.a)([Object(a.b)()],o.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),Object(r.a)([Object(a.b)()],o.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),Object(r.a)([Object(a.b)()],o.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),Object(r.a)([Object(a.b)()],o.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),Object(r.a)([Object(a.b)()],o.prototype,"DECONFLICTOR_SHOW_GRID",void 0),Object(r.a)([Object(a.b)()],o.prototype,"LABELS_SHOW_BORDER",void 0),Object(r.a)([Object(a.b)()],o.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),Object(r.a)([Object(a.b)()],o.prototype,"OVERLAY_SHOW_CENTER",void 0),Object(r.a)([Object(a.b)()],o.prototype,"SHOW_POI",void 0),Object(r.a)([Object(a.b)()],o.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),Object(r.a)([Object(a.b)()],o.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),Object(r.a)([Object(a.b)()],o.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),Object(r.a)([Object(a.b)()],o.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),Object(r.a)([Object(a.b)()],o.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),Object(r.a)([Object(a.b)()],o.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),Object(r.a)([Object(a.b)()],o.prototype,"I3S_TREE_SHOW_TILES",void 0),Object(r.a)([Object(a.b)()],o.prototype,"I3S_SHOW_MODIFICATIONS",void 0),Object(r.a)([Object(a.b)()],o.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),Object(r.a)([Object(a.b)()],o.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),Object(r.a)([Object(a.b)()],o.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),o=Object(r.a)([Object(s.a)("esri.views.3d.support.DebugFlags")],o);const c=new o},817:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return a}));var r=i(681);function n(e,t,i){const r=e.typedBuffer,n=e.typedBufferStride,a=t.typedBuffer,s=t.typedBufferStride,o=i?i.count:t.count;let c=(i&&i.dstIndex?i.dstIndex:0)*n,l=(i&&i.srcIndex?i.srcIndex:0)*s;for(let d=0;d<o;++d)r[c]=a[l],r[c+1]=a[l+1],c+=n,l+=s}function a(e,t,i){const a=e.typedBuffer,s=e.typedBufferStride,o=t.typedBuffer,c=t.typedBufferStride,l=i?i.count:t.count;let d=(i&&i.dstIndex?i.dstIndex:0)*s,h=(i&&i.srcIndex?i.srcIndex:0)*c;if(Object(r.b)(t.elementType)){const e=Object(r.d)(t.elementType);if(Object(r.c)(t.elementType))for(let t=0;t<l;++t)a[d]=Math.max(o[h]/e,-1),a[d+1]=Math.max(o[h+1]/e,-1),d+=s,h+=c;else for(let t=0;t<l;++t)a[d]=o[h]/e,a[d+1]=o[h+1]/e,d+=s,h+=c}else n(e,t,i);return e}function s(e,t,i,r){var n,a;const s=e.typedBuffer,o=e.typedBufferStride,c=null!=(n=null==r?void 0:r.count)?n:e.count;let l=(null!=(a=null==r?void 0:r.dstIndex)?a:0)*o;for(let d=0;d<c;++d)s[l]=t,s[l+1]=i,l+=o}Object.freeze({__proto__:null,copy:n,normalizeIntegerBuffer:a,fill:s})},818:function(e,t,i){"use strict";function r(e,t,i){const r=e.typedBuffer,n=e.typedBufferStride,a=t.typedBuffer,s=t.typedBufferStride,o=i?i.count:t.count;let c=(i&&i.dstIndex?i.dstIndex:0)*n,l=(i&&i.srcIndex?i.srcIndex:0)*s;for(let d=0;d<o;++d)r[c]=a[l],r[c+1]=a[l+1],r[c+2]=a[l+2],r[c+3]=a[l+3],c+=n,l+=s}function n(e,t,i,r,n,a){var s,o;const c=e.typedBuffer,l=e.typedBufferStride,d=null!=(s=null==a?void 0:a.count)?s:e.count;let h=(null!=(o=null==a?void 0:a.dstIndex)?o:0)*l;for(let u=0;u<d;++u)c[h]=t,c[h+1]=i,c[h+2]=r,c[h+3]=n,h+=l}i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return n}));Object.freeze({__proto__:null,copy:r,fill:n})},850:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(113);function n(e,t,i){var n;const l=e.byteLength/(4*t),d=new Uint32Array(e,0,l*t);let h=new Uint32Array(l);const u=null!=(n=null==i?void 0:i.minReduction)?n:0,p=(null==i?void 0:i.originalIndices)||null,f=p?p.length:0,b=(null==i?void 0:i.componentOffsets)||null;let m=0;if(b)for(let r=0;r<b.length-1;r++){const e=b[r+1]-b[r];e>m&&(m=e)}else m=l;const g=Math.floor(1.1*m)+1;(null==c||c.length<2*g)&&(c=new Uint32Array(Object(r.l)(2*g)));for(let r=0;r<2*g;r++)c[r]=0;let v=0;const y=!!b&&!!p,O=y?f:l,x=y?new Uint32Array(f):null,j=1.96;let _=0!==u?Math.ceil(4*j*j/(u*u)*u*(1-u)):O,S=1,w=b?b[1]:O;for(let r=0;r<O;r++){if(r===_){const e=1-v/r;if(e+j*Math.sqrt(e*(1-e)/r)<u)return null;_*=2}if(r===w){for(let e=0;e<2*g;e++)c[e]=0;if(p)for(let e=b[S-1];e<b[S];e++)x[e]=h[p[e]];w=b[++S]}const e=y?p[r]:r,i=e*t,n=o(d,i,t);let s=n%g,l=v;for(;0!==c[2*s+1];){if(c[2*s]===n){const e=c[2*s+1]-1;if(a(d,i,e*t,t)){l=h[e];break}}s++,s>=g&&(s-=g)}l===v&&(c[2*s]=n,c[2*s+1]=e+1,v++),h[e]=l}if(0!==u&&1-v/l<u)return null;if(y){for(let e=b[S-1];e<x.length;e++)x[e]=h[p[e]];h=x}const C=new Uint32Array(t*v);v=0;for(let r=0;r<O;r++)h[r]===v&&(s(d,(y?p[r]:r)*t,C,v*t,t),v++);if(p&&!y){const e=new Uint32Array(f);for(let t=0;t<e.length;t++)e[t]=h[p[t]];h=e}return{buffer:C.buffer,indices:h,uniqueCount:v}}function a(e,t,i,r){for(let n=0;n<r;n++)if(e[t+n]!==e[i+n])return!1;return!0}function s(e,t,i,r,n){for(let a=0;a<n;a++)i[r+a]=e[t+a]}function o(e,t,i){let r=0;for(let n=0;n<i;n++)r=e[t+n]+r|0,r=r+(r<<11)+(r>>>2)|0;return r>>>0}let c=null},859:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(633),n=i(136);function a(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?function(e,t){const i=!(t.draped&&t.stipplePreferContinuous);e.fragment.include(r.a),e.vertex.uniforms.add("stipplePatternPixelSize","float"),e.vertex.uniforms.add("pixelRatio","float"),t.draped?e.vertex.uniforms.add("worldToScreenRatio","float"):(e.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),e.vertex.uniforms.add("camPos","vec3"),e.vertex.code.add(n.a`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - camPos);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),t.stippleRequiresClamp&&e.varyings.add("vStippleDistanceLimits","vec2"),e.vertex.code.add(n.a`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${s};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),e.vertex.code.add(n.a`
  ${t.stippleRequiresStretchMeasure?n.a`vec3`:n.a`vec2`} computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {
  `),i&&e.vertex.code.add(n.a`
      if (segmentLengthPseudoScreen >= patternLength) {

        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        ${t.stippleRequiresStretchMeasure?n.a`return vec3(0.0, segmentLengthScreenRounded, repetitions / flooredRepetitions);`:n.a`return vec2(0.0, segmentLengthScreenRounded);`}
      }
    `),e.vertex.code.add(n.a`
      ${t.stippleRequiresStretchMeasure?n.a`return vec3(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen, 1.0)`:n.a`return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen)`};
    }
  `),e.fragment.uniforms.add("stipplePatternTexture","sampler2D"),e.fragment.uniforms.add("stipplePatternSDFNormalizer","float"),e.fragment.uniforms.add("stipplePatternTextureSize","float"),e.fragment.uniforms.add("stipplePatternPixelSizeInv","float"),t.stippleOffColorEnabled&&e.fragment.uniforms.add("stippleOffColor","vec4"),e.fragment.code.add(n.a`float padTexture(float u) {
return (u * stipplePatternTextureSize + 1.0)/(stipplePatternTextureSize + 2.0);
}`),e.fragment.code.add(n.a`
    float getStippleSDF(out bool isClamped) {
      ${t.stippleRequiresClamp?n.a`
          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;`:n.a`
          float stippleDistanceClamped = vStippleDistance;
          isClamped = false;`}

      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;
      ${t.stippleScaleWithLineWidth?n.a`u *= vLineSizeInv;`:""}
      u = padTexture(fract(u));

      float encodedSDF = rgba2float(texture2D(stipplePatternTexture, vec2(u, 0.5)));
      return (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;
    }

    float getStippleSDF() {
      bool ignored;
      return getStippleSDF(ignored);
    }

    float getStippleAlpha() {
      bool isClamped;
      float stippleSDF = getStippleSDF(isClamped);

      float antiAliasedResult = ${t.stippleScaleWithLineWidth?n.a`clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);`:n.a`clamp(stippleSDF + 0.5, 0.0, 1.0);`}

      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
    }
  `),t.stippleOffColorEnabled?e.fragment.code.add(n.a`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`):e.fragment.code.add(n.a`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}(e,t):function(e){e.fragment.code.add(n.a`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}(e)}const s=n.a.float(.4)},861:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(136);function n(e){e.vertex.code.add(r.a`vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
vec3 camToVert = posWorld - camPosWorld;
bool isBackface = dot(camToVert, normalWorld) > 0.0;
if (isBackface) {
posClip.z += 0.0000003 * posClip.w;
}
return posClip;
}`)}},862:function(e,t,i){"use strict";i.d(t,"a",(function(){return p}));var r=i(306),n=i(441),a=i(720),s=i(714),o=i(877),c=i(634),l=i(402),d=i(623),h=i(406),u=i(136);function p(e,t){const i=e.vertex.code,p=e.fragment.code;1!==t.output&&3!==t.output||(e.include(n.a,{linearDepth:!0}),e.include(s.a,t),e.include(d.a,t),e.include(c.a,t),e.include(r.a,t),e.vertex.uniforms.add("cameraNearFar","vec2"),e.varyings.add("depth","float"),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),i.add(u.a`void main(void) {
vpos = calculateVPos();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPositionWithDepth(proj, view, vpos, cameraNearFar, depth);
forwardTextureCoordinates();
}`),e.include(h.a,t),p.add(u.a`
      void main(void) {
        discardBySlice(vpos);
        ${t.hasColorTexture?u.a`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputDepth(depth);
      }
    `)),2===t.output&&(e.include(n.a,{linearDepth:!1}),e.include(a.a,t),e.include(o.a,t),e.include(s.a,t),e.include(d.a,t),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),e.vertex.uniforms.add("viewNormal","mat4"),e.varyings.add("vPositionView","vec3"),i.add(u.a`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        ${0===t.normalType?u.a`
        vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));`:""}
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, vpos);
        forwardTextureCoordinates();
      }
    `),e.include(r.a,t),e.include(h.a,t),p.add(u.a`
      void main() {
        discardBySlice(vpos);
        ${t.hasColorTexture?u.a`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}

        ${3===t.normalType?u.a`
            vec3 normal = screenDerivativeNormal(vPositionView);`:u.a`
            vec3 normal = normalize(vNormalWorld);
            if (gl_FrontFacing == false) normal = -normal;`}
        gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
      }
    `)),4===t.output&&(e.include(n.a,{linearDepth:!1}),e.include(s.a,t),e.include(d.a,t),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),i.add(u.a`void main(void) {
vpos = calculateVPos();
vpos = subtractOrigin(vpos);
vpos = addVerticalOffset(vpos, localOrigin);
gl_Position = transformPosition(proj, view, vpos);
forwardTextureCoordinates();
}`),e.include(r.a,t),e.include(h.a,t),e.include(l.a),p.add(u.a`
      void main() {
        discardBySlice(vpos);
        ${t.hasColorTexture?u.a`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputHighlight();
      }
    `))}},863:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(467),n=i(136);function a(e){e.include(r.a),e.code.add(n.a`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${n.a.int(1)}) {
        return allMixed;
      }
      else if (mode == ${n.a.int(2)}) {
        return internalMixed;
      }
      else if (mode == ${n.a.int(3)}) {
        return externalColor;
      }
      else {
        // tint (or something invalid)
        float vIn = rgb2v(internalMixed);
        vec3 hsvTint = rgb2hsv(externalColor);
        vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
        return hsv2rgb(hsvOut);
      }
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${n.a.int(2)}) {
        return internalMixed;
      }
      else if (mode == ${n.a.int(3)}) {
        return externalOpacity;
      }
      else {
        // multiply or tint (or something invalid)
        return allMixed;
      }
    }
  `)}},864:function(e,t,i){"use strict";function r(e,t){const i=e.count;t||(t=new e.TypedArrayConstructor(i));for(let r=0;r<i;r++)t[r]=e.get(r);return t}i.d(t,"a",(function(){return r}));Object.freeze({__proto__:null,copy:function(e,t,i){const r=e.typedBuffer,n=e.typedBufferStride,a=t.typedBuffer,s=t.typedBufferStride,o=i?i.count:t.count;let c=(i&&i.dstIndex?i.dstIndex:0)*n,l=(i&&i.srcIndex?i.srcIndex:0)*s;for(let d=0;d<o;++d)r[c]=a[l],c+=n,l+=s},makeDense:r})},876:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(136);function n(e){e.vertex.code.add(r.a`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${r.a.int(1)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${r.a.int(3)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${r.a.int(4)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${r.a.int(1)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}function a(e,t){t.symbolColor?(e.include(n),e.attributes.add("symbolColor","vec4"),e.varyings.add("colorMixMode","mediump float")):e.fragment.uniforms.add("colorMixMode","int"),t.symbolColor?e.vertex.code.add(r.a`int symbolColorMixMode;
vec4 getSymbolColor() {
return decodeSymbolColor(symbolColor, symbolColorMixMode) * 0.003921568627451;
}
void forwardColorMixMode() {
colorMixMode = float(symbolColorMixMode) + 0.5;
}`):e.vertex.code.add(r.a`vec4 getSymbolColor() { return vec4(1.0); }
void forwardColorMixMode() {}`)}},877:function(e,t,i){"use strict";i.d(t,"a",(function(){return h}));var r=i(720),n=i(331),a=i(199),s=i(106),o=i(746),c=i(783),l=i(136);function d(e,t){e.include(o.a),e.vertex.include(c.a,t),e.varyings.add("vPositionWorldCameraRelative","vec3"),e.varyings.add("vPosition_view","vec3"),e.vertex.uniforms.add("uTransform_WorldFromModel_RS","mat3"),e.vertex.uniforms.add("uTransform_WorldFromModel_TH","vec3"),e.vertex.uniforms.add("uTransform_WorldFromModel_TL","vec3"),e.vertex.uniforms.add("uTransform_WorldFromView_TH","vec3"),e.vertex.uniforms.add("uTransform_WorldFromView_TL","vec3"),e.vertex.uniforms.add("uTransform_ViewFromCameraRelative_RS","mat3"),e.vertex.uniforms.add("uTransform_ProjFromView","mat4"),e.vertex.code.add(l.a`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = uTransform_WorldFromModel_RS * positionModel();
vec3 transform_CameraRelativeFromModel = dpAdd(
uTransform_WorldFromModel_TL,
uTransform_WorldFromModel_TH,
-uTransform_WorldFromView_TL,
-uTransform_WorldFromView_TH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 position_view() {
return uTransform_ViewFromCameraRelative_RS * positionWorldCameraRelative();
}
void forwardPosition() {
vPositionWorldCameraRelative = positionWorldCameraRelative();
vPosition_view = position_view();
gl_Position = uTransform_ProjFromView * vec4(vPosition_view, 1.0);
}
vec3 positionWorld() {
return uTransform_WorldFromView_TL + vPositionWorldCameraRelative;
}`),e.fragment.uniforms.add("uTransform_WorldFromView_TL","vec3"),e.fragment.code.add(l.a`vec3 positionWorld() {
return uTransform_WorldFromView_TL + vPositionWorldCameraRelative;
}`)}function h(e,t){0===t.normalType||1===t.normalType?(e.include(r.a,t),e.varyings.add("vNormalWorld","vec3"),e.varyings.add("vNormalView","vec3"),e.vertex.uniforms.add("uTransformNormal_GlobalFromModel","mat3"),e.vertex.uniforms.add("uTransformNormal_ViewFromGlobal","mat3"),e.vertex.code.add(l.a`void forwardNormal() {
vNormalWorld = uTransformNormal_GlobalFromModel * normalModel();
vNormalView = uTransformNormal_ViewFromGlobal * vNormalWorld;
}`)):2===t.normalType?(e.include(d,t),e.varyings.add("vNormalWorld","vec3"),e.vertex.code.add(l.a`
    void forwardNormal() {
      vNormalWorld = ${1===t.viewingMode?l.a`normalize(vPositionWorldCameraRelative);`:l.a`vec3(0.0, 0.0, 1.0);`}
    }
    `)):e.vertex.code.add(l.a`void forwardNormal() {}`)}!function(e){e.ModelTransform=class{constructor(){this.worldFromModel_RS=Object(n.b)(),this.worldFromModel_TH=Object(s.f)(),this.worldFromModel_TL=Object(s.f)()}};e.ViewProjectionTransform=class{constructor(){this.worldFromView_TH=Object(s.f)(),this.worldFromView_TL=Object(s.f)(),this.viewFromCameraRelative_RS=Object(n.b)(),this.projFromView=Object(a.d)()}},e.bindModelTransform=function(e,t){e.setUniformMatrix3fv("uTransform_WorldFromModel_RS",t.worldFromModel_RS),e.setUniform3fv("uTransform_WorldFromModel_TH",t.worldFromModel_TH),e.setUniform3fv("uTransform_WorldFromModel_TL",t.worldFromModel_TL)},e.bindViewProjTransform=function(e,t){e.setUniform3fv("uTransform_WorldFromView_TH",t.worldFromView_TH),e.setUniform3fv("uTransform_WorldFromView_TL",t.worldFromView_TL),e.setUniformMatrix4fv("uTransform_ProjFromView",t.projFromView),e.setUniformMatrix3fv("uTransform_ViewFromCameraRelative_RS",t.viewFromCameraRelative_RS)}}(d||(d={})),(h||(h={})).bindUniforms=function(e,t){e.setUniformMatrix4fv("viewNormal",t)}},882:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return n})),i.d(t,"c",(function(){return a})),i.d(t,"d",(function(){return s})),i.d(t,"e",(function(){return l})),i.d(t,"f",(function(){return c}));i(82);var r=i(113);function n(e,t,i,r){r.premultipliedAlpha&&function(e){const t=e.data,i=t.length;for(let r=0;r<i;r+=4){const e=t[r+3];if(e>0){const i=e/255;t[r+0]=t[r+0]/i,t[r+1]=t[r+1]/i,t[r+2]=t[r+2]/i}}}(e),i.width=e.width,i.height=e.height;const n=i.getContext("2d");n.putImageData(e,0,0),r.flipY&&function(e){e.save(),e.globalCompositeOperation="copy",e.scale(1,-1),e.translate(0,-e.canvas.height),e.drawImage(e.canvas,0,0),e.restore()}(n);const a=n.getImageData(0,0,e.width,e.height),s=function(e,t){const i=f[t.format],r=t.quality/100;return e.toDataURL(i,r)}(i,t);return i.width=0,i.height=0,{dataUrl:s,data:a}}function a(e,t){const i=p(e),n=m[i];return{format:i,quality:Object(r.e)(null!=t?t:n,0,100)}}function s(e,t){return t/Math.max(e[0],e[1])}function o(e,t,i){if(!e||!t)throw new Error("Cannot construct image data without dimensions");if(u)try{return new ImageData(e,t)}catch(r){u=!1}return d(e,t,i)}function c(e,t,i,r){if(!t||!i)throw new Error("Cannot construct image data without dimensions");if(u)try{return new ImageData(e,t,i)}catch(a){u=!1}const n=d(t,i,r);return n.data.set(e,0),n}function l(e,t,i,r=0,n=0,a=e.width-r,s=e.height-n,o=!1){const{data:c}=e,{width:l,height:d,data:h}=t,u=a/l,p=s/d,f=Math.ceil(u/2),b=Math.ceil(p/2),m=e.width;for(let g=0;g<d;g++)for(let e=0;e<l;e++){const t=4*(e+(o?d-g-1:g)*l);let a=0,s=0,v=0,y=0,O=0,x=0;const j=(g+.5)*p;for(let o=Math.floor(g*p);o<(g+1)*p;o++){const t=Math.abs(j-(o+.5))/b,l=(e+.5)*u,d=t*t;for(let h=Math.floor(e*u);h<(e+1)*u;h++){const e=Math.abs(l-(h+.5))/f,t=Math.sqrt(d+e*e);if(t>=1)continue;let u=2*t*t*t-3*t*t+1;const p=4*(r+h+(n+o)*m);x+=u*c[p+3],s+=u,!i&&c[p+3]<255&&(u=u*c[p+3]/255),v+=u*c[p],y+=u*c[p+1],O+=u*c[p+2],a+=u}}h[t]=v/a,h[t+1]=y/a,h[t+2]=O/a,h[t+3]=x/s}return t}function d(e,t,i){return i||(h||(h=document.createElement("canvas"),h.width=1,h.height=1),i=h),i.getContext("2d").createImageData(e,t)}let h=null,u=!0;function p(e){switch(e){case"png":case"jpg":case"jpeg":return e;default:return b}}const f={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},b="png",m={png:100,jpg:98,jpeg:98}},898:function(e,t,i){"use strict";i.d(t,"a",(function(){return m}));var r,n=i(79),a=(i(82),i(86)),s=i(81),o=(i(84),i(83)),c=i(93),l=i(80),d=i(92),h=i(160),u=i(882);const p=new WeakMap;let f=0,b=r=class extends a.a{constructor(e){super(e),this.wrap="repeat"}get url(){return this._get("url")||null}set url(e){this._set("url",e),e&&this._set("data",null)}get data(){return this._get("data")||null}set data(e){this._set("data",e),e&&this._set("url",null)}writeData(e,t,i,r){if(e instanceof HTMLImageElement){const n={type:"image-element",src:Object(h.e)(e.src,r),crossOrigin:e.crossOrigin};t[i]=n}else if(e instanceof HTMLCanvasElement){const r=e.getContext("2d").getImageData(0,0,e.width,e.height),n={type:"canvas-element",imageData:this.encodeImageData(r)};t[i]=n}else if(e instanceof HTMLVideoElement){const n={type:"video-element",src:Object(h.e)(e.src,r),autoplay:e.autoplay,loop:e.loop,muted:e.muted,crossOrigin:e.crossOrigin,preload:e.preload};t[i]=n}else{const r={type:"image-data",imageData:this.encodeImageData(e)};t[i]=r}}readData(e){switch(e.type){case"image-element":{const t=new Image;return t.src=e.src,t.crossOrigin=e.crossOrigin,t}case"canvas-element":{const t=this.decodeImageData(e.imageData),i=document.createElement("canvas");return i.width=t.width,i.height=t.height,i.getContext("2d").putImageData(t,0,0),i}case"image-data":return this.decodeImageData(e.imageData);case"video-element":{const t=document.createElement("video");return t.src=e.src,t.crossOrigin=e.crossOrigin,t.autoplay=e.autoplay,t.loop=e.loop,t.muted=e.muted,t.preload=e.preload,t}default:return}}get transparent(){const e=this.data,t=this.url;if(e instanceof HTMLCanvasElement)return this.imageDataContainsTransparent(e.getContext("2d").getImageData(0,0,e.width,e.height));if(e instanceof ImageData)return this.imageDataContainsTransparent(e);if(t){const e=t.substr(t.length-4,4).toLowerCase(),i=t.substr(0,15).toLocaleLowerCase();if(".png"===e||"data:image/png;"===i)return!0}return!1}set transparent(e){null!=e?this._override("transparent",e):this._clearOverride("transparent")}get contentHash(){const e="string"==typeof this.wrap?this.wrap:"object"==typeof this.wrap?`${this.wrap.horizontal}/${this.wrap.vertical}`:"",t=(t="")=>`d:${t},t:${this.transparent},w:${e}`;return null!=this.url?t(this.url):null!=this.data?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?t(this.data.src):(p.has(this.data)||p.set(this.data,++f),t(p.get(this.data))):t()}clone(){const e={url:this.url,data:this.data,wrap:this.cloneWrap()};return new r(e)}cloneWithDeduplication(e){const t=e.get(this);if(t)return t;const i=this.clone();return e.set(this,i),i}cloneWrap(){return"string"==typeof this.wrap?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}}encodeImageData(e){let t="";for(let i=0;i<e.data.length;i++)t+=String.fromCharCode(e.data[i]);return{data:btoa(t),width:e.width,height:e.height}}decodeImageData(e){const t=atob(e.data),i=new Uint8ClampedArray(t.length);for(let r=0;r<t.length;r++)i[r]=t.charCodeAt(r);return Object(u.f)(i,e.width,e.height)}imageDataContainsTransparent(e){for(let t=3;t<e.data.length;t+=4)if(255!==e.data[t])return!0;return!1}static from(e){return"string"==typeof e?new r({url:e}):e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof ImageData||e instanceof HTMLVideoElement?new r({data:e}):Object(o.d)(r,e)}};Object(n.a)([Object(s.b)({type:String,json:{write:h.f}})],b.prototype,"url",null),Object(n.a)([Object(s.b)({json:{write:{overridePolicy(){return{enabled:!this.url}}}}}),Object(s.b)()],b.prototype,"data",null),Object(n.a)([Object(d.a)("data")],b.prototype,"writeData",null),Object(n.a)([Object(c.a)("data")],b.prototype,"readData",null),Object(n.a)([Object(s.b)({type:Boolean,json:{write:{overridePolicy(){return{enabled:this._isOverridden("transparent")}}}}})],b.prototype,"transparent",null),Object(n.a)([Object(s.b)({json:{write:!0}})],b.prototype,"wrap",void 0),Object(n.a)([Object(s.b)({readOnly:!0})],b.prototype,"contentHash",null),b=r=Object(n.a)([Object(l.a)("esri.geometry.support.MeshTexture")],b);const m=b},899:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r,n=i(79),a=i(103),s=i(85),o=i(81),c=(i(84),i(82),i(83),i(80)),l=i(956),d=i(898);let h=r=class extends l.a{constructor(e){super(e),this.emissiveColor=null,this.emissiveTexture=null,this.occlusionTexture=null,this.metallic=1,this.roughness=1,this.metallicRoughnessTexture=null}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(e,t){const i=Object(s.l)(e)?e.get(this):null;if(i)return i;const n=new r(this.clonePropertiesWithDeduplication(t));return Object(s.l)(e)&&e.set(this,n),n}clonePropertiesWithDeduplication(e){return{...super.clonePropertiesWithDeduplication(e),emissiveColor:Object(s.l)(this.emissiveColor)?this.emissiveColor.clone():null,emissiveTexture:Object(s.l)(this.emissiveTexture)?this.emissiveTexture.cloneWithDeduplication(e):null,occlusionTexture:Object(s.l)(this.occlusionTexture)?this.occlusionTexture.cloneWithDeduplication(e):null,metallic:this.metallic,roughness:this.roughness,metallicRoughnessTexture:Object(s.l)(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.cloneWithDeduplication(e):null}}};Object(n.a)([Object(o.b)({type:a.a,json:{write:!0}})],h.prototype,"emissiveColor",void 0),Object(n.a)([Object(o.b)({type:d.a,json:{write:!0}})],h.prototype,"emissiveTexture",void 0),Object(n.a)([Object(o.b)({type:d.a,json:{write:!0}})],h.prototype,"occlusionTexture",void 0),Object(n.a)([Object(o.b)({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],h.prototype,"metallic",void 0),Object(n.a)([Object(o.b)({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],h.prototype,"roughness",void 0),Object(n.a)([Object(o.b)({type:d.a,json:{write:!0}})],h.prototype,"metallicRoughnessTexture",void 0),h=r=Object(n.a)([Object(c.a)("esri.geometry.support.MeshMaterialMetallicRoughness")],h);const u=h},900:function(e,t,i){"use strict";i.d(t,"a",(function(){return u})),i.d(t,"b",(function(){return f})),i.d(t,"c",(function(){return m}));var r,n=i(79),a=i(86),s=i(89),o=i(87),c=i(81),l=i(104),d=i(80);const h=o.a.getLogger("esri.geometry.support.MeshVertexAttributes");let u=r=class extends a.a{constructor(e){super(e),this.color=null,this.position=new Float64Array(0),this.uv=null,this.normal=null,this.tangent=null}castColor(e){return f(e,Uint8Array,[Uint8ClampedArray],{loggerTag:".color=",stride:4},h)}castPosition(e){return e&&e instanceof Float32Array&&h.warn(".position=","Setting position attribute from a Float32Array may cause precision problems. Consider storing data in a Float64Array or a regular number array"),f(e,Float64Array,[Float32Array],{loggerTag:".position=",stride:3},h)}castUv(e){return f(e,Float32Array,[Float64Array],{loggerTag:".uv=",stride:2},h)}castNormal(e){return f(e,Float32Array,[Float64Array],{loggerTag:".normal=",stride:3},h)}castTangent(e){return f(e,Float32Array,[Float64Array],{loggerTag:".tangent=",stride:4},h)}clone(){const e={position:Object(s.a)(this.position),uv:Object(s.a)(this.uv),normal:Object(s.a)(this.normal),tangent:Object(s.a)(this.tangent),color:Object(s.a)(this.color)};return new r(e)}clonePositional(){const e={position:Object(s.a)(this.position),normal:Object(s.a)(this.normal),tangent:Object(s.a)(this.tangent),uv:this.uv,color:this.color};return new r(e)}};function p(e,t,i,r){const{loggerTag:n,stride:a}=t;return e.length%a!=0?(r.error(n,`Invalid array length, expected a multiple of ${a}`),new i([])):e}function f(e,t,i,r,n){if(!e)return e;if(e instanceof t)return p(e,r,t,n);for(const a of i)if(e instanceof a)return p(new t(e),r,t,n);if(Array.isArray(e))return p(new t(e),r,t,n);{const r=i.map((e=>`'${e.name}'`));return n.error(`Failed to set property, expected one of ${r}, but got ${e.constructor.name}`),new t([])}}function b(e,t,i){t[i]=function(e){const t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e[i];return t}(e)}Object(n.a)([Object(c.b)({json:{write:b}})],u.prototype,"color",void 0),Object(n.a)([Object(l.a)("color")],u.prototype,"castColor",null),Object(n.a)([Object(c.b)({nonNullable:!0,json:{write:b}})],u.prototype,"position",void 0),Object(n.a)([Object(l.a)("position")],u.prototype,"castPosition",null),Object(n.a)([Object(c.b)({json:{write:b}})],u.prototype,"uv",void 0),Object(n.a)([Object(l.a)("uv")],u.prototype,"castUv",null),Object(n.a)([Object(c.b)({json:{write:b}})],u.prototype,"normal",void 0),Object(n.a)([Object(l.a)("normal")],u.prototype,"castNormal",null),Object(n.a)([Object(c.b)({json:{write:b}})],u.prototype,"tangent",void 0),Object(n.a)([Object(l.a)("tangent")],u.prototype,"castTangent",null),u=r=Object(n.a)([Object(d.a)("esri.geometry.support.MeshVertexAttributes")],u);const m=u},901:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return s}));var r=i(558),n=i(246),a=i(850);function s(e){const t=o(e.rings,e.hasZ,1),i=[];let n=0,s=0;for(const a of t.polygons){const e=a.count,o=a.index,c=new Float64Array(t.position.buffer,3*o*t.position.BYTES_PER_ELEMENT,3*e),l=a.holeIndices.map((e=>e-o)),d=new Uint32Array(Object(r.a)(c,l,3));i.push({position:c,faces:d}),n+=c.length,s+=d.length}const c=function(e,t,i){if(1===e.length)return e[0];const r=new Float64Array(t),n=new Uint32Array(i);let a=0,s=0,o=0;for(const c of e){for(let e=0;e<c.position.length;e++)r[a++]=c.position[e];for(let e=0;e<c.faces.length;e++)n[s++]=c.faces[e]+o;o=a/3}return{position:r,faces:n}}(i,n,s),l=Object(a.a)(c.position.buffer,6,{originalIndices:c.faces});return c.position=new Float64Array(l.buffer),c.faces=l.indices,c}function o(e,t,i){const r=e.length,n=new Array(r),a=new Array(r),s=new Array(r);let o=0,d=0,h=0,u=0;for(let c=0;c<r;++c)u+=e[c].length;const p=new Float64Array(3*u);let f=0;for(let b=r-1;b>=0;b--){const u=e[b],m=1===i&&l(u);if(m&&1!==r)n[o++]=u;else{let e=u.length;for(let t=0;t<o;++t)e+=n[t].length;const i={index:f,pathLengths:new Array(o+1),count:e,holeIndices:new Array(o)};i.pathLengths[0]=u.length,u.length>0&&(s[h++]={index:f,count:u.length}),f=m?c(u,u.length-1,-1,p,f,u.length,t):c(u,0,1,p,f,u.length,t);for(let r=0;r<o;++r){const e=n[r];i.holeIndices[r]=f,i.pathLengths[r+1]=e.length,e.length>0&&(s[h++]={index:f,count:e.length}),f=c(e,0,1,p,f,e.length,t)}o=0,i.count>0&&(a[d++]=i)}}for(let l=0;l<o;++l){const e=n[l];e.length>0&&(s[h++]={index:f,count:e.length}),f=c(e,0,1,p,f,e.length,t)}return d<r&&(a.length=d),h<r&&(s.length=h),{position:p,polygons:a,outlines:s}}function c(e,t,i,r,n,a,s){n*=3;for(let o=0;o<a;++o){const a=e[t];r[n++]=a[0],r[n++]=a[1],r[n++]=s?a[2]:0,t+=i}return n/3}function l(e){return!Object(n.g)(e,!1,!1)}},906:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(136);function n(e){const t=r.a`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`,i=r.a`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`;e.vertex.code.add(t),e.vertex.code.add(i),e.fragment.code.add(t),e.fragment.code.add(i)}},907:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return s}));var r=i(961),n=i(136);function a(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(r.b),e.fragment.code.add(n.a`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}function s(e,t){e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}},908:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(136);function n(e,t){1===t.viewingMode?e.vertex.code.add(r.a`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(r.a`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),1===t.viewingMode?e.vertex.code.add(r.a`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(r.a`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}},909:function(e,t,i){"use strict";i.d(t,"a",(function(){return p}));var r=i(85),n=i(251),a=i(149),s=i(199),o=i(116),c=i(245),l=i(580),d=i(541),h=i(743),u=i(529);class p{constructor(e,t,i=null,r=null,a=Object(n.a)(),o=null,l=null,d=!1){this.data=e,this.material=t,this.layerUid=i,this.graphicUid=r,this.id=a,this.boundingInfo=o,this.calculateShaderTransformation=l,this.castShadow=d,this.boundingSphere=Object(c.e)(),this.instanceParameters={highlights:null,occludees:null,visible:!0},this._transformation=Object(s.d)(),this._shaderTransformationDirty=!0}get transformation(){return this._transformation}updateTransformation(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(e,t,i=Object(l.c)(e)){Object(r.k)(this.boundingInfo)||(Object(o.q)(t,this.boundingInfo.getCenter(),e),t[3]=this.boundingInfo.getBSRadius()*i)}get hasShaderTransformation(){return Object(r.l)(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return Object(r.k)(this.calculateShaderTransformation)?Object(r.u)(this.transformation,s.a):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=Object(s.d)()),Object(a.d)(this._shaderTransformation,this.calculateShaderTransformation(Object(r.u)(this.transformation,s.a))),this._shaderTransformationDirty=!1),this._shaderTransformation)}computeAttachmentOrigin(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&(Object(r.l)(this._transformation)&&Object(o.q)(e,e,this._transformation),!0);const t=this.indices.get("position"),i=this.vertexAttributes.get("position");return!!Object(d.c)(i,t,e)&&(Object(r.l)(this._transformation)&&Object(o.q)(e,e,this._transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const e=new h.a(0),t=this.instanceParameters;return t.highlights=Object(u.a)(t.highlights,e),e}removeHighlight(e){const t=this.instanceParameters;t.highlights=Object(u.e)(t.highlights,e)}}},910:function(e,t,i){"use strict";i.d(t,"a",(function(){return f})),i.d(t,"b",(function(){return b})),i.d(t,"c",(function(){return g})),i.d(t,"d",(function(){return m}));var r=i(85),n=i(199),a=i(106),s=i(207),o=i(223),c=i(246),l=i(416),d=i(565),h=i(515),u=i(607);const p=Object(a.f)();function f(e,t,i,a,c,l,h,f){const b=i?i.length:0,m=e.clippingExtent;if(Object(s.o)(t,p,e.elevationProvider.spatialReference),Object(r.l)(m)&&!Object(o.e)(m,p))return null;const g=e.renderCoordsHelper.spatialReference;Object(s.o)(t,p,g);const v=e.localOriginFactory.getOrigin(p),y=new u.a({castShadow:!1,metadata:{layerUid:l,graphicUid:h,usesVerticalDistanceToGround:!0}});for(let r=0;r<b;r++){const e=n.a;y.addGeometry(i[r],a[r],e,v,f)}return{object:y,sampledElevation:Object(d.c)(y,t,e.elevationProvider,e.renderCoordsHelper,c)}}function b(e,t,i){const r=e.elevationContext,n=i.spatialReference;Object(s.o)(t,p,n),r.centerPointInElevationSR=Object(l.g)(p[0],p[1],t.hasZ?p[2]:0,n)}function m(e){switch(e.type){case"point":return e;case"polygon":case"extent":return Object(h.a)(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const i=Object(c.f)(t,Object(c.e)(t)/2);return Object(l.g)(i[0],i[1],i[2],e.spatialReference)}case"mesh":return e.origin}return null}function g(e,t,i,r,n){const a=new Float64Array(3*e.length),s=new Float64Array(a.length);e.forEach(((e,t)=>{a[3*t+0]=e[0],a[3*t+1]=e[1],a[3*t+2]=e.length>2?e[2]:0}));const o=Object(d.d)(a,t,0,s,0,a,0,a.length/3,i,r,n),c=null!=o;return{numVertices:e.length,position:a,mapPosition:s,projectionSuccess:c,sampledElevation:o}}},911:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(136);function n(e,t){const i=e.fragment;i.code.add(r.a`struct ShadingNormalParameters {
vec3 normalView;
vec3 viewDirection;
} shadingParams;`),1===t.doubleSidedMode?i.code.add(r.a`vec3 shadingNormal(ShadingNormalParameters params) {
return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
}`):2===t.doubleSidedMode?i.code.add(r.a`vec3 shadingNormal(ShadingNormalParameters params) {
return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
}`):i.code.add(r.a`vec3 shadingNormal(ShadingNormalParameters params) {
return normalize(params.normalView);
}`)}},942:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));i(82);var r=i(88),n=i(85),a=i(286);function s(e){return Object(n.k)(e)||"simple"===e.type||"unique-value"===e.type||"class-breaks"===e.type||"dictionary"===e.type}function o(e){if(Object(n.k)(e))return null;if(!s(e))return new r.a("renderer-conversion-3d:unsupported-renderer",`Unsupported renderer of type '${e.type||e.declaredClass}'`,{renderer:e});switch(e.type){case"simple":return c(t=e,Object(a.a)(t.symbol).error);case"unique-value":return function(e){const t=e.uniqueValueInfos.map((e=>Object(a.a)(e.symbol).error)).filter((e=>!!e)),i=Object(a.a)(e.defaultSymbol);return i.error&&t.unshift(i.error),c(e,t)}(e);case"class-breaks":return function(e){const t=e.classBreakInfos.map((e=>Object(a.a)(e.symbol).error)).filter((e=>!!e)),i=Object(a.a)(e.defaultSymbol);return i.error&&t.unshift(i.error),c(e,t)}(e);case"dictionary":return null}var t;return null}function c(e,t){if(!t)return null;let i;if(i=Array.isArray(t)?t:[t],i.length>0){const t=i.map((e=>e.details.symbol.type||e.details.symbol.declaredClass)).filter((e=>!!e));t.sort();const n=[];return t.forEach(((e,i)=>{0!==i&&e===t[i-1]||n.push(e)})),new r.a("renderer-conversion-3d:unsupported-symbols",`Renderer contains symbols (${n.join(", ")}) which are not supported in 3D`,{renderer:e,symbolErrors:i})}return null}},955:function(e,t,i){"use strict";i.d(t,"a",(function(){return g}));var r,n=i(79),a=i(86),s=i(89),o=i(87),c=i(81),l=i(104),d=i(80),h=i(83),u=i(956),p=i(899),f=i(900);const b=o.a.getLogger("esri.geometry.support.MeshComponent");let m=r=class extends a.a{constructor(e){super(e),this.faces=null,this.material=null,this.shading="source",this.trustSourceNormals=!1}static from(e){return Object(h.d)(r,e)}castFaces(e){return Object(f.b)(e,Uint32Array,[Uint16Array],{loggerTag:".faces=",stride:3},b)}castMaterial(e){return Object(h.d)(e&&"object"==typeof e&&("metallic"in e||"roughness"in e||"metallicRoughnessTexture"in e)?p.a:u.a,e)}clone(){return new r({faces:Object(s.a)(this.faces),shading:this.shading,material:Object(s.a)(this.material),trustSourceNormals:this.trustSourceNormals})}cloneWithDeduplication(e,t){const i={faces:Object(s.a)(this.faces),shading:this.shading,material:this.material?this.material.cloneWithDeduplication(e,t):null,trustSourceNormals:this.trustSourceNormals};return new r(i)}};Object(n.a)([Object(c.b)({json:{write:!0}})],m.prototype,"faces",void 0),Object(n.a)([Object(l.a)("faces")],m.prototype,"castFaces",null),Object(n.a)([Object(c.b)({type:u.a,json:{write:!0}})],m.prototype,"material",void 0),Object(n.a)([Object(l.a)("material")],m.prototype,"castMaterial",null),Object(n.a)([Object(c.b)({type:String,json:{write:!0}})],m.prototype,"shading",void 0),Object(n.a)([Object(c.b)({type:Boolean})],m.prototype,"trustSourceNormals",void 0),m=r=Object(n.a)([Object(d.a)("esri.geometry.support.MeshComponent")],m);const g=m},956:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r,n=i(79),a=i(103),s=i(86),o=i(85),c=i(81),l=(i(84),i(82),i(83),i(80)),d=i(898);let h=r=class extends s.a{constructor(e){super(e),this.color=null,this.colorTexture=null,this.normalTexture=null,this.alphaMode="auto",this.alphaCutoff=.5,this.doubleSided=!0}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(e,t){const i=Object(o.l)(e)?e.get(this):null;if(i)return i;const n=new r(this.clonePropertiesWithDeduplication(t));return Object(o.l)(e)&&e.set(this,n),n}clonePropertiesWithDeduplication(e){return{color:Object(o.l)(this.color)?this.color.clone():null,colorTexture:Object(o.l)(this.colorTexture)?this.colorTexture.cloneWithDeduplication(e):null,normalTexture:Object(o.l)(this.normalTexture)?this.normalTexture.cloneWithDeduplication(e):null,alphaMode:this.alphaMode,alphaCutoff:this.alphaCutoff,doubleSided:this.doubleSided}}};Object(n.a)([Object(c.b)({type:a.a,json:{write:!0}})],h.prototype,"color",void 0),Object(n.a)([Object(c.b)({type:d.a,json:{write:!0}})],h.prototype,"colorTexture",void 0),Object(n.a)([Object(c.b)({type:d.a,json:{write:!0}})],h.prototype,"normalTexture",void 0),Object(n.a)([Object(c.b)({nonNullable:!0,json:{write:!0}})],h.prototype,"alphaMode",void 0),Object(n.a)([Object(c.b)({nonNullable:!0,json:{write:!0}})],h.prototype,"alphaCutoff",void 0),Object(n.a)([Object(c.b)({nonNullable:!0,json:{write:!0}})],h.prototype,"doubleSided",void 0),h=r=Object(n.a)([Object(l.a)("esri.geometry.support.MeshMaterial")],h);const u=h},958:function(e,t,i){"use strict";i.d(t,"a",(function(){return m})),i.d(t,"b",(function(){return g})),i.d(t,"c",(function(){return y})),i.d(t,"d",(function(){return S}));i(82);var r=i(113),n=i(85),a=i(554),s=i(145),o=i(116),c=i(106),l=i(207),d=i(197),h=i(901),u=i(959),p=i(565),f=i(981),b=i(566);function m(e){const t=[],i=[];!function(e,t,i){const{attributeData:{position:r},removeDuplicateStartEnd:n}=e,s=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(r)&&1===n,o=r.length/3-(s?1:0),c=new Uint32Array(2*(o-1)),l=s?Object(a.m)(r,0,r.length-3):r;let d=0;for(let a=0;a<o-1;a++)c[d++]=a,c[d++]=a+1;t.push(["position",{size:3,data:l,exclusive:s}]),i.push(["position",c])}(e,i,t);const c=i[0][1].data,h=t[0][1].length,p=new Uint16Array(h);return function(e,t,i){const r=e.attributeData.mapPosition;Object(n.k)(r)||(i.push(["mapPos",i[0][1]]),t.push(["mapPos",{size:3,data:r}]))}(e,i,t),function(e,t,i,r){if(Object(n.l)(e.attributeData.colorFeature))return;const a=e.attributeData.color;t.push(["color",{size:4,data:Object(n.u)(a,u.c)}]),i.push(["color",r])}(e,i,t,p),function(e,t,i,r){if(Object(n.l)(e.attributeData.sizeFeature))return;const a=e.attributeData.size;t.push(["size",{size:1,data:[Object(n.u)(a,1)]}]),i.push(["size",r])}(e,i,t,p),function(e,t,i,r){const a=e.attributeData.colorFeature;Object(n.k)(a)||(t.push(["colorFeatureAttribute",{size:1,data:new Float32Array([a])}]),i.push(["color",r]))}(e,i,t,p),function(e,t,i,r){const a=e.attributeData.sizeFeature;Object(n.k)(a)||(t.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([a])}]),i.push(["sizeFeatureAttribute",r]))}(e,i,t,p),function(e,t,i,r){const a=e.attributeData.opacityFeature;Object(n.k)(a)||(t.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([a])}]),i.push(["opacityFeatureAttribute",r]))}(e,i,t,p),function(e,t,i,a){if("round"!==e.join)return;const s=a.length/3,c=new Float32Array(s),l=x,d=j;Object(o.w)(l,0,0,0);const h=Object(n.u)(e.uniformSize,1);for(let n=-1;n<s;++n){const e=n<0?s+n:n,t=(n+1)%s;if(Object(o.w)(d,a[3*t+0]-a[3*e+0],a[3*t+1]-a[3*e+1],a[3*t+2]-a[3*e+2]),Object(o.r)(d,d),n>=0){const e=(Math.PI-Object(r.b)(Object(o.h)(l,d)))*_*1*O(h);c[n]=Math.max(Math.floor(e),0)}Object(o.e)(l,d,-1)}t.push(["subdivisions",{size:1,data:c}]),i.push(["subdivisions",i[0][1]])}(e,i,t,c),function(e,t,i,r){if(Object(n.k)(e.overlayInfo)||1!==e.overlayInfo.renderCoordsHelper.viewingMode||!e.overlayInfo.spatialReference.isGeographic)return;const a=new Float64Array(r.length),c=Object(d.e)(e.overlayInfo.spatialReference);for(let n=0;n<a.length;n+=3)Object(l.i)(r,n,a,n,c);const h=r.length/3,u=new Float32Array(h+1);let p=x,f=j,b=0,m=0;Object(o.w)(p,a[m++],a[m++],a[m++]),u[0]=0;for(let n=1;n<h+1;++n)n===h&&(m=0),Object(o.w)(f,a[m++],a[m++],a[m++]),b+=Object(s.d)(p,f),u[n]=b,[p,f]=[f,p];t.push(["distanceToStart",{size:1,data:u}]),i.push(["distanceToStart",i[0][1]])}(e,i,t,c),new b.a(i,t,2)}function g(e,t,i,r){const n="polygon"===e.type?1:0,a="polygon"===e.type?e.rings:e.paths,{position:s,outlines:o}=Object(h.a)(a,e.hasZ,n),c=new Float64Array(s.length),l=Object(p.d)(s,e.spatialReference,0,c,0,s,0,s.length/3,t,i,r),d=null!=l;return{lines:d?v(o,s,c):[],projectionSuccess:d,sampledElevation:l}}function v(e,t,i){const r=new Array;for(const{index:n,count:a}of e){if(a<=1)continue;const e=3*n,s=e+3*a;r.push({position:t.subarray(e,s),mapPosition:i?i.subarray(e,s):void 0})}return r}function y(e,t){const i="polygon"===e.type?1:0,r="polygon"===e.type?e.rings:e.paths,{position:n,outlines:a}=Object(h.a)(r,!1,i),s=Object(l.l)(n,e.spatialReference,0,n,t,0,n.length/3);for(let o=2;o<n.length;o+=3)n[o]=f.a;return{lines:s?v(a,n):[],projectionSuccess:s}}function O(e){return 1.863798+-2.0062872/(1+e/18.2313)**.8856294}const x=Object(c.f)(),j=Object(c.f)(),_=4/Math.PI;function S(e){switch(e){case"butt":return 0;case"square":return 1;case"round":return 2;default:return null}}},959:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return a})),i.d(t,"c",(function(){return s}));var r=i(245);const n=1.2,a=r.b,s=r.a},960:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(106);class n{constructor(e,t){this.vec3=e,this.id=t}}function a(e,t,i,a){return new n(Object(r.h)(e,t,i),a)}},961:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return n}));var r=i(136);function n(e){e.fragment.code.add(r.a`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function a(e){e.fragment.code.add(r.a`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}},962:function(e,t,i){"use strict";i.d(t,"a",(function(){return v})),i.d(t,"b",(function(){return g}));var r=i(711),n=i(306),a=i(441),s=i(402),o=i(401),c=i(352),l=i(908),d=i(604),h=i(1068),u=i(907),p=i(406),f=i(467),b=i(136),m=i(342);function g(e){const t=new m.a;return t.include(a.a,{linearDepth:!1}),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),0!==e.output&&7!==e.output||(t.include(l.a,e),t.include(r.a,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(b.a`
      void main(void) {
        if (waterColor.a < ${b.a.float(p.c)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${0===e.output?"forwardLinearDepth();":""}
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(o.a),t.include(c.b,e)),7===e.output&&(t.include(n.a,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(b.a`
        void main() {
          discardBySlice(vpos);
          ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),0===e.output&&(t.include(u.a,e),t.include(n.a,e),e.receiveShadows&&t.include(d.a,e),t.include(h.a,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(f.a),t.fragment.code.add(b.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - camPos);
        float shadow = ${e.receiveShadows?b.a`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),2===e.output&&(t.include(l.a,e),t.include(u.a,e),t.include(n.a,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(b.a`
        void main(void) {
          if (waterColor.a < ${b.a.float(p.c)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(b.a`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`)),5===e.output&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(b.a`
        void main(void) {
          if (waterColor.a < ${b.a.float(p.c)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(b.a`void main() {
gl_FragColor = waterColor;
}`)),4===e.output&&(t.include(s.a),t.varyings.add("vpos","vec3"),t.vertex.code.add(b.a`
      void main(void) {
        if (waterColor.a < ${b.a.float(p.c)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(n.a,e),t.fragment.code.add(b.a`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}const v=Object.freeze({__proto__:null,build:g})},963:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return s}));var r=i(742),n=i(136),a=i(342);function s(){const e=new a.a;return e.include(r.a),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("color","vec4"),e.fragment.code.add(n.a`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * color;
}`),e}const o=Object.freeze({__proto__:null,build:s})},964:function(e,t,i){"use strict";i.d(t,"a",(function(){return u})),i.d(t,"b",(function(){return h}));var r=i(306),n=i(441),a=i(603),s=i(402),o=i(859),c=i(406),l=i(136),d=i(342);function h(e){const t=new d.a;return t.include(n.a,{linearDepth:!1}),t.include(a.a,e),t.include(o.a,{...e,stippleRequiresStretchMeasure:!1}),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),e.stippleEnabled&&(t.vertex.uniforms.add("ndcToPixel","vec2"),t.attributes.add("uv0","vec2"),t.attributes.add("auxpos1","vec3")),t.attributes.add("position","vec3"),t.varyings.add("vpos","vec3"),t.vertex.code.add(l.a`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),e.stippleEnabled&&(t.vertex.code.add(l.a`vec4 vpos2 = transformPosition(proj, view, auxpos1);
float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);`),e.draped||t.vertex.code.add(l.a`vec3 segmentCenter = (position + auxpos1) * 0.5;
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),t.vertex.code.add(l.a`float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);`),e.draped?t.vertex.code.add(l.a`float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);
float segmentLengthPseudoScreen = lineSegmentPixelSize;`):t.vertex.code.add(l.a`float segmentLengthRender = length(position - auxpos1);
float startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),t.vertex.code.add(l.a`vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);
vStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);
vStippleDistance *= gl_Position.w;`)),t.vertex.code.add(l.a`}`),4===e.output&&t.include(s.a),t.include(r.a,e),t.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),t.fragment.code.add(l.a`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${e.attributeColor?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${l.a.float(c.c)}) {
      discard;
    }

    ${0===e.output?l.a`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${4===e.output?l.a`outputHighlight();`:""}
  }
  `),t}const u=Object.freeze({__proto__:null,build:h})},965:function(e,t,i){"use strict";i.d(t,"a",(function(){return D})),i.d(t,"b",(function(){return R}));var r=i(711),n=i(861),a=i(306),s=i(441),o=i(782),c=i(720),l=i(746),d=i(876),h=i(714),u=i(603),p=i(877),f=i(709),b=i(862),m=i(401),g=i(1042),v=i(715),y=i(790),O=i(352),x=i(911),j=i(752),_=i(784),S=i(604),w=i(623),C=i(406),P=i(1043),T=i(863),E=i(136),A=i(342);function R(e){const t=new A.a,i=t.vertex.code,R=t.fragment.code;return t.include(P.a,{name:"Default Material Shader",output:e.output}),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),t.include(l.a),t.varyings.add("vpos","vec3"),t.include(w.a,e),t.include(o.a,e),t.include(f.a,e),0!==e.output&&7!==e.output||(t.include(c.a,e),t.include(s.a,{linearDepth:!1}),0===e.normalType&&e.offsetBackfaces&&t.include(n.a),t.include(g.a,e),t.include(p.a,e),e.instancedColor&&t.attributes.add("instanceColor","vec4"),t.varyings.add("localvpos","vec3"),t.include(h.a,e),t.include(r.a,e),t.include(d.a,e),t.include(u.a,e),t.vertex.uniforms.add("externalColor","vec4"),t.varyings.add("vcolorExt","vec4"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),i.add(E.a`
      void main(void) {
        forwardNormalizedVertexColor();
        vcolorExt = externalColor;
        ${e.instancedColor?"vcolorExt *= instanceColor;":""}
        vcolorExt *= vvColor();
        vcolorExt *= getSymbolColor();
        forwardColorMixMode();

        if (vcolorExt.a < ${E.a.float(C.c)}) {
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        }
        else {
          vpos = calculateVPos();
          localvpos = vpos - view[3].xyz;
          vpos = subtractOrigin(vpos);
          ${0===e.normalType?E.a`
          vNormalWorld = dpNormal(vvLocalNormal(normalModel()));`:""}
          vpos = addVerticalOffset(vpos, localOrigin);
          ${e.vertexTangents?"vTangent = dpTransformVertexTangent(tangent);":""}
          gl_Position = transformPosition(proj, view, vpos);
          ${0===e.normalType&&e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, camPos);":""}
        }

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        forwardLinearDepth();
        forwardTextureCoordinates();
      }
    `)),7===e.output&&(t.include(a.a,e),t.include(C.a,e),e.multipassTerrainEnabled&&(t.fragment.include(m.a),t.include(O.b,e)),t.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("opacity","float").add("layerOpacity","float"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.fragment.include(T.a),R.add(E.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${e.hasColorTexture?E.a`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:E.a`vec4 texColor = vec4(1.0);`}
        ${e.attributeColor?E.a`
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:E.a`
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        gl_FragColor = vec4(opacity_);
      }
    `)),0===e.output&&(t.include(a.a,e),t.include(y.a,e),t.include(v.a,e),t.include(C.a,e),e.receiveShadows&&t.include(S.a,e),e.multipassTerrainEnabled&&(t.fragment.include(m.a),t.include(O.b,e)),t.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("opacity","float").add("layerOpacity","float"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.include(_.a,e),t.include(j.a,e),t.fragment.include(T.a),t.include(x.a,e),R.add(E.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${e.hasColorTexture?E.a`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:E.a`vec4 texColor = vec4(1.0);`}
        shadingParams.viewDirection = normalize(vpos - camPos);
        ${3===e.normalType?E.a`
        vec3 normal = screenDerivativeNormal(localvpos);`:E.a`
        shadingParams.normalView = vNormalWorld;
        vec3 normal = shadingNormal(shadingParams);`}
        ${1===e.pbrMode?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":1===e.viewingMode?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${e.attributeColor?E.a`
        vec3 albedo_ = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:E.a`
        vec3 albedo_ = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        ${e.hasNormalTexture?E.a`
              mat3 tangentSpace = ${e.vertexTangents?"computeTangentSpace(normal);":"computeTangentSpace(normal, vpos, vuv0);"}
              vec3 shadedNormal = computeTextureNormal(tangentSpace, vuv0);`:"vec3 shadedNormal = normal;"}
        ${1===e.pbrMode||2===e.pbrMode?1===e.viewingMode?E.a`vec3 normalGround = normalize(vpos + localOrigin);`:E.a`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:E.a``}
        ${1===e.pbrMode||2===e.pbrMode?E.a`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
            vec3 shadedColor = evaluateSceneLightingPBR(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:"vec3 shadedColor = evaluateSceneLighting(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight);"}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.include(b.a,e),t}const D=Object.freeze({__proto__:null,build:R})},966:function(e,t,i){"use strict";i.d(t,"a",(function(){return T})),i.d(t,"b",(function(){return P}));var r=i(711),n=i(861),a=i(306),s=i(441),o=i(782),c=i(720),l=i(746),d=i(876),h=i(714),u=i(603),p=i(709),f=i(862),b=i(401),m=i(715),g=i(790),v=i(352),y=i(752),O=i(784),x=i(604),j=i(623),_=i(406),S=i(863),w=i(136),C=i(342);function P(e){const t=new C.a,i=t.vertex.code,P=t.fragment.code;return t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("camPos","vec3").add("localOrigin","vec3"),t.include(l.a),t.varyings.add("vpos","vec3"),t.include(j.a,e),t.include(o.a,e),t.include(p.a,e),0!==e.output&&7!==e.output||(t.include(c.a,e),t.include(s.a,{linearDepth:!1}),e.offsetBackfaces&&t.include(n.a),e.instancedColor&&t.attributes.add("instanceColor","vec4"),t.varyings.add("vNormalWorld","vec3"),t.varyings.add("localvpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.include(h.a,e),t.include(r.a,e),t.include(d.a,e),t.include(u.a,e),t.vertex.uniforms.add("externalColor","vec4"),t.varyings.add("vcolorExt","vec4"),i.add(w.a`
        void main(void) {
          forwardNormalizedVertexColor();
          vcolorExt = externalColor;
          ${e.instancedColor?"vcolorExt *= instanceColor;":""}
          vcolorExt *= vvColor();
          vcolorExt *= getSymbolColor();
          forwardColorMixMode();

          if (vcolorExt.a < ${w.a.float(_.c)}) {
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          }
          else {
            vpos = calculateVPos();
            localvpos = vpos - view[3].xyz;
            vpos = subtractOrigin(vpos);
            vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, vpos);
            ${e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, camPos);":""}
          }
          ${e.multipassTerrainEnabled?w.a`depth = (view * vec4(vpos, 1.0)).z;`:""}
          forwardLinearDepth();
          forwardTextureCoordinates();
        }
      `)),7===e.output&&(t.include(a.a,e),t.include(_.a,e),e.multipassTerrainEnabled&&(t.fragment.include(b.a),t.include(v.b,e)),t.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("opacity","float").add("layerOpacity","float"),t.fragment.uniforms.add("view","mat4"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.fragment.include(S.a),P.add(w.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?w.a`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${e.hasColorTexture?w.a`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:w.a`vec4 texColor = vec4(1.0);`}
        ${e.attributeColor?w.a`
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w.a`
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}

        gl_FragColor = vec4(opacity_);
      }
    `)),0===e.output&&(t.include(a.a,e),t.include(g.a,e),t.include(m.a,e),t.include(_.a,e),e.receiveShadows&&t.include(x.a,e),e.multipassTerrainEnabled&&(t.fragment.include(b.a),t.include(v.b,e)),t.fragment.uniforms.add("camPos","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("opacity","float").add("layerOpacity","float"),t.fragment.uniforms.add("view","mat4"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.include(O.a,e),t.include(y.a,e),t.fragment.include(S.a),P.add(w.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?w.a`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${e.hasColorTexture?w.a`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:w.a`vec4 texColor = vec4(1.0);`}
        vec3 viewDirection = normalize(vpos - camPos);
        ${1===e.pbrMode?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":1===e.viewingMode?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${e.attributeColor?w.a`
        vec3 albedo_ = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w.a`
        vec3 albedo_ = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        ${w.a`
        vec3 shadedNormal = normalize(vNormalWorld);
        albedo_ *= 1.2;
        vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);
        float alignmentLightView = clamp(dot(viewForward, -lightingMainDirection), 0.0, 1.0);
        float transmittance = 1.0 - clamp(dot(viewForward, shadedNormal), 0.0, 1.0);
        float treeRadialFalloff = vColor.r;
        float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
        additionalLight += backLightFactor * lightingMainIntensity;`}
        ${1===e.pbrMode||2===e.pbrMode?1===e.viewingMode?w.a`vec3 normalGround = normalize(vpos + localOrigin);`:w.a`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:w.a``}
        ${1===e.pbrMode||2===e.pbrMode?w.a`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
            vec3 shadedColor = evaluateSceneLightingPBR(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:"vec3 shadedColor = evaluateSceneLighting(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight);"}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.include(f.a,e),t}const T=Object.freeze({__proto__:null,build:P})},981:function(e,t,i){"use strict";i.d(t,"a",(function(){return mt}));var r=i(79),n=i(99),a=i(129),s=i(121),o=i(87),c=i(408),l=i(85),d=i(215),h=i(562),u=i(112),p=i(81),f=(i(84),i(82),i(83),i(80)),b=i(149),m=i(224),g=i(106),v=i(199),y=i(816),O=i(113),x=i(118),j=i(960);class _{constructor(e,t){this.index=e,this.renderTargets=t,this.extent=Object(x.l)(),this.resolution=0,this.renderLocalOrigin=Object(j.a)(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries={extents:[Object(x.l)(),Object(x.l)(),Object(x.l)()],numViews:0},this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(t.renderTargets.length).fill(!1)}getValidTarget(e){return this.validTargets[e]?this.renderTargets.getTarget(e):null}get needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const t=1===e?this.renderTargets.getTarget(0):2===e?this.renderTargets.getTarget(2):this.renderTargets.getTarget(4);return t?t.getTexture():null}getNormalTexture(e){const t=1===e?this.renderTargets.getTarget(3):null;return t?t.getTexture():null}draw(e,t){const i=this.computeRenderTargetValidityBitfield(),r=this.needsColorWithoutRasterImage;for(const n of this.renderTargets.renderTargets)1===n.type&&!1===r?this.validTargets[n.type]=!1:this.validTargets[n.type]=e.drawTarget(this,n,t);return i^this.computeRenderTargetValidityBitfield()?0:1}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[0]|+e[1]<<1|+e[2]<<2|+e[3]<<3|+e[4]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this.extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Object(x.u)(this.extent,e.range,0,t)}if(this.extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Object(x.u)(this.extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,Object(x.k)(this.canvasGeometries.extents[0],this.extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}applyViewport(e){e.setViewport(0===this.index?0:this.resolution,0,this.resolution,this.resolution)}}var S=i(235),w=i(249),C=i(267),P=(i(257),i(233),i(326),i(209)),T=i(250);class E{constructor(e,t){this.size=Object(S.a)(),this._fbo=null,this._fbo=new C.a(e,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:t,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=Object(l.f)(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return null!==this._fbo}resize(e,t){this.size[0]=e,this.size[1]=t,this._fbo.resize(this.size[0],this.size[1])}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}disposeRenderTargetMemory(){var e;null==(e=this._fbo)||e.resize(0,0)}get gpuMemoryUsage(){var e,t;return null!=(e=null==(t=this._fbo)?void 0:t.gpuMemoryUsage)?e:0}}class A{constructor(e){const t=(t,i,r=!0)=>({type:i,fbo:new E(e,r),renderPass:t,valid:!1,lastUsed:1/0});this.renderTargets=[t(0,0),t(0,1),t(5,2,!1),t(3,3),t(0,4)]}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,t,i){if(e)t.lastUsed=i;else if(i-t.lastUsed>R)t.fbo.disposeRenderTargetMemory(),t.lastUsed=1/0;else if(t.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce(((e,t)=>e+t.fbo.gpuMemoryUsage),0)}}const R=1e3;class D{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return 0===this._outer.size}get(e,t){var i;return null==(i=this._outer.get(e))?void 0:i.get(t)}set(e,t,i){const r=this._outer.get(e);r?r.set(t,i):this._outer.set(e,new Map([[t,i]]))}delete(e,t){const i=this._outer.get(e);i&&(i.delete(t),0===i.size&&this._outer.delete(e))}forEach(e){this._outer.forEach(((t,i)=>e(t,i)))}}class M{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}class I{constructor(e){this._context=e,this._perConstructorInstances=new D,this._frameCounter=0,this._keepAliveFrameCount=z}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.dispose())))),this._perConstructorInstances.clear()}acquire(e,t){const i=t.key;let r=this._perConstructorInstances.get(e,i);if(Object(l.k)(r)){const n=new e(this._context,t,(()=>this.release(n)));r=new M(n),this._perConstructorInstances.set(e,i,r)}return++r.refCount,r.technique}releaseAndAcquire(e,t,i){if(Object(l.l)(i)){if(t.key===i.key)return i;i.release()}return this.acquire(e,t)}release(e){if(Object(l.k)(e)||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);Object(l.k)(t)||(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==z&&this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((e,i)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.dispose(),this._perConstructorInstances.delete(t,i))}))}))}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach(((t,i)=>{e.push((async(e,t)=>{const i=t.shader;i&&(await i.reload(),e.forEach((e=>{e.technique.reload(this._context)})))})(t,i))})),await Promise.all(e)}}const z=-1,L=e=>class extends e{constructor(){super(...arguments),this._isDisposed=!1}dispose(){for(const t of null!=(e=this._managedDisposables)?e:[]){var e;const i=this[t];this[t]=null,i&&"function"==typeof i.dispose&&i.dispose()}this._isDisposed=!0}get isDisposed(){return this._isDisposed}};L(class{});var F=i(685),V=i(315);const G=o.a.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository");class U{constructor(e){this._glMaterial=e,this.refCnt=0,this._glMaterial=e}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,Object(V.a)(this.refCnt>=0)}getRefCnt(){return this.refCnt}get glMaterial(){return this._glMaterial}}class B{constructor(e,t,i,r){this._textureRepository=e,this._techniqueRepository=t,this.materialChanged=i,this.requestRender=r,this._id2glMaterialRef=new D}dispose(){this._textureRepository.dispose()}acquire(e,t){this._ownMaterial(e);let i=this._id2glMaterialRef.get(t,e.id);if(Object(l.k)(i)){const r=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:t});i=new U(r),this._id2glMaterialRef.set(t,e.id,i)}return i.incRefCnt(),i.glMaterial}release(e,t){const i=this._id2glMaterialRef.get(t,e.id);Object(l.l)(i)&&(i.decRefCnt(),0===i.getRefCnt()&&(Object(l.f)(i.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){Object(l.l)(e.repository)&&e.repository!==this&&G.error("Material is already owned by a different material repository"),e.repository=this}}var N=i(823),k=i(1039),H=i(688);class q{constructor(e){this.rctx=e,this.camera=null,this.lastFrameCamera=new F.a,this.pass=0,this.slot=2,this.highlightDepthTexture=null,this.renderOccludedMask=W,this.hasOccludees=!1}resetRenderOccludedMask(){this.renderOccludedMask=W}get isHighlightPass(){return 5===this.pass}}const W=13;class ${constructor(){this.adds=new d.a,this.removes=new d.a,this.updates=new d.a({allocator:e=>e||new Y,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class Y{}class Z{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}function X(e){return e.data.indexCount>=1}var Q=i(670),J=i(564),K=i(1059);class ee{constructor(e){this.first=e.from,this.count=e.to-e.from}}class te{constructor(e=0,t=0){this.from=e,this.to=t}}class ie extends te{constructor(e,t,i,r,n,a){super(t,i),this.id=e,this.isVisible=r,this.hasHighlights=n,this.hasOccludees=a}}function re(e){return Array.from(e.values()).sort(ne)}function ne(e,t){return e.from===t.from?e.to-t.to:e.from-t.from}function ae(e,t){if(0===e.length)return void e.push(new ee(t));const i=e[e.length-1];if(function(e,t){return e.first+e.count>=t.from}(i,t)){const e=t.from-i.first+t.to-t.from;i.count=e}else e.push(new ee(t))}class se{constructor(e,t){this._pool=e,this._size=0,this._buffer=e.newBuffer(oe(t))}dispose(){this._buffer=this._pool.deleteBuffer(this._buffer),this._size=0}release(){this.erase(0,this._size),this.dispose()}get vao(){return this._buffer.vao}get array(){return this._buffer.array}get size(){return this._size}grow(e){this._resize(this._size+e,!0).dispose()}alloc(e){return this._resize(e,!1)}_resize(e,t){let i;const r=function(e,t,i){return t<=i?e>=i?e:oe(Math.max(2*e,i)):e<=2*i?e:oe(i)}(this._buffer.length,this._size,e);if(this._buffer.length!==r){const e=this._pool.newBuffer(r);t&&(e.array.set(this._buffer.array.subarray(0,Math.min(this._size,r))),e.vao.vertexBuffers.geometry.setSubData(e.array,0,0,e.array.byteLength)),i=this._buffer,this._buffer=e}const n=this._size;return this._size=e,i?{dispose:()=>{i.array.fill(0,0,n),this._pool.deleteBuffer(i)},copy:(e,t,r)=>this._buffer.array.set(i.array.subarray(t,r),e),hasNewBuffer:!0}:{dispose:()=>{},copy:(e,t,i)=>{e!==t&&this._buffer.array.copyWithin(e,t,i)},hasNewBuffer:!1}}erase(e,t){this._buffer.array.fill(0,e,t)}}function oe(e){return 65536*Math.ceil(e/65536)}var ce=i(239),le=i(251);class de{constructor(e,t,i,r){this.vao=new T.a(e,t,{geometry:i},{geometry:w.a.createVertex(e,35044)}),this.array=new Float32Array(r),this.vao.vertexBuffers.geometry.setData(this.array)}dispose(){this.vao.dispose(!0)}get length(){return this.array.length}}const he=ce.a+1;class ue{constructor(e,t,i){this._rctx=e,this._locations=t,this._layout=i,this._cache=e.newCache(`MergedRenderer pool ${Object(le.a)()}`,pe)}dispose(){this._cache.destroy()}newBuffer(e){const t=e.toString(),i=this._cache.pop(t);if(Object(l.l)(i)){const e=i.pop();return i.length>0&&this._cache.put(t,i,e.array.byteLength*i.length,he),e}return new de(this._rctx,this._locations,this._layout,e)}deleteBuffer(e){const t=e.array.byteLength,i=e.array.length.toString(),r=this._cache.pop(i);return Object(l.l)(r)?(r.push(e),this._cache.put(i,r,t*r.length,-1)):this._cache.put(i,[e],t,-1),null}}function pe(e,t){if(0===t)return void e.forEach((e=>e.dispose()));const i=e.pop(),r=e.length*i.array.byteLength;return i.dispose(),r}var fe=i(529);class be{constructor(e,t,i){this._rctx=e,this._materialRepository=t,this._material=i,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new d.a,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new J.a(this._material,this._materialRepository),this._bufferWriter=i.createBufferWriter(),this._bufferPool=new ue(e,i.vertexAttributeLocations,Object(Q.a)(this._bufferWriter.vertexBufferLayout))}dispose(){this._glMaterials.destroy(),this._dataByOrigin.forEach((e=>e.buffer.dispose())),this._dataByOrigin.clear(),this._bufferPool.dispose()}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this._material instanceof K.a}get rendersOccluded(){return!this.isEmpty&&1!==this._material.renderOccluded}modify(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()}addAndRemoveGeometries(e,t){const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,n=this._dataByOrigin,a=function(e,t){const i=new Map;for(const r of e)ge(i,r,!0);for(const r of t)ge(i,r,!1);return i}(e,t);a.forEach(((e,t)=>{a.delete(t);const s=e.toAdd.reduce(((e,t)=>e+i.elementCount(t.data)),0);let o=n.get(t);if(null==o)Object(V.a)(0===e.toRemove.length),o=new xe(e.origin,new se(this._bufferPool,s*r)),n.set(t,o);else if(0===e.toAdd.length&&o.instances.size===e.toRemove.length)return o.buffer.dispose(),void n.delete(t);let c=0;o.instances.forEach((e=>c+=e.to-e.from));const l=e.toRemove.reduce(((e,t)=>e+i.elementCount(t.data)),0),d=o.buffer.size,h=(c+s-l)*r,u=_e;if(h<d/2?this.removeAndRebuild(o,e.toRemove,r,h,u):e.toRemove.length>0&&this.remove(o,e.toRemove,r,u),e.toAdd.length>0){const t=Se;Object(V.i)(t,-e.origin[0],-e.origin[1],-e.origin[2]),this.add(o,e.toAdd,r,t,u)}const p=o.buffer.vao.vertexBuffers.geometry;Oe(u),u.forAll((({from:e,to:t})=>{if(e<t){const i=o.buffer.array,r=4,n=e*r,a=t*r;p.setSubData(i,n,n,a)}})),u.clear(),o.drawCommandsDirty=!0}))}updateGeometries(e){const t=this._bufferWriter,i=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.renderGeometry,n=this._dataByOrigin.get(e.origin.id),a=n&&n.instances.get(e.id);if(!a)return;const s=r.updateType;if(1&s&&(a.isVisible=e.instanceParameters.visible),9&s){const t=e.instanceParameters.visible;a.hasHighlights=!!e.instanceParameters.highlights&&t}if(16&s&&(a.hasOccludees=!!e.instanceParameters.occludees),6&s){const{array:r,vao:s}=n.buffer;Object(fe.b)(e,we,Ce),t.write({transformation:we,invTranspTransformation:Ce},e.data,t.vertexBufferLayout.createView(r.buffer),a.from),Object(V.a)(a.from+t.elementCount(e.data)===a.to,"material VBO layout has changed"),s.vertexBuffers.geometry.setSubData(r,a.from*i*4,a.from*i*4,a.to*i*4)}n.drawCommandsDirty=!0}}updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,Object(c.c)(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))}));const e=e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,0===e.instances.size)return;if(!ve(e)){const t=this._bufferWriter.vertexBufferLayout.stride,i=4*e.buffer.size/t;return void(e.drawCommandsDefault=[{first:0,count:i}])}const t=re(e.instances);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const i of t)i.isVisible&&(i.hasOccludees?ae(e.drawCommandsOccludees,i):ae(e.drawCommandsDefault,i),i.hasHighlights?ae(e.drawCommandsHighlight,i):ae(e.drawCommandsShadowHighlightRest,i))};this._dataByOrigin.forEach((t=>{t.drawCommandsDirty&&(e(t),t.drawCommandsDirty=!1)}))}updateLogic(e){return this._material.update(e)}render(e,t,i){if(null!=e&&!this._material.requiresSlot(e,t))return!1;const r=5===t||7===t;if(r&&!this._hasHighlights)return!1;const n=6===t,a=!(r||n);if(this._dataByOrigin.forEach((e=>{if(r&&!e.hasHighlights)return;const t=(r?e.drawCommandsHighlight:n&&ve(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,i=a&&e.drawCommandsOccludees||null;(Object(l.l)(t)||Object(l.l)(i))&&this._renderCommandData.push(new je(e.origin,e.buffer,t,i))})),0===this._renderCommandData.length)return!1;const s=this._rctx,o=this._glMaterials.load(s,t);if(Object(l.k)(o))return this._renderCommandData.clear(),!1;const c=o.beginSlot(i);return c.bindPipelineState(s,e,!1),s.useProgram(c.program),o.bind(i,c),this._renderCommandData.forAll((({origin:t,buffer:r,renderCommands:n,occludeeCommands:a})=>{i.origin=t,c.bindDraw(i),c.ensureAttributeLocations(r.vao),s.bindVAO(r.vao);const o=c.primitiveType;Object(l.l)(n)&&this.renderCommands(s,o,n),Object(l.l)(a)&&(c.bindPipelineState(s,e,!0),this.renderCommands(s,o,a),c.bindPipelineState(s,e,!1))})),this._renderCommandData.clear(),!0}renderCommands(e,t,i){for(let r=0;r<i.length;r++)e.drawArrays(t,i[r].first,i[r].count)}removeAndRebuild(e,t,i,r,n){for(const l of t)e.instances.delete(l.id);const a=re(e.instances);e.instances.clear();const s=e.buffer.size,o=e.buffer.alloc(r);let c=0;for(const l of a){const t=l.from*i,r=l.to*i;o.copy(c,t,r),l.from=c/i,c+=r-t,l.to=c/i,e.instances.set(l.id,l)}n.push(new te(0,o.hasNewBuffer?e.buffer.array.length:s)),o.dispose(),e.buffer.erase(c,n.back().to),e.holes.clear()}remove(e,t,i,r){for(const n of t){const t=n.id,a=e.instances.get(t),s=a.from*i,o=a.to*i;e.buffer.erase(s,o),e.holes.push(new te(a.from,a.to)),e.instances.delete(t),r.push(new te(s,o))}Oe(e.holes)}add(e,t,i,r,n){const a=this._bufferWriter;let s=a.vertexBufferLayout.createView(e.buffer.array.buffer);for(const o of t){const t=Object(l.l)(o.transformation)?Object(b.n)(we,r,o.transformation):r;Object(b.c)(Ce,t);const c=Object(b.t)(Ce,Ce),d=a.elementCount(o.data),h=d*i;let u=ye(e.holes,d);Object(l.k)(u)&&(u=e.buffer.size/i,e.buffer.grow(h),s=a.vertexBufferLayout.createView(e.buffer.array.buffer)),a.write({transformation:t,invTranspTransformation:c},o.data,s,u);const p=o.instanceParameters.visible,f=!!o.instanceParameters.highlights&&p,m=!!o.instanceParameters.occludees,g=new ie(o.id,u,u+d,p,f,m);Object(V.a)(null==e.instances.get(o.id)),e.instances.set(o.id,g),n.push(new te(g.from*i,g.to*i))}}get test(){return{material:this._material,glMaterials:this._glMaterials}}}class me{constructor(e){this.origin=e,this.toAdd=new Array,this.toRemove=new Array}}function ge(e,t,i){const r=t.origin;if(Object(l.k)(r))return;let n=e.get(r.id);null==n&&(n=new me(r.vec3),e.set(r.id,n)),i?n.toAdd.push(t):n.toRemove.push(t)}function ve(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}function ye(e,t){let i;if(!e.some((e=>!(e.to-e.from<t)&&(i=e,!0))))return null;const r=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),r}function Oe(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let i=!0;for(;i;)i=!1,e.forEach((r=>{const n=t.get(r.to);n&&(r.to=n.to,t.delete(n.from),e.removeUnordered(n),i=!0)}))}class xe{constructor(e,t){this.origin=e,this.buffer=t,this.instances=new Map,this.holes=new d.a({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1}}class je{constructor(e,t,i,r){this.origin=e,this.buffer=t,this.renderCommands=i,this.occludeeCommands=r}}const _e=new d.a({deallocator:null}),Se=Object(v.d)(),we=Object(v.d)(),Ce=Object(v.d)();let Pe=class extends n.a{constructor(){super(...arguments),this._pending=new Te,this._changes=new $,this._materialRenderers=new Map,this._sortedMaterialRenderers=new d.a,this._hasHighlights=!1,this._hasWater=!1}dispose(){this._changes.prune(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return Object(c.c)(this._materialRenderers,(e=>e.rendersOccluded))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=function(e){const t=new Map,i=e=>{let i=t.get(e);return i||(i=new Z,t.set(e,i)),i};return e.adds.forAll((e=>{X(e)&&i(e.material).adds.push(e)})),e.removes.forAll((e=>{X(e)&&i(e.material).removes.push(e)})),e.updates.forAll((e=>{X(e.renderGeometry)&&i(e.renderGeometry.material).updates.push(e)})),t}(this._changes);let t=!1,i=!1,r=!1;return e.forEach(((e,n)=>{let a=this._materialRenderers.get(n);if(!a&&e.adds.length>0&&(a=new be(this.rctx,this.materialRepository,n),this._materialRenderers.set(n,a),t=!0,i=!0,r=!0),!a)return;const s=i||a.hasHighlights,o=r||a.hasWater;a.modify(e),i=i||s!==a.hasHighlights,r=r||o!==a.hasWater,a.isEmpty&&(this._materialRenderers.delete(n),a.dispose(),t=!0)})),this._changes.clear(),t&&this.updateSortedMaterialRenderers(),i&&(this._hasHighlights=Object(c.c)(this._materialRenderers,(e=>e.hasHighlights))),r&&(this._hasWater=Object(c.c)(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0}add(e){if(0===e.length)return;const t=this._pending.empty;for(const i of e)this._pending.adds.add(i);t&&this.notifyChange("updating")}remove(e){const t=this._pending.empty;for(const i of e)this._pending.adds.has(i)?(this._pending.removed.add(i),this._pending.adds.delete(i)):this._pending.removed.has(i)||this._pending.removes.add(i);t&&!this._pending.empty&&this.notifyChange("updating")}modify(e,t){const i=0===this._changes.updates.length;for(const r of e){const e=this._changes.updates.pushNew();e.renderGeometry=r,e.updateType=t}i&&this._changes.updates.length>0&&this.notifyChange("updating")}updateLogic(e){let t=!1;return this._sortedMaterialRenderers.forAll((({materialRenderer:i})=>t=i.updateLogic(e)||t)),t}render(e,t){for(let i=0;i<this._sortedMaterialRenderers.length;i++){const r=this._sortedMaterialRenderers.data[i];r.material.shouldRender(e)&&r.materialRenderer.render(t.slot,e.pass,t)}}updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((t,i)=>{i.insertOrder=e++,this._sortedMaterialRenderers.push({material:i,materialRenderer:t})})),this._sortedMaterialRenderers.sort(((e,t)=>{const i=t.material.renderPriority-e.material.renderPriority;return 0!==i?i:e.material.insertOrder-t.material.insertOrder}))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};Object(r.a)([Object(p.b)()],Pe.prototype,"rctx",void 0),Object(r.a)([Object(p.b)()],Pe.prototype,"materialRepository",void 0),Object(r.a)([Object(p.b)()],Pe.prototype,"updating",null),Pe=Object(r.a)([Object(f.a)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Pe);class Te{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}var Ee=i(963),Ae=i(419),Re=i(432),De=i(433),Me=i(434),Ie=i(420),ze=i(393);class Le extends Re.a{initializeProgram(e){const t=Le.shader.get().build();return new Ie.a(e.rctx,t,Me.a)}initializePipeline(){return this.configuration.hasAlpha?Object(ze.f)({blending:Object(ze.g)(770,1,771,771),colorWrite:ze.c}):Object(ze.f)({colorWrite:ze.c})}}Le.shader=new Ae.a(Ee.a,(()=>i.e(321).then(i.bind(null,1355))));class Fe extends De.a{constructor(){super(...arguments),this.hasAlpha=!1}}Object(r.a)([Object(De.b)()],Fe.prototype,"hasAlpha",void 0);class Ve{constructor(e=Object(g.f)()){this.intensity=e}}class Ge{constructor(e=Object(g.f)(),t=Object(g.h)(.57735,.57735,.57735)){this.intensity=e,this.direction=t}}class Ue{constructor(e=Object(g.f)(),t=Object(g.h)(.57735,.57735,.57735),i=!0){this.intensity=e,this.direction=t,this.castShadows=i}}class Be{constructor(){this.r=[0],this.g=[0],this.b=[0]}}var Ne=i(116);function ke(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t[r];return i}function He(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t;return i}function qe(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]+t[r];return i}function We(e){return(e+1)*(e+1)}function $e(e,t,i){const r=e[0],n=e[1],a=e[2],s=i||[];return s.length=We(t),t>=0&&(s[0]=.28209479177),t>=1&&(s[1]=.4886025119*r,s[2]=.4886025119*a,s[3]=.4886025119*n),t>=2&&(s[4]=1.09254843059*r*n,s[5]=1.09254843059*n*a,s[6]=.31539156525*(3*a*a-1),s[7]=1.09254843059*r*a,s[8]=.54627421529*(r*r-n*n)),s}function Ye(e,t){const i=(r=t.r.length,Object(O.e)(Math.floor(Math.sqrt(r)-1),0,2));var r;for(const n of e)Object(Ne.s)(tt,n.direction),$e(tt,i,Ke),ke(Ke,it),He(Ke,n.intensity[0],et),qe(t.r,et),He(Ke,n.intensity[1],et),qe(t.g,et),He(Ke,n.intensity[2],et),qe(t.b,et);return t}function Ze(e,t,i,r){(function(e,t){const i=We(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let n=0;n<i;n++)r.r[n]=r.g[n]=r.b[n]=0})(t,r),Object(Ne.w)(i.intensity,0,0,0);let n=!1;const a=Xe,s=Qe,o=Je;a.length=0,s.length=0,o.length=0;for(const c of e)c instanceof Ue&&!n?(Object(Ne.k)(i.direction,c.direction),i.intensity[0]=c.intensity[0],i.intensity[1]=c.intensity[1],i.intensity[2]=c.intensity[2],i.castShadows=c.castShadows,n=!0):c instanceof Ue||c instanceof Ge?a.push(c):c instanceof Ve?s.push(c):c instanceof Be&&o.push(c);Ye(a,r),function(e,t){$e(tt,0,Ke);for(const i of e)t.r[0]+=Ke[0]*it[0]*i.intensity[0]*4*Math.PI,t.g[0]+=Ke[0]*it[0]*i.intensity[1]*4*Math.PI,t.b[0]+=Ke[0]*it[0]*i.intensity[2]*4*Math.PI}(s,r);for(const c of o)qe(r.r,c.r),qe(r.g,c.g),qe(r.b,c.b)}const Xe=[],Qe=[],Je=[],Ke=[0],et=[0],tt=Object(g.f)(),it=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class rt{constructor(){this._shOrder=2,this._ambientBoost=.4,this._oldSunlight={direction:Object(g.f)(),ambient:{color:Object(g.f)(),intensity:1},diffuse:{color:Object(g.f)(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new Be,this._mainLight={intensity:Object(g.f)(),direction:Object(g.h)(1,0,0),castShadows:!1}}get lightingMainDirection(){return this._mainLight.direction}setLightDirectionUniform(e){e.setUniform3fv("lightingMainDirection",this._mainLight.direction)}setUniforms(e,t=!1){const i=t?(1-this.groundLightingFactor)*(1-this.globalFactor):0;e.setUniform1f("lightingFixedFactor",i),e.setUniform1f("lightingGlobalFactor",this.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._mainLight.intensity),e.setUniform1f("ambientBoostFactor",this._ambientBoost);const r=this._sphericalHarmonics;0===this._shOrder?e.setUniform3f("lightingAmbientSH0",r.r[0],r.g[0],r.b[0]):1===this._shOrder?(e.setUniform4f("lightingAmbientSH_R",r.r[0],r.r[1],r.r[2],r.r[3]),e.setUniform4f("lightingAmbientSH_G",r.g[0],r.g[1],r.g[2],r.g[3]),e.setUniform4f("lightingAmbientSH_B",r.b[0],r.b[1],r.b[2],r.b[3])):2===this._shOrder&&(e.setUniform3f("lightingAmbientSH0",r.r[0],r.g[0],r.b[0]),e.setUniform4f("lightingAmbientSH_R1",r.r[1],r.r[2],r.r[3],r.r[4]),e.setUniform4f("lightingAmbientSH_G1",r.g[1],r.g[2],r.g[3],r.g[4]),e.setUniform4f("lightingAmbientSH_B1",r.b[1],r.b[2],r.b[3],r.b[4]),e.setUniform4f("lightingAmbientSH_R2",r.r[5],r.r[6],r.r[7],r.r[8]),e.setUniform4f("lightingAmbientSH_G2",r.g[5],r.g[6],r.g[7],r.g[8]),e.setUniform4f("lightingAmbientSH_B2",r.b[5],r.b[6],r.b[7],r.b[8]))}set(e){Ze(e,this._shOrder,this._mainLight,this._sphericalHarmonics),Object(Ne.k)(this._oldSunlight.direction,this._mainLight.direction);const t=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*t,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*t,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*t,Object(Ne.e)(this._oldSunlight.diffuse.color,this._mainLight.intensity,t),Object(Ne.k)(nt,this._oldSunlight.diffuse.color),Object(Ne.e)(nt,nt,this._ambientBoost*this.globalFactor),Object(Ne.f)(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,nt)}get old(){return this._oldSunlight}}const nt=Object(g.f)();var at=i(398);class st{constructor(e){this._rctx=e,this.cache=new Map}dispose(){this.cache.forEach((e=>e.texture=Object(l.f)(e.texture))),this.cache.clear()}acquire(e){if(Object(l.k)(e))return null;const t=this.patternId(e),i=this.cache.get(t);if(i)return i.refCount++,i.bind;const r=e.pixelRatio,{encodedData:n,sdfNormalizer:a,pixels:s,paddedPixels:o}=function(e,t){const i=e.map((e=>Math.round(e*t))),r=1/t,n=Math.floor(i.reduce(((e,t)=>e+t))),a=i.reduce(((e,t)=>Math.max(e,t))),s=(Math.floor(.5*(a-1))+.5)*r,o=[];let c=1;for(const f of i){for(let e=0;e<f;e++){const t=c*(Math.min(e,f-1-e)+.5)*r/s*.5+.5;o.push(t)}c=-c}const l=Math.round(i[0]/2),d=[...o.slice(l),...o.slice(0,l)],h=n+2,u=new Uint8Array(4*h);let p=4;for(const f of d)Object(at.a)(f,u,p),p+=4;return u.copyWithin(0,p-4,p),u.copyWithin(p,4,8),{encodedData:u,sdfNormalizer:s,paddedPixels:h,pixels:n}}(e.pattern,r),c=s/r,d={refCount:1,texture:null,bind:e=>(Object(l.k)(d.texture)&&(d.texture=new P.a(this._rctx,{width:o,height:1,internalFormat:6408,pixelFormat:6408,dataType:5121,wrapMode:33071},n)),e.bindTexture(d.texture,"stipplePatternTexture"),{pixelSize:c,sdfNormalizer:a,pixels:s})};return this.cache.set(t,d),d.bind}release(e){if(Object(l.k)(e))return;const t=this.patternId(e),i=this.cache.get(t);i&&(i.refCount--,0===i.refCount&&(Object(l.l)(i.texture)&&i.texture.dispose(),this.cache.delete(t)))}swap(e,t){const i=this.acquire(t);return this.release(e),i}patternId(e){return`${e.pattern.join(",")}-r${e.pixelRatio}`}}var ot=i(502),ct=i(766);const lt=o.a.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let dt=class extends(L(n.a)){constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new rt,this._handles=new s.a,this._frameTask=ot.a,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new d.a,this._geometries=new Map,this.worldToPCSRatio=1,this.events=new a.a,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new q(this._rctx);const t=e.waterTextureRepository;this._stippleTextureRepository=new st(e.renderingContext),this._shaderTechniqueRepository=new I({rctx:this._rctx,viewingMode:2,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:t}),this._handles.add([Object(u.a)(t,"loadingState",(()=>this.events.emit("content-changed"))),Object(u.a)(this,"spatialReference",(e=>this._localOrigins=new k.a(e)))]),this._materialRepository=new B(e.textureRepository,this._shaderTechniqueRepository,(e=>{(e.renderOccluded&gt)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating")}),(()=>this.events.emit("content-changed"))),this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new Ve(Object(g.h)(1,1,1))]),this._bindParameters={slot:20,highlightDepthTexture:Object(N.a)(this._rctx),camera:pt,inverseViewport:Object(m.a)(),origin:null,screenToWorldRatio:null,screenToPCSRatio:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:v.a,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null},this._frameTask=this.view.resourceController.scheduler.registerTask(ot.b.STAGE,this),this._handles.add(this._frameTask)}dispose(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.dispose())),this._layerRenderers.clear(),this._debugTextureTechnique=Object(l.r)(this._debugTextureTechnique),this._debugPatternTexture=Object(l.f)(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=Object(l.f)(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=Object(l.f)(this._shaderTechniqueRepository),this._temporaryFBO=Object(l.f)(this._temporaryFBO),this._quadVAO=Object(l.f)(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedLayerRenderersDirty||this._frameTask.updating||Object(c.c)(this._layerRenderers,(e=>e.updating))}get hasOverlays(){return Object(l.l)(this._overlays)&&Object(l.l)(this._overlayRenderTarget)}get gpuMemoryUsage(){return Object(l.l)(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}collectUnusedRenderTargetMemory(e){let t=!1;if(Object(l.l)(this._overlayRenderTarget))for(const i of this._overlayRenderTarget.renderTargets){const r=this.overlays[0].validTargets[i.type]||!this.overlays[1].validTargets[i.type];t=this._overlayRenderTarget.validateUsageForTarget(r,i,e)||t}return t}get overlays(){return Object(l.u)(this._overlays,[])}ensureDrapeTargets(e){Object(l.l)(this._overlays)&&this._overlays.forEach((t=>{t.hasTargetWithoutRasterImage=Object(h.a)(e,(e=>1===e.drapeTargetType))}))}ensureDrapeSources(e){Object(l.l)(this._overlays)&&this._overlays.forEach((t=>{t.hasDrapedFeatureSource=Object(c.c)(e,((e,t)=>1===t.drapeSourceType)),t.hasDrapedRasterSource=Object(c.c)(e,((e,t)=>0===t.drapeSourceType))}))}ensureOverlays(e,t){Object(l.k)(this._overlays)&&(this._overlayRenderTarget=new A(this._rctx),this._overlays=[new _(0,this._overlayRenderTarget),new _(1,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=Object(l.f)(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(e,t=(()=>!0)){this._frameTask.processQueue(e),e.done||this._processLayers(e,t)}_processLayers(e,t){let i=!1;for(const[r,n]of this._layerRenderers){if(e.done)break;(r.destroyed||t(r))&&(n.commitChanges()&&(i=!0,e.madeProgress()),n.isEmpty&&(i=!0,this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(r),this._handles.remove(r)))}this.updateSortedLayerRenderers(),i&&(Object(l.l)(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}processSyncLayers(){this._processLayers(ot.c,(e=>1===e.updatePolicy))}addGeometries(e,t,i){for(const r of e)Object(l.k)(r.origin)&&(r.origin=this._localOrigins.getOrigin(r.boundingSphere)),this._geometries.set(r.id,r);this.ensureLayerRenderer(t).add(e),2===i&&this.notifyGraphicGeometryChanged(e,t)}removeGeometries(e,t,i){for(const n of e)this._geometries.delete(Object(l.t)(n.id));const r=this._layerRenderers.get(t);r&&(r.remove(e),2===i&&this.notifyGraphicGeometryChanged(e,t))}updateGeometries(e,t,i){const r=this._layerRenderers.get(t);if(r)switch(r.modify(e,i),i){case 4:case 2:return this.notifyGraphicGeometryChanged(e,t);case 1:return this.notifyGraphicVisibilityChanged(e,t)}else lt.warn("Attempted to update geometry for nonexistent layer")}notifyGraphicGeometryChanged(e,t){if(Object(l.k)(t.notifyGraphicGeometryChanged))return;let i;for(const r of e){const e=r.graphicUid;Object(l.l)(e)&&e!==i&&(t.notifyGraphicGeometryChanged(e),i=e)}}notifyGraphicVisibilityChanged(e,t){if(Object(l.k)(t.notifyGraphicVisibilityChanged))return;let i;for(const r of e){const e=r.graphicUid;Object(l.l)(e)&&e!==i&&(t.notifyGraphicVisibilityChanged(e),i=e)}}updateHighlights(e,t){const i=this._layerRenderers.get(t);i?i.modify(e,8):lt.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return 0===this._geometries.size&&!y.a.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateLogic(e){let t=!1;return this._layerRenderers.forEach((i=>t=i.updateLogic(e)||t)),t}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawTarget(e,t,i){const r=e.canvasGeometries;if(0===r.numViews)return!1;this._screenToWorldRatio=i*e.mapUnitsPerPixel;const n=t.renderPass;if(this.isEmpty()||5===n&&!this.hasHighlights||3===n&&!this.hasWater||!e.hasSomeSizedView())return!1;const a=t.fbo;if(!a.isValid())return!1;const s=2*e.resolution,o=e.resolution;a.resize(s,o);const c=this._rctx;pt.pixelRatio=e.pixelRatio*i,this._renderContext.pass=n,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=3===n?21:20,e.applyViewport(this._rctx),a.bind(c),0===e.index&&(c.setClearColor(0,0,0,0),c.clearSafe(16384));const d=1===t.type?2:4===t.type?1:0;if(1===d&&(this._renderContext.renderOccludedMask=gt),y.a.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==d)for(let l=0;l<r.numViews;l++)this.setViewParameters(r.extents[l],e,pt),this.drawDebugTexture(e.resolution,ut[e.index]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({layerView:t,renderer:i})=>{if(2===d&&Object(l.l)(t)&&0===t.drapeSourceType)return;const h=Object(l.l)(t)&&Object(l.l)(t.fullOpacity)&&t.fullOpacity<1&&0===n;h&&(this.bindTemporaryFramebuffer(this._rctx,s,o),c.clearSafe(16384));for(let n=0;n<r.numViews;n++)this.setViewParameters(r.extents[n],e,pt),i.render(this._renderContext,this._bindParameters);h&&Object(l.l)(this._temporaryFBO)&&(a.bind(c),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),2,Object(l.t)(Object(l.t)(t).fullOpacity),3,e.index))})),c.bindFramebuffer(null),a.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,i){Object(l.k)(this._temporaryFBO)&&(this._temporaryFBO=new E(e,!1)),this._temporaryFBO.resize(t,i),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}intersect(e,t,i,r){let n=0;this._geometries.forEach((a=>{if(r&&!r(a))return;this._intersectRenderGeometry(a,i,t,0,e,n);const s=this.longitudeCyclical;s&&(a.boundingSphere[0]-a.boundingSphere[3]<s.min&&this._intersectRenderGeometry(a,i,t,s.range,e,n),a.boundingSphere[0]+a.boundingSphere[3]>s.max&&this._intersectRenderGeometry(a,i,t,-s.range,e,n)),n++}))}_intersectRenderGeometry(e,t,i,r,n,a){if(!e.instanceParameters.visible)return;let s=0;Object(l.l)(e.transformation)&&(r+=e.transformation[12],s=e.transformation[13]),ft[0]=i[0]-r,ft[1]=i[1]-s,ft[2]=1,bt[0]=i[0]-r,bt[1]=i[1]-s,bt[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),n,ft,bt,((i,r,s)=>{!function(e,t,i,r,n,a,s){const o={layerUid:a,graphicUid:s,triangleNr:t},c=t=>{t.set(3,o,e.dist,e.normal,e.transformation,i,r)};if((null==n.results.min.drapedLayerOrder||i>=n.results.min.drapedLayerOrder)&&(null==n.results.min.dist||n.results.ground.dist<=n.results.min.dist)&&c(n.results.min),0!==n.options.store&&(null==n.results.max.drapedLayerOrder||i<n.results.max.drapedLayerOrder)&&(null==n.results.max.dist||n.results.ground.dist>n.results.max.dist)&&c(n.results.max),2===n.options.store){const e=Object(H.b)(n.ray);c(e),n.results.all.push(e)}}(t,s,e.material.renderPriority,a,n,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,t)}ensureLayerRenderer(e){let t=this._layerRenderers.get(e);return t||(t=new Pe({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,t),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.events.emit("content-changed"))),e),this._handles.add(Object(u.a)(t,"updating",(()=>this.notifyChange("updating"))),e)),t}updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const e=new Set(this._layerRenderers.values());this.view.allLayerViews.forEach((t=>{const i=t,r=this._layerRenderers.get(i);r&&(this._sortedLayerRenderers.push(new ht(i,r)),e.delete(r))})),e.forEach((e=>this._sortedLayerRenderers.push(new ht(null,e))))}setViewParameters(e,t,i){i.viewport[0]=i.viewport[1]=0,i.viewport[2]=i.viewport[3]=t.resolution,Object(b.p)(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),Object(b.j)(i.viewMatrix),Object(b.b)(i.viewMatrix,i.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=i,this._bindParameters.camera=i,this._bindParameters.inverseViewport[0]=1/i.fullViewport[2],this._bindParameters.inverseViewport[1]=1/i.fullViewport[3]}updateHasWater(){const e=Object(c.c)(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}updateHasHighlights(){const e=Object(c.c)(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}updateRendersOccluded(){const e=Object(c.c)(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}drawDebugTexture(e,t){const i=this._rctx;this.ensureDebugPatternResources(e,e);const r=this._debugTextureTechnique.program;i.useProgram(r),this._debugTextureTechnique.bindPipelineState(i),r.setUniform4f("color",t[0],t[1],t[2],1),r.bindTexture(this._debugPatternTexture,"tex"),i.bindVAO(this._quadVAO),i.drawArrays(5,0,Object(ct.e)(this._quadVAO,"geometry"))}ensureDebugPatternResources(e,t){if(this._debugPatternTexture)return;const i=new Uint8Array(e*t*4);let r=0;for(let a=0;a<t;a++)for(let n=0;n<e;n++){const s=Math.floor(n/10),o=Math.floor(a/10);s<2||o<2||10*s>e-20||10*o>t-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&s&&1&o?1&n^1&a?0:255:1&s^1&o?0:128)}this._debugPatternTexture=new P.a(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},i);const n=new Fe;n.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(Le,n),this._quadVAO=Object(N.b)(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};Object(r.a)([Object(p.b)()],dt.prototype,"_frameTask",void 0),Object(r.a)([Object(p.b)()],dt.prototype,"_sortedLayerRenderersDirty",void 0),Object(r.a)([(e,t)=>{var i,r;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!=(i=null==(r=e._managedDisposables)?void 0:r.slice())?i:[]),e._managedDisposables.unshift(t)}],dt.prototype,"_shaderTechniqueRepository",void 0),Object(r.a)([(e,t)=>{var i,r;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!=(i=null==(r=e._managedDisposables)?void 0:r.slice())?i:[]),e._managedDisposables.unshift(t)}],dt.prototype,"_stippleTextureRepository",void 0),Object(r.a)([Object(p.b)({constructOnly:!0})],dt.prototype,"view",void 0),Object(r.a)([Object(p.b)()],dt.prototype,"worldToPCSRatio",void 0),Object(r.a)([Object(p.b)()],dt.prototype,"spatialReference",void 0),Object(r.a)([Object(p.b)({type:Boolean,readOnly:!0})],dt.prototype,"updating",null),dt=Object(r.a)([Object(f.a)("esri.views.3d.terrain.OverlayRenderer")],dt);class ht{constructor(e,t){this.layerView=e,this.renderer=t}}const ut=[[1,.5,.5],[.5,.5,1]];const pt=new F.a;pt.near=1,pt.far=1e4,pt.relativeElevation=null;const ft=Object(g.f)(),bt=Object(g.f)(),mt=-2,gt=4}}]);
//# sourceMappingURL=83.67e1264a.chunk.js.map