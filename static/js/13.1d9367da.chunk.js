(this.webpackJsonpimaps=this.webpackJsonpimaps||[]).push([[13],{1040:function(t,e,r){"use strict";r.d(e,"a",(function(){return u})),r.d(e,"b",(function(){return d}));var i=r(237),n=r(386),s=r(514),a=r(303),o=r(617),c=r(328),h=r(112),l=r(248);function d(t){const e=new l.a;return e.include(n.a,{linearDepth:!1}),e.include(s.a,t),e.include(o.a,t),e.vertex.uniforms.add("proj","mat4").add("view","mat4"),e.attributes.add("position","vec3"),e.varyings.add("vpos","vec3"),e.vertex.code.add(h.a`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),t.stippleEnabled&&(e.attributes.add("auxpos1","vec3"),e.vertex.uniforms.add("ndcToPixel","vec2"),e.vertex.code.add(h.a`
    vec4 vpos2 = transformPosition(proj, view, auxpos1);
    float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);

    stipplePatternUv = lineSegmentPixelSize * stipplePatternPixelSizeInv;
    ${t.stippleIntegerRepeatsEnabled?"stipplePatternUv = floor(stipplePatternUv + 0.5);":""}

    // Cancel out perspective correct interpolation because we want this length the really represent
    // the screen distance
    stipplePatternUv *= gl_Position.w;
    `)),e.vertex.code.add(h.a`}`),4===t.output&&e.include(a.a),e.include(i.a,t),e.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),e.fragment.code.add(h.a`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${t.attributeColor?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${h.a.float(c.c)}) {
      discard;
    }

    ${0===t.output?h.a`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${4===t.output?h.a`outputHighlight();`:""}
  }
  `),e}var u=Object.freeze({__proto__:null,build:d})},1131:function(t,e,r){"use strict";r.d(e,"a",(function(){return L}));var i=r(80),n=r(85),s=r(102),a=r(133),o=r(103),c=r(101),h=r(320),l=r(300),d=r(338),u=r(367),p=r(373),f=r(345),g=r(178),b=r(487),m=r(573),v=r(312),_=r(350),O=r(81),y=r(237),j=r(303),x=r(366),w=r(294),T=r(301),S=r(305),R=r(302),M=r(295),C=r(495),E=r(1040),D=r(279);class P extends T.a{constructor(t,e,r){super(t,e,r),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=t.stippleTextureRepository}initializeProgram(t){const e=P.shader.get(),r=this.configuration,i=e.build({output:r.output,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,stippleEnabled:r.stippleEnabled,stippleOffColorEnabled:r.stippleOffColorEnabled,stippleUVMaxEnabled:!1,stippleIntegerRepeatsEnabled:r.stippleIntegerRepeatsEnabled});return new M.a(t.rctx,i,R.a)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(t,e){if(Object(x.c)(this.program,e.camera.projectionMatrix),this.stipplePattern!==t.stipplePattern){const e=t.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,e),this.stipplePattern=e}if(this.configuration.stippleEnabled){const t=Object(n.k)(this.stippleTextureBind)?this.stippleTextureBind(this.program)*e.camera.pixelRatio:1;this.program.setUniform1i("stipplePatternTexture",0),this.program.setUniform1f("stipplePatternPixelSizeInv",1/t),this.program.setUniform2f("ndcToPixel",e.camera.fullViewport[2]/2,e.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",t.color),this.program.setUniform1f("alphaCoverage",Math.min(1,t.width*e.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const e=Object(n.s)(t.stippleOffColor);this.program.setUniform4f("stippleOffColor",e[0],e[1],e[2],e.length>3?e[3]:1)}4===this.configuration.output&&Object(j.b)(this.program,e)}bindDraw(t){Object(x.d)(this.program,t),Object(y.c)(this.program,this.configuration,t),this.program.rebindTextures()}initializePipeline(){const t=this.configuration,e=Object(D.g)(770,1,771,771),r=(e,r=null,i=null)=>Object(D.f)({blending:r,depthTest:C.b,depthWrite:i,colorWrite:D.c,stencilWrite:t.sceneHasOcludees?C.h:null,stencilTest:t.sceneHasOcludees?e?C.d:C.c:null});return 0===t.output?(this._occludeePipelineState=r(!0,t.transparent||t.stippleEnabled?e:null,D.d),r(!1,t.transparent||t.stippleEnabled?e:null,D.d)):r(!1)}get primitiveType(){return 1}getPipelineState(t){return t?this._occludeePipelineState:this.pipeline}}P.shader=new w.a(E.a,(()=>r.e(312).then(r.bind(null,1292))));class I extends S.a{constructor(){super(...arguments),this.output=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.sceneHasOcludees=!1}}Object(O.a)([Object(S.b)({count:8})],I.prototype,"output",void 0),Object(O.a)([Object(S.b)()],I.prototype,"slicePlaneEnabled",void 0),Object(O.a)([Object(S.b)()],I.prototype,"vertexColors",void 0),Object(O.a)([Object(S.b)()],I.prototype,"transparent",void 0),Object(O.a)([Object(S.b)()],I.prototype,"stippleEnabled",void 0),Object(O.a)([Object(S.b)()],I.prototype,"stippleOffColorEnabled",void 0),Object(O.a)([Object(S.b)()],I.prototype,"stippleIntegerRepeatsEnabled",void 0),Object(O.a)([Object(S.b)()],I.prototype,"sceneHasOcludees",void 0);const A=i.a.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");class L extends f.a{constructor(t){super(t,N),this.techniqueConfig=new I}getTechniqueConfig(t){this.techniqueConfig.output=t,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.transparent=this.params.color[3]<1||this.params.width<1;const e=Object(n.k)(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=e,this.techniqueConfig.stippleOffColorEnabled=e&&Object(n.k)(this.params.stippleOffColor),this.techniqueConfig.stippleIntegerRepeatsEnabled=e&&this.params.stippleIntegerRepeats,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig}getPassParameters(){return this.params}intersect(t,e,r,i,n,s,a,o,c){c?Object(v.e)(t,i,s,1,a):this.intersectLineGeometry(t,e,r,i,a)}intersectLineGeometry(t,e,r,i,n){if(!i.options.selectionMode||Object(_.e)(e))return;if(!Object(g.g)(r))return void A.error("intersection assumes a translation-only matrix");const s=t.vertexAttributes.get("position").data,c=i.camera,d=$;Object(a.c)(d,i.point);Object(o.w)(X[0],d[0]-2,d[1]+2,0),Object(o.w)(X[1],d[0]+2,d[1]+2,0),Object(o.w)(X[2],d[0]+2,d[1]-2,0),Object(o.w)(X[3],d[0]-2,d[1]-2,0);for(let a=0;a<4;a++)if(!c.unprojectFromRenderScreen(X[a],Q[a]))return;Object(l.f)(c.eye,Q[0],Q[1],J),Object(l.f)(c.eye,Q[1],Q[2],K),Object(l.f)(c.eye,Q[2],Q[3],tt),Object(l.f)(c.eye,Q[3],Q[0],et);let u=Number.MAX_VALUE;for(let a=0;a<s.length-5;a+=3){if(F[0]=s[a]+r[12],F[1]=s[a+1]+r[13],F[2]=s[a+2]+r[14],V[0]=s[a+3]+r[12],V[1]=s[a+4]+r[13],V[2]=s[a+5]+r[14],Object(l.u)(J,F)<0&&Object(l.u)(J,V)<0||Object(l.u)(K,F)<0&&Object(l.u)(K,V)<0||Object(l.u)(tt,F)<0&&Object(l.u)(tt,V)<0||Object(l.u)(et,F)<0&&Object(l.u)(et,V)<0)continue;if(c.projectToRenderScreen(F,U),c.projectToRenderScreen(V,W),U[2]<0&&W[2]>0){Object(o.j)(k,F,V);const t=c.frustum,e=-Object(l.u)(t[4],F)/Object(o.h)(k,Object(l.r)(t[4]));Object(o.e)(k,k,e),Object(o.f)(F,F,k),c.projectToRenderScreen(F,U)}else if(U[2]>0&&W[2]<0){Object(o.j)(k,V,F);const t=c.frustum,e=-Object(l.u)(t[4],V)/Object(o.h)(k,Object(l.r)(t[4]));Object(o.e)(k,k,e),Object(o.f)(V,V,k),c.projectToRenderScreen(V,W)}else if(U[2]<0&&W[2]<0)continue;U[2]=0,W[2]=0;const t=Object(h.e)(Object(h.f)(U,W,Z),d);t<u&&(u=t,Object(o.k)(B,F),Object(o.k)(q,V))}const p=i.rayBeginPoint,f=i.rayEndPoint;if(u<4){let t=Number.MAX_VALUE;if(Object(h.a)(Object(h.f)(B,q,Z),Object(h.f)(p,f,Y),G)){Object(o.j)(G,G,p);const e=Object(o.p)(G);Object(o.e)(G,G,1/e),t=e/Object(o.m)(p,f)}n(t,G)}}computeAttachmentOrigin(t,e){const r=t.vertexAttributes;if(!r)return!1;const i=r.get("position");return Object(u.a)(i,null,!1,e)}createBufferWriter(){const t=this.params.vertexColors?m.b:m.c;return Object(n.j)(this.params.stipplePattern)?new m.a(t):new H(t.clone().vec3f("auxpos1"))}getGLMaterial(t){return 0===t.output||4===t.output?new z(t):void 0}}class z extends p.a{constructor(t){super(t),this.updateParameters()}updateParameters(){this._technique=this._techniqueRep.releaseAndAcquire(P,this._material.getTechniqueConfig(this._output),this._technique)}beginSlot(t){return 3===t}_updateOccludeeState(t){t.hasOccludees!==this._material.params.sceneHasOcludees&&(this._material.setParameterValues({sceneHasOcludees:t.hasOccludees}),this.updateParameters())}ensureParameters(t){0===this._output&&this._updateOccludeeState(t)}bind(t){this._technique.bindPass(this._material.getPassParameters(),t)}getPipelineState(t,e){return this._technique.getPipelineState(e)}}class H{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get("position").length}write(t,e,r,i){Object(b.c)(e,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,i),this.writeAuxpos1(t,e,r,i)}writeAuxpos1(t,e,r,i){const n=r.getField("auxpos1",d.u),s=e.indices.get("position"),a=e.vertexAttributes.get("position").data,o=t.transformation,c=n.typedBufferStride,h=n.typedBuffer;i*=c;for(let l=0;l<s.length;l+=2){const t=3*s[l],e=a[t],r=a[t+1],n=a[t+2],d=o[0]*e+o[4]*r+o[8]*n+o[12],u=o[1]*e+o[5]*r+o[9]*n+o[13],p=o[2]*e+o[6]*r+o[10]*n+o[14];for(let s=0;s<2;++s)h[i]=d,h[i+1]=u,h[i+2]=p,i+=c}}}const N={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,sceneHasOcludees:!1,...f.b},F=Object(c.e)(),V=Object(c.e)(),k=Object(c.e)(),G=Object(c.e)(),U=Object(s.e)(),W=Object(s.e)(),B=Object(c.e)(),q=Object(c.e)(),Z=Object(h.d)(),Y=Object(h.d)(),$=Object(c.e)(),X=[Object(s.e)(),Object(s.e)(),Object(s.e)(),Object(s.e)()],Q=[Object(c.e)(),Object(c.e)(),Object(c.e)(),Object(c.e)()],J=Object(l.d)(),K=Object(l.d)(),tt=Object(l.d)(),et=Object(l.d)()},238:function(t,e,r){"use strict";function i(){return new Float32Array(2)}function n(t,e){const r=new Float32Array(2);return r[0]=t,r[1]=e,r}function s(){return i()}function a(){return n(1,1)}function o(){return n(1,0)}function c(){return n(0,1)}r.d(e,"a",(function(){return i})),r.d(e,"b",(function(){return n}));const h=s(),l=a(),d=o(),u=c();Object.freeze({__proto__:null,create:i,clone:function(t){const e=new Float32Array(2);return e[0]=t[0],e[1]=t[1],e},fromValues:n,createView:function(t,e){return new Float32Array(t,e,2)},zeros:s,ones:a,unitX:o,unitY:c,ZEROS:h,ONES:l,UNIT_X:d,UNIT_Y:u})},477:function(t,e,r){"use strict";r.d(e,"a",(function(){return a}));var i,n,s={exports:{}};i=s,void 0!==(n=function(){function t(t,r,n){n=n||2;var s,a,o,h,l,d,u,p=r&&r.length,f=p?r[0]*n:t.length,g=e(t,0,f,n,!0),b=[];if(!g||g.next===g.prev)return b;if(p&&(g=c(t,r,g,n)),t.length>80*n){s=o=t[0],a=h=t[1];for(var m=n;m<f;m+=n)(l=t[m])<s&&(s=l),(d=t[m+1])<a&&(a=d),l>o&&(o=l),d>h&&(h=d);u=0!==(u=Math.max(o-s,h-a))?1/u:0}return i(g,b,n,s,a,u),b}function e(t,e,r,i,n){var s,a;if(n===R(t,e,r,i)>0)for(s=e;s<r;s+=i)a=w(s,t[s],t[s+1],a);else for(s=r-i;s>=e;s-=i)a=w(s,t[s],t[s+1],a);return a&&v(a,a.next)&&(T(a),a=a.next),a}function r(t,e){if(!t)return t;e||(e=t);var r,i=t;do{if(r=!1,i.steiner||!v(i,i.next)&&0!==m(i.prev,i,i.next))i=i.next;else{if(T(i),(i=e=i.prev)===i.next)break;r=!0}}while(r||i!==e);return e}function i(t,e,c,h,l,d,p){if(t){!p&&d&&u(t,h,l,d);for(var f,g,b=t;t.prev!==t.next;)if(f=t.prev,g=t.next,d?s(t,h,l,d):n(t))e.push(f.i/c),e.push(t.i/c),e.push(g.i/c),T(t),t=g.next,b=g.next;else if((t=g)===b){p?1===p?i(t=a(r(t),e,c),e,c,h,l,d,2):2===p&&o(t,e,c,h,l,d):i(r(t),e,c,h,l,d,1);break}}}function n(t){var e=t.prev,r=t,i=t.next;if(m(e,r,i)>=0)return!1;for(var n=t.next.next;n!==t.prev;){if(g(e.x,e.y,r.x,r.y,i.x,i.y,n.x,n.y)&&m(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function s(t,e,r,i){var n=t.prev,s=t,a=t.next;if(m(n,s,a)>=0)return!1;for(var o=n.x<s.x?n.x<a.x?n.x:a.x:s.x<a.x?s.x:a.x,c=n.y<s.y?n.y<a.y?n.y:a.y:s.y<a.y?s.y:a.y,h=n.x>s.x?n.x>a.x?n.x:a.x:s.x>a.x?s.x:a.x,l=n.y>s.y?n.y>a.y?n.y:a.y:s.y>a.y?s.y:a.y,d=p(o,c,e,r,i),u=p(h,l,e,r,i),f=t.prevZ,b=t.nextZ;f&&f.z>=d&&b&&b.z<=u;){if(f!==t.prev&&f!==t.next&&g(n.x,n.y,s.x,s.y,a.x,a.y,f.x,f.y)&&m(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,b!==t.prev&&b!==t.next&&g(n.x,n.y,s.x,s.y,a.x,a.y,b.x,b.y)&&m(b.prev,b,b.next)>=0)return!1;b=b.nextZ}for(;f&&f.z>=d;){if(f!==t.prev&&f!==t.next&&g(n.x,n.y,s.x,s.y,a.x,a.y,f.x,f.y)&&m(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;b&&b.z<=u;){if(b!==t.prev&&b!==t.next&&g(n.x,n.y,s.x,s.y,a.x,a.y,b.x,b.y)&&m(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function a(t,e,i){var n=t;do{var s=n.prev,a=n.next.next;!v(s,a)&&_(s,n,n.next,a)&&j(s,a)&&j(a,s)&&(e.push(s.i/i),e.push(n.i/i),e.push(a.i/i),T(n),T(n.next),n=t=a),n=n.next}while(n!==t);return r(n)}function o(t,e,n,s,a,o){var c=t;do{for(var h=c.next.next;h!==c.prev;){if(c.i!==h.i&&b(c,h)){var l=x(c,h);return c=r(c,c.next),l=r(l,l.next),i(c,e,n,s,a,o),void i(l,e,n,s,a,o)}h=h.next}c=c.next}while(c!==t)}function c(t,i,n,s){var a,o,c,d=[];for(a=0,o=i.length;a<o;a++)(c=e(t,i[a]*s,a<o-1?i[a+1]*s:t.length,s,!1))===c.next&&(c.steiner=!0),d.push(f(c));for(d.sort(h),a=0;a<d.length;a++)n=r(n=l(d[a],n),n.next);return n}function h(t,e){return t.x-e.x}function l(t,e){var i=function(t,e){var r,i=e,n=t.x,s=t.y,a=-1/0;do{if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){var o=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=n&&o>a){if(a=o,o===n){if(s===i.y)return i;if(s===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!r)return null;if(n===a)return r;var c,h=r,l=r.x,u=r.y,p=1/0;i=r;do{n>=i.x&&i.x>=l&&n!==i.x&&g(s<u?n:a,s,l,u,s<u?a:n,s,i.x,i.y)&&(c=Math.abs(s-i.y)/(n-i.x),j(i,t)&&(c<p||c===p&&(i.x>r.x||i.x===r.x&&d(r,i)))&&(r=i,p=c)),i=i.next}while(i!==h);return r}(t,e);if(!i)return e;var n=x(i,t),s=r(i,i.next);return r(n,n.next),e===i?s:e}function d(t,e){return m(t.prev,t,e.prev)<0&&m(e.next,t,t.next)<0}function u(t,e,r,i){var n=t;do{if(null===n.z&&(n.z=p(n.x,n.y,e,r,i)),n.prev.next!==n||n.next.prev!==n)return n.prev.next=n,n.next.prev=n,u(t,e,r,i);n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==t);n.prevZ.nextZ=null,n.prevZ=null,function(t){var e,r,i,n,s,a,o,c,h=1;do{for(r=t,t=null,s=null,a=0;r;){for(a++,i=r,o=0,e=0;e<h&&(o++,i=i.nextZ);e++);for(c=h;o>0||c>0&&i;)0!==o&&(0===c||!i||r.z<=i.z)?(n=r,r=r.nextZ,o--):(n=i,i=i.nextZ,c--),s?s.nextZ=n:t=n,n.prevZ=s,s=n;r=i}s.nextZ=null,h*=2}while(a>1)}(n)}function p(t,e,r,i,n){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*n)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*n)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function f(t){var e=t,r=t;do{(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next}while(e!==t);return r}function g(t,e,r,i,n,s,a,o){return(n-a)*(e-o)-(t-a)*(s-o)>=0&&(t-a)*(i-o)-(r-a)*(e-o)>=0&&(r-a)*(s-o)-(n-a)*(i-o)>=0}function b(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&_(r,r.next,t,e))return!0;r=r.next}while(r!==t);return!1}(t,e)&&(j(t,e)&&j(e,t)&&function(t,e){var r=t,i=!1,n=(t.x+e.x)/2,s=(t.y+e.y)/2;do{r.y>s!=r.next.y>s&&r.next.y!==r.y&&n<(r.next.x-r.x)*(s-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==t);return i}(t,e)&&(m(t.prev,t,e.prev)||m(t,e.prev,e))||v(t,e)&&m(t.prev,t,t.next)>0&&m(e.prev,e,e.next)>0)}function m(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function v(t,e){return t.x===e.x&&t.y===e.y}function _(t,e,r,i){var n=y(m(t,e,r)),s=y(m(t,e,i)),a=y(m(r,i,t)),o=y(m(r,i,e));return n!==s&&a!==o||!(0!==n||!O(t,r,e))||!(0!==s||!O(t,i,e))||!(0!==a||!O(r,t,i))||!(0!==o||!O(r,e,i))}function O(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)}function y(t){return t>0?1:t<0?-1:0}function j(t,e){return m(t.prev,t,t.next)<0?m(t,e,t.next)>=0&&m(t,t.prev,e)>=0:m(t,e,t.prev)<0||m(t,t.next,e)<0}function x(t,e){var r=new S(t.i,t.x,t.y),i=new S(e.i,e.x,e.y),n=t.next,s=e.prev;return t.next=e,e.prev=t,r.next=n,n.prev=r,i.next=r,r.prev=i,s.next=i,i.prev=s,i}function w(t,e,r,i){var n=new S(t,e,r);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function T(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function S(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function R(t,e,r,i){for(var n=0,s=e,a=r-i;s<r;s+=i)n+=(t[a]-t[s])*(t[s+1]+t[a+1]),a=s;return n}return t.deviation=function(t,e,r,i){var n=e&&e.length,s=n?e[0]*r:t.length,a=Math.abs(R(t,0,s,r));if(n)for(var o=0,c=e.length;o<c;o++){var h=e[o]*r,l=o<c-1?e[o+1]*r:t.length;a-=Math.abs(R(t,h,l,r))}var d=0;for(o=0;o<i.length;o+=3){var u=i[o]*r,p=i[o+1]*r,f=i[o+2]*r;d+=Math.abs((t[u]-t[f])*(t[p+1]-t[u+1])-(t[u]-t[p])*(t[f+1]-t[u+1]))}return 0===a&&0===d?0:Math.abs((d-a)/a)},t.flatten=function(t){for(var e=t[0][0].length,r={vertices:[],holes:[],dimensions:e},i=0,n=0;n<t.length;n++){for(var s=0;s<t[n].length;s++)for(var a=0;a<e;a++)r.vertices.push(t[n][s][a]);n>0&&(i+=t[n-1].length,r.holes.push(i))}return r},t}())&&(i.exports=n);var a=s.exports},542:function(t,e,r){"use strict";r.d(e,"a",(function(){return s})),r.d(e,"b",(function(){return a})),r.d(e,"c",(function(){return c})),r.d(e,"d",(function(){return o}));var i=r(389),n=r(112);function s(t){t.fragment.include(i.a),t.fragment.uniforms.add("uShadowMapTex","sampler2D"),t.fragment.uniforms.add("uShadowMapNum","int"),t.fragment.uniforms.add("uShadowMapDistance","vec4"),t.fragment.uniforms.add("uShadowMapMatrix","mat4",4),t.fragment.uniforms.add("uDepthHalfPixelSz","float"),t.fragment.code.add(n.a`int chooseCascade(float _linearDepth, out mat4 mat) {
vec4 distance = uShadowMapDistance;
float depth = _linearDepth;
int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;
mat = i == 0 ? uShadowMapMatrix[0] : i == 1 ? uShadowMapMatrix[1] : i == 2 ? uShadowMapMatrix[2] : uShadowMapMatrix[3];
return i;
}
vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
vec4 lv = mat * vec4(_vpos, 1.0);
lv.xy /= lv.w;
return 0.5 * lv.xyz + vec3(0.5);
}
vec2 cascadeCoordinates(int i, vec3 lvpos) {
return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;
}
float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {
return rgba2float(texture2D(_depthTex, uv));
}
float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {
return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;
}
float filterShadow(vec2 uv, vec3 lvpos, float halfPixelSize, sampler2D _depthTex) {
float texSize = 0.5 / halfPixelSize;
vec2 st = fract((vec2(halfPixelSize) + uv) * texSize);
float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);
float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float readShadowMap(const in vec3 _vpos, float _linearDepth) {
mat4 mat;
int i = chooseCascade(_linearDepth, mat);
if (i >= uShadowMapNum) { return 0.0; }
vec3 lvpos = lightSpacePosition(_vpos, mat);
if (lvpos.z >= 1.0) { return 0.0; }
if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }
vec2 uv = cascadeCoordinates(i, lvpos);
return filterShadow(uv, lvpos, uDepthHalfPixelSz, uShadowMapTex);
}`)}function a(t,e){e.shadowMappingEnabled&&(e.shadowMap.bind(t),e.shadowMap.bindView(t,e.origin))}function o(t,e,r){e.shadowMappingEnabled&&e.shadowMap.bindView(t,r)}function c(t,e){e.shadowMappingEnabled&&e.shadowMap.bindView(t,e.origin)}},638:function(t,e,r){"use strict";var i=r(80),n=r(109),s=r(85),a=r(102),o=r(142),c=r(153),h=r(133),l=r(177),d=r(103),u=r(101),p=r(191),f=r(183),g=r(486),b=r(256),m=r(429),v=r(178);const _=i.a.getLogger("esri.views.3d.webgl-engine.lib.Camera");class O{constructor(t=null,e=null,r=null){this._viewUp=Object(u.e)(),this._viewForward=Object(u.e)(),this._viewRight=Object(u.e)(),this._ray=Object(b.c)(),this._viewport=Object(f.g)(0,0,1,1),this._padding=Object(f.g)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Object(l.e)(1,1e3),this._viewDirty=!0,this._viewMatrix=Object(c.d)(),this._projectionDirty=!0,this._projectionMatrix=Object(c.d)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Object(c.d)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Object(c.d)(),this._frustumDirty=!0,this._frustum=Object(g.b)(),this._fullViewport=Object(f.e)(),this.pixelRatio=1,this.relativeElevation=0,Object(s.k)(t)&&Object(d.k)(this._ray.origin,t),this._center=Object(s.k)(e)?Object(u.c)(e):Object(u.e)(),this._up=Object(s.k)(r)?Object(u.c)(r):Object(u.g)(0,0,1)}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center)}get ray(){return Object(d.j)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){Object(o.d)(this._viewMatrix,t),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get x(){return this._viewport[0]}set x(t){t+=this._padding[3],this._viewport[0]!==t&&(this._viewport[0]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(t){t+=this._padding[2],this._viewport[1]!==t&&(this._viewport[1]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(t){this.width=t-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(t){this.height=t-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){this._padding[0]===t[0]&&this._padding[1]===t[1]&&this._padding[2]===t[2]&&this._padding[3]===t[3]||(this._viewport[0]+=t[3]-this._padding[3],this._viewport[1]+=t[2]-this._padding[2],this._viewport[2]-=t[1]+t[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=t[0]+t[2]-(this._padding[0]+this._padding[2]),Object(p.c)(this._padding,t),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&(Object(o.m)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const t=this.width,e=this.height,r=this.near*Math.tan(this.fovY/2),i=r*this.aspect;Object(o.k)(this._projectionMatrix,-i*(1+2*this._padding[3]/t),i*(1+2*this._padding[1]/t),-r*(1+2*this._padding[2]/e),r*(1+2*this._padding[0]/e),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}set projectionMatrix(t){Object(o.d)(this._projectionMatrix,t),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(t){this._fov=t,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Object(v.b)(this._fov,this.width,this.height)}set fovX(t){this._fov=Object(v.d)(t,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Object(v.c)(this._fov,this.width,this.height)}set fovY(t){this._fov=Object(v.e)(t,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return Object(d.m)(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Object(o.a)(this._viewInverseTransposeMatrix,this.viewMatrix),Object(o.e)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(t){Object(d.k)(this._ray.origin,t.eye),Object(d.k)(this._center,t.center),Object(d.k)(this._up,t.up),Object(p.c)(this._viewport,t.viewport),Object(p.c)(this._padding,t.padding),Object(h.c)(this._nearFar,t.nearFar),this._fov=t.fov,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(Object(o.d)(this._viewMatrix,t.viewMatrix),Object(d.k)(this._viewRight,t.viewRight),Object(d.k)(this._viewUp,t.viewUp),Object(d.k)(this._viewForward,t.viewForward)),e._projectionDirty?this._projectionDirty=!0:(Object(o.d)(this._projectionMatrix,t.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(Object(g.a)(t.frustum,this._frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(Object(o.d)(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Object(p.c)(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up}clone(){return(new O).copyFrom(this)}equals(t){return Object(d.o)(this.eye,t.eye)&&Object(d.o)(this._center,t.center)&&Object(d.o)(this._up,t.up)&&Object(p.g)(this._viewport,t.viewport)&&Object(p.g)(this._padding,t.padding)&&Object(h.k)(this._nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation}almostEquals(t){if(this.pixelRatio!==t.pixelRatio||Math.abs(t.fov-this._fov)>=.001)return!1;const e=5e-4;Object(d.A)(x,t.eye,t.center),Object(d.A)(w,this.eye,this._center);const r=Object(d.h)(x,w),i=Object(d.B)(x),n=Object(d.B)(w);return r*r>=(1-1e-10)*i*n&&Object(d.C)(t.eye,this.eye)<Math.max(i,n)*e*e&&Object(p.i)(t.padding,this._padding)<.5&&Object(p.i)(t.viewport,this._viewport)<.5}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this.viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this.viewDirectionDistance(t))}viewDirectionDistance(t){return Math.abs(Object(m.d)(this.viewForward,Object(d.j)(x,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=Object(a.g)()){return t[0]=(this.padding[3]+this.width/2)/this.pixelRatio,t[1]=(this.padding[0]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,r=.5){return t||(t=Object(a.e)()),t[0]=this.padding[3]+this.width*e,t[1]=this.padding[2]+this.height*r,t.length>2&&(t[2]=.5),t}setGLViewport(t){const e=this.viewport,r=this.padding;t.setViewport(e[0]-r[3],e[1]-r[2],e[2]+r[1]+r[3],e[3]+r[0]+r[2])}applyProjection(t,e,r=!1){t!==y&&Object(d.k)(y,t),y[3]=1,r&&(e[2]=-y[2]),Object(p.m)(y,y,this.projectionMatrix),Object(d.e)(y,y,1/Math.abs(y[3]));const i=this.fullViewport;return e[0]=Object(n.m)(0,i[0]+i[2],.5+.5*y[0]),e[1]=Object(n.m)(0,i[1]+i[3],.5+.5*y[1]),r||(e[2]=.5*(y[2]+1)),e}projectToScreen(t,e){this.projectToRenderScreen(t,T),this.renderToScreen(T,e)}projectToRenderScreen(t,e){if(y[0]=t[0],y[1]=t[1],y[2]=t[2],y[3]=1,Object(p.m)(y,y,this.viewProjectionMatrix),0===y[3])return null;Object(d.e)(y,y,1/Math.abs(y[3]));const r=this.fullViewport;return"x"in e?(e.x=Object(n.m)(0,r[0]+r[2],.5+.5*y[0]),e.y=Object(n.m)(0,r[1]+r[3],.5+.5*y[1])):(e[0]=Object(n.m)(0,r[0]+r[2],.5+.5*y[0]),e[1]=Object(n.m)(0,r[1]+r[3],.5+.5*y[1]),e.length>2&&(e[2]=.5*(y[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,T),e)}unprojectFromRenderScreen(t,e){if(Object(o.m)(j,this.projectionMatrix,this.viewMatrix),!Object(o.a)(j,j))return null;const r=this.fullViewport;return y[0]=2*(t[0]-r[0])/r[2]-1,y[1]=2*(t[1]-r[1])/r[3]-1,y[2]=2*t[2]-1,y[3]=1,Object(p.m)(y,y,j),0===y[3]?null:(e[0]=y[0]/y[3],e[1]=y[1]/y[3],e[2]=y[2]/y[3],e)}constrainWindowSize(t,e,r,i=r){const n=t*this.pixelRatio,s=e*this.pixelRatio,a=Math.max(n-r/2,0),o=Math.max(this.fullHeight-s-i/2,0),c=-Math.min(n-r/2,0),h=-Math.min(this.fullHeight-s-i/2,0);return[a,o,r-c- -Math.min(this.fullWidth-n-r/2,0),i-h- -Math.min(s-i/2,0)]}computeUp(t){1===t?this.computeUpGlobal():this.computeUpLocal()}screenToRender(t,e){const r=t[0]*this.pixelRatio,i=this.fullHeight-t[1]*this.pixelRatio;return e[0]=r,e[1]=i,e}renderToScreen(t,e){const r=t[0]/this.pixelRatio,i=(this.fullHeight-t[1])/this.pixelRatio;e[0]=r,e[1]=i}computeUpGlobal(){Object(d.j)(x,this.center,this.eye);const t=Object(d.p)(this.center);t<1?(Object(d.w)(this._up,0,0,1),this._markViewDirty()):Math.abs(Object(d.h)(x,this.center))>.9999*Object(d.p)(x)*t||(Object(d.g)(this._up,x,this.center),Object(d.g)(this._up,this._up,x),Object(d.r)(this._up,this._up),this._markViewDirty())}computeUpLocal(){Object(d.v)(x,this.eye,this.center),Math.abs(x[2])<=.9999&&(Object(d.e)(x,x,x[2]),Object(d.w)(this._up,-x[0],-x[1],1-x[2]),Object(d.r)(this._up,this._up),this._markViewDirty())}_compareAndSetView(t,e){"number"==typeof t[0]&&isFinite(t[0])&&"number"==typeof t[1]&&isFinite(t[1])&&"number"==typeof t[2]&&isFinite(t[2])?Object(d.o)(t,e)||(Object(d.k)(e,t),this._markViewDirty()):_.warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(Object(g.c)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(Object(o.l)(this._viewMatrix,this.eye,this._center,this._up),Object(d.w)(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),Object(d.w)(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),Object(d.w)(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const y=Object(f.e)(),j=Object(c.d)(),x=Object(u.e)(),w=Object(u.e)(),T=Object(a.e)();e.a=O},639:function(t,e,r){"use strict";r.d(e,"a",(function(){return n}));var i=r(112);function n(t,e){0===e.output&&e.receiveShadows?(t.varyings.add("linearDepth","float"),t.vertex.code.add(i.a`void forwardLinearDepth() { linearDepth = gl_Position.w; }`)):1===e.output||3===e.output?(t.varyings.add("linearDepth","float"),t.vertex.uniforms.add("cameraNearFar","vec2"),t.vertex.code.add(i.a`void forwardLinearDepth() {
linearDepth = (-position_view().z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);
}`)):t.vertex.code.add(i.a`void forwardLinearDepth() {}`)}},664:function(t,e,r){"use strict";r.d(e,"a",(function(){return a}));var i=r(112);function n(t){const e=t.fragment.code;e.add(i.a`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)
{
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),e.add(i.a`float integratedRadiance(float cosTheta2, float roughness)
{
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),e.add(i.a`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)
{
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)}var s=r(552);function a(t,e){const r=t.fragment.code;t.include(s.a),3===e.pbrMode||4===e.pbrMode?(r.add(i.a`
    struct PBRShadingWater
    {
        float NdotL;   // cos angle between normal and light direction
        float NdotV;   // cos angle between normal and view direction
        float NdotH;   // cos angle between normal and half vector
        float VdotH;   // cos angle between view direction and half vector
        float LdotH;   // cos angle between light direction and half vector
        float VdotN;   // cos angle between view direction and normal vector
    };

    float dtrExponent = ${e.useCustomDTRExponentForWater?"2.2":"2.0"};
    `),r.add(i.a`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),r.add(i.a`float normalDistributionWater(float NdotH, float roughness)
{
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),r.add(i.a`float geometricOcclusionKelemen(float LoH)
{
return 0.25 / (LoH * LoH);
}`),r.add(i.a`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)
{
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}
vec3 tonemapACES(const vec3 x) {
return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);
}`)):1!==e.pbrMode&&2!==e.pbrMode||(t.include(n),r.add(i.a`struct PBRShadingInfo
{
float NdotL;
float NdotV;
float NdotH;
float VdotH;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),r.add(i.a`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),r.add(i.a`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`),r.add(i.a`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`),r.add(i.a`float gamutMapChanel(float x, vec2 p){
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),r.add(i.a`vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){
vec3 outColor;
vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));
outColor.x = gamutMapChanel(inColor.x, p) ;
outColor.y = gamutMapChanel(inColor.y, p) ;
outColor.z = gamutMapChanel(inColor.z, p) ;
return outColor;
}`))}},686:function(t,e,r){"use strict";var i=r(81),n=r(93),s=r(83),a=(r(79),r(84),r(80),r(82));let o=class extends n.a{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_UPDATE_THRESHOLDS=!1,this.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET=!1,this.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.ENABLE_PROFILE_DEPTH_RANGE=!1,this.DISABLE_FAST_UPDATES=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1}};Object(i.a)([Object(s.b)()],o.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),Object(i.a)([Object(s.b)()],o.prototype,"SCENEVIEW_LOCKING_LOG",void 0),Object(i.a)([Object(s.b)()],o.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),Object(i.a)([Object(s.b)()],o.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),Object(i.a)([Object(s.b)()],o.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),Object(i.a)([Object(s.b)()],o.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),Object(i.a)([Object(s.b)()],o.prototype,"DECONFLICTOR_SHOW_GRID",void 0),Object(i.a)([Object(s.b)()],o.prototype,"LABELS_SHOW_BORDER",void 0),Object(i.a)([Object(s.b)()],o.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),Object(i.a)([Object(s.b)()],o.prototype,"OVERLAY_SHOW_CENTER",void 0),Object(i.a)([Object(s.b)()],o.prototype,"SHOW_POI",void 0),Object(i.a)([Object(s.b)()],o.prototype,"TESTS_DISABLE_UPDATE_THRESHOLDS",void 0),Object(i.a)([Object(s.b)()],o.prototype,"DISABLE_DECONFLICTOR_VISIBILITY_OFFSET",void 0),Object(i.a)([Object(s.b)()],o.prototype,"DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES",void 0),Object(i.a)([Object(s.b)()],o.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),Object(i.a)([Object(s.b)()],o.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),Object(i.a)([Object(s.b)()],o.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),Object(i.a)([Object(s.b)()],o.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),Object(i.a)([Object(s.b)()],o.prototype,"I3S_TREE_SHOW_TILES",void 0),Object(i.a)([Object(s.b)()],o.prototype,"I3S_SHOW_MODIFICATIONS",void 0),Object(i.a)([Object(s.b)()],o.prototype,"ENABLE_PROFILE_DEPTH_RANGE",void 0),Object(i.a)([Object(s.b)()],o.prototype,"DISABLE_FAST_UPDATES",void 0),Object(i.a)([Object(s.b)()],o.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),Object(i.a)([Object(s.b)()],o.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),Object(i.a)([Object(s.b)()],o.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),o=Object(i.a)([Object(a.a)("esri.views.3d.support.DebugFlags")],o);const c=new o;e.a=c},687:function(t,e,r){"use strict";r.d(e,"a",(function(){return b})),r.d(e,"b",(function(){return m})),r.d(e,"c",(function(){return C})),r.d(e,"d",(function(){return v})),r.d(e,"e",(function(){return y})),r.d(e,"f",(function(){return M})),r.d(e,"g",(function(){return j})),r.d(e,"h",(function(){return P})),r.d(e,"i",(function(){return D})),r.d(e,"j",(function(){return _}));r(79);var i=r(80),n=r(109),s=r(324),a=r(142),o=r(153),c=r(103),h=r(101),l=r(320),d=r(300),u=r(256),p=r(429),f=r(209);const g=i.a.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");function b(t=H){return{plane:Object(d.d)(t.plane),origin:Object(h.c)(t.origin),basis1:Object(h.c)(t.basis1),basis2:Object(h.c)(t.basis2)}}function m(t,e=b()){return v(t.origin,t.basis1,t.basis2,e)}function v(t,e,r,i=b()){return Object(c.k)(i.origin,t),Object(c.k)(i.basis1,e),Object(c.k)(i.basis2,r),_(i),function(t,e){Math.abs(Object(c.h)(t.basis1,t.basis2)/(Object(c.p)(t.basis1)*Object(c.p)(t.basis2)))>1e-6&&g.warn(e,"Provided basis vectors are not perpendicular"),Math.abs(Object(c.h)(t.basis1,P(t)))>1e-6&&g.warn(e,"Basis vectors and plane normal are not perpendicular"),Math.abs(-Object(c.h)(P(t),t.origin)-t.plane[3])>1e-6&&g.warn(e,"Plane offset is not consistent with plane origin")}(i,"fromValues()"),i}function _(t){Object(d.i)(t.basis2,t.basis1,t.origin,t.plane)}function O(t,e,r){t!==r&&m(t,r);const i=Object(c.e)(f.d.get(),P(t),e);return Object(c.f)(r.origin,r.origin,i),r.plane[3]-=e,r}function y(t,e=b()){const r=(t[2]-t[0])/2,i=(t[3]-t[1])/2;return Object(c.w)(e.origin,t[0]+r,t[1]+i,0),Object(c.w)(e.basis1,r,0,0),Object(c.w)(e.basis2,0,i,0),Object(d.h)(0,0,1,0,e.plane),e}function j(t,e,r){return!!Object(d.m)(t.plane,e,r)&&I(t,r)}function x(t,e,r){const i=N.get();z(t,e,i,N.get());let s=Number.POSITIVE_INFINITY;for(const a of G){const o=L(t,a,F.get()),h=f.d.get();if(Object(d.k)(i,o,h)){const t=Object(c.v)(f.d.get(),e.origin,h),i=Math.abs(Object(n.b)(Object(c.h)(e.direction,t)));i<s&&(s=i,Object(c.k)(r,h))}}return s===Number.POSITIVE_INFINITY?w(t,e,r):r}function w(t,e,r){if(j(t,e,r))return r;const i=N.get(),n=N.get();z(t,e,i,n);let s=Number.POSITIVE_INFINITY;for(const a of G){const o=L(t,a,F.get()),h=f.d.get();if(Object(d.l)(i,o,h)){const t=Object(u.d)(e,h);if(!Object(d.o)(n,h))continue;t<s&&(s=t,Object(c.k)(r,h))}}return R(t,e.origin)<s&&T(t,e.origin,r),r}function T(t,e,r){const i=Object(d.s)(t.plane,e,f.d.get()),n=Object(l.i)(A(t,t.basis1),i,-1,1,f.d.get()),s=Object(l.i)(A(t,t.basis2),i,-1,1,f.d.get());return Object(c.j)(r,Object(c.f)(f.d.get(),n,s),t.origin),r}function S(t,e,r){const{origin:i,basis1:n,basis2:s}=t,a=Object(c.j)(f.d.get(),e,i),o=Object(p.d)(n,a),h=Object(p.d)(s,a),l=Object(p.d)(P(t),a);return Object(c.w)(r,o,h,l)}function R(t,e){const r=S(t,e,f.d.get()),{basis1:i,basis2:n}=t,s=Object(c.p)(i),a=Object(c.p)(n),o=Math.max(Math.abs(r[0])-s,0),h=Math.max(Math.abs(r[1])-a,0),l=r[2];return o*o+h*h+l*l}function M(t,e){return Math.sqrt(R(t,e))}function C(t,e){return Object(d.o)(t.plane,e)&&I(t,e)}function E(t,e){const r=-t.plane[3];return Object(p.d)(P(t),e)-r}function D(t,e,r,i){return t!==i&&m(t,i),Object(a.c)(W,Object(a.i)(W),e,r),Object(c.q)(i.basis1,t.basis1,W),Object(c.q)(i.basis2,t.basis2,W),_(i),i}function P(t){return Object(d.r)(t.plane)}function I(t,e){const r=Object(c.j)(f.d.get(),e,t.origin),i=Object(c.t)(t.basis1),n=Object(c.t)(t.basis2),s=Object(c.h)(t.basis1,r),a=Object(c.h)(t.basis2,r);return-s-i<0&&s-i<0&&-a-n<0&&a-n<0}function A(t,e){const r=F.get();return Object(c.k)(r.origin,t.origin),Object(c.k)(r.vector,e),r}function L(t,e,r){const{basis1:i,basis2:n,origin:s}=t,a=Object(c.e)(f.d.get(),i,e.origin[0]),o=Object(c.e)(f.d.get(),n,e.origin[1]);Object(c.f)(r.origin,a,o),Object(c.f)(r.origin,r.origin,s);const h=Object(c.e)(f.d.get(),i,e.direction[0]),l=Object(c.e)(f.d.get(),n,e.direction[1]);return Object(c.e)(r.vector,Object(c.f)(h,h,l),2),r}function z(t,e,r,i){const n=P(t);Object(d.i)(n,e.direction,e.origin,r),Object(d.i)(Object(d.r)(r),n,e.origin,i)}const H={plane:Object(d.d)(),origin:Object(h.g)(0,0,0),basis1:Object(h.g)(1,0,0),basis2:Object(h.g)(0,1,0)},N=new s.a(d.d),F=new s.a(l.d),V=Object(h.e)(),k=new s.a((()=>({origin:null,basis1:null,basis2:null,plane:null}))),G=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],U=Object(o.d)(),W=Object(o.d)();Object.freeze({__proto__:null,BoundedPlaneClass:class{constructor(){this.plane=Object(d.d)(),this.origin=Object(h.e)(),this.basis1=Object(h.e)(),this.basis2=Object(h.e)()}},create:b,wrap:function(t,e,r){const i=k.get();return i.origin=t,i.basis1=e,i.basis2=r,i.plane=Object(d.v)(0,0,0,0),_(i),i},copy:m,copyWithoutVerify:function(t,e){Object(c.k)(e.origin,t.origin),Object(c.k)(e.basis1,t.basis1),Object(c.k)(e.basis2,t.basis2),Object(d.c)(t.plane,e.plane)},fromValues:v,updateUnboundedPlane:_,elevate:O,setExtent:function(t,e,r){return y(e,r),O(r,E(t,t.origin),r),r},fromAABoundingRect:y,intersectRay:j,intersectRayClosestSilhouette:function(t,e,r){if(j(t,e,r))return r;const i=x(t,e,f.d.get());return Object(c.f)(r,e.origin,Object(c.e)(f.d.get(),e.direction,Object(c.m)(e.origin,i)/Object(c.p)(e.direction))),r},closestPointOnSilhouette:x,closestPoint:w,projectPoint:T,projectPointLocal:S,distance2:R,distance:M,distanceToSilhouette:function(t,e){let r=Number.NEGATIVE_INFINITY;for(const i of G){const n=L(t,i,F.get()),s=Object(l.e)(n,e);s>r&&(r=s)}return Math.sqrt(r)},extrusionContainsPoint:C,axisAt:function(t,e,r,i){return function(t,e,r){switch(e){case 0:Object(c.k)(r,t.basis1),Object(c.r)(r,r);break;case 1:Object(c.k)(r,t.basis2),Object(c.r)(r,r);break;case 2:Object(c.k)(r,P(t))}return r}(t,r,i)},altitudeAt:E,setAltitudeAt:function(t,e,r,i){const n=E(t,e),s=Object(c.e)(V,P(t),r-n);return Object(c.f)(i,e,s),i},equals:function(t,e){return Object(c.o)(t.basis1,e.basis1)&&Object(c.o)(t.basis2,e.basis2)&&Object(c.o)(t.origin,e.origin)},transform:function(t,e,r){return t!==r&&m(t,r),Object(a.a)(U,e),Object(a.e)(U,U),Object(c.q)(r.basis1,t.basis1,U),Object(c.q)(r.basis2,t.basis2,U),Object(c.q)(Object(d.r)(r.plane),Object(d.r)(t.plane),U),Object(c.q)(r.origin,t.origin,e),Object(d.t)(r.plane,r.origin,r.plane),r},rotate:D,normal:P,UP:H})},689:function(t,e,r){"use strict";r.d(e,"a",(function(){return g})),r.d(e,"b",(function(){return _})),r.d(e,"c",(function(){return v}));var i=r(85),n=r(278),s=r(283),a=r(142),o=r(153),c=r(496),h=r(359),l=r(103),d=r(456),u=r(101),p=r(183),f=r(372);class g{constructor(){this._transform=Object(o.d)(),this._transformInverse=new b({value:this._transform},a.a,o.d),this._transformInverseTranspose=new b(this._transformInverse,a.e,o.d),this._transformTranspose=new b({value:this._transform},a.e,o.d),this._transformInverseRotation=new b({value:this._transform},n.j,s.b)}invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(t){Object(a.d)(this._transform,t)}multiplyTransform(t){Object(a.m)(this._transform,this._transform,t)}set(t){Object(a.d)(this._transform,t),this.invalidateLazyTransforms()}setAndInvalidateLazyTransforms(t,e){this.setTransformMatrix(t),this.multiplyTransform(e),this.invalidateLazyTransforms()}}class b{constructor(t,e,r){this.original=t,this.update=e,this.dirty=!0,this.transform=r()}invalidate(){this.dirty=!0}get value(){return this.dirty&&(this.update(this.transform,this.original.value),this.dirty=!1),this.transform}}const m=new class{constructor(t=0){this.offset=t,this.sphere=Object(f.b)(),this.tmpVertex=Object(u.e)()}applyToVertex(t,e,r){const i=this.objectTransform.transform;let n=i[0]*t+i[4]*e+i[8]*r+i[12],s=i[1]*t+i[5]*e+i[9]*r+i[13],a=i[2]*t+i[6]*e+i[10]*r+i[14];const o=this.offset/Math.sqrt(n*n+s*s+a*a);n+=n*o,s+=s*o,a+=a*o;const c=this.objectTransform.inverse;return this.tmpVertex[0]=c[0]*n+c[4]*s+c[8]*a+c[12],this.tmpVertex[1]=c[1]*n+c[5]*s+c[9]*a+c[13],this.tmpVertex[2]=c[2]*n+c[6]*s+c[10]*a+c[14],this.tmpVertex}applyToMinMax(t,e){const r=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*r,t[1]+=t[1]*r,t[2]+=t[2]*r;const i=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*i,e[1]+=e[1]*i,e[2]+=e[2]*i}applyToAabb(t){const e=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*e,t[1]+=t[1]*e,t[2]+=t[2]*e;const r=this.offset/Math.sqrt(t[3]*t[3]+t[4]*t[4]+t[5]*t[5]);return t[3]+=t[3]*r,t[4]+=t[4]*r,t[5]+=t[5]*r,t}applyToBoundingSphere(t){const e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),r=this.offset/e;return this.sphere[0]=t[0]+t[0]*r,this.sphere[1]=t[1]+t[1]*r,this.sphere[2]=t[2]+t[2]*r,this.sphere[3]=t[3]+t[3]*this.offset/e,this.sphere}};function v(t){return Object(i.k)(t)?(m.offset=t,m):null}new class{constructor(t=0){this.offset=t,this.componentLocalOriginLength=0,this.tmpVertex=Object(u.e)(),this.mbs=Object(p.e)(),this.obb={center:Object(u.e)(),halfSize:Object(d.b)(),quaternion:null}}set localOrigin(t){this.componentLocalOriginLength=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}applyToVertex(t,e,r){const i=t,n=e,s=r+this.componentLocalOriginLength,a=this.offset/Math.sqrt(i*i+n*n+s*s);return this.tmpVertex[0]=t+i*a,this.tmpVertex[1]=e+n*a,this.tmpVertex[2]=r+s*a,this.tmpVertex}applyToAabb(t){const e=t[0],r=t[1],i=t[2]+this.componentLocalOriginLength,n=t[3],s=t[4],a=t[5]+this.componentLocalOriginLength,o=this.offset/Math.sqrt(e*e+r*r+i*i);t[0]+=e*o,t[1]+=r*o,t[2]+=i*o;const c=this.offset/Math.sqrt(n*n+s*s+a*a);return t[3]+=n*c,t[4]+=s*c,t[5]+=a*c,t}applyToMbs(t){const e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),r=this.offset/e;return this.mbs[0]=t[0]+t[0]*r,this.mbs[1]=t[1]+t[1]*r,this.mbs[2]=t[2]+t[2]*r,this.mbs[3]=t[3]+t[3]*this.offset/e,this.mbs}applyToObb(t){const e=t.center,r=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);this.obb.center[0]=e[0]+e[0]*r,this.obb.center[1]=e[1]+e[1]*r,this.obb.center[2]=e[2]+e[2]*r,Object(l.u)(this.obb.halfSize,t.halfSize,t.quaternion),Object(l.f)(this.obb.halfSize,this.obb.halfSize,t.center);const i=this.offset/Math.sqrt(this.obb.halfSize[0]*this.obb.halfSize[0]+this.obb.halfSize[1]*this.obb.halfSize[1]+this.obb.halfSize[2]*this.obb.halfSize[2]);return this.obb.halfSize[0]+=this.obb.halfSize[0]*i,this.obb.halfSize[1]+=this.obb.halfSize[1]*i,this.obb.halfSize[2]+=this.obb.halfSize[2]*i,Object(l.j)(this.obb.halfSize,this.obb.halfSize,t.center),Object(c.a)(O,t.quaternion),Object(l.u)(this.obb.halfSize,this.obb.halfSize,O),this.obb.halfSize[0]*=this.obb.halfSize[0]<0?-1:1,this.obb.halfSize[1]*=this.obb.halfSize[1]<0?-1:1,this.obb.halfSize[2]*=this.obb.halfSize[2]<0?-1:1,this.obb.quaternion=t.quaternion,this.obb}};new class{constructor(t=0){this.offset=t,this.tmpVertex=Object(u.e)()}applyToVertex(t,e,r){const i=t+this.localOrigin[0],n=e+this.localOrigin[1],s=r+this.localOrigin[2],a=this.offset/Math.sqrt(i*i+n*n+s*s);return this.tmpVertex[0]=t+i*a,this.tmpVertex[1]=e+n*a,this.tmpVertex[2]=r+s*a,this.tmpVertex}applyToAabb(t){const e=t[0]+this.localOrigin[0],r=t[1]+this.localOrigin[1],i=t[2]+this.localOrigin[2],n=t[3]+this.localOrigin[0],s=t[4]+this.localOrigin[1],a=t[5]+this.localOrigin[2],o=this.offset/Math.sqrt(e*e+r*r+i*i);t[0]+=e*o,t[1]+=r*o,t[2]+=i*o;const c=this.offset/Math.sqrt(n*n+s*s+a*a);return t[3]+=n*c,t[4]+=s*c,t[5]+=a*c,t}};const _="terrain",O=Object(h.b)()},714:function(t,e,r){"use strict";r.d(e,"a",(function(){return n}));var i=r(109);function n(t,e,r){var n;const h=t.byteLength/(4*e),l=new Uint32Array(t,0,h*e);let d=new Uint32Array(h);const u=null!=(n=null==r?void 0:r.minReduction)?n:0,p=(null==r?void 0:r.originalIndices)||null,f=p?p.length:0,g=(null==r?void 0:r.componentOffsets)||null;let b=0;if(g)for(let i=0;i<g.length-1;i++){const t=g[i+1]-g[i];t>b&&(b=t)}else b=h;const m=Math.floor(1.1*b)+1;(null==c||c.length<2*m)&&(c=new Uint32Array(Object(i.p)(2*m)));for(let i=0;i<2*m;i++)c[i]=0;let v=0;const _=!!g&&!!p,O=_?f:h,y=_?new Uint32Array(f):null,j=1.96;let x=0!==u?Math.ceil(4*j*j/(u*u)*u*(1-u)):O,w=1,T=g?g[1]:O;for(let i=0;i<O;i++){if(i===x){const t=1-v/i;if(t+j*Math.sqrt(t*(1-t)/i)<u)return null;x*=2}if(i===T){for(let t=0;t<2*m;t++)c[t]=0;if(p)for(let t=g[w-1];t<g[w];t++)y[t]=d[p[t]];T=g[++w]}const t=_?p[i]:i,r=t*e,n=o(l,r,e);let a=n%m,h=v;for(;0!==c[2*a+1];){if(c[2*a]===n){const t=c[2*a+1]-1;if(s(l,r,t*e,e)){h=d[t];break}}a++,a>=m&&(a-=m)}h===v&&(c[2*a]=n,c[2*a+1]=t+1,v++),d[t]=h}if(0!==u&&1-v/h<u)return null;if(_){for(let t=g[w-1];t<y.length;t++)y[t]=d[p[t]];d=y}const S=new Uint32Array(e*v);v=0;for(let i=0;i<O;i++)d[i]===v&&(a(l,(_?p[i]:i)*e,S,v*e,e),v++);if(p&&!_){const t=new Uint32Array(f);for(let e=0;e<t.length;e++)t[e]=d[p[e]];d=t}return{buffer:S.buffer,indices:d,uniqueCount:v}}function s(t,e,r,i){for(let n=0;n<i;n++)if(t[e+n]!==t[r+n])return!1;return!0}function a(t,e,r,i,n){for(let s=0;s<n;s++)r[i+s]=t[e+s]}function o(t,e,r){let i=0;for(let n=0;n<r;n++)i=t[e+n]+i|0,i=i+(i<<11)+(i>>>2)|0;return i>>>0}let c=null},722:function(t,e,r){"use strict";r.d(e,"a",(function(){return u})),r.d(e,"b",(function(){return d}));var i=r(142),n=r(153),s=r(103),a=r(101),o=r(191),c=r(183),h=(r(687),r(256)),l=r(403);class d{constructor(){this.min=new u,this.max=new u,this.hud=new u,this.ground=new u}init(t){this.min.init(t),this.max.init(t),this.hud.init(t),this.ground.init(t),this.all=[]}}class u{constructor(t){this.normal=Object(a.e)(),this.transformation=Object(n.d)(),this._ray=Object(h.c)(),this.init(t)}get ray(){return this._ray}get hasIntersectionPoint(){return null!=this.dist}get distanceInRenderSpace(){if(null!=this.dist)return Object(s.e)(p,this.ray.direction,this.dist),Object(s.p)(p)}getIntersectionPoint(t){return!!this.hasIntersectionPoint&&(Object(s.e)(p,this.ray.direction,this.dist),Object(s.f)(t,this.ray.origin,p),!0)}getTransformedNormal(t){return Object(s.k)(f,this.normal),f[3]=0,Object(o.m)(f,f,this.transformation),Object(s.k)(t,f),Object(s.r)(t,t),t}init(t){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",t?Object(h.b)(t,this._ray):this._ray=Object(h.c)()}set(t,e,r,n,o,c,h,d,u,p){t instanceof l.a&&(t={type:"stage",obj:t}),this.dist=r,Object(s.k)(this.normal,n),Object(i.d)(this.transformation,o),this.target=t,this.name=e,this.drapedLayerOrder=c,this.center=h?Object(a.c)(h):null,this.geometryId=d,this.triangleNr=u,this.drapedLayerGraphicOrder=p}copyFrom(t){Object(h.b)(t.ray,this._ray),this.dist=t.dist,this.target=t.target,this.name=t.name,this.drapedLayerOrder=t.drapedLayerOrder,this.center=t.center?Object(a.c)(t.center):null,this.geometryId=t.geometryId,this.triangleNr=t.triangleNr,this.intersector=t.intersector,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,Object(s.k)(this.normal,t.normal),Object(i.d)(this.transformation,t.transformation)}}Object(a.e)();const p=Object(a.e)(),f=Object(c.e)()},723:function(t,e,r){"use strict";r.d(e,"a",(function(){return s})),r.d(e,"b",(function(){return a}));var i=r(755),n=r(112);function s(t){t.fragment.uniforms.add("texWaveNormal","sampler2D"),t.fragment.uniforms.add("texWavePerturbation","sampler2D"),t.fragment.uniforms.add("waveParams","vec4"),t.fragment.uniforms.add("waveDirection","vec2"),t.include(i.b),t.fragment.code.add(n.a`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}function a(t,e){t.setUniform4f("waveParams",e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset),t.setUniform2f("waveDirection",e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity)}},751:function(t,e,r){"use strict";r.d(e,"a",(function(){return o})),r.d(e,"b",(function(){return a}));var i=r(477),n=r(261),s=r(714);function a(t){const e=o(t.rings,t.hasZ,1),r=[];let n=0,a=0;for(const s of e.polygons){const t=s.count,o=s.index,c=new Float64Array(e.position.buffer,3*o*e.position.BYTES_PER_ELEMENT,3*t),h=s.holeIndices.map((t=>t-o)),l=new Uint32Array(Object(i.a)(c,h,3));r.push({position:c,faces:l}),n+=c.length,a+=l.length}const c=function(t,e,r){if(1===t.length)return t[0];const i=new Float64Array(e),n=new Uint32Array(r);let s=0,a=0,o=0;for(const c of t){for(let t=0;t<c.position.length;t++)i[s++]=c.position[t];for(let t=0;t<c.faces.length;t++)n[a++]=c.faces[t]+o;o=s/3}return{position:i,faces:n}}(r,n,a),h=Object(s.a)(c.position.buffer,6,{originalIndices:c.faces});return c.position=new Float64Array(h.buffer),c.faces=h.indices,c}function o(t,e,r){const i=t.length,n=new Array(i),s=new Array(i),a=new Array(i);let o=0,l=0,d=0,u=0;for(let c=0;c<i;++c)u+=t[c].length;const p=new Float64Array(3*u);let f=0;for(let g=i-1;g>=0;g--){const u=t[g],b=1===r&&h(u);if(b&&1!==i)n[o++]=u;else{let t=u.length;for(let e=0;e<o;++e)t+=n[e].length;const r={index:f,pathLengths:new Array(o+1),count:t,holeIndices:new Array(o)};r.pathLengths[0]=u.length,u.length>0&&(a[d++]={index:f,count:u.length}),f=b?c(u,u.length-1,-1,p,f,u.length,e):c(u,0,1,p,f,u.length,e);for(let i=0;i<o;++i){const t=n[i];r.holeIndices[i]=f,r.pathLengths[i+1]=t.length,t.length>0&&(a[d++]={index:f,count:t.length}),f=c(t,0,1,p,f,t.length,e)}o=0,r.count>0&&(s[l++]=r)}}for(let h=0;h<o;++h){const t=n[h];t.length>0&&(a[d++]={index:f,count:t.length}),f=c(t,0,1,p,f,t.length,e)}return l<i&&(s.length=l),d<i&&(a.length=d),{position:p,polygons:s,outlines:a}}function c(t,e,r,i,n,s,a){n*=3;for(let o=0;o<s;++o){const s=t[e];i[n++]=s[0],i[n++]=s[1],i[n++]=a?s[2]:0,e+=r}return n/3}function h(t){return!Object(n.g)(t,!1,!1)}},753:function(t,e,r){"use strict";r.d(e,"a",(function(){return f})),r.d(e,"b",(function(){return g})),r.d(e,"c",(function(){return m}));var i=r(109),n=r(85),s=r(310),a=r(103),o=r(101),c=r(175),h=r(751),l=r(795),d=r(430),u=r(806),p=r(397);function f(t){const e=[],r=[];!function(t,e,r){const{attributeData:{position:i},removeDuplicateStartEnd:n}=t,a=function(t){const e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}(i)&&1===n,o=i.length/3-(a?1:0),c=new Uint32Array(2*(o-1)),h=a?Object(s.m)(i,0,i.length-3):i;let l=0;for(let s=0;s<o-1;s++)c[l++]=s,c[l++]=s+1;e.push(["position",{size:3,data:h,exclusive:a}]),r.push(["position",c])}(t,r,e);const o=r[0][1].data,c=e[0][1].length,h=new Uint16Array(c);return function(t,e,r){const i=t.attributeData.mapPosition;Object(n.j)(i)||(r.push(["mapPos",r[0][1]]),e.push(["mapPos",{size:3,data:i}]))}(t,r,e),function(t,e,r,i){if(Object(n.k)(t.attributeData.colorFeature))return;const s=t.attributeData.color;e.push(["color",{size:4,data:Object(n.t)(s,l.c)}]),r.push(["color",i])}(t,r,e,h),function(t,e,r,i){if(Object(n.k)(t.attributeData.sizeFeature))return;const s=t.attributeData.size;e.push(["size",{size:1,data:[Object(n.t)(s,1)]}]),r.push(["size",i])}(t,r,e,h),function(t,e,r,i){const s=t.attributeData.colorFeature;Object(n.j)(s)||(e.push(["colorFeatureAttribute",{size:1,data:new Float32Array([s])}]),r.push(["color",i]))}(t,r,e,h),function(t,e,r,i){const s=t.attributeData.sizeFeature;Object(n.j)(s)||(e.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([s])}]),r.push(["sizeFeatureAttribute",i]))}(t,r,e,h),function(t,e,r,i){const s=t.attributeData.opacityFeature;Object(n.j)(s)||(e.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([s])}]),r.push(["opacityFeatureAttribute",i]))}(t,r,e,h),function(t,e,r,s){if("round"!==t.join)return;const o=s.length/3,c=new Float32Array(o),h=_,l=O;Object(a.w)(h,0,0,0);const d=Object(n.t)(t.uniformSize,1);for(let n=-1;n<o;++n){const t=n<0?o+n:n,e=(n+1)%o;if(Object(a.w)(l,s[3*e+0]-s[3*t+0],s[3*e+1]-s[3*t+1],s[3*e+2]-s[3*t+2]),Object(a.r)(l,l),n>=0){const t=(Math.PI-Object(i.b)(Object(a.h)(h,l)))*y*1*v(d);c[n]=Math.max(Math.floor(t),0)}Object(a.e)(h,l,-1)}e.push(["subdivisions",{size:1,data:c}]),r.push(["subdivisions",r[0][1]])}(t,r,e,o),new p.a(r,e,2)}function g(t,e,r,i){const n="polygon"===t.type?1:0,s="polygon"===t.type?t.rings:t.paths,{position:a,outlines:o}=Object(h.a)(s,t.hasZ,n),c=new Float64Array(a.length),l=Object(d.c)(a,t.spatialReference,0,c,0,a,0,a.length/3,e,r,i),u=null!=l;return{lines:u?b(o,a,c):[],projectionSuccess:u,sampledElevation:l}}function b(t,e,r){const i=new Array;for(const{index:n,count:s}of t){if(s<=1)continue;const t=3*n,a=t+3*s;i.push({position:e.subarray(t,a),mapPosition:r?r.subarray(t,a):void 0})}return i}function m(t,e){const r="polygon"===t.type?1:0,i="polygon"===t.type?t.rings:t.paths,{position:n,outlines:s}=Object(h.a)(i,!1,r),a=Object(c.m)(n,t.spatialReference,0,n,e,0,n.length/3);for(let o=2;o<n.length;o+=3)n[o]=u.a;return{lines:a?b(s,n):[],projectionSuccess:a}}function v(t){return 1.863798+-2.0062872/(1+t/18.2313)**.8856294}const _=Object(o.e)(),O=Object(o.e)(),y=4/Math.PI},754:function(t,e,r){"use strict";r.d(e,"a",(function(){return s}));var i=r(101);class n{constructor(t,e){this.vec3=t,this.id=e}}function s(t,e,r,s){return new n(Object(i.g)(t,e,r),s)}},755:function(t,e,r){"use strict";r.d(e,"a",(function(){return s})),r.d(e,"b",(function(){return n}));var i=r(112);function n(t){t.fragment.code.add(i.a`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function s(t){t.fragment.code.add(i.a`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}},756:function(t,e,r){"use strict";r.d(e,"a",(function(){return n}));var i=r(112);function n(t,e){1===e.viewingMode?t.vertex.code.add(i.a`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):t.vertex.code.add(i.a`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),1===e.viewingMode?t.vertex.code.add(i.a`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):t.vertex.code.add(i.a`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}},759:function(t,e,r){"use strict";r.d(e,"a",(function(){return p}));r(79);var i=r(85),n=r(153),s=r(103),a=r(101),o=r(256);class c{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2}}var h=r(722),l=r(689),d=r(350);const u=1e-5;class p{constructor(t){this.options=new c,this.results=new h.b,this.transform=new l.a,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.tolerance=u,this.verticalOffset=null,this._ray={origin:Object(a.e)(),direction:Object(a.e)()},this._rayEndPoint=Object(a.e)(),this._rayStartPointTransformed=Object(a.e)(),this._rayEndPointTransformed=Object(a.e)(),this.viewingMode=null==t?1:t}get ray(){return this._ray}get rayBeginPoint(){return this._ray.origin}get rayEndPoint(){return this._rayEndPoint}reset(t,e){this.resetWithRay(Object(o.e)(t,e,this._ray))}resetWithRay(t){t!==this._ray&&Object(o.b)(t,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,Object(s.f)(this._rayEndPoint,this._ray.origin,this._ray.direction),this._numObjectsTested=0,this.results.init(this._ray)}intersect(t=null,e,r,n,s,a){this.point=e,this.camera=r,this.filterPredicate=s,this.tolerance=null==n?u:n;const o=Object(l.c)(this.verticalOffset);if(Object(i.k)(t)&&t.length>0){const e=a?t=>{a(t)&&this.intersectObject(t)}:t=>{this.intersectObject(t)};for(const r of t){const t=r.getSpatialQueryAccelerator&&r.getSpatialQueryAccelerator();Object(i.k)(t)?(Object(i.k)(o)?t.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,e,o):t.forEachAlongRay(this._ray.origin,this._ray.direction,e),this.options.selectionMode&&this.options.hud&&t.forEachDegenerateObject(e)):r.objects.forAll((t=>e(t)))}}this.sortResults()}intersectObject(t){this._numObjectsTested++;const e=t.geometryRecords;if(!e)return;const r=t.id,a=t.transformation;let o;const c=Object(l.c)(this.verticalOffset);for(const l of e){const{geometry:e,material:u,instanceParameters:p}=l;if(Object(d.e)(p))continue;o=e.id,this.transform.setAndInvalidateLazyTransforms(a,l.getShaderTransformation()),Object(s.q)(this._rayStartPointTransformed,this._ray.origin,this.transform.inverse),Object(s.q)(this._rayEndPointTransformed,this._rayEndPoint,this.transform.inverse);const f=this.transform.transform;Object(i.k)(c)&&(c.objectTransform=this.transform),u.intersect(e,p,this.transform.transform,this,this._rayStartPointTransformed,this._rayEndPointTransformed,((e,s,a,c,l,d)=>{if(e>=0){if(Object(i.k)(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEndPoint,e))return;const u=`Object3D ${r}`;if(l)return void((null==this.results.hud.dist||e<this.results.hud.dist)&&this.results.hud.set(t,u,e,s,n.a,c,d,o,a));const p=r=>r.set(t,u,e,s,f,c,null,o,a);if((null==this.results.min.drapedLayerOrder||c>=this.results.min.drapedLayerOrder)&&(null==this.results.min.dist||e<this.results.min.dist)&&p(this.results.min),0!==this.options.store&&(null==this.results.max.drapedLayerOrder||c<this.results.max.drapedLayerOrder)&&(null==this.results.max.dist||e>this.results.max.dist)&&p(this.results.max),2===this.options.store){const t=new h.a(this._ray);p(t),this.results.all.push(t)}}}),l.shaderTransformation)}}sortResults(){this.results.all.sort(((t,e)=>t.dist!==e.dist?t.dist-e.dist:t.drapedLayerOrder!==e.drapedLayerOrder?(void 0!==t.drapedLayerOrder?t.drapedLayerOrder:Number.MAX_VALUE)-(void 0!==e.drapedLayerOrder?e.drapedLayerOrder:Number.MAX_VALUE):(void 0!==e.drapedLayerGraphicOrder?e.drapedLayerGraphicOrder:Number.MIN_VALUE)-(void 0!==t.drapedLayerGraphicOrder?t.drapedLayerGraphicOrder:Number.MIN_VALUE)))}}p.DEFAULT_TOLERANCE=u},761:function(t,e,r){"use strict";r.d(e,"a",(function(){return a})),r.d(e,"b",(function(){return o}));var i=r(280),n=r(112);function s(t){t.fragment.uniforms.add("lastFrameColorMap","sampler2D"),t.fragment.uniforms.add("reprojectionMat","mat4"),t.fragment.uniforms.add("rpProjectionMat","mat4"),t.fragment.code.add(n.a`vec2 reprojectionCoordinate(vec3 projectionCoordinate)
{
vec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
vec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
reprojectedCoord.xy /= reprojectedCoord.w;
return reprojectedCoord.xy * 0.5 + 0.5;
}`)}function a(t,e){t.fragment.uniforms.add("nearFar","vec2"),t.fragment.uniforms.add("depthMapView","sampler2D"),t.fragment.uniforms.add("ssrViewMat","mat4"),t.fragment.uniforms.add("invResolutionHeight","float"),t.fragment.include(i.a),t.include(s),t.fragment.code.add(n.a`
  const int maxSteps = ${e.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function o(t,e){var r,i;e.ssrEnabled&&(t.bindTexture(e.linearDepthTexture,"depthMapView"),t.setUniform2fv("nearFar",e.camera.nearFar),t.setUniformMatrix4fv("ssrViewMat",e.camera.viewMatrix),t.setUniform1f("invResolutionHeight",1/e.camera.height),i=e,(r=t).bindTexture(i.lastFrameColorTexture,"lastFrameColorMap"),r.setUniformMatrix4fv("reprojectionMat",i.reprojectionMat),r.setUniformMatrix4fv("rpProjectionMat",i.camera.projectionMatrix))}},794:function(t,e,r){"use strict";r.d(e,"a",(function(){return n})),r.d(e,"b",(function(){return s}));var i=r(85);function n(t){return Object(i.j)(t)?t:t.slice()}function s(t){return[t,t]}},795:function(t,e,r){"use strict";r.d(e,"a",(function(){return n})),r.d(e,"b",(function(){return s})),r.d(e,"c",(function(){return a}));var i=r(183);const n=1.2,s=i.b,a=i.a},796:function(t,e,r){"use strict";r.d(e,"a",(function(){return v})),r.d(e,"b",(function(){return m}));var i=r(639),n=r(237),s=r(386),a=r(303),o=r(280),c=r(259),h=r(756),l=r(542),d=r(863),u=r(723),p=r(328),f=r(337),g=r(112),b=r(248);function m(t){const e=new b.a;return e.include(s.a,{linearDepth:!1}),e.attributes.add("position","vec3"),e.attributes.add("uv0","vec2"),e.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),e.vertex.uniforms.add("waterColor","vec4"),0!==t.output&&7!==t.output||(e.include(h.a,t),e.include(i.a,t),e.varyings.add("vuv","vec2"),e.varyings.add("vpos","vec3"),e.varyings.add("vnormal","vec3"),e.varyings.add("vtbnMatrix","mat3"),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),e.vertex.code.add(g.a`
      void main(void) {
        if (waterColor.a < ${g.a.float(p.c)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${t.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${0===t.output?"forwardLinearDepth();":""}
      }
    `)),t.multipassTerrainEnabled&&(e.fragment.include(o.a),e.include(c.b,t)),7===t.output&&(e.include(n.a,t),e.fragment.uniforms.add("waterColor","vec4"),e.fragment.code.add(g.a`
        void main() {
          discardBySlice(vpos);
          ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),0===t.output&&(e.include(u.a,t),e.include(n.a,t),t.receiveShadows&&e.include(l.a,t),e.include(d.a,t),e.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),e.fragment.include(f.a),e.fragment.code.add(g.a`
      void main() {
        discardBySlice(vpos);
        ${t.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - camPos);
        float shadow = ${t.receiveShadows?g.a`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${t.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),2===t.output&&(e.include(h.a,t),e.include(u.a,t),e.include(n.a,t),e.varyings.add("vpos","vec3"),e.varyings.add("vuv","vec2"),e.vertex.code.add(g.a`
        void main(void) {
          if (waterColor.a < ${g.a.float(p.c)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),e.fragment.uniforms.add("timeElapsed","float"),e.fragment.code.add(g.a`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`)),5===t.output&&(e.varyings.add("vpos","vec3"),e.vertex.code.add(g.a`
        void main(void) {
          if (waterColor.a < ${g.a.float(p.c)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),e.fragment.uniforms.add("waterColor","vec4"),e.fragment.code.add(g.a`void main() {
gl_FragColor = waterColor;
}`)),4===t.output&&(e.include(a.a),e.varyings.add("vpos","vec3"),e.vertex.code.add(g.a`
      void main(void) {
        if (waterColor.a < ${g.a.float(p.c)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),e.include(n.a,t),e.fragment.code.add(g.a`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),e}var v=Object.freeze({__proto__:null,build:m})},797:function(t,e,r){"use strict";r.d(e,"a",(function(){return o})),r.d(e,"b",(function(){return a}));var i=r(585),n=r(112),s=r(248);function a(){const t=new s.a;return t.include(i.a),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("color","vec4"),t.fragment.code.add(n.a`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * color;
}`),t}var o=Object.freeze({__proto__:null,build:a})},806:function(t,e,r){"use strict";r.d(e,"a",(function(){return te}));var i=r(81),n=r(93),s=r(114),a=r(80),o=r(520),c=r(85),h=r(173),l=r(426),d=r(111),u=r(83),p=(r(79),r(84),r(82)),f=r(142),g=r(177),b=r(101),m=r(686),v=r(109),_=r(191),O=r(123),y=r(754);class j{constructor(t,e){this.index=t,this.renderTargets=e,this.extent=Object(O.k)(),this.resolution=0,this.viewport=Object(O.k)(),this.renderLocalOrigin=Object(y.a)(0,0,0,"O"),this.pixelRatio=1,this.canvasGeometries={extents:[Object(O.k)(),Object(O.k)(),Object(O.k)()],numViews:0},this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=t,this.validTargets=new Array(e.renderTargets.length).fill(!1)}getValidTarget(t){return this.validTargets[t]?this.renderTargets.getTarget(t):null}get needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(t){const e=1===t?this.renderTargets.getTarget(0):2===t?this.renderTargets.getTarget(2):this.renderTargets.getTarget(4);return e?e.getTexture():null}getNormalTexture(t){const e=1===t?this.renderTargets.getTarget(3):null;return e?e.getTexture():null}draw(t,e){const r=this.computeRenderTargetValidityBitfield(),i=this.needsColorWithoutRasterImage;for(const n of this.renderTargets.renderTargets)1===n.type&&!1===i?this.validTargets[n.type]=!1:this.validTargets[n.type]=t.drawTarget(this,n,e);return r^this.computeRenderTargetValidityBitfield()?0:1}computeRenderTargetValidityBitfield(){const t=this.validTargets;return+t[0]|+t[1]<<1|+t[2]<<2|+t[3]<<3|+t[4]<<4}setupGeometryViewsCyclical(t){this.setupGeometryViewsDirect();const e=.001*t.range;if(this.extent[0]-e<=t.min){const e=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Object(O.t)(this.extent,t.range,0,e)}if(this.extent[2]+e>=t.max){const e=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Object(O.t)(this.extent,-t.range,0,e)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,Object(O.u)(this.canvasGeometries.extents[0],this.extent),Object(_.l)(this.viewport,0,0,this.resolution,this.resolution)}hasSomeSizedView(){for(let t=0;t<this.canvasGeometries.numViews;t++){const e=this.canvasGeometries.extents[t];if(e[0]!==e[2]&&e[1]!==e[3])return!0}return!1}applyViewport(t){const e=this.viewport;0===this.index?t.setViewport(e[0],e[1],e[2],e[3]):t.setViewport(e[0]+this.resolution,e[1],e[2],e[3])}}var x=r(238),w=r(202),T=r(232),S=(r(169),r(197),r(242),r(166)),R=r(206);class M{constructor(t,e){this.size=Object(x.a)(),this._fbo=null,this._fbo=new T.a(t,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:e,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=Object(c.f)(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return null!==this._fbo}resize(t,e){this.size[0]=t,this.size[1]=e,this._fbo.resize(this.size[0],this.size[1])}bind(t){t.bindFramebuffer(this._fbo)}generateMipMap(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}disposeRenderTargetMemory(){var t;null==(t=this._fbo)||t.resize(0,0)}get gpuMemoryUsage(){var t,e;return null!=(t=null==(e=this._fbo)?void 0:e.gpuMemoryUsage)?t:0}}class C{constructor(t){this.renderTargets=null;const e=(e,r,i=!0)=>({type:r,fbo:new M(t,i),renderPass:e,valid:!1,lastUsed:1/0});this.renderTargets=[e(0,0),e(0,1),e(5,2,!1),e(3,3),e(0,4)]}getTarget(t){return this.renderTargets[t].fbo}dispose(){for(const t of this.renderTargets)t.fbo.dispose()}disposeRenderTargetMemory(){for(const t of this.renderTargets)t.fbo.disposeRenderTargetMemory()}validateUsageForTarget(t,e,r){if(t)e.lastUsed=r;else if(r-e.lastUsed>E)e.fbo.disposeRenderTargetMemory(),e.lastUsed=1/0;else if(e.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce(((t,e)=>t+e.fbo.gpuMemoryUsage),0)}}const E=1e3;class D{constructor(t){this.technique=t,this.refCount=0,this.refZeroFrame=0}}class P{constructor(t){this._context=t,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach((t=>t.forEach((t=>t.technique.dispose())))),this._perConstructorInstances.clear()}acquire(t,e){const r=e.key;let i=this._perConstructorInstances.get(t);i||(i=new Map,this._perConstructorInstances.set(t,i));let n=i.get(r);if(void 0===n){const s=new t(this._context,e,(()=>this.release(s)));n=new D(s),i.set(r,n)}return++n.refCount,n.technique}releaseAndAcquire(t,e,r){if(Object(c.k)(r)){if(e.key===r.key)return r;r.release()}return this.acquire(t,e)}release(t){if(Object(c.j)(t))return;const e=this._perConstructorInstances.get(t.constructor).get(t.key);--e.refCount,0===e.refCount&&(e.refZeroFrame=this._frameCounter)}frameUpdate(){this._frameCounter++,this._perConstructorInstances.forEach(((t,e)=>{t.forEach(((e,r)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.dispose(),t.delete(r))})),0===t.size&&this._perConstructorInstances.delete(e)}))}async hotReload(){const t=new Array;this._perConstructorInstances.forEach(((e,r)=>{t.push((async(t,e)=>{const r=e.shader;r&&(await r.reload(),t.forEach((t=>{t.technique.reload(this._context)})))})(e,r))})),await Promise.all(t)}}var I=r(570),A=r(638);const L=[{output:0,name:"color"},{output:1,name:"depth"},{output:2,name:"normal"},{output:3,name:"depthShadowMap"},{output:4,name:"highlight"},{output:5,name:"draped"},{output:6,name:"occlusion"},{output:7,name:"alpha"}];function z(t,e){return t+"_"+L.find((t=>t.output===e)).name}var H=r(178);const N=a.a.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRep");class F{constructor(t){this.refCnt=0,this.glMaterial=t}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,Object(H.a)(this.refCnt>=0)}getRefCnt(){return this.refCnt}getGLMaterial(){return this.glMaterial}}var V=class{constructor(t,e,r){this._textureRep=t,this._techniqueRep=e,this.onMaterialChanged=r,this._id2glMaterialRef=new Map}dispose(){this._textureRep.dispose()}acquire(t,e){this.ownMaterial(t);const r=z(t.id,e);let i=this._id2glMaterialRef.get(r);if(null==i){const n=t.getGLMaterial({material:t,techniqueRep:this._techniqueRep,textureRep:this._textureRep,output:e});return i=new F(n),i.incRefCnt(),this._id2glMaterialRef.set(r,i),n}return i.incRefCnt(),i.getGLMaterial()}release(t,e){const r=z(t.id,e),i=this._id2glMaterialRef.get(r);if(i.decRefCnt(),0===i.getRefCnt()){const t=i.getGLMaterial();t&&t.dispose(),this._id2glMaterialRef.delete(r)}}materialChanged(t){for(const e of L)if(5!==e.output&&6!==e.output){const r=this._id2glMaterialRef.get(z(t.id,e.output));if(r&&r.getGLMaterial()){const t=r.getGLMaterial();t.updateParameters&&t.updateParameters()}}this.onMaterialChanged&&this.onMaterialChanged(t)}ownMaterial(t){Object(c.k)(t.materialRepository)&&t.materialRepository!==this&&N.error("Material is already owned by a different material repository"),t.materialRepository=this}},k=r(526),G=r(841),U=r(722);class W{constructor(t){this.rctx=t,this.camera=null,this.lastFrameCamera=new A.a,this.pass=0,this.slot=0,this.highlightDepthTexture=null,this.renderOccludedMask=B,this.hasOccludees=!1}resetRenderOccludedMask(){this.renderOccludedMask=B}get isHighlightPass(){return 5===this.pass}}const B=13;class q{constructor(){this.adds=new h.a,this.removes=new h.a,this.updates=new h.a({allocator:t=>t||new Z,deallocator:t=>(t.renderGeometry=null,t)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class Z{}class Y{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}var $=r(345);function X(t){return t.data.indexCount>=1}var Q=r(153),J=r(535);class K{constructor(t){null==t?t=16:t<65536&&(t=Object(v.p)(t)),this._array=new Float32Array(t),this._size=0}resize(t,e){if(this._size=t,this._size>this._array.length){let t=this._array.length||1;for(;t<this._size;)t*=2;const r=new Float32Array(t);return e&&r.set(this._array),this._array=r,!0}const r=2*this._size;if(r<=this._array.length){let t=this._array.length;for(;t>=r;)t=Math.floor(t/2);const i=new Float32Array(t);return e&&i.set(this._array.subarray(0,t)),this._array=i,!0}return!1}append(t){const e=this._size;this.resize(this._size+t.length,!0),this._array.set(t,e)}erase(t,e){for(let r=t;r<e;++r)this._array[r]=0}get array(){return this._array}get size(){return this._size}}var tt=r(842);class et{constructor(t,e,r,i,n,s){this.from=t,this.to=e,this.isVisible=r,this.hasHighlights=i,this.hasOccludees=n,this.transformation=s,null!=s&&(this.transformationNormal=Object(Q.c)(s),Object(f.a)(this.transformationNormal,this.transformationNormal),Object(f.e)(this.transformationNormal,this.transformationNormal))}}function rt(t,e){const r=t=>({first:t.from,count:t.to-t.from});if(0===t.length)return void t.push(r(e));const i=t[t.length-1];if(function(t,e){return t.first+t.count>=e.from}(i,e)){const t=e.from-i.first+e.to-e.from;i.count=t}else t.push(r(e))}var it=r(350),nt=r(377);r(132);function st(t,e,r){Object(c.k)(r)&&(r.drawCalls+=t,r.triangles+=e)}nt.a;var at=r(472);function ot(t){return t.hasOccludees||t.hasHighlights||t.hasHiddenInstances}const ct={begin:0,end:0},ht=Object(Q.d)(),lt=Object(Q.d)(),dt=Object(Q.d)();var ut=class{constructor(t,e,r){this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=t,this._material=r,this._materialRep=e,this._glMaterials=Object(it.a)(this._material,this._materialRep),this._bufferWriter=r.createBufferWriter()}dispose(){Object(it.f)(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((t=>{t.vao.dispose(!0),t.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((t=>{t&&t.dispose()})),this._glMaterials.clear(),this._glMaterials=null)}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&Object(o.b)(this._glMaterials,(t=>t instanceof tt.a))}get rendersOccluded(){return!this.isEmpty&&1!==this._material.renderOccluded}modify(t){this.updateGeometries(t.updates),this.addAndRemoveGeometries(t.adds,t.removes),this.updateRenderCommands()}addAndRemoveGeometries(t,e){const r=this._bufferWriter,i=r.vertexBufferLayout,n=i.stride/4,s=this._dataByOrigin,a=function(t,e,r,i){const n=new Map,s=e.vertexBufferLayout.stride/4,a=(r,i)=>{const a=r.origin;if(Object(c.j)(a))return;const o=t.get(a.id);let h=n.get(a.id);null==h&&(h={optimalCount:null==o?0:o.optimalCount,sparseCount:null==o?0:o.buffer.size,toAdd:[],toRemove:[],origin:a.vec3},n.set(a.id,h));const l=e.elementCount(r.data)*s;i?(h.optimalCount+=l,h.sparseCount+=l,h.toAdd.push(r)):(h.optimalCount-=l,h.toRemove.push(r))};for(const o of r)a(o,!0);for(const o of i)a(o,!1);return n}(s,r,t,e);a.forEach(((t,e)=>{a.delete(e);const r=t.optimalCount,o=t.sparseCount;let c=s.get(e);if(null==c)Object(H.a)(r>0),c=this.createData(i,r,t.origin),s.set(e,c);else if(0===r)return c.vao.dispose(!0),c.vao=null,void s.delete(e);const h=r<t.sparseCount/2,l=h?r:o,d=ct,u=c.buffer.size,p=c.buffer.array,f=c.buffer.resize(l,!1);h||f?this.removeAndRebuild(c,t.toRemove,n,p,d):t.toRemove.length>0?(this.removeByErasing(c,t.toRemove,n,d),t.toAdd.length>0&&(d.end=u)):(d.begin=u,d.end=u);const g=ht;Object(H.j)(g,-t.origin[0],-t.origin[1],-t.origin[2]),this.append(c,t.toAdd,n,g,d);const b=c.vao.vertexBuffers.geometry;if(b.byteSize!==c.buffer.array.buffer.byteLength)b.setData(c.buffer.array);else{const{begin:t,end:e}=d;if(t<e){const r=c.buffer.array,i=4,n=t*i,s=e*i;b.setSubData(r,n,n,s)}}c.drawCommandsDirty=!0}))}updateGeometries(t){const e=this._bufferWriter,r=e.vertexBufferLayout.stride/4;for(const i of t){const t=i.updateType,n=i.renderGeometry,s=this._dataByOrigin.get(n.origin.id),a=s&&s.instances.get(n.id);if(!a)return;if(1&t&&(a.isVisible=n.instanceParameters.visible),9&t){const t=n.instanceParameters.visible;a.hasHighlights=!!n.instanceParameters.highlights&&t}if(16&t&&(a.hasOccludees=!!n.instanceParameters.occludees),6&t){const t=s.buffer.array,i=s.vao;Object(it.c)(n,lt,dt),e.write({transformation:lt,invTranspTransformation:dt},n.data,e.vertexBufferLayout.createView(t.buffer),a.from),Object(H.a)(a.from+e.elementCount(n.data)===a.to,"material VBO layout has changed"),i.vertexBuffers.geometry.setSubData(t,a.from*r*4,a.from*r*4,a.to*r*4)}s.drawCommandsDirty=!0}}updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((t=>{t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,Object(o.b)(t.instances,(e=>(e.isVisible?(e.hasHighlights&&(this._hasHighlights=!0,t.hasHighlights=!0),e.hasOccludees&&(this._hasOccludees=!0,t.hasOccludees=!0)):t.hasHiddenInstances=!0,t.hasHiddenInstances&&t.hasHighlights&&t.hasOccludees)))}));this._dataByOrigin.forEach((t=>{t.drawCommandsDirty&&((t=>{if(t.drawCommandsDefault=null,t.drawCommandsHighlight=null,t.drawCommandsOccludees=null,t.drawCommandsShadowHighlightRest=null,t.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0},0===t.instances.size)return;if(!ot(t)){const e=4*t.buffer.size/Object(at.d)(t.vao.layout.geometry);return t.drawCommandsDefault=[{first:0,count:e}],void(t.stats={default:e,highlight:0,occludees:0,shadowHighlightRest:0})}const e=function(t){return t.sort(((t,e)=>t.from===e.from?t.to>e.to?1:t.to<e.to?-1:0:t.from>e.from?1:t.from<e.from?-1:0))}([...t.instances.values()]);t.drawCommandsDefault=[],t.drawCommandsHighlight=[],t.drawCommandsOccludees=[],t.drawCommandsShadowHighlightRest=[];for(const i of e)i.isVisible&&(i.hasOccludees?rt(t.drawCommandsOccludees,i):rt(t.drawCommandsDefault,i),i.hasHighlights?rt(t.drawCommandsHighlight,i):rt(t.drawCommandsShadowHighlightRest,i));const r=t=>{let e=0;for(const r of t)e+=r.count;return e/3};t.stats={default:r(t.drawCommandsDefault),highlight:r(t.drawCommandsHighlight),occludees:r(t.drawCommandsOccludees),shadowHighlightRest:r(t.drawCommandsShadowHighlightRest)}})(t),t.drawCommandsDirty=!1)}))}updateLogic(t){return this._material.update(t)}render(t,e,r,i){const n=this._rctx,s=this._glMaterials.get(e),a=5===e||7===e,o=6===e,h=!(a||o);if(3===e&&null===t&&(t=22),!s||2!==s.ensureResources(n)||null!=t&&!s.beginSlot(t)||a&&!this._hasHighlights)return!1;s.ensureParameters(r);const l=s.getPipelineState(t,!1);n.setPipelineState(l);const d=s.technique;n.useProgram(d.program),s.bind(r);let u=!1;return this._dataByOrigin.forEach((e=>{if(Object(c.j)(e.drawCommandsDefault)&&Object(c.j)(e.drawCommandsHighlight)&&Object(c.j)(e.drawCommandsOccludees)&&Object(c.j)(e.drawCommandsShadowHighlightRest))return;if(a&&!e.hasHighlights)return;r.origin=e.origin,d.bindDraw(r,{},{}),d.ensureAttributeLocations(e.vao),n.bindVAO(e.vao);const p=d.primitiveType,f=a?e.drawCommandsHighlight:o&&ot(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault;if(Object(c.k)(f)){this.renderCommands(n,p,f);const t=a?e.stats.highlight:o&&ot(e)?e.stats.shadowHighlightRest:e.stats.default;st(f.length,t,i),u=!0}if(h){const r=e.drawCommandsOccludees;if(Object(c.k)(r)){const a=s.getPipelineState(t,!0);n.setPipelineState(a),this.renderCommands(n,p,r),n.setPipelineState(l),st(r.length,e.stats.occludees,i),u=!0}}})),u}renderCommands(t,e,r){for(let i=0;i<r.length;i++)t.drawArrays(e,r[i].first,r[i].count)}createData(t,e,r){return{instances:new Map,vao:new R.a(this._rctx,this._material.vertexAttributeLocations,{geometry:Object(J.a)(t)},{geometry:w.a.createVertex(this._rctx,35044)}),buffer:new K(e),optimalCount:0,origin:r,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}}removeAndRebuild(t,e,r,i,n){for(const l of e){const e=l.id,i=t.instances.get(e);t.optimalCount-=(i.to-i.from)*r,t.instances.delete(e)}let s=0;const a=t.buffer.array;n.begin=0,n.end=0;let o=-1,c=-1,h=0;t.instances.forEach((t=>{const e=t.from*r,n=t.to*r,l=n-e;o!==c&&c!==e?(a.set(i.subarray(o,c),h),h+=c-o,o=e):-1===o&&(o=e),c=n,t.from=s/r,s+=l,t.to=s/r})),o!==c&&a.set(i.subarray(o,c),h),n.end=s}removeByErasing(t,e,r,i){i.begin=1/0,i.end=-1/0;let n=-1,s=-1;for(const a of e){const e=a.id,o=t.instances.get(e),c=o.from*r,h=o.to*r;n!==s&&s!==c?(t.buffer.erase(n,s),n=c):-1===n&&(n=c),s=h,t.instances.delete(e),t.optimalCount-=h-c,c<i.begin&&(i.begin=c),h>i.end&&(i.end=h)}n!==s&&t.buffer.erase(n,s)}append(t,e,r,i,n){const s=this._bufferWriter;for(const a of e){const e=Object(c.k)(a.transformation)?Object(f.m)(lt,i,a.transformation):i;Object(f.a)(dt,e),Object(f.e)(dt,dt);const o=n.end;s.write({transformation:e,invTranspTransformation:dt},a.data,s.vertexBufferLayout.createView(t.buffer.array.buffer),n.end/r);const h=s.elementCount(a.data)*r,l=o+h;Object(H.a)(null==t.instances.get(a.id));const d=a.instanceParameters.visible,u=!!a.instanceParameters.highlights&&d,p=!!a.instanceParameters.occludees,g=new et(o/r,l/r,d,u,p);t.instances.set(a.id,g),t.optimalCount+=h,n.end+=h}}get test(){return{material:this._material,glMaterials:this._glMaterials}}};let pt=class extends n.a{constructor(){super(...arguments),this._pending=new ft,this._changes=new q,this._materialRenderers=new Map,this._sortedMaterialRenderers=new h.a,this._hasHighlights=!1,this._hasWater=!1}dispose(){this._changes.prune(),this._materialRenderers.forEach((t=>t.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return Object(o.b)(this._materialRenderers,(t=>t.rendersOccluded))}stopAnimationsAtTime(t){this._sortedMaterialRenderers.forAll((e=>Object(c.c)(e.material.animation,(e=>e.stopAtTime(t)))))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const t=function(t){const e=new Map,r=t=>{let r=e.get(t);return r||(r=new Y,e.set(t,r)),r};return t.adds.forAll((t=>{X(t)&&r(t.material).adds.push(t)})),t.removes.forAll((t=>{X(t)&&r(t.material).removes.push(t)})),t.updates.forAll((t=>{X(t.renderGeometry)&&r(t.renderGeometry.material).updates.push(t)})),e}(this._changes);let e=!1,r=!1,i=!1;return t.forEach(((t,n)=>{let s=this._materialRenderers.get(n);if(!s&&t.adds.length>0&&(s=new ut(this.rctx,this.materialRepository,n),this._materialRenderers.set(n,s),e=!0,r=!0,i=!0),!s)return;const a=r||s.hasHighlights,o=i||s.hasWater;s.modify(t),r=r||a!==s.hasHighlights,i=i||o!==s.hasWater,s.isEmpty&&(this._materialRenderers.delete(n),s.dispose(),e=!0)})),this._changes.clear(),e&&this.updateSortedMaterialRenderers(),r&&(this._hasHighlights=Object(o.b)(this._materialRenderers,(t=>t.hasHighlights))),i&&(this._hasWater=Object(o.b)(this._materialRenderers,(t=>t.hasWater))),this.notifyChange("updating"),!0}add(t){if(0===t.length)return;const e=this._pending.empty;for(const r of t)this._pending.adds.add(r);e&&this.notifyChange("updating")}remove(t){const e=this._pending.empty;for(const r of t)this._pending.adds.has(r)?(this._pending.removed.add(r),this._pending.adds.delete(r)):this._pending.removed.has(r)||this._pending.removes.add(r);e&&!this._pending.empty&&this.notifyChange("updating")}modify(t,e){const r=0===this._changes.updates.length;for(const i of t){const t=this._changes.updates.pushNew();t.renderGeometry=i,t.updateType=e}r&&this._changes.updates.length>0&&this.notifyChange("updating")}updateLogic(t){let e=!1;return this._sortedMaterialRenderers.forAll((({materialRenderer:r})=>{r.updateLogic&&r.updateLogic(t)&&(e=!0)})),e}render(t,e){for(let r=0;r<this._sortedMaterialRenderers.length;r++){const i=this._sortedMaterialRenderers.data[r];Object($.c)(i.material,t)&&i.materialRenderer.render(null,t.pass,e,null)}}updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let t=0;this._materialRenderers.forEach(((e,r)=>{r.insertOrder=t++,this._sortedMaterialRenderers.push({material:r,materialRenderer:e})})),this._sortedMaterialRenderers.sort(((t,e)=>{const r=e.material.renderPriority-t.material.renderPriority;return 0!==r?r:t.material.insertOrder-e.material.insertOrder}))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let t=0;t<this._changes.updates.length;){const e=this._changes.updates.data[t];this._pending.has(e.renderGeometry)?this._changes.updates.removeUnorderedIndex(t):t++}this._pending.clear()}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};Object(i.a)([Object(u.b)()],pt.prototype,"rctx",void 0),Object(i.a)([Object(u.b)()],pt.prototype,"materialRepository",void 0),Object(i.a)([Object(u.b)()],pt.prototype,"updating",null),pt=Object(i.a)([Object(p.a)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],pt);class ft{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(t){return this.adds.has(t)||this.removes.has(t)||this.removed.has(t)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}var gt=r(797),bt=r(294),mt=r(301),vt=r(305),_t=r(302),Ot=r(295),yt=r(279);class jt extends mt.a{initializeProgram(t){const e=jt.shader.get().build();return new Ot.a(t.rctx,e,_t.a)}initializePipeline(){return this.configuration.hasAlpha?Object(yt.f)({blending:Object(yt.g)(770,1,771,771),colorWrite:yt.c}):Object(yt.f)({colorWrite:yt.c})}}jt.shader=new bt.a(gt.a,(()=>r.e(302).then(r.bind(null,1288))));class xt extends vt.a{constructor(){super(...arguments),this.hasAlpha=!1}}Object(i.a)([Object(vt.b)()],xt.prototype,"hasAlpha",void 0);class wt{constructor(t=Object(b.e)()){this.intensity=t}}class Tt{constructor(t=Object(b.e)(),e=Object(b.g)(.57735,.57735,.57735)){this.intensity=t,this.direction=e}}class St{constructor(t=Object(b.e)(),e=Object(b.g)(.57735,.57735,.57735),r=!0){this.intensity=t,this.direction=e,this.castShadows=r}}class Rt{constructor(){this.r=[0],this.g=[0],this.b=[0]}}var Mt=r(103);function Ct(t,e,r){(r=r||t).length=t.length;for(let i=0;i<t.length;i++)r[i]=t[i]*e[i];return r}function Et(t,e,r){(r=r||t).length=t.length;for(let i=0;i<t.length;i++)r[i]=t[i]*e;return r}function Dt(t,e,r){(r=r||t).length=t.length;for(let i=0;i<t.length;i++)r[i]=t[i]+e[i];return r}function Pt(t){return(t+1)*(t+1)}function It(t,e,r){const i=t[0],n=t[1],s=t[2],a=r||[];return a.length=Pt(e),e>=0&&(a[0]=.28209479177),e>=1&&(a[1]=.4886025119*i,a[2]=.4886025119*s,a[3]=.4886025119*n),e>=2&&(a[4]=1.09254843059*i*n,a[5]=1.09254843059*n*s,a[6]=.31539156525*(3*s*s-1),a[7]=1.09254843059*i*s,a[8]=.54627421529*(i*i-n*n)),a}function At(t,e){const r=(i=e.r.length,Object(v.e)(Math.floor(Math.sqrt(i)-1),0,2));var i;for(const n of t)Object(Mt.s)(kt,n.direction),It(kt,r,Ft),Ct(Ft,Gt),Et(Ft,n.intensity[0],Vt),Dt(e.r,Vt),Et(Ft,n.intensity[1],Vt),Dt(e.g,Vt),Et(Ft,n.intensity[2],Vt),Dt(e.b,Vt);return e}function Lt(t,e,r,i){(function(t,e){const r=Pt(t),i=e||{r:[],g:[],b:[]};i.r.length=i.g.length=i.b.length=r;for(let n=0;n<r;n++)i.r[n]=i.g[n]=i.b[n]=0})(e,i),Object(Mt.w)(r.intensity,0,0,0);let n=!1;const s=zt,a=Ht,o=Nt;s.length=0,a.length=0,o.length=0;for(const c of t)c instanceof St&&!n?(Object(Mt.k)(r.direction,c.direction),r.intensity[0]=c.intensity[0],r.intensity[1]=c.intensity[1],r.intensity[2]=c.intensity[2],r.castShadows=c.castShadows,n=!0):c instanceof St||c instanceof Tt?s.push(c):c instanceof wt?a.push(c):c instanceof Rt&&o.push(c);At(s,i),function(t,e){It(kt,0,Ft);for(const r of t)e.r[0]+=Ft[0]*Gt[0]*r.intensity[0]*4*Math.PI,e.g[0]+=Ft[0]*Gt[0]*r.intensity[1]*4*Math.PI,e.b[0]+=Ft[0]*Gt[0]*r.intensity[2]*4*Math.PI}(a,i);for(const c of o)Dt(i.r,c.r),Dt(i.g,c.g),Dt(i.b,c.b)}const zt=[],Ht=[],Nt=[],Ft=[0],Vt=[0],kt=Object(b.e)(),Gt=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class Ut{constructor(){this._shOrder=2,this._ambientBoost=.4,this._oldSunlight={direction:Object(b.e)(),ambient:{color:Object(b.e)(),intensity:1},diffuse:{color:Object(b.e)(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new Rt,this._mainLight={intensity:Object(b.e)(),direction:Object(b.g)(1,0,0),castShadows:!1}}get lightingMainDirection(){return this._mainLight.direction}setLightDirectionUniform(t){t.setUniform3fv("lightingMainDirection",this._mainLight.direction)}setUniforms(t,e=!1){const r=e?(1-this.groundLightingFactor)*(1-this.globalFactor):0;t.setUniform1f("lightingFixedFactor",r),t.setUniform1f("lightingGlobalFactor",this.globalFactor),this.setLightDirectionUniform(t),t.setUniform3fv("lightingMainIntensity",this._mainLight.intensity),t.setUniform1f("ambientBoostFactor",this._ambientBoost);const i=this._sphericalHarmonics;0===this._shOrder?t.setUniform3f("lightingAmbientSH0",i.r[0],i.g[0],i.b[0]):1===this._shOrder?(t.setUniform4f("lightingAmbientSH_R",i.r[0],i.r[1],i.r[2],i.r[3]),t.setUniform4f("lightingAmbientSH_G",i.g[0],i.g[1],i.g[2],i.g[3]),t.setUniform4f("lightingAmbientSH_B",i.b[0],i.b[1],i.b[2],i.b[3])):2===this._shOrder&&(t.setUniform3f("lightingAmbientSH0",i.r[0],i.g[0],i.b[0]),t.setUniform4f("lightingAmbientSH_R1",i.r[1],i.r[2],i.r[3],i.r[4]),t.setUniform4f("lightingAmbientSH_G1",i.g[1],i.g[2],i.g[3],i.g[4]),t.setUniform4f("lightingAmbientSH_B1",i.b[1],i.b[2],i.b[3],i.b[4]),t.setUniform4f("lightingAmbientSH_R2",i.r[5],i.r[6],i.r[7],i.r[8]),t.setUniform4f("lightingAmbientSH_G2",i.g[5],i.g[6],i.g[7],i.g[8]),t.setUniform4f("lightingAmbientSH_B2",i.b[5],i.b[6],i.b[7],i.b[8]))}set(t){Lt(t,this._shOrder,this._mainLight,this._sphericalHarmonics),Object(Mt.k)(this._oldSunlight.direction,this._mainLight.direction);const e=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*e,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*e,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*e,Object(Mt.e)(this._oldSunlight.diffuse.color,this._mainLight.intensity,e),Object(Mt.k)(Wt,this._oldSunlight.diffuse.color),Object(Mt.e)(Wt,Wt,this._ambientBoost*this.globalFactor),Object(Mt.f)(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,Wt)}get old(){return this._oldSunlight}}const Wt=Object(b.e)();class Bt{constructor(t){this._rctx=t,this.cache=new Map}dispose(){this.cache.forEach((t=>t.texture=Object(c.f)(t.texture))),this.cache.clear()}acquire(t){if(Object(c.j)(t))return null;const e=this.patternId(t),r=this.cache.get(e);if(r)return r.refCount++,r.bind;const i=this.patternToTextureData(t,2),n=i.length/2,s={refCount:1,texture:null,bind:t=>(Object(c.j)(s.texture)&&(s.texture=new S.a(this._rctx,{width:i.length,height:1,internalFormat:6406,pixelFormat:6406,dataType:5121,wrapMode:33071},i)),t.bindTexture(s.texture,"stipplePatternTexture"),n)};return this.cache.set(e,s),s.bind}release(t){if(Object(c.j)(t))return;const e=this.patternId(t),r=this.cache.get(e);r&&(r.refCount--,0===r.refCount&&(Object(c.k)(r.texture)&&r.texture.dispose(),this.cache.delete(e)))}swap(t,e){const r=this.acquire(e);return this.release(t),r}patternId(t){return t.join(",")}patternToTextureData(t,e){const r=t.reduce(((t,e)=>t+e))*e,i=new Uint8Array(r);let n=!0,s=0;for(const a of t){for(let t=0;t<a*e;t++)i[s++]=n?255:0;n=!n}return i}}var qt=r(483);const Zt=a.a.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let Yt=class extends(Object(I.b)(n.a)){constructor(t){super(t),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new Ut,this._handles=new s.a,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new h.a,this._geometries=new Map,this.globalUnitScale=1,this.longitudeCyclical=null}initialize(){const t=this.view._stage.renderView;this._rctx=t.renderingContext,this._renderContext=new W(this._rctx);const e=t.waterTextureRepository;this._stippleTextureRepository=new Bt(t.renderingContext),this._shaderTechniqueRepository=new P({rctx:this._rctx,viewingMode:2,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:e}),this._handles.add([Object(d.a)(e,"loadingState",(()=>this.emitContentChanged())),Object(d.a)(this,"spatialReference",(t=>this._localOrigins=new G.a(t)))]),this._materialRepository=new V(t.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=t=>{(t.renderOccluded&ee)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.emitContentChanged(),this.notifyChange("updating")},this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new wt(Object(b.g)(1,1,1))]),this._bindParameters={slot:null,highlightDepthTexture:Object(k.a)(this._rctx),camera:Qt,inverseViewport:Object(g.a)(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null},this._handles.add(this.view.resourceController.scheduler.registerTask(qt.b.STAGE,this))}dispose(){this._handles.destroy(),this._layerRenderers.forEach((t=>t.dispose())),this._layerRenderers.clear(),this._debugTextureTechnique=Object(c.q)(this._debugTextureTechnique),this._debugPatternTexture=Object(c.f)(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=Object(c.f)(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=Object(c.f)(this._shaderTechniqueRepository),this._temporaryFBO=Object(c.f)(this._temporaryFBO),this._quadVAO=Object(c.f)(this._quadVAO),this._overlayRenderTarget=Object(c.f)(this._overlayRenderTarget)}get updating(){return this._sortedLayerRenderersDirty||Object(o.b)(this._layerRenderers,(t=>t.updating))}get hasOverlays(){return Object(c.k)(this._overlays)&&Object(c.k)(this._overlayRenderTarget)}get gpuMemoryUsage(){return Object(c.k)(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}collectUnusedRenderTargetMemory(t){let e=!1;if(Object(c.k)(this._overlayRenderTarget))for(const r of this._overlayRenderTarget.renderTargets){const i=this.overlays[0].validTargets[r.type]||!this.overlays[1].validTargets[r.type];e=this._overlayRenderTarget.validateUsageForTarget(i,r,t)||e}return e}get overlays(){return Object(c.t)(this._overlays,[])}ensureDrapeTargets(t){Object(c.k)(this._overlays)&&this._overlays.forEach((e=>{e.hasTargetWithoutRasterImage=Object(l.a)(t,(t=>1===t.drapeTargetType))}))}ensureDrapeSources(t){Object(c.k)(this._overlays)&&this._overlays.forEach((e=>{e.hasDrapedFeatureSource=Object(o.b)(t,((t,e)=>1===e.drapeSourceType)),e.hasDrapedRasterSource=Object(o.b)(t,((t,e)=>0===e.drapeSourceType))}))}ensureOverlays(t,e){Object(c.j)(this._overlays)&&(this._overlayRenderTarget=new C(this._rctx),this._overlays=[new j(0,this._overlayRenderTarget),new j(1,this._overlayRenderTarget)]),this.ensureDrapeTargets(t),this.ensureDrapeSources(e)}disposeOverlays(){Object(c.k)(this._overlayRenderTarget)&&this._overlayRenderTarget.disposeRenderTargetMemory()}get running(){return this.updating}runTask(t,e=(()=>!0)){let r=!1;for(const[i,n]of this._layerRenderers){if(t.done)break;e(i)&&(n.commitChanges()&&(r=!0,t.madeProgress()),n.isEmpty&&(this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(i),this._handles.remove(i)))}this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),r=!0),r&&(Object(c.k)(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}processSyncLayers(){this.runTask(qt.c,(t=>1===t.updatePolicy))}addGeometries(t,e,r){for(const i of t)Object(c.j)(i.origin)&&(i.origin=this._localOrigins.getOrigin(i.boundingSphere)),this._geometries.set(i.id,i);this.ensureLayerRenderer(e).add(t),2===r&&this.notifyGraphicGeometryChanged(t,e)}removeGeometries(t,e,r){for(const n of t)this._geometries.delete(Object(c.s)(n.id));const i=this._layerRenderers.get(e);i&&(i.remove(t),2===r&&this.notifyGraphicGeometryChanged(t,e))}updateGeometries(t,e,r){const i=this._layerRenderers.get(e);if(i)switch(i.modify(t,r),r){case 4:case 2:return this.notifyGraphicGeometryChanged(t,e);case 1:return this.notifyGraphicVisibilityChanged(t,e)}else Zt.warn("Attempted to update geometry for nonexistent layer")}notifyGraphicGeometryChanged(t,e){if(Object(c.j)(e.notifyGraphicGeometryChanged))return;let r;for(const i of t){const t=i.graphicUid;Object(c.k)(t)&&t!==r&&(e.notifyGraphicGeometryChanged(t),r=t)}}notifyGraphicVisibilityChanged(t,e){if(Object(c.j)(e.notifyGraphicVisibilityChanged))return;let r;for(const i of t){const t=i.graphicUid;Object(c.k)(t)&&t!==r&&(e.notifyGraphicVisibilityChanged(t),r=t)}}updateHighlights(t,e){const r=this._layerRenderers.get(e);r?r.modify(t,8):Zt.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return 0===this._geometries.size&&!m.a.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateLogic(t){let e=!1;return this._layerRenderers.forEach((r=>{r.updateLogic(t)&&(e=!0)})),e}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawTarget(t,e,r){const i=t.canvasGeometries;if(0===i.numViews)return!1;const n=t.pixelRatio*r;this._screenToWorldRatio=n*Math.abs(i.extents[0][2]-i.extents[0][0])/Math.abs(t.viewport[2]-t.viewport[0]);const s=e.renderPass;if(this.isEmpty()||5===s&&!this.hasHighlights||3===s&&!this.hasWater)return!1;if(!t.hasSomeSizedView())return!1;const a=e.fbo,o=2*t.resolution,h=t.resolution,l=1===e.type?2:4===e.type?1:0;if(!a.isValid())return!1;a.resize(o,h);const d=this._rctx;if(Qt.pixelRatio=n||1,this._renderContext.pass=s,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,t.applyViewport(this._rctx),a.bind(d),0===t.index&&(d.setClearColor(0,0,0,0),d.clearSafe(16384)),1===l&&(this._renderContext.renderOccludedMask=ee),m.a.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==l)for(let c=0;c<i.numViews;c++)this.setViewParameters(i.extents[c],t,Qt),this.drawDebugTexture(t.resolution,Xt[t.index%Xt.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({layerView:e,renderer:r})=>{if(2===l&&Object(c.k)(e)&&0===e.drapeSourceType)return;const n=Object(c.k)(e)&&Object(c.k)(e.fullOpacity)&&e.fullOpacity<1&&0===s;n&&(this.bindTemporaryFramebuffer(this._rctx,o,h),d.clearSafe(16384));for(let s=0;s<i.numViews;s++)this.setViewParameters(i.extents[s],t,Qt),r.render(this._renderContext,this._bindParameters);n&&Object(c.k)(this._temporaryFBO)&&(a.bind(d),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),2,Object(c.s)(Object(c.s)(e).fullOpacity),3,t.index))})),d.bindFramebuffer(null),a.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(t,e,r){Object(c.j)(this._temporaryFBO)&&(this._temporaryFBO=new M(t,!1)),this._temporaryFBO.resize(e,r),this._temporaryFBO.bind(t)}async reloadShaders(){await this._shaderTechniqueRepository.hotReload()}intersect(t,e,r){let i=0;this._geometries.forEach((n=>{if(r&&!r(n))return;this.intersectRenderGeometry(n,e,0,t,i);const s=this.longitudeCyclical;s&&(n.boundingSphere[0]-n.boundingSphere[3]<s.min&&this.intersectRenderGeometry(n,e,s.range,t,i),n.boundingSphere[0]+n.boundingSphere[3]>s.max&&this.intersectRenderGeometry(n,e,-s.range,t,i)),i++}))}intersectRenderGeometry(t,e,r,i,n){if(!t.instanceParameters.visible)return;let s=0;Object(c.k)(t.transformation)&&(r+=t.transformation[12],s=t.transformation[13]),Jt[0]=e[0]-r,Jt[1]=e[1]-s,Jt[2]=1,Kt[0]=e[0]-r,Kt[1]=e[1]-s,Kt[2]=0,t.screenToWorldRatio=this._screenToWorldRatio,t.material.intersect(t,null,t.getShaderTransformation(),i,Jt,Kt,((e,r,s)=>{this.addIntersectionResult(s,t.material.renderPriority,n,i,t.layerUid,t.graphicUid)}),t.calculateShaderTransformation,!0)}addIntersectionResult(t,e,r,i,n,s){const a={type:"external",metadata:{layerUid:n,graphicUid:s}},o=n=>{n.set(a,null,i.results.ground.dist,i.results.ground.normal,i.results.ground.transformation,e,null,null,t,r),n.intersector="OverlayRenderer"};if((null==i.results.min.drapedLayerOrder||e>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&o(i.results.min),0!==i.options.store&&(null==i.results.max.drapedLayerOrder||e<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&o(i.results.max),2===i.options.store){const t=new U.a(i.ray);o(t),i.results.all.push(t)}}stopAnimationsAtTime(t){this._sortedLayerRenderers.forAll((e=>e.renderer.stopAnimationsAtTime(t)))}ensureLayerRenderer(t){let e=this._layerRenderers.get(t);return e||(e=new pt({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(t,e),this._sortedLayerRenderersDirty=!0,"fullOpacity"in t&&this._handles.add(t.watch("fullOpacity",(()=>this.emitContentChanged())),t),this._handles.add(Object(d.a)(e,"updating",(()=>this.notifyChange("updating"))),t)),e}updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const t=new Set(this._layerRenderers.values());this.view.allLayerViews.forEach((e=>{const r=e,i=this._layerRenderers.get(r);i&&(this._sortedLayerRenderers.push(new $t(r,i)),t.delete(i))})),t.forEach((t=>this._sortedLayerRenderers.push(new $t(null,t))))}setViewParameters(t,e,r){r.viewport=e.viewport,Object(f.o)(r.projectionMatrix,0,t[2]-t[0],0,t[3]-t[1],r.near,r.far),Object(f.i)(r.viewMatrix),Object(f.t)(r.viewMatrix,r.viewMatrix,[-t[0],-t[1],0]),this._renderContext.camera=r,this._bindParameters.camera=r,this._bindParameters.inverseViewport[0]=1/r.fullViewport[2],this._bindParameters.inverseViewport[1]=1/r.fullViewport[3]}emitContentChanged(){this.onContentChanged&&this.onContentChanged()}updateHasWater(){const t=Object(o.b)(this._layerRenderers,(t=>t.hasWater));t!==this._hasWater&&(this._hasWater=t,this.onHasWaterChanged&&this.onHasWaterChanged(t))}updateHasHighlights(){const t=Object(o.b)(this._layerRenderers,(t=>t.hasHighlights));t!==this._hasHighlights&&(this._hasHighlights=t,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))}updateRendersOccluded(){const t=Object(o.b)(this._layerRenderers,(t=>t.rendersOccluded));t!==this._rendersOccluded&&(this._rendersOccluded=t,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))}drawDebugTexture(t,e){const r=this._rctx;this.ensureDebugPatternResources(t,t);const i=this._debugTextureTechnique.program;r.useProgram(i),r.setPipelineState(this._debugTextureTechnique.pipeline),i.setUniform4f("color",e[0],e[1],e[2],1),i.bindTexture(this._debugPatternTexture,"tex"),r.bindVAO(this._quadVAO),r.drawArrays(5,0,Object(at.f)(this._quadVAO,"geometry"))}ensureDebugPatternResources(t,e){if(this._debugPatternTexture)return;const r=new Uint8Array(t*e*4);let i=0;for(let s=0;s<e;s++)for(let n=0;n<t;n++){const a=Math.floor(n/10),o=Math.floor(s/10);a<2||o<2||10*a>t-20||10*o>e-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&a&&1&o?1&n^1&s?0:255:1&a^1&o?0:128)}this._debugPatternTexture=new S.a(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:t,height:e},r);const n=new xt;n.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(jt,n),this._quadVAO=Object(k.b)(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};Object(i.a)([Object(I.c)()],Yt.prototype,"_shaderTechniqueRepository",void 0),Object(i.a)([Object(I.c)()],Yt.prototype,"_stippleTextureRepository",void 0),Object(i.a)([Object(u.b)({constructOnly:!0})],Yt.prototype,"view",void 0),Object(i.a)([Object(u.b)()],Yt.prototype,"globalUnitScale",void 0),Object(i.a)([Object(u.b)()],Yt.prototype,"spatialReference",void 0),Object(i.a)([Object(u.b)({type:Boolean,readOnly:!0})],Yt.prototype,"updating",null),Yt=Object(i.a)([Object(p.a)("esri.views.3d.terrain.OverlayRenderer")],Yt);class $t{constructor(t,e){this.layerView=t,this.renderer=e}}const Xt=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],Qt=new A.a;Qt.near=1,Qt.far=1e4,Qt.relativeElevation=null;const Jt=Object(b.e)(),Kt=Object(b.e)(),te=-2,ee=4},841:function(t,e,r){"use strict";r.d(e,"a",(function(){return f}));var i=r(85),n=r(153),s=r(103),a=r(101),o=r(175),c=r(397),h=r(754),l=r(403),d=r(508),u=r(434);let p=0;class f{constructor(t){this._originSR=t,this.ROOT_ORIGIN_ID="rg_root_"+p++,this._origins=new Map,this._gridSize=125e4,this._objects=new Map}getOrigin(t){const e=this._origins.get(this.ROOT_ORIGIN_ID);if(null==e){if(Object(i.k)(g))return this._origins.set(this.ROOT_ORIGIN_ID,Object(h.a)(g[0],g[1],g[2],this.ROOT_ORIGIN_ID)),this.getOrigin(t);const e=Object(h.a)(t[0]+Math.random()-.5,t[1]+Math.random()-.5,t[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,e),e}const r=this._gridSize,n=Math.round(t[0]/r),a=Math.round(t[1]/r),o=Math.round(t[2]/r),c=`rg_${n}/${a}/${o}`;let l=this._origins.get(c);const d=.5*r;if(Object(s.j)(b,t,e.vec3),b[0]=Math.abs(b[0]),b[1]=Math.abs(b[1]),b[2]=Math.abs(b[2]),b[0]<d&&b[1]<d&&b[2]<d){if(l){const e=Math.max(...b);if(Object(s.j)(b,t,l.vec3),b[0]=Math.abs(b[0]),b[1]=Math.abs(b[1]),b[2]=Math.abs(b[2]),Math.max(...b)<e)return l}return e}return l||(l=Object(h.a)(n*r,a*r,o*r,c),this._origins.set(c,l)),l}_drawOriginBox(t,e=[1,1,0,1]){const r=window.view,i=r._stage,s=e.toString();if(!this._objects.has(s)){this._material=new u.a({width:2,color:e}),i.add(this._material);const t=new d.a({isPickable:!1}),r=new l.a({castShadow:!1});i.add(r),t.add(r),i.add(t),this._objects.set(s,r)}const a=this._objects.get(s),h=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],p=h.length,f=new Array(3*p),g=new Uint16Array(2*(p-1)),b=.5*this._gridSize;for(let n=0;n<p;n++)f[3*n+0]=t[0]+(1&h[n]?b:-b),f[3*n+1]=t[1]+(2&h[n]?b:-b),f[3*n+2]=t[2]+(4&h[n]?b:-b),n>0&&(g[2*n+0]=n-1,g[2*n+1]=n);Object(o.m)(f,this._originSR,0,f,r.renderSpatialReference,0,p);const m=new c.a([["position",{size:3,data:f,exclusive:!0}]],[["position",g]],2);i.add(m),a.addGeometry(m,this._material,n.a)}get test(){const t=this;return{get gridSize(){return t._gridSize},set gridSize(e){t._gridSize=e}}}}let g=null;const b=Object(a.e)()},842:function(t,e,r){"use strict";r.d(e,"a",(function(){return s}));var i=r(373),n=r(843);class s extends i.a{constructor(t){super(t),this.updateParameters()}updateParameters(t){this._technique=this._techniqueRep.releaseAndAcquire(n.a,this._material.getTechniqueConfig(this._output,t),this._technique)}beginSlot(t){if(2===this._output)return 22===t;if(5===this._output)return null==t;if(4===this._output)return 3===t;let e=3;return this._material.params.transparent&&(e=this._material.params.writeDepth?5:8),t===e}setElapsedTimeUniform(t){const e=.001*this._material.animation.time;t.setUniform1f("timeElapsed",e*this._material.params.animationSpeed)}_updateShadowState(t){t.shadowMappingEnabled!==this._material.params.receiveShadows&&this._material.setParameterValues({receiveShadows:t.shadowMappingEnabled})}_updateSSRState(t){t.ssrEnabled!==this._material.params.ssrEnabled&&this._material.setParameterValues({ssrEnabled:t.ssrEnabled})}ensureResources(t){return this._technique.ensureResource(t)}ensureParameters(t){0===this._output&&(this._updateShadowState(t),this._updateSSRState(t)),this.updateParameters(t)}bind(t){this._technique.bindPass(this._material.params,t),2!==this._output&&0!==this._output||this.setElapsedTimeUniform(this._technique.program)}}},843:function(t,e,r){"use strict";r.d(e,"a",(function(){return _})),r.d(e,"b",(function(){return O}));var i=r(81),n=r(237),s=r(303),a=r(259),o=r(542),c=r(761),h=r(723),l=r(366),d=r(294),u=r(301),p=r(305),f=r(302),g=r(333),b=r(295),m=r(796),v=r(279);class _ extends u.a{constructor(t,e,r){super(t,e,r),this._textureRepository=t.waterTextureRepository}initializeProgram(t){const e=_.shader.get(),r=this.configuration,i=e.build({OITEnabled:0===r.transparencyPassType,output:r.output,viewingMode:t.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:r.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:r.useSSR,highStepCount:!0,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new b.a(t.rctx,i,f.a)}ensureResource(t){return this._textureRepository.ready||this._textureRepository.updating||this._textureRepository.loadTextures(t),this._textureRepository.ready?2:1}bindPass(t,e){Object(l.c)(this.program,e.camera.projectionMatrix),e.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",e.camera.nearFar),this.program.setUniform2fv("inverseViewport",e.inverseViewport),Object(a.a)(this.program,e)),0===this.configuration.output&&(e.lighting.setUniforms(this.program,!1),Object(c.b)(this.program,e)),0!==this.configuration.output&&2!==this.configuration.output||(Object(h.b)(this.program,t),this._textureRepository.bind(this.program)),this.program.setUniform4fv("waterColor",t.color),4===this.configuration.output&&Object(s.b)(this.program,e)}bindDraw(t){Object(l.d)(this.program,t),this.program.rebindTextures(),0!==this.configuration.output&&7!==this.configuration.output||Object(l.a)(this.program,t.origin,t.camera.viewInverseTransposeMatrix),0===this.configuration.output&&Object(o.b)(this.program,t),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||Object(n.c)(this.program,this.configuration,t)}setPipelineState(t){const e=this.configuration,r=3===t,i=2===t;return Object(v.f)({blending:2!==e.output&&4!==e.output&&e.transparent?r?g.f:Object(g.a)(t):null,depthTest:{func:Object(g.b)(t)},depthWrite:r?e.writeDepth&&v.d:Object(g.c)(t),colorWrite:v.c,polygonOffset:r||i?null:Object(g.g)(e.enableOffset)})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}_.shader=new d.a(m.a,(()=>r.e(318).then(r.bind(null,1120))));class O extends p.a{constructor(){super(...arguments),this.output=0,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(i.a)([Object(p.b)({count:8})],O.prototype,"output",void 0),Object(i.a)([Object(p.b)()],O.prototype,"receiveShadows",void 0),Object(i.a)([Object(p.b)()],O.prototype,"slicePlaneEnabled",void 0),Object(i.a)([Object(p.b)()],O.prototype,"transparent",void 0),Object(i.a)([Object(p.b)()],O.prototype,"enableOffset",void 0),Object(i.a)([Object(p.b)()],O.prototype,"writeDepth",void 0),Object(i.a)([Object(p.b)()],O.prototype,"useSSR",void 0),Object(i.a)([Object(p.b)()],O.prototype,"isDraped",void 0),Object(i.a)([Object(p.b)({count:4})],O.prototype,"transparencyPassType",void 0),Object(i.a)([Object(p.b)()],O.prototype,"multipassTerrainEnabled",void 0),Object(i.a)([Object(p.b)()],O.prototype,"cullAboveGround",void 0)},863:function(t,e,r){"use strict";r.d(e,"a",(function(){return c}));var i=r(755),n=r(112);function s(t){t.fragment.code.add(n.a`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}var a=r(664),o=r(761);function c(t,e){t.include(a.a,e),t.include(s),t.include(i.a),e.ssrEnabled&&t.include(o.a,e),t.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.775).add("waterSeeColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]),t.fragment.code.add(n.a`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),t.fragment.code.add(n.a`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {
float reflectionHit = 0.;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}`),e.ssrEnabled?t.fragment.code.add(n.a`vec4 viewPosition = vec4(positionView.xyz, 1.0);
vec3 viewDir = normalize(viewPosition.xyz);
vec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = ssrViewMat *vec4(localUp, 0.0);
float correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);
vec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));
vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
reflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;
reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;
}
float seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);
return tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);
}`):t.fragment.code.add(n.a`return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);
}`)}},900:function(t,e,r){"use strict";r.d(e,"a",(function(){return p}));var i=r(85),n=r(214),s=r(142),a=r(153),o=r(103),c=r(183),h=r(468),l=r(367),d=r(632),u=r(350);class p{constructor(t,e,r=null,i=null,s=Object(n.a)(),o=null,h=null,l=!1){this.data=t,this.material=e,this.layerUid=r,this.graphicUid=i,this.id=s,this.boundingInfo=o,this.calculateShaderTransformation=h,this.castShadow=l,this.boundingSphere=Object(c.e)(),this.instanceParameters={highlights:null,occludees:null,visible:!0},this._transformation=Object(a.d)(),this._shaderTransformationDirty=!0}get transformation(){return this._transformation}updateTransformation(t){t(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(t,e,r=Object(h.d)(t)){Object(i.j)(this.boundingInfo)||(Object(o.q)(e,this.boundingInfo.getCenter(),t),e[3]=this.boundingInfo.getBSRadius()*r)}get hasShaderTransformation(){return Object(i.k)(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return Object(i.j)(this.calculateShaderTransformation)?Object(i.t)(this.transformation,a.a):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=Object(a.d)()),Object(s.d)(this._shaderTransformation,this.calculateShaderTransformation(Object(i.t)(this.transformation,a.a))),this._shaderTransformationDirty=!1),this._shaderTransformation)}computeAttachmentOrigin(t){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,t)&&(Object(i.k)(this._transformation)&&Object(o.q)(t,t,this._transformation),!0);const e=this.indices.get("position"),r=this.vertexAttributes.get("position");return!!Object(l.c)(r,e,t)&&(Object(i.k)(this._transformation)&&Object(o.q)(t,t,this._transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const t=new d.a(0),e=this.instanceParameters;return e.highlights=Object(u.b)(e.highlights,t),t}removeHighlight(t){const e=this.instanceParameters;e.highlights=Object(u.g)(e.highlights,t)}}},901:function(t,e,r){"use strict";r.d(e,"a",(function(){return f})),r.d(e,"b",(function(){return g})),r.d(e,"c",(function(){return m})),r.d(e,"d",(function(){return b}));var i=r(85),n=r(153),s=r(101),a=r(175),o=r(236),c=r(261),h=r(349),l=r(430),d=r(414),u=r(403);const p=Object(s.e)();function f(t,e,r,s,c,h,d,f,g,b){const m=r?r.length:0,v=t.clippingExtent;if(Object(a.q)(e,p,t.elevationProvider.spatialReference),Object(i.k)(v)&&!Object(o.e)(v,p))return null;const _=t.renderCoordsHelper.spatialReference;Object(a.q)(e,p,_);const O=t.localOriginFactory.getOrigin(p),y=new u.a({castShadow:!1,metadata:{layerUid:f,graphicUid:g,usesVerticalDistanceToGround:!0}});for(let i=0;i<m;i++){const t=c?c[i]:n.a;y.addGeometry(r[i],s[i],t,h,O,b)}return{object:y,sampledElevation:Object(l.b)(y,e,t.elevationProvider,t.renderCoordsHelper,d)}}function g(t,e,r){const i=t.elevationContext,n=r.spatialReference;Object(a.q)(e,p,n),i.centerPointInElevationSR=Object(h.g)(p[0],p[1],e.hasZ?p[2]:0,n)}function b(t){switch(t.type){case"point":return t;case"polygon":case"extent":return Object(d.a)(t);case"polyline":{const e=t.paths[0];if(!e||0===e.length)return null;const r=Object(c.f)(e,Object(c.e)(e)/2);return Object(h.g)(r[0],r[1],r[2],t.spatialReference)}case"mesh":return t.origin}return null}function m(t,e,r,i,n){const s=new Float64Array(3*t.length),a=new Float64Array(s.length);t.forEach(((t,e)=>{s[3*e+0]=t[0],s[3*e+1]=t[1],s[3*e+2]=t.length>2?t[2]:0}));const o=Object(l.c)(s,e,0,a,0,s,0,s.length/3,r,i,n),c=null!=o;return{numVertices:t.length,position:s,mapPosition:a,projectionSuccess:c,sampledElevation:o}}}}]);
//# sourceMappingURL=13.1d9367da.chunk.js.map