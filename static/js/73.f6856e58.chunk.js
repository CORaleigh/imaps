(this.webpackJsonpimaps=this.webpackJsonpimaps||[]).push([[73,35],{1001:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(367),a=i(446);const n={vvSizeEnabled:!1,vvSizeMinSize:Object(a.c)(1,1,1),vvSizeMaxSize:Object(a.c)(100,100,100),vvSizeOffset:Object(a.c)(0,0,0),vvSizeFactor:Object(a.c)(1,1,1),vvSizeValue:Object(a.c)(1,1,1),vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvOpacityEnabled:!1,vvOpacityValues:[0,0,0,0,0,0,0,0],vvOpacityOpacities:[1,1,1,1,1,1,1,1],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:Object(r.b)()}},1002:function(e,t,i){"use strict";var r,a,n;i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return a})),function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"}(r||(r={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(a||(a={})),function(e){e[e.LAYER_VIEW=0]="LAYER_VIEW",e[e.EXTERNAL=1]="EXTERNAL"}(n||(n={}))},1003:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return _})),i.d(t,"c",(function(){return j})),i.d(t,"d",(function(){return S})),i.d(t,"e",(function(){return E}));i(82);var r,a,n=i(85),s=i(549),o=i(151),c=i(117),l=i(109),d=i(187),h=i(208),u=i(943),p=i(272),f=i(1004),b=i(607),m=i(1027),g=i(163),v=i(595),O=i(139),y=i(770);function _(e){const t=[],i=[];!function(e,t,i){const{attributeData:{position:a},removeDuplicateStartEnd:n}=e,o=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(a)&&n===r.REMOVE,c=a.length/3-(o?1:0),l=new Uint32Array(2*(c-1)),d=o?Object(s.m)(a,0,a.length-3):a;let h=0;for(let r=0;r<c-1;r++)l[h++]=r,l[h++]=r+1;t.push([O.a.POSITION,{size:3,data:d,exclusive:o}]),i.push([O.a.POSITION,l])}(e,i,t);const a=i[0][1].data,l=t[0][1].length,u=new Uint16Array(l);return function(e,t,i){const r=e.attributeData.mapPosition;Object(n.j)(r)||(i.push([O.a.MAPPOS,i[0][1]]),t.push([O.a.MAPPOS,{size:3,data:r}]))}(e,i,t),function(e,t,i,r){if(Object(n.k)(e.attributeData.colorFeature))return;const a=e.attributeData.color;t.push([O.a.COLOR,{size:4,data:Object(n.t)(a,f.c)}]),i.push([O.a.COLOR,r])}(e,i,t,u),function(e,t,i,r){if(Object(n.k)(e.attributeData.sizeFeature))return;const a=e.attributeData.size;t.push([O.a.SIZE,{size:1,data:[Object(n.t)(a,1)]}]),i.push([O.a.SIZE,r])}(e,i,t,u),function(e,t,i,r){const a=e.attributeData.colorFeature;Object(n.j)(a)||(t.push([O.a.COLORFEATUREATTRIBUTE,{size:1,data:new Float32Array([a])}]),i.push([O.a.COLOR,r]))}(e,i,t,u),function(e,t,i,r){const a=e.attributeData.sizeFeature;Object(n.j)(a)||(t.push([O.a.SIZEFEATUREATTRIBUTE,{size:1,data:new Float32Array([a])}]),i.push([O.a.SIZEFEATUREATTRIBUTE,r]))}(e,i,t,u),function(e,t,i,r){const a=e.attributeData.opacityFeature;Object(n.j)(a)||(t.push([O.a.OPACITYFEATUREATTRIBUTE,{size:1,data:new Float32Array([a])}]),i.push([O.a.OPACITYFEATUREATTRIBUTE,r]))}(e,i,t,u),function(e,t,i,r){if(Object(n.j)(e.overlayInfo)||e.overlayInfo.renderCoordsHelper.viewingMode!==p.a.Global||!e.overlayInfo.spatialReference.isGeographic)return;const a=new Float64Array(r.length),s=Object(h.e)(e.overlayInfo.spatialReference);for(let n=0;n<a.length;n+=3)Object(d.i)(r,n,a,n,s);const l=r.length/3,u=new Float32Array(l+1);let f=T,b=C,m=0,g=0;Object(c.w)(f,a[g++],a[g++],a[g++]),u[0]=0;for(let n=1;n<l+1;++n)n===l&&(g=0),Object(c.w)(b,a[g++],a[g++],a[g++]),m+=Object(o.d)(f,b),u[n]=m,[f,b]=[b,f];t.push([O.a.DISTANCETOSTART,{size:1,data:u}]),i.push([O.a.DISTANCETOSTART,i[0][1]])}(e,i,t,a),new v.a(i,t,g.f.Line)}function j(e,t,i,r){const a="polygon"===e.type?u.a.CCW_IS_HOLE:u.a.NONE,n="polygon"===e.type?e.rings:e.paths,{position:s,outlines:o}=Object(u.b)(n,e.hasZ,a),c=new Float64Array(s.length),l=Object(b.d)(s,e.spatialReference,0,c,0,s,0,s.length/3,t,i,r),d=null!=l;return{lines:d?x(o,s,c):[],projectionSuccess:d,sampledElevation:l}}function x(e,t,i){const r=new Array;for(const{index:a,count:n}of e){if(n<=1)continue;const e=3*a,s=e+3*n;r.push({position:t.subarray(e,s),mapPosition:i?i.subarray(e,s):void 0})}return r}function S(e,t){const i="polygon"===e.type?u.a.CCW_IS_HOLE:u.a.NONE,r="polygon"===e.type?e.rings:e.paths,{position:a,outlines:n}=Object(u.b)(r,!1,i),s=Object(d.l)(a,e.spatialReference,0,a,t,0,a.length/3);for(let o=2;o<a.length;o+=3)a[o]=m.a;return{lines:s?x(n,a):[],projectionSuccess:s}}(a=r||(r={}))[a.KEEP=0]="KEEP",a[a.REMOVE=1]="REMOVE";const T=Object(l.f)(),C=Object(l.f)();function E(e){switch(e){case"butt":return y.a.BUTT;case"square":return y.a.SQUARE;case"round":return y.a.ROUND;default:return null}}},1004:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return n})),i.d(t,"c",(function(){return s}));var r=i(257);const a=1.2,n=r.b,s=r.a},1005:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(109);class a{constructor(e,t){this.vec3=e,this.id=t}}function n(e,t,i,n){return new a(Object(r.h)(e,t,i),n)}},1006:function(e,t,i){"use strict";i.d(t,"a",(function(){return b})),i.d(t,"b",(function(){return f}));var r=i(799),a=i(800),n=i(947),s=i(502),o=i(730),c=i(948),l=i(464),d=i(500),h=i(126),u=i(297),p=i(139);function f(){const e=new u.a;return e.attributes.add(p.a.POSITION,"vec2"),e.varyings.add("worldRay","vec3"),e.vertex.uniforms.add("inverseProjectionMatrix","mat4"),e.vertex.uniforms.add("inverseViewMatrix","mat4"),e.vertex.code.add(h.a`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),e.fragment.uniforms.add("lightingMainDirection","vec3"),e.fragment.include(l.a),e.fragment.include(d.a),e.include(a.a),e.include(r.a,{pbrMode:s.a.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(o.a),e.include(n.a),e.include(c.a),e.fragment.code.add(h.a`void main() {
vec4 cloudsColor = crossFade == 0 ? renderCloud(normalize(worldRay), cameraPosition) : renderCloudCrossFade(normalize(worldRay), cameraPosition);
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),e}const b=Object.freeze({__proto__:null,build:f})},1007:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return a}));var r=i(126);function a(e){e.fragment.code.add(r.a`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function n(e){e.fragment.code.add(r.a`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}},1008:function(e,t,i){"use strict";i.d(t,"a",(function(){return x})),i.d(t,"b",(function(){return j}));var r=i(732),a=i(210),n=i(301),s=i(478),o=i(420),c=i(410),l=i(799),d=i(800),h=i(356),u=i(950),p=i(502),f=i(625),b=i(1086),m=i(949),g=i(397),v=i(464),O=i(126),y=i(297),_=i(139);function j(e){const t=new y.a;return t.include(s.a,{linearDepth:!1}),t.attributes.add(_.a.POSITION,"vec3"),t.attributes.add(_.a.UV0,"vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),e.output!==a.a.Color&&e.output!==a.a.Alpha||(t.include(u.a,e),t.include(r.a,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),t.fragment.uniforms.add("localOrigin","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(O.a`
      void main(void) {
        if (waterColor.a < ${O.a.float(g.c)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${e.output===a.a.Color?"forwardLinearDepth();":""}
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(c.a),t.include(h.b,e)),e.output===a.a.Alpha&&(t.include(n.a,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(O.a`
        void main() {
          discardBySlice(vpos);
          ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),e.output===a.a.Color&&(t.include(d.a),t.include(l.a,{pbrMode:p.a.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(m.a,e),t.include(n.a,e),e.receiveShadows&&t.include(f.a,e),t.include(b.a,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("lightingSpecularStrength","float").add("lightingEnvironmentStrength","float").add("cameraPosition","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(v.a),t.fragment.code.add(O.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${e.receiveShadows?O.a`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output===a.a.Normal&&(t.include(u.a,e),t.include(m.a,e),t.include(n.a,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(O.a`
        void main(void) {
          if (waterColor.a < ${O.a.float(g.c)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(O.a`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`)),e.output===a.a.Draped&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(O.a`
        void main(void) {
          if (waterColor.a < ${O.a.float(g.c)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(O.a`void main() {
gl_FragColor = waterColor;
}`)),e.output===a.a.Highlight&&(t.include(o.a),t.varyings.add("vpos","vec3"),t.vertex.code.add(O.a`
      void main(void) {
        if (waterColor.a < ${O.a.float(g.c)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(n.a,e),t.fragment.code.add(O.a`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}const x=Object.freeze({__proto__:null,build:j})},1009:function(e,t,i){"use strict";i.d(t,"a",(function(){return d})),i.d(t,"b",(function(){return l}));var r=i(687),a=i(397),n=i(126),s=i(297),o=i(163),c=i(626);function l(e){const t=new s.a,{mode:i}=e;return t.include(r.a),t.include(a.a,{alphaDiscardMode:o.a.Blend}),t.fragment.uniforms.add("densityMap","sampler2D"),t.fragment.uniforms.add("tex","sampler2D"),t.fragment.uniforms.add("densityNormalizer","float"),t.fragment.uniforms.add("minDensity","float"),i===c.a.KernelDensity&&t.fragment.uniforms.add("densityMultiplier","float"),t.fragment.code.add(n.a`
    void main() {
      float density = texture2D(densityMap, uv).r${i===c.a.KernelDensity?n.a` * densityMultiplier`:""};
      float densityRatio = (density - minDensity) * densityNormalizer;

      vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));

      discardOrAdjustAlpha(color);
      gl_FragColor = color;
    }
  `),t}const d=Object.freeze({__proto__:null,build:l,get HeatmapMode(){return c.a}})},1010:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return s}));var r=i(687),a=i(126),n=i(297);function s(){const e=new n.a;return e.include(r.a),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("uColor","vec4"),e.fragment.code.add(a.a`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * uColor;
}`),e}const o=Object.freeze({__proto__:null,build:s})},1011:function(e,t,i){"use strict";i.d(t,"a",(function(){return f})),i.d(t,"b",(function(){return p}));var r=i(210),a=i(301),n=i(478),s=i(624),o=i(420),c=i(894),l=i(397),d=i(126),h=i(297),u=i(139);function p(e){const t=new h.a;return t.include(n.a,{linearDepth:!1}),t.include(s.a,e),t.include(c.a,{...e,stippleRequiresStretchMeasure:!1}),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),e.stippleEnabled&&(t.vertex.uniforms.add("ndcToPixel","vec2"),t.attributes.add(u.a.UV0,"vec2"),t.attributes.add(u.a.AUXPOS1,"vec3")),t.attributes.add(u.a.POSITION,"vec3"),t.varyings.add("vpos","vec3"),t.vertex.code.add(d.a`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),e.stippleEnabled&&(t.vertex.code.add(d.a`vec4 vpos2 = transformPosition(proj, view, auxpos1);
float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);`),e.draped||t.vertex.code.add(d.a`vec3 segmentCenter = (position + auxpos1) * 0.5;
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),t.vertex.code.add(d.a`float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);`),e.draped?t.vertex.code.add(d.a`float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);
float segmentLengthPseudoScreen = lineSegmentPixelSize;`):t.vertex.code.add(d.a`float segmentLengthRender = length(position - auxpos1);
float startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),t.vertex.code.add(d.a`vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);
vStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);
vStippleDistance *= gl_Position.w;`)),t.vertex.code.add(d.a`}`),e.output===r.a.Highlight&&t.include(o.a),t.include(a.a,e),t.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),t.fragment.code.add(d.a`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${e.attributeColor?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${d.a.float(l.c)}) {
      discard;
    }

    ${e.output===r.a.Color?d.a`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===r.a.Highlight?d.a`outputHighlight();`:""}
  }
  `),t}const f=Object.freeze({__proto__:null,build:p})},1012:function(e,t,i){"use strict";i.d(t,"a",(function(){return L})),i.d(t,"b",(function(){return M}));var r=i(272),a=i(732),n=i(898),s=i(210),o=i(301),c=i(478),l=i(830),d=i(703),h=i(802),u=i(914),p=i(639),f=i(624),b=i(915),m=i(731),g=i(899),v=i(410),O=i(1090),y=i(773),_=i(832),j=i(356),x=i(689),S=i(754),T=i(502),C=i(625),E=i(623),A=i(397),w=i(1091),R=i(900),P=i(126),I=i(297),D=i(139);function M(e){const t=new I.a,i=t.vertex.code,M=t.fragment.code;t.include(w.a,{name:"Default Material Shader",output:e.output}),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraPosition","vec3").add("localOrigin","vec3");const L=e.hasModelTransformation;return L&&t.vertex.uniforms.add("model","mat4"),t.include(h.a),t.varyings.add("vpos","vec3"),t.include(E.a,e),t.include(l.a,e),t.include(m.a,e),e.output!==s.a.Color&&e.output!==s.a.Alpha||(t.include(d.a,e),t.include(c.a,{linearDepth:!1,hasModelTransformation:L}),e.normalType===d.b.Attribute&&e.offsetBackfaces&&t.include(n.a),t.include(O.a,e),t.include(b.a,e),e.instancedColor&&t.attributes.add(D.a.INSTANCECOLOR,"vec4"),t.varyings.add("localvpos","vec3"),t.include(p.a,e),t.include(a.a,e),t.include(u.a,e),t.include(f.a,e),t.vertex.uniforms.add("externalColor","vec4"),t.varyings.add("vcolorExt","vec4"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),i.add(P.a`
      void main(void) {
        forwardNormalizedVertexColor();
        vcolorExt = externalColor;
        ${e.instancedColor?"vcolorExt *= instanceColor;":""}
        vcolorExt *= vvColor();
        vcolorExt *= getSymbolColor();
        forwardColorMixMode();

        if (vcolorExt.a < ${P.a.float(A.c)}) {
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        }
        else {
          vpos = calculateVPos();
          localvpos = vpos - view[3].xyz;
          vpos = subtractOrigin(vpos);
          ${e.normalType===d.b.Attribute?P.a`
          vNormalWorld = dpNormal(vvLocalNormal(normalModel()));`:""}
          vpos = addVerticalOffset(vpos, localOrigin);
          ${e.vertexTangents?"vTangent = dpTransformVertexTangent(tangent);":""}
          gl_Position = transformPosition(proj, view, ${L?"model,":""} vpos);
          ${e.normalType===d.b.Attribute&&e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
        }

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        forwardLinearDepth();
        forwardTextureCoordinates();
      }
    `)),e.output===s.a.Alpha&&(t.include(o.a,e),t.include(A.a,e),e.multipassTerrainEnabled&&(t.fragment.include(v.a),t.include(j.b,e)),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("opacity","float").add("layerOpacity","float"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.fragment.include(R.a),M.add(P.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${e.hasColorTexture?P.a`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:P.a`vec4 texColor = vec4(1.0);`}
        ${e.attributeColor?P.a`
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:P.a`
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        gl_FragColor = vec4(opacity_);
      }
    `)),e.output===s.a.Color&&(t.include(o.a,e),t.include(_.a,e),t.include(y.a,e),t.include(A.a,e),e.receiveShadows&&t.include(C.a,e),e.multipassTerrainEnabled&&(t.fragment.include(v.a),t.include(j.b,e)),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("opacity","float").add("layerOpacity","float"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.include(T.b,e),t.include(S.a,e),t.fragment.include(R.a),t.include(x.a,e),M.add(P.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${e.hasColorTexture?P.a`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:P.a`vec4 texColor = vec4(1.0);`}
        shadingParams.viewDirection = normalize(vpos - cameraPosition);
        ${e.normalType===d.b.ScreenDerivative?P.a`
        vec3 normal = screenDerivativeNormal(localvpos);`:P.a`
        shadingParams.normalView = vNormalWorld;
        vec3 normal = shadingNormal(shadingParams);`}
        ${e.pbrMode===T.a.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.viewingMode===r.a.Global?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${e.attributeColor?P.a`
        vec3 albedo_ = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:P.a`
        vec3 albedo_ = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        ${e.hasNormalTexture?P.a`
              mat3 tangentSpace = ${e.vertexTangents?"computeTangentSpace(normal);":"computeTangentSpace(normal, vpos, vuv0);"}
              vec3 shadedNormal = computeTextureNormal(tangentSpace, vuv0);`:"vec3 shadedNormal = normal;"}
        ${e.pbrMode===T.a.Normal||e.pbrMode===T.a.Schematic?e.viewingMode===r.a.Global?P.a`vec3 normalGround = normalize(vpos + localOrigin);`:P.a`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:P.a``}
        ${e.pbrMode===T.a.Normal||e.pbrMode===T.a.Schematic?P.a`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
            vec3 shadedColor = evaluateSceneLightingPBR(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:"vec3 shadedColor = evaluateSceneLighting(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight);"}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.include(g.a,e),t}const L=Object.freeze({__proto__:null,build:M})},1013:function(e,t,i){"use strict";i.d(t,"a",(function(){return P})),i.d(t,"b",(function(){return R}));var r=i(272),a=i(732),n=i(898),s=i(210),o=i(301),c=i(478),l=i(830),d=i(703),h=i(802),u=i(914),p=i(639),f=i(624),b=i(731),m=i(899),g=i(410),v=i(773),O=i(832),y=i(356),_=i(754),j=i(502),x=i(625),S=i(623),T=i(397),C=i(900),E=i(126),A=i(297),w=i(139);function R(e){const t=new A.a,i=t.vertex.code,R=t.fragment.code;return t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraPosition","vec3").add("localOrigin","vec3"),t.include(h.a),t.varyings.add("vpos","vec3"),t.include(S.a,e),t.include(l.a,e),t.include(b.a,e),e.output!==s.a.Color&&e.output!==s.a.Alpha||(t.include(d.a,e),t.include(c.a,{linearDepth:!1}),e.offsetBackfaces&&t.include(n.a),e.instancedColor&&t.attributes.add(w.a.INSTANCECOLOR,"vec4"),t.varyings.add("vNormalWorld","vec3"),t.varyings.add("localvpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.include(p.a,e),t.include(a.a,e),t.include(u.a,e),t.include(f.a,e),t.vertex.uniforms.add("externalColor","vec4"),t.varyings.add("vcolorExt","vec4"),i.add(E.a`
        void main(void) {
          forwardNormalizedVertexColor();
          vcolorExt = externalColor;
          ${e.instancedColor?"vcolorExt *= instanceColor;":""}
          vcolorExt *= vvColor();
          vcolorExt *= getSymbolColor();
          forwardColorMixMode();

          if (vcolorExt.a < ${E.a.float(T.c)}) {
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          }
          else {
            vpos = calculateVPos();
            localvpos = vpos - view[3].xyz;
            vpos = subtractOrigin(vpos);
            vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, vpos);
            ${e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
          }
          ${e.multipassTerrainEnabled?E.a`depth = (view * vec4(vpos, 1.0)).z;`:""}
          forwardLinearDepth();
          forwardTextureCoordinates();
        }
      `)),e.output===s.a.Alpha&&(t.include(o.a,e),t.include(T.a,e),e.multipassTerrainEnabled&&(t.fragment.include(g.a),t.include(y.b,e)),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("opacity","float").add("layerOpacity","float"),t.fragment.uniforms.add("view","mat4"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.fragment.include(C.a),R.add(E.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?E.a`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${e.hasColorTexture?E.a`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:E.a`vec4 texColor = vec4(1.0);`}
        ${e.attributeColor?E.a`
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:E.a`
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}

        gl_FragColor = vec4(opacity_);
      }
    `)),e.output===s.a.Color&&(t.include(o.a,e),t.include(O.a,e),t.include(v.a,e),t.include(T.a,e),e.receiveShadows&&t.include(x.a,e),e.multipassTerrainEnabled&&(t.fragment.include(g.a),t.include(y.b,e)),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("opacity","float").add("layerOpacity","float"),t.fragment.uniforms.add("view","mat4"),e.hasColorTexture&&t.fragment.uniforms.add("tex","sampler2D"),t.include(j.b,e),t.include(_.a,e),t.fragment.include(C.a),R.add(E.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?E.a`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${e.hasColorTexture?E.a`
        vec4 texColor = texture2D(tex, vuv0);
        ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
        discardOrAdjustAlpha(texColor);`:E.a`vec4 texColor = vec4(1.0);`}
        vec3 viewDirection = normalize(vpos - cameraPosition);
        ${e.pbrMode===j.a.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.viewingMode===r.a.Global?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${e.attributeColor?E.a`
        vec3 albedo_ = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:E.a`
        vec3 albedo_ = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
        float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));
        `}
        ${E.a`
        vec3 shadedNormal = normalize(vNormalWorld);
        albedo_ *= 1.2;
        vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);
        float alignmentLightView = clamp(dot(viewForward, -lightingMainDirection), 0.0, 1.0);
        float transmittance = 1.0 - clamp(dot(viewForward, shadedNormal), 0.0, 1.0);
        float treeRadialFalloff = vColor.r;
        float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
        additionalLight += backLightFactor * lightingMainIntensity;`}
        ${e.pbrMode===j.a.Normal||e.pbrMode===j.a.Schematic?e.viewingMode===r.a.Global?E.a`vec3 normalGround = normalize(vpos + localOrigin);`:E.a`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:E.a``}
        ${e.pbrMode===j.a.Normal||e.pbrMode===j.a.Schematic?E.a`
            float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
            vec3 shadedColor = evaluateSceneLightingPBR(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:"vec3 shadedColor = evaluateSceneLighting(shadedNormal, albedo_, shadow, 1.0 - ssao, additionalLight);"}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),t.include(m.a,e),t}const P=Object.freeze({__proto__:null,build:R})},1016:function(e,t,i){"use strict";var r;i.d(t,"a",(function(){return r})),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Cross=2]="Cross",e[e.ForwardDiagonal=3]="ForwardDiagonal",e[e.BackwardDiagonal=4]="BackwardDiagonal",e[e.DiagonalCross=5]="DiagonalCross",e[e.COUNT=6]="COUNT"}(r||(r={}))},1027:function(e,t,i){"use strict";i.d(t,"a",(function(){return ci}));var r,a,n,s,o,c,l=i(79),d=i(100),h=i(138),u=i(124),p=i(87),f=i(424),b=i(85),m=i(212),g=i(551),v=i(136),O=i(81),y=(i(84),i(82),i(83),i(80)),_=i(147),j=i(219),x=i(109),S=i(200),T=i(272),C=i(1002),E=i(798);(c=r||(r={}))[c.INNER=0]="INNER",c[c.OUTER=1]="OUTER",function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(a||(a={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(n||(n={})),function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.Water=3]="Water",e[e.Occluded=4]="Occluded"}(s||(s={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(o||(o={}));var A,w,R=i(116),P=i(118),I=i(163),D=i(1005);(w=A||(A={}))[w.None=0]="None",w[w.ColorAndWater=1]="ColorAndWater",w[w.Highlight=2]="Highlight",w[w.Occluded=3]="Occluded";class M{constructor(e,t){this.index=e,this.renderTargets=t,this.extent=Object(P.l)(),this.resolution=0,this.renderLocalOrigin=Object(D.a)(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new L,this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(t.renderTargets.length).fill(!1)}getValidTarget(e){return this.validTargets[e]?this.renderTargets.getTarget(e):null}get needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const t=e===A.ColorAndWater?this.renderTargets.getTarget(s.Color):e===A.Highlight?this.renderTargets.getTarget(s.Highlight):this.renderTargets.getTarget(s.Occluded);return t?t.getTexture():null}getNormalTexture(e){const t=e===A.ColorAndWater?this.renderTargets.getTarget(s.Water):null;return t?t.getTexture():null}draw(e,t){const i=this.computeRenderTargetValidityBitfield(),r=this.needsColorWithoutRasterImage;for(const a of this.renderTargets.renderTargets)a.type===s.ColorNoRasterImage&&!1===r?this.validTargets[a.type]=!1:this.validTargets[a.type]=e.drawTarget(this,a,t);return i^this.computeRenderTargetValidityBitfield()?I.k.CHANGED:I.k.UNCHANGED}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[s.Color]|+e[s.ColorNoRasterImage]<<1|+e[s.Highlight]<<2|+e[s.Water]<<3|+e[s.Occluded]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this.extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Object(P.u)(this.extent,e.range,0,t)}if(this.extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Object(P.u)(this.extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,Object(P.k)(this.canvasGeometries.extents[0],this.extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}applyViewport(e){e.setViewport(this.index===r.INNER?0:this.resolution,0,this.resolution,this.resolution)}}class L{constructor(){this.extents=[Object(P.l)(),Object(P.l)(),Object(P.l)()],this.numViews=0}}var N=i(188),F=i(94),z=i(314);class U{constructor(e,t){this.size=Object(N.a)(),this._fbo=null,this._fbo=new z.a(e,{colorTarget:F.y.TEXTURE,depthStencilTarget:F.m.NONE},{target:F.A.TEXTURE_2D,pixelFormat:F.p.RGBA,dataType:F.q.UNSIGNED_BYTE,wrapMode:F.B.CLAMP_TO_EDGE,samplingMode:F.z.LINEAR_MIPMAP_LINEAR,hasMipmap:t,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=Object(b.e)(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return null!==this._fbo}resize(e,t){this.size[0]=e,this.size[1]=t,this._fbo.resize(this.size[0],this.size[1])}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}disposeRenderTargetMemory(){var e;null==(e=this._fbo)||e.resize(0,0)}get gpuMemoryUsage(){var e,t;return null!=(e=null==(t=this._fbo)?void 0:t.gpuMemoryUsage)?e:0}}var G=i(567);class V{constructor(e){const t=(t,i,r=!0)=>({type:i,fbo:new U(e,r),renderPass:t,valid:!1,lastUsed:1/0});this.renderTargets=[t(G.a.MATERIAL,s.Color),t(G.a.MATERIAL,s.ColorNoRasterImage),t(G.a.MATERIAL_HIGHLIGHT,s.Highlight,!1),t(G.a.MATERIAL_NORMAL,s.Water),t(G.a.MATERIAL,s.Occluded)]}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,t,i){if(e)t.lastUsed=i;else if(i-t.lastUsed>B)t.fbo.disposeRenderTargetMemory(),t.lastUsed=1/0;else if(t.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce(((e,t)=>e+t.fbo.gpuMemoryUsage),0)}}const B=1e3;var k=i(818);class H{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}class W{constructor(e){this._context=e,this._perConstructorInstances=new k.a,this._frameCounter=0,this._keepAliveFrameCount=q}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.destroy())))),this._perConstructorInstances.clear()}acquire(e,t){const i=t.key;let r=this._perConstructorInstances.get(e,i);if(Object(b.j)(r)){const a=new e(this._context,t,(()=>this.release(a)));r=new H(a),this._perConstructorInstances.set(e,i,r)}return++r.refCount,r.technique}releaseAndAcquire(e,t,i){if(Object(b.k)(i)){if(t.key===i.key)return i;this.release(i)}return this.acquire(e,t)}release(e){if(Object(b.j)(e)||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);Object(b.j)(t)||(--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==q&&this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((e,i)=>{0===e.refCount&&e.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(e.technique.destroy(),this._perConstructorInstances.delete(t,i))}))}))}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach(((t,i)=>{e.push((async(e,t)=>{const i=t.shader;i&&(await i.reload(),e.forEach((e=>{e.technique.reload(this._context)})))})(t,i))})),await Promise.all(e)}}const q=-1,$=e=>class extends e{constructor(){super(...arguments),this._isDisposed=!1}dispose(){for(const t of null!=(e=this._managedDisposables)?e:[]){var e;const i=this[t];this[t]=null,i&&"function"==typeof i.dispose&&i.dispose()}this._isDisposed=!0}get isDisposed(){return this._isDisposed}};$(class{});var X=i(748),Y=(i(171),i(692));class Z{constructor(){this.adds=new m.a,this.removes=new m.a,this.updates=new m.a({allocator:e=>e||new Q,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class Q{}class J{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}function K(e){return e.data.indexCount>=1}var ee=i(726),te=i(621),ie=i(335),re=i(896),ae=i(278),ne=i(1100);class se{constructor(e){this.first=e.from,this.count=e.to-e.from}}class oe{constructor(e=0,t=0){this.from=e,this.to=t}}class ce extends oe{constructor(e,t,i,r,a,n){super(t,i),this.id=e,this.isVisible=r,this.hasHighlights=a,this.hasOccludees=n}}function le(e){return Array.from(e.values()).sort(de)}function de(e,t){return e.from===t.from?e.to-t.to:e.from-t.from}function he(e,t){if(0===e.length)return void e.push(new se(t));const i=e[e.length-1];if(function(e,t){return e.first+e.count>=t.from}(i,t)){const e=t.from-i.first+t.to-t.from;i.count=e}else e.push(new se(t))}class ue{constructor(e,t){this._pool=e,this._size=0,this._buffer=e.newBuffer(pe(t))}dispose(){this._buffer=this._pool.deleteBuffer(this._buffer),this._size=0}release(){this.erase(0,this._size),this.dispose()}get vao(){return this._buffer.vao}get array(){return this._buffer.array}get size(){return this._size}grow(e){this._resize(this._size+e,!0).dispose()}alloc(e){return this._resize(e,!1)}_resize(e,t){let i;const r=function(e,t,i){return t<=i?e>=i?e:pe(Math.max(2*e,i)):e<=2*i?e:pe(i)}(this._buffer.length,this._size,e);if(this._buffer.length!==r){const e=this._pool.newBuffer(r);t&&(e.array.set(this._buffer.array.subarray(0,Math.min(this._size,r))),e.vao.vertexBuffers.geometry.setSubData(e.array,0,0,e.array.byteLength)),i=this._buffer,this._buffer=e}const a=this._size;return this._size=e,i?{dispose:()=>{i.array.fill(0,0,a),this._pool.deleteBuffer(i)},copy:(e,t,r)=>this._buffer.array.set(i.array.subarray(t,r),e),hasNewBuffer:!0}:{dispose:()=>{},copy:(e,t,i)=>{e!==t&&this._buffer.array.copyWithin(e,t,i)},hasNewBuffer:!1}}erase(e,t){this._buffer.array.fill(0,e,t)}}function pe(e){return 65536*Math.ceil(e/65536)}var fe=i(243),be=i(244),me=i(162),ge=i(164);class ve{constructor(e,t,i,r){this.vao=new ge.a(e,t,{geometry:i},{geometry:me.a.createVertex(e,F.D.STATIC_DRAW)}),this.array=new Float32Array(r),this.vao.vertexBuffers.geometry.setSize(this.array.byteLength)}dispose(){this.vao.dispose(!0)}get length(){return this.array.length}}const Oe=fe.a+1;class ye{constructor(e,t,i){this._rctx=e,this._locations=t,this._layout=i,this._cache=e.newCache(`MergedRenderer pool ${Object(be.a)()}`,_e)}dispose(){this._cache.destroy()}newBuffer(e){const t=e.toString(),i=this._cache.pop(t);if(Object(b.k)(i)){const e=i.pop();return i.length>0&&this._cache.put(t,i,e.array.byteLength*i.length,Oe),e}return new ve(this._rctx,this._locations,this._layout,e)}deleteBuffer(e){const t=e.array.byteLength,i=e.array.length.toString(),r=this._cache.pop(i);return Object(b.k)(r)?(r.push(e),this._cache.put(i,r,t*r.length,-1)):this._cache.put(i,[e],t,-1),null}}function _e(e,t){if(t===fe.d.ALL)return void e.forEach((e=>e.dispose()));const i=e.pop(),r=e.length*i.array.byteLength;return i.dispose(),r}var je=i(513);class xe{constructor(e,t,i){this._rctx=e,this._materialRepository=t,this._material=i,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new m.a,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new te.a(this._material,this._materialRepository),this._bufferWriter=i.createBufferWriter(),this._bufferPool=new ye(e,i.vertexAttributeLocations,Object(ee.a)(this._bufferWriter.vertexBufferLayout))}dispose(){this._glMaterials.destroy(),this._dataByOrigin.forEach((e=>e.buffer.dispose())),this._dataByOrigin.clear(),this._bufferPool.dispose()}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this._material instanceof ne.a}get rendersOccluded(){return!this.isEmpty&&this._material.renderOccluded!==ie.c.Occlude}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateRenderCommands()}_addAndRemoveGeometries(e,t){const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,a=this._dataByOrigin,n=function(e,t){const i=new Map;for(const r of e)Te(i,r,!0);for(const r of t)Te(i,r,!1);return i}(e,t);n.forEach(((e,t)=>{n.delete(t);const s=e.toAdd.reduce(((e,t)=>e+i.elementCount(t.data)),0);let o=a.get(t);if(null==o)Object(ae.a)(0===e.toRemove.length),o=new we(e.origin,new ue(this._bufferPool,s*r)),a.set(t,o);else if(0===e.toAdd.length&&o.instances.size===e.toRemove.length)return o.buffer.dispose(),void a.delete(t);let c=0;o.instances.forEach((e=>c+=e.to-e.from));const l=e.toRemove.reduce(((e,t)=>e+i.elementCount(t.data)),0),d=o.buffer.size,h=(c+s-l)*r,u=Pe;if(h<d/2?this._removeAndRebuild(o,e.toRemove,r,h,u):e.toRemove.length>0&&this._remove(o,e.toRemove,r,u),e.toAdd.length>0){const t=Ie;Object(ae.i)(t,-e.origin[0],-e.origin[1],-e.origin[2]),this._add(o,e.toAdd,r,t,u)}const p=o.buffer.vao.vertexBuffers.geometry;Ae(u),u.forAll((({from:e,to:t})=>{if(e<t){const i=o.buffer.array,r=4,a=e*r,n=t*r;p.setSubData(i,a,a,n)}})),u.clear(),o.drawCommandsDirty=!0}))}_updateGeometries(e){const t=this._bufferWriter,i=t.vertexBufferLayout.stride/4;for(const r of e){const e=r.renderGeometry,a=this._dataByOrigin.get(e.origin.id),n=a&&a.instances.get(e.id);if(!n)return;const s=r.updateType;if(s&re.a.State.VISIBILITIES&&(n.isVisible=e.instanceParameters.visible),s&(re.a.State.HIGHLIGHTS|re.a.State.VISIBILITIES)){const t=e.instanceParameters.visible;n.hasHighlights=!!e.instanceParameters.highlights&&t}if(s&re.a.State.OCCLUDEES&&(n.hasOccludees=!!e.instanceParameters.occludees),s&(re.a.State.VERTEXATTRS|re.a.State.TRANSFORMATION)){const{array:r,vao:s}=a.buffer;Object(je.b)(e,De,Me),t.write({transformation:De,invTranspTransformation:Me},e.data,t.vertexBufferLayout.createView(r.buffer),n.from),Object(ae.a)(n.from+t.elementCount(e.data)===n.to,"material VBO layout has changed"),s.vertexBuffers.geometry.setSubData(r,n.from*i*4,n.from*i*4,n.to*i*4)}a.drawCommandsDirty=!0}}_updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,Object(f.c)(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))}));const e=e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,0===e.instances.size)return;if(!Ce(e)){const t=this._bufferWriter.vertexBufferLayout.stride,i=4*e.buffer.size/t;return void(e.drawCommandsDefault=[{first:0,count:i}])}const t=le(e.instances);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const i of t)i.isVisible&&(i.hasOccludees?he(e.drawCommandsOccludees,i):he(e.drawCommandsDefault,i),i.hasHighlights?he(e.drawCommandsHighlight,i):he(e.drawCommandsShadowHighlightRest,i))};this._dataByOrigin.forEach((t=>{t.drawCommandsDirty&&(e(t),t.drawCommandsDirty=!1)}))}updateAnimation(e){return this._material.update(e)}requiresSlot(e,t){return null==e||this._material.requiresSlot(e,t)}render(e,t,i){if(!this.requiresSlot(e,t))return!1;const r=t===G.a.MATERIAL_HIGHLIGHT||t===G.a.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT;if(r&&!this._hasHighlights)return!1;const a=t===G.a.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,n=!(r||a);if(this._dataByOrigin.forEach((e=>{if(r&&!e.hasHighlights)return;const t=(r?e.drawCommandsHighlight:a&&Ce(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault)||null,i=n&&e.drawCommandsOccludees||null;(Object(b.k)(t)||Object(b.k)(i))&&this._renderCommandData.push(new Re(e.origin,e.buffer,t,i))})),0===this._renderCommandData.length)return!1;const s=this._rctx,o=this._glMaterials.load(s,t);if(Object(b.j)(o))return this._renderCommandData.clear(),!1;const c=o.beginSlot(i);return s.useTechnique(c,e,!1),o.bind(i,c),this._renderCommandData.forAll((({origin:t,buffer:r,renderCommands:a,occludeeCommands:n})=>{i.origin=t,c.bindDraw(i),c.ensureAttributeLocations(r.vao),s.bindVAO(r.vao);const o=c.primitiveType;Object(b.k)(a)&&this._renderCommands(s,o,a),Object(b.k)(n)&&(c.bindPipelineState(s,e,!0),this._renderCommands(s,o,n),c.bindPipelineState(s,e,!1))})),this._renderCommandData.clear(),!0}_renderCommands(e,t,i){for(let r=0;r<i.length;r++)e.drawArrays(t,i[r].first,i[r].count)}_removeAndRebuild(e,t,i,r,a){for(const l of t)e.instances.delete(l.id);const n=le(e.instances);e.instances.clear();const s=e.buffer.size,o=e.buffer.alloc(r);let c=0;for(const l of n){const t=l.from*i,r=l.to*i;o.copy(c,t,r),l.from=c/i,c+=r-t,l.to=c/i,e.instances.set(l.id,l)}a.push(new oe(0,o.hasNewBuffer?e.buffer.array.length:s)),o.dispose(),e.buffer.erase(c,a.back().to),e.holes.clear()}_remove(e,t,i,r){for(const a of t){const t=a.id,n=e.instances.get(t),s=n.from*i,o=n.to*i;e.buffer.erase(s,o),e.holes.push(new oe(n.from,n.to)),e.instances.delete(t),r.push(new oe(s,o))}Ae(e.holes)}_add(e,t,i,r,a){if(0===t.length)return;const n=this._bufferWriter;let s=n.vertexBufferLayout.createView(e.buffer.array.buffer);const o=e.holes.length>0;let c=Number.MAX_SAFE_INTEGER,l=Number.MIN_SAFE_INTEGER;for(const d of t){const t=Object(b.k)(d.transformation)?Object(_.m)(De,r,d.transformation):r;Object(_.a)(Me,t);const h=Object(_.t)(Me,Me),u=n.elementCount(d.data),p=u*i;let f=Ee(e.holes,u);Object(b.j)(f)&&(f=e.buffer.size/i,e.buffer.grow(p),s=n.vertexBufferLayout.createView(e.buffer.array.buffer)),n.write({transformation:t,invTranspTransformation:h},d.data,s,f);const m=d.instanceParameters.visible,g=!!d.instanceParameters.highlights&&m,v=!!d.instanceParameters.occludees,O=new ce(d.id,f,f+u,m,g,v);Object(ae.a)(null==e.instances.get(d.id)),e.instances.set(d.id,O),o?a.push(new oe(O.from*i,O.to*i)):(c=Math.min(O.from,c),l=Math.max(O.to,l))}o||a.push(new oe(c*i,l*i))}get test(){return{material:this._material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}class Se{constructor(e){this.origin=e,this.toAdd=new Array,this.toRemove=new Array}}function Te(e,t,i){const r=t.origin;if(Object(b.j)(r))return;let a=e.get(r.id);null==a&&(a=new Se(r.vec3),e.set(r.id,a)),i?a.toAdd.push(t):a.toRemove.push(t)}function Ce(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}function Ee(e,t){let i;if(!e.some((e=>!(e.to-e.from<t)&&(i=e,!0))))return null;const r=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),r}function Ae(e){const t=new Map;e.forAll((e=>t.set(e.from,e)));let i=!0;for(;i;)i=!1,e.forEach((r=>{const a=t.get(r.to);a&&(r.to=a.to,t.delete(a.from),e.removeUnordered(a),i=!0)}))}class we{constructor(e,t){this.origin=e,this.buffer=t,this.instances=new Map,this.holes=new m.a({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1}}class Re{constructor(e,t,i,r){this.origin=e,this.buffer=t,this.renderCommands=i,this.occludeeCommands=r}}const Pe=new m.a({deallocator:null}),Ie=Object(S.d)(),De=Object(S.d)(),Me=Object(S.d)();let Le=class extends d.a{constructor(){super(...arguments),this._pending=new Ne,this._changes=new Z,this._materialRenderers=new Map,this._sortedMaterialRenderers=new m.a,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return Object(f.c)(this._materialRenderers,(e=>e.rendersOccluded))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=function(e){const t=new Map,i=e=>{let i=t.get(e);return i||(i=new J,t.set(e,i)),i};return e.removes.forAll((e=>{K(e)&&i(e.material).removes.push(e)})),e.adds.forAll((e=>{K(e)&&i(e.material).adds.push(e)})),e.updates.forAll((e=>{K(e.renderGeometry)&&i(e.renderGeometry.material).updates.push(e)})),t}(this._changes);let t=!1,i=!1,r=!1;return e.forEach(((e,a)=>{let n=this._materialRenderers.get(a);if(!n&&e.adds.length>0&&(n=new xe(this.rctx,this.materialRepository,a),this._materialRenderers.set(a,n),t=!0,i=!0,r=!0),!n)return;const s=i||n.hasHighlights,o=r||n.hasWater;n.modify(e),i=i||s!==n.hasHighlights,r=r||o!==n.hasWater,n.isEmpty&&(this._materialRenderers.delete(a),n.dispose(),t=!0)})),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),i&&(this._hasHighlights=Object(f.c)(this._materialRenderers,(e=>e.hasHighlights))),r&&(this._hasWater=Object(f.c)(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0}add(e){if(0===e.length)return;const t=this._pending.empty;for(const i of e)this._pending.adds.add(i);t&&this.notifyChange("updating")}remove(e){const t=this._pending.empty;for(const i of e)this._pending.adds.has(i)?(this._pending.removed.add(i),this._pending.adds.delete(i)):this._pending.removed.has(i)||this._pending.removes.add(i);t&&!this._pending.empty&&this.notifyChange("updating")}modify(e,t){const i=0===this._changes.updates.length;for(const r of e){const e=this._changes.updates.pushNew();e.renderGeometry=r,e.updateType=t}i&&this._changes.updates.length>0&&this.notifyChange("updating")}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll((({materialRenderer:i})=>t=i.updateAnimation(e)||t)),t}render(e,t){for(let i=0;i<this._sortedMaterialRenderers.length;i++){const r=this._sortedMaterialRenderers.data[i];r.material.shouldRender(e)&&r.materialRenderer.render(t.slot,e.pass,t)}}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((t,i)=>{i.insertOrder=e++,this._sortedMaterialRenderers.push({material:i,materialRenderer:t})})),this._sortedMaterialRenderers.sort(((e,t)=>{const i=t.material.renderPriority-e.material.renderPriority;return 0!==i?i:e.material.insertOrder-t.material.insertOrder}))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};Object(l.a)([Object(O.b)()],Le.prototype,"rctx",void 0),Object(l.a)([Object(O.b)()],Le.prototype,"materialRepository",void 0),Object(l.a)([Object(O.b)()],Le.prototype,"updating",null),Le=Object(l.a)([Object(y.a)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Le);class Ne{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}var Fe,ze=i(495),Ue=i(545),Ge=i(411),Ve=i(139),Be=i(604),ke=i(858),He=i(501),We=i(388),qe=i(404),$e=i(419),Xe=i(382),Ye=i(389),Ze=i(626),Qe=i(355),Je=i(203);!function(e){e[e.Screen=0]="Screen",e[e.World=1]="World"}(Fe||(Fe={}));class Ke extends qe.a{constructor(e,t,i){super(e,t,i),this._kernelBlurRadius=1;const{R32F:r,textureFloatLinear:a}=e.rctx.capabilities.textureFloat,n=null!=r;this._kernelTextureChannels=n?1:4,this._floatInterpolationDisabled=!a;const s={target:F.A.TEXTURE_2D,pixelFormat:n?F.p.RED:F.p.RGBA,internalFormat:n?F.v.R32F:F.p.RGBA,dataType:F.q.FLOAT,samplingMode:F.z.NEAREST,wrapMode:F.B.CLAMP_TO_EDGE,width:1,height:1};this._kernel=new Je.a(e.rctx,s)}initializeProgram(e){const t=Ke.shader.get().build({isAttributeDriven:this.configuration.isAttributeDriven,mode:this.configuration.mode});return new Ye.a(e.rctx,t,Xe.a)}initializePipeline(){return Object(Qe.f)({blending:Object(Qe.h)(F.b.ONE,F.b.ONE,F.c.ADD),colorWrite:Qe.c,depthTest:null,depthWrite:null})}bindPass(e,t){const{camera:i}=t,{mode:r}=this.configuration;switch(Object(He.b)(this.program,i.projectionMatrix),r){case Ze.a.KernelDensity:this._bindKernelDensityPass(e,t);break;case Ze.a.GaussianBlur:this._bindGaussianBlurPass(e,t)}}bindDraw(e){Object(He.c)(this.program,e)}_bindKernelDensityPass({searchRadius:e,resolutionForScale:t},{camera:i,screenToWorldRatio:r}){0!==t&&(e/=r/t),this.program.setUniform1f("radius",e*i.pixelRatio/i.fullViewport[2])}_bindGaussianBlurPass({searchRadius:e,resolutionForScale:t},{camera:i,screenToWorldRatio:r}){const a=Math.round(e),n=3*(0===t?a:a*t/r);0===t||this._floatInterpolationDisabled?this._kernel.setSamplingMode(F.z.NEAREST):this._kernel.setSamplingMode(F.z.LINEAR),this._kernelBlurRadius!==a&&this._recomputeKernel(a),this.program.setUniform1f("radius",2*n*i.pixelRatio/i.fullViewport[2]),this.program.bindTexture(this._kernel,"kernel")}_recomputeKernel(e){const t=Object(ke.b)(e),i=Math.ceil(t.length/2),r=this._kernelTextureChannels,a=new Float32Array(i*r);for(let n=0;n<i;++n){const e=t[i-1-n];for(let t=0;t<r;++t)a[n*r+t]=e}this._kernel.resize(i,1),this._kernel.setData(a),this._kernelBlurRadius=e}destroy(){this._kernel=Object(b.e)(this._kernel),super.destroy()}}Ke.shader=new We.a(Ze.b,(()=>i.e(326).then(i.bind(null,1349))));class et extends $e.a{constructor(){super(...arguments),this.isAttributeDriven=!1,this.mode=Ze.a.GaussianBlur}}Object(l.a)([Object($e.b)()],et.prototype,"isAttributeDriven",void 0),Object(l.a)([Object($e.b)()],et.prototype,"mode",void 0);const tt={searchRadius:128,resolutionForScale:0,colorRampData:null,isAttributeDriven:!1,minDensity:0,maxDensity:100,fieldTotal:0,pixelRatio:1,...ie.a};class it extends ie.b{constructor(e){super(e,tt),this._techniqueConfig=new et}requiresSlot(e,t){return e===Ge.a.DRAPED_MATERIAL&&t===G.a.MATERIAL}getTechniqueConfig(){return this._techniqueConfig.isAttributeDriven=this.parameters.isAttributeDriven,this._techniqueConfig}createGLMaterial(e){return new rt(e)}intersect(){}createBufferWriter(){return new at(this.parameters.isAttributeDriven?st:nt)}}class rt extends Ue.a{constructor(e){super(e)}beginSlot(e){return this.updateParameters(e)}updateParameters(e){return this.ensureTechnique(Ke,e)}bind(e,t){t.bindPass(this._material.parameters,e)}}class at{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(Ve.a.POSITION).length*ot}write(e,t,i,r){Object(Be.f)(t.indices.get(Ve.a.POSITION),t.vertexAttributes.get(Ve.a.POSITION).data,e.transformation,i.position,r,ot);const a=t.indices.get(Ve.a.POSITION).length,n=i.uv0;let s=r;for(let c=0;c<a;++c)n.setValues(s++,-1,-1),n.setValues(s++,1,-1),n.setValues(s++,1,1),n.setValues(s++,1,1),n.setValues(s++,-1,1),n.setValues(s++,-1,-1);const o="featureAttribute"in i?i.featureAttribute:null;o&&Object(Be.a)(t.indices.get(Ve.a.FEATUREATTRIBUTE),t.vertexAttributes.get(Ve.a.FEATUREATTRIBUTE).data,o,r,ot)}}const nt=Object(ze.a)().vec3f(Ve.a.POSITION).vec2f(Ve.a.UV0),st=nt.clone().f32(Ve.a.FEATUREATTRIBUTE),ot=6;var ct=i(445),lt=i(1009);class dt extends qe.a{constructor(e,t){super(e,t,(()=>this.destroy()))}initializeProgram(e){const t=dt.shader.get().build({mode:this.configuration.mode});return new Ye.a(e.rctx,t,Xe.a)}initializePipeline(e){return Object(Qe.f)({blending:ct.d,colorWrite:Qe.c,depthTest:null,depthWrite:null})}bindPass(e,t){const{densityMap:i,colorRamp:r,maxDensity:a,minDensity:n,searchRadius:s}=e;this.program.bindTexture(i,"densityMap"),this.program.bindTexture(r,"tex"),this.configuration.mode===Ze.a.KernelDensity&&this.program.setUniform1f("densityMultiplier",3/(s*s*Math.PI)),this.program.setUniform1f("densityNormalizer",1/(a-n)),this.program.setUniform1f("minDensity",n)}get primitiveType(){return F.r.TRIANGLE_STRIP}}dt.shader=new We.a(lt.a,(()=>i.e(325).then(i.bind(null,1350))));class ht extends $e.a{constructor(){super(...arguments),this.mode=Ze.a.GaussianBlur}}Object(l.a)([Object($e.b)()],ht.prototype,"mode",void 0);var ut=i(647);let pt=class extends Le{constructor(){super(...arguments),this.type="draped-heatmap"}initialize(){super.initialize();const e={colorTarget:F.y.TEXTURE,depthStencilTarget:F.m.NONE,width:0,height:0},{capabilities:t}=this.rctx,{R32F:i}=t.colorBufferFloat,{textureFloatLinear:r}=t.textureFloat,a=null!=i,n={target:F.A.TEXTURE_2D,pixelFormat:a?F.p.RED:F.p.RGBA,internalFormat:a?F.v.R32F:F.p.RGBA,dataType:F.q.FLOAT,samplingMode:r?F.z.LINEAR:F.z.NEAREST,wrapMode:F.B.CLAMP_TO_EDGE,width:0,height:0};this._densityMap=new z.a(this.rctx,e,n),this._quad=Object(Y.b)(this.rctx);const s={target:F.A.TEXTURE_2D,pixelFormat:F.p.RGBA,dataType:F.q.UNSIGNED_BYTE,samplingMode:F.z.LINEAR,wrapMode:F.B.CLAMP_TO_EDGE,width:1,height:1},o=new Je.a(this.rctx,s,new Uint8ClampedArray(4));this._colorRamp=o,this._technique=new dt({rctx:this.rctx,viewingMode:T.a.Local},new ht),this._heatmapParameters={colorRamp:o,densityMap:this._densityMap.colorTexture,searchRadius:1,minDensity:0,maxDensity:100,fieldTotal:0}}destroy(){this._technique=Object(b.q)(this._technique),this._densityMap=Object(b.e)(this._densityMap),this._quad=Object(b.e)(this._quad),this._colorRamp=Object(b.e)(this._colorRamp)}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccluded(){return!1}get _heatmapDensityMaterialRenderers(){return this._sortedMaterialRenderers.filter(ft)}add(e){super.add(e)}remove(e){super.remove(e)}render(e,t){const i=this._heatmapDensityMaterialRenderers,r=i.length;if(r<1)return;const a=this.rctx.getBoundFramebufferObject(),n=this.rctx.getViewport(),s=i[0].material.parameters,{pixelRatio:o}=s,c=Math.ceil(n.width*o),l=Math.ceil(n.height*o);this._densityMap.resize(c,l),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,c,l),this.rctx.clear(F.e.COLOR_BUFFER_BIT);let d=!1;for(let b=0;b<r;b++){const r=i[b];r.material.shouldRender(e)&&(d=d||r.materialRenderer.render(t.slot,e.pass,t))}if(this.rctx.bindFramebuffer(a),this.rctx.setViewport(n.x,n.y,n.width,n.height),!d)return;const{searchRadius:h,minDensity:u,maxDensity:p,fieldTotal:f,colorRampData:m}=s,g=this._heatmapParameters;if(g.searchRadius=h,g.fieldTotal=f,g.searchRadius=h,g.minDensity=u,g.maxDensity=p,Object(b.k)(m)&&m!==this._colorRampData){const{colorRamp:e}=g,t=e.descriptor.width,i=m.length/4;i!==t&&e.resize(i,1),e.setData(m),this._colorRampData=m}this.rctx.bindVAO(this._quad),this.rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this.rctx),this._technique.bindPass(g,t),this.rctx.drawArrays(this._technique.primitiveType,0,Object(ut.f)(this._quad,"geometry"))}};function ft(e){return function(e){return e instanceof it}(e.material)}pt=Object(l.a)([Object(y.a)("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],pt);const bt=p.a.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository");class mt{constructor(e){this._glMaterial=e,this.refCnt=0,this._glMaterial=e}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,Object(ae.a)(this.refCnt>=0)}getRefCnt(){return this.refCnt}get glMaterial(){return this._glMaterial}}class gt{constructor(e,t,i,r){this._textureRepository=e,this._techniqueRepository=t,this.materialChanged=i,this.requestRender=r,this._id2glMaterialRef=new k.a}dispose(){this._textureRepository.dispose()}acquire(e,t){this._ownMaterial(e);let i=this._id2glMaterialRef.get(t,e.id);if(Object(b.j)(i)){const r=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:t});i=new mt(r),this._id2glMaterialRef.set(t,e.id,i)}return i.incRefCnt(),i.glMaterial}release(e,t){const i=this._id2glMaterialRef.get(t,e.id);Object(b.k)(i)&&(i.decRefCnt(),0===i.getRefCnt()&&(Object(b.e)(i.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){Object(b.k)(e.repository)&&e.repository!==this&&bt.error("Material is already owned by a different material repository"),e.repository=this}}var vt=i(1088),Ot=i(752),yt=i(608);class _t{constructor(e){this.rctx=e,this.camera=null,this.lastFrameCamera=new X.a,this.pass=G.a.MATERIAL,this.slot=Ge.a.OPAQUE_MATERIAL,this.highlightDepthTexture=null,this.renderOccludedMask=jt,this.hasOccludees=!1,this.hasFillLights=!0}resetRenderOccludedMask(){this.renderOccludedMask=jt}get isHighlightPass(){return this.pass===G.a.MATERIAL_HIGHLIGHT}}const jt=ie.c.Occlude|ie.c.OccludeAndTransparent|ie.c.OccludeAndTransparentStencil;var xt=i(1010);class St extends qe.a{initializeProgram(e){const t=St.shader.get().build();return new Ye.a(e.rctx,t,Xe.a)}initializePipeline(){return this.configuration.hasAlpha?Object(Qe.f)({blending:Object(Qe.g)(F.b.SRC_ALPHA,F.b.ONE,F.b.ONE_MINUS_SRC_ALPHA,F.b.ONE_MINUS_SRC_ALPHA),colorWrite:Qe.c}):Object(Qe.f)({colorWrite:Qe.c})}}St.shader=new We.a(xt.a,(()=>i.e(320).then(i.bind(null,1351))));class Tt extends $e.a{constructor(){super(...arguments),this.hasAlpha=!1}}Object(l.a)([Object($e.b)()],Tt.prototype,"hasAlpha",void 0);class Ct{constructor(e=Object(x.f)()){this.intensity=e}}class Et{constructor(e=Object(x.f)(),t=Object(x.h)(.57735,.57735,.57735)){this.intensity=e,this.direction=t}}class At{constructor(e=Object(x.f)(),t=Object(x.h)(.57735,.57735,.57735),i=!0,r=1,a=1){this.intensity=e,this.direction=t,this.castShadows=i,this.specularStrength=r,this.environmentStrength=a}}class wt{constructor(){this.r=[0],this.g=[0],this.b=[0]}}var Rt=i(117);function Pt(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t[r];return i}function It(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t;return i}function Dt(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]+t[r];return i}function Mt(e){return(e+1)*(e+1)}function Lt(e,t,i){const r=e[0],a=e[1],n=e[2],s=i||[];return s.length=Mt(t),t>=0&&(s[0]=.28209479177),t>=1&&(s[1]=.4886025119*r,s[2]=.4886025119*n,s[3]=.4886025119*a),t>=2&&(s[4]=1.09254843059*r*a,s[5]=1.09254843059*a*n,s[6]=.31539156525*(3*n*n-1),s[7]=1.09254843059*r*n,s[8]=.54627421529*(r*r-a*a)),s}function Nt(e,t){const i=(r=t.r.length,Object(R.e)(Math.floor(Math.sqrt(r)-1),0,2));var r;for(const a of e)Object(Rt.s)(kt,a.direction),Lt(kt,i,Vt),Pt(Vt,Ht),It(Vt,a.intensity[0],Bt),Dt(t.r,Bt),It(Vt,a.intensity[1],Bt),Dt(t.g,Bt),It(Vt,a.intensity[2],Bt),Dt(t.b,Bt);return t}function Ft(e,t,i,r){(function(e,t){const i=Mt(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let a=0;a<i;a++)r.r[a]=r.g[a]=r.b[a]=0})(t,r),Object(Rt.w)(i.intensity,0,0,0);let a=!1;const n=zt,s=Ut,o=Gt;n.length=0,s.length=0,o.length=0;for(const c of e)c instanceof At&&!a?(Object(Rt.k)(i.direction,c.direction),Object(Rt.k)(i.intensity,c.intensity),i.specularStrength=c.specularStrength,i.environmentStrength=c.environmentStrength,i.castShadows=c.castShadows,a=!0):c instanceof At||c instanceof Et?n.push(c):c instanceof Ct?s.push(c):c instanceof wt&&o.push(c);Nt(n,r),function(e,t){Lt(kt,0,Vt);for(const i of e)t.r[0]+=Vt[0]*Ht[0]*i.intensity[0]*4*Math.PI,t.g[0]+=Vt[0]*Ht[0]*i.intensity[1]*4*Math.PI,t.b[0]+=Vt[0]*Ht[0]*i.intensity[2]*4*Math.PI}(s,r);for(const c of o)Dt(r.r,c.r),Dt(r.g,c.g),Dt(r.b,c.b)}const zt=[],Ut=[],Gt=[],Vt=[0],Bt=[0],kt=Object(x.f)(),Ht=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class Wt{constructor(){this._shOrder=2,this._ambientBoost=.4,this._oldSunlight={direction:Object(x.f)(),ambient:{color:Object(x.f)(),intensity:1},diffuse:{color:Object(x.f)(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new wt,this._mainLight={intensity:Object(x.f)(),direction:Object(x.h)(1,0,0),castShadows:!1,specularStrength:1,environmentStrength:1}}get lightingMainDirection(){return this._mainLight.direction}setLightDirectionUniform(e){e.setUniform3fv("lightingMainDirection",this._mainLight.direction)}setUniforms(e,t,i){const r=t?(1-this.groundLightingFactor)*(1-this.globalFactor):0;e.setUniform1f("lightingFixedFactor",r),e.setUniform1f("lightingGlobalFactor",this.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._mainLight.intensity),e.setUniform1f("lightingSpecularStrength",this._mainLight.specularStrength),e.setUniform1f("lightingEnvironmentStrength",this._mainLight.environmentStrength),e.setUniform1f("ambientBoostFactor",this._ambientBoost),e.setUniform1b("hasFillLights",i);const a=this._sphericalHarmonics;0===this._shOrder?e.setUniform3f("lightingAmbientSH0",a.r[0],a.g[0],a.b[0]):1===this._shOrder?(e.setUniform4f("lightingAmbientSH_R",a.r[0],a.r[1],a.r[2],a.r[3]),e.setUniform4f("lightingAmbientSH_G",a.g[0],a.g[1],a.g[2],a.g[3]),e.setUniform4f("lightingAmbientSH_B",a.b[0],a.b[1],a.b[2],a.b[3])):2===this._shOrder&&(e.setUniform3f("lightingAmbientSH0",a.r[0],a.g[0],a.b[0]),e.setUniform4f("lightingAmbientSH_R1",a.r[1],a.r[2],a.r[3],a.r[4]),e.setUniform4f("lightingAmbientSH_G1",a.g[1],a.g[2],a.g[3],a.g[4]),e.setUniform4f("lightingAmbientSH_B1",a.b[1],a.b[2],a.b[3],a.b[4]),e.setUniform4f("lightingAmbientSH_R2",a.r[5],a.r[6],a.r[7],a.r[8]),e.setUniform4f("lightingAmbientSH_G2",a.g[5],a.g[6],a.g[7],a.g[8]),e.setUniform4f("lightingAmbientSH_B2",a.b[5],a.b[6],a.b[7],a.b[8]))}set(e){Ft(e,this._shOrder,this._mainLight,this._sphericalHarmonics),Object(Rt.k)(this._oldSunlight.direction,this._mainLight.direction);const t=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*t,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*t,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*t,Object(Rt.e)(this._oldSunlight.diffuse.color,this._mainLight.intensity,t),Object(Rt.k)(qt,this._oldSunlight.diffuse.color),Object(Rt.e)(qt,qt,this._ambientBoost*this.globalFactor),Object(Rt.f)(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,qt)}get old(){return this._oldSunlight}}const qt=Object(x.f)();var $t=i(436);class Xt{constructor(e){this._rctx=e,this.cache=new Map}dispose(){this.cache.forEach((e=>e.texture=Object(b.e)(e.texture))),this.cache.clear()}_acquire(e){if(Object(b.j)(e))return null;const t=this._patternId(e),i=this.cache.get(t);if(i)return i.refCount++,i.bind;const r=e.pixelRatio,{encodedData:a,sdfNormalizer:n,pixels:s,paddedPixels:o}=function(e,t){const i=e.map((e=>Math.round(e*t))),r=1/t,a=Math.floor(i.reduce(((e,t)=>e+t))),n=i.reduce(((e,t)=>Math.max(e,t))),s=(Math.floor(.5*(n-1))+.5)*r,o=[];let c=1;for(const f of i){for(let e=0;e<f;e++){const t=c*(Math.min(e,f-1-e)+.5)*r/s*.5+.5;o.push(t)}c=-c}const l=Math.round(i[0]/2),d=[...o.slice(l),...o.slice(0,l)],h=a+2,u=new Uint8Array(4*h);let p=4;for(const f of d)Object($t.a)(f,u,p),p+=4;return u.copyWithin(0,p-4,p),u.copyWithin(p,4,8),{encodedData:u,sdfNormalizer:s,paddedPixels:h,pixels:a}}(e.pattern,r),c=s/r,l={refCount:1,texture:null,bind:e=>(Object(b.j)(l.texture)&&(l.texture=new Je.a(this._rctx,{width:o,height:1,internalFormat:F.p.RGBA,pixelFormat:F.p.RGBA,dataType:F.q.UNSIGNED_BYTE,wrapMode:F.B.CLAMP_TO_EDGE},a)),e.bindTexture(l.texture,"stipplePatternTexture"),{pixelSize:c,sdfNormalizer:n,pixels:s})};return this.cache.set(t,l),l.bind}release(e){if(Object(b.j)(e))return;const t=this._patternId(e),i=this.cache.get(t);i&&(i.refCount--,0===i.refCount&&(Object(b.k)(i.texture)&&i.texture.dispose(),this.cache.delete(t)))}swap(e,t){const i=this._acquire(t);return this.release(e),i}_patternId(e){return`${e.pattern.join(",")}-r${e.pixelRatio}`}}var Yt,Zt=i(859);!function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"}(Yt||(Yt={}));class Qt extends qe.a{initializeProgram(e){const t=Qt.shader.get().build(this.configuration);return new Ye.a(e.rctx,t,Xe.a)}initializePipeline(){if(this.configuration.function===Zt.a.TransparentToHUDVisibility)return Object(Qe.f)({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case Yt.None:return Object(Qe.f)({colorWrite:Qe.c});case Yt.Alpha:return Object(Qe.f)({blending:Object(Qe.g)(F.b.SRC_ALPHA,F.b.ONE,F.b.ONE_MINUS_SRC_ALPHA,F.b.ONE_MINUS_SRC_ALPHA),colorWrite:Qe.c});default:return Object(Qe.f)({blending:Object(Qe.h)(F.b.ONE,F.b.ONE_MINUS_SRC_ALPHA),colorWrite:Qe.c})}}}Qt.shader=new We.a(Zt.b,(()=>i.e(322).then(i.bind(null,1352))));class Jt extends $e.a{constructor(){super(...arguments),this.function=Zt.a.Standard,this.alphaMode=Yt.None,this.hasOpacityFactor=!1}}Object(l.a)([Object($e.b)({count:Zt.a.COUNT})],Jt.prototype,"function",void 0),Object(l.a)([Object($e.b)({count:Yt.COUNT})],Jt.prototype,"alphaMode",void 0),Object(l.a)([Object($e.b)()],Jt.prototype,"hasOpacityFactor",void 0);var Kt=i(514);const ei=p.a.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let ti=class extends($(d.a)){constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new Wt,this._handles=new u.a,this._frameTask=Kt.a,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new m.a,this._geometries=new Map,this.worldToPCSRatio=1,this.events=new h.a,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new _t(this._rctx);const t=e.waterTextureRepository;this._stippleTextureRepository=new Xt(e.renderingContext),this._shaderTechniqueRepository=new W({rctx:this._rctx,viewingMode:T.a.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:t}),this._handles.add([Object(v.a)(t,"loadingState",(()=>this.events.emit("content-changed"))),Object(v.a)(this,"spatialReference",(e=>this._localOrigins=new vt.a(e)))]),this._materialRepository=new gt(e.textureRepository,this._shaderTechniqueRepository,(e=>{(e.renderOccluded&li)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating")}),(()=>this.events.emit("content-changed"))),this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new Ct(Object(x.h)(1,1,1))]),this._bindParameters={slot:Ge.a.DRAPED_MATERIAL,highlightDepthTexture:Object(Y.a)(this._rctx),camera:ni,inverseViewport:Object(j.a)(),origin:null,screenToWorldRatio:null,screenToPCSRatio:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:S.a,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:I.i.NONE,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:!0},this._frameTask=this.view.resourceController.scheduler.registerTask(Kt.b.STAGE,this),this._handles.add(this._frameTask)}dispose(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.destroy())),this._layerRenderers.clear(),this._debugTextureTechnique=Object(b.q)(this._debugTextureTechnique),this._debugPatternTexture=Object(b.e)(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=Object(b.e)(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=Object(b.e)(this._shaderTechniqueRepository),this._temporaryFBO=Object(b.e)(this._temporaryFBO),this._quadVAO=Object(b.e)(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedLayerRenderersDirty||this._frameTask.updating||Object(f.c)(this._layerRenderers,(e=>e.updating))}get hasOverlays(){return Object(b.k)(this._overlays)&&Object(b.k)(this._overlayRenderTarget)}get gpuMemoryUsage(){return Object(b.k)(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}collectUnusedRenderTargetMemory(e){let t=!1;if(Object(b.k)(this._overlayRenderTarget))for(const i of this._overlayRenderTarget.renderTargets){const r=this.overlays[0].validTargets[i.type]||!this.overlays[1].validTargets[i.type];t=this._overlayRenderTarget.validateUsageForTarget(r,i,e)||t}return t}get overlays(){return Object(b.t)(this._overlays,[])}ensureDrapeTargets(e){Object(b.k)(this._overlays)&&this._overlays.forEach((t=>{t.hasTargetWithoutRasterImage=Object(g.a)(e,(e=>e.drapeTargetType===C.b.WithoutRasterImage))}))}ensureDrapeSources(e){Object(b.k)(this._overlays)&&this._overlays.forEach((t=>{t.hasDrapedFeatureSource=Object(f.c)(e,((e,t)=>t.drapeSourceType===C.a.Features)),t.hasDrapedRasterSource=Object(f.c)(e,((e,t)=>t.drapeSourceType===C.a.RasterImage))}))}ensureOverlays(e,t){Object(b.j)(this._overlays)&&(this._overlayRenderTarget=new V(this._rctx),this._overlays=[new M(r.INNER,this._overlayRenderTarget),new M(r.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=Object(b.e)(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(e,t=(()=>!0)){this._frameTask.processQueue(e),e.done||this._processLayers(e,t)}_processLayers(e,t){let i=!1;for(const[r,a]of this._layerRenderers){if(e.done)break;(r.destroyed||t(r))&&(a.commitChanges()&&(i=!0,e.madeProgress()),a.isEmpty&&(i=!0,this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(r),this._handles.remove(r),a.destroy()))}this._updateSortedLayerRenderers(),i&&(Object(b.k)(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}processSyncLayers(){this._processLayers(Kt.c,(e=>e.updatePolicy===I.j.SYNC))}addGeometries(e,t,i,r=!1){for(const a of e)Object(b.j)(a.origin)&&(a.origin=this._localOrigins.getOrigin(a.boundingSphere)),this._geometries.set(a.id,a);this._ensureLayerRenderer(t,r).add(e),i===re.a.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e,t)}removeGeometries(e,t,i){for(const a of e)this._geometries.delete(Object(b.s)(a.id));const r=this._layerRenderers.get(t);r&&(r.remove(e),i===re.a.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e,t))}updateGeometries(e,t,i){const r=this._layerRenderers.get(t);if(r)switch(r.modify(e,i),i){case re.a.State.TRANSFORMATION:case re.a.State.VERTEXATTRS:return this._notifyGraphicGeometryChanged(e,t);case re.a.State.VISIBILITIES:return this._notifyGraphicVisibilityChanged(e,t)}else ei.warn("Attempted to update geometry for nonexistent layer")}_notifyGraphicGeometryChanged(e,t){if(Object(b.j)(t.notifyGraphicGeometryChanged))return;let i;for(const r of e){const e=r.graphicUid;Object(b.k)(e)&&e!==i&&(t.notifyGraphicGeometryChanged(e),i=e)}}_notifyGraphicVisibilityChanged(e,t){if(Object(b.j)(t.notifyGraphicVisibilityChanged))return;let i;for(const r of e){const e=r.graphicUid;Object(b.k)(e)&&e!==i&&(t.notifyGraphicVisibilityChanged(e),i=e)}}updateHighlights(e,t){const i=this._layerRenderers.get(t);i?i.modify(e,re.a.State.HIGHLIGHTS):ei.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return 0===this._geometries.size&&!E.a.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateAnimation(e){let t=!1;return this._layerRenderers.forEach((i=>t=i.updateAnimation(e)||t)),t}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawTarget(e,t,i){const a=e.canvasGeometries;if(0===a.numViews)return!1;this._screenToWorldRatio=i*e.mapUnitsPerPixel;const n=t.renderPass;if(this.isEmpty()||n===G.a.MATERIAL_HIGHLIGHT&&!this.hasHighlights||n===G.a.MATERIAL_NORMAL&&!this.hasWater||!e.hasSomeSizedView())return!1;const o=t.fbo;if(!o.isValid())return!1;const c=2*e.resolution,l=e.resolution;o.resize(c,l);const d=this._rctx;ni.pixelRatio=e.pixelRatio*i,this._renderContext.pass=n,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=n===G.a.MATERIAL_NORMAL?Ge.a.DRAPED_WATER:Ge.a.DRAPED_MATERIAL,e.applyViewport(this._rctx),o.bind(d),e.index===r.INNER&&(d.setClearColor(0,0,0,0),d.clearSafe(F.e.COLOR_BUFFER_BIT));const h=t.type===s.ColorNoRasterImage?ii.ExcludeRasterImage:t.type===s.Occluded?ii.OccludedOnly:ii.Normal;if(h===ii.OccludedOnly&&(this._renderContext.renderOccludedMask=li),E.a.OVERLAY_DRAW_DEBUG_TEXTURE&&h!==ii.OccludedOnly)for(let r=0;r<a.numViews;r++)this._setViewParameters(a.extents[r],e,ni),this._drawDebugTexture(e.resolution,ai[e.index]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({overlayLayer:t,renderer:i})=>{if(h===ii.ExcludeRasterImage&&t.drapeSourceType===C.a.RasterImage)return;const{fullOpacity:r}=t,s=Object(b.k)(r)&&r<1&&n===G.a.MATERIAL;s&&(this.bindTemporaryFramebuffer(this._rctx,c,l),d.clearSafe(F.e.COLOR_BUFFER_BIT));for(let n=0;n<a.numViews;n++)this._setViewParameters(a.extents[n],e,ni),i.render(this._renderContext,this._bindParameters);s&&Object(b.k)(this._temporaryFBO)&&(o.bind(d),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),Yt.PremultipliedAlpha,r,Zt.a.OverlayWithTransparency,e.index))})),d.bindFramebuffer(null),o.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,i){Object(b.j)(this._temporaryFBO)&&(this._temporaryFBO=new U(e,!1)),this._temporaryFBO.resize(t,i),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}intersect(e,t,i,r){let a=0;this._geometries.forEach((n=>{if(r&&!r(n))return;this._intersectRenderGeometry(n,i,t,0,e,a);const s=this.longitudeCyclical;s&&(n.boundingSphere[0]-n.boundingSphere[3]<s.min&&this._intersectRenderGeometry(n,i,t,s.range,e,a),n.boundingSphere[0]+n.boundingSphere[3]>s.max&&this._intersectRenderGeometry(n,i,t,-s.range,e,a)),a++}))}_intersectRenderGeometry(e,t,i,r,a,n){if(!e.instanceParameters.visible)return;let s=0;Object(b.k)(e.transformation)&&(r+=e.transformation[12],s=e.transformation[13]),si[0]=i[0]-r,si[1]=i[1]-s,si[2]=1,oi[0]=i[0]-r,oi[1]=i[1]-s,oi[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),a,si,oi,((i,r,s)=>{!function(e,t,i,r,a,n,s){const o={layerUid:n,graphicUid:s,triangleNr:t},c=t=>{t.set(yt.b.OVERLAY,o,e.dist,e.normal,e.transformation,i,r)};if((null==a.results.min.drapedLayerOrder||i>=a.results.min.drapedLayerOrder)&&(null==a.results.min.dist||a.results.ground.dist<=a.results.min.dist)&&c(a.results.min),a.options.store!==yt.c.MIN&&(null==a.results.max.drapedLayerOrder||i<a.results.max.drapedLayerOrder)&&(null==a.results.max.dist||a.results.ground.dist>a.results.max.dist)&&c(a.results.max),a.options.store===yt.c.ALL){const e=Object(Ot.b)(a.ray);c(e),a.results.all.push(e)}}(t,s,e.material.renderPriority,n,a,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,t)}_ensureLayerRenderer(e,t){let i=this._layerRenderers.get(e);return i&&t===i instanceof pt||(i=t?new pt({rctx:this._rctx,materialRepository:this._materialRepository}):new Le({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,i),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.events.emit("content-changed"))),e),this._handles.add(Object(v.a)(i,"updating",(()=>this.notifyChange("updating"))),e)),i}_updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const e=this.view.map.allLayers;this._layerRenderers.forEach(((t,i)=>{const r=e.indexOf(i.layer);this._sortedLayerRenderers.push(new ri(i,t,r<0?1/0:r))})),this._sortedLayerRenderers.sort(((e,t)=>e.index-t.index))}_setViewParameters(e,t,i){i.viewport[0]=i.viewport[1]=0,i.viewport[2]=i.viewport[3]=t.resolution,Object(_.q)(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),Object(_.f)(i.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=i,this._bindParameters.camera=i,this._bindParameters.inverseViewport[0]=1/i.fullViewport[2],this._bindParameters.inverseViewport[1]=1/i.fullViewport[3]}_updateHasWater(){const e=Object(f.c)(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateHasHighlights(){const e=Object(f.c)(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}_updateRendersOccluded(){const e=Object(f.c)(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_drawDebugTexture(e,t){this._ensureDebugPatternResources(e,e);const i=this._rctx,r=i.useTechnique(this._debugTextureTechnique);r.setUniform4f("uColor",t[0],t[1],t[2],1),r.bindTexture(this._debugPatternTexture,"tex"),i.bindVAO(this._quadVAO),i.drawArrays(F.r.TRIANGLE_STRIP,0,Object(ut.f)(this._quadVAO,"geometry"))}_ensureDebugPatternResources(e,t){if(this._debugPatternTexture)return;const i=new Uint8Array(e*t*4);let r=0;for(let n=0;n<t;n++)for(let a=0;a<e;a++){const s=Math.floor(a/10),o=Math.floor(n/10);s<2||o<2||10*s>e-20||10*o>t-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&s&&1&o?1&a^1&n?0:255:1&s^1&o?0:128)}this._debugPatternTexture=new Je.a(this._rctx,{target:F.A.TEXTURE_2D,pixelFormat:F.p.RGBA,dataType:F.q.UNSIGNED_BYTE,samplingMode:F.z.NEAREST,width:e,height:t},i);const a=new Tt;a.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(St,a),this._quadVAO=Object(Y.b)(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};var ii;Object(l.a)([Object(O.b)()],ti.prototype,"_frameTask",void 0),Object(l.a)([Object(O.b)()],ti.prototype,"_sortedLayerRenderersDirty",void 0),Object(l.a)([(e,t)=>{var i,r;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!=(i=null==(r=e._managedDisposables)?void 0:r.slice())?i:[]),e._managedDisposables.unshift(t)}],ti.prototype,"_shaderTechniqueRepository",void 0),Object(l.a)([(e,t)=>{var i,r;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=null!=(i=null==(r=e._managedDisposables)?void 0:r.slice())?i:[]),e._managedDisposables.unshift(t)}],ti.prototype,"_stippleTextureRepository",void 0),Object(l.a)([Object(O.b)({constructOnly:!0})],ti.prototype,"view",void 0),Object(l.a)([Object(O.b)()],ti.prototype,"worldToPCSRatio",void 0),Object(l.a)([Object(O.b)()],ti.prototype,"spatialReference",void 0),Object(l.a)([Object(O.b)({type:Boolean,readOnly:!0})],ti.prototype,"updating",null),ti=Object(l.a)([Object(y.a)("esri.views.3d.terrain.OverlayRenderer")],ti),function(e){e[e.Normal=0]="Normal",e[e.OccludedOnly=1]="OccludedOnly",e[e.ExcludeRasterImage=2]="ExcludeRasterImage"}(ii||(ii={}));class ri{constructor(e,t,i){this.overlayLayer=e,this.renderer=t,this.index=i}}const ai=[[1,.5,.5],[.5,.5,1]];const ni=new X.a;ni.near=1,ni.far=1e4,ni.relativeElevation=null;const si=Object(x.f)(),oi=Object(x.f)(),ci=-2,li=ie.c.OccludeAndTransparent},1061:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));var r=i(410),a=i(126);function n(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMatrix","mat4"),e.fragment.uniforms.add("proj","mat4"),e.fragment.code.add(a.a`vec2 reprojectionCoordinate(vec3 projectionCoordinate)
{
vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
reprojectedCoord.xy /= reprojectedCoord.w;
return reprojectedCoord.xy * 0.5 + 0.5;
}`)}function s(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("view","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.fragment.include(r.a),e.include(n),e.fragment.code.add(a.a`
  const int maxSteps = ${t.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function o(e,t){var i,r;t.ssrEnabled&&(e.bindTexture(t.linearDepthTexture,"depthMapView"),e.setUniform2fv("nearFar",t.camera.nearFar),e.setUniformMatrix4fv("view",t.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/t.camera.height),r=t,(i=e).bindTexture(r.lastFrameColorTexture,"lastFrameColorMap"),i.setUniformMatrix4fv("reprojectionMatrix",r.reprojectionMatrix),i.setUniformMatrix4fv("proj",r.camera.projectionMatrix))}},1084:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i(410),a=i(857),n=i(500),s=i(126);function o(e,t){t.multipassGeometryEnabled&&e.vertex.include(a.b),t.multipassTerrainEnabled&&e.varyings.add("depth","float"),e.vertex.code.add(s.a`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${t.multipassGeometryEnabled?s.a`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${t.multipassTerrainEnabled?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),t.multipassTerrainEnabled&&e.fragment.include(r.a),e.fragment.uniforms.add("terrainDepthTexture","sampler2D"),e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("inverseViewport","vec2"),e.fragment.include(n.a),e.fragment.code.add(s.a`
  void main() {
    gl_FragColor = vec4(1, 1, 1, 1);
    ${t.multipassTerrainEnabled?s.a`

          vec2 uv = gl_FragCoord.xy * inverseViewport;

          //Read the rgba data from the texture linear depth
          vec4 terrainDepthData = texture2D(terrainDepthTexture, uv);

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), nearFar);

          //If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          //Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            gl_FragColor.g = 0.5;
          }`:""}
  }
  `)}},1085:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));var r=i(85);const a={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},n={dash:a.dash,"dash-dot":[...a.dash,...a.dot],dot:a.dot,"long-dash":a["long-dash"],"long-dash-dot":[...a["long-dash"],...a.dot],"long-dash-dot-dot":[...a["long-dash"],...a.dot,...a.dot],none:null,"short-dash":a["short-dash"],"short-dash-dot":[...a["short-dash"],...a["short-dot"]],"short-dash-dot-dot":[...a["short-dash"],...a["short-dot"],...a["short-dot"]],"short-dot":a["short-dot"],solid:null};function s(e,t=2){return{pattern:[e,e],pixelRatio:t}}function o(e){return Object(r.k)(e)&&"style"===e.type?function(e){return Object(r.k)(e)?function(e,t=2){return Object(r.j)(e)?e:{pattern:e.slice(),pixelRatio:t}}(n[e],8):null}(e.style):null}},1086:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var r=i(1007),a=i(947),n=i(754),s=i(1061),o=i(948),c=i(126);function l(e,t){e.include(n.a,t),e.include(a.a),e.include(r.a),t.cloudsReflectionsEnabled&&e.include(o.a),t.ssrEnabled&&e.include(s.a,t),e.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),e.fragment.code.add(c.a`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),e.fragment.code.add(c.a`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),t.cloudsReflectionsEnabled&&e.fragment.code.add(c.a`vec4 cloudsColor = crossFade == 0 ? renderCloud(reflectedWorld, position) : renderCloudCrossFade(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y*cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * (1.0 - totalFadeInOut);`),t.ssrEnabled?e.fragment.code.add(c.a`vec4 viewPosition = vec4(positionView.xyz, 1.0);
vec3 viewDir = normalize(viewPosition.xyz);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view *vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
reflectionHit = clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod*0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor + reflSea * seaColorMod + specular  + foam);`):e.fragment.code.add(c.a`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),t.cloudsReflectionsEnabled?t.ssrEnabled?e.fragment.code.add(c.a`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):e.fragment.code.add(c.a`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):e.fragment.code.add(c.a`return waterRenderedColor;
}`)}},1087:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s}));var r=i(219),a=i(335);const n={waveStrength:.06,waveTextureRepeat:32,waveDirection:Object(r.e)(1,0),waveVelocity:.05,flowStrength:.015,flowOffset:-.5,animationSpeed:.35,color:[0,0,0,0],transparent:!0,writeDepth:!0,slicePlaneEnabled:!1,isDraped:!1,receiveShadows:!0,ssrEnabled:!1,...a.a},s={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}}},1088:function(e,t,i){"use strict";i.d(t,"a",(function(){return m}));var r=i(85),a=i(244),n=i(200),s=i(117),o=i(109),c=i(187),l=i(163),d=i(595),h=i(1005),u=i(659),p=i(139),f=i(776),b=i(777);class m{constructor(e,t=125e4){this._originSR=e,this._gridSize=t,this._origins=new Map,this._objects=new Map,this._rootOriginId="root/"+Object(a.a)()}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(null==t){if(Object(r.k)(g))return this._origins.set(this._rootOriginId,Object(h.a)(g[0],g[1],g[2],this._rootOriginId)),this.getOrigin(e);const t=Object(h.a)(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,t),t}const i=this._gridSize,a=Math.round(e[0]/i),n=Math.round(e[1]/i),o=Math.round(e[2]/i),c=`${a}/${n}/${o}`;let l=this._origins.get(c);const d=.5*i;if(Object(s.j)(v,e,t.vec3),v[0]=Math.abs(v[0]),v[1]=Math.abs(v[1]),v[2]=Math.abs(v[2]),v[0]<d&&v[1]<d&&v[2]<d){if(l){const t=Math.max(...v);if(Object(s.j)(v,e,l.vec3),v[0]=Math.abs(v[0]),v[1]=Math.abs(v[1]),v[2]=Math.abs(v[2]),Math.max(...v)<t)return l}return t}return l||(l=Object(h.a)(a*i,n*i,o*i,c),this._origins.set(c,l)),l}_drawOriginBox(e,t=[1,1,0,1]){const i=window.view,r=i._stage,a=t.toString();if(!this._objects.has(a)){this._material=new b.a({width:2,color:t}),r.add(this._material);const e=new f.a({isPickable:!1}),i=new u.a({castShadow:!1});r.add(i),e.add(i),r.add(e),this._objects.set(a,i)}const s=this._objects.get(a),o=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],h=o.length,m=new Array(3*h),g=new Uint16Array(2*(h-1)),v=.5*this._gridSize;for(let n=0;n<h;n++)m[3*n+0]=e[0]+(1&o[n]?v:-v),m[3*n+1]=e[1]+(2&o[n]?v:-v),m[3*n+2]=e[2]+(4&o[n]?v:-v),n>0&&(g[2*n+0]=n-1,g[2*n+1]=n);Object(c.l)(m,this._originSR,0,m,i.renderSpatialReference,0,h);const O=new d.a([[p.a.POSITION,{size:3,data:m,exclusive:!0}]],[[p.a.POSITION,g]],l.f.Line);r.add(O),s.addGeometry(O,this._material,n.a)}}let g=null;const v=Object(o.f)()},1089:function(e,t,i){"use strict";i.d(t,"a",(function(){return p})),i.d(t,"b",(function(){return d})),i.d(t,"c",(function(){return h}));var r=i(301),a=i(946),n=i(753),s=i(857),o=i(126),c=i(297),l=i(139);function d(e){const t=new c.a;return t.include(a.a),t.include(n.a,e),t.include(r.a,e),t.attributes.add(l.a.UV0,"vec2"),t.vertex.uniforms.add("lineSize","float").add("pixelToNDC","vec2").add("borderSize","float").add("screenOffset","vec2"),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),e.multipassGeometryEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(o.a`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${e.occlusionTestEnabled?o.a`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${e.screenSizePerspectiveEnabled?o.a`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:o.a`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${e.multipassGeometryEnabled?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${e.depthHudEnabled?e.depthHudAlignStartEnabled?o.a`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:o.a`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.screenSizePerspectiveEnabled?o.a`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:o.a`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),t.fragment.uniforms.add("uColor","vec4"),t.fragment.uniforms.add("borderColor","vec4"),e.multipassGeometryEnabled&&(t.fragment.include(s.b,e),t.fragment.uniforms.add("inverseViewport","vec2")),t.fragment.code.add(o.a`
    void main() {
      ${e.multipassGeometryEnabled?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = uColor.a * borderColor.a * coverage.y;
      float colorAlpha = uColor.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${e.depthHudEnabled?o.a`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:o.a`
      // Compute the finalRgb, but keep it pre-multiplied (for unpre-multiplied you
      // need to divide by finalAlpha). We avoid the division here by setting the
      // appropriate blending function in the material.
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),t}function h(e,t,i){u(e,"uColor",t.color),e.setUniform1f("pixelRatio",i),e.setUniform2f("screenOffset",t.screenOffset[0]*i,t.screenOffset[1]*i),null!==t.borderColor?(u(e,"borderColor",t.borderColor),e.setUniform1f("borderSize",i)):(e.setUniform4f("borderColor",0,0,0,0),e.setUniform1f("borderSize",0))}function u(e,t,i){3===i.length?e.setUniform4f(t,i[0],i[1],i[2],1):e.setUniform4fv(t,i)}const p=Object.freeze({__proto__:null,build:d,bindLineCalloutUniforms:h})},1090:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r=i(639),a=i(913),n=i(689),s=i(126),o=i(139);function c(e,t){const i=e.fragment;t.vertexTangents?(e.attributes.add(o.a.TANGENT,"vec4"),e.varyings.add("vTangent","vec4"),t.doubleSidedMode===n.b.WindingOrder?i.code.add(s.a`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`):i.code.add(s.a`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = vTangent.w;
vec3 tangent = normalize(vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`)):(e.extensions.add("GL_OES_standard_derivatives"),i.code.add(s.a`mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {
vec3 Q1 = dFdx(pos);
vec3 Q2 = dFdy(pos);
vec2 stx = dFdx(st);
vec2 sty = dFdy(st);
float det = stx.t * sty.s - sty.t * stx.s;
vec3 T = stx.t * Q2 - sty.t * Q1;
T = T - normal * dot(normal, T);
T *= inversesqrt(max(dot(T,T), 1.e-10));
vec3 B = sign(det) * cross(normal, T);
return mat3(T, B, normal);
}`)),t.attributeTextureCoordinates!==r.b.None&&(e.include(a.a,t),i.uniforms.add("normalTexture","sampler2D"),i.uniforms.add("normalTextureSize","vec2"),i.code.add(s.a`
    vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
      vtc.uv = uv;
      ${t.supportsTextureAtlas?"vtc.size = normalTextureSize;":""}
      vec3 rawNormal = textureLookup(normalTexture, vtc).rgb * 2.0 - 1.0;
      return tangentSpace * rawNormal;
    }
  `))}},1091:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(210),a=i(126),n=i(493);function s(e,t){const i=a.a`
  /*
  *  ${t.name}
  *  ${t.output===r.a.Color?"RenderOutput: Color":t.output===r.a.Depth?"RenderOutput: Depth":t.output===r.a.Shadow?"RenderOutput: Shadow":t.output===r.a.Normal?"RenderOutput: Normal":t.output===r.a.Highlight?"RenderOutput: Highlight":""}
  */
  `;Object(n.c)()&&(e.fragment.code.add(i),e.vertex.code.add(i))}},1100:function(e,t,i){"use strict";i.d(t,"a",(function(){return Ae}));var r=i(210),a=i(85),n=i(448);class s{constructor(){this.enabled=!0,this._time=0}get time(){return Object(n.a)(this._time)}advance(e){return Object(a.k)(e.forcedTime)?this._time!==e.forcedTime&&(this._time=e.forcedTime,!0):!(!this.enabled||0===e.dt)&&(this._time+=e.dt,!0)}}var o=i(621),c=i(335),l=i(445),d=i(411),h=i(163),u=i(545),p=i(79),f=i(82),b=i(100),m=i(116),g=i(81),v=(i(84),i(83),i(80)),O=i(147),y=i(200),_=i(117),j=i(109),x=(i(543),i(462)),S=i(526);i(288);function T(e=E){return[e[0],e[1],e[2],e[3]]}function C(e,t,i=T()){return Object(_.g)(i,e,t),Object(_.r)(i,i),i[3]=Object(S.a)(e,t),i}const E=[0,0,1,0];Object(x.b)(),Object(x.b)();var A=i(1006),w=i(388),R=i(404),P=i(382),I=i(389),D=i(94),M=i(355);class L extends R.a{constructor(e){super(e,null,(()=>this.destroy()))}initializeProgram(e){const t=L.shader.get().build();return new I.a(e.rctx,t,P.a)}initializePipeline(){return Object(M.f)({blending:Object(M.h)(D.b.ONE,D.b.SRC_ALPHA),depthTest:{func:D.h.LEQUAL},colorWrite:M.c})}}L.shader=new w.a(A.a,(()=>i.e(318).then(i.bind(null,1348))));var N,F=i(86),z=i(95);let U=N=class extends F.a{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new N({cloudCover:this.cloudCover})}};Object(p.a)([Object(z.a)({cloudy:"cloudy"})],U.prototype,"type",void 0),Object(p.a)([Object(g.b)({type:Number,nonNullable:!0,range:{min:0,max:1}})],U.prototype,"cloudCover",void 0),U=N=Object(p.a)([Object(v.a)("esri.views.3d.environment.CloudyWeather")],U);const G=U;var V;let B=V=class extends F.a{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new V({fogStrength:this.fogStrength})}};Object(p.a)([Object(z.a)({foggy:"foggy"})],B.prototype,"type",void 0),Object(p.a)([Object(g.b)({type:Number,nonNullable:!0,range:{min:0,max:1}})],B.prototype,"fogStrength",void 0),B=V=Object(p.a)([Object(v.a)("esri.views.3d.environment.FoggyWeather")],B);const k=B;var H;let W=H=class extends F.a{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new H({cloudCover:this.cloudCover,precipitation:this.precipitation})}};Object(p.a)([Object(z.a)({rainy:"rainy"})],W.prototype,"type",void 0),Object(p.a)([Object(g.b)({type:Number,nonNullable:!0,range:{min:0,max:1}})],W.prototype,"cloudCover",void 0),Object(p.a)([Object(g.b)({type:Number,nonNullable:!0,range:{min:0,max:1}})],W.prototype,"precipitation",void 0),W=H=Object(p.a)([Object(v.a)("esri.views.3d.environment.RainyWeather")],W);const q=W;var $;let X=$=class extends b.a{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5}clone(){return new $({cloudCover:this.cloudCover,precipitation:this.precipitation})}};Object(p.a)([Object(z.a)({snowy:"snowy"})],X.prototype,"type",void 0),Object(p.a)([Object(g.b)({type:Number,nonNullable:!0,range:{min:0,max:1}})],X.prototype,"cloudCover",void 0),Object(p.a)([Object(g.b)({type:Number,nonNullable:!0,range:{min:0,max:1}})],X.prototype,"precipitation",void 0),X=$=Object(p.a)([Object(v.a)("esri.views.3d.environment.SnowyWeather")],X);const Y=X;var Z;let Q=Z=class extends F.a{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new Z({cloudCover:this.cloudCover})}};Object(p.a)([Object(z.a)({sunny:"sunny"})],Q.prototype,"type",void 0),Object(p.a)([Object(g.b)({type:Number,nonNullable:!0,range:{min:0,max:1}})],Q.prototype,"cloudCover",void 0),Q=Z=Object(p.a)([Object(v.a)("esri.views.3d.environment.SunnyWeather")],Q);const J={key:"type",base:null,typeMap:{sunny:Q,cloudy:G,rainy:q,snowy:Y,foggy:k}};Object.keys(J.typeMap);const K=1e4;var ee=i(692);let te=class extends b.a{constructor(e){super(e),this._inverseProjectionMatrix=Object(y.d)(),this._inverseViewMatrix=Object(y.d)(),this._technique=new L(e),this._vao=Object(ee.b)(e.rctx),this._setDefaultParallax(e.radius)}destroy(){this._technique=Object(a.q)(this._technique),this._vao=Object(a.e)(this._vao)}render(e,t,i){this._parameters.clouds=t;const r=e.camera;if(Object(a.j)(this._vao)||Object(a.j)(r))return;const n=e.rctx,s=n.useTechnique(this._technique);e.scenelightingData.setLightDirectionUniform(s),e.scenelightingData.setUniforms(s,!1,!1),Object(O.a)(this._inverseProjectionMatrix,r.projectionMatrix),Object(O.a)(this._inverseViewMatrix,r.viewMatrix),s.setUniformMatrix4fv("inverseProjectionMatrix",this._inverseProjectionMatrix),s.setUniformMatrix4fv("inverseViewMatrix",this._inverseViewMatrix),s.setUniform2f("cloudVariables",this._parameters.clouds.coverage,this._parameters.clouds.absorption),this._setParallaxParams(r.eye,i),e.cloudsCompositionParams=this._parameters,oe(s,r,this._parameters),n.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),n.drawArrays(D.r.TRIANGLE_STRIP,0,4)}get isFading(){return this._parameters.crossFade.stage!==ae.FINISHED||this._parameters.fadeInOut.stage!==re.FINISHED||this._parameters.fadeIn.stage!==ie.FINISHED||this._parameters.fadeInOutHeight.stage!==ne.FINISHED}_setDefaultParallax(e){this._parameters={parallax:{anchorPointClouds:Object(j.f)(),radius:e,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:Object(y.d)()},parallaxNew:{anchorPointClouds:Object(j.f)(),radius:e,cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:Object(y.d)()},crossFade:{stage:ae.FINISHED,factor:0,distanceThresholdFactor:.3},fadeInOut:{stage:re.FINISHED,factor:0,distanceThresholdFactor:.6},fadeIn:{stage:ie.FINISHED,factor:0,distanceThresholdFactor:2},fadeInOutHeight:{stage:ne.FINISHED,factor:-1},cameraPositionLastFrame:Object(j.f)(),startTime:0,startTimeHeightFade:0,clouds:null}}_isCameraPositionFinal(e){return Object(_.C)(this._parameters.cameraPositionLastFrame,e)}_setFadeInStage(e){const t=this._isCameraPositionFinal(e);this._parameters.fadeIn.stage===ie.FINISHED&&(this._parameters.fadeIn.factor=1,Object(_.k)(this._parameters.parallax.anchorPointClouds,de),this._parameters.fadeIn.stage=ie.CHANGE_ANCHOR,this._parameters.crossFade.stage=ae.FINISHED,this._parameters.fadeInOut.stage=re.FINISHED),this._parameters.fadeIn.stage===ie.CHANGE_ANCHOR&&t&&(Object(_.k)(this._parameters.parallax.anchorPointClouds,de),this._parameters.fadeIn.stage=ie.FADE_IN,this._parameters.startTime=performance.now()),this._parameters.fadeIn.factor>0&&this._parameters.fadeIn.stage===ie.FADE_IN&&(this._parameters.fadeIn.factor=1-(performance.now()-this._parameters.startTime)/500),this._parameters.fadeIn.factor<=0&&this._parameters.fadeIn.stage===ie.FADE_IN&&(this._parameters.fadeIn.stage=ie.FINISHED,this._parameters.fadeIn.factor=0)}_setCrossFadingStage(){this._parameters.crossFade.stage===ae.FINISHED&&(Object(_.k)(this._parameters.parallaxNew.anchorPointClouds,de),this._parameters.startTime=performance.now(),this._parameters.crossFade.factor=0,this._parameters.crossFade.stage=ae.CROSS_FADE),this._parameters.crossFade.factor<1&&this._parameters.crossFade.stage===ae.CROSS_FADE&&(this._parameters.crossFade.factor=(performance.now()-this._parameters.startTime)/500),this._parameters.crossFade.factor>=1&&this._parameters.crossFade.stage===ae.CROSS_FADE&&(this._parameters.crossFade.stage=ae.FINISHED,this._parameters.crossFade.factor=1,Object(_.k)(this._parameters.parallax.anchorPointClouds,this._parameters.parallaxNew.anchorPointClouds))}_setFadeInOutStage(e){this._parameters.fadeInOut.stage===re.FINISHED&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=0,this._parameters.fadeInOut.stage=re.FADE_OUT),this._parameters.fadeInOut.factor<1&&this._parameters.fadeInOut.stage===re.FADE_OUT&&(this._parameters.fadeInOut.factor=(performance.now()-this._parameters.startTime)/250),this._parameters.fadeInOut.factor>=1&&this._parameters.fadeInOut.stage===re.FADE_OUT&&(this._parameters.fadeInOut.factor=1,Object(_.k)(this._parameters.parallax.anchorPointClouds,de)),this._parameters.fadeInOut.factor>=1&&this._parameters.fadeInOut.stage===re.FADE_OUT&&this._isCameraPositionFinal(e)&&(this._parameters.startTime=performance.now(),this._parameters.fadeInOut.factor=1,this._parameters.fadeInOut.stage=re.FADE_IN,this._parameters.crossFade.stage=ae.FINISHED,this._parameters.crossFade.factor=0),this._parameters.fadeInOut.factor>0&&this._parameters.fadeInOut.stage===re.FADE_IN&&(this._parameters.fadeInOut.factor=1-(performance.now()-this._parameters.startTime)/500),this._parameters.fadeInOut.factor<=0&&this._parameters.fadeInOut.stage===re.FADE_IN&&(this._parameters.fadeInOut.stage=re.FINISHED,this._parameters.fadeInOut.factor=0)}_setFadeInOutHeight(e){const t=performance.now();this._parameters.startTimeHeightFade=this._parameters.fadeInOutHeight.stage===ne.FINISHED?t:this._parameters.startTimeHeightFade,e?this._parameters.fadeInOutHeight.factor+=(t-this._parameters.startTimeHeightFade)/500:this._parameters.fadeInOutHeight.factor-=(t-this._parameters.startTimeHeightFade)/500,this._parameters.startTimeHeightFade=t,this._parameters.fadeInOutHeight.factor=Object(m.e)(this._parameters.fadeInOutHeight.factor,0,1),this._parameters.fadeInOutHeight.stage=ne.HEIGHT_FADE}_setParallaxParams(e,t){this._parameters.fadeInOutHeight.factor<0&&(this._parameters.fadeInOutHeight.factor=Object(_.p)(e)-this._parameters.parallax.radius>K?1:0),Object(_.r)(de,e),Object(_.e)(de,de,this._parameters.parallax.radius),0===this._parameters.parallax.anchorPointClouds[0]&&0===this._parameters.parallax.anchorPointClouds[1]&&0===this._parameters.parallax.anchorPointClouds[2]&&Object(_.k)(this._parameters.parallax.anchorPointClouds,de);const i=Object(_.p)(Object(_.j)(he,this._parameters.parallax.anchorPointClouds,de));let r=!0;i>this._parameters.fadeIn.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeIn.stage!==ie.FINISHED?this._setFadeInStage(e):i>this._parameters.fadeInOut.distanceThresholdFactor*this._parameters.parallax.cloudsHeight||this._parameters.fadeInOut.stage!==re.FINISHED?this._setFadeInOutStage(e):i>this._parameters.crossFade.distanceThresholdFactor*this._parameters.parallax.cloudsHeight&&!t||this._parameters.crossFade.stage!==ae.FINISHED?this._setCrossFadingStage():r=!1;const a=Object(_.p)(e),n=a-this._parameters.parallax.radius;(n>17e3||n<-1e4)&&this._parameters.fadeInOutHeight.factor<1?this._parameters.fadeInOutHeight.factor=1:(n>K||n<-3500)&&this._parameters.fadeInOutHeight.factor<1?this._setFadeInOutHeight(!0):n<K&&n>-3500&&this._parameters.fadeInOutHeight.factor>0?this._setFadeInOutHeight(!1):this._parameters.fadeInOutHeight.stage=ne.FINISHED,this._parameters.parallax.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(a*a-this._parameters.parallax.radius*this._parameters.parallax.radius,0))/a,C(ce,this._parameters.parallax.anchorPointClouds,le),this._parameters.parallax.transform=Object(y.d)(),Object(O.e)(this._parameters.parallax.transform,this._parameters.parallax.transform,le[3],le),r&&(C(ce,this._parameters.parallaxNew.anchorPointClouds,le),this._parameters.parallaxNew.transform=Object(y.d)(),Object(O.e)(this._parameters.parallaxNew.transform,this._parameters.parallaxNew.transform,le[3],le)),Object(_.k)(this._parameters.cameraPositionLastFrame,e)}};var ie,re,ae,ne,se;function oe(e,t,i){e.bindTexture(i.clouds.cubeMap.colorTexture,"cubeMap"),e.setUniform1f("cloudsHeight",i.parallax.cloudsHeight),e.setUniformMatrix4fv("rotationMatrixClouds",i.parallax.transform),e.setUniformMatrix4fv("rotationMatrixCloudsCrossFade",i.parallaxNew.transform),e.setUniform3fv("anchorPosition",i.parallax.anchorPointClouds),e.setUniform3fv("anchorPositionCrossFade",i.parallaxNew.anchorPointClouds),i.fadeInOut.stage!==re.FINISHED?e.setUniform1f("totalFadeInOut",i.fadeInOutHeight.factor+Math.max(Object(m.e)(i.fadeInOut.factor,0,1))):e.setUniform1f("totalFadeInOut",i.fadeInOutHeight.factor+Math.max(Object(m.e)(i.fadeIn.factor,0,1))),e.setUniform1f("radiusCurvatureCorrectionFactor",i.parallax.radiusCurvatureCorrectionFactor),e.setUniform1i("crossFade",i.crossFade.stage),e.setUniform1f("crossFadeAnchorFactor",Object(m.e)(i.crossFade.factor,0,1)),e.setUniform1f("radius",i.parallax.radius),e.setUniform3fv("cameraPosition",t.eye)}Object(p.a)([Object(g.b)({constructOnly:!0})],te.prototype,"rctx",void 0),Object(p.a)([Object(g.b)({constructOnly:!0})],te.prototype,"viewingMode",void 0),Object(p.a)([Object(g.b)({constructOnly:!0})],te.prototype,"radius",void 0),te=Object(p.a)([Object(v.a)("esri.views.3d.environment.CloudsComposition")],te),(se=ie||(ie={}))[se.FINISHED=0]="FINISHED",se[se.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",se[se.FADE_IN=2]="FADE_IN",function(e){e[e.FINISHED=0]="FINISHED",e[e.FADE_OUT=1]="FADE_OUT",e[e.FADE_IN=2]="FADE_IN"}(re||(re={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.CROSS_FADE=1]="CROSS_FADE"}(ae||(ae={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.HEIGHT_FADE=1]="HEIGHT_FADE"}(ne||(ne={}));const ce=Object(j.h)(0,0,1),le=T(),de=Object(j.f)(),he=Object(j.f)();var ue=i(301),pe=i(420),fe=i(356),be=i(502),me=i(625),ge=i(1061),ve=i(949),Oe=i(501),ye=i(419),_e=i(1008);class je extends R.a{constructor(e,t,i){super(e,t,i),this._textureRepository=e.waterTextureRepository}initializeProgram(e){const t=je.shader.get(),i=this.configuration,r=t.build({oitEnabled:i.transparencyPassType===h.i.Color,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,pbrMode:be.a.Water,useCustomDTRExponentForWater:!0,ssrEnabled:i.useSSR,cloudsReflectionsEnabled:Object(f.a)("enable-feature:clouds-reflections"),highStepCount:!0,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new I.a(e.rctx,r,P.a)}bindPass(e,t){Object(Oe.b)(this.program,t.camera.projectionMatrix),t.multipassTerrainEnabled&&(this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(fe.a)(this.program,t)),this.configuration.output===r.a.Color&&(t.lighting.setUniforms(this.program,!1,!1),Object(ge.b)(this.program,t),Object(f.a)("enable-feature:clouds-reflections")&&Object(a.k)(t.cloudsCompositionParams)&&oe(this.program,t.camera,t.cloudsCompositionParams)),this.configuration.output!==r.a.Color&&this.configuration.output!==r.a.Normal||(Object(ve.b)(this.program,e),this._textureRepository.bind(this.program)),this.program.setUniform4fv("waterColor",e.color),this.configuration.output===r.a.Highlight&&Object(pe.b)(this.program,t)}bindDraw(e){Object(Oe.c)(this.program,e),this.program.rebindTextures(),this.configuration.output!==r.a.Color&&this.configuration.output!==r.a.Alpha||Object(Oe.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),this.configuration.output===r.a.Color&&Object(me.b)(this.program,e),this.configuration.output!==r.a.Color&&this.configuration.output!==r.a.Alpha&&this.configuration.output!==r.a.Highlight||Object(ue.c)(this.program,this.configuration,e)}_setPipelineState(e){const t=this.configuration,i=e===h.i.NONE,a=e===h.i.FrontFace;return Object(M.f)({blending:t.output!==r.a.Normal&&t.output!==r.a.Highlight&&t.transparent?i?l.d:Object(l.f)(e):null,depthTest:{func:Object(l.g)(e)},depthWrite:i?t.writeDepth&&M.d:Object(l.h)(e),colorWrite:M.c,polygonOffset:i||a?null:Object(l.e)(t.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}je.shader=new w.a(_e.a,(()=>i.e(338).then(i.bind(null,1347))));class xe extends ye.a{constructor(){super(...arguments),this.output=r.a.Color,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=h.i.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(p.a)([Object(ye.b)({count:r.a.COUNT})],xe.prototype,"output",void 0),Object(p.a)([Object(ye.b)()],xe.prototype,"receiveShadows",void 0),Object(p.a)([Object(ye.b)()],xe.prototype,"slicePlaneEnabled",void 0),Object(p.a)([Object(ye.b)()],xe.prototype,"transparent",void 0),Object(p.a)([Object(ye.b)()],xe.prototype,"enableOffset",void 0),Object(p.a)([Object(ye.b)()],xe.prototype,"writeDepth",void 0),Object(p.a)([Object(ye.b)()],xe.prototype,"useSSR",void 0),Object(p.a)([Object(ye.b)()],xe.prototype,"isDraped",void 0),Object(p.a)([Object(ye.b)({count:h.i.COUNT})],xe.prototype,"transparencyPassType",void 0),Object(p.a)([Object(ye.b)()],xe.prototype,"multipassTerrainEnabled",void 0),Object(p.a)([Object(ye.b)()],xe.prototype,"cullAboveGround",void 0);class Se extends u.a{updateParameters(e){return this.ensureTechnique(je,e)}setElapsedTimeUniform(e){const t=.001*this._material.animation.time;e.setUniform1f("timeElapsed",t*this._material.parameters.animationSpeed)}_updateShadowState(e){e.shadowMappingEnabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMappingEnabled})}_updateSSRState(e){e.ssrEnabled!==this._material.parameters.ssrEnabled&&this._material.setParameters({ssrEnabled:e.ssrEnabled})}ensureResources(e){const t=this._techniqueRep.constructionContext.waterTextureRepository;return t.ready||t.updating||t.loadTextures(e),t.ready?h.g.LOADED:h.g.LOADING}beginSlot(e){return this._output===r.a.Color&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.parameters,e),this._output!==r.a.Normal&&this._output!==r.a.Color||this.setElapsedTimeUniform(t.program)}}var Te=i(713),Ce=i(434),Ee=i(1087);class Ae extends c.b{constructor(e){super(e,Ee.a),this._techniqueConfig=new xe,this.animation=new s}getTechniqueConfig(e,t){return this._techniqueConfig.output=e,this._techniqueConfig.writeDepth=this.parameters.writeDepth,this._techniqueConfig.receiveShadows=this.parameters.receiveShadows,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.transparent=this.parameters.transparent,this._techniqueConfig.useSSR=this.parameters.ssrEnabled,this._techniqueConfig.isDraped=this.parameters.isDraped,this._techniqueConfig.transparencyPassType=t.transparencyPassType,this._techniqueConfig.enableOffset=t.camera.relativeElevation<l.b,this._techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this._techniqueConfig.cullAboveGround=t.cullAboveGround,this._techniqueConfig}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<we;const i=this.animation.advance(e);return this.animation.enabled&&i}intersect(e,t,i,r,a,n,s){Object(Ce.f)(e,t,r,a,n,void 0,s)}requiresSlot(e,t){switch(Object(o.b)(t)){case r.a.Normal:return e===d.a.DRAPED_WATER;case r.a.Color:if(this.parameters.isDraped)return e===d.a.DRAPED_MATERIAL;break;case r.a.Highlight:return e===d.a.OPAQUE_MATERIAL||e===d.a.DRAPED_MATERIAL}let i=d.a.OPAQUE_MATERIAL;return this.parameters.transparent&&(i=this.parameters.writeDepth?d.a.TRANSPARENT_MATERIAL:d.a.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===i}createGLMaterial(e){if(e.output===r.a.Color&&this.parameters.isDraped)return e.output=r.a.Draped,new Se(e);switch(e.output){case r.a.Color:case r.a.Normal:case r.a.Highlight:case r.a.Alpha:return new Se(e)}return null}createBufferWriter(){return new Te.a(Te.d)}}const we=35e3},1104:function(e,t,i){"use strict";i.d(t,"a",(function(){return J}));var r=i(116),a=i(85),n=i(102),s=i(233),o=i(367),c=i(147),l=i(200),d=i(151),h=i(219),u=i(117),p=i(109);function f(e){return(t=e)instanceof Float32Array&&t.length>=16||function(e){return Array.isArray(e)&&e.length>=16}(e);var t}var b=i(118),m=i(495),g=i(210),v=i(753),O=i(562),y=i(856),_=i(335),j=i(411),x=i(768),S=i(278),T=i(139),C=i(604),E=i(434),A=i(513),w=i(827),R=i(79),P=i(301),I=i(731),D=i(420),M=i(857),L=i(356),N=i(623),F=i(747),z=i(501),U=i(388),G=i(404),V=i(419),B=i(163),k=i(382),H=i(445),W=i(389),q=i(94),$=i(355);class X extends G.a{initializeProgram(e){const t=X.shader.get(),i=this.configuration,r=t.build({output:i.output,frontFacePass:i.transparencyPassType===B.i.FrontFace,viewingMode:e.viewingMode,occlusionTestEnabled:i.occlusionTestEnabled,signedDistanceFieldEnabled:i.sdf,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,debugDrawLabelBorder:i.debugDrawLabelBorder,binaryHighlightOcclusionEnabled:i.binaryHighlightOcclusion,screenCenterOffsetUnitsEnabled:i.screenCenterOffsetUnitsEnabled,screenSizePerspectiveEnabled:i.screenSizePerspective,verticalOffsetEnabled:i.verticalOffset,pixelSnappingEnabled:i.pixelSnappingEnabled,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!1,isDraped:i.isDraped,multipassGeometryEnabled:i.multipassGeometryEnabled,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new W.a(e.rctx,r,k.a)}bindPass(e,t){Object(z.b)(this.program,t.camera.projectionMatrix),this.program.setUniform1f("cameraGroundRelative",t.camera.aboveGround?1:-1),this.program.setUniform1f("perDistancePixelRatio",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix),this.program.setUniform1f("polygonOffset",e.shaderPolygonOffset),Object(I.b)(this.program,e,t),Object(F.b)(this.program,e),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio||1),Object(z.e)(this.program,t),this.configuration.output===g.a.Occlusion?(this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(M.a)(this.program,t),Object(L.a)(this.program,t)):(Object(v.c)(this.program,t),Object(w.c)(this.program,e,t.camera.pixelRatio||1),Object(N.b)(this.program,e),this.configuration.occlusionTestEnabled&&this.program.bindTexture(t.hudVisibilityTexture,"hudVisibilityTexture")),this.configuration.output===g.a.Highlight&&Object(D.b)(this.program,t)}bindDraw(e){Object(z.c)(this.program,e),Object(z.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),Object(P.c)(this.program,this.configuration,e),this.program.rebindTextures()}_setPipelineState(e){const t=this.configuration,i=e===B.i.NONE,r=e===B.i.FrontFace,a=q.h.LEQUAL,n=this.configuration.polygonOffsetEnabled&&Y,s=(i||r)&&t.output!==g.a.Highlight?(t.depthEnabled||t.output===g.a.Occlusion)&&$.d:null;return Object($.f)({blending:t.output===g.a.Color||t.output===g.a.Alpha||t.output===g.a.Highlight?i?Z:Object(H.f)(e):null,depthTest:{func:a},depthWrite:s,colorWrite:$.c,polygonOffset:n})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return this.configuration.output===g.a.Occlusion?q.r.POINTS:q.r.TRIANGLES}}X.shader=new U.a(w.a,(()=>i.e(324).then(i.bind(null,1345))));const Y={factor:0,units:-4},Z=Object($.h)(q.b.ONE,q.b.ONE_MINUS_SRC_ALPHA);class Q extends V.a{constructor(){super(...arguments),this.output=g.a.Color,this.occlusionTestEnabled=!0,this.sdf=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.screenSizePerspective=!1,this.screenCenterOffsetUnitsEnabled=v.b.World,this.debugDrawLabelBorder=!1,this.binaryHighlightOcclusion=!0,this.slicePlaneEnabled=!1,this.polygonOffsetEnabled=!1,this.depthEnabled=!0,this.transparencyPassType=B.i.NONE,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.multipassGeometryEnabled=!1,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(R.a)([Object(V.b)({count:g.a.COUNT})],Q.prototype,"output",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"occlusionTestEnabled",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"sdf",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"vvSize",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"vvColor",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"verticalOffset",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"screenSizePerspective",void 0),Object(R.a)([Object(V.b)({count:v.b.COUNT})],Q.prototype,"screenCenterOffsetUnitsEnabled",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"debugDrawLabelBorder",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"binaryHighlightOcclusion",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"slicePlaneEnabled",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"polygonOffsetEnabled",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"depthEnabled",void 0),Object(R.a)([Object(V.b)({count:B.i.COUNT})],Q.prototype,"transparencyPassType",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"pixelSnappingEnabled",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"isDraped",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"multipassGeometryEnabled",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"multipassTerrainEnabled",void 0),Object(R.a)([Object(V.b)()],Q.prototype,"cullAboveGround",void 0);class J extends _.b{constructor(e){super(e,Oe),this.techniqueConfig=new Q}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.verticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits?v.b.Screen:v.b.World,this.techniqueConfig.polygonOffsetEnabled=this.parameters.polygonOffset,this.techniqueConfig.isDraped=this.parameters.isDraped,this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this.techniqueConfig.sdf=this.parameters.textureIsSignedDistanceField,this.techniqueConfig.vvSize=!!this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=!!this.parameters.vvColorEnabled,e===g.a.Color&&(this.techniqueConfig.debugDrawLabelBorder=!!this.parameters.debugDrawLabelBorder),e===g.a.Highlight&&(this.techniqueConfig.binaryHighlightOcclusion=this.parameters.binaryHighlightOcclusion),this.techniqueConfig.depthEnabled=this.parameters.depthEnabled,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.multipassGeometryEnabled=t.multipassGeometryEnabled,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}intersect(e,t,i,r,n,s,o,c,l){Object(a.k)(l)?this._intersectDrapedHudGeometry(e,s,o,c,l):this._intersectHudGeometry(e,t,i,r,o,c)}_intersectDrapedHudGeometry(e,t,i,r,n){const s=e.vertexAttributes.get(T.a.POSITION),o=e.vertexAttributes.get(T.a.SIZE),c=this.parameters,l=Object(w.d)(c);let d=1,h=1;if(Object(a.k)(r)){const e=r(fe);d=e[0],h=e[5]}d*=e.screenToWorldRatio,h*=e.screenToWorldRatio;const u=me*e.screenToWorldRatio;for(let a=0;a<s.data.length/s.size;a++){const r=a*s.size,p=s.data[r],f=s.data[r+1],b=a*o.size;let m;ge[0]=o.data[b]*d,ge[1]=o.data[b+1]*h,c.textureIsSignedDistanceField&&(m=c.outlineSize*e.screenToWorldRatio/2),te(t,p,f,ge,u,m,c,l)&&i(n.dist,n.normal,-1,!0)}}_intersectHudGeometry(e,t,i,r,n,o){if(!r.options.selectionMode||!r.options.hud||Object(A.d)(t))return;const l=this.parameters;let d=1,h=1;if(Object(s.f)(le,i),Object(a.k)(o)){const e=o(fe);d=e[0],h=e[5],function(e){const t=e[0],i=e[1],r=e[2],a=e[3],n=e[4],s=e[5],o=e[6],c=e[7],l=e[8],d=1/Math.sqrt(t*t+i*i+r*r),h=1/Math.sqrt(a*a+n*n+s*s),u=1/Math.sqrt(o*o+c*c+l*l);e[0]=t*d,e[1]=i*d,e[2]=r*d,e[3]=a*h,e[4]=n*h,e[5]=s*h,e[6]=o*u,e[7]=c*u,e[8]=l*u}(le)}const f=e.vertexAttributes.get(T.a.POSITION),b=e.vertexAttributes.get(T.a.SIZE),m=e.vertexAttributes.get(T.a.NORMAL),g=e.vertexAttributes.get(T.a.AUXPOS1);Object(S.a)(f.size>=3);const v=r.point,O=r.camera,y=Object(w.d)(l);d*=O.pixelRatio,h*=O.pixelRatio;const _="screen"===this.parameters.centerOffsetUnits;for(let a=0;a<f.data.length/f.size;a++){const e=a*f.size;Object(u.w)(ae,f.data[e],f.data[e+1],f.data[e+2]),Object(u.q)(ae,ae,i);const t=a*b.size;ge[0]=b.data[t]*d,ge[1]=b.data[t+1]*h,Object(u.q)(ae,ae,O.viewMatrix);const s=a*g.size;if(Object(u.w)(ue,g.data[s+0],g.data[s+1],g.data[s+2]),!_&&(ae[0]+=ue[0],ae[1]+=ue[1],0!==ue[2])){const e=ue[2];Object(u.r)(ue,ae),Object(u.j)(ae,ae,Object(u.e)(ue,ue,e))}const o=a*m.size;if(Object(u.w)(ne,m.data[o],m.data[o+1],m.data[o+2]),this._normalAndViewAngle(ne,le,O,pe),this._applyVerticalOffsetTransformationView(ae,pe,O,ie),O.applyProjection(ae,se),se[0]>-1){let e=Math.floor(se[0])+this.parameters.screenOffset[0],t=Math.floor(se[1])+this.parameters.screenOffset[1];_&&(e+=ue[0],0!==ue[1]&&(t+=Object(x.b)(ue[1],ie.factorAlignment))),Object(x.a)(ge,ie.factor,ge);const i=be*O.pixelRatio;let a;if(l.textureIsSignedDistanceField&&(a=l.outlineSize*O.pixelRatio/2),te(v,e,t,ge,i,a,l,y)){const e=r.ray;if(Object(u.q)(ce,ae,Object(c.a)(he,O.viewMatrix)),se[0]=v[0],se[1]=v[1],O.unprojectFromRenderScreen(se,ae)){const t=Object(p.f)();Object(u.k)(t,e.direction);const i=1/Object(u.p)(t);Object(u.e)(t,t,i),n(Object(u.m)(e.origin,ae)*i,t,-1,!0,1,ce)}}}}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return!1;const r=i.get(T.a.POSITION),a=e.indices.get(T.a.POSITION);return Object(O.b)(r,a,t)}createBufferWriter(){return new _e(this)}_normalAndViewAngle(e,t,i,r){return f(t)&&(t=Object(s.f)(de,t)),Object(u.x)(r.normal,e,t),Object(u.q)(r.normal,r.normal,i.viewInverseTransposeMatrix),r.cosAngle=Object(u.h)(oe,ve),r}_updateScaleInfo(e,t,i){const r=this.parameters;r.screenSizePerspective?Object(x.c)(i,t,r.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),r.screenSizePerspectiveAlignment?Object(x.c)(i,t,r.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)}applyShaderOffsetsView(e,t,i,r,a,n,s){const o=this._normalAndViewAngle(t,i,a,pe);return this._applyVerticalGroundOffsetView(e,o,a,s),this._applyVerticalOffsetTransformationView(s,o,a,n),this._applyPolygonOffsetView(s,o,r[3],a,s),this._applyCenterOffsetView(s,r,s),s}applyShaderOffsetsNDC(e,t,i,r,n){return this._applyCenterOffsetNDC(e,t,i,r),Object(a.k)(n)&&Object(u.k)(n,r),this._applyPolygonOffsetNDC(r,t,i,r),r}_applyPolygonOffsetView(e,t,i,a,n){const s=a.aboveGround?1:-1;let o=Math.sign(i);0===o&&(o=s);const c=s*o;if(this.parameters.shaderPolygonOffset<=0)return Object(u.k)(n,e);const l=Object(r.e)(Math.abs(t.cosAngle),.01,1),d=1-Math.sqrt(1-l*l)/l/a.viewport[2];return Object(u.e)(n,e,c>0?d:1/d),n}_applyVerticalGroundOffsetView(e,t,i,r){const a=Object(u.p)(e),n=i.aboveGround?1:-1,s=.5*i.computeRenderPixelSizeAtDist(a),o=Object(u.e)(ae,t.normal,n*s);return Object(u.f)(r,e,o),r}_applyVerticalOffsetTransformationView(e,t,i,r){const a=this.parameters;if(!a.verticalOffset||!a.verticalOffset.screenLength){if(a.screenSizePerspective||a.screenSizePerspectiveAlignment){const i=Object(u.p)(e);this._updateScaleInfo(r,i,t.cosAngle)}else r.factor.scale=1,r.factorAlignment.scale=1;return e}const n=Object(u.p)(e),s=a.screenSizePerspectiveAlignment||a.screenSizePerspective,o=Object(E.i)(i,n,a.verticalOffset,t.cosAngle,s);return this._updateScaleInfo(r,n,t.cosAngle),Object(u.e)(t.normal,t.normal,o),Object(u.f)(e,e,t.normal)}_applyCenterOffsetView(e,t,i){const r="screen"!==this.parameters.centerOffsetUnits;return i!==e&&Object(u.k)(i,e),r&&(i[0]+=t[0],i[1]+=t[1],t[2]&&(Object(u.r)(ne,i),Object(u.f)(i,i,Object(u.e)(ne,ne,t[2])))),i}_applyCenterOffsetNDC(e,t,i,r){const a="screen"!==this.parameters.centerOffsetUnits;return r!==e&&Object(u.k)(r,e),a||(r[0]+=t[0]/i.fullWidth*2,r[1]+=t[1]/i.fullHeight*2),r}_applyPolygonOffsetNDC(e,t,i,r){const a=this.parameters.shaderPolygonOffset;if(e!==r&&Object(u.k)(r,e),a){const e=i.aboveGround?1:-1,n=e*Math.sign(t[3]);r[2]-=(n||e)*a}return r}requiresSlot(e){if(e===j.a.DRAPED_MATERIAL)return!0;const{drawInSecondSlot:t,occlusionTest:i}=this.parameters;return e===(t?j.a.LABEL_MATERIAL:j.a.HUD_MATERIAL)||i&&e===j.a.OCCLUSION_PIXELS}createGLMaterial(e){return e.output===g.a.Color||e.output===g.a.Alpha?new ee(e):e.output===g.a.Highlight?new K(e):null}calculateRelativeScreenBounds(e,t,i=Object(b.l)()){return function(e,t,i,r=re){Object(d.c)(r,e.anchorPos),r[0]*=-t[0],r[1]*=-t[1],r[0]+=e.screenOffset[0]*i,r[1]+=e.screenOffset[1]*i}(this.parameters,e,t,i),i[2]=i[0]+e[0],i[3]=i[1]+e[1],i}}class K extends y.a{constructor(e){super({...e,...e.material.parameters})}updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this.selectProgram(e)}selectProgram(e){return this.ensureTechnique(X,e)}beginSlot(e){return this.updateParameters(e)}bind(e,t){this.bindTextures(t.program),this.bindTextureScale(t.program),t.bindPass(this._material.parameters,e)}}class ee extends K{_isOcclusionSlot(e){return e.slot===j.a.OCCLUSION_PIXELS&&this._material.parameters.occlusionTest&&(this._output===g.a.Color||this._output===g.a.Alpha)}selectProgram(e){return this.ensureTechnique(X,e,this._isOcclusionSlot(e)?g.a.Occlusion:this._output)}bind(e,t){this._isOcclusionSlot(e)||(this.bindTextures(t.program),this.bindTextureScale(t.program)),t.bindPass(this._material.parameters,e)}}function te(e,t,i,r,a,n,s,o){let c=t-a-(o[0]>0?r[0]*o[0]:0),l=c+r[0]+2*a,d=i-a-(o[1]>0?r[1]*o[1]:0),h=d+r[1]+2*a;if(s.textureIsSignedDistanceField){const e=s.distanceFieldBoundingBox;c+=r[0]*e[0],d+=r[1]*e[1],l-=r[0]*(1-e[2]),h-=r[1]*(1-e[3]),c-=n,l+=n,d-=n,h+=n}return e[0]>c&&e[0]<l&&e[1]>d&&e[1]<h}const ie={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},re=Object(h.a)(),ae=Object(p.f)(),ne=Object(p.f)(),se=Object(n.d)(),oe=Object(p.f)(),ce=Object(p.f)(),le=Object(o.b)(),de=Object(o.b)(),he=Object(l.d)(),ue=Object(p.f)(),pe={normal:oe,cosAngle:0},fe=Object(l.d)(),be=1,me=2,ge=[0,0],ve=Object(p.h)(0,0,1),Oe={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:Object(h.e)(.5,.5),shaderPolygonOffset:1e-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,pixelSnappingEnabled:!0,debugDrawLabelBorder:!1,isDraped:!1,..._.a},ye=Object(m.a)().vec3f(T.a.POSITION).vec3f(T.a.NORMAL).vec2f(T.a.UV0).vec4u8(T.a.COLOR).vec2f(T.a.SIZE).vec4f(T.a.AUXPOS1).vec4f(T.a.AUXPOS2);class _e{constructor(e){this.material=e,this.vertexBufferLayout=ye}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get(T.a.POSITION).length}write(e,t,i,r){Object(C.f)(t.indices.get(T.a.POSITION),t.vertexAttributes.get(T.a.POSITION).data,e.transformation,i.position,r,6),Object(C.e)(t.indices.get(T.a.NORMAL),t.vertexAttributes.get(T.a.NORMAL).data,e.invTranspTransformation,i.normal,r,6);{const e=t.vertexAttributes.get(T.a.UV0).data;let a,n,s,o;if(null==e||e.length<4){const e=this.material.parameters;a=0,n=0,s=e.texCoordScale[0],o=e.texCoordScale[1]}else a=e[0],n=e[1],s=e[2],o=e[3];s=Math.min(1.99999,s+1),o=Math.min(1.99999,o+1);const c=t.indices.get(T.a.POSITION).length,l=i.uv0;let d=r;for(let t=0;t<c;++t)l.set(d,0,a),l.set(d,1,n),d+=1,l.set(d,0,s),l.set(d,1,n),d+=1,l.set(d,0,s),l.set(d,1,o),d+=1,l.set(d,0,s),l.set(d,1,o),d+=1,l.set(d,0,a),l.set(d,1,o),d+=1,l.set(d,0,a),l.set(d,1,n),d+=1}Object(C.c)(t.indices.get(T.a.COLOR),t.vertexAttributes.get(T.a.COLOR).data,4,i.color,r,6);{const e=t.indices.get(T.a.SIZE),a=t.vertexAttributes.get(T.a.SIZE).data,n=e.length,s=i.size;let o=r;for(let t=0;t<n;++t){const i=a[2*e[t]],r=a[2*e[t]+1];for(let e=0;e<6;++e)s.set(o,0,i),s.set(o,1,r),o+=1}}t.indices.get(T.a.AUXPOS1)&&t.vertexAttributes.get(T.a.AUXPOS1)&&Object(C.b)(t.indices.get(T.a.AUXPOS1),t.vertexAttributes.get(T.a.AUXPOS1).data,i.auxpos1,r,6),t.indices.get(T.a.AUXPOS2)&&t.vertexAttributes.get(T.a.AUXPOS2)&&Object(C.b)(t.indices.get(T.a.AUXPOS2),t.vertexAttributes.get(T.a.AUXPOS2).data,i.auxpos2,r,6)}}},1124:function(e,t,i){"use strict";i.d(t,"a",(function(){return u})),i.d(t,"b",(function(){return m})),i.d(t,"c",(function(){return l}));i(82);var r,a,n=i(88),s=i(85),o=i(392),c=i(201);function l(e,t,i){const a=u(e),s=t,c=d(a,s,i);if(a){const t=o.a.deriveUnitFromSR(a,e.spatialReference).heightUnit;if(!i&&t!==a.heightUnit){const e=new n.a("layerview:unmatched-height-unit",`The vertical units of the layer must match the horizontal units (${t})`,{horizontalUnit:t});return new n.a("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:a,error:e})}}if(!("heightModelInfo"in(l=e)&&null!=l.heightModelInfo||null!=l.spatialReference)&&b(l)||c===r.Unsupported)return new n.a("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:a});var l;switch(c){case r.Units:{const e=a.heightUnit||"unknown",t=s.heightUnit||"unknown",i=new n.a("layerview:incompatible-height-unit",`The vertical units of the layer (${e}) must match the vertical units of the scene (${t})`,{layerUnit:e,sceneUnit:t});return new n.a("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:a,sceneHeightModelInfo:s,error:i})}case r.HeightModel:{const e=a.heightModel||"unknown",t=s.heightModel||"unknown",i=new n.a("layerview:incompatible-height-model",`The height model of the layer (${e}) must match the height model of the scene (${t})`,{layerHeightModel:e,sceneHeightModel:t});return new n.a("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:a,sceneHeightModelInfo:s,error:i})}case r.CRS:{const e=a.vertCRS||"unknown",t=s.vertCRS||"unknown",i=new n.a("layerview:incompatible-vertical-datum",`The vertical datum of the layer (${e}) must match the vertical datum of the scene (${t})`,{layerDatum:e,sceneDatum:t});return new n.a("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:a,sceneHeightModelInfo:s,error:i})}}return null}function d(e,t,i){if(!h(e)||!h(t))return r.Unsupported;if(null==e||null==t)return r.Ok;if(!i&&e.heightUnit!==t.heightUnit)return r.Units;if(e.heightModel!==t.heightModel)return r.HeightModel;switch(e.heightModel){case"gravity-related-height":return r.Ok;case"ellipsoidal":return e.vertCRS===t.vertCRS?r.Ok:r.CRS;default:return r.Unsupported}}function h(e){return null==e||null!=e.heightModel&&null!=e.heightUnit}function u(e){const t=e.url&&Object(c.f)(e.url);return null==(e.spatialReference&&e.spatialReference.vcsWkid)&&Object(s.k)(t)&&"ImageServer"===t.serverType||!p(e)||!e.heightModelInfo?b(e)?o.a.deriveUnitFromSR(v,e.spatialReference):null:e.heightModelInfo}function p(e){return"heightModelInfo"in e}function f(e){if("unknown"===e.type||!("capabilities"in e))return!1;switch(e.type){case"csv":case"feature":case"geojson":case"subtype-group":case"ogc-feature":case"wfs":return!0;default:return!1}}function b(e){return f(e)?!!(e.capabilities&&e.capabilities.data&&e.capabilities.data.supportsZ):g(e)}function m(e){return null!=e.layers||g(e)||f(e)||p(e)}function g(e){switch(e.type){case"building-scene":case"elevation":case"integrated-mesh":case"point-cloud":case"scene":case"voxel":return!0;case"analysis":case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"csv":case"geojson":case"feature":case"subtype-group":case"geo-rss":case"graphics":case"group":case"imagery":case"imagery-tile":case"kml":case"map-image":case"map-notes":case"ogc-feature":case"open-street-map":case"route":case"stream":case"tile":case"unknown":case"unsupported":case"vector-tile":case"wcs":case"web-tile":case"wfs":case"wms":case"wmts":case null:return!1}return!1}(a=r||(r={}))[a.Ok=0]="Ok",a[a.Units=1]="Units",a[a.HeightModel=2]="HeightModel",a[a.CRS=3]="CRS",a[a.Unsupported=4]="Unsupported";const v=new o.a({heightModel:"gravity-related-height"})},1136:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i(85),a=i(460),n=i(262),s=i(168);const o={getObjectId:e=>e.objectId,getAttributes:e=>e.attributes,getAttribute:(e,t)=>e.attributes[t],cloneWithGeometry:(e,t)=>new n.a(t,e.attributes,null,e.objectId),getGeometry:e=>e.geometry,getCentroid:(e,t)=>(Object(r.j)(e.centroid)&&(e.centroid=Object(a.a)(new s.a,e.geometry,t.hasZ,t.hasM)),e.centroid)}},1148:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return o})),i.d(t,"c",(function(){return c}));var r=i(85),a=i(895);const n=64,s=n/2,o=s/5;function c(e,t){return Object(r.k)(t)?l(e,"diamond"===(i=t.style)?"kite":i):null;var i}function l(e,t){return e.fromData(t,(()=>Object(a.c)(t,n,s,o)))}},1149:function(e,t,i){"use strict";i.d(t,"a",(function(){return g})),i.d(t,"b",(function(){return m}));var r=i(1148),a=i(210),n=i(301),s=i(945),o=i(622),c=i(410),l=i(356),d=i(397),h=i(464),u=i(500),p=i(126),f=i(297),b=i(139);function m(e){const t=new f.a;return t.include(s.a,e),e.output===a.a.Depth&&t.include(o.a,e),t.fragment.include(u.a),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("nearFar","vec2").add("pixelRatio","float").add("screenSize","vec2").add("inverseProjectionMatrix","mat4"),t.fragment.uniforms.add("tex","sampler2D"),t.attributes.add(b.a.POSITION,"vec3"),t.attributes.add(b.a.UV0,"vec2"),t.attributes.add(b.a.AUXPOS1,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vUV","vec2"),t.varyings.add("vSize","float"),t.varyings.add("linearDepth","float"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(p.a`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}`),t.vertex.code.add(p.a`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= screenSize / posNdc.w;
return posNdc;
}`),t.vertex.code.add(p.a`
    void clipAndTransform(inout vec4 pos, inout vec4 prev) {
      float vnp = nearFar[0] * 0.99;

      if (prev.z > -nearFar[0]) {
        //previous behind ncp
        prev = mix(pos, prev, interp(vnp, pos, prev));
      }

      ${e.multipassTerrainEnabled?"depth = pos.z;":""}
      linearDepth = (-pos.z - nearFar[0]) / (nearFar[1] - nearFar[0]);

      pos = projectAndScale(pos);
      prev = projectAndScale(prev);
    }
  `),t.vertex.code.add(p.a`
    void main(void) {
      float coverage = 1.0;

      // Check for special value of uv0.y which is used by the Renderer when graphics
      // are removed before the VBO is recompacted. If this is the case, then we just
      // project outside of clip space.
      if (uv0.y == 0.0) {
        // Project out of clip space
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      }
      else {
        float lineSize = getSize();
        float lineWidth = max(lineSize, 1.0) * pixelRatio;

        vec4 pos  = view * vec4(position.xyz, 1.0);
        vec4 prev = view * vec4(auxpos1.xyz, 1.0);
        clipAndTransform(pos, prev);

        // normalize vector along line segment
        vec2 segment = pos.xy - prev.xy;
        float segmentLen = length(segment);
        segment = (segmentLen > 0.001) ? segment / segmentLen : vec2(0.0, 0.0);

        // displace according to position in the texture
        vec2 displacementDirU = uv0.x * PERPENDICULAR(segment);
        vec2 displacementDirV = uv0.y * segment;

        vSize = ${p.a.float(r.a/r.b)} * lineWidth;
        pos.xy += displacementDirU * vSize + displacementDirV * vSize;

        // Convert back into NDC
        pos.xy = (pos.xy / screenSize) * pos.w;

        // Convert texture coordinate into [0,1]
        vUV = (uv0 + 1.0) / 2.0;

        vColor = getColor();
        vColor.a *= coverage;

        // transform final position to camera space for slicing
        vpos = (inverseProjectionMatrix * pos).xyz;
        gl_Position = pos;
      }
    }
  `),e.multipassTerrainEnabled&&(t.fragment.include(c.a),t.include(l.b,e)),t.include(n.a,e),t.fragment.uniforms.add("intrinsicColor","vec4"),t.fragment.include(h.a),t.fragment.code.add(p.a`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

    vec4 finalColor = intrinsicColor * vColor;

    // Offset texture coordinate s.t. we sample texel centers
    float texelSize = ${p.a.float(1/r.a)};
    vec2 samplePos = vUV + vec2(0.5, -0.5) * texelSize;

    // Evaluate sdf
    float sdf = rgba2float(texture2D(tex, samplePos)) - 0.5;
    float distance = sdf * vSize;

    // Grow by a halfpixel to make sure the line is fully covered by the cross marker
    // (otherwise there will be a halo if they are different colours)
    distance -= 0.5;

    finalColor.a *= clamp(0.5 - distance, 0.0, 1.0);

    if (finalColor.a < ${p.a.float(d.c)}) {
      discard;
    }

    ${e.output===a.a.Alpha?p.a`gl_FragColor = vec4(finalColor.a);`:""}
    ${e.output===a.a.Color?p.a`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===a.a.Color&&e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${e.output===a.a.Highlight?p.a`gl_FragColor = vec4(1.0);`:""}
    ${e.output===a.a.Depth?p.a`outputDepth(linearDepth);`:""}
  }
  `),t}const g=Object.freeze({__proto__:null,build:m})},1155:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));var r=i(802),a=i(126),n=i(139);function s(e,t){e.attributes.add(n.a.FEATUREVALUE,"vec4"),e.vertex.code.add(a.a`bool isCapVertex() {
return featureValue.w == 1.0;
}`),e.vertex.uniforms.add("size","vec3"),t.vvSize?(e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(a.a`vec2 getSize() {
return size.xy*clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
}`)):e.vertex.code.add(a.a`vec2 getSize(){
return size.xy;
}`),t.vvOpacity?(e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(a.a`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
vec4 applyOpacity(vec4 color) {
float value = featureValue.z;
if (value <= vvOpacityValues[0]) {
return vec4( color.xyz, vvOpacityOpacities[0]);
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
}
}
return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
}`)):e.vertex.code.add(a.a`vec4 applyOpacity(vec4 color){
return color;
}`),t.vvColor?(e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(a.a`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 getColor() {
float value = featureValue.y;
if (value <= vvColorValues[0]) {
return applyOpacity(vvColorColors[0]);
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
}
}
return applyOpacity(vvColorColors[vvColorNumber - 1]);
}`)):e.vertex.code.add(a.a`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),e.include(r.a),e.attributes.add(n.a.PROFILERIGHT,"vec4"),e.attributes.add(n.a.PROFILEUP,"vec4"),e.attributes.add(n.a.PROFILEVERTEXANDNORMAL,"vec4"),e.vertex.code.add(a.a`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),e.vertex.code.add(a.a`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),e.vertex.code.add(a.a`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),e.vertex.code.add(a.a`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}function o(e,t){t.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors)),t.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",t.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",t.vvOpacityOpacities))}},1156:function(e,t,i){"use strict";i.d(t,"a",(function(){return j})),i.d(t,"b",(function(){return _}));var r=i(272),a=i(732),n=i(210),s=i(301),o=i(478),c=i(1155),l=i(622),d=i(420),h=i(410),u=i(773),p=i(832),f=i(356),b=i(689),m=i(950),g=i(625),v=i(464),O=i(126),y=i(297);function _(e){const t=new y.a;return t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("cameraPosition","vec3").add("localOrigin","vec3"),t.varyings.add("vpos","vec3"),t.include(c.a,e),e.output!==n.a.Color&&e.output!==n.a.Alpha||(t.include(o.a,{linearDepth:!1}),e.receiveShadows&&t.include(g.a,e),t.include(a.a,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vcolor","vec4"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(O.a`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${e.output===n.a.Color?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(h.a),t.include(f.b,e)),e.output===n.a.Alpha&&(t.include(s.a,e),t.fragment.uniforms.add("cameraPosition","vec3"),t.fragment.uniforms.add("localOrigin","vec3"),t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(O.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `)),e.output===n.a.Color&&(t.include(s.a,e),t.include(p.a,e),t.include(u.a,e),e.receiveShadows&&t.include(g.a,e),t.include(b.a,e),t.fragment.uniforms.add("cameraPosition","vec3").add("localOrigin","vec3").add("ambient","vec3").add("diffuse","vec3").add("specular","vec3").add("opacity","float"),t.fragment.include(v.a),t.fragment.code.add(O.a`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

        shadingParams.viewDirection = normalize(vpos - cameraPosition);
        shadingParams.normalView = vnormal;
        vec3 normal = shadingNormal(shadingParams);
        float ssao = evaluateAmbientOcclusionInverse();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.viewingMode===r.a.Global?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
        float combinedOpacity = vcolor.a * opacity;
        albedo += 0.25 * specular; // don't completely ignore specular for now

        vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
        gl_FragColor = vec4(shadedColor, combinedOpacity);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output!==n.a.Depth&&e.output!==n.a.Shadow||(t.include(o.a,{linearDepth:!0}),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("depth","float"),t.vertex.code.add(O.a`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),t.include(s.a,e),t.include(l.a,e),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(O.a`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`)),e.output===n.a.Normal&&(t.include(o.a,{linearDepth:!1}),t.include(m.a,e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(O.a`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(s.a,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(O.a`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`)),e.output===n.a.Highlight&&(t.include(o.a,{linearDepth:!1}),t.include(m.a,e),t.vertex.uniforms.add("viewNormal","mat4"),t.varyings.add("vnormal","vec3"),t.vertex.code.add(O.a`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(s.a,e),t.include(d.a),t.fragment.code.add(O.a`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}const j=Object.freeze({__proto__:null,build:_})},1157:function(e,t,i){"use strict";i.d(t,"a",(function(){return y})),i.d(t,"b",(function(){return O}));var r=i(210),a=i(301),n=i(478),s=i(624),o=i(622),c=i(420),l=i(410),d=i(356),h=i(397),u=i(464),p=i(126),f=i(297),b=i(139),m=i(1016);const g=.70710678118,v=g;function O(e){const t=new f.a;e.draped||t.extensions.add("GL_OES_standard_derivatives");const i=e.output===r.a.Depth;t.include(n.a,{linearDepth:i}),t.include(s.a,e),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("view","mat4"),i&&(t.include(o.a,e),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("linearDepth","float")),e.draped?t.vertex.uniforms.add("worldToScreenRatio","float"):(t.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),t.vertex.uniforms.add("cameraPosition","vec3"),t.attributes.add(b.a.BOUNDINGRECT,"mat3")),t.attributes.add(b.a.POSITION,"vec3"),t.attributes.add(b.a.UVMAPSPACE,"vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),e.multipassTerrainEnabled&&t.varyings.add("depth","float");const O=e.style===m.a.ForwardDiagonal||e.style===m.a.BackwardDiagonal||e.style===m.a.DiagonalCross;return O&&t.vertex.code.add(p.a`
      const mat2 rotate45 = mat2(${p.a.float(g)}, ${p.a.float(-v)},
                                 ${p.a.float(v)}, ${p.a.float(g)});
    `),e.draped||(t.vertex.code.add(p.a`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),t.vertex.code.add(p.a`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),t.vertex.code.add(p.a`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${p.a.float(.08715574274)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - cameraPosition);
      }
    `)),t.vertex.code.add(p.a`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${O?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${O?" * rotate45":""};

      ${e.draped?"":p.a`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${p.a.float(e.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `),t.vertex.code.add(p.a`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${i?p.a`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:p.a`transformPosition(proj, view, vpos);`}
    }
  `),t.include(a.a,e),t.fragment.include(u.a),t.fragment.uniforms.add("uColor","vec4"),e.draped&&t.fragment.uniforms.add("texelSize","float"),e.output===r.a.Highlight&&t.include(c.a),e.multipassTerrainEnabled&&(t.fragment.include(l.a),t.include(d.b,e)),e.output!==r.a.Highlight&&(t.fragment.code.add(p.a`
      const float lineWidth = ${p.a.float(e.lineWidth)};
      const float spacing = ${p.a.float(e.patternSpacing)};
      const float spacingINV = ${p.a.float(1/e.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),e.draped||t.fragment.code.add(p.a`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),t.fragment.code.add(p.a`
    void main() {
      discardBySlice(vpos);
      ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${e.attributeColor?"vColor * uColor;":"uColor;"}
      color = highlightSlice(color, vpos);

      ${e.output!==r.a.Highlight?p.a`color.a *= ${function(e){function t(t){return e.draped?p.a`coverage(vuv.${t}, texelSize)`:p.a`sample(vuv.${t})`}switch(e.style){case m.a.ForwardDiagonal:case m.a.Horizontal:return t("y");case m.a.BackwardDiagonal:case m.a.Vertical:return t("x");case m.a.DiagonalCross:case m.a.Cross:return p.a`
        1.0 - (1.0 - ${t("x")}) * (1.0 - ${t("y")})
      `;default:return"0.0"}}(e)};`:""}

      if (color.a < ${p.a.float(h.c)}) {
        discard;
      }

      ${e.output===r.a.Alpha?p.a`gl_FragColor = vec4(color.a);`:""}

      ${e.output===r.a.Color?p.a`gl_FragColor = color; ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${e.output===r.a.Highlight?p.a`outputHighlight();`:""}
      ${e.output===r.a.Depth?p.a`outputDepth(linearDepth);`:""};
    }
  `),t}const y=Object.freeze({__proto__:null,build:O})},1187:function(e,t,i){"use strict";i.d(t,"a",(function(){return B}));var r=i(87),a=i(85),n=i(102),s=i(151),o=i(117),c=i(109),l=i(620),d=i(499),h=i(423),u=i(421),p=i(210),f=i(562),b=i(545),m=i(335),g=i(411),v=i(278),O=i(139),y=i(604),_=i(713),j=i(434),x=i(513),S=i(79),T=i(301),C=i(420),E=i(501),A=i(388),w=i(404),R=i(419),P=i(382),I=i(389),D=i(654),M=i(1011),L=i(94),N=i(355);class F extends w.a{constructor(e,t,i){super(e,t,i),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==p.a.Highlight}initializeProgram(e){const t=F.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:i.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleRequiresClamp:!1,stippleScaleWithLineWidth:!1,stipplePreferContinuous:i.stipplePreferContinuous});return new I.a(e.rctx,r,P.a)}destroy(){super.destroy(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,t){if(Object(E.b)(this.program,t.camera.projectionMatrix),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.stippleEnabled){const{pixelSize:e,sdfNormalizer:i,pixels:r}=Object(a.k)(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};this.program.setUniform1f("stipplePatternSDFNormalizer",i),this.program.setUniform1f("stipplePatternTextureSize",r),this.program.setUniform1f("stipplePatternPixelSize",e),this.program.setUniform1f("stipplePatternPixelSizeInv",1/e),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/t.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/t.camera.perScreenPixelRatio),this.program.setUniform2f("ndcToPixel",t.camera.fullViewport[2]/2,t.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",e.color),this.program.setUniform1f("alphaCoverage",Math.min(1,e.width*t.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const t=Object(a.s)(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}this.configuration.output===p.a.Highlight&&Object(C.b)(this.program,t)}bindDraw(e){Object(E.c)(this.program,e),this.stippleEnabled&&!this.configuration.draped&&Object(E.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),Object(T.c)(this.program,this.configuration,e),this.program.rebindTextures()}initializePipeline(){const e=this.configuration,t=Object(N.g)(L.b.SRC_ALPHA,L.b.ONE,L.b.ONE_MINUS_SRC_ALPHA,L.b.ONE_MINUS_SRC_ALPHA),i=(t,i=null,r=null)=>Object(N.f)({blending:i,depthTest:D.b,depthWrite:r,colorWrite:N.c,stencilWrite:e.sceneHasOcludees?D.h:null,stencilTest:e.sceneHasOcludees?t?D.d:D.c:null});return e.output===p.a.Color?(this._occludeePipelineState=i(!0,e.transparent||this.stippleEnabled?t:null,N.d),i(!1,e.transparent||this.stippleEnabled?t:null,N.d)):i(!1)}get primitiveType(){return L.r.LINES}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}F.shader=new A.a(M.a,(()=>i.e(332).then(i.bind(null,1356))));class z extends R.a{constructor(){super(...arguments),this.output=p.a.Color,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.sceneHasOcludees=!1}}Object(S.a)([Object(R.b)({count:p.a.COUNT})],z.prototype,"output",void 0),Object(S.a)([Object(R.b)()],z.prototype,"slicePlaneEnabled",void 0),Object(S.a)([Object(R.b)()],z.prototype,"vertexColors",void 0),Object(S.a)([Object(R.b)()],z.prototype,"transparent",void 0),Object(S.a)([Object(R.b)()],z.prototype,"draped",void 0),Object(S.a)([Object(R.b)()],z.prototype,"stippleEnabled",void 0),Object(S.a)([Object(R.b)()],z.prototype,"stippleOffColorEnabled",void 0),Object(S.a)([Object(R.b)()],z.prototype,"stipplePreferContinuous",void 0),Object(S.a)([Object(R.b)()],z.prototype,"sceneHasOcludees",void 0);const U=r.a.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");var G,V;(V=G||(G={}))[V.START=0]="START",V[V.END=1]="END";class B extends m.b{constructor(e){super(e,W),this._techniqueConfig=new z}getTechniqueConfig(e,t){this._techniqueConfig.output=e,this._techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this._techniqueConfig.vertexColors=this.parameters.vertexColors,this._techniqueConfig.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._techniqueConfig.draped=t.slot===g.a.DRAPED_MATERIAL;const i=Object(a.k)(this.parameters.stipplePattern);return this._techniqueConfig.stippleEnabled=i,this._techniqueConfig.stippleOffColorEnabled=i&&Object(a.k)(this.parameters.stippleOffColor),this._techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this._techniqueConfig.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._techniqueConfig}getPassParameters(){return this.parameters}intersect(e,t,i,r,n,s,o,c,l){Object(a.k)(l)?Object(j.e)(e,r,l,s,1,o):this._intersectLineGeometry(e,t,i,r,o)}_intersectLineGeometry(e,t,i,r,a){if(!r.options.selectionMode||Object(x.d)(t))return;if(!Object(v.g)(i))return void U.error("intersection assumes a translation-only matrix");const n=e.vertexAttributes.get(O.a.POSITION).data,c=r.camera,u=ie;Object(s.c)(u,r.point);Object(o.w)(re[0],u[0]-2,u[1]+2,0),Object(o.w)(re[1],u[0]+2,u[1]+2,0),Object(o.w)(re[2],u[0]+2,u[1]-2,0),Object(o.w)(re[3],u[0]-2,u[1]-2,0);for(let s=0;s<4;s++)if(!c.unprojectFromRenderScreen(re[s],ae[s]))return;Object(h.f)(c.eye,ae[0],ae[1],ne),Object(h.f)(c.eye,ae[1],ae[2],se),Object(h.f)(c.eye,ae[2],ae[3],oe),Object(h.f)(c.eye,ae[3],ae[0],ce);let p=Number.MAX_VALUE,f=0;for(let s=0;s<n.length-5;s+=3){if(q[0]=n[s]+i[12],q[1]=n[s+1]+i[13],q[2]=n[s+2]+i[14],$[0]=n[s+3]+i[12],$[1]=n[s+4]+i[13],$[2]=n[s+5]+i[14],Object(h.t)(ne,q)<0&&Object(h.t)(ne,$)<0||Object(h.t)(se,q)<0&&Object(h.t)(se,$)<0||Object(h.t)(oe,q)<0&&Object(h.t)(oe,$)<0||Object(h.t)(ce,q)<0&&Object(h.t)(ce,$)<0)continue;if(c.projectToRenderScreen(q,Z),c.projectToRenderScreen($,Q),Z[2]<0&&Q[2]>0){Object(o.j)(X,q,$);const e=c.frustum,t=-Object(h.t)(e[l.a.NEAR],q)/Object(o.h)(X,Object(h.q)(e[l.a.NEAR]));Object(o.e)(X,X,t),Object(o.f)(q,q,X),c.projectToRenderScreen(q,Z)}else if(Z[2]>0&&Q[2]<0){Object(o.j)(X,$,q);const e=c.frustum,t=-Object(h.t)(e[l.a.NEAR],$)/Object(o.h)(X,Object(h.q)(e[l.a.NEAR]));Object(o.e)(X,X,t),Object(o.f)($,$,X),c.projectToRenderScreen($,Q)}else if(Z[2]<0&&Q[2]<0)continue;Z[2]=0,Q[2]=0;const e=Object(d.e)(Object(d.f)(Z,Q,ee),u);e<p&&(p=e,Object(o.k)(J,q),Object(o.k)(K,$),f=s/3)}const b=r.rayBegin,m=r.rayEnd;if(p<4){let e=Number.MAX_VALUE;if(Object(d.a)(Object(d.f)(J,K,ee),Object(d.f)(b,m,te),Y)){Object(o.j)(Y,Y,b);const t=Object(o.p)(Y);Object(o.e)(Y,Y,1/t),e=t/Object(o.m)(b,m)}a(e,Y,f,!1)}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return!1;const r=i.get(O.a.POSITION);return Object(f.a)(r,null,!1,t)}requiresSlot(e){return e===g.a.OPAQUE_MATERIAL||e===g.a.DRAPED_MATERIAL}createGLMaterial(e){return e.output===p.a.Color||e.output===p.a.Highlight?new k(e):null}createBufferWriter(){const e=this.parameters.vertexColors?_.b:_.c;return Object(a.j)(this.parameters.stipplePattern)?new _.a(e):new H(e.clone().vec3f(O.a.AUXPOS1).vec2f(O.a.UV0))}}class k extends b.a{updateParameters(e){return this.ensureTechnique(F,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output===p.a.Color&&this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}class H{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(O.a.POSITION).length}write(e,t,i,r){Object(y.d)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r),this._writeAuxpos1(e,t,i,r),this._writeUV0(e,t,i,r)}_writeAuxpos1(e,t,i,r){const a=i.getField(O.a.AUXPOS1,u.u),n=t.indices.get(O.a.POSITION),s=t.vertexAttributes.get(O.a.POSITION).data,o=e.transformation,c=a.typedBufferStride,l=a.typedBuffer;r*=c;for(let d=0;d<n.length-1;d+=2)for(const e of[1,0]){const t=3*n[d+e],i=s[t],a=s[t+1],h=s[t+2],u=o[0]*i+o[4]*a+o[8]*h+o[12],p=o[1]*i+o[5]*a+o[9]*h+o[13],f=o[2]*i+o[6]*a+o[10]*h+o[14];l[r]=u,l[r+1]=p,l[r+2]=f,r+=c}}_writeUV0(e,t,i,r){var a;const n=i.getField(O.a.UV0,u.m),s=t.indices.get(O.a.POSITION),c=t.vertexAttributes.get(O.a.POSITION).data,l=null==(a=t.vertexAttributes.get(O.a.DISTANCETOSTART))?void 0:a.data,d=e.transformation,h=n.typedBufferStride,p=n.typedBuffer;let f=0;p[r*=h]=G.START,p[r+1]=f,r+=h;const b=3*s[0],m=Object(o.w)(q,c[b],c[b+1],c[b+2]);d&&Object(o.q)(m,m,d);const g=$,v=s.length-1;let y=1;const _=l?(e,t,i)=>f=l[i]:(e,t,i)=>f+=Object(o.m)(e,t);for(let u=1;u<v;u+=2){const e=3*s[u];Object(o.w)(g,c[e],c[e+1],c[e+2]),d&&Object(o.q)(g,g,d),_(m,g,y++);for(let t=0;t<2;++t)p[r]=1-t,p[r+1]=f,r+=h;Object(o.k)(m,g)}const j=3*s[v];Object(o.w)(g,c[j],c[j+1],c[j+2]),d&&Object(o.q)(g,g,d),_(m,g,y),p[r]=G.END,p[r+1]=f}}const W={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleOffColor:null,stipplePreferContinuous:!0,sceneHasOcludees:!1,...m.a},q=Object(c.f)(),$=Object(c.f)(),X=Object(c.f)(),Y=Object(c.f)(),Z=Object(n.d)(),Q=Object(n.d)(),J=Object(c.f)(),K=Object(c.f)(),ee=Object(d.d)(),te=Object(d.d)(),ie=Object(c.f)(),re=[Object(n.d)(),Object(n.d)(),Object(n.d)(),Object(n.d)()],ae=[Object(c.f)(),Object(c.f)(),Object(c.f)(),Object(c.f)()],ne=Object(h.d)(),se=Object(h.d)(),oe=Object(h.d)(),ce=Object(h.d)()},1188:function(e,t,i){"use strict";i.r(t),i.d(t,"fetch",(function(){return W})),i.d(t,"gltfToEngineResources",(function(){return $})),i.d(t,"parseUrl",(function(){return q}));var r=i(487),a=i(85),n=i(233),s=i(367),o=i(147),c=i(200),l=i(117),d=i(109),h=i(223),u=i(421),p=i(744),f=i(1150),b=i(1182),m=i(1152),g=i(1179),v=i(1153),O=i(103),y=i(298),_=i(88),j=i(87),x=i(91),S=i(719),T=i(819),C=i(163),E=i(595),A=i(750),w=i(804),R=i(94);const P=j.a.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function I(e,t){const i=await async function(e,t){const i=Object(a.k)(t)&&t.streamDataRequester;if(i)return async function(e,t,i){const r=await Object(y.c)(t.request(e,"json",i));if(!0===r.ok)return r.value;Object(x.s)(r.error),D(r.error.details.url)}(e,i,t);const r=await Object(y.c)(Object(O.default)(e,Object(a.s)(t)));if(!0===r.ok)return r.value.data;Object(x.s)(r.error),D(r.error)}(e,t);return{resource:i,textures:await N(i.textureDefinitions,t)}}function D(e){throw new _.a("",`Request for object resource failed: ${e}`)}function M(e){const t=e.params,i=t.topology;let r=!0;switch(t.vertexAttributes||(P.warn("Geometry must specify vertex attributes"),r=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const e=t.faces;if(e){if(t.vertexAttributes)for(const i in t.vertexAttributes){const t=e[i];t&&t.values?(null!=t.valueType&&"UInt32"!==t.valueType&&(P.warn(`Unsupported indexed geometry indices type '${t.valueType}', only UInt32 is currently supported`),r=!1),null!=t.valuesPerElement&&1!==t.valuesPerElement&&(P.warn(`Unsupported indexed geometry values per element '${t.valuesPerElement}', only 1 is currently supported`),r=!1)):(P.warn(`Indexed geometry does not specify face indices for '${i}' attribute`),r=!1)}}else P.warn("Indexed geometries must specify faces"),r=!1;break}default:P.warn(`Unsupported topology '${i}'`),r=!1}e.params.material||(P.warn("Geometry requires material"),r=!1);const a=e.params.vertexAttributes;for(const n in a)a[n].values||(P.warn("Geometries with externally defined attributes are not yet supported"),r=!1);return r}function L(e){const t=Object(h.h)();return e.forEach((e=>{const i=e.boundingInfo;Object(a.k)(i)&&(Object(h.n)(t,i.getBBMin()),Object(h.n)(t,i.getBBMax()))})),t}async function N(e,t){const i=[];for(const s in e){const r=e[s],n=r.images[0].data;if(!n){P.warn("Externally referenced texture data is not yet supported");continue}const o=r.encoding+";base64,"+n,c="/textureDefinitions/"+s,l="rgba"===r.channels?r.alphaChannelUsage||"transparency":"none",d={noUnpackFlip:!0,wrap:{s:R.B.REPEAT,t:R.B.REPEAT},preMultiplyAlpha:F(l)!==C.a.Opaque},h=Object(a.k)(t)&&t.disableTextures?Promise.resolve(null):Object(T.a)(o,t);i.push(h.then((e=>({refId:c,image:e,params:d,alphaChannelUsage:l}))))}const r=await Promise.all(i),n={};for(const a of r)n[a.refId]=a;return n}function F(e){switch(e){case"mask":return C.a.Mask;case"maskAndTransparency":return C.a.MaskBlend;case"none":return C.a.Opaque;default:return C.a.Blend}}function z(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const U=new S.a(1,2,"wosr");var G=i(139),V=i(1154),B=i(1014),k=i(1015),H=i(883);async function W(e,t){const i=q(Object(r.a)(e));if("wosr"===i.fileType){const e=await(t.cache?t.cache.loadWOSR(i.url,t):I(i.url,t)),r=function(e,t){const i=[],r=[],n=[],s=[],o=e.resource,c=S.a.parse(o.version||"1.0","wosr");U.validate(c);const l=o.model.name,h=o.model.geometries,u=o.materialDefinitions,p=e.textures;let f=0;const b=new Map;for(let m=0;m<h.length;m++){const e=h[m];if(!M(e))continue;const o=z(e),c=e.params.vertexAttributes,l=[];for(const t in c){const e=c[t],i=e.values;l.push([t,{data:i,size:e.valuesPerElement,exclusive:!0}])}const g=[];if("PerAttributeArray"!==e.params.topology){const t=e.params.faces;for(const e in t)g.push([e,new Uint32Array(t[e].values)])}const v=p&&p[o.texture];if(v&&!b.has(o.texture)){const{image:e,params:t}=v,i=new A.a(e,t);s.push(i),b.set(o.texture,i)}const O=b.get(o.texture),y=O?O.id:void 0;let _=n[o.material]?n[o.material][o.texture]:null;if(!_){const e=u[o.material.substring(o.material.lastIndexOf("/")+1)].params;1===e.transparency&&(e.transparency=0);const i=v&&v.alphaChannelUsage,r=e.transparency>0||"transparency"===i||"maskAndTransparency"===i,s=v?F(v.alphaChannelUsage):void 0,c={ambient:Object(d.g)(e.diffuse),diffuse:Object(d.g)(e.diffuse),opacity:1-(e.transparency||0),transparent:r,textureAlphaMode:s,textureAlphaCutoff:.33,textureId:y,initTextureTransparent:!0,doubleSided:!0,cullFace:C.b.None,colorMixMode:e.externalColorMixMode||"tint",textureAlphaPremultiplied:!!v&&!!v.params.preMultiplyAlpha};Object(a.k)(t)&&t.materialParamsMixin&&Object.assign(c,t.materialParamsMixin),_=new w.a(c),n[o.material]||(n[o.material]={}),n[o.material][o.texture]=_}r.push(_);const j=new E.a(l,g);f+=g.position?g.position.length:0,i.push(j)}return{name:l,stageResources:{textures:s,materials:r,geometries:i},pivotOffset:o.model.pivotOffset,boundingBox:L(i),numberOfVertices:f,lodThreshold:null}}(e,t);return{lods:[r],referenceBoundingBox:r.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:e.remove}}const n=await(t.cache?t.cache.loadGLTF(i.url,t,t.usePBR):Object(g.a)(new m.a(t.streamDataRequester),i.url,t,t.usePBR)),s=Object(a.i)(n.model.meta,"ESRI_proxyEllipsoid");n.meta.isEsriSymbolResource&&Object(a.k)(s)&&-1!==n.meta.uri.indexOf("/RealisticTrees/")&&function(e,t){for(let i=0;i<e.model.lods.length;++i){const r=e.model.lods[i];e.customMeta.esriTreeRendering=!0;for(const n of r.parts){const r=n.attributes.normal;if(Object(a.j)(r))return;const s=n.attributes.position,h=s.count,p=Object(d.f)(),f=Object(d.f)(),m=Object(d.f)(),g=Object(b.a)(u.J,h),v=Object(b.a)(u.u,h),O=Object(o.a)(Object(c.d)(),n.transform);for(let a=0;a<h;a++){s.getVec(a,f),r.getVec(a,p),Object(l.q)(f,f,n.transform),Object(l.j)(m,f,t.center),Object(l.b)(m,m,t.radius);const o=m[2],c=Object(l.p)(m),d=Math.min(.45+.55*c*c,1);Object(l.b)(m,m,t.radius),Object(l.q)(m,m,O),Object(l.r)(m,m),i+1!==e.model.lods.length&&e.model.lods.length>1&&Object(l.i)(m,m,p,o>-1?.2:Math.min(-4*o-3.8,1)),v.setVec(a,m),g.set(a,0,255*d),g.set(a,1,255*d),g.set(a,2,255*d),g.set(a,3,255)}n.attributes.normal=v,n.attributes.color=g}}}(n,s);const h=n.meta.isEsriSymbolResource?{usePBR:t.usePBR,isSchematic:!1,treeRendering:n.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:t.usePBR,isSchematic:!1,mrrFactors:[0,1,.5]},p={...t.materialParamsMixin,treeRendering:n.customMeta.esriTreeRendering};if(null!=i.specifiedLodIndex){const e=$(n,h,p,i.specifiedLodIndex);let t=e[0].boundingBox;return 0!==i.specifiedLodIndex&&(t=$(n,h,p,0)[0].boundingBox),{lods:e,referenceBoundingBox:t,isEsriSymbolResource:n.meta.isEsriSymbolResource,isWosr:!1,remove:n.remove}}const f=$(n,h,p);return{lods:f,referenceBoundingBox:f[0].boundingBox,isEsriSymbolResource:n.meta.isEsriSymbolResource,isWosr:!1,remove:n.remove}}function q(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function $(e,t,i,r){const o=e.model,c=Object(s.b)(),l=new Array,d=new Map,m=new Map;return o.lods.forEach(((e,s)=>{if(void 0!==r&&s!==r)return;const g={name:e.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:Object(a.k)(e.lodThreshold)?e.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:Object(h.h)()};l.push(g),e.parts.forEach((e=>{const r=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),s=o.materials.get(e.material),l=Object(a.k)(e.attributes.texCoord0),O=Object(a.k)(e.attributes.normal),y=function(e){switch(e){case"BLEND":return C.a.Blend;case"MASK":return C.a.Mask;case"OPAQUE":case null:case void 0:return C.a.Opaque}}(s.alphaMode);if(!d.has(r)){if(l){if(Object(a.k)(s.textureColor)&&!m.has(s.textureColor)){const e=o.textures.get(s.textureColor),t={...e.parameters,preMultiplyAlpha:y!==C.a.Opaque};m.set(s.textureColor,new A.a(e.data,t))}if(Object(a.k)(s.textureNormal)&&!m.has(s.textureNormal)){const e=o.textures.get(s.textureNormal);m.set(s.textureNormal,new A.a(e.data,e.parameters))}if(Object(a.k)(s.textureOcclusion)&&!m.has(s.textureOcclusion)){const e=o.textures.get(s.textureOcclusion);m.set(s.textureOcclusion,new A.a(e.data,e.parameters))}if(Object(a.k)(s.textureEmissive)&&!m.has(s.textureEmissive)){const e=o.textures.get(s.textureEmissive);m.set(s.textureEmissive,new A.a(e.data,e.parameters))}if(Object(a.k)(s.textureMetallicRoughness)&&!m.has(s.textureMetallicRoughness)){const e=o.textures.get(s.textureMetallicRoughness);m.set(s.textureMetallicRoughness,new A.a(e.data,e.parameters))}}const n=s.color[0]**(1/V.a),c=s.color[1]**(1/V.a),h=s.color[2]**(1/V.a),u=s.emissiveFactor[0]**(1/V.a),p=s.emissiveFactor[1]**(1/V.a),f=s.emissiveFactor[2]**(1/V.a),b=Object(a.k)(s.textureColor)&&l?m.get(s.textureColor):null;d.set(r,new w.a({...t,transparent:y===C.a.Blend,customDepthTest:C.c.Lequal,textureAlphaMode:y,textureAlphaCutoff:s.alphaCutoff,diffuse:[n,c,h],ambient:[n,c,h],opacity:s.opacity,doubleSided:s.doubleSided,doubleSidedType:"winding-order",cullFace:s.doubleSided?C.b.None:C.b.Back,vertexColors:!!e.attributes.color,vertexTangents:!!e.attributes.tangent,normals:O?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,fillLightsEnabled:!0,textureId:Object(a.k)(b)?b.id:void 0,colorMixMode:s.colorMixMode,normalTextureId:Object(a.k)(s.textureNormal)&&l?m.get(s.textureNormal).id:void 0,textureAlphaPremultiplied:Object(a.k)(b)&&!!b.params.preMultiplyAlpha,occlusionTextureId:Object(a.k)(s.textureOcclusion)&&l?m.get(s.textureOcclusion).id:void 0,emissiveTextureId:Object(a.k)(s.textureEmissive)&&l?m.get(s.textureEmissive).id:void 0,metallicRoughnessTextureId:Object(a.k)(s.textureMetallicRoughness)&&l?m.get(s.textureMetallicRoughness).id:void 0,emissiveFactor:[u,p,f],mrrFactors:[s.metallicFactor,s.roughnessFactor,t.mrrFactors[2]],isSchematic:!1,...i}))}const _=function(e,t){switch(t){case R.r.TRIANGLES:return Object(v.c)(e);case R.r.TRIANGLE_STRIP:return Object(v.b)(e);case R.r.TRIANGLE_FAN:return Object(v.a)(e)}}(e.indices||e.attributes.position.count,e.primitiveType),j=e.attributes.position.count,x=Object(b.a)(u.u,j);Object(p.e)(x,e.attributes.position,e.transform);const S=[[G.a.POSITION,{data:x.typedBuffer,size:x.elementCount,exclusive:!0}]],T=[[G.a.POSITION,_]];if(Object(a.k)(e.attributes.normal)){const t=Object(b.a)(u.u,j);Object(n.a)(c,e.transform),Object(p.a)(t,e.attributes.normal,c),S.push([G.a.NORMAL,{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),T.push([G.a.NORMAL,_])}if(Object(a.k)(e.attributes.tangent)){const t=Object(b.a)(u.C,j);Object(n.a)(c,e.transform),Object(f.c)(t,e.attributes.tangent,c),S.push([G.a.TANGENT,{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),T.push([G.a.TANGENT,_])}if(Object(a.k)(e.attributes.texCoord0)){const t=Object(b.a)(u.m,j);Object(B.b)(t,e.attributes.texCoord0),S.push([G.a.UV0,{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),T.push([G.a.UV0,_])}if(Object(a.k)(e.attributes.color)){const t=Object(b.a)(u.J,j);if(4===e.attributes.color.elementCount)e.attributes.color instanceof u.C?Object(f.b)(t,e.attributes.color,255):e.attributes.color instanceof u.J?Object(k.a)(t,e.attributes.color):e.attributes.color instanceof u.H&&Object(f.b)(t,e.attributes.color,1/256);else{Object(k.b)(t,255,255,255,255);const i=new u.B(t.buffer,0,4);e.attributes.color instanceof u.u?Object(p.d)(i,e.attributes.color,255):e.attributes.color instanceof u.B?Object(H.a)(i,e.attributes.color):e.attributes.color instanceof u.z&&Object(p.d)(i,e.attributes.color,1/256)}S.push([G.a.COLOR,{data:t.typedBuffer,size:t.elementCount,exclusive:!0}]),T.push([G.a.COLOR,_])}const P=new E.a(S,T);g.stageResources.geometries.push(P),g.stageResources.materials.push(d.get(r)),l&&(Object(a.k)(s.textureColor)&&g.stageResources.textures.push(m.get(s.textureColor)),Object(a.k)(s.textureNormal)&&g.stageResources.textures.push(m.get(s.textureNormal)),Object(a.k)(s.textureOcclusion)&&g.stageResources.textures.push(m.get(s.textureOcclusion)),Object(a.k)(s.textureEmissive)&&g.stageResources.textures.push(m.get(s.textureEmissive)),Object(a.k)(s.textureMetallicRoughness)&&g.stageResources.textures.push(m.get(s.textureMetallicRoughness))),g.numberOfVertices+=j;const I=P.boundingInfo;Object(a.k)(I)&&(Object(h.n)(g.boundingBox,I.getBBMin()),Object(h.n)(g.boundingBox,I.getBBMax()))}))})),l}},1213:function(e,t,i){"use strict";i.r(t),i.d(t,"getGeometryServiceURL",(function(){return c})),i.d(t,"projectGeometry",(function(){return l}));var r=i(153),a=i(88),n=i(181),s=i(718),o=i(643);async function c(e=null,t){var i,s;if(r.a.geometryServiceUrl)return r.a.geometryServiceUrl;if(!e)throw new a.a("internal:geometry-service-url-not-configured");let o;o="portal"in e?e.portal||n.a.getDefault():e,await o.load({signal:t});const c=null==(i=o.helperServices)||null==(s=i.geometry)?void 0:s.url;if(!c)throw new a.a("internal:geometry-service-url-not-configured");return c}async function l(e,t,i=null,r){const n=await c(i,r),l=new o.a;l.geometries=[e],l.outSpatialReference=t;const d=await Object(s.a)(n,l,{signal:r});if(d&&Array.isArray(d)&&1===d.length)return d[0];throw new a.a("internal:geometry-service-projection-failed")}},126:function(e,t,i){"use strict";function r(e,...t){let i="";for(let r=0;r<t.length;r++)i+=e[r]+t[r];return i+=e[e.length-1],i}i.d(t,"a",(function(){return r})),function(e){e.int=function(e){return Math.round(e).toString()},e.float=function(e){return e.toPrecision(8)}}(r||(r={}))},1364:function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return Zl}));var r=i(79),a=i(85),n=i(144),s=i(81),o=i(84),c=i(82),l=(i(83),i(80)),d=i(1002),h=i(136),u=i(1124);const p=e=>{let t=class extends e{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(e){super.postscript(e),Object(u.b)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){const e=Object(h.l)(this.view.defaultsFromMap,"heightModelInfoReady");this.handles.add(e),await e;const t=Object(u.c)(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(t)throw t}canResume(){const e=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!e||!e.minScale||!e.maxScale||e.minScale>=e.maxScale)}getSuspendInfo(){const e=super.getSuspendInfo(),t=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return t&&t.minScale&&t.maxScale&&t.minScale<t.maxScale&&(e.outsideScaleRange=!0),e}};return Object(r.a)([Object(s.b)()],t.prototype,"view",void 0),Object(r.a)([Object(s.b)()],t.prototype,"slicePlaneEnabled",void 0),t=Object(r.a)([Object(l.a)("esri.views.3d.layers.LayerView3D")],t),t};var f=i(125),b=i(111),m=i(134),g=i(183),v=i(91),O=i(269),y=i(207),_=i(638),j=i(105),x=i(245);function S(e,t){if(!e||e.symbol)return null;const i=t&&t.renderer;return e&&Object(a.k)(i)&&i.getObservationRenderer?i.getObservationRenderer(e):i}function T(e,t){const i=S(e,t),r=function(e,t){if(Object(a.k)(e.symbol))return e.symbol;const i=S(e,t);return Object(a.k)(i)&&"dot-density"!==i.type?i.getSymbol(e,t):null}(e,t);if(Object(a.j)(r))return null;const n={renderer:i,symbol:r};if(Object(a.j)(i)||!("visualVariables"in i)||!i.visualVariables)return n;const s=Object(x.getVisualVariableValues)(i,e,t),o=["proportional","proportional","proportional"];for(const{variable:a,value:c}of s)switch(a.type){case"color":n.color=c.toRgba();break;case"size":if("outline"===a.target)n.outlineSize=c;else{const e=a.axis,t=a.useSymbolValue?"symbol-value":c;switch(e){case"width":o[0]=t;break;case"depth":o[1]=t;break;case"height":o[2]=t;break;case"width-and-depth":o[0]=o[1]=t;break;default:o[0]=o[1]=o[2]=t}}break;case"opacity":n.opacity=c;break;case"rotation":switch(a.axis){case"tilt":n.tilt=c;break;case"roll":n.roll=c;break;default:n.heading=c}}return"proportional"===o[0]&&"proportional"===o[1]&&"proportional"===o[2]||(n.size=o),n}async function C(e,t){const i=S(e,t),r=await async function(e,t){if(Object(a.k)(e.symbol))return e.symbol;const i=S(e,t);return Object(a.k)(i)&&i.getSymbolAsync(e,{...t,abortOptions:{signal:t.signal}})}(e,t);if(!r)return null;const n={renderer:i,symbol:r};if(!i||!("visualVariables"in i)||!i.visualVariables)return n;const s=Object(x.getVisualVariableValues)(i,e,t),o=["proportional","proportional","proportional"];for(const{variable:a,value:c}of s)if("color"===a.type)n.color=j.a.toUnitRGBA(c);else if("size"===a.type)if("outline"===a.target)n.outlineSize=c;else{const e=a.axis,t=a.useSymbolValue?"symbol-value":c;"width"===e?o[0]=t:"depth"===e?o[1]=t:"height"===e?o[2]=t:o[0]=o[1]="width-and-depth"===e?t:o[2]=t}else"opacity"===a.type?n.opacity=c:"rotation"===a.type&&"tilt"===a.axis?n.tilt=c:"rotation"===a.type&&"roll"===a.axis?n.roll=c:"rotation"===a.type&&(n.heading=c);return(isFinite(o[0])||isFinite(o[1])||isFinite(o[2]))&&(n.size=o),n}var E=i(145),A=i(1004),w=(i(99),i(217),i(250),i(253),i(251),i(120),i(248),i(225)),R=(i(319),i(115),i(100)),P=i(88),I=i(124),D=i(87),M=i(424),L=i(212),N=i(234),F=i(117),z=i(109),U=i(187),G=i(223),V=i(118),B=i(463),k=i(984),H=i(130),W=i(961),q=i(467),$=i(1069),X=i(456),Y=i(303),Z=i(1203),Q=i(320),J=i(289);const K=X.a.fromSimpleMarkerSymbol(Q.a),ee=q.a.fromSimpleLineSymbol(Q.c),te=Y.a.fromSimpleFillSymbol(Q.b),ie=new $.a({symbolLayers:[new W.a({material:{color:J.a},edges:new Z.a({size:"1px",color:J.b})})]});function re(e){if(Object(a.j)(e))return null;switch(e.type){case"mesh":return ie;case"point":case"multipoint":return K;case"polyline":return ee;case"polygon":case"extent":return te}return null}var ae,ne,se,oe=i(306),ce=i(514);i(216);class le{constructor(e,t){this.spatialReference=e,this.view=t}getElevation(e,t,i){return this.view.elevationProvider.getElevation(e,t,0,this.spatialReference,i)}async queryElevation(e,t,i,r,a){return this.view.elevationProvider.queryElevation(e,t,0,this.spatialReference,a,i,r)}}(se=ae||(ae={}))[se.GRAPHIC=0]="GRAPHIC",se[se.LABEL=1]="LABEL",se[se._COUNT=2]="_COUNT",function(e){e[e.USER_SETTING=0]="USER_SETTING",e[e.SCALE_RANGE=1]="SCALE_RANGE",e[e.FILTER=2]="FILTER",e[e.DECONFLICTION=3]="DECONFLICTION",e[e._COUNT=4]="_COUNT"}(ne||(ne={}));var de=i(855),he=i(138),ue=i(262),pe=i(168),fe=i(1136);let be=class extends R.a{constructor(e){super(e),this.events=new he.a,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.spatialReference=null,this.featureAdapter={getAttribute:(e,t)=>"graphic"in e?e.graphic.attributes[t]:fe.a.getAttribute(e,t),getAttributes:e=>"graphic"in e?e.graphic.attributes:fe.a.getAttributes(e),getObjectId:e=>"graphic"in e?Object(B.e)(e.graphic,this.objectIdField):fe.a.getObjectId(e),getGeometry:e=>"graphic"in e?e.getAsOptimizedGeometry(this.hasZ,this.hasM):fe.a.getGeometry(e),getCentroid:(e,t)=>{if("graphic"in e){let i=null;Object(a.k)(e.centroid)?i=e.centroid:"point"===e.graphic.geometry.type&&Object(U.n)(e.graphic.geometry,me,this.spatialReference)&&(i=me);const r=new Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return Object(a.j)(i)?(r[0]=0,r[1]=0,r[2]=0,r[3]=0):(r[0]=i.x,r[1]=i.y,t.hasZ&&(r[2]=i.hasZ?i.z:0),t.hasM&&(r[t.hasZ?3:2]=i.hasM?i.m:0)),new pe.a([],r)}return fe.a.getCentroid(e,t)},cloneWithGeometry:(e,t)=>"graphic"in e?new ue.a(t,this.featureAdapter.getAttributes(e),null,this.featureAdapter.getObjectId(e)):fe.a.cloneWithGeometry(e,t)}}forEach(e){this.forAllGraphics((t=>{e(t)}))}forEachInBounds(e,t){this.getSpatialIndex().forEachInBounds(e,t)}forEachBounds(e,t,i){const r=this.getSpatialIndex();for(const n of e){const e=this.featureAdapter.getObjectId(n);Object(a.k)(r.getBounds(e,i))&&t(i)}}};Object(r.a)([Object(s.b)({constructOnly:!0})],be.prototype,"getSpatialIndex",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],be.prototype,"forAllGraphics",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],be.prototype,"hasZ",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],be.prototype,"hasM",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],be.prototype,"objectIdField",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],be.prototype,"spatialReference",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],be.prototype,"featureSpatialReference",void 0),be=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],be);const me={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null},ge=be;class ve{constructor(e,t,i){this.graphic=e,this.renderingInfo=t,this.layer=i}}class Oe{constructor(e){this.schedule=e,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.isAsync=!1}}var ye=i(298),_e=i(974),je=i(102),xe=i(147),Se=i(200),Te=i(607),Ce=i(568),Ee=i(798),Ae=i(746),we=i(139);function Re(e,t,i,r){const a=e.stageObject,n=a.geometryRecords;let s=0;for(const o of n){const{update:e,averageGeometrySampledElevation:n}=Be(o,t,i,r);s+=n,e&&a.geometryVertexAttrsUpdated(o)}return s/n.length}function Pe(e,t,i,r){const a=e.stageObject,n=t.centerPointInElevationSR;let s=0;a.metadata.usesVerticalDistanceToGround?(Object(Te.g)(n,i,t,r,Ve),Object(Ce.h)(a,Ve.verticalDistanceToGround),s=Ve.sampledElevation):(Object(Te.g)(n,i,t,r,Ve),"absolute-height"!==t.mode&&(s=Ve.sampledElevation));const o=Object(xe.c)(Ie,a.transformation),c=Object(F.w)(Ge,o[12],o[13],o[14]);Ee.a.TESTS_DISABLE_OPTIMIZATIONS?(Ne[0]=n.x,Ne[1]=n.y,Ne[2]=Ve.z,Object(U.d)(n.spatialReference,Ne,o,r.spatialReference)&&(a.transformation=o)):r.setAltitudeOfTransformation(Ve.z,o);const l=Le/r.unitInMeters;return(Math.abs(o[12]-c[0])>=l||Math.abs(o[13]-c[1])>=l||Math.abs(o[14]-c[2])>=l)&&(a.transformation=o),s}const Ie=Object(Se.d)();function De(e,t,i,r){const n=e.graphics3DSymbolLayer.lodRenderer;if(Object(a.j)(n))return 0;const s=t.centerPointInElevationSR;Object(Te.g)(s,i,t,r,Ve);const o="absolute-height"!==t.mode?Ve.sampledElevation:0,c=n.instanceData,l=e.instanceIndex,d=Ue;c.getGlobalTransform(l,d);const h=Object(F.w)(Ge,d[12],d[13],d[14]);Ee.a.TESTS_DISABLE_OPTIMIZATIONS?(Ne[0]=s.x,Ne[1]=s.y,Ne[2]=Ve.z,Object(U.d)(s.spatialReference,Ne,d,r.spatialReference)&&c.setGlobalTransform(l,d)):r.setAltitudeOfTransformation(Ve.z,d);const u=Le/r.unitInMeters;return(Ee.a.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(d[12]-h[0])>=u||Math.abs(d[13]-h[1])>=u||Math.abs(d[14]-h[2])>=u)&&c.setGlobalTransform(l,d),o}function Me(e,t,i,r){const a=e.stageObject,n=a.geometryRecords;if(0===n.length)return 0;let s=0,o=null,c=0,l=!1;for(const d of n){const e=d.geometry.vertexAttributes.get(we.a.POSITION);if(e!==o){const{update:a,averageGeometrySampledElevation:n}=Be(d,t,i,r);c=n,o=e,l=a}l&&a.geometryVertexAttrsUpdated(d),s+=c}return s/n.length}const Le=.01,Ne=Object(z.f)(),Fe=Object(z.f)(),ze=Object(z.f)(),Ue=Object(Se.d)(),Ge=Object(z.f)(),Ve=new Te.a;function Be(e,t,i,r){let a=!1;const n=i.spatialReference,s=e.geometry,o=e.getShaderTransformation(),c=t.requiresSampledElevationInfo;Fe[0]=o[12],Fe[1]=o[13],Fe[2]=o[14],s.invalidateBoundingInfo();const l=s.getMutableAttribute(we.a.POSITION),d=l.data,h=s.vertexAttributes.get(we.a.MAPPOS).data,u=l.size,p=d.length/u,f=new Ae.a(h,n);let b=0,m=0;for(let g=0;g<p;g++){if(ze[0]=d[b],ze[1]=d[b+1],ze[2]=d[b+2],Object(Te.g)(f,i,t,r,Ve),c&&(m+=Ve.sampledElevation),Ee.a.TESTS_DISABLE_OPTIMIZATIONS)d[b]=f.array[f.offset],d[b+1]=f.array[f.offset+1],d[b+2]=Ve.z,Object(U.l)(d,n,b,d,r.spatialReference,b,1),d[b]-=Fe[0],d[b+1]-=Fe[1],d[b+2]-=Fe[2],a=!0;else{Ne[0]=d[b]+Fe[0],Ne[1]=d[b+1]+Fe[1],Ne[2]=d[b+2]+Fe[2],r.setAltitude(Ne,Ve.z),d[b]=Ne[0]-Fe[0],d[b+1]=Ne[1]-Fe[1],d[b+2]=Ne[2]-Fe[2];const e=Le/r.unitInMeters;(Math.abs(ze[0]-d[b])>=e||Math.abs(ze[1]-d[b+1])>=e||Math.abs(ze[2]-d[b+2])>=e)&&(a=!0)}b+=u,f.offset+=3}return m/=p,{update:a,averageGeometrySampledElevation:m}}var ke,He,We=i(676),qe=i(498),$e=i(163);(He=ke||(ke={}))[He.INVISIBLE=0]="INVISIBLE",He[He.TRANSPARENT=1]="TRANSPARENT",He[He.OPAQUE=2]="OPAQUE";class Xe{constructor(e,t,i,r,a,n,s,o=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=i,this._uniqueMaterials=r,this._sharedResource=a,this.elevationAligner=n,this.elevationContext=s,this._edgeState=o,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1,this.graphics3DSymbolLayer=e,this.stageObject=t}get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}initialize(e,t){this._stageLayer=t,this._stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.add(this.stageObject)}destroy(){const e=this._stage;this._stageLayer&&(e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries)),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const t=this._stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),Object(a.k)(this._sharedResource)&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null,this._stage=null}layerOpacityChanged(e,t){if(Object(a.j)(this._edgeState))return;const i=Ye(this._edgeState.baseMaterial);let r=!1;for(const a of this._edgeState.edgeMaterials)a.objectTransparency!==i&&(a.objectTransparency=i,r=!0);r&&this._resetEdgeObject(t),this._stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,t){Object(a.j)(this._edgeState)||(this._stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{slicePlaneEnabled:e},!t),this._edgeState.properties.slicePlaneEnabled=e)}setVisibility(e){if(null!=this._stage&&this._visible!==e&&(this._visible=e,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this._stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),Object(a.k)(this._edgeState))){const t=this._stage.renderView.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this._addOrUpdateEdgeObject(t,!1)}}get visible(){return this._visible}alignWithElevation(e,t,i,r){null!=this.elevationAligner&&(Object(a.k)(i)&&Object(de.f)(this.elevationContext.featureExpressionInfoContext,i),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e,t),this._resetEdgeObject(r))}getCenterObjectSpace(e=Object(z.f)()){return Object(F.k)(e,Object(qe.e)(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=Object(G.f)()){const t=this.stageObject.boundingVolumeObjectSpace;return Object(G.y)(e,t.min),Object(G.x)(e,t.max),e}computeAttachmentOrigin(e){if(this.useObjectOriginAsAttachmentOrigin){const t=this.stageObject.transformation;e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++}else for(const t of this.stageObject.geometryRecords)t.computeAttachmentOrigin(Je)&&(Object(F.q)(Je,Je,this.stageObject.transformation),Object(F.f)(e.render.origin,e.render.origin,Je),e.render.num++)}async getProjectedBoundingBox(e,t,i,r,n){const s=this.getBoundingBoxObjectSpace(n),o=Ke,c=Object(G.s)(s)?1:o.length;for(let a=0;a<c;a++){const e=o[a];Qe[0]=s[e[0]],Qe[1]=s[e[1]],Qe[2]=s[e[2]],Object(F.q)(Qe,Qe,this.stageObject.transformation),Ze[3*a+0]=Qe[0],Ze[3*a+1]=Qe[1],Ze[3*a+2]=Qe[2]}if(!e(Ze,0,c))return null;Object(G.h)(s);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let a=0;a<3*c;a+=3){for(let e=0;e<3;e++)s[e]=Math.min(s[e],Ze[a+e]),s[e+3]=Math.max(s[e+3],Ze[a+e]);l&&i.push({location:Ze.slice(a,a+3),screenSpaceBoundingRect:l})}if(t&&t.service&&"absolute-height"!==this.elevationContext.mode){Object(G.d)(s,Je);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let i=0;if(t.useViewElevation)i=Object(a.t)(t.service.getElevation(Je[0],Je[1],e),0);else try{const n=Object(Ce.d)(s,t);i=Object(a.t)(await t.service.queryElevation(Je[0],Je[1],r,n,e),0)}catch(d){}Object(G.u)(s,0,0,-this.alignedSampledElevation+i)}return s}addObjectState(e,t){e===$e.d.Highlight&&t.addObject(this.stageObject,this.stageObject.highlight()),e===$e.d.MaskOccludee&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}_resetEdgeObject(e){if(Object(a.j)(this._edgeState))return;const t=this._stage.renderView.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)}_addOrUpdateEdgeObject(e,t){const i=this._edgeState;if(Object(a.j)(i))return;const r=Ye(i.baseMaterial);for(const a of i.edgeMaterials)a.objectTransparency=r;e.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!t).then((()=>{var e;return null==(e=this._stageLayer)?void 0:e.sync()}))}}function Ye(e){return e.isVisible?e.parameters.transparent?ke.TRANSPARENT:ke.OPAQUE:ke.INVISIBLE}const Ze=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Qe=Object(z.f)(),Je=Object(z.f)(),Ke=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];var et,tt,it,rt,at=i(257);(tt=et||(et={}))[tt.Recreate_Symbol=0]="Recreate_Symbol",tt[tt.Recreate_Graphics=1]="Recreate_Graphics",tt[tt.Fast_Update=2]="Fast_Update";class nt{constructor(e){this.schedule=e,this._loadStatus=it.LOADING,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){return this._loadStatus===it.LOADED?(e&&e(),Object(a.s)(this._loader)):this._loadStatus===it.FAILED?(t&&t(this._loadError),Object(a.s)(this._loader)):(Object(a.j)(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then((()=>{this._abortController=null,this._loadStatus=it.LOADED}),(e=>{throw this._loadError=e,this._abortController=null,this._loadStatus=it.FAILED,!Object(v.l)(e)&&this.logger&&e.message&&this.logger.warn(e.message),e}))),this._loader.then(e,t).catch((()=>{})),this._loader)}abortLoad(){Object(a.k)(this._abortController)?this._abortController=Object(a.a)(this._abortController):this._loadStatus===it.LOADING&&(this._loadStatus=it.FAILED),this._loader=null}}(rt=it||(it={}))[rt.LOADING=0]="LOADING",rt[rt.LOADED=1]="LOADED",rt[rt.FAILED=2]="FAILED";var st=i(222),ot=i(918),ct=i(594);function lt(e,t){const i=(e,i,r=!1)=>({levels:e.map((e=>{const a=i(e.tesselation);return r&&ct.a.cgToGIS(a),{components:[{geometry:a,material:t}],faceCount:a.indexCount/3,minScreenSpaceRadius:e.minScreenSpaceRadius}}))});switch(e){case"sphere":return i([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],(e=>ct.a.createPolySphereGeometry(.5,e,!0)));case"cube":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>ct.a.createBoxGeometry(1)));case"cone":return i(dt,(e=>ct.a.createConeGeometry(1,.5,e,!1)),!0);case"inverted-cone":return i(dt,(e=>ct.a.createConeGeometry(1,.5,e,!0)),!0);case"cylinder":return i(dt,(e=>ct.a.createCylinderGeometry(1,.5,e,[0,0,1],[0,0,.5])));case"tetrahedron":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>ct.a.createTetrahedronGeometry(1)),!0);case"diamond":return i([{tesselation:0,minScreenSpaceRadius:0}],(()=>ct.a.createDiamondGeometry(1)),!0);default:return}}const dt=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];function ht(e,t){return function(e,t){if(Object(a.j)(e))return null;const i=Object(a.k)(e.color)?Object(at.f)(j.a.toUnitRGBA(e.color)):Object(at.g)(0,0,0,0),r=Object(je.g)(e.size),n=Object(je.g)(e.extensionLength);switch(e.type){case"solid":return function(e){return{...ut,...e,type:"solid"}}({color:i,size:r,extensionLength:n,...t});case"sketch":return function(e){return{...pt,...e,type:"sketch"}}({color:i,size:r,extensionLength:n,...t});default:return}}(function(e){return e&&e.enabled&&e.edges||null}(e),t)}const ut={color:Object(at.g)(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:ke.OPAQUE},pt={color:Object(at.g)(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:ke.OPAQUE};function ft(e){const t=[];return e.levels.forEach((e=>{e.components.forEach((e=>{t.push(e.material)}))})),Object(o.k)(t)}function bt(e){const t=[];return e.components.forEach((e=>{t.push(e.geometry)})),Object(o.k)(t)}const mt={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function gt(e){let t=0,i=0,r=0,n=!1,s=0;const o={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const c of e)Object(a.j)(c)||(t+=c.primitivesPerFeature,i+=c.primitivesPerCoordinate,r+=c.drawCallsPerFeature,o.bytesPerFeature+=c.memory.bytesPerFeature,o.bytesPerFeatureLabel+=c.memory.bytesPerFeatureLabel,o.bytesPerCoordinate+=c.memory.bytesPerCoordinate,o.draped.bytesPerFeature+=c.memory.bytesPerFeature,o.draped.bytesPerFeatureLabel+=c.memory.bytesPerFeatureLabel,o.draped.bytesPerCoordinate+=c.memory.bytesPerCoordinate,n=n||c.estimated,++s);return{primitivesPerFeature:t,primitivesPerCoordinate:i,drawCallsPerFeature:r,estimated:n,memory:o,numComplexities:s}}const vt={};function Ot(e,t){const i=yt(e,t),r=function(e){return e&&e.enabled&&(function(e){return"extrude"===e.type}(e)||function(e){return"fill"===e.type}(e))&&Object(a.k)(e.edges)}(t)?2:0;switch(t.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:r,estimated:!1,memory:i};case"fill":return"mesh-3d"===e.type?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:r,estimated:!1,memory:i}:Object(a.k)(t.outline)&&t.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:i}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:i};case"object":return t.resource&&t.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:i}:{..._t(t.resource&&t.resource.primitive||ot.b),memory:i};case"path":{const e=3,r=3,a=10;let n=0,s=0;switch(t.profile){case"circle":n=a;break;case"quad":n=4;break;default:return void Object(st.a)(t.profile)}switch(t.join){case"round":s=e;break;case"miter":case"bevel":s=1;break;default:return void Object(st.a)(t.join)}const o=2*n,c=n*s*2;let l=-2*c-o;switch(t.cap){case"none":break;case"butt":case"square":l+=2*(n-1);break;case"round":l+=2*(n*(r-1)*2+n);break;default:return}return{primitivesPerFeature:l,primitivesPerCoordinate:c+o,drawCallsPerFeature:0,estimated:!1,memory:i}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:i};default:return}}function yt(e,t){const i="point-3d"===e.type;switch(t.type){case"extrude":return t.edges&&t.edges.size>0?jt.EXTRUDE_EDGES:jt.EXTRUDE;case"fill":return Object(a.k)(t.outline)&&t.outline.size>0?jt.FILL_OUTLINE:jt.FILL;case"water":return jt.FILL;case"line":return"round"===t.join?jt.LINE_ROUND:jt.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return jt.PATH_ROUND_CIRCLE;case"quad":return jt.PATH_ROUND_QUAD;default:return void Object(st.a)(t.profile)}case"miter":case"bevel":switch(t.profile){case"circle":return jt.PATH_MITER_CIRCLE;case"quad":return jt.PATH_MITER_QUAD;default:return void Object(st.a)(t.profile)}default:return void Object(st.a)(t.join)}case"object":return i?jt.OBJECT_POINT:jt.OBJECT_POLYGON;case"icon":case"text":return i?jt.ICON_POINT:jt.ICON_POLYGON;default:return}}function _t(e){let t=vt[e];if(t)return t;return t={primitivesPerFeature:bt(lt(e,null).levels[0]).reduce(((e,t)=>e+t.indices.get(we.a.POSITION).length/3),0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},vt[e]=t,t}const jt={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}},xt=D.a.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class St extends nt{constructor(e,t,i,r){super(i.schedule),this._context=i,this._elevationInfoOverride=null,this._ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this.complexity=null,this.logger=xt,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=e,this.symbolLayer=t,this._renderPriority=r.renderPriority,this._renderPriorityStep=r.renderPriorityStep,this._elevationContext=new We.a,this.complexity=this.computeComplexity(),this._ignoreDrivers=r.ignoreDrivers,this._ignoreDrivers||(this._drivenProperties=Ct(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}_drivenPropertiesChanged(e){if(this._ignoreDrivers)return!1;const t=this._drivenProperties,i=Ct(e);return i.color!==t.color||i.opacity!==t.opacity||i.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||i.size!==t.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,i,r){const a=e.projectionSuccess,n="polygons"in e?e.polygons:null,s=`${r} geometry failed to be created`;let o=null;a?!t.length||1===t.length&&!t[0].length?o=`${s} (no ${i} were defined)`:Array.isArray(t)&&Array.isArray(t[0])?n&&0===n.length&&"rings"===i&&t.length>0&&t[0].length>2&&(o=`${s} (filled rings should use clockwise winding - try reversing the order of vertices)`):o=`${s} (${i} should be defined as a 2D array)`:o=`${s} (failed to project geometry to view spatial reference)`,o&&xt.warnOncePerTick(o)}_validateGeometry(e,t=null,i=null){if(Object(a.k)(t)&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+` symbol: ${e.type}`),!1;if("point"===e.type){const t=e;if(!isFinite(t.x)||!isFinite(t.y))return xt.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return Et}_defaultElevationInfoZ(){return At}_updateElevationContext(){Object(a.k)(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t){const i=Object(a.s)(e.geometry),r=this.getDefaultElevationInfo(i);t.unit=null!=this._elevationContext.unit?this._elevationContext.unit:r.unit,t.mode=this.getGeometryElevationMode(i,r),t.offsetMeters=Object(a.t)(this._elevationContext.meterUnitOffset,Object(a.t)(r.offset,0));const n=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===t.mode;n&&(t.mode="relative-to-ground",t.offsetMeters=0);const s=n?de.g:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(s,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}onRemoveGraphic(e){}_getLayerOpacity(){if(this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner)return this._context.graphicsCoreOwner.fullOpacity;const e=this._context.layer.opacity;return null==e?1:e}_getCombinedOpacity(e,t=wt){let i=1;return this.draped||(i*=this._getLayerOpacity()),this._drivenProperties.opacity||(Object(a.k)(e)?i*=e.a:t.hasIntrinsicColor||(i=0)),i}_getCombinedOpacityAndColor(e,t=wt){const i=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return Object(Ce.g)(null,i);const r=Object(a.k)(e)?j.a.toUnitRGB(e):z.a;return Object(Ce.g)(r,i)}_getVertexOpacityAndColor(e,t=null){const i=this._drivenProperties.color?e.color:null,r=this._drivenProperties.opacity?e.opacity:null,n=Object(Ce.g)(i,r);return Object(a.k)(t)&&(n[0]*=t,n[1]*=t,n[2]*=t,n[3]*=t),n}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return Ot(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,i){switch(e){case"opacity":return this.layerOpacityChanged(t,i);case"elevationInfo":{const e=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,i,e)!==Te.b.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(e,t,i){let r=Te.b.UPDATE;return e.forEach((e=>{const n=t(e);if(Object(a.k)(n)){const t=e.graphic;this.setGraphicElevationContext(t,n.elevationContext),n.needsElevationUpdates=i(n.elevationContext.mode)}else r=Te.b.RECREATE})),r}applyRendererDiff(e,t){return et.Recreate_Symbol}getFastUpdateAttrValues(e){if(!this._fastUpdates.enabled)return null;const t=this._fastUpdates.visualVariables,i=t.size?Tt(t.size.field,e):0,r=t.color?Tt(t.color.field,e):0,a=t.opacity?Tt(t.opacity.field,e):0;return Object(at.g)(i,r,a,0)}get draped(){return this._draped}ensureDrapedStatus(e){return null==this._draped?(this._draped=e,!0):(e!==this.draped&&xt.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}}function Tt(e,t){const i=null!=e?t.attributes[e]:0;return null!=i&&isFinite(i)?i:0}function Ct(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach((e=>{switch(e.type){case"color":if(t.color=!0,e.stops)for(let i=0;i<e.stops.length;i++){const r=e.stops[i].color;r&&(t.opacity=!0,r.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}})),t}const Et={mode:"on-the-ground",offset:0,unit:"meters"},At={mode:"absolute-height",offset:0,unit:"meters"},wt={hasIntrinsicColor:!1};var Rt=i(951),Pt=i(595),It=i(335),Dt=i(188),Mt=i(495),Lt=i(210),Nt=i(753),Ft=i(545),zt=i(411),Ut=i(604),Gt=i(301),Vt=i(731),Bt=i(857),kt=i(501),Ht=i(388),Wt=i(404),qt=i(419),$t=i(382),Xt=i(389),Yt=i(434),Zt=i(1089),Qt=i(94),Jt=i(355);class Kt extends Wt.a{initializeProgram(e){const t=Kt.shader.get(),i=this.configuration,r=t.build({occlusionTestEnabled:i.occlusionTestEnabled,verticalOffsetEnabled:i.verticalOffset,screenSizePerspectiveEnabled:i.screenSizePerspective,depthHudEnabled:i.depthHudEnabled,depthHudAlignStartEnabled:i.depthHudAlignStartEnabled,screenCenterOffsetUnitsEnabled:i.screenCenterOffsetUnitsEnabled,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,viewingMode:e.viewingMode,isDraped:!1,multipassGeometryEnabled:i.multipassGeometryEnabled});return new Xt.a(e.rctx,r,$t.a)}bindPass(e,t){Object(kt.b)(this.program,t.camera.projectionMatrix),Object(Zt.c)(this.program,e,t.camera.pixelRatio||1),Object(Vt.b)(this.program,e,t),Object(Nt.c)(this.program,t),this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(Bt.a)(this.program,t),this.program.bindTexture(t.hudVisibilityTexture,"hudVisibilityTexture"),this.program.setUniform1f("cameraGroundRelative",t.camera.aboveGround?1:-1),this.program.setUniform1f("polygonOffset",e.shaderPolygonOffset),Object(kt.e)(this.program,t),this.program.setUniform1f("perDistancePixelRatio",Math.tan(t.camera.fovY/2)/(t.camera.fullViewport[2]/2)),this.program.setUniformMatrix4fv("viewNormal",t.camera.viewInverseTransposeMatrix),this.program.setUniform2f("pixelToNDC",2/t.camera.fullViewport[2],2/t.camera.fullViewport[3]);const i=t.camera.pixelRatio||1;this.program.setUniform1f("lineSize",Math.ceil(e.size)*i),Object(Yt.a)(e.screenSizePerspective,this.program,"screenSizePerspectiveAlignment")}bindDraw(e){Object(kt.c)(this.program,e),Object(kt.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),Object(Gt.c)(this.program,this.configuration,e),this.program.rebindTextures()}setPipelineState(e){const t=e?Qt.h.ALWAYS:Qt.h.LESS;return this.configuration.depthHudEnabled?Object(Jt.f)({depthTest:{func:t},depthWrite:Jt.d}):Object(Jt.f)({blending:Object(Jt.g)(Qt.b.ONE,Qt.b.SRC_ALPHA,Qt.b.ONE_MINUS_SRC_ALPHA,Qt.b.ONE_MINUS_SRC_ALPHA),depthTest:{func:t},colorWrite:Jt.c})}initializePipeline(){return this.setPipelineState(this.configuration.multipassGeometryEnabled)}}Kt.shader=new Ht.a(Zt.a,(()=>i.e(330).then(i.bind(null,1357))));class ei extends qt.a{constructor(){super(...arguments),this.occlusionTestEnabled=!0,this.verticalOffset=!1,this.screenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.screenCenterOffsetUnitsEnabled=Nt.b.World,this.slicePlaneEnabled=!1,this.multipassGeometryEnabled=!1}}Object(r.a)([Object(qt.b)()],ei.prototype,"occlusionTestEnabled",void 0),Object(r.a)([Object(qt.b)()],ei.prototype,"verticalOffset",void 0),Object(r.a)([Object(qt.b)()],ei.prototype,"screenSizePerspective",void 0),Object(r.a)([Object(qt.b)()],ei.prototype,"depthHudEnabled",void 0),Object(r.a)([Object(qt.b)()],ei.prototype,"depthHudAlignStartEnabled",void 0),Object(r.a)([Object(qt.b)({count:Nt.b.COUNT})],ei.prototype,"screenCenterOffsetUnitsEnabled",void 0),Object(r.a)([Object(qt.b)()],ei.prototype,"slicePlaneEnabled",void 0),Object(r.a)([Object(qt.b)()],ei.prototype,"multipassGeometryEnabled",void 0);class ti extends It.b{constructor(e){super(e,ri),this.techniqueConfig=new ei,this._uniqueMaterialIdentifier=ti.uniqueMaterialIdentifier(this.parameters)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}getPassParameters(){return this.parameters}getTechniqueConfig(e,t){const i=(null==t?void 0:t.slot)!==zt.a.LINE_CALLOUTS;return this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.verticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.depthHudEnabled=i,this.techniqueConfig.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits?Nt.b.Screen:Nt.b.World,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.multipassGeometryEnabled=!!t&&t.multipassGeometryEnabled,this.techniqueConfig}intersect(){}requiresSlot(e){switch(e){case zt.a.LINE_CALLOUTS:case zt.a.LINE_CALLOUTS_HUD_DEPTH:return!0}return!1}createGLMaterial(e){return e.output===Lt.a.Color?new ii(e):null}createBufferWriter(){return new si}validateParameters(e){const t=ti.uniqueMaterialIdentifier(e);t!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=t)}static uniqueMaterialIdentifier(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}}class ii extends Ft.a{updateParameters(e){return this.ensureTechnique(Kt,e)}beginSlot(e){return this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}const ri={verticalOffset:null,screenSizePerspective:null,screenOffset:[0,0],color:[0,0,0,1],size:1,borderColor:null,occlusionTest:!1,shaderPolygonOffset:1e-5,depthHUDAlignStart:!1,centerOffsetUnits:"world",slicePlaneEnabled:!1,...It.a},ai=Object(Mt.a)().vec3f(we.a.POSITION).vec3f(we.a.NORMAL).vec2f(we.a.UV0).vec4f(we.a.AUXPOS1),ni=[Object(Dt.b)(0,0),Object(Dt.b)(1,0),Object(Dt.b)(0,1),Object(Dt.b)(1,0),Object(Dt.b)(1,1),Object(Dt.b)(0,1)];class si{constructor(){this.vertexBufferLayout=ai}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get(we.a.POSITION).length}write(e,t,i,r){Object(Ut.f)(t.indices.get(we.a.POSITION),t.vertexAttributes.get(we.a.POSITION).data,e.transformation,i.position,r,6),Object(Ut.e)(t.indices.get(we.a.NORMAL),t.vertexAttributes.get(we.a.NORMAL).data,e.invTranspTransformation,i.normal,r,6),Object(Ut.b)(t.indices.get(we.a.AUXPOS1),t.vertexAttributes.get(we.a.AUXPOS1).data,i.auxpos1,r,6);for(let a=0;a<ni.length;++a)i.uv0.setVec(r+a,ni[a])}}class oi extends St{constructor(e,t){super(e,null,t,hi),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new ti(this.materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}_perInstanceMaterialParameters(e){const t=this.materialParameters;return t.screenOffset=e.screenOffset||[0,0],t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get materialParameters(){const e=this.symbol,t=e.callout,i=Object(a.k)(t.color)?j.a.toUnitRGBA(t.color):[0,0,0,0];i[3]*=this._getLayerOpacity();const r=Object(je.g)(t.size||0);let n=null;if(e.verticalOffset){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e.verticalOffset;n={screenLength:Object(je.g)(t),minWorldLength:i||0,maxWorldLength:null!=r?r:1/0}}const s=Object(a.k)(t.border)&&Object(a.k)(t.border.color)?j.a.toUnitRGBA(t.border.color):null,o="object"===e.symbolLayers.getItemAt(0).type,c=!o,l=o?0:void 0,d="label-3d"===e.type;return{color:i,size:r,verticalOffset:n,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:s,occlusionTest:c,shaderPolygonOffset:l,depthHUDAlignStart:d,slicePlaneEnabled:this._context.slicePlaneEnabled,renderOccluded:It.a.renderOccluded}}_defaultElevationInfoNoZ(){return di}createGraphics3DGraphic(e){const t=e.renderingInfo,i=e.graphic,r=this.setGraphicElevationContext(i,new We.a,t.elevationOffset||0),n=t.symbol,s="on-the-ground"===this._elevationContext.mode&&("cim"===n.type||!n.symbolLayers.some((e=>"object"===e.type||"text"===e.type)));if("label-3d"!==n.type&&s)return null;if("point-3d"===n.type&&n.symbolLayers.every((e=>"text"===e.type&&!Object(_e.e)(e))))return null;const o=Object(Ce.a)(i.geometry);return Object(a.j)(o)?null:this._createAs3DShape(o,r,t,i.uid)}layerOpacityChanged(){return Object(a.j)(this._material)||this._material.setParameters(this.materialParameters),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=Object(Te.e)(oi.elevationModeChangeTypes,i,r);return n!==Te.b.UPDATE||e.forEach((e=>{const i=t(e);Object(a.k)(i)&&this.updateGraphicElevationContext(e.graphic,i)})),n}slicePlaneEnabledChanged(){return Object(a.j)(this._material)||this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}setGraphicElevationContext(e,t,i=0){const r=super.setGraphicElevationContext(e,t);return r.addOffsetRenderUnits(i),r}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=Object(Te.h)(t.elevationContext.mode)}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:mt.memory}}_createVertexData(e){const{translation:t,centerOffset:i}=e,r=t?{size:3,data:[t[0],t[1],t[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0},a=i?{size:4,data:[i[0],i[1],i[2],i[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0};return[[we.a.POSITION,r],[we.a.NORMAL,{size:3,data:[0,0,1],exclusive:!0}],[we.a.AUXPOS1,a]]}_getOrCreateMaterial(e){const t=this._perInstanceMaterialParameters(e),i=ti.uniqueMaterialIdentifier(t);if(Object(a.k)(this._material)&&i===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(e.materialCollection){let r=e.materialCollection.get(i);return Object(a.j)(r)&&(r=new ti(t),e.materialCollection.add(i,r)),{material:r,isUnique:!1}}return{material:new ti(t),isUnique:!0}}_createAs3DShape(e,t,i,r){const a=[new Pt.a(this._createVertexData(i),li,$e.f.Point)],n=this._getOrCreateMaterial(i),s=Object(Rt.a)(this._context,e,a,[n.material],t,this._context.layer.uid,r);if(null===s)return null;const o=new Xe(this,s.object,a,n.isUnique?[n.material]:null,null,Pe,t);return o.metadata={elevationOffset:i.elevationOffset||0},o.alignedSampledElevation=s.sampledElevation,o.needsElevationUpdates=Object(Te.h)(t.mode),Object(Rt.b)(o,e,this._context.elevationProvider),o}}oi.elevationModeChangeTypes={definedChanged:Te.b.UPDATE,staysOnTheGround:Te.b.UPDATE,onTheGroundChanged:Te.b.RECREATE};const ci=new Uint16Array([0]),li=[[we.a.POSITION,ci],[we.a.NORMAL,ci],[we.a.AUXPOS1,ci]],di={mode:"relative-to-ground",offset:0},hi={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},ui=D.a.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");const pi={line:oi};var fi=i(409),bi=i(211),mi=i(151),gi=i(219),vi=i(135),Oi=i(160);const yi=new bi.a(Array,(e=>Object(G.w)(e,G.b)),null,10,5),_i=Object(V.l)();class ji{constructor(e,t,i,r,n){this.graphic=e,this.graphics3DSymbol=t,this.graphics=i,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=function(e,t){const i=new Array(e);for(let r=0;r<i.length;r++)i[r]=new Array(t);return i}(ae._COUNT,ne._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++t.referenced,this._featureExpressionFeature=n?Object(de.c)(n,e,r):null;for(const s of i)Object(a.k)(s)&&(this.isElevationSource=this.isElevationSource||s.isElevationSource)}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(e,t,i){this._layer=t,this._stage=e,this._forEachSymbolLayerGraphic((r=>{r.initialize(e,t,i),r.setVisibility(this.isVisible())}))}destroy(){this._forEachSymbolLayerGraphic((e=>e.destroy())),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.graphics}clearLabelGraphics(){this._forEachLabelGraphic((e=>e.destroy())),this._labelGraphics.length=0}addLabelGraphic(e,t,i){this._labelGraphics.push(e),e.initialize(t,i),e.setVisibility(this.isVisible(ae.LABEL))}addAuxiliaryGraphic(e){this._auxiliaryGraphics.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic((t=>{"draped"===t.type&&(e=!0)})),e}isVisible(e=ae.GRAPHIC,t){for(let i=0;i<=e;i++){const e=this._visibilityFlags[i];for(let i=0;i<e.length;++i)if(!1===e[i]&&i!==t)return!1}return!0}hasVisibilityFlag(e,t){return null!=this._visibilityFlags[t][e]}setVisibilityFlag(e,t,i){const r=this.isVisible(i);this._visibilityFlags[i][e]=t;const a=this.isVisible(i);if(r===a)return!1;if(i===ae.LABEL)this._forEachLabelGraphic((e=>e.setVisibility(a)));else{this._forEachSymbolLayerGraphic((e=>e.setVisibility(a)));const e=this.isVisible(ae.LABEL);this._forEachLabelGraphic((t=>t.setVisibility(e)))}return!0}clearVisibilityFlag(e,t=ae.GRAPHIC){return this.setVisibilityFlag(e,void 0,t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(Object(a.j)(t))return!1;this._extent=Object(V.l)(),Object(B.d)(t,this._extent);const i=t.spatialReference;if(!i.equals(e)&&!Object(U.k)(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return Object(a.k)(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===t||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=t),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(e,t,i){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=vi.a.fromExtent("mesh"===r.type?r.extent:r)),Object(Oi.d)(r,t,i)}get usedMemory(){let e=Object(fi.b)(this.graphic.attributes);return this._forEachSymbolLayerGraphic((t=>{const i=t.graphics3DSymbolLayer.complexity;if(Object(a.j)(i))return;const r="draped"===t.type?i.memory.draped:i.memory;e+=r.bytesPerFeature,r.bytesPerCoordinate&&(e+=Object(B.h)(this.graphic.geometry)*r.bytesPerCoordinate)})),e}computeAttachmentOrigin(){const e={render:{origin:Object(z.f)(),num:0},draped:{origin:Object(gi.a)(),num:0}};for(const t of this.graphics)Object(a.j)(t)||t.computeAttachmentOrigin(e);return e.render.num&&Object(F.e)(e.render.origin,e.render.origin,1/e.render.num),e.draped.num&&Object(mi.g)(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,i,r,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?Object(G.h)(n.boundingBox):n.boundingBox=Object(G.h)(),n.requiresDrapedElevation=!1,await Object(ye.a)(this.graphics,(async s=>{if(Object(a.j)(s))return;const o="draped"===s.type?t:e,c=yi.acquire(),l=await s.getProjectedBoundingBox(o,i,n.screenSpaceObjects,r,c);isFinite(l[2])&&isFinite(l[5])||(n.requiresDrapedElevation=!0),l&&Object(G.j)(n.boundingBox,c),yi.release(c)})),Object(G.c)(n.boundingBox)||Object(V.b)(Object(G.A)(n.boundingBox,_i))?n:null}needsElevationUpdates(){for(const e of this.graphics)if(Object(a.k)(e)&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;for(const e of this._labelGraphics)if(e&&e.needsElevationUpdates)return!0;return!1}alignWithElevation(e,t,i){this._forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,t,this._featureExpressionFeature,i)}))}addObjectStateSet(e,t){this._forEachSymbolLayerGraphic((i=>i.addObjectState(e,t)))}removeObjectState(e){this._forEachSymbolLayerGraphic((t=>t.removeObjectState(e)))}_forEachGraphicList(e,t){e.forEach((e=>e&&t(e)))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.graphics,e),this._forEachGraphicList(this._auxiliaryGraphics,e)}_forEachLabelGraphic(e){this._forEachGraphicList(this._labelGraphics,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}}var xi=i(359),Si=i(233),Ti=i(367),Ci=i(421),Ei=i(744),Ai=i(272),wi=i(943),Ri=i(1027),Pi=i(101);function Ii(e){const t=[[we.a.POSITION,e.indices]],i=[[we.a.POSITION,{size:3,data:e.attributeData.position,exclusive:!0}]];return Object(a.k)(e.attributeData.color)&&(i.push([we.a.COLOR,{size:4,data:e.attributeData.color,exclusive:!0}]),t.push([we.a.COLOR,new Uint32Array(e.indices.length)])),Object(a.k)(e.attributeData.uvMapSpace)&&(i.push([we.a.UVMAPSPACE,{size:4,data:e.attributeData.uvMapSpace,exclusive:!0}]),t.push([we.a.UVMAPSPACE,e.indices])),Object(a.k)(e.attributeData.boundingRect)&&(i.push([we.a.BOUNDINGRECT,{size:9,data:e.attributeData.boundingRect,exclusive:!0}]),t.push([we.a.BOUNDINGRECT,e.indices])),Object(a.k)(e.attributeData.mapPosition)&&(i.push([we.a.MAPPOS,{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push([we.a.MAPPOS,e.indices])),new Pt.a(i,t)}function Di(e){const t=[[we.a.POSITION,e.indices],[we.a.UV0,e.indices]],i=[[we.a.POSITION,{size:3,data:e.attributeData.position,exclusive:!0}],[we.a.UV0,{size:2,data:e.attributeData.uv0,exclusive:!0}]];return Object(a.k)(e.attributeData.mapPosition)&&(i.push([we.a.MAPPOS,{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push([we.a.MAPPOS,e.indices])),new Pt.a(i,t)}function Mi(e){switch(e.type){case"extent":if(e instanceof Pi.a)return vi.a.fromExtent(e);break;case"polygon":return e}return null}function Li(e,t,i,r){const a=Object(wi.b)(e.rings,e.hasZ,wi.a.CCW_IS_HOLE),n=new Float64Array(a.position.length),s=Object(Te.d)(a.position,e.spatialReference,0,n,0,a.position,0,a.position.length/3,t,i,r),o=null!=s;return{position:a.position,mapPosition:n,polygons:zi(a.polygons,a.position,n),outlines:Fi(a.outlines,a.position,n),projectionSuccess:o,sampledElevation:s}}function Ni(e,t){const i=Object(wi.b)(e.rings,!1,wi.a.CCW_IS_HOLE),r=Object(U.l)(i.position,e.spatialReference,0,i.position,t,0,i.position.length/3);for(let a=2;a<i.position.length;a+=3)i.position[a]=Ri.a;return{position:i.position,polygons:zi(i.polygons,i.position),outlines:Fi(i.outlines,i.position),projectionSuccess:r}}function Fi(e,t,i){const r=new Array;for(const{index:a,count:n}of e){if(n<=1)continue;const e=3*a,s=e+3*n;r.push({index:a,count:n,position:t.subarray(e,s),mapPosition:i?i.subarray(e,s):void 0})}return r}function zi(e,t,i){const r=new Array;for(const{index:a,count:n,holeIndices:s,pathLengths:o}of e){if(n<=1)continue;const e=3*a,c=e+3*n,l=s.map((e=>e-a));r.push({index:a,count:n,holeIndices:l,pathLengths:o,position:t.subarray(e,c),mapPosition:i?i.subarray(e,c):void 0})}return r}var Ui=i(659),Gi=i(804);const Vi=["polygon","extent"];function Bi(e,t,i,r){const a=new Uint32Array(e.length),n=[[we.a.POSITION,{size:3,data:i.positions,exclusive:!0}],[we.a.NORMAL,{size:3,data:i.normals,exclusive:!0}],[we.a.COLOR,{size:4,data:r,exclusive:!0}],[we.a.SIZE,{size:1,data:i.heights,exclusive:!0}]],s=[[we.a.POSITION,e],[we.a.NORMAL,e],[we.a.COLOR,a]];return i.elevation&&(n.push([we.a.MAPPOS,{size:3,data:i.elevation}]),s.push([we.a.MAPPOS,e])),new Pt.a(n,s,$e.f.Triangle,t)}function ki(e,t,i,r,a,n,s,o,c,l,d,h,u,p){const f=i.length/3;let b=0,m=2*r.count;(function(e,t,i,r,a,n,s,o,c,l,d,h,u,p,f,b,m,g){Object(F.k)(ir,m);const v=b>0?1:-1;let O=3*i,y=h,_=3*y,j=h+r,x=3*j;for(let C=0;C<r;++C)g&&(ir[0]=e[O+0],ir[1]=e[O+1],ir[2]=e[O+2],Object(F.r)(ir,ir)),o[_+0]=e[O+0],o[_+1]=e[O+1],o[_+2]=e[O+2],c[_+0]=t[O+0],c[_+1]=t[O+1],c[_+2]=t[O+2],l[_+0]=-v*ir[0],l[_+1]=-v*ir[1],l[_+2]=-v*ir[2],d[y]=0,o[x+0]=e[O+0]+b*ir[0],o[x+1]=e[O+1]+b*ir[1],o[x+2]=e[O+2]+b*ir[2],c[x+0]=t[O+0],c[x+1]=t[O+1],c[x+2]=t[O+2],l[x+0]=v*ir[0],l[x+1]=v*ir[1],l[x+2]=v*ir[2],d[j]=b,_+=3,x+=3,O+=3,y+=1,j+=1;O=3*n,_=0,x=3*f;const S=b<0?nr:ar,T=b<0?ar:nr;for(let C=0;C<s;++C)p[_+0]=a[O+S[0]],p[_+1]=a[O+S[1]],p[_+2]=a[O+S[2]],u[x+0]=a[O+T[0]]+r,u[x+1]=a[O+T[1]]+r,u[x+2]=a[O+T[2]]+r,_+=3,x+=3,O+=3})(e,t,r.index,r.count,i,0,f,a,n,s,o,c,l,d,m,h,u,p),c+=2*r.count,m=0,qi(a,n,o,s,b,r.pathLengths[0],r.count,c,l,m,h),c+=4*r.pathLengths[0],m+=2*r.pathLengths[0],b+=r.pathLengths[0];for(let g=1;g<r.pathLengths.length;++g)qi(a,n,o,s,b,r.pathLengths[g],r.count,c,l,m,h),c+=4*r.pathLengths[g],m+=2*r.pathLengths[g],b+=r.pathLengths[g]}function Hi(e,t,i,r,a,n,s){r[n]=r[s],s*=3,e[0+(n*=3)]=e[s+0],e[n+1]=e[s+1],e[n+2]=e[s+2],t[n+0]=t[s+0],t[n+1]=t[s+1],t[n+2]=t[s+2],i[n+0]=a[0],i[n+1]=a[1],i[n+2]=a[2]}const Wi=Object(z.f)();function qi(e,t,i,r,a,n,s,o,c,l,d){let h=a,u=a+1,p=a+s,f=a+s+1,b=o,m=o+1,g=o+2*n,v=o+2*n+1;d<0&&(h=a+s+1,f=a),l*=3;for(let O=0;O<n;++O)O===n-1&&(d>0?(u=a,f=a+s):(u=a,h=a+s)),Ji(e,h,u,p,Wi),Hi(e,t,r,i,Wi,b,h),Hi(e,t,r,i,Wi,m,u),Hi(e,t,r,i,Wi,g,p),Hi(e,t,r,i,Wi,v,f),c[l++]=b,c[l++]=g,c[l++]=v,c[l++]=b,c[l++]=v,c[l++]=m,h++,u++,p++,f++,b+=2,m+=2,g+=2,v+=2}const $i=Object(z.f)(),Xi=Object(z.f)(),Yi=Object(z.f)(),Zi=Object(z.f)(),Qi=Object(z.f)();function Ji(e,t,i,r,a){t*=3,i*=3,r*=3,Object(F.w)($i,e[t++],e[t++],e[t++]),Object(F.w)(Xi,e[i++],e[i++],e[i++]),Object(F.w)(Yi,e[r++],e[r++],e[r++]),Object(F.j)(Zi,Xi,$i),Object(F.j)(Qi,Yi,$i),Object(F.g)(a,Qi,Zi),Object(F.r)(a,a)}const Ki=Object(z.f)();function er(e,t,i,r){const a=e.stageObject,n=a.geometryRecords,s=n.length,o="absolute-height"!==t.mode;let c=0;const l=a.transformation,d=Object(xe.a)(Object(Se.d)(),l);for(let h=0;h<s;h+=2){const e=n[h].geometry,s=e.getMutableAttribute(we.a.POSITION).data,u=e.vertexAttributes.get(we.a.SIZE).data,p=e.vertexAttributes.get(we.a.MAPPOS).data,f=new Ae.a(p),b=s.length/3;let m=0,g=!1,v=0;const O=i.spatialReference;for(let a=0;a<b;a++){Ki[0]=s[m],Ki[1]=s[m+1],Ki[2]=s[m+2],Object(Te.g)(f,i,t,r,rr),o&&(v+=rr.sampledElevation),Ee.a.TESTS_DISABLE_OPTIMIZATIONS?(Object(F.w)(tr,f.array[f.offset+0],f.array[f.offset+1],rr.z+u[m/3]),r.toRenderCoords(tr,O,tr),Object(F.q)(tr,tr,d)):(Object(F.w)(tr,s[m+0],s[m+1],s[m+2]),Object(F.q)(tr,tr,l),r.setAltitude(tr,rr.z+u[m/3]),Object(F.q)(tr,tr,d)),s[m]=tr[0],s[m+1]=tr[1],s[m+2]=tr[2];const e=sr/r.unitInMeters;(Math.abs(Ki[0]-s[m])>=e||Math.abs(Ki[1]-s[m+1])>=e||Math.abs(Ki[2]-s[m+2])>=e)&&(g=!0),f.offset+=3,m+=3}g&&(e.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(n[h]),n[h+1].geometry.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(n[h+1])),c+=v/b}return c/s}const tr=Object(z.f)(),ir=Object(z.f)(),rr=new Te.a,ar=[0,2,1],nr=[0,1,2],sr=.01;var or=i(98),cr=i(271),lr=i(972),dr=i(431),hr=i(494),ur=i(896);class pr{constructor(e,t,i){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this._graphicsCoreOwner=null,this.isElevationSource=!1}initialize(e,t,i){this.stage=e,this._graphicsCoreOwner=i,this._overlayRenderer=this._graphicsCoreOwner.view.basemapTerrain.overlayManager.renderer}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._overlayRenderer.addGeometries(this.renderGeometries,this._graphicsCoreOwner,ur.a.Geometry.ADD);if(e||this._addedToStage){for(const e of this.renderGeometries)e.instanceParameters.visible=this._visible;this._overlayRenderer.updateGeometries(this.renderGeometries,this._graphicsCoreOwner,ur.a.State.VISIBILITIES)}}}destroy(){this.stage&&this._addedToStage&&this._overlayRenderer.removeGeometries(this.renderGeometries,this._graphicsCoreOwner,ur.a.Geometry.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=Object(z.f)()){return Object(F.w)(e,0,0,0)}getBoundingBoxObjectSpace(e=Object(G.f)()){return Object(G.h)(e)}addObjectState(e,t){e===$e.d.Highlight&&(this.renderGeometries.forEach((e=>{const i=e.addHighlight();t.addRenderGeometry(e,i,this)})),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._graphicsCoreOwner))}removeObjectState(e){this.renderGeometries.forEach((t=>{e.removeRenderGeometry(t)}))}removeRenderGeometryObjectState(e,t){e.removeHighlight(t),this._addedToStage&&this._overlayRenderer.updateHighlights(this.renderGeometries,this._graphicsCoreOwner)}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.computeAttachmentOrigin(mr)&&(e.draped.origin[0]+=mr[0],e.draped.origin[1]+=mr[1],e.draped.num++)}async getProjectedBoundingBox(e,t,i,r,n){Object(G.h)(n);for(let a=0;a<this.renderGeometries.length;a++){const t=this.renderGeometries[a];this._getRenderGeometryProjectedBoundingRect(t,e,fr,i),Object(G.m)(n,fr)}if(t){let e;Object(G.d)(n,mr);const i=Object(Ce.d)(n,t);try{e=await t.service.queryElevation(mr[0],mr[1],r,i,"ground")}catch(s){}Object(a.k)(e)&&(n[2]=Math.min(n[2],e),n[5]=Math.max(n[5],e))}return n}_getRenderGeometryProjectedBoundingRect(e,t,i,r){if(this.boundingBox)Object(G.w)(br,this.boundingBox);else{const t=e.boundingSphere,i=t[3];br[0]=t[0]-i,br[1]=t[1]-i,br[2]=t[2]-i,br[3]=t[0]+i,br[4]=t[1]+i,br[5]=t[2]+i}return t(br,0,2),this.calculateRelativeScreenBounds&&r.push({location:Object(G.d)(br),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),Object(G.A)(br,i)}}const fr=Object(V.l)(),br=Object(G.f)(),mr=Object(z.f)();var gr=i(116);class vr{constructor(e,t,i,r=2048){this.text=e,this._alignment=t,this._parameters=i,this.maxSize=r,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._displayWidth=null,this._heightMetrics=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${e}`,this._lines=e.split(/\r?\n/)}get displayWidth(){return Math.ceil(this._ensureTextWidth()+2*this.backgroundHorizontalPadding)}get displayHeight(){const e=this.lineSpacing*(this._lines.length-1),t=this.lineHeight;return Math.ceil(e+t+2*this.haloSize+this.backgroundTopPadding+this.backgroundBottomPadding)}get renderedWidth(){return Math.ceil(this._toRenderUnit(this.displayWidth))}get renderedHeight(){return Math.ceil(this._toRenderUnit(this.displayHeight))}get firstRenderedBaselinePosition(){return this._toRenderUnit(this.firstLineYOffset+this.baselinePosition)}get firstLineYOffset(){return this.backgroundTopPadding+this.haloSize}get heightMetrics(){return this._ensureHeightMetrics()}get lineSpacing(){return(this.lineHeight+this.linePadding)*this._parameters.definition.lineSpacingFactor}get lineHeight(){return this.heightMetrics.lineHeight}get linePadding(){return this.lineHeight*xr}get baselinePosition(){return this.heightMetrics.baselinePosition}get renderedFontSize(){return this._toRenderUnit(this.fontSize)}get fontSize(){return this._parameters.definition.size}get renderedHaloSize(){return this._toRenderUnit(this.haloSize)}get haloSize(){return this._parameters.haloSize}get backgroundHorizontalPadding(){return this.hasBackground?this._parameters.definition.background.padding[0]:0}get backgroundVerticalPadding(){return this.hasBackground?this._parameters.definition.background.padding[1]:0}get backgroundTopPadding(){return Math.max(0,this.backgroundVerticalPadding-this.heightMetrics.paddingTop)}get backgroundBottomPadding(){return Math.max(0,this.backgroundVerticalPadding-this.heightMetrics.paddingBottom)}get hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(Object(a.j)(this._renderPixelRatio)){const e=this._parameters.definition.pixelRatio;this.maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this.maxSize/this.displayWidth,this.maxSize/this.displayHeight)):this._renderPixelRatio=e}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case yr.Left:return this.backgroundHorizontalPadding;case yr.Center:return(this.displayWidth-this._lineWidths[e])/2;case yr.Right:return this.displayWidth-this.backgroundHorizontalPadding-this._lineWidths[e]}}render(e,t=0,i=0){e.save();const r=t/=this.renderPixelRatio,a=i/=this.renderPixelRatio,n=this.haloSize,s=this.firstLineYOffset;t+=n,i+=s+this.baselinePosition;const o=this.haloSize>0;o&&this._renderHalo(e,r,a,n,s),this._setFontProperties(e,this.renderedFontSize);for(let c=0;c<this._lines.length;++c){const r=this._lines[c],a=this._getLineXOffset(c);o&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,r,t+a,i),this._renderLineDecoration(e,t+a,i,this._textWidths[c])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,r,t+this._getLineXOffset(c),i),this._renderLineDecoration(e,t+a,i,this._textWidths[c]),i+=this.lineSpacing}if(Ee.a.TEXT_SHOW_BASELINE){e.strokeStyle=Tr,e.setLineDash([2,2]),e.lineWidth=1;let t=a+s;for(let i=0;i<this._lines.length;++i){const i=t+this.baselinePosition;this._drawLine(e,[r,i],[r+this.displayWidth,i]),t+=this.lineSpacing}}if(Ee.a.TEXT_SHOW_BORDER&&(e.strokeStyle=Tr,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[r,a],[this.displayWidth,this.displayHeight])),this.hasBackground){const t=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,r,a,t),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,t,i,r,a=!1){if("none"===this._parameters.definition.font.decoration||0===r)return;const n=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":i+=2*n;break;case"line-through":i-=.33*this.baselinePosition}const s=a?this.haloSize:0;e.strokeStyle=a?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(n+2*s),e.beginPath(),e.moveTo(this._toRenderUnit(t-s),this._toRenderUnit(i)),e.lineTo(this._toRenderUnit(t+r+s),this._toRenderUnit(i)),e.stroke()}_roundedRect(e,t,i,r){t=this._toRenderUnit(t),i=this._toRenderUnit(i);const a=this.renderedWidth,n=this.renderedHeight;0!==r?(r=Object(gr.e)(r,0,Math.floor(n/2)),e.beginPath(),e.moveTo(t,i+r),e.arcTo(t,i,t+r,i,r),e.lineTo(t+a-r,i),e.arcTo(t+a,i,t+a,i+r,r),e.lineTo(t+a,i+n-r),e.arcTo(t+a,i+n,t+a-r,i+n,r),e.lineTo(t+r,i+n),e.arcTo(t,i+n,t,i+n-r,r),e.closePath()):e.rect(t,i,a,n)}_renderHalo(e,t,i,r,a){const n=this.renderedWidth,s=this.renderedHeight,o=_r(jr,Math.max(n,Sr),Math.max(s,Sr)),c=o.getContext("2d");c.clearRect(0,0,n,s),this._setFontProperties(c,this.renderedFontSize),c.fillStyle=this._parameters.haloStyle,c.strokeStyle=this._parameters.haloStyle;const l=this.renderedHaloSize<3;c.lineJoin=l?"miter":"round",l?this._renderHaloEmulated(c,r,a):this._renderHaloNative(c,r,a);let d=a+this.baselinePosition;for(let h=0;h<this._lines.length;++h){const e=this._getLineXOffset(h);this._renderLineDecoration(c,r+e,d,this._textWidths[h],!0),d+=this.lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(o,0,0,n,s,this._toRenderUnit(t),this._toRenderUnit(i),n,s),e.globalAlpha=1}_renderHaloEmulated(e,t,i){i+=this.baselinePosition;for(let r=0;r<this._lines.length;++r){const a=this._lines[r],n=this._getLineXOffset(r);for(const[r,s]of Or)this._fillText(e,a,t+n+this.haloSize*r,i+this.haloSize*s);i+=this.lineSpacing}}_renderHaloNative(e,t,i){const r=2*this.haloSize;i+=this.baselinePosition;for(let a=0;a<this._lines.length;++a){const n=this._lines[a],s=this._getLineXOffset(a),o=5,c=.1;for(let a=0;a<o;a++){const l=1-(o-1)*c+a*c;e.lineWidth=this._toRenderUnit(l*r),this._strokeText(e,n,t+s,i)}i+=this.lineSpacing}}_setFontProperties(e,t){e.font=this._parameters.fontString(t),e.textAlign="left",e.textBaseline="alphabetic"}_ensureTextWidth(){if(Object(a.k)(this._displayWidth))return this._displayWidth;const e=_r(jr,Sr,Sr).getContext("2d");this._setFontProperties(e,this.fontSize);let t=2*this.haloSize;const i=this._parameters.definition.font;"italic"!==i.style&&"oblique"!==i.style&&"bold"!==i.weight&&"bolder"!==i.weight||(t+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let r=0;for(const a of this._lines){const i=e.measureText(a).width,n=i+t;this._textWidths.push(i),this._lineWidths.push(n),r=Math.max(r,n)}return this._displayWidth=r,this._displayWidth}_ensureHeightMetrics(){if(Object(a.j)(this._heightMetrics)){const e=_r(jr,Sr,Sr).getContext("2d");this._setFontProperties(e,this.fontSize);const t=e.measureText(this.text+Cr),i=this.hasBackground?e.measureText(this._lines[0]):t,r=1===this._lines.length?i:this.hasBackground?e.measureText(this._lines[this._lines.length-1]):t,a=t.actualBoundingBoxAscent+t.actualBoundingBoxDescent;this._heightMetrics={paddingTop:t.actualBoundingBoxAscent-i.actualBoundingBoxAscent,paddingBottom:t.actualBoundingBoxDescent-r.actualBoundingBoxDescent,lineHeight:a,baselinePosition:t.actualBoundingBoxAscent}}return this._heightMetrics}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,t,i,r){e.fillText(t,this._toRenderUnit(i),this._toRenderUnit(r))}_strokeText(e,t,i,r){e.strokeText(t,this._toRenderUnit(i),this._toRenderUnit(r))}_drawLine(e,t,i){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(t[0])+.5,this._toRoundedRenderUnit(t[1])+.5),e.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),e.stroke()}_drawBox(e,t,i){const r=this._toRenderUnit(t[0]),a=this._toRenderUnit(t[1]),n=this._toRenderUnit(i[0]),s=this._toRenderUnit(i[1]),o=Math.floor(r)+.5,c=Math.ceil(r+n)-.5,l=Math.floor(a)+.5,d=Math.ceil(a+s)-.5;e.beginPath(),e.moveTo(o,l),e.lineTo(c,l),e.lineTo(c,d),e.lineTo(o,d),e.lineTo(o,l),e.stroke()}}const Or=[];{const e=16;for(let t=0;t<360;t+=360/e)Or.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}var yr;function _r(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}!function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"}(yr||(yr={}));const jr={canvas:null},xr=.2,Sr=512,Tr="rgb(255, 0, 255, 0.5)",Cr=(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t);return e})(),Er={left:0,center:.5,right:1},Ar={"bottom-left":Object(gi.e)(0,0),bottom:Object(gi.e)(.5,0),"bottom-right":Object(gi.e)(1,0),left:Object(gi.e)(0,.5),center:Object(gi.e)(.5,.5),right:Object(gi.e)(1,.5),"top-left":Object(gi.e)(0,1),top:Object(gi.e)(.5,1),"top-right":Object(gi.e)(1,1)};function wr(e){return"justify"===e?"center":e}function Rr(e){return"middle"===e?"center":e}var Pr,Ir,Dr,Mr=i(895),Lr=i(246);function Nr(e){return null!=e}function Fr(e){return"number"==typeof e}function zr(e){return"string"==typeof e}function Ur(e,t){e&&e.push(t)}function Gr(e,t,i,r,a){const n=e.minSize,s=e.maxSize;if(e.expression)return Ur(a,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){const e=r.symbolSize[i];return t.minSize[i]=e,t.maxSize[i]=e,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=Pr.DefinedSize,!0}if(Nr(e.field))return Nr(e.stops)?2===e.stops.length&&Fr(e.stops[0].size)&&Fr(e.stops[1].size)?(Vr(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=Pr.DefinedSize,!0):(Ur(a,"Could not convert size info: stops only supported with 2 elements"),!1):Fr(n)&&Fr(s)&&Nr(e.minDataValue)&&Nr(e.maxDataValue)?(Vr(n,s,e.minDataValue,e.maxDataValue,t,i),t.type[i]=Pr.DefinedSize,!0):null!=Lr.a[e.valueUnit]?(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/Lr.a[e.valueUnit],t.type[i]=Pr.DefinedSize,!0):"unknown"===e.valueUnit?(Ur(a,"Could not convert size info: proportional size not supported"),!1):(Ur(a,"Could not convert size info: scale-dependent size not supported"),!1);if(!Nr(e.field)){if(e.stops&&e.stops[0]&&Fr(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=Pr.DefinedSize,!0;if(Fr(n))return t.minSize[i]=n,t.maxSize[i]=n,t.offset[i]=n,t.factor[i]=0,t.type[i]=Pr.DefinedSize,!0}return Ur(a,"Could not convert size info: unsupported variant of sizeInfo"),!1}function Vr(e,t,i,r,a,n){const s=Math.abs(r-i)>0?(t-e)/(r-i):0;a.minSize[n]=s>0?e:t,a.maxSize[n]=s>0?t:e,a.offset[n]=e-i*s,a.factor[n]=s}function Br(e,t,i,r){if(e.normalizationField||e.valueRepresentation)return Ur(r,"Could not convert size info: unsupported property"),null;if(!function(e){return null==e||zr(e)}(e.field))return Ur(r,"Could not convert size info: field is not a string"),null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return Ur(r,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[Pr.Undefined,Pr.Undefined,Pr.Undefined]};let a;switch(e.axis){case"width":return a=Gr(e,t.size,0,i,r),a?t:null;case"height":return a=Gr(e,t.size,2,i,r),a?t:null;case"depth":return a=Gr(e,t.size,1,i,r),a?t:null;case"width-and-depth":return a=Gr(e,t.size,0,i,r),a&&Gr(e,t.size,1,i,r),a?t:null;case null:case void 0:case"all":return a=Gr(e,t.size,0,i,r),a=a&&Gr(e,t.size,1,i,r),a=a&&Gr(e,t.size,2,i,r),a?t:null;default:return Ur(r,`Could not convert size info: unknown axis "${e.axis}""`),null}}function kr(e,t,i){e[4*t+0]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function Hr(e,t,i){const r=2===i&&"arithmetic"===e.rotationType;t.offset[i]=r?90:0,t.factor[i]=r?-1:1,t.type[i]=1}function Wr(e,t,i){if(!e)return null;const r=!t.supportedTypes||!!t.supportedTypes.size,a=!t.supportedTypes||!!t.supportedTypes.color,n=!t.supportedTypes||!!t.supportedTypes.rotation,s=!!t.supportedTypes&&!!t.supportedTypes.opacity,o=e.reduce(((e,o)=>{if(!e)return e;if(o.valueExpression)return Ur(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(o.type){case"size":return r?Br(o,e,t,i):e;case"color":return a?function(e,t,i){if(e.normalizationField)return Ur(i,"Could not convert color info: unsupported property"),null;if(zr(e.field)){if(!e.stops)return Ur(i,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return Ur(i,"Could not convert color info: too many color stops"),null;t.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const r=e.stops;for(let e=0;e<8;++e){const i=r[Math.min(e,r.length-1)];t.color.values[e]=i.value,kr(t.color.colors,e,i.color)}}}else{if(!(e.stops&&e.stops.length>=0))return Ur(i,"Could not convert color info: no field and no colors/stops"),null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.color.values[e]=1/0,kr(t.color.colors,e,i)}}return t}(o,e,i):e;case"opacity":return s?function(e,t,i){if(e.normalizationField)return Ur(i,"Could not convert opacity info: unsupported property"),null;if(zr(e.field)){if(!e.stops)return Ur(i,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return Ur(i,"Could not convert opacity info: too many opacity stops"),null;t.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const r=e.stops;for(let e=0;e<8;++e){const i=r[Math.min(e,r.length-1)];t.opacity.values[e]=i.value,t.opacity.opacityValues[e]=i.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return Ur(i,"Could not convert opacity info: no field and no opacities/stops"),null;{const i=e.stops&&e.stops.length>=0&&e.stops[0].opacity;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let e=0;e<8;e++)t.opacity.values[e]=1/0,t.opacity.opacityValues[e]=i}}return t}(o,e,i):null;case"rotation":return n?function(e,t,i){if(!zr(e.field))return Ur(i,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return Ur(i,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return Hr(e,t.rotation,0),t;case"roll":return Hr(e,t.rotation,1),t;case null:case void 0:case"heading":return Hr(e,t.rotation,2),t;default:return Ur(i,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}(o,e,i):e;default:return null}}),{size:null,color:null,opacity:null,rotation:null});return!(e.length>0&&o)||o.size||o.color||o.opacity||o.rotation?o&&o.size&&!function(e,t,i){for(let a=0;a<3;++a){let i=t.unitInMeters;e.type[a]===Pr.DefinedSize&&(i*=t.modelSize[a],e.type[a]=Pr.DefinedScale),e.minSize[a]=e.minSize[a]/i,e.maxSize[a]=e.maxSize[a]/i,e.offset[a]=e.offset[a]/i,e.factor[a]=e.factor[a]/i}let r;if(e.type[0]!==Pr.Undefined)r=0;else if(e.type[1]!==Pr.Undefined)r=1;else{if(e.type[2]===Pr.Undefined)return Ur(i,"No size axis contains a valid size or scale"),!1;r=2}for(let a=0;a<3;++a)e.type[a]===Pr.Undefined&&(e.minSize[a]=e.minSize[r],e.maxSize[a]=e.maxSize[r],e.offset[a]=e.offset[r],e.factor[a]=e.factor[r],e.type[a]=e.type[r]);return!0}(o.size,t,i)?null:o:null}function qr(e){return e&&null!=e.size}function $r(e,t){if(!e)return{enabled:!1};if(Ee.a.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};const i=Wr(e.visualVariables,t);return i?{enabled:!0,visualVariables:i,materialParameters:Zr(i,t),requiresShaderTransformation:qr(i)}:{enabled:!1}}function Xr(e,t,i){if(!t||!e.enabled)return!1;const r=e.visualVariables,a=Wr(t.visualVariables,i);return!!a&&!!(Yr(r.size,a.size,"size")&&Yr(r.color,a.color,"color")&&Yr(r.rotation,a.rotation,"rotation")&&Yr(r.opacity,a.opacity,"opacity"))&&(e.visualVariables=a,e.materialParameters=Zr(a,i),e.requiresShaderTransformation=qr(a),!0)}function Yr(e,t,i){if(!!e!=!!t)return!1;if(e&&e.field!==t.field)return!1;if(e&&"rotation"===i){const i=e,r=t;for(let e=0;e<3;e++)if(i.type[e]!==r.type[e]||i.offset[e]!==r.offset[e]||i.factor[e]!==r.factor[e])return!1}return!0}function Zr(e,t){const i={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},r=qr(e);return e&&e.size?(i.vvSizeEnabled=!0,i.vvSizeMinSize=e.size.minSize,i.vvSizeMaxSize=e.size.maxSize,i.vvSizeOffset=e.size.offset,i.vvSizeFactor=e.size.factor):e&&r&&(i.vvSizeValue=t.transformation.scale),e&&r&&(i.vvSymbolAnchor=t.transformation.anchor,i.vvSymbolRotationMatrix=Object(Ti.b)(),Object(xe.i)(Qr),function(e,t,i,r=Object(Se.d)()){const a=e||0,n=t||0,s=i||0;0!==a&&Object(xe.g)(r,r,-a/180*Math.PI),0!==n&&Object(xe.r)(r,r,n/180*Math.PI),0!==s&&Object(xe.o)(r,r,s/180*Math.PI)}(t.transformation.rotation[2],t.transformation.rotation[0],t.transformation.rotation[1],Qr),Object(Si.f)(i.vvSymbolRotationMatrix,Qr)),e&&e.color&&(i.vvColorEnabled=!0,i.vvColorValues=e.color.values,i.vvColorColors=e.color.colors),e&&e.opacity&&(i.vvOpacityEnabled=!0,i.vvOpacityValues=e.opacity.values,i.vvOpacityOpacities=e.opacity.opacityValues),i}!function(e){e[e.Undefined=0]="Undefined",e[e.DefinedSize=1]="DefinedSize",e[e.DefinedScale=2]="DefinedScale"}(Pr||(Pr={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedAngle=1]="DefinedAngle"}(Ir||(Ir={})),function(e){const t=Object(Se.d)(),i=Object(z.f)();e.evaluateModelTransform=function(e,r,a){if(!e.vvSizeEnabled)return a;Object(xe.c)(t,a);const n=e.vvSymbolRotationMatrix;Object(xe.s)(Qr,n[0],n[1],n[2],0,n[3],n[4],n[5],0,n[6],n[7],n[8],0,0,0,0,1),Object(xe.m)(t,t,Qr);for(let t=0;t<3;++t){const a=e.vvSizeOffset[t]+r[0]*e.vvSizeFactor[t];i[t]=Object(gr.e)(a,e.vvSizeMinSize[t],e.vvSizeMaxSize[t])}return Object(xe.h)(t,t,i),Object(xe.j)(t,t,e.vvSymbolAnchor),t},e.evaluateModelTransformScale=function(e,t,i){if(!t.vvSizeEnabled)return Object(F.w)(e,1,1,1);for(let r=0;r<3;++r){const a=t.vvSizeOffset[r]+i[0]*t.vvSizeFactor[r];e[r]=Object(gr.e)(a,t.vvSizeMinSize[r],t.vvSizeMaxSize[r])}return e}}(Dr||(Dr={}));const Qr=Object(Se.d)(),Jr=Dr.evaluateModelTransform,Kr=Dr.evaluateModelTransformScale;var ea=i(963),ta=i(750),ia=i(1104),ra=i(430);const aa=Object(Se.d)(),na=Object(z.h)(0,0,1),sa=Mr.a,oa=[sa/2,sa/2,1-sa/2,1-sa/2],ca=[Mr.b*sa,Mr.b*sa];class la extends St{constructor(e,t,i,r){super(e,t,i,r),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}getCachedSize(){return{size:this._getIconSize()}}async doLoad(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),i=this._getPrimitive();if(Object(a.k)(i))this._prepareResourcesPrimitive(t,i);else{const i=Object(dr.g)(this.symbol,this.symbolLayer),r=Object(or.h)(i);r&&"application/json"===r.mediaType?await this._prepareResourcesCIM(t,JSON.parse(r.data),e):await this._prepareResourcesHref(t,i,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=Object(Ce.i)(this._getIconSize());if(e)throw new P.a("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,t=Math.round(null!=e.size?Object(je.g)(e.size):16);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e){const t=this._getGraphicHash(e);let i=""===t?null:this._cimSymbolTextures.get(t);if(!i){const r={scaleFactor:this._cimScaleFactorOrFunction},a=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,e,"esriGeometryPoint",r,null,null);this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",a.anchorPosition);const n={width:a.imageData.width,height:a.imageData.height,powerOfTwoResizeMode:$e.e.PAD};i=new ta.a(a.imageData,n),this._cimSymbolTextures.set(t,i),this._context.stage.add(i)}return i}_computeSize(e,t){const i=e.width/e.height;return i>1?[t,Math.round(t/i)]:[Math.round(t*i),t]}_prepareMaterialParameters(){const e={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if(function(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()}(t)){const{screenLength:i,minWorldLength:r,maxWorldLength:a}=t.verticalOffset;e.verticalOffset={screenLength:Object(je.g)(i),minWorldLength:r||0,maxWorldLength:null!=a?a:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){const i=this._getOutlineSize();if(da(t)&&0===i)throw new Error("Nothing to render");this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize;const r=this._context.sharedResources.textures.fromData(t,(()=>Object(Mr.c)(t)));this._texture=r.texture,this._releaseTexture=r,e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=oa,e.textureId=this._texture.id;const a=this._getIconSize();this._size=[a,a],this._symbolTextureRatio=1/sa,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(e,t,i){if(!Object(c.a)("esri-canvas-svg-support")&&Object(or.z)(t))throw new P.a("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const r=this._getIconSize(),a=r*this._context.graphicsCoreOwner.view.pixelRatio,n=await Object(ye.c)(this._context.sharedResources.textures.fromUrl(t,a,{signal:i}));if(!1===n.ok)throw Object(v.s)(n.error),new P.a("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${t})`);this._releaseTexture=n.value;const s=n.value.texture,o=s.params;this._size=this._computeSize(o,r),e.textureId=s.id,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesCIM(e,t,r){const a=new ra.a({data:t});if(!this._context.sharedResources.cimSymbolRasterizer){const e=(await Promise.all([i.e(13),i.e(47)]).then(i.bind(null,1247))).CIMSymbolRasterizer;Object(v.t)(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference,!0))}const n=this._context.layer.fields?this._context.layer.fields.map((e=>e.toJSON())):null;let s,o;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(a,n,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(isNaN(e.scaleExpression)){const t=e.scaleExpression,i=await Object(H.d)(t,this._context.layer.spatialReference,n);o=(e,t,r)=>{const a=Object(hr.a)(i,e,{$view:r},"esriGeometryPoint",t);return null!==a?a:1}}else s=Number(e.scaleExpression)}this._cimScaleFactorOrFunction=s||o||1;const c=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];Object(v.t)(r);const l=this._context.layer.fieldsIndex;this._cimRequiredFields=c.map((e=>l.get(e).name)),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||lr.b}_getOutlineSize(){let e=0;const t=this.symbolLayer;return Object(a.k)(t.outline)&&null!=t.outline.size?Math.max(Object(je.g)(t.outline.size),0):(e=da(this._getPrimitive())?1.5:0,Math.max(e,0))}_getOutlineColor(){const e=this._getLayerOpacity(),t=this.symbolLayer,i=Object(a.i)(t,"outline","color");if(Object(a.k)(i)){const t=j.a.toUnitRGB(i),r=i.a*e;return[t[0],t[1],t[2],r]}return[0,0,0,0]}_getFillColor(){if(da(this._getPrimitive()))return A.b;const e=Object(a.j)(this._getPrimitive()),t=Object(a.i)(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}_getAnchorPos(e,t){return"relative"===e?Object(gi.e)((t.x||0)+.5,.5-(t.y||0)):e in Ar?Ar[e]:Ar.center}_createMaterialAndAddToStage(e,t){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=$r(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(e,this._fastUpdates.materialParameters),this._cimLayers){let i=this._cimSymbolMaterials.get(e.textureId);return i||(i=new ia.a(e),this._cimSymbolMaterials.set(e.textureId,i),t.add(i)),i}return this._material=new ia.a(e),t.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial((e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0,isDraped:this.draped})})),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial((e=>this._context.stage.remove(e))),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach((e=>this._context.stage.remove(e))),this._cimSymbolTextures.clear(),this._releaseTexture=Object(a.q)(this._releaseTexture)}_getScaleFactor(e,t){if(this._drivenProperties.size&&e.size){for(let t=0;t<3;t++){const i=e.size[t];i&&"symbol-value"!==i&&"proportional"!==i&&(e.size[t]=Object(je.g)(i))}if("symbol-value"===e.size[0])return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let i,r;if(this._cimLayers){if(!this._cimLayers.length)return null;const e=this._generateTextureCIM(t),a={textureId:e.id,...this._cimMaterialParametersInfo};r=this._createMaterialAndAddToStage(a,this._context.stage),i=[e.params.width,e.params.height]}else i=this._size,r=Object(a.s)(this._material);const n=Object(Rt.d)(t.geometry);if(Object(a.j)(n))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const s=e.renderingInfo,o=this._getVertexOpacityAndColor(s);let c=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const e=i[0]>i[1]?i[0]:i[1];c=this._getScaleFactor(s,e)}c*=this._symbolTextureRatio;const l=[i[0]*c,i[1]*c],d=this.setGraphicElevationContext(t,new We.a);return this.ensureDrapedStatus("on-the-ground"===d.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,n,r,o,l,e.layer.uid):this._createAs3DShape(t,n,r,o,l,d,t.uid)}layerOpacityChanged(){const e=this._getFillColor(),t=this._getOutlineColor();return this._forEachMaterial((i=>{i.setParameters({color:e}),i.setParameters({outlineColor:t})})),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=Object(Te.e)(la.elevationModeChangeTypes,i,r);if(a!==Te.b.UPDATE)return a;const n=Object(Te.h)(r)||"absolute-height"===r;return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial((e=>{e.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return et.Recreate_Symbol;if(!Xr(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return et.Recreate_Symbol;Object(a.k)(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters)}return et.Fast_Update}_defaultElevationInfoNoZ(){return ha}_createAs3DShape(e,t,i,r,a,n,s){const o=this.getFastUpdateAttrValues(e),c=o?e=>Jr(this._fastUpdates.materialParameters,o,e):null,l=[ct.a.createPointGeometry(na,null,r,a,ua,null,o)],d=Object(Rt.a)(this._context,t,l,[i],n,this._context.layer.uid,s,c);if(null===d)return null;const h=new Xe(this,d.object,l,null,null,Pe,n);return h.alignedSampledElevation=d.sampledElevation,h.needsElevationUpdates=Object(Te.h)(n.mode)||"absolute-height"===n.mode,h.getScreenSize=this._createScreenSizeGetter(a,c),h.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(h.getScreenSize(),1,e),Object(Rt.b)(h,t,this._context.elevationProvider),h}_createAsOverlay(e,t,i,r,n,s){i.renderPriority=this._renderPriority;const o=Object(at.e)();Object(U.o)(t,o,this._context.overlaySR),o[2]=Ri.a;const c=this._context.clippingExtent;if(Object(a.k)(c)&&!Object(G.e)(c,o))return null;const l=this.getFastUpdateAttrValues(e),d=l?e=>Jr(this._fastUpdates.materialParameters,l,e):null,h=ct.a.createPointGeometry(na,o,r,n,null,null,l),u=new ea.a(h,i,{layerUid:s,graphicUid:e.uid,calculateShaderTransformation:d});o[3]=0,Object(cr.c)(u.boundingSphere,o);const p=new pr(this,[u],null);return p.getScreenSize=this._createScreenSizeGetter(n,d),p.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(p.getScreenSize(),1,e),p}_createScreenSizeGetter(e,t){const i=this._outlineSize+2;if(this._fastUpdates.enabled){const r=e[0]/this._symbolTextureRatio,a=e[1]/this._symbolTextureRatio;return(e=Object(gi.a)())=>{const n=t(aa);return e[0]=n[0]*r+i,e[1]=n[5]*a+i,e}}{const t=e[0]/this._symbolTextureRatio+i,r=e[1]/this._symbolTextureRatio+i;return(e=Object(gi.a)())=>(e[0]=t,e[1]=r,e)}}_fastVisualVariableConvertOptions(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=Object(z.h)(e,e,e),i=Object(je.h)(1),r=e*i;return{modelSize:t,symbolSize:Object(z.h)(r,r,r),unitInMeters:i,transformation:{anchor:z.c,scale:z.a,rotation:z.c}}}_getGraphicHash(e){let t="";for(const i of this._cimRequiredFields)t+=i+e.attributes[i];return t}_forEachMaterial(e){Object(a.k)(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)}get test(){return{material:this._material}}}function da(e){return!!Object(a.k)(e)&&("cross"===e||"x"===e)}la.PRIMITIVE_SIZE=ca,la.elevationModeChangeTypes={definedChanged:Te.b.UPDATE,staysOnTheGround:Te.b.NONE,onTheGroundChanged:Te.b.RECREATE};const ha={mode:"relative-to-ground",offset:0},ua=Object(at.g)(0,0,0,1);var pa=i(1003),fa=i(1148),ba=i(621),ma=i(856),ga=i(1001),va=i(288),Oa=i(420),ya=i(356),_a=i(623),ja=i(445),xa=i(654),Sa=i(1149);const Ta=new Map([[we.a.POSITION,0],[we.a.UV0,2],[we.a.AUXPOS1,3],[we.a.SIZE,6],[we.a.SIZEFEATUREATTRIBUTE,6],[we.a.COLOR,5],[we.a.COLORFEATUREATTRIBUTE,5],[we.a.OPACITYFEATUREATTRIBUTE,7]]);class Ca extends Wt.a{constructor(e,t,i){super(e,t,i)}initializeProgram(e){const t=Ca.shader.get(),i=this.configuration,r=t.build({oitEnabled:i.transparencyPassType===$e.i.Color,output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:i.draped,vvColor:i.vvColor,vvSize:i.vvSize,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new Xt.a(e.rctx,r,Ta)}bindPass(e,t){Object(kt.b)(this.program,t.camera.projectionMatrix),this.configuration.output===Lt.a.Highlight&&Object(Oa.b)(this.program,t),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(ya.a)(this.program,t)),this.program.setUniform1f("intrinsicWidth",e.width),this.program.setUniform4fv("intrinsicColor",e.color),this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio),this.program.setUniform2f("screenSize",t.camera.fullViewport[2],t.camera.fullViewport[3]),Object(_a.d)(this.program,e)}bindDraw(e){Object(kt.c)(this.program,e),Object(Gt.b)(this.program,this.configuration,e.slicePlane,{origin:e.origin,view:e.camera.viewMatrix}),this.program.setUniformMatrix4fv("inverseProjectionMatrix",Object(xe.a)(va.a.get(),e.camera.projectionMatrix)),this.program.rebindTextures()}_makePipelineState(e,t){const i=this.configuration,r=e===$e.i.NONE;return Object(Jt.f)({blending:i.output===Lt.a.Color||i.output===Lt.a.Alpha?r?ja.d:Object(ja.f)(e):null,depthTest:{func:Object(ja.g)(e)},depthWrite:r?i.writeDepth&&Jt.d:Object(ja.h)(e),colorWrite:Jt.c,stencilWrite:i.sceneHasOcludees?xa.h:null,stencilTest:i.sceneHasOcludees?t?xa.d:xa.c:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=Object(Jt.f)({blending:ja.d,depthTest:xa.a,depthWrite:null,colorWrite:Jt.c,stencilWrite:null,stencilTest:xa.f}),this._occluderPipelineOpaque=Object(Jt.f)({blending:ja.d,depthTest:xa.a,depthWrite:null,colorWrite:Jt.c,stencilWrite:xa.g,stencilTest:xa.e}),this._occluderPipelineMaskWrite=Object(Jt.f)({blending:null,depthTest:xa.b,depthWrite:null,colorWrite:null,stencilWrite:xa.h,stencilTest:xa.d})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===zt.a.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===zt.a.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,t)}}Ca.shader=new Ht.a(Sa.a,(()=>i.e(331).then(i.bind(null,1360))));class Ea extends qt.a{constructor(){super(...arguments),this.output=Lt.a.Color,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.writeDepth=!1,this.draped=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.sceneHasOcludees=!1,this.transparencyPassType=$e.i.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(r.a)([Object(qt.b)({count:Lt.a.COUNT})],Ea.prototype,"output",void 0),Object(r.a)([Object(qt.b)()],Ea.prototype,"occluder",void 0),Object(r.a)([Object(qt.b)()],Ea.prototype,"slicePlaneEnabled",void 0),Object(r.a)([Object(qt.b)()],Ea.prototype,"transparent",void 0),Object(r.a)([Object(qt.b)()],Ea.prototype,"writeDepth",void 0),Object(r.a)([Object(qt.b)()],Ea.prototype,"draped",void 0),Object(r.a)([Object(qt.b)()],Ea.prototype,"vvSize",void 0),Object(r.a)([Object(qt.b)()],Ea.prototype,"vvColor",void 0),Object(r.a)([Object(qt.b)()],Ea.prototype,"vvOpacity",void 0),Object(r.a)([Object(qt.b)()],Ea.prototype,"sceneHasOcludees",void 0),Object(r.a)([Object(qt.b)({count:$e.i.COUNT})],Ea.prototype,"transparencyPassType",void 0),Object(r.a)([Object(qt.b)()],Ea.prototype,"multipassTerrainEnabled",void 0),Object(r.a)([Object(qt.b)()],Ea.prototype,"cullAboveGround",void 0);class Aa extends It.b{constructor(e){super(e,Ra),this._vertexAttributeLocations=Ta,this.techniqueConfig=new Ea,this.layout=this.createLayout()}dispose(){}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.draped=t.slot===zt.a.DRAPED_MATERIAL,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.occluder=this.parameters.renderOccluded===It.c.OccludeAndTransparentStencil,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}intersect(){}createLayout(){const e=Object(Mt.a)().vec3f(we.a.POSITION).vec2f(we.a.UV0).vec3f(we.a.AUXPOS1);return this.parameters.vvSizeEnabled?e.f32(we.a.SIZEFEATUREATTRIBUTE):e.f32(we.a.SIZE),this.parameters.vvColorEnabled?e.f32(we.a.COLORFEATUREATTRIBUTE):e.vec4f(we.a.COLOR),this.parameters.vvOpacityEnabled&&e.f32(we.a.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new Pa(this.layout,this.parameters)}requiresSlot(e,t){if(e===zt.a.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===It.c.OccludeAndTransparentStencil)return e===zt.a.OPAQUE_MATERIAL||e===zt.a.OCCLUDER_MATERIAL||e===zt.a.TRANSPARENT_OCCLUDER_MATERIAL;const i=Object(ba.b)(t);return i===Lt.a.Color||i===Lt.a.Alpha?e===(this.parameters.writeDepth?zt.a.TRANSPARENT_MATERIAL:zt.a.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===zt.a.OPAQUE_MATERIAL}createGLMaterial(e){return e.output===Lt.a.Color||e.output===Lt.a.Alpha||e.output===Lt.a.Highlight||e.output===Lt.a.Depth?new wa(e):null}validateParameters(e){e.color&&e.color[3]<1&&(e.transparent=!0)}}class wa extends ma.a{constructor(e){super({...e,...e.material.parameters})}updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this.ensureTechnique(Ca,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output!==Lt.a.Color&&this._output!==Lt.a.Alpha||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){this.bindTextures(t.program),this.bindTextureScale(t.program),t.bindPass(this._material.parameters,e)}}const Ra={width:0,color:[1,1,1,1],placement:"end",textureId:null,writeDepth:!0,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,sceneHasOcludees:!1,...It.a,...ga.a};class Pa{constructor(e,t){this.vertexBufferLayout=e,this.parameters=t}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(){return"begin-end"===this.parameters.placement?12:6}write(e,t,i,r){const a=t.vertexAttributes.get(we.a.POSITION).data,n=a.length/3;let s=1,o=0;this.parameters.vvSizeEnabled?o=t.vertexAttributes.get(we.a.SIZEFEATUREATTRIBUTE).data[0]:t.vertexAttributes.has(we.a.SIZE)&&(s=t.vertexAttributes.get(we.a.SIZE).data[0]);let c=[1,1,1,1],l=0;this.parameters.vvColorEnabled?l=t.vertexAttributes.get(we.a.COLORFEATUREATTRIBUTE).data[0]:t.vertexAttributes.has(we.a.COLOR)&&(c=t.vertexAttributes.get(we.a.COLOR).data);let d=0;this.parameters.vvOpacityEnabled&&(d=t.vertexAttributes.get(we.a.OPACITYFEATUREATTRIBUTE).data[0]);const h=e.transformation,u=new Float32Array(i.buffer);let p=r*(this.vertexBufferLayout.stride/4);const f=(e,t,i,r)=>{if(u[p++]=e[0],u[p++]=e[1],u[p++]=e[2],u[p++]=i[0],u[p++]=i[1],u[p++]=t[0],u[p++]=t[1],u[p++]=t[2],this.parameters.vvSizeEnabled?u[p++]=o:u[p++]=s,this.parameters.vvColorEnabled)u[p++]=l;else{const e=Math.min(4*r,c.length-4);u[p++]=c[e+0],u[p++]=c[e+1],u[p++]=c[e+2],u[p++]=c[e+3]}this.parameters.vvOpacityEnabled&&(u[p++]=d)};let b;!function(e){e[e.ASCENDING=1]="ASCENDING",e[e.DESCENDING=-1]="DESCENDING"}(b||(b={}));const m=(e,t)=>{const i=Object(F.w)(Ia,a[3*e],a[3*e+1],a[3*e+2]),r=Da;let s=e+t;do{Object(F.w)(r,a[3*s],a[3*s+1],a[3*s+2]),s+=t}while(Object(F.C)(i,r)&&s>=0&&s<n);h&&(Object(F.q)(i,i,h),Object(F.q)(r,r,h)),f(i,r,[-1,-1],e),f(i,r,[1,-1],e),f(i,r,[1,1],e),f(i,r,[-1,-1],e),f(i,r,[1,1],e),f(i,r,[-1,1],e)},g=this.parameters.placement;"begin"!==g&&"begin-end"!==g||m(0,b.ASCENDING),"end"!==g&&"begin-end"!==g||m(n-1,b.DESCENDING)}}const Ia=Object(z.f)(),Da=Object(z.f)();var Ma=i(1085),La=i(777);const Na=["polyline","polygon","extent"];class Fa extends St{constructor(e,t,i,r){super(e,t,i,r),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=$r(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const e=null!=this.symbolLayer.size?this.symbolLayer.size:Object(je.h)(1);if(e<0)throw new P.a("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=e}this._markerTexture=Object(fa.c)(this._context.sharedResources.textures,this.symbolLayer.marker)}_getMaterialParameters(e,t=!1){var i;const r=Object(a.b)(this.symbolLayer.marker,(e=>e.color)),n=Object(a.b)(this.symbolLayer.material,(e=>e.color)),s=this._getCombinedOpacityAndColor(t&&r||n);this._patternHidesLine&&!t&&(s[3]=0);const o=s[3],c={width:this._computeMaterialWidth(null==(i=this.symbolLayer)?void 0:i.size),color:s,polygonOffset:!0,join:this.symbolLayer.join||"miter",cap:Object(pa.e)(this.symbolLayer.cap||"butt"),transparent:o<1||this.needsDrivenTransparentPass,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:Object(Ma.b)(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?{...c,...this._fastUpdates.materialParameters}:c}get lineMaterial(){return Object(a.j)(this._lineMaterial)&&(this._lineMaterial=new La.a(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}get ringMaterial(){return Object(a.j)(this._ringMaterial)&&(this._ringMaterial=new La.a(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}get wireframeLineMaterial(){return Object(a.j)(this._wireframeLineMaterial)&&(this._wireframeLineMaterial=new La.a({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterial)),this._wireframeLineMaterial}get wireframeRingMaterial(){return Object(a.j)(this._wireframeRingMaterial)&&(this._wireframeRingMaterial=new La.a({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterial)),this._wireframeRingMaterial}get markerMaterial(){return Object(a.j)(this._markerMaterial)&&Object(a.k)(this.symbolLayer.marker)&&Object(a.k)(this._markerTexture)&&(this._markerMaterial=new Aa({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id}),this._context.stage.add(this._markerMaterial)),this._markerMaterial}destroy(){super.destroy(),this._forEachMaterial((e=>this._context.stage.remove(e))),this._lineMaterial=null,this._ringMaterial=null,this._wireframeLineMaterial=null,this._wireframeRingMaterial=null,this._markerMaterial=null,this._markerTexture=Object(a.q)(this._markerTexture)}_getDrivenSize(e){return this._drivenProperties.size&&e.size?Object(je.g)(function(e){for(let t=0;t<3;t++){const i=e[t];if("number"==typeof i)return isFinite(i)?i:0}return 0}(e.size)):1}_getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?Tt(this._fastUpdates.visualVariables.size.field,e):null}_getDrivenColor(e){const t=Object(at.g)(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}_getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?Tt(this._fastUpdates.visualVariables.color.field,e):null}_getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?Tt(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Na,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new We.a);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,t.uid)}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return et.Recreate_Symbol;if(!Xr(this._fastUpdates,t,this._vvConvertOptions))return et.Recreate_Symbol;this._forEachMaterial((e=>e.setParameters(this._fastUpdates.materialParameters)))}return et.Fast_Update}prepareSymbolLayerPatch(e){var t,i;if("partial"!==e.diff.type)return;const r=e.diff.diff,n={};"complete"===(null==(t=r.size)?void 0:t.type)&&(n.width=this._computeMaterialWidth(r.size.newValue),delete r.size),"complete"===(null==(i=r.cap)?void 0:i.type)&&(n.cap=Object(pa.e)(Object(a.t)(r.cap.newValue,"butt")),delete r.cap);const s=this._prepareMarkerPatch(e,r);this._prepareMaterialPatch(e,r,s),e.symbolLayerStatePatches.push((()=>this._forEachMaterial((e=>e.setParameters(n)))))}layerOpacityChanged(){return this._forEachMaterial(((e,t)=>this._updateMaterialLayerOpacity(e,t))),!0}_forEachMaterial(e){Object(a.k)(this._lineMaterial)&&e(this._lineMaterial),Object(a.k)(this._ringMaterial)&&e(this._ringMaterial),Object(a.k)(this._wireframeLineMaterial)&&e(this._wireframeLineMaterial),Object(a.k)(this._wireframeRingMaterial)&&e(this._wireframeRingMaterial),Object(a.k)(this._markerMaterial)&&e(this._markerMaterial,!0)}_updateMaterialLayerOpacity(e,t=!1){const i=e.parameters.color,r=Object(a.i)(this.symbolLayer,"material","color"),n=this._patternHidesLine&&!t?0:this._getCombinedOpacity(r),s=n<1||this.needsDrivenTransparentPass,o=[i[0],i[1],i[2],n];e.setParameters({color:o,transparent:s})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=Object(Te.e)(Fa.elevationModeChangeTypes,i,r);if(a!==Te.b.UPDATE)return a;const n=Object(Te.h)(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};return this._forEachMaterial((t=>t.setParameters(e))),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof Pi.a)return vi.a.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,i){const r=e.graphic,n=this._getGeometryAsPolygonOrPolyline(r.geometry),s="polygon"===n.type?n.rings:n.paths,o=new Array,c=new Array,l=new Array,d=Object(G.f)(),h=Object(pa.c)(n,this._context.elevationProvider,this._context.renderCoordsHelper,t),u="polygon"===n.type?"rings":"paths";this._logGeometryCreationWarnings(h,s,u,"LineSymbol3DLayer");for(let b=0;b<h.lines.length;b++){const{position:t,mapPosition:i}=h.lines[b];if(Object(a.k)(this._context.clippingExtent)&&(Object(G.h)(d),Object(G.k)(d,i),!Object(G.r)(d,this._context.clippingExtent)))continue;const r=this._createGeometry(e,t,i,n.type,za.ELEVATED);o.push(r),c.push("polygon"===n.type?this.ringMaterial:this.lineMaterial),l.push(Se.a),Ee.a.LINE_WIREFRAMES&&(o.push(r.cloneShallow()),c.push("polygon"===n.type?this.wireframeRingMaterial:this.wireframeLineMaterial),l.push(Se.a));const s=this.markerMaterial;Object(a.k)(s)&&(o.push(r.cloneShallow()),c.push(s),l.push(Se.a))}if(0===o.length)return null;const p=new Ui.a({geometries:o,materials:c,transformations:l,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),f=new Xe(this,p,o,null,null,Me,t);return f.alignedSampledElevation=h.sampledElevation,f.needsElevationUpdates=Object(Te.h)(t.mode),f}_createGeometry(e,t,i,r,a){const n="polygon"===r?pa.a.REMOVE:pa.a.KEEP,s=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,o=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return Object(pa.b)({overlayInfo:a===za.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:n,uniformSize:this._uniformSize,attributeData:{position:t,mapPosition:i,size:o?null:this._getDrivenSize(e.renderingInfo),color:s?null:this._getDrivenColor(e.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(e.graphic),colorFeature:this._getColorFeatureAttributeData(e.graphic),opacityFeature:this._getOpacityFeatureAttributeData(e.graphic)}})}_createAsOverlay(e,t){const i=e.graphic,r=this._getGeometryAsPolygonOrPolyline(i.geometry),n="polygon"===r.type?r.rings:r.paths,s="polygon"===r.type?this.ringMaterial:this.lineMaterial;s.renderPriority=this._renderPriority;const o=Ee.a.LINE_WIREFRAMES?"polygon"===r.type?this.wireframeRingMaterial:this.wireframeLineMaterial:null,c=this.markerMaterial;Object(a.k)(o)&&(o.renderPriority=this._renderPriority-.001),Object(a.k)(c)&&(c.renderPriority=this._renderPriority-.002);const l=new Array,d=Object(G.f)(),h=Object(G.h)(),u=Object(pa.d)(r,this._context.overlaySR),p="polygon"===r.type?"rings":"paths";this._logGeometryCreationWarnings(u,n,p,"LineSymbol3DLayer");for(const f of u.lines){if(Object(G.h)(d),Object(G.k)(d,f.position),!Object(G.r)(d,this._context.clippingExtent))continue;Object(G.j)(h,d);const n=this._createGeometry(e,f.position,null,r.type,za.DRAPED),u=e=>{const r=new ea.a(n,e,{layerUid:t,graphicUid:i.uid});return l.push(r),r};if(Object(a.k)(c)){const e=u(c),t=Object(a.s)(this.symbolLayer.marker).placement;"begin"!==t&&"begin-end"!==t||Object(G.k)(d,f.position,0,1),"end"!==t&&"begin-end"!==t||Object(G.k)(d,f.position,f.position.length-3,1),this._updateBoundingSphere(e,d)}const p=u(s);if(this._updateBoundingSphere(p,d),Ee.a.LINE_WIREFRAMES){const e=u(o);this._updateBoundingSphere(e,d)}}return new pr(this,l,h)}_updateBoundingSphere(e,t){Object(cr.l)(e.boundingSphere,.5*(t[0]+t[3]),.5*(t[1]+t[4]),0,.5*Math.sqrt((t[3]-t[0])*(t[3]-t[0])+(t[4]-t[1])*(t[4]-t[1])))}get _patternHidesLine(){const e=this.symbolLayer.pattern;return Object(a.k)(e)&&"style"===e.type&&"none"===e.style}_computeMaterialWidth(e){return e=Object(a.t)(e,Object(je.h)(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?Object(je.g)(1):1:Object(je.g)(e)}_prepareMaterialPatch(e,t,i){const r=t.material;if(Object(a.j)(r)||"collection"===r.type)return;const n="complete"===r.type?Object(a.b)(r.newValue,(e=>e.color)):"complete"===r.diff.color.type?r.diff.color.newValue:null,s=this._getCombinedOpacityAndColor(n);i&&this._patchMaterialColor(Object(at.d)(s),this._markerMaterial,e),this._patternHidesLine&&(s[3]=0),this._patchMaterialColor(s,this._lineMaterial,e),delete t.material}_prepareMarkerPatch(e,t){const i=t.marker;if(Object(a.j)(i)||"partial"!==i.type||Object(a.k)(i.diff.style)||Object(a.k)(i.diff.placement)||Object(a.k)(i.diff.color)&&"complete"!==i.diff.color.type)return!1;const r=i.diff.color;if(Object(a.j)(r))return delete t.marker,Object(a.j)(this.symbolLayer)||Object(a.j)(this.symbolLayer.marker)||Object(a.j)(this.symbolLayer.marker.color);const n=Object(a.s)(r.newValue);return Object(a.j)(n)?(delete t.marker,!0):(this._patchMaterialColor(this._getCombinedOpacityAndColor(n),this._markerMaterial,e),delete t.marker,!1)}_patchMaterialColor(e,t,i){if(Object(a.j)(t))return;const r=e[3];i.symbolLayerStatePatches.push((()=>t.setParameters({color:e,transparent:r<1||this.needsDrivenTransparentPass})))}}var za;Fa.elevationModeChangeTypes={definedChanged:Te.b.RECREATE,staysOnTheGround:Te.b.NONE,onTheGroundChanged:Te.b.RECREATE},function(e){e[e.DRAPED=0]="DRAPED",e[e.ELEVATED=1]="ELEVATED"}(za||(za={}));var Ua=i(996),Ga=i(941),Va=i(850),Ba=i(952),ka=i(562),Ha=i(1187);const Wa=["mesh"];const qa=Object(z.f)(),$a=Object(z.f)(),Xa=Object(z.f)(),Ya=Object(z.f)(),Za=Object(z.f)(),Qa=Object(Se.d)(),Ja=Object(Ti.b)(),Ka=Object(G.f)(),en=[new Ua.a];var tn;!function(e){e[e.NONE=0]="NONE",e[e.ECEF=1]="ECEF"}(tn||(tn={}));var rn=i(971),an=i(796);class nn{constructor(e,t,i,r){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=r,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const t=this.lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){null!=this.instanceIndex&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,i){if(this.elevationAligner){Object(de.f)(this.elevationContext.featureExpressionInfoContext,i);const r=this.elevationAligner(this,this.elevationContext,e,t);Object(a.k)(r)&&(this.alignedSampledElevation=r)}}getCenterObjectSpace(e=Object(z.f)()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,dn),Object(F.q)(e,this.lodRenderer.baseBoundingSphere.center,dn)}getBoundingBoxObjectSpace(e=Object(G.f)()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,dn);const t=this.lodRenderer.baseBoundingBox;Object(G.h)(e);for(let i=0;i<8;++i)Object(F.w)(on,0==(1&i)?t[0]:t[3],0==(2&i)?t[1]:t[4],0==(4&i)?t[2]:t[5]),Object(F.q)(on,on,dn),Object(G.n)(e,on);return e}computeAttachmentOrigin(e){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,dn),e.render.origin[0]+=dn[12],e.render.origin[1]+=dn[13],e.render.origin[2]+=dn[14],e.render.num++}async getProjectedBoundingBox(e,t,i,r,n){const s=this.getBoundingBoxObjectSpace(n),o=ln,c=Object(G.s)(s)?1:o.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,dn);for(let a=0;a<c;a++){const e=o[a];on[0]=s[e[0]],on[1]=s[e[1]],on[2]=s[e[2]],Object(F.q)(on,on,dn),sn[3*a+0]=on[0],sn[3*a+1]=on[1],sn[3*a+2]=on[2]}if(!e(sn,0,c))return null;Object(G.h)(s);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let a=0;a<3*c;a+=3){for(let e=0;e<3;e++)s[e]=Math.min(s[e],sn[a+e]),s[e+3]=Math.max(s[e+3],sn[a+e]);l&&i.push({location:sn.slice(a,a+3),screenSpaceBoundingRect:l})}if(t&&(Object(G.d)(s,cn),"absolute-height"!==this.elevationContext.mode)){let e;const i=Object(Ce.d)(s,t);try{e=await t.service.queryElevation(cn[0],cn[1],r,i,"ground")}catch(d){}Object(a.k)(e)&&Object(G.u)(s,0,0,-this.alignedSampledElevation+e)}return s}addObjectState(e,t){if(e===$e.d.Highlight){const i=new an.a(e);this._addHighlightId(i),t.addExternal((e=>{this._removeHighlightId(e)}),i)}}removeObjectState(e){this._highlights.forEach((t=>e.remove(t)))}_addHighlightId(e){this._highlights.add(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(e){this._highlights.delete(e),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const sn=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],on=Object(z.f)(),cn=Object(z.f)(),ln=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],dn=Object(Se.d)();function hn(e,t=un){const i=bt(e).reduce(((e,t)=>e+t.indexCount/3),0);return Math.sqrt(i/(t*Math.PI))}const un=.05;var pn,fn=i(1188),bn=i(726),mn=i(748),gn=i(608),vn=i(826),On=i(567),yn=i(278),_n=i(629);!function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"}(pn||(pn={}));class jn{constructor(e){this.localTransform=e.getField(we.a.LOCALTRANSFORM,Ci.i),this.globalTransform=e.getField(we.a.GLOBALTRANSFORM,Ci.i),this.modelOrigin=e.getField(we.a.MODELORIGIN,Ci.v),this.model=e.getField(we.a.MODEL,Ci.f),this.modelNormal=e.getField(we.a.MODELNORMAL,Ci.f),this.modelScaleFactors=e.getField(we.a.MODELSCALEFACTORS,Ci.m),this.boundingSphere=e.getField(we.a.BOUNDINGSPHERE,Ci.D),this.color=e.getField(we.a.COLOR,Ci.C),this.featureAttribute=e.getField(we.a.FEATUREATTRIBUTE,Ci.C),this.state=e.getField(we.a.STATE,Ci.l),this.lodLevel=e.getField(we.a.LODLEVEL,Ci.l)}}class xn extends he.a{constructor(e,t){super(),this._capacity=0,this._size=0,this._next=0,this._layout=function(e){let t=Object(Mt.a)().mat4f64(we.a.LOCALTRANSFORM).mat4f64(we.a.GLOBALTRANSFORM).vec4f64(we.a.BOUNDINGSPHERE).vec3f64(we.a.MODELORIGIN).mat3f(we.a.MODEL).mat3f(we.a.MODELNORMAL).vec2f(we.a.MODELSCALEFACTORS);return e.indexOf("color")>=0&&(t=t.vec4f(we.a.COLOR)),e.indexOf("featureAttribute")>=0&&(t=t.vec4f(we.a.FEATUREATTRIBUTE)),t=t.u8(we.a.STATE).u8(we.a.LODLEVEL).alignTo(8),t}(e),this._shaderTransformation=t}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,pn.ALLOCATED),this._size++,this.emit("instance-added",{index:e}),e}removeInstance(e){const t=this._view.state;Object(yn.a)(e>=0&&e<this._capacity&&t.get(e)&pn.ALLOCATED,"invalid instance handle"),this._getStateFlag(e,pn.ACTIVE)?this._setStateFlags(e,pn.REMOVE):this.freeInstance(e),this.emit("instance-removed",{index:e})}freeInstance(e){const t=this._view.state;Object(yn.a)(e>=0&&e<this._capacity&&t.get(e)&pn.ALLOCATED,"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,i=!0){this._view.localTransform.setMat(e,t),i&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,i=!0){this._view.globalTransform.setMat(e,t),i&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,i=Cn,r=En;t.localTransform.getMat(e,An),t.globalTransform.getMat(e,wn);const a=Object(xe.m)(wn,wn,An);Object(F.w)(i,a[12],a[13],a[14]),t.modelOrigin.setVec(e,i),Object(Si.f)(r,a),t.model.setMat(e,r);const n=Object(_n.e)(Cn,a);n.sort(),t.modelScaleFactors.set(e,0,n[1]),t.modelScaleFactors.set(e,1,n[2]),Object(Si.e)(r,r),Object(Si.n)(r,r),t.modelNormal.setMat(e,r),this._setStateFlags(e,pn.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const i=this._view;i.model.getMat(e,En),i.modelOrigin.getVec(e,Cn),t[0]=En[0],t[1]=En[1],t[2]=En[2],t[3]=0,t[4]=En[3],t[5]=En[4],t[6]=En[5],t[7]=0,t[8]=En[6],t[9]=En[7],t[10]=En[8],t[11]=0,t[12]=Cn[0],t[13]=Cn[1],t[14]=Cn[2],t[15]=1}applyShaderTransformation(e,t){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){return this._view.localTransform.getMat(e,t),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,e,t),t}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);if(this._shaderTransformation){const i=this._shaderTransformation.scaleFactor(Cn,this,e);t*=Math.max(i[0],i[1],i[2])}return t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);if(this._shaderTransformation){const i=this._shaderTransformation.scaleFactor(Cn,this,e);i.sort(),t*=i[1]}return t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}getColor(e,t){this._view.color.getVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,pn.VISIBLE,t),this.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,pn.VISIBLE)}setHighlight(e,t){t!==this.getHighlight(e)&&(this._setStateFlag(e,pn.HIGHLIGHT,t),this.emit("instance-highlight-changed",{index:e}))}getHighlight(e){return this._getStateFlag(e,pn.HIGHLIGHT)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++t;return t}_setStateFlags(e,t){const i=this._view.state;t=i.get(e)|t,i.set(e,t)}_clearStateFlags(e,t){const i=this._view.state;t=i.get(e)&~t,i.set(e,t)}_setStateFlag(e,t,i){i?this._setStateFlags(e,t):this._clearStateFlags(e,t)}_getStateFlag(e,t){return!!(this._view.state.get(e)&t)}_grow(){const e=Math.max(Sn,Math.floor(this._capacity*Tn)),t=this._layout.createBuffer(e);if(this._buffer){const e=new Uint8Array(this._buffer.buffer);new Uint8Array(t.buffer).set(e)}this._capacity=e,this._buffer=t,this._view=new jn(this._buffer)}_findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&pn.ALLOCATED;)t=(t+1)%this._capacity;return this._next=(t+1)%this._capacity,t}}const Sn=1024,Tn=2,Cn=Object(z.f)(),En=Object(Ti.b)(),An=Object(Se.d)(),wn=Object(Se.d)();class Rn extends vn.b{constructor(e,t){super((e=>Object(qe.h)(this._instanceData.view.boundingSphere.getVec(e,this._tmpSphere))),{maximumDepth:25}),this._tmpSphere=Object(qe.c)(),this._tmpMat4=Object(Se.d)(),this._instanceData=e,this._boundingSphere=t}addInstance(e){const t=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);Object(F.q)(this._tmpSphere,this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*Object(_n.c)(i),t.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}}class Pn{constructor(e,t){this.thresholdScale=1,this._camera=new mn.a,this._worldSpaceRadius=e,this._thresholds=t.map((e=>e))}updateCamera(e){this._camera.copyFrom(e)}selectLevel(e,t){const i=this._camera.computeScreenPixelSizeAt(e),r=this._worldSpaceRadius*t/i,a=this._thresholds;let n=-1;for(let s=0;s<a.length;++s)r>=a[s]*this.thresholdScale&&(n=s);return n}}var In=i(752),Dn=i(162),Mn=i(164);class Ln{constructor(e,t){const i=e.renderContext.rctx,{geometry:r,material:a}=t;this._materialRepository=e.materialRep,a.setParameters({instancedDoublePrecision:!0});const n=a.createBufferWriter(),s=n.vertexBufferLayout,o=n.elementCount(r),c=n.allocate(o);n.write({},r,c,0),this.geometry=r,this.material=a,this.glMaterials=new ba.a(a,this._materialRepository),this.vertexBufferLayout=s,this.vbo=Dn.a.createVertex(i,Qt.D.STATIC_DRAW,c.buffer),this.vao=new Mn.a(i,$t.a,{geometry:Object(bn.a)(s)},{geometry:this.vbo}),this.vertexCount=o}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,t,i,r,a,n){const s=this.geometry.id;this.material.intersect(this.geometry,null,e.transform.transform,e,i,r,((i,r,o,c,l)=>{if(i>=0){if(null!=t&&!t(e.rayBegin,e.rayEnd,i))return;const c={layerUid:n.layerUid,graphicUid:n.graphicUid(a),geometryId:s,triangleNr:o};if((null==e.results.min.drapedLayerOrder||l>=e.results.min.drapedLayerOrder)&&(null==e.results.min.dist||i<e.results.min.dist)&&e.results.min.set(gn.b.LOD,c,i,r,e.transform.transform,l),e.options.store!==gn.c.MIN&&(null==e.results.max.drapedLayerOrder||l>=e.results.max.drapedLayerOrder)&&(null==e.results.max.dist||i>e.results.max.dist)&&e.results.max.set(gn.b.LOD,c,i,r,e.transform.transform,l),e.options.store===gn.c.ALL){const t=Object(In.b)(e.results.min.ray);t.set(gn.b.LOD,c,i,r,e.transform.transform,l),e.results.all.push(t)}}}))}}class Nn{constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}static async create(e,t,i){const r=await Promise.allSettled(t.components.map((t=>e.schedule((()=>new Ln(e,t)),i)))),a=r.map((e=>"fulfilled"===e.status?e.value:null)).filter((e=>e));if(Object(v.m)(i)||a.length!==r.length){a.forEach((e=>e.destroy())),Object(v.t)(i);for(const e of r)if("rejected"===e.status)throw e.reason}return new Nn(t.minScreenSpaceRadius,a)}destroy(){this.components.forEach((e=>e.destroy()))}intersect(e,t,i,r,a,n){this.components.forEach((s=>s.intersect(e,t,i,r,a,n)))}get boundingBox(){if(Object(a.j)(this._boundingBox)){const e=Object(G.h)();this.components.forEach((t=>{Object(a.k)(t.boundingInfo)&&(Object(G.n)(e,t.boundingInfo.bbMin),Object(G.n)(e,t.boundingInfo.bbMax))})),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(Object(a.j)(this._boundingSphere)){const e=this.boundingBox,t=Object(z.f)();Object(G.d)(e,t),this._boundingSphere={center:t,radius:.5*Object(G.g)(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce(((e,t)=>e+t.triangleCount),0)}}class Fn{constructor(e,t,i){this._elementSize=t,this._buffer=Dn.a.createVertex(e,Qt.D.STATIC_DRAW),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(e,t,i,r=0){const a=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(i.array,r*this.elementSize).set(a)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const i=e*this._elementSize,r=t*this._elementSize;this._buffer.setSubData(this._array,i,i,r)}resize(e){const t=e*this._elementSize,i=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setSize(t),this._capacity=e}}class zn{constructor(e){this.modelOriginHi=e.getField(we.a.MODELORIGINHI,Ci.u),this.modelOriginLo=e.getField(we.a.MODELORIGINLO,Ci.u),this.model=e.getField(we.a.MODEL,Ci.f),this.modelNormal=e.getField(we.a.MODELNORMAL,Ci.f),this.color=e.getField(we.a.INSTANCECOLOR,Ci.C),this.featureAttribute=e.getField(we.a.INSTANCEFEATUREATTRIBUTE,Ci.C)}}class Un{constructor(e,t){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=e,this._instanceBufferLayout=t,this._elementSize=t.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCylce(){this._captureFirstIndex=!0}beginUpdate(){Object(yn.a)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){Object(yn.a)(this._updating,"not updating"),this.size<Bn*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){Object(yn.a)(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),Object(yn.a)(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){Object(yn.a)(this._updating,"not updating"),Object(yn.a)(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(Gn,Math.floor(this._capacity*Vn));this._resize(e)}_shrink(){const e=Math.max(Gn,Math.floor(this._capacity*kn));this._resize(e)}_resize(e){if(Object(yn.a)(this._updating,"not updating"),e===this._capacity)return;const t=new Fn(this._rctx,this._elementSize,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const e=this.size,i=this._compactInstances(t);Object(yn.a)(i===e,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=i,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new zn(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const t=this._headIndex,i=this._tailIndex;return i<t?(this._buffer.copyRange(i,t,e),t-i):i>t?(this._buffer.copyRange(i,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-i),t+(this._capacity-i)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}}const Gn=1024,Vn=2,Bn=.3,kn=.5;var Hn=i(513),Wn=i(647);let qn=function(e){const t=e.baseBoundingSphere.radius,i=e.levels.map((e=>e.minScreenSpaceRadius));return new Pn(t,i)};class $n{constructor(e,t,i,r){this.type=gn.b.LOD,this.isGround=!1,this._inverseViewport=Object(gi.a)(),this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new mn.a,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[zt.a.OPAQUE_PLUGIN,zt.a.TRANSPARENT_PLUGIN],this.canRender=!0,this._symbol=e,this._optionalFields=t,this._metadata=i,this._instanceBufferLayout=Object(Gi.b)({instancedDoublePrecision:!0,instanced:t}),this._glInstanceBufferLayout=Object(bn.a)(this._instanceBufferLayout,1),this._instanceData=new xn(this._optionalFields,r),this._instanceData.on("instance-added",(()=>this._requestUpdateCycle())),this._instanceData.on("instance-removed",(()=>this._requestUpdateCycle())),this._instanceData.on("instance-transform-changed",(e=>{this._requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(e.index)})),this._instanceData.on("instance-visibility-changed",(e=>{this._requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(e.index)})),this._instanceData.on("instance-highlight-changed",(()=>this._requestUpdateCycle(!0))),this._enableLevelSelection=this._symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach((t=>{const i=t.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu})),this._highlightRenderInstanceData.forEach((t=>{const i=t.memoryUsage;e.cpu+=i.cpu,e.gpu+=i.gpu})),e}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach(((e,i)=>{const r=this._defaultRenderInstanceData[i],a=this._highlightRenderInstanceData[i],n=r.size+a.size,s=e.triangleCount;t.push({renderedInstances:n,renderedTriangles:n*s,trianglesPerInstance:s})})),{totalInstances:e,renderedInstances:t.reduce(((e,t)=>e+t.renderedInstances),0),renderedTriangles:t.reduce(((e,t)=>e+t.renderedTriangles),0),levels:t}}async initializeRenderContext(e,t){this._context=e;const i=e.renderContext.rctx,r=await Promise.allSettled(this._symbol.levels.map((r=>(this._defaultRenderInstanceData.push(new Un(i,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new Un(i,this._instanceBufferLayout)),Nn.create(e,r,t))))),a=r.map((e=>"fulfilled"===e.status?e.value:null)).filter((e=>e));if(Object(v.m)(t)||a.length!==r.length){a.forEach((e=>e.destroy())),Object(v.t)(t);for(const e of r)if("rejected"===e.status)throw e.reason}this._levels=a,this._levelSelector=qn(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach((e=>e.destroy())),this._defaultRenderInstanceData.forEach((e=>e.destroy())),this._highlightRenderInstanceData.forEach((e=>e.destroy()))}get needsTransparentPass(){return this._levels.some((e=>e.components.some((e=>e.material.requiresSlot(zt.a.TRANSPARENT_MATERIAL)))))}get needsHighlight(){return this._highlightRenderInstanceData.some((e=>e.size>0))}prepareRender(e,t){if(Ee.a.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const e=t.equals(this._lastCamera);this._lastCamera.copyFrom(t),e||this._requestUpdateCycle()}const i=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this._updateInstances(t,i),this.needsUpdates&&this._context.requestRender()}render(e){var t,i,r,a;const n=e.slot===zt.a.OPAQUE_PLUGIN?zt.a.OPAQUE_MATERIAL:e.slot===zt.a.TRANSPARENT_PLUGIN?zt.a.TRANSPARENT_MATERIAL:null;if(!n||!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(e.pass))return;const s=e.camera;this._inverseViewport[0]=1/s.fullViewport[2],this._inverseViewport[1]=1/s.fullViewport[3];const o={slot:n,origin:[0,0,0],camera:s,inverseViewport:this._inverseViewport,shadowMap:e.shadowMap,shadowMappingEnabled:e.shadowMap.enabled,ssaoHelper:e.ssaoHelper,ssaoEnabled:e.ssaoHelper.enabled,screenToWorldRatio:null,screenToPCSRatio:null,slicePlane:e.sliceHelper&&e.sliceHelper.plane,hudVisibilityTexture:null!=(t=null==(i=e.offscreenRenderingHelper)?void 0:i.hudVisibilityTexture)?t:null,highlightDepthTexture:null!=(r=null==(a=e.offscreenRenderingHelper)?void 0:a.depthTexture)?r:null,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMatrix:Se.a,ssrEnabled:!1,lighting:e.scenelightingData,transparencyPassType:e.transparencyPassType,terrainLinearDepthTexture:e.multipassTerrainParams.terrainLinearDepthTexture,geometryLinearDepthTexture:e.multipassGeometryParams.geometryLinearDepthTexture,multipassTerrainEnabled:e.multipassTerrainParams.multipassTerrainEnabled,cullAboveGround:e.multipassTerrainParams.cullAboveGround,multipassGeometryEnabled:e.multipassGeometryParams.multipassGeometryEnabled,highlightColorTexture:null,cloudsCompositionParams:null,hasFillLights:e.hasFillLights};e.rctx.bindVAO();const c=e.pass!==On.a.MATERIAL_HIGHLIGHT&&e.pass!==On.a.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT,l=e.pass!==On.a.MATERIAL_DEPTH_SHADOWMAP_DEFAULT;c&&this._renderComponents(e,n,o,this._defaultRenderInstanceData),l&&this._renderComponents(e,n,o,this._highlightRenderInstanceData)}intersect(e,t,i,r){if(!this.baseMaterial.isVisible())return;const a=Object(z.f)();Object(F.j)(a,r,i);const n=a=>{this._instanceData.getCombinedModelTransform(a,Qn),e.transform.set(Qn),Object(F.q)(Jn,i,e.transform.inverse),Object(F.q)(Kn,r,e.transform.inverse);const n=this._instanceData.getState(a),s=this._instanceData.getLodLevel(a);Object(yn.a)(n&pn.ACTIVE,"invalid instance state"),Object(yn.a)(s>=0&&s<this._levels.length,"invaid lod level"),this._levels[s].intersect(e,t,Jn,Kn,a,this._metadata)};this.baseMaterial.parameters.verticalOffset?this.octree.forEach(n):this.octree.forEachAlongRay(i,a,n)}queryDepthRange(e){return this._queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this._invalidateOctree()}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,e&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}get octree(){return this._octree||(this._octree=this._buildOctree()),this._octree}_invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null)}_buildOctree(){const e=new Rn(this._instanceData,this.baseBoundingSphere),t=this._instanceData,i=t.view?t.view.state:null;for(let r=0;r<this._instanceData.capacity;++r)i.get(r)&pn.ACTIVE&&e.addInstance(r);return e}_queryDepthRangeOctree(e){const t=e.eye,i=e.viewForward,r=this.octree.findClosest(i,vn.a.FRONT_TO_BACK,e.frustum),a=this.octree.findClosest(i,vn.a.BACK_TO_FRONT,e.frustum);if(null!=r&&null!=a){this._instanceData.view.boundingSphere.getVec(r,Zn),Object(F.j)(Zn,Zn,t);const n=Object(F.h)(Zn,i)-Zn[3];this._instanceData.view.boundingSphere.getVec(a,Zn),Object(F.j)(Zn,Zn,t);const s=Object(F.h)(Zn,i)+Zn[3];return{near:Math.max(e.near,n),far:Math.min(e.far,s)}}return{near:1/0,far:-1/0}}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this._highlightRenderInstanceData.forEach((e=>{e.startUpdateCylce()})),this.needsUpdates&&this._context.requestRender()}_updateInstances(e,t){const i=this._enableLevelSelection,r=this._levelSelector;r.updateCamera(e),this._defaultRenderInstanceData.forEach((e=>{e.beginUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.beginUpdate()}));const a=this._instanceData,n=this._instanceData.view,s=a.size,o=a.capacity;let c=this._instanceIndex;t=Math.min(s,t);for(let l=0;l<t;++l){0===c&&this._startUpdateCycle();const e=n.state.get(c);let s=0;if(!(e&pn.ALLOCATED)){c=(c+1)%o,t++;continue}const l=n.lodLevel.get(c);if(e&pn.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[l].freeTail(),e&pn.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[l].freeTail(),e&pn.REMOVE)a.freeInstance(c);else if(e&pn.VISIBLE){let t=0;i&&(n.modelOrigin.getVec(c,Yn),t=r.selectLevel(Yn,a.getCombinedMedianScaleFactor(c))),s=e&~(pn.ACTIVE|pn.TRANSFORM_CHANGED),t>=0&&(e&pn.HIGHLIGHT?(Xn(this._highlightRenderInstanceData[t],n,c),s|=pn.HIGHLIGHT_ACTIVE):(Xn(this._defaultRenderInstanceData[t],n,c),s|=pn.DEFAULT_ACTIVE)),n.state.set(c,s),n.lodLevel.set(c,t)}else s=e&~(pn.ACTIVE|pn.TRANSFORM_CHANGED),n.state.set(c,s);if(this._octree){const t=!!(e&pn.ACTIVE),i=!!(s&pn.ACTIVE);!t&&i?this._octree.addInstance(c):t&&!i?this._octree.removeInstance(c):t&&i&&e&pn.TRANSFORM_CHANGED&&(this._octree.removeInstance(c),this._octree.addInstance(c))}c=(c+1)%o}this._instanceIndex=c,this._defaultRenderInstanceData.forEach((e=>{e.endUpdate()})),this._highlightRenderInstanceData.forEach((e=>{e.endUpdate()}))}_renderComponents(e,t,i,r){this.levels.forEach(((a,n)=>{a.components.forEach((a=>{this._renderComponent(e,t,i,r[n],a,n)}))}))}_renderComponent(e,t,i,r,n,s){if(0===r.size||!n.material.requiresSlot(t))return;const{rctx:o,pass:c}=e,l=n.glMaterials.load(o,c);if(Object(a.j)(l))return;const d=l.beginSlot(i),h=o.useTechnique(d,t);l.bind(i,d),o.bindVAO(n.vao),d.ensureAttributeLocations(n.vao),e.isHighlightPass&&Object(Oa.b)(h,i),d.bindDraw(i),Ee.a.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.pass===On.a.MATERIAL&&(h.setUniform4fv("externalColor",es[Math.min(s,es.length-1)]),h.setUniform1i("colorMixMode",Yt.b.replace));const u=o.capabilities.instancing,p=r.capacity,f=r.headIndex,b=r.tailIndex,m=r.firstIndex,g=this._glInstanceBufferLayout,v=(e,t)=>{Object(Wn.a)(o,$t.a,r.buffer,g,e),u.drawArraysInstanced(d.primitiveType,0,n.vertexCount,t-e),Object(Wn.e)(o,$t.a,r.buffer,g)};n.material.parameters.transparent&&null!=m?f>b?(Object(yn.a)(m>=b&&m<=f,"invalid firstIndex"),v(m,f),v(b,m)):f<b&&(m<=f?(Object(yn.a)(m>=0&&m<=f,"invalid firstIndex"),v(m,f),v(b,p),v(0,m)):(Object(yn.a)(m>=b&&m<=p,"invalid firstIndex"),v(m,p),v(0,f),v(b,m))):f>b?v(b,f):f<b&&(v(0,f),v(b,p)),o.bindVAO(null)}}function Xn(e,t,i){const r=e.allocateHead();!function(e,t,i,r){Object(Hn.c)(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,e.model,t),i.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(r,e.color,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,e.featureAttribute,t)}(t,i,e.view,r)}const Yn=Object(z.f)(),Zn=Object(at.e)(),Qn=Object(Se.d)(),Jn=Object(z.f)(),Kn=Object(z.f)(),es=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]];const ts=Object(z.f)(),is=Object(Se.d)(),rs=Object(Se.d)(),as=Object(at.e)(),ns=new Te.a;var ss=i(189);function os(e,t,i,r,a){return e[0]=t,e[1]=i,e[2]=r,e[3]=a,e}function cs(e,t,i){const r=t[0],a=t[1],n=t[2],s=t[3],o=i[0],c=i[1],l=i[2],d=i[3];return e[0]=r*o+n*c,e[1]=a*o+s*c,e[2]=r*l+n*d,e[3]=a*l+s*d,e}function ls(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}const ds=cs,hs=ls;Object.freeze({__proto__:null,copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},set:os,transpose:function(e,t){if(e===t){const i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},invert:function(e,t){const i=t[0],r=t[1],a=t[2],n=t[3];let s=i*n-a*r;return s?(s=1/s,e[0]=n*s,e[1]=-r*s,e[2]=-a*s,e[3]=i*s,e):null},adjoint:function(e,t){const i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e},determinant:function(e){return e[0]*e[3]-e[2]*e[1]},multiply:cs,rotate:function(e,t,i){const r=t[0],a=t[1],n=t[2],s=t[3],o=Math.sin(i),c=Math.cos(i);return e[0]=r*c+n*o,e[1]=a*c+s*o,e[2]=r*-o+n*c,e[3]=a*-o+s*c,e},scale:function(e,t,i){const r=t[0],a=t[1],n=t[2],s=t[3],o=i[0],c=i[1];return e[0]=r*o,e[1]=a*o,e[2]=n*c,e[3]=s*c,e},fromRotation:function(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},str:function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},frob:function(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)},LDU:function(e,t,i,r){return e[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-e[2]*i[1],[e,t,i]},add:function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},subtract:ls,exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},equals:function(e,t){const i=e[0],r=e[1],a=e[2],n=e[3],s=t[0],o=t[1],c=t[2],l=t[3];return Math.abs(i-s)<=ss.a*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(r-o)<=ss.a*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(a-c)<=ss.a*Math.max(1,Math.abs(a),Math.abs(c))&&Math.abs(n-l)<=ss.a*Math.max(1,Math.abs(n),Math.abs(l))},multiplyScalar:function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e},multiplyScalarAndAdd:function(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e},mul:ds,sub:hs});var us=i(446);class ps extends Pt.a{constructor(e,t,i,r,a,n){super(e,t),this.path=i,this.geometrySR=r,this.upVectorAlignment=a,this.stencilWidth=n}}function fs(e){return"upVectorAlignment"in e}function bs(){return[1,0,0,1]}Object.freeze({__proto__:null,create:bs,clone:function(e){return[e[0],e[1],e[2],e[3]]},fromValues:function(e,t,i,r){return[e,t,i,r]},createView:function(e,t){return new Float64Array(e,t,4)}});var ms=i(423),gs=i(360);function vs(){return{up:Object(z.f)(),right:Object(z.f)()}}function Os(e,t,i){Object(F.q)(e.up,t.up,i),Object(F.q)(e.right,t.right,i)}function ys(e,t,i){Object(mi.s)(e,Object(F.h)(i,t.right),Object(F.h)(i,t.up))}class _s{constructor(){this.pos=Object(z.f)(),this.posES=Object(z.f)(),this.posGS=Object(z.f)(),this.vRight=Object(z.f)(),this.vLeft=Object(z.f)(),this.frame=vs(),this.rotationFrame=vs(),this.rotationRight=Object(gi.a)(),this.rotationAngle=0,this.miterStretch=[1,0,0,1]}setFrameFromUpVector(e){Object(F.k)(this.frame.up,e),Object(F.f)(Gs,this.vLeft,this.vRight),Object(F.r)(Gs,Gs),Object(F.e)(Us,this.frame.up,Object(F.h)(Gs,this.frame.up)),Object(F.j)(ks,Gs,Us),Object(F.r)(ks,ks),Object(F.g)(this.frame.right,ks,this.frame.up)}computeRotationAxisAndAngleFromUpVector(){Object(F.k)(this.rotationFrame.up,this.frame.up),Object(F.k)(this.rotationFrame.right,this.frame.right),Object(mi.s)(this.rotationRight,1,0),Object(F.e)(Us,this.frame.up,Object(F.h)(this.frame.up,this.vLeft)),Object(F.j)(Us,this.vLeft,Us),Object(F.s)(Us,Us),Object(F.r)(Us,Us),Object(F.e)(Gs,this.frame.up,Object(F.h)(this.frame.up,this.vRight)),Object(F.j)(Gs,this.vRight,Gs),Object(F.r)(Gs,Gs),Object(F.g)(Vs,this.rotationFrame.up,this.vLeft);const e=Math.sign(Object(F.h)(Vs,this.vRight));if(this.rotationAngle=e*(Math.PI-Object(gr.b)(Object(F.h)(Us,Gs))),Math.abs(this.rotationAngle)>0){const e=Object(gr.o)(Math.cos(.5*this.rotationAngle));os(this.miterStretch,e-1+1,0,0,1)}const t=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*t))}}class js{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null}addVertex(e,t){return this.vertices.push(Object(gi.b)(e)),this.vertexNormals.push(Object(gi.b)(t)),this.vertices.length-1}addUV(e){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(e),this.uvs.length-1}addPole(e,t=null){return this.poles.push({position:Object(gi.b)(e),normal:t?Object(gi.b)(t):null}),this.poles.length-1}addSegment(e,t=null,i=null){this.vertexIndices.push(e.v0),this.vertexIndices.push(e.v1),t&&(this.uvIndices.push(t.v0),this.uvIndices.push(t.v1)),i&&(this.poleIndices.push(i.v0),this.poleIndices.push(i.v1))}get numSegments(){return this.vertexIndices.length/2}hasUV(){return null!=this.uvs}translate(e,t){for(const i of this.vertices)i[0]+=e,i[1]+=t;for(const i of this.poles)i.position[0]+=e,i.position[1]+=t}static circle(e=20){const t=new js,i={v0:0,v1:0};t.addPole(Object(gi.e)(0,0));for(let n=0;n<e;++n){const i=2*n*Math.PI/e,r=Math.cos(i),a=Math.sin(i),s=Object(gi.e)(.5*r,.5*a),o=Object(gi.e)(r,a);t.addVertex(s,o),t.addUV(n/e)}t.addUV(1);for(let n=0;n<e-1;++n){const e={v0:n,v1:n+1},r=e;t.addSegment(e,r,i)}const r={v0:e-1,v1:0},a={v0:e-1,v1:e};return t.addSegment(r,a,i),t}static rect(){const e=new js,t=Object(gi.e)(-.5,-.5),i=Object(gi.e)(.5,-.5),r=Object(gi.e)(.5,.5),a=Object(gi.e)(-.5,.5),n=Object(gi.e)(0,-1),s=Object(gi.e)(1,0),o=Object(gi.e)(0,1),c=Object(gi.e)(-1,0);e.addUV(0),e.addUV(1),e.addPole(Object(gi.e)(0,.5),o),e.addPole(Object(gi.e)(0,.5)),e.addPole(Object(gi.e)(0,-.5)),e.addPole(Object(gi.e)(0,-.5),n);const l={v0:0,v1:1};return e.addVertex(t,n),e.addVertex(i,n),e.addSegment({v0:0,v1:1},l,{v0:3,v1:3}),e.addVertex(i,s),e.addVertex(r,s),e.addSegment({v0:2,v1:3},l,{v0:2,v1:1}),e.addVertex(r,o),e.addVertex(a,o),e.addSegment({v0:4,v1:5},l,{v0:0,v1:0}),e.addVertex(a,c),e.addVertex(t,c),e.addSegment({v0:6,v1:7},l,{v0:1,v1:2}),e}}class xs{constructor(e){this.vertices=[],this.offset=Object(z.f)(),this.xform=Object(Se.d)(),this.vertices=e;const t=Math.floor((e.length-1)/2);Object(F.k)(this.offset,this.vertices[t].pos);for(const i of this.vertices)Object(F.j)(i.pos,i.pos,this.offset);Object(xe.j)(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const e=this.vertices.length;let t=this.vertices[0];t.index=0,Object(F.w)(t.vLeft,0,0,0),t.vLeftLength=0,Object(F.j)(t.vRight,this.vertices[1].pos,t.pos),t.vRightLength=Object(F.p)(t.vRight),Object(F.r)(t.vRight,t.vRight);let i=t;for(let r=1;r<e;++r)t=this.vertices[r],t.index=r,Object(F.k)(t.vLeft,i.vRight),t.vLeftLength=i.vRightLength,r<e-1?(Object(F.j)(t.vRight,this.vertices[r+1].pos,t.pos),t.vRightLength=Object(F.p)(t.vRight),Object(F.r)(t.vRight,t.vRight)):(Object(F.k)(t.vRight,t.vLeft),t.vRightLength=t.vLeftLength),i=t}}class Ss{numProfilesPerJoin(){return 1}extrude(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],!1)}}class Ts{constructor(e=.8*Math.PI,t=1){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,i){const r=Hs;if(Math.abs(e.rotationAngle)>=this.cutoffAngle)for(let a=0;a<this.numBendSubdivisions+1;++a){Object(xe.d)(Ws,.5*-e.rotationAngle+a*e.rotationAngle/this.numBendSubdivisions,e.rotationFrame.up),Os(r,e.frame,Ws);for(let a=0;a<t.vertices.length;++a)Object(mi.k)(t.vertices[a],e.rotationRight)*e.rotationAngle>=0?i(e.index,r,t.vertices[a],t.vertexNormals[a],!1):(Object(mi.p)(Ns,t.vertices[a],e.miterStretch),i(e.index,e.frame,Ns,t.vertexNormals[a],!0))}else for(let a=0;a<this.numBendSubdivisions+1;++a)for(let r=0;r<t.vertices.length;++r){const a=Object(mi.k)(t.vertices[r],e.rotationRight)*e.rotationAngle>=0;Object(mi.p)(Ns,t.vertices[r],e.miterStretch),i(e.index,e.frame,Ns,t.vertexNormals[r],!a)}}}const Cs={generateUV:!1};class Es{rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],0,0)}}class As extends Es{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}}class ws extends Es{constructor(e,t=0,i=!1){super(),this.profile=e,this.profilePlaneOffset=t,this.flip=i}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.index,e.frame,t.vertices[r],t.vertexNormals[r],this.profilePlaneOffset,0)}rebuildCapGeometry(e,t){const i=Fs;Object(mi.s)(i,0,0);const r=this.flip?1:-1;for(let a=0;a<this.profile.vertices.length;++a)t(e.index,e.frame,this.profile.vertices[a],i,this.profilePlaneOffset,r)}buildTopology(e,t){const i=this.vertexBufferStart+this.profile.vertexIndices[0];for(let r=1;r<this.profile.numSegments;++r){const e=this.profile.vertexIndices[2*r+0],a=this.profile.vertexIndices[2*r+1],n=this.vertexBufferStart+e,s=this.vertexBufferStart+a;this.flip?t(s,n,i):t(i,n,s)}}}class Rs extends Es{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}getNumVertices(){let e=0;return e=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(e+=this.profile.vertices.length),e+=this.profile.poles.length,e}getNumIndices(){let e=0;e+=2*this.profile.numSegments*(this.numSegments-1);for(let t=0;t<this.profile.numSegments;++t){const i=this.profile.vertexIndices[2*t+0],r=this.profile.vertexIndices[2*t+1];this.profile.poleIndices[i]===this.profile.poleIndices[r]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){const i=e.frame,r=.5*this.sign,a=Ns,n=Fs;Object(mi.s)(n,0,0);for(let s=0;s<this.profile.poles.length;++s){const a=this.profile.poles[s];a.normal?t(e.index,i,a.position,a.normal,r,0):t(e.index,i,a.position,n,r,this.sign)}if(this.breakNormals)for(let s=0;s<this.profile.vertices.length;++s)t(e.index,i,this.profile.vertices[s],this.profile.vertexNormals[s],0,0);for(let s=0;s<this.numSegments-1;++s){const o=(1-(s+1)/this.numSegments)*Math.PI*.5,c=Math.sin(o),l=Math.cos(o);for(let s=0;s<this.profile.vertices.length;++s){const o=this.profile.poles[this.profile.poleIndices[s]];Object(mi.f)(a,this.profile.vertices[s],o.position),Object(mi.g)(a,a,c),o.normal?(Object(mi.m)(a,a,o.position),t(e.index,i,a,o.normal,r*l,0)):(Object(mi.i)(n,a),Object(mi.g)(n,n,c),Object(mi.m)(a,a,o.position),t(e.index,i,a,n,r*l,this.sign*l))}}}buildTopology(e,t){const i=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,r=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let a=0;a<this.profile.numSegments;++a){const e=this.profile.vertexIndices[2*a+0],n=this.profile.vertexIndices[2*a+1],s=this.vertexBufferStart+this.profile.poleIndices[e],o=this.vertexBufferStart+this.profile.poleIndices[n];let c=i+e,l=i+n;for(let i=0;i<this.numSegments-1;++i){const a=r+i*this.profile.vertices.length+e,s=r+i*this.profile.vertices.length+n;this.flip?(t(a,l,c),t(l,a,s)):(t(c,l,a),t(s,a,l)),c=a,l=s}this.flip?(t(s,l,c),s!==o&&t(s,o,l)):(t(c,l,s),s!==o&&t(l,o,s))}}}class Ps{constructor(e,t,i,r,a,n=Cs){this.options=n,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=t,this.path=e,this.extruder=i,this.startCap=r,this.endCap=a;const s=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*s+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const o=this.startCap.getNumVertices();this.numVerticesTotal+=o,this.numNormalsTotal+=o,this.endCap.vertexBufferStart=this.numVerticesTotal;const c=this.endCap.getNumVertices();this.numVerticesTotal+=c,this.numNormalsTotal+=c,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this._rebuildGeometry(),this.buildTopology()}emitVertex(e,t,i,r,a){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,a){const t=this.path.vertices[e];this.profileRightAxisData[4*this._extrusionVertexCount+3]=t.rotationRight[0]*t.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=t.rotationRight[1]*t.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(e,t,i,r,a,n){this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=i[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=i[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,this.profileRightAxisData[4*this._extrusionVertexCount+3]=a,this.profileUpAxisData[4*this._extrusionVertexCount+3]=n,++this._extrusionVertexCount}emitTriangle(e,t,i){this.vertexIndices[3*this._triangleCount+0]=e,this.vertexIndices[3*this._triangleCount+1]=t,this.vertexIndices[3*this._triangleCount+2]=i,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[e],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[t],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[i],this.normalIndices[3*this._triangleCount+0]=e,this.normalIndices[3*this._triangleCount+1]=t,this.normalIndices[3*this._triangleCount+2]=i,++this._triangleCount}_rebuildGeometry(){const e=(e,t,i,r,a)=>this.emitVertex(e,t,i,r,a),t=(e,t,i,r,a,n)=>this.emitCapVertex(e,t,i,r,a,n);this._extrusionVertexCount=0;for(const i of this.path.vertices)this.originData[3*i.index+0]=i.pos[0],this.originData[3*i.index+1]=i.pos[1],this.originData[3*i.index+2]=i.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,t);for(let i=1;i<this.path.vertices.length-1;++i)this.extruder.extrude(this.path.vertices[i],this.profile,e);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,t),this.startCap.rebuildCapGeometry(this.path.vertices[0],t),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],t),this.profile.hasUV()&&this.options.generateUV)for(let i=0;i<this.profile.uvs.length;++i)this.uvData[2*i+0]=this.profile.uvs[i],this.uvData[2*i+1]=0}buildTopology(){const e=(e,t,i)=>this.emitTriangle(e,t,i);this._triangleCount=0;const t=this.profile.vertices.length,i=this.profile.numSegments,r=this.numExtrusionProfiles-1;let a=i*r*2*3;this.startCap.indexBufferStart=a,this.startCap.firstProfileVertexIndex=0,a+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=a,this.endCap.firstProfileVertexIndex=t*(this.numExtrusionProfiles-1),a+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(a),this.normalIndices=new Uint32Array(a),this.pathVertexIndices=new Uint32Array(a),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(a));for(let n=0;n<i;++n){const i=this.profile.vertexIndices[2*n],a=this.profile.vertexIndices[2*n+1];for(let n=0;n<r;++n){const r=n*t+i,s=(n+1)*t+a,o=n*t+a;e(r,(n+1)*t+i,s),e(r,s,o)}}this.startCap.buildTopology(this.path.vertices[0],e),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],e)}onPathChanged(){this._rebuildGeometry()}}class Is{constructor(e){this.builder=e}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}}class Ds extends Is{constructor(e){super(e),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=new Float32Array(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Float32Array(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;for(let t=0;t<this.builder.numVerticesTotal;++t){let i=this.builder.pathVertexData[t];const r=0===i||i===this.builder.path.vertices.length-1;i*=3;const a=Ls;Object(F.w)(a,this.builder.originData[i++],this.builder.originData[i++],this.builder.originData[i]);const n=4*t,s=Us,o=Ns,c=Gs,l=Vs,d=Bs;let h=0,u=0;if(Object(F.w)(l,this.builder.profileRightAxisData[n],this.builder.profileRightAxisData[n+1],this.builder.profileRightAxisData[n+2]),Object(F.w)(d,this.builder.profileUpAxisData[n],this.builder.profileUpAxisData[n+1],this.builder.profileUpAxisData[n+2]),Object(mi.s)(o,this.builder.profileVertexAndNormalData[n]*e[0],this.builder.profileVertexAndNormalData[n+1]*e[1]),r)Object(F.g)(c,d,l),h=this.builder.profileRightAxisData[n+3]*e[0],u=this.builder.profileUpAxisData[n+3];else{const e=Fs,t=zs;Object(mi.s)(e,this.builder.profileRightAxisData[n+3],this.builder.profileUpAxisData[n+3]);const i=Object(mi.l)(e);Object(mi.i)(e,e);const r=Object(mi.k)(o,e);if(Math.abs(r)>i){Object(mi.s)(t,-e[1],e[0]);const a=Object(mi.k)(o,t);Object(mi.g)(e,e,i*Math.sign(r)),Object(mi.g)(t,t,a),Object(mi.m)(o,e,t)}Object(F.w)(c,0,0,0)}Object(F.w)(s,l[0]*o[0]+d[0]*o[1],l[1]*o[0]+d[1]*o[1],l[2]*o[0]+d[2]*o[1]),this.vertexAttributePosition[3*t+0]=a[0]+s[0]+c[0]*h,this.vertexAttributePosition[3*t+1]=a[1]+s[1]+c[1]*h,this.vertexAttributePosition[3*t+2]=a[2]+s[2]+c[2]*h;const p=Ns;Object(mi.s)(p,this.builder.profileVertexAndNormalData[n+2],this.builder.profileVertexAndNormalData[n+3]),this.vertexAttributeNormal[3*t+0]=l[0]*p[0]+d[0]*p[1]+c[0]*u,this.vertexAttributeNormal[3*t+1]=l[1]*p[0]+d[1]*p[1]+c[1]*u,this.vertexAttributeNormal[3*t+2]=l[2]*p[0]+d[2]*p[1]+c[2]*u}}createGeometryData(){const e=[[we.a.POSITION,this.builder.vertexIndices],[we.a.NORMAL,this.builder.normalIndices]],t=[[we.a.POSITION,{size:3,data:this.vertexAttributePosition,exclusive:!0}],[we.a.NORMAL,{size:3,data:this.vertexAttributeNormal,exclusive:!0}]];if(this.vertexAttributeColor){const i=this.builder.vertexIndices.length;e.push([we.a.COLOR,new Uint32Array(i)]),t.push([we.a.COLOR,{size:4,data:this.vertexAttributeColor}])}return{vertexAttributes:t,indices:e}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(e,t,i){const r=this.builder.vertexIndices,a={size:3,data:this.vertexAttributePosition},n=r.length/3;Object(Yt.g)(e,t,0,n,r,a,void 0,void 0,i)}}class Ms extends Is{constructor(e,t,i,r){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=i,this.opacityAttributeValue=r,this.vvData=null,this.baked=new Ds(e),this.vvData=new Float32Array(4*this.builder.path.vertices.length);for(let a=0;a<this.builder.path.vertices.length;++a){this.vvData[4*a+0]=t,this.vvData[4*a+1]=i,this.vvData[4*a+2]=r;const e=0===a||a===this.builder.path.vertices.length-1;this.vvData[4*a+3]=e?1:0}}createGeometryData(){return{vertexAttributes:[[we.a.POSITION,{size:3,data:this.builder.originData,exclusive:!0}],[we.a.PROFILERIGHT,{size:4,data:this.builder.profileRightAxisData,exclusive:!0}],[we.a.PROFILEUP,{size:4,data:this.builder.profileUpAxisData,exclusive:!0}],[we.a.PROFILEVERTEXANDNORMAL,{size:4,data:this.builder.profileVertexAndNormalData,exclusive:!0}],[we.a.FEATUREVALUE,{size:4,data:this.vvData,exclusive:!0}]],indices:[[we.a.POSITION,this.builder.pathVertexIndices],[we.a.PROFILERIGHT,this.builder.vertexIndices],[we.a.PROFILEUP,this.builder.vertexIndices],[we.a.PROFILEVERTEXANDNORMAL,this.builder.vertexIndices],[we.a.FEATUREVALUE,this.builder.pathVertexIndices]]}}}const Ls=Object(z.f)(),Ns=Object(gi.a)(),Fs=Object(gi.a)(),zs=Object(gi.a)(),Us=Object(z.f)(),Gs=Object(z.f)(),Vs=Object(z.f)(),Bs=Object(z.f)(),ks=Object(z.f)(),Hs=vs(),Ws=Object(Se.d)();var qs=i(689),$s=i(1155),Xs=i(915),Ys=i(502),Zs=i(625),Qs=i(1156);const Js=new Map([[we.a.POSITION,0],[we.a.PROFILERIGHT,1],[we.a.PROFILEUP,2],[we.a.PROFILEVERTEXANDNORMAL,3],[we.a.FEATUREVALUE,4]]);class Ks extends Wt.a{initializeProgram(e){const t=Ks.shader.get(),i=this.configuration,r=t.build({oitEnabled:i.transparencyPassType===$e.i.Color,output:i.output,viewingMode:e.viewingMode,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:i.receiveShadows,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,pbrMode:Ys.a.Disabled,useCustomDTRExponentForWater:!1,receiveAmbientOcclusion:i.receiveSSAO,doubleSidedMode:i.doubleSidedMode,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new Xt.a(e.rctx,r,Js)}bindPass(e,t){var i,r;Object(kt.b)(this.program,t.camera.projectionMatrix),this.program.setUniform3fv("size",e.size),t.multipassTerrainEnabled&&(this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(ya.a)(this.program,t)),this.configuration.output!==Lt.a.Color&&this.configuration.output!==Lt.a.Alpha||this.program.setUniform1f("opacity",e.opacity),this.configuration.output===Lt.a.Color?(t.lighting.setUniforms(this.program,!1,!1),this.program.setUniform3fv("ambient",e.ambient),this.program.setUniform3fv("diffuse",e.diffuse),this.program.setUniform3fv("specular",e.specular),this.program.setUniform1f("opacity",e.opacity)):this.configuration.output!==Lt.a.Depth&&this.configuration.output!==Lt.a.Shadow||this.program.setUniform2fv("nearFar",t.camera.nearFar),Object($s.b)(this.program,e),null==(i=t.shadowMap)||i.bind(this.program),null==(r=t.ssaoHelper)||r.bind(this.program,t.camera)}bindDraw(e){Object(kt.c)(this.program,e),Object(Gt.c)(this.program,this.configuration,e),this.program.rebindTextures(),this.configuration.output!==Lt.a.Color&&this.configuration.output!==Lt.a.Alpha||Object(kt.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),this.configuration.output===Lt.a.Color&&Object(Zs.c)(this.program,e),this.configuration.output===Lt.a.Normal&&Object(Xs.b)(this.program,e.camera.viewInverseTransposeMatrix)}_setPipelineState(e){const t=this.configuration,i=e===$e.i.NONE,r=e===$e.i.FrontFace;return Object(Jt.f)({blending:t.output!==Lt.a.Color&&t.output!==Lt.a.Alpha||!t.transparent?null:i?ja.d:Object(ja.f)(e),culling:(e=>!e.slicePlaneEnabled&&!(e.transparent||e.doubleSidedMode===qs.b.None))(t)&&Jt.e,depthTest:{func:Object(ja.g)(e)},depthWrite:i||r?Jt.d:null,colorWrite:Jt.c,stencilWrite:t.sceneHasOcludees?xa.h:null,stencilTest:t.sceneHasOcludees?xa.c:null,polygonOffset:i||r?null:ja.a})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}Ks.shader=new Ht.a(Qs.a,(()=>i.e(333).then(i.bind(null,1361))));class eo extends qt.a{constructor(){super(...arguments),this.output=Lt.a.Color,this.doubleSidedMode=qs.b.None,this.receiveShadows=!1,this.receiveSSAO=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.sceneHasOcludees=!1,this.transparencyPassType=$e.i.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(r.a)([Object(qt.b)({count:Lt.a.COUNT})],eo.prototype,"output",void 0),Object(r.a)([Object(qt.b)({count:qs.b.COUNT})],eo.prototype,"doubleSidedMode",void 0),Object(r.a)([Object(qt.b)()],eo.prototype,"receiveShadows",void 0),Object(r.a)([Object(qt.b)()],eo.prototype,"receiveSSAO",void 0),Object(r.a)([Object(qt.b)()],eo.prototype,"vvSize",void 0),Object(r.a)([Object(qt.b)()],eo.prototype,"vvColor",void 0),Object(r.a)([Object(qt.b)()],eo.prototype,"vvOpacity",void 0),Object(r.a)([Object(qt.b)()],eo.prototype,"slicePlaneEnabled",void 0),Object(r.a)([Object(qt.b)()],eo.prototype,"transparent",void 0),Object(r.a)([Object(qt.b)()],eo.prototype,"sceneHasOcludees",void 0),Object(r.a)([Object(qt.b)({count:$e.i.COUNT})],eo.prototype,"transparencyPassType",void 0),Object(r.a)([Object(qt.b)()],eo.prototype,"multipassTerrainEnabled",void 0),Object(r.a)([Object(qt.b)()],eo.prototype,"cullAboveGround",void 0);class to extends It.b{constructor(e){super(e,ro),this.supportsEdges=!0,this._vertexAttributeLocations=Js,this.techniqueConfig=new eo,this.vertexBufferLayout=to.getVertexBufferLayout(this.parameters)}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,e!==Lt.a.Color&&e!==Lt.a.Alpha||(this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?qs.b.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?qs.b.WindingOrder:qs.b.None,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows,this.techniqueConfig.receiveSSAO=!!t.ssaoEnabled&&this.parameters.receiveSSAO),this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}isVisibleInPass(e){return e!==On.a.MATERIAL_DEPTH_SHADOWMAP_ALL&&e!==On.a.MATERIAL_DEPTH_SHADOWMAP_DEFAULT&&e!==On.a.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||this.parameters.castShadows}isVisible(){const e=this.parameters;return!!super.isVisible()&&e.opacity>0}intersect(e,t,i,r,n,s,o){const c=e;if(!fs(c))return;const l=c.path,d=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const e=this.parameters.vvSizeOffset,t=this.parameters.vvSizeFactor,i=this.parameters.vvSizeMinSize,r=this.parameters.vvSizeMaxSize,a=l.sizeAttributeValue;d[0]*=Object(gr.e)(e[0]+a*t[0],i[0],r[0]),d[1]*=Object(gr.e)(e[2]+a*t[2],i[2],r[2])}const h=Math.max(d[0],d[1]),u=e.boundingInfo;if(Object(a.j)(u))return void this._intersectTriangles(l,d,n,s,o);const p=Object(G.p)(u.bbMin[0]-h,u.bbMin[1]-h,u.bbMin[2]-h,u.bbMax[0]+h,u.bbMax[1]+h,u.bbMax[2]+h),f=[s[0]-n[0],s[1]-n[1],s[2]-n[2]],b=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]),m=[b/f[0],b/f[1],b/f[2]];Object(Yt.d)(p,n,m,r.tolerance)&&this._intersectTriangles(l,d,n,s,o)}_intersectTriangles(e,t,i,r,a){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(i,r,a)}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return null;const r=i.get(we.a.POSITION);return Object(ka.a)(r,null,!1,t)}createBufferWriter(){return new ao(this.vertexBufferLayout)}requiresSlot(e){return e===(this.parameters.transparent?zt.a.TRANSPARENT_MATERIAL:zt.a.OPAQUE_MATERIAL)||e===zt.a.DRAPED_MATERIAL}createGLMaterial(e){return e.output===Lt.a.Color||e.output===Lt.a.Alpha||e.output===Lt.a.Depth||e.output===Lt.a.Normal||e.output===Lt.a.Highlight||e.output===Lt.a.Shadow&&this.parameters.castShadows?new io(e):null}static getVertexBufferLayout(e){let t=Object(Mt.a)().vec3f(we.a.POSITION).vec4f(we.a.PROFILERIGHT).vec4f(we.a.PROFILEUP).vec4f(we.a.PROFILEVERTEXANDNORMAL);return(e.vvColorEnabled||e.vvSizeEnabled||e.vvOpacityEnabled)&&(t=t.vec4f(we.a.FEATUREVALUE)),t}}class io extends Ft.a{updateParameters(e){return this.ensureTechnique(Ks,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}_updateShadowState(e){(Object(a.j)(this.technique)||e.shadowMappingEnabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:e.shadowMappingEnabled})}beginSlot(e){return this._output!==Lt.a.Color&&this._output!==Lt.a.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}const ro={size:[1,1,1],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],opacity:1,doubleSided:!1,doubleSidedType:"normal",receiveSSAO:!0,receiveShadows:!1,castShadows:!0,slicePlaneEnabled:!1,transparent:!1,sceneHasOcludees:!1,...ga.a,...It.a};class ao{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(we.a.POSITION).length}write(e,t,i,r){const a=e=>{if(t.vertexAttributes.has(e)){const a=t.vertexAttributes.get(e),n=t.indices.get(e);Object(yn.a)(4===a.size);const s=i.getField(e,Ci.C);if(!s)throw new Error("unable to acquire view for "+e);Object(Ut.b)(n,a.data,s,r)}};a(we.a.PROFILERIGHT),a(we.a.PROFILEUP),a(we.a.PROFILEVERTEXANDNORMAL),this.vertexBufferLayout.hasField(we.a.FEATUREVALUE)&&a(we.a.FEATUREVALUE),Object(Ut.d)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)}}const no=["polyline"];function so(e,t,i){switch(t){case"world":for(const t of e.vertices)Object(F.f)(fo,t.pos,e.offset),i.worldUpAtPosition(fo,po),t.setFrameFromUpVector(po),t.computeRotationAxisAndAngleFromUpVector();break;case"path":Object(F.f)(fo,e.vertices[0].pos,e.offset),i.worldUpAtPosition(fo,po),function(e,t){let i=null;const r=e.vertices.length,a=.99619469809,n=Object(z.f)(),s=Object(z.f)(),o=Object(z.f)(),c=Object(z.f)(),l=Object(z.f)(),d=Object(z.f)(),h=Object(ms.d)();let u=e.vertices[0];Object(F.k)(s,t),Object(F.w)(n,0,1,0),ct.a.makeOrthoBasisDirUpFallback(u.vRight,s,n,n,o,s,a),Object(F.k)(u.frame.up,s),Object(F.k)(u.frame.right,o),i=u;for(let p=1;p<r;++p){u=e.vertices[p],Object(F.f)(l,u.vLeft,u.vRight);let t=Object(F.p)(l);t>0?(t=1/Math.sqrt(t),l[0]=l[0]*t,l[1]=l[1]*t,l[2]=l[2]*t):(l[0]=u.vRight[0],l[1]=u.vRight[1],l[2]=u.vRight[2]),Object(F.f)(d,i.pos,i.frame.up),Object(ms.g)(u.pos,l,h),Object(ms.m)(h,Object(gs.g)(d,u.vLeft),c)?(Object(F.j)(c,c,u.pos),Object(F.r)(s,c),Object(F.g)(o,l,s),Object(F.r)(o,o)):ct.a.makeOrthoBasisDirUpFallback(l,i.frame.up,i.frame.right,n,o,s,a),Object(F.k)(u.frame.up,s),Object(F.k)(u.frame.right,o),i=u}}(e,po);for(const t of e.vertices){const e=Math.sign(Object(F.h)(t.frame.right,t.vRight));Object(F.g)(t.rotationFrame.up,t.vRight,t.vLeft),Object(F.e)(t.rotationFrame.up,t.rotationFrame.up,e),Object(F.r)(t.rotationFrame.up,t.rotationFrame.up);const i=Object(F.h)(t.rotationFrame.up,t.frame.up),r=Object(F.h)(t.rotationFrame.up,t.frame.right);if(Object(F.e)(fo,t.frame.up,-r),Object(F.e)(bo,t.frame.right,i),Object(F.f)(fo,fo,bo),Object(F.r)(t.rotationFrame.right,fo),ys(t.rotationRight,t.frame,t.rotationFrame.right),Object(F.s)(fo,t.vLeft),t.rotationAngle=-e*(Math.PI-Object(gr.b)(Object(F.h)(fo,t.vRight))),Math.abs(t.rotationAngle)>0){const e=Object(gr.o)(Math.cos(.5*t.rotationAngle));os(t.miterStretch,1+(e-1)*t.rotationRight[0]*t.rotationRight[0],(e-1)*t.rotationRight[0]*t.rotationRight[1],(e-1)*t.rotationRight[0]*t.rotationRight[1],1+(e-1)*t.rotationRight[1]*t.rotationRight[1])}const a=Math.PI-t.rotationAngle;t.maxStretchDistance=Math.abs(Math.min(t.vLeftLength,t.vRightLength)*Object(gr.o)(Math.cos(.5*a)))}}}function oo(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function co(e,t,i,r){let a=0;for(const n of e.vertices)Object(Te.g)(n.posES,i,t,r,mo),a+=mo.sampledElevation,Object(F.f)(po,n.pos,e.offset),r.setAltitude(po,mo.z),Object(F.j)(n.pos,po,e.offset);return e.updatePathVertexInformation(),a/e.vertices.length}function lo(e,t,i,r){const a=e.stageObject,n=a.geometryRecords;let s=0;ho.spatialReference=r.spatialReference;for(const o of n){const e=o.geometry;if(!fs(e))continue;const n=e.path,c=n.builder.path,l=e.geometrySR;uo.spatialReference=l,s+=co(c,t,i,r),"world"!==e.upVectorAlignment&&so(c,e.upVectorAlignment,r),n.onPathChanged(),e.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(o)}return s/n.length}const ho=Object(B.g)(0,0,0,null),uo=Object(B.g)(0,0,0,null),po=Object(z.f)(),fo=Object(us.b)(),bo=Object(us.b)(),mo=new Te.a,go=3,vo=3,Oo=10;var yo=i(208);function _o(e,t,i,r,n=1){Object(F.w)(To,1,0,0),Object(F.w)(Co,0,1,0),Object(F.w)(Eo,0,0,1),function(e,t){Object(F.w)(zo,0,0,0);for(let i=0;i<t.count-1;i++)t.getVec(i,xo),Object(F.f)(zo,zo,xo);Object(F.e)(e,zo,1/(t.count-1))}(jo,t),function(e,t){const i=e.count-1;return Object(ms.e)(e,t,0,Math.floor(i/3),Math.floor(i*(2/3)))}(t,So)&&function(e,t,i,r,n,s){Object(a.k)(n)?(n.basisMatrixAtPosition(s,Mo),Object(F.w)(Lo,Mo[0],Mo[1],Mo[2]),Object(F.w)(No,Mo[4],Mo[5],Mo[6]),Object(F.w)(Fo,Mo[8],Mo[9],Mo[10])):(Object(F.w)(Lo,1,0,0),Object(F.w)(No,0,1,0),Object(F.w)(Fo,0,0,1));const o=Object(ms.q)(e);Object(F.h)(o,Fo)<0&&Object(F.e)(o,o,-1),Object(F.k)(r,o);const c=Object(F.h)(o,No),l=Object(F.h)(o,Lo);Math.abs(c)<Math.abs(l)?(Object(F.c)(t,Lo,o,-l),Object(F.r)(t,t),Object(F.g)(i,t,o),Object(F.r)(i,i),Object(F.e)(i,i,-1)):(Object(F.c)(i,No,o,-c),Object(F.r)(i,i),Object(F.g)(t,i,o),Object(F.r)(t,t))}(So,To,Co,Eo,i,jo),Object(mi.s)(Ao,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),Object(mi.s)(wo,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let a=0;a<t.count;a++){t.getVec(a,xo);const e=Object(F.h)(To,xo),i=Object(F.h)(Co,xo);Ao[0]=Math.min(Ao[0],e),Ao[1]=Math.min(Ao[1],i),wo[0]=Math.max(wo[0],e),wo[1]=Math.max(wo[1],i)}const s=Object(F.h)(Eo,jo);Uo(Po,Ao[0],Ao[1],s,To,Co,Eo),Uo(Io,wo[0],Ao[1],s,To,Co,Eo),Uo(Do,Ao[0],wo[1],s,To,Co,Eo),Object(F.j)(Io,Io,Po),Object(F.e)(Io,Io,.5),Object(F.j)(Do,Do,Po),Object(F.e)(Do,Do,.5),Object(F.f)(Po,Po,Io),Object(F.f)(Po,Po,Do);const o=Ao[0]%n,c=Ao[1]%n;Ro[0]=Ao[0]-o,Ro[1]=Ao[1]-c;for(let a=0;a<t.count;a++){t.getVec(a,xo),e.setValues(a,(Object(F.h)(To,xo)-Ro[0])/n,(Object(F.h)(Co,xo)-Ro[1])/n,Ro[0]/n,Ro[1]/n);for(let e=0;e<3;e++)r.set(a,e,Po[e]),r.set(a,e+3,Io[e]),r.set(a,e+6,Do[e])}}const jo=Object(z.f)(),xo=Object(z.f)(),So=Object(ms.d)(),To=Object(z.f)(),Co=Object(z.f)(),Eo=Object(z.f)(),Ao=Object(gi.a)(),wo=Object(gi.a)(),Ro=Object(gi.a)(),Po=Object(z.f)(),Io=Object(z.f)(),Do=Object(z.f)();const Mo=Object(Se.d)(),Lo=Object(z.f)(),No=Object(z.f)(),Fo=Object(z.f)();const zo=Object(z.f)();function Uo(e,t,i,r,a,n,s){Object(F.w)(e,t*a[0]+i*n[0]+r*s[0],t*a[1]+i*n[1]+r*s[1],t*a[2]+i*n[2]+r*s[2])}var Go=i(751),Vo=i(1016),Bo=i(713),ko=i(1157);class Ho extends Wt.a{initializeProgram(e){const t=Ho.shader.get(),i=this.configuration,r=t.build({output:i.output,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,style:i.style,patternSpacing:i.patternSpacing,lineWidth:i.lineWidth,draped:i.draped,oitEnabled:i.transparencyPassType===$e.i.Color,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new Xt.a(e.rctx,r,$o)}bindPass(e,t){Object(kt.b)(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("uColor",e.color),this.configuration.draped?(this.program.setUniform1f("worldToScreenRatio",1/t.screenToPCSRatio),this.program.setUniform1f("texelSize",1/t.camera.pixelRatio)):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/t.camera.perScreenPixelRatio),this.configuration.output===Lt.a.Highlight&&Object(Oa.b)(this.program,t),(this.configuration.output===Lt.a.Depth||t.multipassTerrainEnabled)&&this.program.setUniform2fv("nearFar",t.camera.nearFar),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(ya.a)(this.program,t))}bindDraw(e){Object(kt.c)(this.program,e),Object(kt.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),Object(Gt.c)(this.program,this.configuration,e),this.program.rebindTextures()}_setPipelineState(e,t){const i=this.configuration,r=e===$e.i.NONE,a=e===$e.i.FrontFace;return Object(Jt.f)({blending:i.output===Lt.a.Color||i.output===Lt.a.Alpha?r?ja.d:Object(ja.f)(e):null,culling:Object(Jt.b)(i.cullFace),depthTest:{func:Object(ja.g)(e)},depthWrite:r?i.writeDepth&&Jt.d:Object(ja.h)(e),colorWrite:Jt.c,stencilWrite:i.sceneHasOcludees?xa.h:null,stencilTest:i.sceneHasOcludees?t?xa.d:xa.c:null,polygonOffset:r||a?i.polygonOffset&&Wo:Object(ja.e)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}Ho.shader=new Ht.a(ko.a,(()=>i.e(334).then(i.bind(null,1362))));const Wo={factor:1,units:1};class qo extends qt.a{constructor(){super(...arguments),this.output=Lt.a.Color,this.cullFace=$e.b.None,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.enableOffset=!0,this.transparencyPassType=$e.i.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(r.a)([Object(qt.b)({count:Lt.a.COUNT})],qo.prototype,"output",void 0),Object(r.a)([Object(qt.b)({count:$e.b.COUNT})],qo.prototype,"cullFace",void 0),Object(r.a)([Object(qt.b)()],qo.prototype,"slicePlaneEnabled",void 0),Object(r.a)([Object(qt.b)()],qo.prototype,"vertexColors",void 0),Object(r.a)([Object(qt.b)()],qo.prototype,"polygonOffset",void 0),Object(r.a)([Object(qt.b)()],qo.prototype,"writeDepth",void 0),Object(r.a)([Object(qt.b)()],qo.prototype,"sceneHasOcludees",void 0),Object(r.a)([Object(qt.b)({count:Vo.a.COUNT})],qo.prototype,"style",void 0),Object(r.a)([Object(qt.b)()],qo.prototype,"patternSpacing",void 0),Object(r.a)([Object(qt.b)()],qo.prototype,"lineWidth",void 0),Object(r.a)([Object(qt.b)()],qo.prototype,"enableOffset",void 0),Object(r.a)([Object(qt.b)()],qo.prototype,"draped",void 0),Object(r.a)([Object(qt.b)({count:$e.i.COUNT})],qo.prototype,"transparencyPassType",void 0),Object(r.a)([Object(qt.b)()],qo.prototype,"multipassTerrainEnabled",void 0),Object(r.a)([Object(qt.b)()],qo.prototype,"cullAboveGround",void 0);const $o=new Map([[we.a.POSITION,0],[we.a.COLOR,3],[we.a.UVMAPSPACE,4],[we.a.BOUNDINGRECT,5]]);class Xo extends It.b{constructor(e){super(e,Qo),this.supportsEdges=!0,this._vertexAttributeLocations=$o,this.techniqueConfig=new qo}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.style=this.parameters.style,this.techniqueConfig.patternSpacing=this.parameters.patternSpacing,this.techniqueConfig.lineWidth=this.parameters.lineWidth,this.techniqueConfig.draped=this.parameters.draped,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.enableOffset=t.camera.relativeElevation<ja.b,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(e,t,i,r,a,n,s){Object(Yt.f)(e,t,r,a,n,void 0,s)}requiresSlot(e,t){return e===zt.a.DRAPED_MATERIAL||(Object(ba.b)(t)===Lt.a.Highlight?e===zt.a.OPAQUE_MATERIAL:e===(this.parameters.writeDepth?zt.a.TRANSPARENT_MATERIAL:zt.a.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL))}createGLMaterial(e){return e.output===Lt.a.Color||e.output===Lt.a.Alpha||e.output===Lt.a.Highlight||e.output===Lt.a.Depth&&this.parameters.writeLinearDepth?new Yo(e):null}createBufferWriter(){const e=Object(Mt.a)().vec3f(we.a.POSITION).vec4u8(we.a.COLOR).vec4f(we.a.UVMAPSPACE);return this.parameters.draped||e.mat3f(we.a.BOUNDINGRECT),new Zo(e)}}class Yo extends Ft.a{updateParameters(e){return this.ensureTechnique(Ho,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output!==Lt.a.Color&&this._output!==Lt.a.Alpha||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}class Zo extends Bo.a{write(e,t,i,r){for(const a of this.vertexBufferLayout.fieldNames){const n=t.vertexAttributes.get(a),s=t.indices.get(a);if(n&&s)switch(a){case we.a.POSITION:{Object(yn.a)(3===n.size);const t=i.getField(a,Ci.u);t&&Object(Ut.f)(s,n.data,e.transformation,t,r);break}case we.a.COLOR:{Object(yn.a)(3===n.size||4===n.size);const e=i.getField(a,Ci.J);e&&Object(Ut.c)(s,n.data,n.size,e,r);break}case we.a.UVMAPSPACE:{Object(yn.a)(4===n.size);const e=i.getField(a,Ci.C);e&&Object(Ut.b)(s,n.data,e,r);break}case we.a.BOUNDINGRECT:{Object(yn.a)(9===n.size);const t=i.getField(a,Ci.f);t&&this.writeBoundingRect(s,n.data,e.transformation,t,r);break}}}}writeBoundingRect(e,t,i,r,a){const n=i,s=r.typedBuffer,o=r.typedBufferStride,c=e.length;a*=o;for(let l=0;l<c;++l){const i=9*e[l],r=t[i],c=t[i+1],d=t[i+2];s[a]=n[0]*r+n[4]*c+n[8]*d+n[12],s[a+1]=n[1]*r+n[5]*c+n[9]*d+n[13],s[a+2]=n[2]*r+n[6]*c+n[10]*d+n[14];for(let e=3;e<9;++e)s[a+e]=t[i+e];a+=o}}}const Qo={color:[1,1,1,1],writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:$e.b.None,sceneHasOcludees:!1,style:Vo.a.Cross,patternSpacing:10,lineWidth:1,draped:!0,...It.a};function Jo(e,t,i){return function(e,t,i){return Object(a.k)(e)?"none"===e.style||"solid"===e.style?("none"===e.style&&(t.color=Object(at.g)(0,0,0,0),t.transparent=!0),new Go.a(t)):(t.style=function(e){switch(e){case"horizontal":return Vo.a.Horizontal;case"vertical":return Vo.a.Vertical;case"cross":return Vo.a.Cross;case"forward-diagonal":return Vo.a.ForwardDiagonal;case"backward-diagonal":return Vo.a.BackwardDiagonal;case"diagonal-cross":return Vo.a.DiagonalCross;default:return}}(e.style),t.draped=i.isDraped,new Xo(t)):new Go.a(t)}(function(e){return e&&e.pattern||null}(e),t,i)}function Ko(e,t){if(function(e){return e.material instanceof Xo&&!e.material.parameters.draped}(e)){const i=e.geometry.vertexAttributes,r=i.get(we.a.POSITION).data,a=i.get(we.a.UVMAPSPACE).data,n=i.get(we.a.BOUNDINGRECT).data;_o(Ci.C.fromTypedArray(a),Ci.v.fromTypedArray(r),t,Ci.g.fromTypedArray(n))}}function ec(e,t,i,r){const a=Re(e,t,i,r),n=e.stageObject.geometryRecords;for(let s=0;s<n.length;s++)Ko(n[s],r);return a}const tc=["polyline","polygon","extent"];class ic extends St{constructor(e,t,i,r){super(e,t,i,r),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}_ensureMaterials(){this._ensureFillMaterial(),this._ensureOutlineMaterial()}_ensureFillMaterial(){if(Object(a.k)(this._material))return;const e=Object(a.i)(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=Jo(this.symbolLayer,{color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,writeLinearDepth:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof Xo,this._context.stage.add(this._material)}_ensureOutlineMaterial(){const e=this.symbolLayer.outline;if(Object(a.k)(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;this._outlineMaterial=(t=>{const i=Object(Ma.b)(e.pattern);return new La.a({width:t,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:i,stippleScaleWithLineWidth:!0,cap:Object(pa.e)(e.patternCap||"butt")})})(Object(je.g)(e.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(e){return Object(a.k)(e)&&e.size&&e.size>0&&Object(a.k)(e.color)&&(Object(a.j)(e.pattern)||"style"!==e.pattern.type||"none"!==e.pattern.style)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,tc,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new We.a);return this.ensureDrapedStatus("on-the-ground"===r.mode),this._ensureMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}layerOpacityChanged(){if(Object(a.k)(this._material)){const e=this._material.parameters.color,t=Object(a.i)(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t);this._material.setParameters({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(Object(a.k)(this._outlineMaterial)){const e=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=Object(Te.e)(ic.elevationModeChangeTypes,i,r);if(a!==Te.b.UPDATE)return a;const n=Object(Te.h)(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){if(Object(a.k)(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),Object(a.k)(this._outlineMaterial)){const e={slicePlaneEnabled:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,i){const r=Mi(e.geometry);if(Object(a.j)(r))return null;ac.renderData=Li(r,this._context.elevationProvider,this._context.renderCoordsHelper,i),ac.color=t;const n=ac.renderData.position.length/3;if(this._needsUV&&(ac.uvMapSpace=new Float32Array(4*n),ac.boundingRect=new Float64Array(9*n)),ac.outNum=0,ac.outGeometries=[],ac.outTransforms=[],ac.outMaterials=[],this._createAs3DShapeFill(ac),this._hasOutline&&this._createAs3DShapeOutline(ac),this._logGeometryCreationWarnings(ac.renderData,r.rings,"rings","FillSymbol3DLayer"),0===ac.outNum)return null;this._needsUV&&_o(Ci.C.fromTypedArray(ac.uvMapSpace),Ci.v.fromTypedArray(ac.renderData.position),this._context.renderCoordsHelper,Ci.g.fromTypedArray(ac.boundingRect));const s=new Ui.a({geometries:ac.outGeometries,materials:ac.outMaterials,transformations:ac.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),o=new Xe(this,s,ac.outGeometries,null,null,ec,i);return o.alignedSampledElevation=ac.renderData.sampledElevation,o.needsElevationUpdates=Object(Te.h)(i.mode),o}_createAs3DShapeFill(e){const t=e.renderData.polygons;for(const{position:i,mapPosition:r,holeIndices:n,index:s,count:o}of t){if(Object(a.k)(this._context.clippingExtent)&&(Object(G.h)(rc),Object(G.k)(rc,r),!Object(G.r)(rc,this._context.clippingExtent)))continue;const t=Object(xi.a)(r,n,3);if(0===t.length)continue;const c=Ii({indices:new Uint32Array(t),attributeData:{position:i,color:e.color,mapPosition:r,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*s*e.uvMapSpace.BYTES_PER_ELEMENT,4*o):null,boundingRect:this._needsUV?new Float64Array(e.boundingRect.buffer,9*s*e.boundingRect.BYTES_PER_ELEMENT,9*o):null}});e.outGeometries.push(c),e.outMaterials.push(Object(a.s)(this._material)),e.outTransforms.push(Se.a),e.outNum++}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{mapPosition:r,position:n}=t[i];if(Object(a.k)(this._context.clippingExtent)&&(Object(G.h)(rc),Object(G.k)(rc,r),!Object(G.r)(rc,this._context.clippingExtent)))continue;const s=Object(pa.b)({overlayInfo:null,removeDuplicateStartEnd:pa.a.REMOVE,attributeData:{position:n,mapPosition:r}}),o=s.vertexAttributes.get(we.a.POSITION);o.data===n&&(o.data=new Float64Array(n)),e.outGeometries.push(s),e.outMaterials.push(Object(a.s)(this._outlineMaterial)),e.outTransforms.push(Se.a),e.outNum++}}_createAsOverlay(e,t){const i=Mi(e.geometry);if(Object(a.j)(i))return null;Object(a.s)(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,Object(a.k)(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),nc.renderData=Ni(i,this._context.overlaySR),nc.color=t;const r=nc.renderData.position.length/3;return this._needsUV&&(nc.uvMapSpace=new Float32Array(4*r)),nc.outNum=0,nc.outGeometries=[],nc.outBoundingBox=Object(G.h)(),nc.layerUid=this._context.layer.uid,nc.graphicsUid=e.uid,this._createAsOverlayFill(nc),this._hasOutline&&this._createAsOverlayOutline(nc),this._logGeometryCreationWarnings(nc.renderData,i.rings,"rings","FillSymbol3DLayer"),0===nc.outNum?null:(this._needsUV&&function(e,t,i,r,a=1){if(i.isGeographic&&r===Ai.a.Global){const e=new Float64Array(t.typedBuffer.length),r=3*t.count,a=Object(yo.e)(i);for(let i=0;i<r;i+=3)Object(U.i)(t.typedBuffer,i,e,i,a);t=Ci.v.fromTypedArray(e)}Object(mi.s)(Ao,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let o=0;o<t.count;o++)t.getVec(o,xo),Ao[0]=Math.min(Ao[0],xo[0]),Ao[1]=Math.min(Ao[1],xo[1]);const n=Ao[0]%a,s=Ao[1]%a;Ro[0]=Ao[0]-n,Ro[1]=Ao[1]-s;for(let o=0;o<t.count;o++)t.getVec(o,xo),e.setValues(o,(xo[0]-Ro[0])/a,(xo[1]-Ro[1])/a,Ro[0]/a,Ro[1]/a)}(Ci.C.fromTypedArray(nc.uvMapSpace),Ci.v.fromTypedArray(nc.renderData.position),this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode),nc.outNum>0?new pr(this,nc.outGeometries,nc.outBoundingBox):null)}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:i,holeIndices:r,index:n,count:s}of t){if(Object(G.h)(rc),Object(G.k)(rc,i),!Object(G.r)(rc,this._context.clippingExtent))continue;const t=Object(xi.a)(i,r,3);if(0===t.length)continue;Object(G.j)(e.outBoundingBox,rc);const o=Ii({indices:new Uint32Array(t),attributeData:{position:i,color:e.color,uvMapSpace:this._needsUV?new Float32Array(e.uvMapSpace.buffer,4*n*e.uvMapSpace.BYTES_PER_ELEMENT,4*s):null}}),c=new ea.a(o,Object(a.s)(this._material),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),l=rc;Object(cr.l)(c.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1]))),e.outGeometries.push(c),e.outNum++}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if(Object(G.h)(rc),Object(G.k)(rc,r),!Object(G.r)(rc,this._context.clippingExtent))continue;Object(G.j)(e.outBoundingBox,rc);const n=Object(pa.b)({overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:pa.a.REMOVE,attributeData:{position:r}}),s=new ea.a(n,Object(a.s)(this._outlineMaterial),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),o=rc;Object(cr.l)(s.boundingSphere,.5*(o[0]+o[3]),.5*(o[1]+o[4]),0,.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1]))),e.outGeometries.push(s),e.outNum++}}_getOutlineOpacity(){const e=Object(a.i)(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(Object(a.k)(e)?e.a:0)}_getOutlineColor(){const e=Object(a.i)(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return Object(Ce.g)(Object(a.k)(e)?j.a.toUnitRGB(e):null,t)}get test(){return{createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)}}}ic.elevationModeChangeTypes={definedChanged:Te.b.RECREATE,staysOnTheGround:Te.b.NONE,onTheGroundChanged:Te.b.RECREATE};const rc=Object(G.f)(),ac={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},nc={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},sc=D.a.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters");class oc{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=this._colorToRGBA(e.color),this.haloStyle=this._colorToRGB(e.halo.color),this.backgroundStyle=0!==e.background.color[3]?this._colorToRGBA(e.background.color):null}fontString(e){const t=this.definition.font;return`${t.style} ${t.weight} ${e}px ${t.family}, sans-serif`}_colorToRGB(e){return`rgb(${e.slice(0,3).map((e=>Math.floor(255*e))).toString()})`}_colorToRGBA(e){return`rgba(${e.slice(0,3).map((e=>Math.floor(255*e))).toString()},${e[3]})`}static async fromSymbol(e,t=1){const i=Object(a.i)(e,"material","color"),r=Object(a.n)(i,at.b,j.a.toUnitRGBA),n=Object(a.n)(e.size,12,je.g),s=e.lineHeight,o=Object(a.k)(e.background)?j.a.toUnitRGBA(e.background.color):at.b,c={family:Object(a.n)(e.font,"sans-serif",(e=>e.family)),decoration:Object(a.n)(e.font,"none",(e=>e.decoration)),weight:Object(a.n)(e.font,"normal",(e=>e.weight)),style:Object(a.n)(e.font,"normal",(e=>e.style))},l=e.halo,d=Object(a.k)(l)&&Object(a.k)(l.color)&&l.size>0?{size:Object(je.g)(l.size),color:j.a.toUnitRGBA(l.color)}:{size:0,color:at.b},h=new oc({color:r,size:n,background:{color:o,padding:Object(a.k)(e.background)?[.65*n,.5*n]:[0,0],borderRadius:Object(a.k)(e.background)?n*(6/16):0},lineSpacingFactor:s,font:c,halo:d,pixelRatio:t}),u=h.fontString(n);try{await document.fonts.load(u)}catch(p){sc.warnOnce(`Failed to preload font '${u}'. Some text symbology may be rendered using the default browser font.`)}return h}}class cc{constructor(e,t,i){this._renderer=new vr(e,t,i)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const e=_r(lc,this._renderer.renderedWidth,this._renderer.renderedHeight),t=e.getContext("2d");return t.save(),this._renderer.render(t,0,0),t.restore(),new ta.a(e,{wrap:{s:Qt.B.CLAMP_TO_EDGE,t:Qt.B.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0,powerOfTwoResizeMode:$e.e.PAD})}}const lc={canvas:null},dc=[0,0,1];function hc(e,t,i){e&&e.forEach((e=>{const r=t(e);Object(a.k)(r)&&i(r,e.graphic)}))}const uc={mode:"relative-to-ground",offset:0},pc={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],horizontalPlacement:"center",verticalPlacement:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawLabelBorder:!1,displayWidth:0,displayHeight:0};var fc=i(114),bc=i(1100),mc=i(1087);const gc=["polyline","polygon","extent"];class vc extends St{constructor(e,t,i,r){super(e,t,i,r)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,gc,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new We.a);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,i,t.uid)}ensureMaterial(){if(Object(a.k)(this._material))return;const e={...mc.a},t=this.symbolLayer.color;Object(a.k)(t)&&(e.color=j.a.toUnitRGBA(t));const i=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=Object(a.k)(this.symbolLayer.waveDirection)?vc.headingVectorFromAngle(this.symbolLayer.waveDirection):Object(gi.e)(0,0);const r=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,n=mc.b[r];e.waveStrength=n.waveStrength,e.waveTextureRepeat=n.textureRepeat,e.waveVelocity=n.waveVelocity,e.flowStrength=n.perturbationStrength,e.slicePlaneEnabled=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new bc.a(e),this._context.stage.add(this._material)}layerOpacityChanged(){if(Object(a.j)(this._material))return!0;const e=this._material.parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),i=t<1||this.needsDrivenTransparentPass;return this._material.setParameters({color:[e[0],e[1],e[2],t],transparent:i}),!0}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,a=Object(Te.e)(vc.elevationModeChangeTypes,i,r);if(a!==Te.b.UPDATE)return a;const n=Object(Te.h)(r);return this.updateGraphics3DGraphicElevationInfo(e,t,(()=>n))}slicePlaneEnabledChanged(){return Object(a.k)(this._material)&&this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(e,t,i){const r=Mi(e.geometry);if(Object(a.j)(r))return null;xc.renderData=Li(r,this._context.elevationProvider,this._context.renderCoordsHelper,t);const n=xc.renderData.position.length/3;if(xc.uvCoords=new Float64Array(2*n),xc.outNum=0,xc.outGeometries=[],xc.outTransforms=[],xc.outMaterials=[],this._create3DShapeGeometries(xc),this._logGeometryCreationWarnings(xc.renderData,r.rings,"rings","WaterSymbol3DLayer"),0===xc.outNum)return null;this._createUVCoordsFromVertices(xc.uvCoords,xc.renderData.mapPosition,n,this._context.elevationProvider.spatialReference);const s=new Ui.a({geometries:xc.outGeometries,materials:xc.outMaterials,transformations:xc.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:i}}),o=new Xe(this,s,xc.outGeometries,null,null,Re,t);return o.alignedSampledElevation=xc.renderData.sampledElevation,o.needsElevationUpdates=Object(Te.h)(t.mode),o}_createUVCoordsFromVertices(e,t,i,r){const a=Object(fc.e)(r);Object(V.m)(yc);for(let o=0;o<i;o++)Object(mi.s)(_c,t[3*o+0],t[3*o+1]),Object(V.o)(yc,_c);Object(cr.b)(yc,yc,a);const n=yc[0]%vc.unitSizeOfTexture,s=yc[1]%vc.unitSizeOfTexture;Oc[0]=yc[0]-n,Oc[1]=yc[1]-s;for(let o=0;o<i;o++)e[2*o+0]=(t[3*o+0]*a-Oc[0])/vc.unitSizeOfTexture,e[2*o+1]=(t[3*o+1]*a-Oc[1])/vc.unitSizeOfTexture}_create3DShapeGeometries(e){const t=e.renderData.polygons,i=e.uvCoords;for(const{count:r,index:n,position:s,mapPosition:o,holeIndices:c}of t){if(Object(a.k)(this._context.clippingExtent)&&(Object(G.h)(jc),Object(G.k)(jc,o),!Object(G.r)(jc,this._context.clippingExtent)))continue;const t=Object(xi.a)(o,c,3);if(0===t.length)continue;const l=Di({indices:new Uint32Array(t),attributeData:{position:s,uv0:new Float64Array(i.buffer,2*n*i.BYTES_PER_ELEMENT,2*r),mapPosition:o}});e.outGeometries.push(l),e.outMaterials.push(Object(a.s)(this._material)),e.outTransforms.push(Se.a),e.outNum++}}_createAsOverlay(e){const t=Mi(e.geometry);if(Object(a.j)(t))return null;Object(a.s)(this._material).renderPriority=this._renderPriority,Sc.renderData=Ni(t,this._context.overlaySR);const i=Sc.renderData.position.length/3;return Sc.uvCoords=new Float64Array(2*i),Sc.outNum=0,Sc.outGeometries=[],Sc.outBoundingBox=Object(G.h)(),Sc.layerUid=this._context.layer.uid,Sc.graphicsUid=e.uid,this._createAsOverlayWater(Sc),this._logGeometryCreationWarnings(Sc.renderData,t.rings,"rings","WaterSymbol3DLayer"),0===Sc.outNum?null:(this._createUVCoordsFromVertices(Sc.uvCoords,Sc.renderData.position,i,this._context.overlaySR),Sc.outNum>0?new pr(this,Sc.outGeometries,Sc.outBoundingBox):null)}_createAsOverlayWater(e){const t=e.uvCoords,i=e.renderData.polygons;for(const{position:r,holeIndices:n,index:s,count:o}of i){if(Object(G.h)(jc),Object(G.k)(jc,r),!Object(G.r)(jc,this._context.clippingExtent))continue;Object(G.j)(e.outBoundingBox,jc);const i=Object(xi.a)(r,n,3);if(0===i.length)continue;const c=Di({indices:new Uint32Array(i),attributeData:{position:r,uv0:new Float64Array(t.buffer,2*s*t.BYTES_PER_ELEMENT,2*o)}}),l=new ea.a(c,Object(a.s)(this._material),{layerUid:e.layerUid,graphicUid:e.graphicsUid}),d=jc;Object(cr.l)(l.boundingSphere,.5*(d[0]+d[3]),.5*(d[1]+d[4]),0,.5*Math.sqrt((d[3]-d[0])*(d[3]-d[0])+(d[4]-d[1])*(d[4]-d[1]))),e.outGeometries.push(l),e.outNum++}}static headingVectorFromAngle(e){const t=Object(gi.a)(),i=Object(ss.c)(e);return t[0]=Math.sin(i),t[1]=Math.cos(i),t}get test(){return{create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}vc.unitSizeOfTexture=100,vc.elevationModeChangeTypes={definedChanged:Te.b.RECREATE,staysOnTheGround:Te.b.NONE,onTheGroundChanged:Te.b.RECREATE};const Oc=Object(gi.a)(),yc=Object(V.l)(),_c=Object(gi.a)(),jc=Object(G.f)(),xc={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Sc={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Tc=D.a.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory");function Cc(e,t,i,r){const a=Ac[e.type]&&Ac[e.type][t.type]||Ec[t.type];return a?new a(e,t,i,r):(Tc.error("GraphicsLayerFactory#make",`unknown symbol type ${t.type}`),null)}const Ec={icon:la,object:class extends St{constructor(e,t,i,r){super(e,t,i,r),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=i.physicalBasedRenderingEnabled}getCachedSize(){const[e,t,i]=Object(a.k)(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:i}}async doLoad(e){if(!this._drivenProperties.size&&Object(Ce.i)(this.symbolLayer))throw new Error;const t=this.symbolLayer;if(this.isPrimitive){const i=t.resource?t.resource.primitive:ot.b;this._resources=await this._createResourcesForPrimitive(i,e)}else this._resources=await this._createResourcesForUrl(t.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return Object(a.k)(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return Object(a.i)(this._resources,"lodRenderer")}_setMaterialTransparencyParams(e,t=Object(a.i)(this.symbolLayer,"material","color")){const i=this._getCombinedOpacity(t),r=i<1||this.needsDrivenTransparentPass;return e.transparent=r,e.opacity=i,e.cullFace=r?$e.b.None:$e.b.Back,e}async _createResourcesForPrimitive(e,t){if(!function(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}(e))throw new Error(`Unknown object symbol primitive: ${e}`);const i=this.symbolLayer,r=Object(G.f)(Object(rn.c)(e)),n=Object(z.g)(Object(G.z)(r)),s=Object(z.g)(Object(rn.d)(n,i)),o=Object(F.p)(s),c={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:z.a,diffuse:z.a,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},l=c.usePBR;this._setMaterialTransparencyParams(c);const d=this.symbol;if("point-3d"===d.type&&d.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=d.verticalOffset;c.verticalOffset={screenLength:Object(je.g)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},c.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(c.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)c.externalColor=at.a;else{const e=Object(a.k)(i.material)&&i.material.color,t=Object(a.k)(e)?j.a.toUnitRGBA(e):at.a;c.externalColor=t}this._fastUpdates=$r(this._context.renderer,this._fastVisualVariableConvertOptions(r,s,n,a.o)),this._fastUpdates.enabled?(Object.assign(c,this._fastUpdates.materialParameters),c.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(c.instanced.push("color"),this._optionalFields.push("color"));const h=lt(e,new Gi.a(c));if(!h)throw new Error(`Unknown object symbol primitive: ${e}`);const u=ft(h).map((e=>({opacity:1,transparent:e.parameters.transparent}))),p=await this._createStageResources(h,l);return{lodResources:h,lodRenderer:await this._createLodRenderer(h,t),stageResources:p,symbolSize:s,extentPadding:o,isEsriSymbolResource:!1,isWosr:!1,originalMaterialParameters:u,physicalBasedRenderingEnabled:l,resourceBoundingBox:r,resourceSize:n,dispose:a.o,pivotOffset:a.o}}async _createResourcesForUrl(e,t){const i=["transformation"],r={materialParamsMixin:{instanced:i,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=$r(this._context.renderer,this._fastVisualVariableConvertOptions(a.o,a.o,a.o,a.o)),this._fastUpdates.enabled?(Object.assign(r.materialParamsMixin,this._fastUpdates.materialParameters),i.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(i.push("color"),this._optionalFields.push("color"));const n=this.symbol;if("point-3d"===n.type&&n.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=n.verticalOffset;r.materialParamsMixin.verticalOffset={screenLength:Object(je.g)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},r.materialParamsMixin.castShadows=!1}r.signal=t,r.usePBR=this._context.physicalBasedRenderingEnabled;const s=r.usePBR,o=await Object(fn.fetch)(e,r),c=o.isEsriSymbolResource,l=o.isWosr,d=o.remove,h=function(e){return{levels:e.map((e=>function(e){const t=[];return e.stageResources.geometries.forEach(((i,r)=>{const a=e.stageResources.materials[r],n=e.stageResources.textures;t.push({material:a,geometry:i,textures:n})})),{components:t,minScreenSpaceRadius:e.lodThreshold,pivotOffset:e.pivotOffset}}(e)))}}(o.lods);(function(e){e.levels.forEach((e=>{e.minScreenSpaceRadius||(e.minScreenSpaceRadius=hn(e))}))})(h),h.levels.sort(((e,t)=>e.minScreenSpaceRadius-t.minScreenSpaceRadius)),h.levels[0].minScreenSpaceRadius=Math.min(2,h.levels[0].minScreenSpaceRadius);const u=this._context,p=this.symbolLayer.material,f=this._getExternalColorParameters(p),b=Object(a.i)(this.symbolLayer,"material","color"),m=this._getCombinedOpacity(b,{hasIntrinsicColor:!0}),g=this.needsDrivenTransparentPass,v=ft(h),O=ft(h).map((e=>({opacity:e.parameters.opacity||1,transparent:e.parameters.transparent})));v.forEach((e=>{const t=e.parameters;e.setParameters(f);const i=t.opacity*m,r=i<1||g||t.transparent;e.setParameters({opacity:i,transparent:r}),u.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:u.sharedResources.screenSizePerspectiveSettings})}));const y=o.referenceBoundingBox,_=Object(z.g)(Object(G.z)(y)),j=Object(z.g)(h.levels[0].pivotOffset),x=Object(z.g)(Object(rn.d)(_,this.symbolLayer)),S=Object(F.p)(x);Xr(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(y,x,_,j))&&v.forEach((e=>e.setParameters(this._fastUpdates.materialParameters)));const T=await this._createStageResources(h,s);return{lodResources:h,lodRenderer:await this._createLodRenderer(h,t),stageResources:T,symbolSize:x,extentPadding:S,isEsriSymbolResource:c,isWosr:l,originalMaterialParameters:O,physicalBasedRenderingEnabled:s,resourceBoundingBox:y,resourceSize:_,dispose:d,pivotOffset:j}}async _createStageResources(e,t){const i=this._context.stage,r=ft(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),i.addMany(r);const a=function(e){const t=new Array;return e.levels.forEach((e=>{e.components.forEach((e=>{e.textures&&t.push(...e.textures)}))})),Object(o.k)(t)}(e);i.addMany(a),await i.load(a);const n=function(e){const t=[];return e.levels.forEach((e=>{e.components.forEach((e=>{t.push(e.geometry)}))})),Object(o.k)(t)}(e);return i.addMany(n),{materials:r,textures:a,geometries:n}}async _createLodRenderer(e,t){const i=this._context.stage,r={layerUid:this._context.layer.uid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},a=this._fastUpdates.enabled?{applyTransform:(e,t,i)=>{e.getFeatureAttribute(t,as),Object(xe.c)(i,Jr(this._fastUpdates.materialParameters,as,i))},scaleFactor:(e,t,i)=>(t.getFeatureAttribute(i,as),Kr(e,this._fastUpdates.materialParameters,as))}:null,n=new $n(e,this._optionalFields,r,a);return n.slicePlaneEnabled=this._context.slicePlaneEnabled,await i.addRenderPlugin(n.slots,n,t),n}_getExternalColorParameters(e){const t={};return this._drivenProperties.color?t.externalColor=at.a:Object(a.k)(e)&&Object(a.k)(e.color)?t.externalColor=j.a.toUnitRGBA(e.color):(t.externalColor=at.a,t.colorMixMode="ignore"),t}destroy(){if(super.destroy(),Object(a.k)(this._resources)){const e=this._context.stage;e.removeRenderPlugin(this._resources.lodRenderer);const t=this._resources.stageResources;e.removeMany(t.materials),e.removeMany(t.textures),e.removeMany(t.geometries),Object(a.k)(this._resources.dispose)&&this._resources.dispose(),this._resources=null}}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const i=Object(Rt.d)(t.geometry);if(Object(a.j)(i))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const r=this.setGraphicElevationContext(t,new We.a),n=e.renderingInfo;return this._createAs3DShape(t,i,n,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(Object(a.j)(this._resources))return!0;const e=this._drivenProperties.opacity,t=!this.isPrimitive,i=this._resources.stageResources.materials,r=this._resources.originalMaterialParameters;for(let n=0;n<i.length;n++){const s=i[n],o=Object(a.i)(this.symbolLayer,"material","color"),c=r[n],l=this._getCombinedOpacity(o,{hasIntrinsicColor:t})*c.opacity,d=l<1||e||c.transparent;s.setParameters({opacity:l,transparent:d}),this.isPrimitive&&s.setParameters({cullFace:d?$e.b.None:$e.b.Back})}return!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Te.i)}slicePlaneEnabledChanged(){if(Object(a.j)(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(Object(a.j)(this._resources))return!0;const{stageResources:e,isWosr:t}=this._resources;for(const i of e.materials)this.isPrimitive?i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this.hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}applyRendererDiff(e,t){if(Object(a.j)(this._resources))return et.Recreate_Symbol;const{stageResources:{materials:i},lodRenderer:r,resourceBoundingBox:n,symbolSize:s,resourceSize:o,pivotOffset:c}=this._resources;for(const a in e.diff){if("visualVariables"!==a)return et.Recreate_Symbol;if(!Xr(this._fastUpdates,t,this._fastVisualVariableConvertOptions(n,s,o,c)))return et.Recreate_Symbol;for(const e of i)e.setParameters(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged()}return et.Fast_Update}computeComplexity(){return Object(a.j)(this._resources)?super.computeComplexity():{primitivesPerFeature:bt(this._resources.lodResources.levels[0]).reduce(((e,t)=>e+t.indices.get(we.a.POSITION).length),0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:yt(this.symbol,this.symbolLayer)}}_hasLodRenderer(){return Object(a.k)(this._resources)}_createAs3DShape(e,t,i,r,n){if(!this._hasLodRenderer()||Object(a.j)(this._resources))return null;const s=this.getFastUpdateAttrValues(e),o=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?Object(Ce.g)(i.color,i.opacity):null,c=this._context.clippingExtent;if(Object(U.o)(t,ts,this._context.elevationProvider.spatialReference),Object(a.k)(c)&&!Object(G.e)(c,ts))return null;const l=this._requiresTerrainElevation(r),d=this._computeGlobalTransform(t,r,rs,ns),h=this._computeLocalTransform(this._resources,this.symbolLayer,i,is),u=this._resources.lodRenderer.instanceData,p=u.addInstance();this._instanceIndexToGraphicUid.set(p,n),u.setLocalTransform(p,h,!1),u.setGlobalTransform(p,d),s&&u.setFeatureAttribute(p,s),o&&u.setColor(p,o);const f=new nn(this,p,De,r);return l&&(f.alignedSampledElevation=ns.sampledElevation),f.needsElevationUpdates=Object(Te.i)(r.mode),Object(Rt.b)(f,t,this._context.elevationProvider),f}_computeGlobalTransform(e,t,i,r){return Object(Te.g)(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r),ts[0]=e.x,ts[1]=e.y,ts[2]=r.z,Object(U.d)(e.spatialReference,ts,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(e,t,i,r){return Object(xe.i)(r),this._applyObjectRotation(i,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,i,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,a=Object(Ce.c)(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===a[0]&&1===a[1]&&1===a[2]||Object(xe.h)(i,i,a)}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(Object(a.j)(this._resources))return!0;const i=t&&Object(Rt.d)(t);if(Object(a.j)(i))return!1;const r=this.getGeometryElevationMode(t);return e.elevationContext.mode===r&&(this._computeGlobalTransform(i,e.elevationContext,rs,ns),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=ns.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,rs,!0),Object(Rt.b)(e,i,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(Object(a.j)(this._resources))return;const i=(e,t,i)=>Object(a.t)(null!=e&&"complete"===e.type?e.newValue:t,i),r=i(t.heading,this.symbolLayer.heading,0),n=i(t.tilt,this.symbolLayer.tilt,0),s=i(t.roll,this.symbolLayer.roll,0),o=i(t.width,this.symbolLayer.width,void 0),c=i(t.height,this.symbolLayer.height,void 0),l=i(t.depth,this.symbolLayer.depth,void 0),d=i(t.anchor,this.symbolLayer.anchor,void 0),h=i(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const u={heading:r,tilt:n,roll:s,anchor:d,anchorPosition:h},p=this._resources;this.loadStatus===it.LOADED&&e.symbolLayerStatePatches.push((()=>{p.symbolSize=Object(z.g)(Object(rn.d)(p.resourceSize,{width:o,height:c,depth:l,isPrimitive:this.symbolLayer.isPrimitive}))})),e.graphics3DGraphicPatches.push(((e,t)=>{const i=this._computeLocalTransform(p,u,t,is),r=e.instanceIndex;p.lodRenderer.instanceData.setLocalTransform(r,i,!0)}))}_preparePatchColor(e,t){if(!t.material||"partial"!==t.material.type)return;const i=t.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const r=i.color.newValue,n=Object(a.k)(r)?j.a.toUnitRGBA(r):at.a;delete i.color;const s=this._resources;Object(a.j)(s)||e.graphics3DGraphicPatches.push((e=>{let t;this._hasPerInstanceColor()?(s.lodRenderer.instanceData.setColor(e.instanceIndex,n),t=this._setMaterialTransparencyParams({},r)):t=this._setMaterialTransparencyParams({externalColor:n},r);for(const i of s.stageResources.materials)i.setParameters(t)}))}_requiresTerrainElevation(e){return"absolute-height"!==e.mode}_applyObjectRotation(e,t,i){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return Object(Ce.b)(e.heading,e.tilt,e.roll,i)}_computeAnchor(e,t,i){const r=Object(z.f)();switch(i.anchor){case"center":Object(F.k)(r,Object(G.d)(e)),Object(F.s)(r,r);break;case"top":{const t=Object(G.d)(e);Object(F.w)(r,-t[0],-t[1],-e[5]);break}case"bottom":{const t=Object(G.d)(e);Object(F.w)(r,-t[0],-t[1],-e[2]);break}case"relative":{const t=Object(G.d)(e),a=Object(G.z)(e),n=i.anchorPosition,s=n?Object(z.h)(n.x,n.y,n.z):z.c;Object(F.a)(r,a,s),Object(F.f)(r,r,t),Object(F.s)(r,r);break}default:Object(a.k)(t)?Object(F.s)(r,t):Object(F.k)(r,z.c)}return r}_applyAnchor(e,t,i){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const r=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);r&&Object(xe.j)(i,i,r)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,t,i,r){const n=Object(a.k)(e)?Object(z.g)(Object(G.z)(e)):z.a,s=Object(a.k)(e)?this._computeAnchor(e,r,this.symbolLayer):z.c,o=this._context.renderCoordsHelper.unitInMeters,c=Object(Ce.c)(Object(a.k)(t)?t:void 0,t,i,o),l=Object(z.h)(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:n,symbolSize:Object(a.k)(t)?t:z.a,unitInMeters:o,transformation:{anchor:s,scale:c,rotation:l}}}},line:Fa,path:class extends St{constructor(e,t,i,r){super(e,t,i,r),this._intrinsicSize=Object(gi.e)(1,1),this.upVectorAlignment="path",this.stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const e=Object(a.k)(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height,t=Object(a.k)(this.symbolLayer.height)?this.symbolLayer.height:e;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,t],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=$r(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const i=this.symbolLayer.anchor||"center";this.upVectorAlignment="path","heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");const r=this.symbolLayer.profile||"circle";if("quad"===r)this._profile=js.rect();else this._profile=js.circle(Oo);let n=[0,0];switch("center"!==i&&(n={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[i],this._profile.translate(n[0],n[1])),this.symbolLayer.join||"simple"){case"round":this._extruder=new Ts(0,go);break;case"bevel":this._extruder=new Ts(0,1);break;case"miter":this._extruder=new Ts(.8*Math.PI,1);break;default:this._extruder=new Ss}const s=this.symbolLayer.cap||"butt";switch(s){case"none":this._startCap=new As,this._endCap=new As;break;default:this._startCap=new ws(this._profile,0),this._endCap=new ws(this._profile,0,!0);break;case"square":this._startCap=new ws(this._profile,-.5),this._endCap=new ws(this._profile,.5,!0);break;case"round":{const e="quad"===r;this._startCap=new Rs({profile:this._profile,flip:!1,breakNormals:e,subdivisions:vo}),this._endCap=new Rs({profile:this._profile,flip:!0,breakNormals:e,subdivisions:vo});break}}const o=Object(a.i)(this.symbolLayer,"material","color"),c=this._getCombinedOpacityAndColor(o),l=Object(z.g)(c),d=c[3],h=d<1||this.needsDrivenTransparentPass,u={diffuse:l,ambient:l,opacity:d,transparent:h,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:h||"none"===s?$e.b.None:$e.b.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(Object(mi.s)(this._intrinsicSize,e,t),!Object(Ce.f)(this._intrinsicSize[0])||!Object(Ce.f)(this._intrinsicSize[1])))throw new P.a("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||Object(mi.g)(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled?(Object.assign(u,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new to(u)):(u.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new Gi.a(u)),this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,no,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(t,new We.a),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}layerOpacityChanged(){const e=Object(a.i)(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),i=t<1||this.needsDrivenTransparentPass;return this._material.setParameters({opacity:t,transparent:i}),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Te.i)}slicePlaneEnabledChanged(){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return et.Recreate_Symbol;if(!Xr(this._fastUpdates,t,this._vvConvertOptions))return et.Recreate_Symbol;this._material.setParameters(this._fastUpdates.materialParameters)}return et.Fast_Update}getVertexData(e){let t=0;const i=e.paths,r=[],a=e.spatialReference,n=this._context.elevationProvider.spatialReference,s=this._context.renderCoordsHelper.spatialReference;for(const u of i)t+=u.length;const o=new Float64Array(3*t),c=new Float64Array(3*t),l=new Float64Array(3*t);let d=0;for(const u of i){r.push({index:d,numVertices:u.length});for(const t of u)o[d++]=t[0],o[d++]=t[1],o[d++]=e.hasZ?t[2]:0}let h=!0;return a.equals(n)?this._copyVertices(o,0,c,0,t):h=Object(U.l)(o,a,0,c,n,0,t),n.equals(s)?this._copyVertices(c,0,l,0,t):Object(U.l)(c,n,0,l,s,0,t),{pathVertexDataInfos:r,vertexDataGS:o,vertexDataES:c,vertexDataRS:l,projectionSuccess:h,terrainElevation:0}}_copyVertices(e,t,i,r,a){t*=3,r*=3;for(let n=0;n<a;++n)i[r++]=e[t++],i[r++]=e[t++],i[r++]=e[t++]}_createAs3DShape(e,t,i,r){const n=e.geometry,s=new Array,o=new Array,c=new Array,l=n.spatialReference,d=Object(G.f)(),h=this._context.renderCoordsHelper;uo.spatialReference=l;const u=this.getVertexData(n);if(!u.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(u.pathVertexDataInfos.length>0){for(let r=0;r<u.pathVertexDataInfos.length;++r){const n=u.pathVertexDataInfos[r],p=n.index,f=n.numVertices;if(f<2)continue;if(Object(a.k)(this._context.clippingExtent)&&(Object(G.h)(d),Object(G.k)(d,u.vertexDataES,3*p,f),!Object(G.r)(d,this._context.clippingExtent)))continue;const b=[];for(let e=p;e<p+3*f;){const t=e++,r=e++,a=e++,n=new _s;Object(F.w)(n.posGS,u.vertexDataGS[t],u.vertexDataGS[r],u.vertexDataGS[a]),Object(F.w)(n.posES,u.vertexDataES[t],u.vertexDataES[r],u.vertexDataES[a]);const s=Object(Te.f)(n.posES,this._context.elevationProvider,i,h);Object(F.w)(po,u.vertexDataRS[t],u.vertexDataRS[r],u.vertexDataRS[a]),h.setAltitude(po,s),Object(F.w)(n.pos,po[0],po[1],po[2]),b.push(n)}const m=new xs(b);so(m,this.upVectorAlignment,this._context.renderCoordsHelper);const g=new Ps(m,this._profile,this._extruder,this._startCap,this._endCap);let v=null;if(this._fastUpdates.enabled){const t=this._fastUpdates.visualVariables,i=t.size?Tt(t.size.field,e):0,r=t.color?Tt(t.color.field,e):0,a=t.opacity?Tt(t.opacity.field,e):0;v=new Ms(g,i,r,a)}else{const e=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(e[0]*=oo(t.size[0],"symbol-value"===t.size[2]?this.symbolLayer.height||0:t.size[2],this.symbolLayer.width||0),e[1]*=oo(t.size[2],"symbol-value"===t.size[0]?this.symbolLayer.width||0:t.size[0],this.symbolLayer.height||0));let i=null;this._drivenProperties.color&&(i=t.color),this._drivenProperties.opacity&&null!=t.opacity&&(i=i?[i[0],i[1],i[2],t.opacity]:[1,1,1,t.opacity]);const r=new Ds(g);r.bake(e),i&&r.bakeVertexColors(i),v=r}const{vertexAttributes:O,indices:y}=v.createGeometryData(),_=new ps(O,y,v,l,this.upVectorAlignment,this.stencilWidth);s.push(_),o.push(this._material),c.push(v.xform)}if(s.length>0){const e={layerUid:this._context.layer.uid,graphicUid:r},t=new Ui.a({geometries:s,materials:o,transformations:c,metadata:e}),a=new Xe(this,t,s,null,null,lo,i);return a.alignedSampledElevation=u.terrainElevation,a.needsElevationUpdates=Object(Te.i)(i.mode),a}}else 0!==n.paths.length&&n.paths.some((e=>e.length>0))||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}},fill:ic,extrude:class extends St{constructor(e,t,i,r){super(e,t,i,r),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=Object(Ce.i)(this._getSymbolSize());if(e)throw new P.a("graphics3dextrudesymbollayer:invalid-size",e)}const e=Object(a.i)(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e),i=Object(z.g)(t),r=t[3],n=r<1||this.needsDrivenTransparentPass,s={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:r,transparent:n,cullFace:n?$e.b.None:$e.b.Back,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new Gi.a(s),this._bottomMaterial=new Gi.a({...s,cullFace:$e.b.Back}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Vi,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),r=this.setGraphicElevationContext(t,new We.a);return this._createAs3DShape(t,e.renderingInfo,i,r,t.uid)}layerOpacityChanged(e,t){const i=Object(a.i)(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i),n=r<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:r,transparent:n}),this._bottomMaterial.setParameters({opacity:r,transparent:n});const s=this._getLayerOpacity();return e.forEach((e=>{const i=t(e);Object(a.k)(i)&&i.layerOpacityChanged(s,this._context.isAsync)})),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Te.i)}slicePlaneEnabledChanged(e,t){return this._material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled}),e.forEach((e=>{const i=t(e);Object(a.k)(i)&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}_getExtrusionSize(e){let t;var i;return t=e.size&&this._drivenProperties.size?null!=(i=function(e,t=0){const i=e[t];return"number"==typeof i&&isFinite(i)?i:null}(e.size,2))?i:0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?et.Recreate_Symbol:et.Recreate_Graphics}_getSymbolSize(){var e;return null!=(e=this.symbolLayer.size)?e:1}_createAs3DShape(e,t,i,r,n){const s=Mi(e.geometry);if(Object(a.j)(s))return null;const o=Li(s,this._context.elevationProvider,this._context.renderCoordsHelper,r);if(this._logGeometryCreationWarnings(o,s.rings,"rings","ExtrudeSymbol3DLayer"),0===s.rings.length||!s.rings.some((e=>e.length>0)))return null;const c=Object(Ce.a)(s);if(Object(a.j)(c))return null;const l=new Array,d=new Array,h=new Array,u=Object(G.f)(),p=Object(Se.d)(),f=Object(z.f)(),b=this._context.renderCoordsHelper.viewingMode===Ai.a.Global;b||this._context.renderCoordsHelper.worldUpAtPosition(null,f),Object(U.d)(s.spatialReference,[c.x,c.y,0],p,this._context.renderCoordsHelper.spatialReference);const m=Object(Se.d)();Object(xe.a)(m,p);const g=Object(Ti.b)();Object(Si.a)(g,m);const{polygons:v,mapPosition:O,position:y}=o,_=y.length/3,j=new Float64Array(3*_*6),x=new Float64Array(3*_*6),S=new Float64Array(3*_*6),T=new Float64Array(1*_*6);let C=0;for(let a=0;a<v.length;++a){const e=v[a],r=e.count;if(this._context.clippingExtent&&(Object(G.h)(u),Object(G.k)(u,e.mapPosition),!Object(G.r)(u,this._context.clippingExtent)))continue;const n=Object(xi.a)(e.mapPosition,e.holeIndices,3);if(0===n.length)continue;const s=3*r*2+n.length,o=new Uint32Array(s),c=new Uint32Array(n.length),p=6*r,_=3*j.BYTES_PER_ELEMENT,E=new Ci.v(j.buffer,C*_,_,(C+p)*_),A=3*x.BYTES_PER_ELEMENT,w=new Ci.v(x.buffer,C*A,A,(C+p)*A),R=new Float64Array(S.buffer,3*C*S.BYTES_PER_ELEMENT,3*p),P=new Float64Array(T.buffer,1*C*T.BYTES_PER_ELEMENT,1*p),I=this._getExtrusionSize(t);ki(y,O,n,e,E.typedBuffer,R,w.typedBuffer,P,0,o,c,I,f,b),Object(Ei.e)(E,E,m),Object(Ei.a)(w,w,g),C+=6*r;const D=Bi(o,o.length-c.length,{positions:E.typedBuffer,elevation:R,normals:w.typedBuffer,heights:P},i);l.push(D),d.push(this._material),h.push(Se.a);const M=Bi(c,0,{positions:E.typedBuffer,elevation:R,normals:w.typedBuffer,heights:P},i);l.push(M),d.push(this._bottomMaterial),h.push(Se.a)}if(0===l.length)return null;const E=new Ui.a({geometries:l,materials:d,transformations:h,metadata:{layerUid:this._context.layer.uid,graphicUid:n,isElevationSource:!0}});E.transformation=p;const A=ht(this.symbolLayer,{opacity:this._getLayerOpacity()}),w=Object(a.k)(A)?{baseMaterial:this._material,edgeMaterials:[A],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,R=new Xe(this,E,l,null,null,er,r,w);return R.alignedSampledElevation=o.sampledElevation,R.needsElevationUpdates=Object(Te.i)(r.mode),R}},text:class extends St{constructor(e,t,i,r){super(e,t,i,r),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=Object(Ce.i)(this.symbolLayer.size);if(e)throw new P.a("graphics3dtextsymbollayer:invalid-size",e)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const e=this._context.graphicsCoreOwner.view.pixelRatio;this._textRenderParameters=await oc.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){const t=e.graphic,i=Object(Rt.d)(t.geometry);if(Object(a.j)(i))return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;const r=this.symbolLayer.text;if(Object(a.j)(r)||""===r)return null;const n=Object(_e.b)(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(Object(a.k)(n)&&!Object(_e.e)(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const s={...pc,verticalOffset:n,horizontalPlacement:wr(this.symbolLayer.horizontalAlignment),verticalPlacement:Rr(this.symbolLayer.verticalAlignment)};return this._createAs3DShape(t,i,r,s)}createLabel(e,t,i,r){const n=e.graphic,s=Object(Rt.d)(n.geometry);if(Object(a.j)(s))return this.logger.warn(`unsupported geometry type for label: ${n.geometry.type}`),null;const o=t.text;return!o||/^\s+$/.test(o)?null:this._createAs3DShape(n,s,o,t,i,r)}setGraphicElevationContext(e,t,i=0){const r=super.setGraphicElevationContext(e,t);return r.addOffsetRenderUnits(i),r}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,t){return hc(e,t,((e,t)=>{this.updateGraphicElevationContext(t,e)})),Te.b.UPDATE}slicePlaneEnabledChanged(e,t){return hc(e,t,(e=>{for(const t of e.stageObject.geometryRecords)t.material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})})),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,t.metadata.elevationOffset),t.needsElevationUpdates=Object(Te.h)(t.elevationContext.mode)||"absolute-height"===t.elevationContext.mode}_defaultElevationInfoNoZ(){return uc}_createAs3DShape(e,t,i,r,n,s){const o=this.setGraphicElevationContext(e,new We.a,r.elevationOffset),c="polyline"===Object(a.i)(e.geometry,"type"),l=e.uid;let d=null,h=null;if(Object(a.j)(s)){const e=function(e){switch(e){case"left":return yr.Left;case"right":return yr.Right;default:return yr.Center}}(r.horizontalPlacement);d=new cc(i,e,this._textRenderParameters);let t=null;h=this._context.sharedResources.textures.fromData(d.key,(()=>Object(a.s)(d).create()),(()=>{Object(a.k)(t)&&t.release()}));const n=this._context.stage.renderView.textureRepository.acquire(h.texture.id);if(Object(a.j)(n)||Object(v.n)(n))return h.release(),null;t=n}const u=function(e,t){if("baseline"===t.verticalPlacement){const i=Er[t.horizontalPlacement],r=Object(a.k)(e)?e.baselineAnchorY:0;return Object(gi.e)(i,r)}const i=function(e,t){switch(t){case"bottom":return"left"===e?"bottom-left":"right"===e?"bottom-right":"bottom";case"center":return e;case"top":return"left"===e?"top-left":"right"===e?"top-right":"top"}}(t.horizontalPlacement,t.verticalPlacement);return Ar[i]}(d,r),p={occlusionTest:!0,screenOffset:r.screenOffset,anchorPos:u,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:r.centerOffsetUnits,debugDrawLabelBorder:r.debugDrawLabelBorder,drawInSecondSlot:!0};if(Object(a.k)(h)&&(p.textureId=h.texture.id),Object(a.k)(s)&&(p.textureId=s.id),Object(a.k)(r.verticalOffset)){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=r.verticalOffset;p.verticalOffset={screenLength:Object(je.g)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:e,screenSizePerspectiveSettingsLabels:t}=this._context.sharedResources;p.screenSizePerspective=t.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),p.screenSizePerspectiveAlignment=e}let f;if(c&&(p.shaderPolygonOffset=1e-4),p.slicePlaneEnabled=this._context.slicePlaneEnabled,Object(a.k)(n)){const e=JSON.stringify(p);f=n.get(e),Object(a.j)(f)&&(f=new ia.a(p),n.add(e,f))}else f=new ia.a(p);const b=[f],m=r.translation,g=Object(a.k)(d)?[d.displayWidth,d.displayHeight]:[0,0],O=r.centerOffset,y=dc,_=[ct.a.createPointGeometry(y,m,null,g,O,[0,0],null)],j=this._context.layer.uid,x=Object(Rt.a)(this._context,t,_,b,o,j,l);if(null===x)return null;const S=new Xe(this,x.object,_,Object(a.j)(n)?b:null,h,Pe,o);S.alignedSampledElevation=x.sampledElevation,S.needsElevationUpdates=Object(Te.h)(o.mode)||"absolute-height"===o.mode;const{displayWidth:T,displayHeight:C}=Object(a.k)(d)?d:r;S.getScreenSize=(e=Object(gi.a)())=>(e[0]=T,e[1]=C,e);const E={labelText:i,elevationOffset:r.elevationOffset};return S.metadata=E,Object(Rt.b)(S,t,this._context.elevationProvider),S}},water:vc};const Ac={"mesh-3d":{fill:class extends St{constructor(e,t,i,r){super(e,t,i,r),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){Ee.a.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new Ha.a({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new Ha.a({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),(e=>e.material))),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Wa,"fill on mesh-3d"))return null;const i=this.setGraphicElevationContext(t,new We.a),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}layerOpacityChanged(e,t){const i=this._getLayerOpacity();return this._materials.forEach((e=>{e.material.setParameters({layerOpacity:i});const t=e.material.parameters;this._setMaterialTransparentParameter(t,e),e.material.setParameters({transparent:t.transparent})})),e.forEach((e=>{const r=t(e);Object(a.k)(r)&&r.layerOpacityChanged(i,this._context.isAsync)})),!0}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,Te.i)}slicePlaneEnabledChanged(e,t){return this._materials.forEach((e=>{e.material.setParameters({slicePlaneEnabled:this._context.slicePlaneEnabled})})),e.forEach((e=>{const i=t(e);Object(a.k)(i)&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._materials.forEach((t=>t.material.setParameters({usePBR:e}))),!0}pixelRatioChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return Object(a.j)(e)?"-":e instanceof j.a?e.toHex():e.contentHash}_materialPropertiesDefault(e,t){const i=this._requiresSymbolVertexColors(),r=!!e.vertexAttributes.color,a=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:r,hasVertexTangents:a,uid:`vc:${r},vt:${a},vct${t},svc:${i}`}}_materialProperties(e,t,i){const r=this._materialPropertiesDefault(e,i);if(!t.material)return r;const{color:a,colorTexture:n,normalTexture:s,doubleSided:o,alphaCutoff:c,alphaMode:l}=t.material,d=this._colorOrTextureUid(a),h=this._colorOrTextureUid(n),u=this._colorOrTextureUid(s);if(r.color=a,r.colorTexture=n,r.normalTexture=s,r.uid=`${r.uid},cmuid:${d},ctmuid:${h},ntmuid:${u},ds:${o},ac:${c},am:${l}`,t.material instanceof Ga.a){const{metallic:e,roughness:i,metallicRoughnessTexture:a,emissiveColor:n,emissiveTexture:s,occlusionTexture:o}=t.material,c=this._colorOrTextureUid(a),l=this._colorOrTextureUid(n),d=this._colorOrTextureUid(s),h=this._colorOrTextureUid(o);r.metallic=e,r.roughness=i,r.metallicRoughnessTexture=a,r.emissiveColor=n,r.emissiveTexture=s,r.occlusionTexture=o,r.uid=`${r.uid},mrm:${e},mrr:${i},mrt:${c},emuid:${l},etmuid:${d},otmuid:${h}`}return r}_setInternalColorValueParameters(e,t){t.diffuse=j.a.toUnitRGB(e),t.opacity=e.a}_getLoadableTextureResource(e){return e.data?e.data:e.url}_getInternalTextureId(e){const t=this._getInternalTexture(e,$e.a.Opaque);return Object(a.k)(t)?t.id:null}_getInternalTexture(e,t){const i=this._getLoadableTextureResource(e);if(!i)return null;const r=`${e.contentHash}/${t}`;let a=this._textures.get(r);return a||(a=new ta.a(i,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:t!==$e.a.Opaque}),this._textures.set(r,a),this._context.stage.add(a),this._context.stage.loadImmediate(a)),a}_castTextureWrap(e="repeat"){if("string"==typeof e){const t=this._castTextureWrapIndividual(e);return{s:t,t:t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return Qt.B.CLAMP_TO_EDGE;case"mirror":return Qt.B.MIRRORED_REPEAT;default:return Qt.B.REPEAT}}_setInternalMaterialParameters(e,t){if(Object(a.k)(e.color)&&this._setInternalColorValueParameters(e.color,t),Object(a.k)(e.colorTexture)){const i=this._getInternalTexture(e.colorTexture,t.textureAlphaMode);Object(a.k)(i)?(t.textureId=i.id,t.textureAlphaPremultiplied=!!i.params.preMultiplyAlpha):t.textureId=void 0}Object(a.k)(e.normalTexture)&&(t.normalTextureId=this._getInternalTextureId(e.normalTexture)),Object(a.k)(e.emissiveColor)&&(t.emissiveFactor=j.a.toUnitRGB(e.emissiveColor)),Object(a.k)(e.emissiveTexture)&&(t.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),Object(a.k)(e.occlusionTexture)&&(t.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),Object(a.k)(e.metallicRoughnessTexture)&&(t.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture))}_setExternalMaterialParameters(e){const t=this._drivenProperties.color;let i=Object(a.k)(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(t)e.externalColor=at.a;else{const t=Object(a.k)(this.symbolLayer.material)?this.symbolLayer.material.color:null;Object(a.k)(t)?e.externalColor=j.a.toUnitRGBA(t):(i=null,e.externalColor=at.a)}i&&(e.colorMixMode=i),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const t=e.vertexAttributes.color;if(Object(a.j)(t))return!1;for(let i=3;i<t.length;i+=4)if(255!==t[i])return!0;return!1}_getOrCreateMaterial(e,t){var i,r,n;const s=null==(i=t.material)?void 0:i.color,o=null==(r=t.material)?void 0:r.colorTexture,c=null==(n=t.material)?void 0:n.alphaMode,l="blend"===c,d=!("opaque"===c)&&(this._hasTransparentVertexColors(e)||Object(a.k)(s)&&s.a<1||Object(a.k)(o)&&o.transparent||l),h=this._materialProperties(e,t,d),u=this._materials.get(h.uid);if(u)return u.material;const p={material:null,isComponentTransparent:d,alphaMode:t.material?t.material.alphaMode:"opaque"},f=null==h.metallicRoughnessTexture&&null==h.metallic&&null==h.roughness,b={usePBR:this._usePBR(),isSchematic:f,vertexColors:h.hasVertexColors,symbolColors:h.hasSymbolVertexColors,vertexTangents:h.hasVertexTangents,ambient:z.c,diffuse:z.a,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:$e.b.None,layerOpacity:this._getLayerOpacity(),slicePlaneEnabled:this._context.slicePlaneEnabled,initTextureTransparent:!0};f||(b.mrrFactors=[null!=h.metallic?h.metallic:1,null!=h.roughness?h.roughness:1,.5]),t.material&&(b.doubleSided=t.material.doubleSided,b.cullFace=t.material.doubleSided?$e.b.None:$e.b.Back,b.textureAlphaCutoff=t.material.alphaCutoff),this._setExternalMaterialParameters(b),this._setMaterialTransparentParameter(b,p),this._setInternalMaterialParameters(h,b);const m=new Gi.a(b);return p.material=m,this._materials.set(h.uid,p),this._context.stage.add(m),m}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,"auto"===t.alphaMode?e.textureAlphaMode=e.transparent?$e.a.MaskBlend:$e.a.Opaque:e.textureAlphaMode="opaque"===t.alphaMode?$e.a.Opaque:"mask"===t.alphaMode?$e.a.Mask:$e.a.Blend}_addDebugNormals(e,t,i,r){const a=t.length,n=e.spatialReference.isGeographic?20015077/180:1,s=.1*Math.max(e.extent.width*n,e.extent.height*n,e.extent.zmax-e.extent.zmin),o=[],c=[],l=[],d=[];for(let p=0;p<a;p++){const e=t[p],i=e.vertexAttributes.get(we.a.POSITION),r=e.vertexAttributes.get(we.a.NORMAL),a=e.indices.get(we.a.POSITION),n=e.indices.get(we.a.NORMAL),h=i.data,u=r.data;for(let t=0;t<a.length;t++){const e=3*a[t],i=3*n[t];for(let t=0;t<3;t++)o.push(h[e+t]);for(let t=0;t<3;t++)o.push(h[e+t]+u[i+t]*s);if(c.push(c.length),c.push(c.length),t%3==0){this._calculateFaceNormal(h,a,t,Za),this._getFaceVertices(h,a,t,$a,Xa,Ya),Object(F.f)($a,$a,Xa),Object(F.f)($a,$a,Ya),Object(F.e)($a,$a,1/3);for(let e=0;e<3;e++)l.push($a[e]);for(let e=0;e<3;e++)l.push($a[e]+Za[e]*s);d.push(d.length),d.push(d.length)}}}const h=new Pt.a([[we.a.POSITION,{data:o,size:3,exclusive:!0}]],[[we.a.POSITION,new Uint32Array(c)]],$e.f.Line);t.push(h),i.push(this._debugVertexNormalMaterial),r.push(Object(Se.c)(r[0]));const u=new Pt.a([[we.a.POSITION,{data:l,size:3,exclusive:!0}]],[[we.a.POSITION,new Uint32Array(d)]],$e.f.Line);t.push(u),i.push(this._debugFaceNormalMaterial),r.push(Object(Se.c)(r[0]))}_createAs3DShape(e,t,i,r){const n=e.geometry;if("mesh"!==n.type)return null;const s=this._createGeometryInfo(n,t);if(!s)return null;const{geometries:o,materials:c,transformations:l,objectTransformation:d}=s;Ee.a.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(n,o,c,l);const h=new Ui.a({geometries:o,materials:c,transformations:l,metadata:{layerUid:this._context.layer.uid,graphicUid:r}});h.transformation=d;const u=this._createEdgeMaterial(),p=Object(a.k)(u)?{baseMaterial:c[0],edgeMaterials:[u],properties:{mergeGeometries:!0,slicePlaneEnabled:this._context.slicePlaneEnabled}}:null,f=new Xe(this,h,o,null,null,Pe,i,p);return f.needsElevationUpdates=Object(Te.i)(i.mode),f.useObjectOriginAsAttachmentOrigin=!0,f.elevationContext.centerPointInElevationSR=this._getCenterPointInElevationSR(h),f.alignedSampledElevation=Pe(f,f.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),f}_getCenterPointInElevationSR(e){const t=Object(B.g)(0,0,0,this._context.elevationProvider.spatialReference);return Object(U.r)([e.transformation[12],e.transformation[13],e.transformation[14]],this._context.renderCoordsHelper.spatialReference,t),t}_createComponentNormals(e,t,i,r){switch(i.shading||"flat"){case"source":return this._createComponentNormalsSource(e,t,i,r);case"flat":return this._createComponentNormalsFlat(e,r);case"smooth":return this._createComponentNormalsSmooth(e,r);default:return}}_createComponentNormalsSource(e,t,i,r){if(Object(a.j)(t))return this._createComponentNormalsFlat(e,r);let n=!1;if(!i.trustSourceNormals)for(let a=0;a<r.length;a+=3){this._calculateFaceNormal(e,r,a,Za);for(let e=0;e<3;e++){const i=3*r[a+e];$a[0]=t[i+0],$a[1]=t[i+1],$a[2]=t[i+2],Object(F.h)(Za,$a)<0&&(t[i+0]=-t[i+0],t[i+1]=-t[i+1],t[i+2]=-t[i+2],n=!0)}}return{normals:t,indices:r,didFlipNormals:n}}_createComponentNormalsFlat(e,t){const i=new Float32Array(t.length),r=new Uint32Array(3*t.length);for(let a=0;a<t.length;a+=3){const n=this._calculateFaceNormal(e,t,a,Za);for(let e=0;e<3;e++)i[a+e]=n[e],r[a+e]=a/3}return{normals:i,indices:r,didFlipNormals:!1}}_createComponentNormalsSmooth(e,t){const i={};for(let n=0;n<t.length;n+=3){const r=this._calculateFaceNormal(e,t,n,Za);for(let e=0;e<3;e++){const a=t[n+e];let s=i[a];s||(s={normal:Object(z.f)(),count:0},i[a]=s),Object(F.f)(s.normal,s.normal,r),s.count++}}const r=new Float32Array(3*t.length),a=new Uint32Array(3*t.length);for(let n=0;n<t.length;n++){const e=i[t[n]];1!==e.count&&(Object(F.r)(e.normal,e.normal),e.count=1);for(let t=0;t<3;t++)r[3*n+t]=e.normal[t];a[n]=n}return{normals:r,indices:a,didFlipNormals:!1}}_getFaceVertices(e,t,i,r,a,n){const s=3*t[i+0],o=3*t[i+1],c=3*t[i+2];r[0]=e[s+0],r[1]=e[s+1],r[2]=e[s+2],a[0]=e[o+0],a[1]=e[o+1],a[2]=e[o+2],n[0]=e[c+0],n[1]=e[c+1],n[2]=e[c+2]}_calculateFaceNormal(e,t,i,r){return this._getFaceVertices(e,t,i,$a,Xa,Ya),Object(F.j)(Xa,Xa,$a),Object(F.j)(Ya,Ya,$a),Object(F.g)($a,Xa,Ya),Object(F.r)(r,$a),r}_getOrCreateComponents(e){return Object(a.t)(e.components,en)}_createPositionBuffer(e,t){let i=e.vertexAttributes.position;const r=t.reprojection===tn.ECEF?t.transformBeforeProject:null;if(Object(a.k)(r)&&(i=Object(Va.h)(i,new Float64Array(i.length),r)),t.reprojection===tn.NONE)return t.needsBufferCopy?new Float64Array(i):i;const n=Object(a.k)(r)?i:new Float64Array(i.length);return Object(U.l)(i,e.spatialReference,0,n,this._context.renderCoordsHelper.spatialReference,0,i.length/3),n}_createNormalBuffer(e,t,i){let r=e.vertexAttributes.normal;if(Object(a.j)(r))return null;const n=i.reprojection===tn.ECEF?i.transformBeforeProject:null;if(Object(a.k)(n)&&(r=Object(Va.g)(r,new Float32Array(r.length),n)),"local"===this._context.graphicsCoreOwner.view.viewingMode||i.reprojection===tn.NONE)return i.needsBufferCopy&&e.vertexAttributes.normal===r?new Float32Array(r):r;const s=e.vertexAttributes.position,o=Object(a.k)(n)?r:new Float32Array(r.length);return Object(Va.c)(r,s,t,e.spatialReference,o)}_createTangentBuffer(e,t,i){let r=e.vertexAttributes.tangent;if(Object(a.j)(r))return null;const n=i.reprojection===tn.ECEF?i.transformBeforeProject:null;if(Object(a.k)(n)&&(r=Object(Va.i)(r,new Float32Array(r.length),n)),"local"===this._context.graphicsCoreOwner.view.viewingMode||i.reprojection===tn.NONE)return i.needsBufferCopy&&e.vertexAttributes.normal===r?new Float32Array(r):r;const s=e.vertexAttributes.position,o=Object(a.k)(n)?r:new Float32Array(r.length);return Object(Va.e)(r,s,t,e.spatialReference,o)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const t=this._getVertexOpacityAndColor(e),i=Object(Ba.c)(Object(a.i)(this.symbolLayer,"material","colorMixMode")),r=new Uint8Array(4);return Object(Ba.b)(t,i,r),r}return null}_createBuffers(e,t){const i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const r=e.vertexAttributes.normal,n=e.vertexAttributes.uv,s=e.vertexAttributes.tangent;if(Object(a.k)(r)&&r.length!==i.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(Object(a.k)(s)&&s.length/4!=i.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(Object(a.k)(n)&&n.length/2!=i.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const o=this._computeReprojectionInfo(e),c=this._createPositionBuffer(e,o),l=this._createColorBuffer(e),d=this._createSymbolColorBuffer(t),h=this._createNormalBuffer(e,c,o),u=this._createTangentBuffer(e,c,o);return{positionBuffer:c,normalBuffer:h,tangentBuffer:u,uvBuffer:n,colorBuffer:l,symbolColorBuffer:d,objectTransformation:o.reprojection===tn.NONE&&Object(a.k)(o.objectTransformation)?o.objectTransformation:this._transformOriginLocal(e,c,h,u),geometryTransformation:o.reprojection===tn.NONE&&Object(a.k)(o.geometryTransformation)?o.geometryTransformation:Object(Se.d)()}}_computeReprojectionInfo(e){const t=Object(a.k)(e.transform),i=t&&e.transform.geographic||this._context.renderCoordsHelper.viewingMode===Ai.a.Local?tn.NONE:tn.ECEF;if(t){if(i===tn.NONE){const t=Object(Se.d)();return Object(U.d)(e.spatialReference,e.transform.origin,t,this._context.renderCoordsHelper.spatialReference),{reprojection:i,objectTransformation:t,geometryTransformation:Object(Se.c)(e.transform.localMatrix),needsBufferCopy:!1}}const t=Object(xe.f)(Object(Se.d)(),e.transform.origin);return Object(xe.m)(t,t,e.transform.localMatrix),{reprojection:i,transformBeforeProject:t,needsBufferCopy:!0}}return{reprojection:i,needsBufferCopy:!0}}_transformOriginLocal(e,t,i,r){const n=this._context.renderCoordsHelper.spatialReference,s=e.anchor;qa[0]=s.x,qa[1]=s.y,qa[2]=s.z;const o=Object(Se.d)();Object(U.d)(e.spatialReference,qa,o,n);const c=Ci.v.fromTypedArray(t);if(Object(xe.a)(Qa,o),Object(Ei.e)(c,c,Qa),Object(a.k)(i)||Object(a.k)(r)){if(Object(Si.f)(Ja,o),Object(Si.n)(Ja,Ja),Object(a.k)(i)){const e=Ci.u.fromTypedArray(i);Object(Ei.a)(e,e,Ja)}if(Object(a.k)(r)){const e=Ci.u.fromTypedArray(r,4*r.BYTES_PER_ELEMENT);Object(Ei.a)(e,e,Ja)}}return o}_validateFaces(e,t){const i=e.vertexAttributes.position.length/3,r=t.faces;if(r){let e=-1;for(let t=0;t<r.length;t++){const i=r[t];i>e&&(e=i)}if(i<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,t){return t.faces?t.faces:Object(ka.d)(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;const t=e.vertexAttributes&&e.vertexAttributes.position;if(!t)return!1;const i=this._context.elevationProvider.spatialReference;let r;const a=t.length/3;return e.spatialReference.equals(i)?r=t:(r=new Float64Array(t.length),Object(U.l)(e.vertexAttributes.position,e.spatialReference,0,r,i,0,a)),Object(G.h)(Ka),Object(G.k)(Ka,r,0,a),!Object(G.r)(Ka,this._context.clippingExtent)}_createGeometryInfo(e,t){if(!Object(U.b)(e.spatialReference,this._context.graphicsCoreOwner.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const i=this._createBuffers(e,t);if(Object(a.j)(i))return null;const{positionBuffer:r,uvBuffer:n,colorBuffer:s,symbolColorBuffer:o,normalBuffer:c,tangentBuffer:l,objectTransformation:d,geometryTransformation:h}=i,u=this._getOrCreateComponents(e),p=[],f=[],b=[];let m=!1;for(const g of u){if(!this._validateFaces(e,g))return null;const t=this._getOrCreateFaces(e,g);if(0===t.length)continue;const i=this._createComponentNormals(r,c,g,t);i.didFlipNormals&&(m=!0);const d=[[we.a.POSITION,{size:3,data:r,exclusive:!0}],[we.a.NORMAL,{size:3,data:i.normals,exclusive:!0}]],u=[[we.a.POSITION,t],[we.a.NORMAL,i.indices]];Object(a.k)(s)&&(d.push([we.a.COLOR,{size:4,data:s,exclusive:!0}]),u.push([we.a.COLOR,t])),Object(a.k)(o)&&(d.push([we.a.SYMBOLCOLOR,{size:4,data:o,exclusive:!0}]),u.push([we.a.SYMBOLCOLOR,new Uint16Array(t.length)])),Object(a.k)(n)&&(d.push([we.a.UV0,{size:2,data:n,exclusive:!0}]),u.push([we.a.UV0,t])),Object(a.k)(l)&&(d.push([we.a.TANGENT,{size:4,data:l,exclusive:!0}]),u.push([we.a.TANGENT,t]));const v=new Pt.a(d,u);p.push(v),f.push(h),b.push(this._getOrCreateMaterial(e,g))}return m&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:p,transformations:f,materials:b,objectTransformation:d}}_createEdgeMaterial(){const e={opacity:this._getLayerOpacity()};return ht(this.symbolLayer,e)}}}};class wc extends nt{constructor(e,t,i){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}set symbol(e){this._symbol=e;for(let t=0;t<e.symbolLayers.length;t++){const i=this.symbolLayers[t];Object(a.j)(i)||(i.symbol=e,i.symbolLayer=e.symbolLayers.items[t])}}get symbol(){return this._symbol}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const i=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const r=[];for(let a=0;a<i;a++){const n=t.getItemAt(a);if(!1===n.enabled)continue;Rc.renderPriority=1-(1+a)/i,Rc.renderPriorityStep=1/i,Rc.ignoreDrivers=n._ignoreDrivers;const s=Cc(this.symbol,n,this._context,Rc);r.push(Object(v.p)(e,(()=>{this.symbolLayers[a]=null,s.destroy()}))),this.symbolLayers[a]=s}await Object(ye.a)(this.symbolLayers,(async(e,t)=>{if(Object(a.k)(e))try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}}));for(const a of r)null==a||a.remove();if(r.length=0,Object(v.t)(e),this.symbolLayers.length&&!this.symbolLayers.some((e=>!!e)))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return Object(a.k)(t)?t.getCachedSize():null}get extentPadding(){return this._extentPadding}createGraphics3DGraphic(e,t){const i=e.graphic,r=new Array(this.symbolLayers.length);for(let s=0;s<this.symbolLayers.length;s++){const t=this.symbolLayers[s];r[s]=Object(a.k)(t)?t.createGraphics3DGraphic(e):null}const n=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new ji(i,t||this,r,e.layer,n)}get complexity(){return gt(this.symbolLayers.map((e=>Object(a.i)(e,"complexity"))))}globalPropertyChanged(e,t){const i=this.symbolLayers.length;for(let r=0;r<i;r++){const i=this.symbolLayers[r],n=e=>{const t=e.graphics[r];return t instanceof Xe?t:null};if(Object(a.k)(i)&&!i.globalPropertyChanged(e,t,n))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==it.LOADED?et.Recreate_Symbol:this.symbolLayers.reduce(((i,r)=>i!==et.Recreate_Symbol&&Object(a.k)(r)?Math.min(i,r.applyRendererDiff(e,t)):i),et.Fast_Update)}prepareSymbolPatch(e){if(this.loadStatus===it.FAILED)return;if("partial"!==e.diff.type)return;const t=e.diff.diff;if(!t.symbolLayers||"partial"!==t.symbolLayers.type)return;const i=t.symbolLayers.diff;this.symbolLayers.forEach(((t,r)=>{if(Object(a.j)(t))return;const n=i[r];if(n){const i={diff:n,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(i),e.symbolStatePatches.push(...i.symbolLayerStatePatches),i.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push(((e,t)=>{const n=e.graphics[r];Object(a.k)(n)&&i.graphics3DGraphicPatches.forEach((e=>e(n,t)))}))}}))}updateGeometry(e,t){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if(Object(a.j)(r))continue;const n=e.graphics[i];if(Object(a.j)(n)||!r.updateGeometry(n,t))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const i=this.symbolLayers[t];if(Object(a.j)(i))continue;const r=e.graphics[t];Object(a.k)(r)&&i.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=0,t=0,i=0;return this.symbolLayers.forEach((r=>{Object(a.j)(r)||(r.loadStatus===it.LOADING?e++:r.isFastUpdatesEnabled()?i++:t++)})),{loading:e,slow:t,fast:i}}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const e of this.symbolLayers)Object(a.k)(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const Rc={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};class Pc extends wc{constructor(e,t,i){super(e,t,i),this.calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this.calloutSymbolLayer=function(e,t){if(!Object(_e.b)(e))return ui.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const i=pi[e.callout.type];return i?new i(e,t):(ui.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)}(this.symbol,t))}async doLoad(e){const t=this.calloutSymbolLayer?Object(ye.c)(this.calloutSymbolLayer.load()):null;try{await super.doLoad(e),Object(v.t)(e)}catch(r){var i;throw null==(i=this.calloutSymbolLayer)||i.abortLoad(),r}t&&await t}destroy(){super.destroy(),this.calloutSymbolLayer=Object(a.d)(this.calloutSymbolLayer)}createGraphics3DGraphic(e,t){const i=super.createGraphics3DGraphic(e,t);if(Object(a.k)(this.calloutSymbolLayer)&&Object(a.k)(i)){const t=this._createCalloutGraphic(e);Object(a.k)(t)&&i.addAuxiliaryGraphic(t)}return i}globalPropertyChanged(e,t){return!!super.globalPropertyChanged(e,t)&&(!this.calloutSymbolLayer||this.calloutSymbolLayer.globalPropertyChanged(e,t,(e=>this._getCalloutGraphicLayer(e))))}updateGeometry(e,t){const i=super.updateGeometry(e,t);if(i&&this.calloutSymbolLayer){const i=this._getCalloutGraphicLayer(e);if(i)return this.calloutSymbolLayer.updateGeometry(i,t)}return i}_createCalloutGraphic(e){const t=e.renderingInfo,i={renderer:t.renderer,symbol:t.symbol,translation:[0,0,0],centerOffset:[0,0,0,0],screenOffset:[0,0],centerOffsetUnits:"world",elevationOffset:0,materialCollection:null};return e.renderingInfo=i,this.calloutSymbolLayer.createGraphics3DGraphic(e)}_getCalloutGraphicLayer(e){for(const t of e._auxiliaryGraphics)if(t.graphics3DSymbolLayer===this.calloutSymbolLayer)return t}}class Ic extends nt{constructor(e,t,i){super(t),this.symbol=e,this.convert=i,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return Object(a.k)(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return Object(a.k)(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return Object(a.k)(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this.convert(t),Object(a.k)(this.graphics3DSymbol)&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return Object(a.k)(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return Object(a.k)(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:mt}globalPropertyChanged(e,t){return!!Object(a.k)(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return Object(a.k)(this.graphics3DSymbol)?this.graphics3DSymbol.applyRendererDiff(e,t):et.Recreate_Symbol}prepareSymbolPatch(e){Object(a.k)(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return!!Object(a.k)(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(e,t)}onRemoveGraphic(){}getFastUpdateStatus(){return Object(a.k)(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){Object(a.k)(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}}class Dc{constructor(e){this.graphicsCore=e,this.idToState=new Map,this.states=new Set;const t=e.owner.layer&&e.owner.layer.objectIdField;t?(this.getGraphicId=e=>Object(B.e)(e,t),this.getGraphics3DGraphicById=e=>this.graphicsCore.getGraphics3DGraphicByObjectId(e)):(this.getGraphicId=e=>e.uid,this.getGraphics3DGraphicById=e=>this.graphicsCore.getGraphics3DGraphicById(e))}destroy(){this.idToState.clear(),this.states.forEach(((e,t)=>this.remove(t)))}add(e){const t={remove:()=>this.remove(e)};if(this.states.has(e))return t;const i=this.getGraphicId(e.graphic),r=this.getGraphics3DGraphicById(i);return this.states.has(e)||this.states.add(e),this._ensureStateList(i).push(e),e.displaying=!!Object(a.k)(r)&&r.isVisible(),e.isDraped=!!Object(a.k)(r)&&r.isDraped,e.tracking=!0,Object(a.k)(r)&&e.emit("changed",{}),t}remove(e){if(this.states.has(e)){if(this.idToState.size){const t=this.getGraphicId(e.graphic),i=this.idToState.get(t);i&&(Object(o.h)(i,e),0===i.length&&this.idToState.delete(t))}this.states.delete(e),e.tracking=!1,e.displaying=!1}}addGraphic(e){this._forEachState(e,(t=>{t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit("changed",{})}))}removeGraphic(e){this._forEachState(e,(e=>{e.displaying=!1,e.isDraped=!1}))}updateGraphicGeometry(e){this._forEachState(e,(e=>{e.emit("changed",{})}))}updateGraphicVisibility(e){this._forEachState(e,(t=>{t.displaying=e.isVisible()}))}allGraphicsDeleted(){this.states.forEach((e=>{e.displaying=!1}))}_ensureStateList(e){const t=this.idToState.get(e);if(t)return t;const i=new Array;return this.idToState.set(e,i),i}_forEachState(e,t){if(0===this.states.size||0===this.idToState.size)return;const i=this.getGraphicId(e.graphic),r=this.idToState.get(i);null!=r&&r.forEach(t)}}var Mc=i(991);let Lc=class extends R.a{constructor(e){super(e),this._index=new Mc.a(9,Object(c.a)("esri-csp-restrictions")?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(e){this._addMany(e)}destroy(){this._missing.clear(),this._index.destroy(),this._index=null,this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(e,t,i){t.equals(this.spatialReference)&&(Nc.minX=e[0],Nc.minY=e[1],Nc.maxX=e[2],Nc.maxY=e[3],this.update(),this._index.search(Nc,(e=>i(e.graphic.uid))))}add(e){this._missing.add(e),this.updating=!0}remove(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);this._index.remove(e);const t=Object(B.e)(e.graphic,this._get("objectIdField"));null!=t&&this._boundsByFeature.delete(t)}_addMany(e){if(0===e.length)return;const t=this._get("objectIdField");for(const i of e){i.computeExtent(this.spatialReference);const e=Object(B.e)(i.graphic,t);null!=e&&this._boundsByFeature.set(e,i.extent)}this._index.load(e)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(e,t){Nc.minX=e[0],Nc.minY=e[1],Nc.maxX=e[2],Nc.maxY=e[3],this.update(),this._index.search(Nc,(e=>{t(e)}))}getBounds(e,t){this.update();const i=this._boundsByFeature.get(e);return i?Object(G.o)(t,i):null}};Object(r.a)([Object(s.b)({constructOnly:!0})],Lc.prototype,"spatialReference",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Lc.prototype,"hasZ",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Lc.prototype,"hasM",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Lc.prototype,"objectIdField",void 0),Object(r.a)([Object(s.b)()],Lc.prototype,"updating",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Lc.prototype,"updatingRemaining",null),Lc=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.SpatialIndex2D")],Lc);const Nc={minX:0,minY:0,maxX:0,maxY:0};var Fc=i(645);const zc=D.a.getLogger("esri.views.3d.layers.support.StageLayerElevationProvider");let Uc=class extends(he.a.EventedMixin(R.a)){constructor(e){super(e),this.elevationOffset=0,this._layerHandes=new I.a}initialize(){this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersectLayers=[this.stageLayer],this.intersector=Object(In.a)(this.view.state.viewingMode),this.intersector.options.store=gn.c.MIN;const e=this._computeLayerExtent(this.stageLayer);this.zmin=e[2],this.zmax=e[5];const t=this.stageLayer.events;this._layerHandes.add([t.on("layerObjectAdded",(e=>this._objectChanged(e.object))),t.on("layerObjectRemoved",(e=>this._objectChanged(e.object))),t.on("objectGeometryAdded",(e=>this._objectChanged(e.object))),t.on("objectGeometryRemoved",(e=>this._objectChanged(e.object))),t.on("vertexAttrsUpdated",(e=>this._objectChanged(e.object))),t.on("objectTransformation",(e=>this._objectChanged(e)))])}dispose(){this._layerHandes.destroy()}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=Object(fc.f)(this.layer.spatialReference),i=Object(Fc.a)(e.unit);this.elevationOffset=Object(a.t)(e.offset,0)*i/t}else this.elevationOffset=0}getElevation(e,t,i,r){if(kc[0]=e,kc[1]=t,kc[2]=i,!this.renderCoordsHelper.toRenderCoords(kc,r,kc))return zc.error("could not project point for elevation alignment"),null;const a=this.elevationOffset,n=this.zmin+a,s=this.zmax+a;this.renderCoordsHelper.setAltitude(Hc,s,kc),this.renderCoordsHelper.setAltitude(Wc,n,kc);return this.intersector.reset(Hc,Wc,null),this.intersector.intersect(this.intersectLayers,null,1,null,(e=>e.metadata&&e.metadata.isElevationSource)),this.intersector.results.min.getIntersectionPoint(kc)?this.renderCoordsHelper.getAltitude(kc):null}_objectChanged(e){var t;if(null==(t=e.metadata)||!t.isElevationSource||!this.spatialReference)return;Object(G.h)(Gc),e.metadata.lastValidElevationBB.isEmpty()||this._expandExtent(e.metadata.lastValidElevationBB.min,e.metadata.lastValidElevationBB.max,Gc);const i=e.boundingVolumeWorldSpace.min,r=e.boundingVolumeWorldSpace.max;this._expandExtent(i,r,Gc),Object(G.A)(Gc,Vc),this.zmin=Math.min(this.zmin,Gc[2]),this.zmax=Math.max(this.zmax,Gc[5]),Bc.extent=Vc,Bc.spatialReference=this.spatialReference,this.emit("elevation-change",Bc),Object(F.k)(e.metadata.lastValidElevationBB.min,i),Object(F.k)(e.metadata.lastValidElevationBB.max,r)}_computeLayerExtent(e){return Object(G.h)(Gc),e.objects.forAll((e=>this._expandExtent(e.boundingVolumeWorldSpace.min,e.boundingVolumeWorldSpace.max,Gc))),Gc}_expandExtent(e,t,i){for(let r=0;r<8;++r)kc[0]=1&r?e[0]:t[0],kc[1]=2&r?e[1]:t[1],kc[2]=4&r?e[2]:t[2],this.renderCoordsHelper.fromRenderCoords(kc,kc,this.spatialReference),Object(G.n)(i,kc);return i}};Object(r.a)([Object(s.b)({constructOnly:!0})],Uc.prototype,"layer",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Uc.prototype,"stageLayer",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Uc.prototype,"view",void 0),Object(r.a)([Object(s.b)({readOnly:!0,aliasOf:"view.spatialReference"})],Uc.prototype,"spatialReference",void 0),Uc=Object(r.a)([Object(l.a)("esri.views.3d.layers.support.StageLayerElevationProvider")],Uc);const Gc=Object(G.h)(),Vc=Object(V.m)(),Bc={spatialReference:null,extent:Vc,context:"scene"},kc=Object(z.f)(),Hc=Object(z.f)(),Wc=Object(z.f)();const qc=Object(z.f)();var $c=i(564),Xc=i(270);class Yc{constructor(e,t){this.owner=t,this.properties={},this.afterDispatchHandle=null;for(const i in e){const t=e[i],r=new $c.a(t,null,null,2,2);this.properties[i]={pool:r,acquired:[]}}this.afterDispatchHandle=Object(Xc.a)((()=>this._release()))}destroy(){this.afterDispatchHandle&&(this.afterDispatchHandle.remove(),this.afterDispatchHandle=null);for(const e in this.properties){const t=this.properties[e];for(const e of t.acquired)Object(Xc.b)(e)||t.pool.release(e);t.pool.destroy(),t.pool=null,t.acquired=null}this.properties=null,this.owner=null}get(e){const t=this.owner._get(e),i=this.properties[e];let r=i.pool.acquire();for(i.acquired.push(r);r===t;)i.acquired.push(r),r=i.pool.acquire();return r}_release(){for(const e in this.properties){const t=this.properties[e];let i=0;for(const e of t.acquired)Object(Xc.b)(e)?t.acquired[i++]=e:t.pool.release(e);t.acquired.length=i}}}var Zc,Qc=i(1088),Jc=i(776),Kc=i(113),el=i(466),tl=i(299),il=i(224);const rl=Object(z.f)(),al=Object(G.f)(),nl=D.a.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");let sl=Zc=class extends R.a{constructor(e){super(e),this.propertiesPool=new Yc({computedExtent:Pi.a},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this.graphicStateTracking=null,this.symbolCreationContext=new Oe(((e,t)=>this._frameTask.schedule(e,t))),this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this.graphicsDrapedUids=new Set,this.graphicsBySymbol=new Map,this.symbolConversionCache=new Map,this.symbols=new Map,this.graphicsWithoutSymbol=new Map,this.graphicsWaitingForSymbol=new Map,this.graphicsUpdateId=0,this._handles=new I.a,this._frameTask=ce.a,this.suspendSymbolCleanup=!1,this._spatialReference=null,this.arcadeOnDemand=null,this.rendererChangeAbortController=null,this.elevationInfoChangeAbortController=null,this.setupAbortController=null,this.elevationAlignment=null,this.scaleVisibility=null,this.filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this.featureStore=null,this.deconflictor=null,this.labeler=null,this.objectStates=null,this.viewElevationProvider=null,this.stageLayerElevationProvider=null,this.sharedSymbolResourcesOwnerHandle=null,this.whenGraphics3DGraphicRequests={},this.pendingUpdates=new Map,this.numberOfGraphics=0,this.numberOfGraphicsProvidingElevation=0,this.pendingAdds=0,this.pendingRemoves=0,this.pendingUpdatesPool=new L.a({allocator:e=>e||new cl,deallocator:e=>(e.clear(),e)}),this.symbolWarningLogged=!1,this.geometryWarningLogged=!1,this.objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new L.a,this.preferredUpdatePolicy=$e.j.SYNC,this.forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=void 0,this._startCreateGraphics=!1}get spatialIndex(){var e;return this._spatialIndex||(this._spatialIndex=new Lc({objectIdField:null==(e=this.owner.layer)?void 0:e.objectIdField,spatialReference:this._spatialReference,hasZ:this.hasZ,hasM:this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get effectiveUpdatePolicy(){return Object(a.k)(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?$e.j.ASYNC:Object(a.t)(this.forcedUpdatePolicy,this.preferredUpdatePolicy)}get updating(){var e,t;return!!(this.graphicsWaitingForSymbol.size>0||this.running||null!=(e=this.elevationAlignment)&&e.updating||Object(a.k)(this.scaleVisibility)&&this.scaleVisibility.updating||null!=(t=this.filterVisibility)&&t.updating||this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating)}get running(){var e;return this.pendingUpdates.size>0||!(null==(e=this._spatialIndex)||!e.updating)}get suspendedOrOutsideOfView(){var e;return this.owner.suspended||(null==(e=this.owner.suspendInfo)?void 0:e.outsideOfView)}get updatingRemaining(){var e,t;return this.updating?this.pendingUpdates.size+.1*((null==(e=this._spatialIndex)?void 0:e.updatingRemaining)||0)+.1*((null==(t=this.elevationAlignment)?void 0:t.updatingRemaining)||0):0}get displayFeatureLimit(){const e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?e.graphics3D.minTotalNumberOfFeatures:0,i=e?e.graphics3D.maxTotalNumberOfFeatures:0,r=e?e.graphics3D.maxTotalNumberOfPrimitives:0,n=this.averageSymbolComplexity,s=Math.max(1,Object(a.k)(n)?n.primitivesPerFeature:1),o=Object(a.k)(n)&&n.drawCallsPerFeature>0?i/n.drawCallsPerFeature*.3:i,c=Math.ceil(r/s),l=Math.max(t,Math.min(i,c,o)),d=this._get("displayFeatureLimit");return d&&d.minimumTotalNumberOfFeatures===t&&d.maximumTotalNumberOfFeatures===i&&d.maximumTotalNumberOfPrimitives===r&&d.averageSymbolComplexity===n&&d.maximumNumberOfFeatures===l?d:{minimumTotalNumberOfFeatures:t,maximumTotalNumberOfFeatures:i,maximumTotalNumberOfPrimitives:r,averageSymbolComplexity:n,maximumNumberOfFeatures:l}}get averageSymbolComplexity(){const e=function(e){const t=gt(e);return t.numComplexities>0&&(t.primitivesPerFeature/=t.numComplexities,t.primitivesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.bytesPerCoordinate/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities,t.memory.draped.bytesPerCoordinate/=t.numComplexities),t}(this.symbolComplexities),t=this._get("averageSymbolComplexity");return 0===e.numComplexities||Object(a.k)(t)&&(e.estimated&&(t.primitivesPerFeature>=e.primitivesPerFeature||t.primitivesPerCoordinate>=e.primitivesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.primitivesPerFeature===e.primitivesPerFeature&&t.primitivesPerCoordinate===e.primitivesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}get spatialReference(){return this._spatialReference}get usedMemory(){const e=Object(a.k)(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0;return this._usedMemory+e}get usedMemoryPerGraphic(){if(this._usedMemory&&this.numberOfGraphics)return Math.abs(this.pendingAdds-this.pendingRemoves)/this.numberOfGraphics>30?0:this._usedMemory/this.numberOfGraphics;if(Object(a.k)(this.averageSymbolComplexity)){const e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)}get symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}_getConvertedSymbol(e){if("web-style"===e.type)return e.clone();const t=this.symbolConversionCache.get(e.id);if(Object(a.k)(t))return t;const i=Object(oe.a)(e,{retainId:!0,hasLabelingContext:this._hasLabelingContext(e)}),r=i.symbol||null;return Object(a.j)(r)&&i.error&&nl.error(i.error.message),this.symbolConversionCache.set(e.id,r),r}_getSymbolComplexitiesUsedOrRenderer(e){if(Object(a.j)(e))return[];const t=e.getSymbols(),i="backgroundFillSymbol"in e&&e.backgroundFillSymbol;if(!(i||t&&t.length))return[];const r=[],n=this._getSymbolComplexityUsedOrRenderer(i);Object(a.k)(n)&&r.push(n);for(const s of t){const e=this._getSymbolComplexityUsedOrRenderer(s);Object(a.k)(e)&&r.push(e)}return r}_getSymbolComplexityUsedOrRenderer(e){if(Object(a.j)(e))return null;const t=this.symbols.get(e.id);if(Object(a.k)(t))return t.complexity;const i=this._getConvertedSymbol(e);return Object(a.k)(i)?function(e){return"web-style"===e.type?mt:gt(e.symbolLayers.toArray().map((t=>Ot(e,t))))}(i):null}_getSymbolComplexitiesUsed(){const e=[];return this.symbols.forEach((t=>{Object(a.k)(t)&&e.push(t.complexity)})),e}initialize(){this._spatialReference=this.owner.view.spatialReference,this._set("featureStore",new ge({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,spatialReference:this._spatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forAllGraphics:e=>this.graphics3DGraphics.forEach(e)}))}async setup(e){this.setupAbortController=new AbortController;const t=this.setupAbortController.signal;this._set("elevationAlignment",e.elevationAlignment),this._set("scaleVisibility",e.scaleVisibility),this._set("filterVisibility",e.filterVisibility),this._set("deconflictor",e.deconflictor),this._set("labeler",e.labeler),this._set("objectStates",e.objectStates);const i=this.owner.view;this.viewElevationProvider=new le(this._spatialReference,i),this._initializeStage(i,this.layer.uid),this.symbolCreationContext.sharedResources=i.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=i.sharedSymbolResources.addGraphicsOwner(this.owner),Object(a.k)(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=i.sharedSymbolResources.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=i.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new Qc.a(i.renderSpatialReference),this.symbolCreationContext.elevationProvider=i.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);const r=Object(de.e)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await Object(de.b)(r,this._spatialReference,nl),Object(v.t)(t),this.symbolCreationContext.screenSizePerspectiveEnabled=i.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled;const n="layer"in this.owner?["layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled"]:"view.screenSizePerspectiveEnabled";this._handles.add([this.watch("suspendedOrOutsideOfView",(()=>this._frameTask.reschedule((()=>this._updateLayerVisibility())))),this.owner.watch(n,(()=>{const e=i.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;var t;e!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=e,null==(t=this.labeler)||t.reset(),this.recreateAllGraphicsAndSymbols())})),this.owner.watch("slicePlaneEnabled",(e=>this._slicePlaneEnabledChange(!!e))),this.owner.view.watch("pixelRatio",(()=>this._pixelRatioChange())),this.owner.view.watch("qualitySettings.physicallyBasedRenderingEnabled",(e=>this._physicalBasedRenderingChange(e))),Object(h.e)(i.basemapTerrain,"tilingScheme",(e=>{e.spatialReference.equals(this.symbolCreationContext.overlaySR)||(this.symbolCreationContext.overlaySR=i.basemapTerrain.spatialReference),this._handles.has("loaded-graphics")?this.recreateAllGraphics():this._handles.add([Object(h.b)(this.owner,"loadedGraphics","change",(e=>this._graphicsCollectionChanged(e)),(()=>this.recreateAllGraphics())),Object(h.b)(this.owner,"loadedGraphics","after-changes",(()=>this._signalUpdatingDuringAsyncLoadedGraphicsChange()),(()=>this._signalUpdatingDuringAsyncLoadedGraphicsChange()))],"loaded-graphics")})),Object(h.f)(this,"asyncUpdates",(()=>this.runTask(ce.c)),!0),Object(h.a)(this,"effectiveUpdatePolicy",(e=>{Object(a.k)(this.stageLayer)&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===$e.j.ASYNC,e===$e.j.SYNC&&this.runTask(ce.c)}),!0)]),this._frameTask=i.resourceController.scheduler.registerTask(ce.b.GRAPHICS_CORE,this),this.owner.layer&&"featureReduction"in this.owner.layer&&this._handles.add(this.owner.watch("layer.featureReduction",(()=>this.deconflictor.featureReductionChange()))),this.notifyChange("averageSymbolComplexity");try{await this.rendererChange(this.layer.renderer)}catch{}Object(v.t)(t),this.setupAbortController=null}_abortSetup(){this.setupAbortController&&(this.setupAbortController.abort(),this.setupAbortController=null)}destroy(){this._abortSetup(),this._abortRendererChange(),this._abortElevationInfoChange(),this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._updatingPendingLoadedGraphicsChange=Object(a.r)(this._updatingPendingLoadedGraphicsChange),this.clear(),this.graphicStateTracking=Object(a.d)(this.graphicStateTracking),this.stage&&(this.stage.remove(this.stageLayer),this.stageLayer=null,this.stage=null),this._handles=Object(a.d)(this._handles),this._frameTask.remove(),this._frameTask=ce.a,this._spatialReference=null,this._set("owner",null);for(const e in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[e].reject(new P.a("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle=Object(a.r)(this.sharedSymbolResourcesOwnerHandle),this.propertiesPool=Object(a.d)(this.propertiesPool),this.pendingUpdatesPool=null,this.symbolConversionCache.clear(),this.objectIdInvisibleSet.clear(),this._spatialIndex=Object(a.d)(this._spatialIndex),this._set("featureStore",Object(a.d)(this.featureStore))}clear(){var e,t;null==(e=this.objectStates)||e.allGraphicsDeleted(),Object(a.k)(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach((e=>e.destroy())),null==(t=this._spatialIndex)||t.clear(),this.graphics3DGraphics.clear(),this.numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this.symbols.forEach(a.d),this.symbols.clear(),this.graphicsBySymbol.clear(),this.graphicsWithoutSymbol.clear(),this.graphicsWaitingForSymbol.clear(),this.pendingUpdates.clear(),this.pendingUpdatesPool.clear(),this.pendingAdds=0,this.pendingRemoves=0,this.notifyChange("updating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this.featureStore.events.emit("changed")}_initializeStage(e,t){this.stage=e._stage,this.stageLayer=new Jc.a({isPickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t),this.stage.add(this.stageLayer);const i=this.stageLayer.events;i.on("objectTransformation",(e=>this.notifyGraphicGeometryChanged(e.metadata.graphicUid))),i.on("visibilityChanged",(e=>this.notifyGraphicVisibilityChanged(e.metadata.graphicUid))),i.on("objectGeometryAdded",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid))),i.on("objectGeometryRemoved",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid))),i.on("vertexAttrsUpdated",(e=>this.notifyGraphicGeometryChanged(e.object.metadata.graphicUid)))}notifyGraphicGeometryChanged(e){if(Object(a.j)(this.graphicStateTracking)||Object(a.j)(e))return;const t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicGeometry(t)}notifyGraphicVisibilityChanged(e){if(Object(a.j)(this.graphicStateTracking)||Object(a.j)(e))return;const t=this.graphics3DGraphics.get(e);t&&this.graphicStateTracking.updateGraphicVisibility(t)}_updateLayerVisibility(){const e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this.numberOfGraphics>e*ll,i=!this.suspendedOrOutsideOfView&&!t;i!==this._visible&&(this._visible=i,i?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())}_updateStageLayerVisibility(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)}getGraphics3DGraphicById(e){return this.graphics3DGraphics.get(e)}getGraphics3DGraphicByObjectId(e){var t;return null!=(t=this.owner.layer)&&t.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e,t=this.owner.layer&&this.owner.layer.objectIdField){return Object(B.e)(e,t)}get graphics3DGraphicsByObjectID(){const e=this.owner.layer&&this.owner.layer.objectIdField;if(!e)return null;const t=new Map;return this.graphics3DGraphics.forEach((i=>{if(!i)return;const r=i.graphic,n=this._getGraphicObjectID(r,e);Object(a.k)(n)&&t.set(n,i)})),t}get labelsEnabled(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())}async updateLabelingInfo(e){const t=this.deconflictor&&this.deconflictor.labelingInfoChange(e),i=this.labeler&&this.labeler.labelingInfoChange(e);await Object(v.i)([t,i])}updateVisibilityInfo(){this.deconflictor&&this.deconflictor.labelingInfoChange(),this.labeler&&this.labeler.visibilityInfoChange()}get symbolUpdateType(){if(this.pendingUpdates.size>0)return"unknown";let e=0,t=0;return Object(M.c)(this.symbols,((i,r)=>{if(Object(a.k)(i)){const a=i.getFastUpdateStatus();if(a.loading>0)return!0;this.graphicsBySymbol.has(r)&&(t+=a.fast,e+=a.slow)}return!1}))?"unknown":t>=0&&0===e?"fast":e>=0&&0===t?"slow":"mixed"}runTask(e){this._frameTask.processQueue(e),this._applyPendingUpdates(e),this.notifyChange("running"),this.running||this.notifyChange("updating"),this.notifyChange("updatingRemaining")}setObjectIdVisibility(e,t){t?this.objectIdInvisibleSet.delete(e):this.objectIdInvisibleSet.add(e);const i=this._findGraphics3DGraphicByObjectId(e);Object(a.k)(i)&&this._updateUserVisibility(i)}_findGraphics3DGraphicByObjectId(e){return Object(M.a)(this.graphics3DGraphics,(t=>this._getGraphicObjectID(t.graphic)===e))}_updateUserVisibility(e){if(Object(a.j)(e))return!1;const t=e.graphic,i=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&(Object(a.j)(i)||!this.objectIdInvisibleSet.has(i));return e.setVisibilityFlag(ne.USER_SETTING,r,ae.GRAPHIC)}_whenGraphics3DGraphic(e){const t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);const i=this.whenGraphics3DGraphicRequests[e.uid];if(i)return i.promise;const r=Object(v.e)();return this.whenGraphics3DGraphicRequests[e.uid]=r,r.promise}async _boundsForGraphics3DGraphic(e,t){const i=this._spatialReference,r=this.owner.view.renderSpatialReference,n=this.owner.view.basemapTerrain.spatialReference,s=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:Object(a.k)(t)&&t.useViewElevation,minDemResolution:Object(a.k)(t)&&t.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,o=await e.getProjectedBoundingBox(((e,t,a)=>Object(U.l)(e,r,t,e,i,t,a)),((e,t,r)=>Object(U.l)(e,n,t,e,i,t,r)),s,Object(a.i)(t,"signal"));if(!o)return null;const c=o.boundingBox;if(o.requiresDrapedElevation){const e=this.symbolCreationContext.elevationProvider;if(e){Object(G.d)(c,rl);const t=Object(a.t)(e.getElevation(rl[0],rl[1],0,i,"ground"),0);c[2]=Math.min(c[2],t),c[5]=Math.max(c[5],t)}}return{boundingBox:c,screenSpaceObjects:o.screenSpaceObjects}}async whenGraphicBounds(e,t){await Object(h.j)(this.owner,"loadedGraphics");const i=this.owner.layer&&this.owner.layer.objectIdField,r=this.owner.loadedGraphics.find((t=>t===e||i&&t.attributes&&e.attributes&&t.attributes[i]===e.attributes[i]));if(!r)throw new P.a("internal:graphic-not-part-of-view","Graphic is not part of this view");const a=await this._whenGraphics3DGraphic(r);return this._boundsForGraphics3DGraphic(a,t)}computeAttachmentOrigin(e,t){const i=this.graphics3DGraphics.get(e.uid);if(!i)return null;const r=i.computeAttachmentOrigin();if(0===r.render.num&&0===r.draped.num)return null;Object(F.w)(dl,0,0,0);let n=0;if(r.render.num>0){if(!Object(U.t)(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,hl,t))return null;Object(F.f)(dl,dl,hl),n++}if(r.draped.num>0){const[e,i]=r.draped.origin,s=Object(a.t)(this.viewElevationProvider.getElevation(e,i,"ground"),0);if(Object(F.w)(hl,e,i,s),!Object(U.t)(hl,this.viewElevationProvider.spatialReference,hl,t))return null;Object(F.f)(dl,dl,hl),n++}return n>1&&Object(F.e)(dl,dl,1/n),new Kc.a({x:dl[0],y:dl[1],z:dl[2],spatialReference:t})}getSymbolLayerSize(e,t){const i=this.symbols.get(e.id);if(Object(a.j)(i))throw new P.a("internal:symbol-not-part-of-view","Symbol is not part of this view");const r=e.symbolLayers.indexOf(t);if(-1===r)throw new P.a("internal:missing-symbol-layer","Symbol layer is not in symbol");const n=i.getSymbolLayerSize(r);if(null==n)throw new P.a("internal:missing-size","Symbol layer has no valid size");return n}_graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}graphicUpdateHandler(e){const t=e.graphic.uid,i=this.graphics3DGraphics.get(t);if(!Object(a.j)(i)||!Object(a.j)(this.graphicsWithoutSymbol.get(t)))switch(e.property){case"visible":this._graphicUpdateVisibleHandler(i);break;case"geometry":this._graphicUpdateGeometryHandler(i,e);break;case"symbol":this._graphicUpdateSymbolHandler(i,e);break;case"attributes":break;case"transform":this._graphicUpdateTransformHandler(i,e)}}_graphicUpdateGeometryHandler(e,t){const i=t.graphic.geometry;if(Object(a.j)(i))return void this._recreateGraphic(t.graphic);if(Object(a.j)(e)){const e=t.graphic.symbol&&t.graphic.symbol.id;if(e){const t=this.symbols.get(e);if(Object(a.k)(t)&&t.loadStatus===it.LOADING)return}return void this._recreateGraphic(t.graphic)}const r=e.graphics3DSymbol;!Object(a.j)(t.newValue)&&r.updateGeometry(e,t.newValue)||this._recreateGraphic(e.graphic),this._expandComputedExtent(i)}_graphicUpdateSymbolHandler(e,t){const i=t.graphic,r=Object(a.k)(e)?e.graphics3DSymbol:Object(a.k)(t.oldValue)?this.symbols.get(t.oldValue.id):null;if(Object(a.j)(r)||Object(a.j)(t.newValue))return void this._recreateGraphic(i);const n=r.symbol,s=this._getConvertedSymbol(t.newValue);if(Object(a.k)(s)&&(s.type!==n.type||"web-style"===s.type)||"web-style"===n.type)return void this._recreateGraphic(i);const o=this.graphicsBySymbol.get(n.id);if(o&&1!==o.size)return void this._recreateGraphic(i);const c=Object(O.a)(n,s);if(Object(a.j)(c))return void this._updateSymbolMapping(n.id,s);const l={diff:c,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(l),!Object(O.d)(l.diff))return void this._recreateGraphic(i);const d=this._getRenderingInfo(i);if(Object(a.j)(d))return void this._recreateGraphic(i);const h=r.extentPadding;for(const a of l.symbolStatePatches)a();if(h!==r.extentPadding&&this._recomputeExtentPadding(),Object(a.k)(e))for(const a of l.graphics3DGraphicPatches)a(e,d);this._updateSymbolMapping(n.id,s)}_graphicUpdateVisibleHandler(e){this._updateUserVisibility(e)&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}_graphicUpdateTransformHandler(e,t){}recreateGraphics(e){this.suspendSymbolCleanup=!0,this.remove(e),this.add(e),this.suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===$e.j.SYNC&&this._cleanupSymbols()}_recreateGraphic(e){this.recreateGraphics([e])}_beginGraphicUpdate(e){const t=this.graphicsUpdateId;return this.graphicsUpdateId++,this.graphicsWaitingForSymbol.set(e.uid,t),1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating"),t}_endGraphicUpdate(e){e&&(this.graphicsWaitingForSymbol.delete(e.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))}_recomputeExtentPadding(){let e=0;this.symbols.forEach((t=>{Object(a.k)(t)&&(e=Math.max(e,t.extentPadding))})),this._set("extentPadding",e)}_expandComputedExtent(e){const t=al,i=e.spatialReference;Object(B.c)(e,t);const r=this._spatialReference,a=Zc.tmpVec;if(i.equals(r)||Object(U.v)(t[0],t[1],0,i,a,r)&&(t[0]=a[0],t[1]=a[1],Object(U.v)(t[3],t[4],0,i,a,r),t[3]=a[0],t[4]=a[1]),!(isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])))return;const n=this.computedExtent;let s=null;const o=isFinite(t[2])&&isFinite(t[5]),c=o&&(!n||null==n.zmin||t[2]<n.zmin),l=o&&(!n||null==n.zmax||t[5]>n.zmax);n?(t[0]<n.xmin||t[1]<n.ymin||t[3]>n.xmax||t[4]>n.ymax||c||l)&&(s=this.propertiesPool.get("computedExtent"),s.xmin=Math.min(t[0],n.xmin),s.ymin=Math.min(t[1],n.ymin),s.xmax=Math.max(t[3],n.xmax),s.ymax=Math.max(t[4],n.ymax),s.spatialReference=r):(s=this.propertiesPool.get("computedExtent"),s.xmin=t[0],s.ymin=t[1],s.xmax=t[3],s.ymax=t[4],s.spatialReference=r),s&&(c&&(s.zmin=t[2]),l&&(s.zmax=t[5]),this._set("computedExtent",s))}_abortElevationInfoChange(){this.elevationInfoChangeAbortController&&(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)}async elevationInfoChange(){var e,t;this._abortElevationInfoChange();const i=new AbortController;this.elevationInfoChangeAbortController=i;const r=Object(de.e)(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await Object(de.b)(r,this._spatialReference,nl),Object(v.t)(i),this.elevationInfoChangeAbortController=null,null==(e=this.labeler)||e.elevationInfoChange(),this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("elevationInfo",t)?t.forEach((e=>{const t=e.graphic,i=e.labelGraphics;for(const r of i)r.graphics3DSymbolLayer.updateGraphicElevationContext(t,r)})):this._recreateSymbol(i)})),this.updateStageLayerElevationProvider(),null==(t=this.elevationAlignment)||t.elevationInfoChange()}updateStageLayerElevationProvider(){this.stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this.numberOfGraphicsProvidingElevation>0&&(this.stageLayerElevationProvider=new Uc({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))}_clearSymbolsAndGraphics(){var e,t,i,r,a;this.clear(),null==(e=this.filterVisibility)||e.clear(),null==(t=this.labeler)||t.reset(),null==(i=this.deconflictor)||i.clear(),null==(r=this.elevationAlignment)||r.clear(),null==(a=this.stageLayer)||a.invalidateSpatialQueryAccelerator(),this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(e=!1){if(!this._startCreateGraphics)return;const{loadedGraphics:t,view:i}=this.owner,r=i.basemapTerrain.tilingScheme&&t&&t.length?t.toArray():null;!e&&r||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),r&&(e?this.add(r):this.recreateGraphics(r))}_recreateSymbol(e){const t=this.graphicsBySymbol.get(e),i=[];t&&(t.forEach(((e,t)=>{var r;const a=e.usedMemory;this._conditionalRemove(e,t),null==(r=this._spatialIndex)||r.remove(e),i.push(e.graphic),e.destroy(),this._removeGraphics3DGraphic(t,a),this._updateLayerVisibility(),this.featureStore.events.emit("changed")})),this.graphicsBySymbol.set(e,new Map));const r=this.symbols.get(e);Object(a.d)(r),this.symbols.delete(e),this.add(i)}_recreateGraphicsForSymbol(e){const t=this.graphicsBySymbol.get(e);if(t){const e=[];t.forEach((t=>e.push(t.graphic))),this.recreateGraphics(e)}}_conditionalRemove(e,t){var i,r,n;this.graphicsDrapedUids.delete(t),null==(i=this.objectStates)||i.removeGraphic(e),null==(r=this.labeler)||r.removeGraphic(e),null==(n=this.deconflictor)||n.removeGraphic(e),Object(a.k)(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(e)}add(e){e&&0!==e.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(e)===$e.j.ASYNC?this._addDelayed(e):this._addImmediate(e),this.notifyChange("updating")):nl.error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(e){if(this.effectiveUpdatePolicy===$e.j.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const t of e)if(Object(a.k)(t.geometry)&&"mesh"===t.geometry.type&&!t.geometry.loaded)return $e.j.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(e){this.geometryWarningLogged=!1,this.symbolWarningLogged=!1;for(const t of e)this._addGraphic(t,this._getRenderingInfo(t,nl),$e.j.SYNC);this._cleanupSymbols(),this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()}_addDelayed(e){for(const t of e){const e=t.uid;let i=this.pendingUpdates.get(e);i?i.add?i.state!==ol.NEW&&i.abortController.abort():this.pendingAdds++:(i=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(e,i)),i.add=t}this.notifyChange("running"),this.notifyChange("updatingRemaining")}remove(e){this.effectiveUpdatePolicy===$e.j.ASYNC?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange("updating")}_removeImmediate(e){for(const t of e)this._removeGraphic(t);this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}_removeDelayed(e){for(const t of e){const e=t.uid,i=this.pendingUpdates.get(e);if(i)i.add&&(i.remove?i.add=null:this.pendingUpdates.delete(e),i.state===ol.LOADING&&i.abortController.abort(),this.pendingAdds--);else{const i=this.pendingUpdatesPool.pushNew();i.remove=t,this.pendingUpdates.set(e,i),this.pendingRemoves++}}0===this.pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining")}_finishPendingUpdates(){this.pendingUpdatesPool.clear(),this._cleanupSymbols(),(this.pendingAdds||this.pendingRemoves)&&nl.warn("pendingAdds/Removes in inconsistent state!"),this.pendingAdds=0,this.pendingRemoves=0}_applyPendingUpdates(e){var t;if(this.geometryWarningLogged=!1,this.symbolWarningLogged=!1,0===this.pendingUpdates.size&&null!=(t=this._spatialIndex)&&t.updating)this._spatialIndex.update();else{for(const[t,i]of this.pendingUpdates){if(e.done)break;i.add&&i.state===ol.NEW&&this._processPendingUpdateNew(i);let r=this.effectiveUpdatePolicy;if(!i.remove||i.add&&i.state!==ol.READY||(this.pendingRemoves--,e.madeProgress(),this._removeGraphic(i.remove),i.remove=null,r=$e.j.SYNC),i.add)switch(i.state){case ol.READY:this._addGraphic(i.add,i.renderingInfo,r),i.add=null,this.pendingAdds--,e.madeProgress();break;case ol.REJECTED:i.add=null,this.pendingAdds--;case ol.LOADING:}null==i.remove&&null==i.add&&this.pendingUpdates.delete(t)}0===this.pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}}_processPendingUpdateNew(e){if(!e.add)return void(e.state=ol.READY);const t=e.add.geometry;Object(a.k)(t)&&"mesh"===t.type&&!t.loaded?this._processPendingUpdateNewMesh(e,t):this._processPendingUpdateNewRenderingInfo(e)}async _processPendingUpdateNewMesh(e,t){e.state=ol.LOADING,e.abortController=new AbortController;const i=e.abortController.signal;try{await t.load({signal:i})}catch(r){return this._processPendingUpdateNewError(e,r)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e)}_processPendingUpdateNewError(e,t){e.abortController=null,Object(v.l)(t)?e.state=ol.NEW:e.state=ol.REJECTED}async _processPendingUpdateNewRenderingInfo(e){if(Object(a.j)(this.layer.renderer)||"dictionary"!==this.layer.renderer.type)return e.renderingInfo=this._getRenderingInfo(e.add,nl),void(e.state=ol.READY);e.state=ol.LOADING,e.abortController=new AbortController;let t=null;try{t=await this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal})}catch(i){return e.abortController=null,void(Object(v.l)(i)?e.state=ol.NEW:e.state=ol.REJECTED)}Object(a.j)(t)||Object(a.j)(t.symbol)?(nl&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,nl.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),e.renderingInfo=null):e.renderingInfo=t,e.state=ol.READY}_addGraphic(e,t,i){if(this.graphicsWithoutSymbol.set(e.uid,e),Object(a.j)(t)||Object(a.j)(t.symbol)||!Object(B.f)(e))return;const r=t.symbol,n=this.getOrCreateGraphics3DSymbol(r,t.renderer);if(Object(a.j)(n))return;this._expandComputedExtent(e.geometry);const s=this._beginGraphicUpdate(e),o=new ve(e,t,this.layer);let c=!1;const l=e=>{e===n.symbol.id&&(c=!0)};this._whenSymbolRemoved.push(l);const d=()=>{if(!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(l),this.graphicsWaitingForSymbol.get(e.uid)!==s||c||n.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==n.symbol.id)--n.referenced;else{const t=this._createGraphics3DGraphic(n,o);this._spatialIndex&&Object(a.k)(t)&&this._spatialIndex.add(t),--n.referenced,this._endGraphicUpdate(e)}this.featureStore.events.emit("changed"),this.labeler&&this.owner.view.labeler.setDirty()}},h=t=>{this.destroyed||(this._whenSymbolRemoved.removeUnordered(l),c||(Object(v.l)(t)?this.add([e]):n.destroyed||this._endGraphicUpdate(e)))};i===$e.j.ASYNC?n.load((()=>this._frameTask.schedule(d)),(e=>this._frameTask.schedule((()=>h(e))))):n.load(d,h)}_removeGraphic(e){const t=e.uid,i=this.graphics3DGraphics.get(t);if(i){var r;i.graphics3DSymbol.onRemoveGraphic(i);const e=i.usedMemory,a=i.isElevationSource;this._conditionalRemove(i,t),null==(r=this._spatialIndex)||r.remove(i);const n=i.graphics3DSymbol.symbol.id;this.graphicsBySymbol.get(n).delete(t),this.graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,e,a),i.destroy(),this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(t),this.graphicsWaitingForSymbol.delete(t),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))}_hasLabelingContext(e){if(e instanceof el.a||e instanceof tl.a){const t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some((t=>t.symbol===e))}return!1}_hasValidSymbolCreationContext(e){return!(e instanceof el.a&&!this._hasLabelingContext(e))||(nl.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)}_getRenderingInfo(e,t){const i=e.geometry;if(Object(a.j)(i))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!Object(U.b)(i.spatialReference,this._spatialReference))return t&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&Object(a.k)(e.symbol))return t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?Object(_.c)(e,this.layer):e;let n;return n=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||Object(a.k)(this.currentRenderer))?this.owner.getRenderingInfo(r,this.currentRenderer,Object(a.s)(this.arcadeOnDemand)):{symbol:r.symbol||re(r.geometry)},Object(a.j)(n)||Object(a.j)(n.symbol)?(t&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,t.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):n}_getRenderingInfoAsync(e,t){const i=e.geometry;if(Object(a.j)(i))return nl&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,nl.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&Object(a.k)(e.symbol))return nl&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,nl.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const r=this.rendererHasGeometryOperations?Object(_.c)(e,this.layer):e;return this.owner.getRenderingInfoAsync(r,Object(a.s)(this.currentRenderer),Object(a.s)(this.arcadeOnDemand),t)}_createGraphics3DSymbol(e,t){if(!this._hasValidSymbolCreationContext(e))return null;const i=this._getConvertedSymbol(e);if(!i)return null;let r;if(Object(a.k)(t)&&"backgroundFillSymbol"in t&&t.backgroundFillSymbol){const e=Object(oe.a)(t.backgroundFillSymbol,{ignoreDrivers:!0});Object(a.k)(e.symbol)&&"web-style"!==e.symbol.type&&"cim"!==e.symbol.type&&(r=e.symbol.symbolLayers)}const n=function(e,t,i){let r;return r="point-3d"===e.type?Pc:wc,new r(e,t,i)}(i,this.symbolCreationContext,r);return n.load((()=>{const e=n.extentPadding;e>this.extentPadding&&this._set("extentPadding",e),this.notifyChange("averageSymbolComplexity")}),(()=>{})),n}getOrCreateGraphics3DSymbol(e,t){let i=this.symbols.get(e.id);return void 0===i&&(i=e instanceof il.a?new Ic(e,(e=>this._frameTask.schedule(e)),(e=>this._createGraphics3DSymbol(e,t))):this._createGraphics3DSymbol(e,t),this.symbols.set(e.id,i)),Object(a.k)(i)&&++i.referenced,i}trackGraphicState(e){return Object(a.j)(this.graphicStateTracking)&&(this.graphicStateTracking=new Dc(this)),this.graphicStateTracking.add(e)}_addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this.numberOfGraphics++,e.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(e,t,i=!1){this._usedMemory-=t,this.graphics3DGraphics.delete(e),this.numberOfGraphics--,i&&(this.numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(e,t){var i,r,n,s;const o=t.graphic;if(this.graphicsWithoutSymbol.delete(o.uid),!this.symbols.has(e.symbol.id))return this.add([o]),null;if(this.graphics3DGraphics.has(o.uid))return null;const c=e.createGraphics3DGraphic(t);if(Object(a.j)(c))return null;this._addGraphics3DGraphic(c);const l=e.symbol.id;this.graphicsBySymbol.has(l)||this.graphicsBySymbol.set(l,new Map),this.graphicsBySymbol.get(l).set(o.uid,c),c.isDraped&&this.graphicsDrapedUids.add(o.uid),c.centroid=null,Object(a.k)(o.geometry)&&"point"!==o.geometry.type&&(c.centroid=Object(Ce.a)(o.geometry,this._spatialReference)),this._updateUserVisibility(c),Object(a.k)(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(c),null==(i=this.filterVisibility)||i.updateVisibility(c),null==(r=this.deconflictor)||r.addGraphic(c),null==(n=this.labeler)||n.addGraphic(c),null==(s=this.objectStates)||s.addGraphic(c),this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,c),c.initialize(this.stage,this.stageLayer,this.owner),Object(a.k)(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(c);const d=this.whenGraphics3DGraphicRequests[o.uid];return d&&(delete this.whenGraphics3DGraphicRequests[o.uid],d.resolve(c)),c}_abortRendererChange(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)}async rendererChange(e){if(this._abortRendererChange(),e!==this.currentRenderer)if(this._validateRenderer(e),Object(a.j)(e)&&this._currentRendererChange(null,!1),Object(k.a)(e))if(Object(a.k)(e)&&e.arcadeRequired){const t=new AbortController;this.rendererChangeAbortController=t;const{arcadeUtils:i}=await this._ensureArcade();Object(v.t)(t),i.hasGeometryOperations(e)&&(await i.enableGeometryOperations(),Object(v.t)(t)),this.effectiveUpdatePolicy===$e.j.ASYNC?await this._frameTask.schedule((()=>this._currentRendererChange(e,!0)),t.signal):this._currentRendererChange(e,!0),this.rendererChangeAbortController=null}else if(this.effectiveUpdatePolicy===$e.j.ASYNC){const t=new AbortController;this.rendererChangeAbortController=t,await this._frameTask.schedule((()=>this._currentRendererChange(e,!1)),t.signal),this.rendererChangeAbortController=null}else this._currentRendererChange(e,!1);else this._currentRendererChange(e,!1)}async _ensureArcade(){return Object(a.j)(this.arcadeOnDemand)?(this.arcadeOnDemand=await Object(H.e)(),this.arcadeOnDemand):this.arcadeOnDemand}_currentRendererChange(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=Object(a.s)(this.arcadeOnDemand);const i=this.symbolCreationContext.renderer;if(e===i)return;if(this.symbolConversionCache.clear(),Object(a.j)(e))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const r=Object(O.a)(i,e);this._updateUnchangedSymbolMappings(r,e,i),this.symbolCreationContext.renderer=e,Object(a.j)(r)||("complete"===r.type?this.recreateAllGraphicsAndSymbols():"partial"===r.type&&(this._applyRendererDiff(r,e,i)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}_diffHasSymbolChange(e){for(const t in e.diff)switch(t){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1}_applySymbolSetDiff(e,t,i){e=e||[],t=t||[];const r=[];for(const n of t){const t=this.graphicsBySymbol.get(n.id);t&&t.forEach(((s,o)=>{const c=s.graphic,l=this.layer instanceof y.a?this.layer:null,d=Object(a.s)(this.arcadeOnDemand);if(n===i.defaultSymbol&&i.getSymbol(Object(_.c)(c,l),{arcade:d})===i.defaultSymbol)return;const h=s.usedMemory;e.length||i.defaultSymbol?r.push(c):this.graphicsWithoutSymbol.set(o,c);const u=this.graphics3DGraphics.get(o);this._conditionalRemove(u,o),s.destroy(),t.delete(o),this._removeGraphics3DGraphic(o,h),this._updateLayerVisibility()})),this._whenSymbolRemoved.forAll((e=>e(n.id)))}(e.length||r.length)&&(this.graphicsWithoutSymbol.forEach((e=>r.push(e))),this.graphicsWithoutSymbol.clear(),this.add(r)),this._cleanupSymbols(),this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}_applyUniqueValueRendererDiff(e,t,i){const r=e.diff.defaultSymbol,a=e.diff.uniqueValueInfos;if(r||a){const n=a?a.added.map((e=>e.symbol)):[],s=a?a.removed.map((e=>e.symbol)):[];if(a)for(let e=0;e<a.changed.length;e++)n.push(a.changed[e].newValue.symbol),s.push(a.changed[e].oldValue.symbol);return r?(i.defaultSymbol&&s.push(i.defaultSymbol),t.defaultSymbol&&n.push(t.defaultSymbol)):i.defaultSymbol&&n.length&&s.push(t.defaultSymbol),this._applySymbolSetDiff(n,s,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(e,t,i){if("unique-value"!==(null==t?void 0:t.type)||"unique-value"!==(null==i?void 0:i.type)||Object(a.k)(e)&&"partial"!==e.type)return[];const r=e=>Object(a.k)(e)?e.id:null,n=e&&e.diff,s=n&&n.defaultSymbol,o=n&&n.uniqueValueInfos;let c;if(o)c=o.unchanged.map((e=>({oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)})));else{c=[];for(const e of i.uniqueValueInfos){const i=r(e.symbol),a=t.uniqueValueInfos.find((t=>t.value===e.value));a&&i!==r(a.symbol)&&c.push({oldId:i,newId:r(a.symbol)})}}return!s&&i.defaultSymbol&&c.push({oldId:r(i.defaultSymbol),newId:r(t.defaultSymbol)}),c}_updateSymbolMapping(e,t){const i=Object(a.k)(t)&&t?"string"==typeof t?t:t.id:null;if(!e||e===i)return;const r=this.graphicsBySymbol.get(e);this.graphicsBySymbol.delete(e),void 0!==r&&this.graphicsBySymbol.set(i,r);const n=this.symbols.get(e);if(void 0!==n&&(this.symbols.delete(e),this.symbols.set(i,n),Object(a.k)(n))){const e="string"==typeof t?null:t;Object(a.k)(e)?n.symbol=e:n.symbol.id=i}}_updateUnchangedSymbolMappings(e,t,i){const r=this._calculateUnchangedSymbolMapping(e,t,i);for(const{oldId:a,newId:n}of r)this._updateSymbolMapping(a,n)}_applyRendererDiff(e,t,i){if(this._diffHasSymbolChange(e))return!1;if(t instanceof w.a&&i instanceof w.a&&this._applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)return!0;for(const[r]of this.graphicsBySymbol){const i=this.symbols.get(r);if(Object(a.k)(i))switch(i.applyRendererDiff(e,t)){case et.Recreate_Symbol:this._recreateSymbol(r);break;case et.Recreate_Graphics:this._recreateGraphicsForSymbol(r);case et.Fast_Update:}}return!0}opacityChange(){this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("opacity",t))),this._updateStageLayerVisibility()}_slicePlaneEnabledChange(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.isSliceable=e,this.forEachGraphics3DSymbol(((e,t)=>e.globalPropertyChanged("slicePlaneEnabled",t))),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange())}_physicalBasedRenderingChange(e){e!==this.symbolCreationContext.physicalBasedRenderingEnabled&&(this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("physicalBasedRenderingEnabled",t)||this._recreateSymbol(i)})))}_pixelRatioChange(){this.forEachGraphics3DSymbol(((e,t,i)=>{e.globalPropertyChanged("pixelRatio",t)||this._recreateSymbol(i)}))}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=Object(N.b)((()=>{this._updatingPendingLoadedGraphicsChange=null}))}setClippingExtent(e,t){const i=this.symbolCreationContext.clippingExtent,r=Object(V.l)();return function(e,t,i){if(Object(a.j)(e)||Object(a.j)(i))return!1;let r=!0;return qc[0]=null!=e.xmin?e.xmin:0,qc[1]=null!=e.ymin?e.ymin:0,qc[2]=null!=e.zmin?e.zmin:0,r=r&&Object(U.l)(qc,e.spatialReference,0,qc,i,0,1),t[0]=qc[0],t[1]=qc[1],qc[0]=null!=e.xmax?e.xmax:0,qc[1]=null!=e.ymax?e.ymax:0,qc[2]=null!=e.zmax?e.zmax:0,r=r&&Object(U.l)(qc,e.spatialReference,0,qc,i,0,1),t[2]=qc[0],t[3]=qc[1],null==e.xmin&&(t[0]=-1/0),null==e.ymin&&(t[1]=-1/0),null==e.xmax&&(t[2]=1/0),null==e.ymax&&(t[3]=1/0),r}(e,r,t)?this.symbolCreationContext.clippingExtent=Object(G.o)(Object(G.f)(),r):this.symbolCreationContext.clippingExtent=null,!Object(G.i)(this.symbolCreationContext.clippingExtent,i)}modifyGraphics3DGraphicVisibilities(e){let t=!1;this.graphics3DGraphics.forEach((i=>{e(i)&&(t=!0)})),t&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}forEachGraphics3DSymbol(e){for(const[t,i]of this.symbols){if(Object(a.j)(i))return;e(i,this.graphicsBySymbol.get(t)||ul,t)}}updateAllGraphicsVisibility(){this.filterVisibility&&(this.filterVisibility.dirty=!0),this.modifyGraphics3DGraphicVisibilities((e=>{const t=this._updateUserVisibility(e),i=Object(a.k)(this.scaleVisibility)&&this.scaleVisibility.updateVisibility(e);return t||i}))}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities((e=>e.setVisibilityFlag(ne.USER_SETTING,!1,ae.GRAPHIC)))}_validateRenderer(e){const t=Object(k.b)(e);if(t){const e=`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`;nl.warn(e,t.message)}}_volatileGraphicsUpdated(){var e;null==(e=this.labeler)||e.reset(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")}_cleanupSymbols(){if(this.graphicsWaitingForSymbol.size>0||this.suspendSymbolCleanup)return;let e=!1;this.symbols.forEach(((t,i)=>{if(Object(a.j)(t)||t.referenced>0)return;const r=this.graphicsBySymbol.get(i);r&&0!==r.size||(this.graphicsBySymbol.delete(i),this.symbols.delete(i),Object(a.d)(t),e=!0)})),e&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}get test(){return{snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this.symbols.keys()].sort(),graphicsBySymbol:[...this.graphicsBySymbol.keys()].sort().map((e=>({symbolId:e,graphics:[...this.graphicsBySymbol.get(e).keys()].sort()}))),graphicsWithoutSymbol:[...this.graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this.graphicsDrapedUids].sort(),pendingUpdates:this.pendingUpdates}),symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size,forceUpdatePolicy:e=>{this.forcedUpdatePolicy=e}}}get performanceInfo(){return{visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}}};var ol;sl.tmpVec=Object(z.f)(),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"computedExtent",void 0),Object(r.a)([Object(s.b)()],sl.prototype,"currentRenderer",void 0),Object(r.a)([Object(s.b)()],sl.prototype,"rendererHasGeometryOperations",void 0),Object(r.a)([Object(s.b)()],sl.prototype,"_frameTask",void 0),Object(r.a)([Object(s.b)()],sl.prototype,"rendererChangeAbortController",void 0),Object(r.a)([Object(s.b)()],sl.prototype,"elevationInfoChangeAbortController",void 0),Object(r.a)([Object(s.b)()],sl.prototype,"setupAbortController",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"elevationAlignment",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"scaleVisibility",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"filterVisibility",void 0),Object(r.a)([Object(s.b)()],sl.prototype,"_spatialIndex",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"extentPadding",void 0),Object(r.a)([Object(s.b)()],sl.prototype,"_updatingPendingLoadedGraphicsChange",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"featureStore",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"deconflictor",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"labeler",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"objectStates",void 0),Object(r.a)([Object(s.b)()],sl.prototype,"preferredUpdatePolicy",void 0),Object(r.a)([Object(s.b)()],sl.prototype,"forcedUpdatePolicy",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"effectiveUpdatePolicy",null),Object(r.a)([Object(s.b)({constructOnly:!0})],sl.prototype,"elevationFeatureExpressionEnabled",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],sl.prototype,"owner",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],sl.prototype,"layer",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],sl.prototype,"graphicSymbolSupported",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],sl.prototype,"getRenderingInfoWithoutRenderer",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"updating",null),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"running",null),Object(r.a)([Object(s.b)({readOnly:!0})],sl.prototype,"suspendedOrOutsideOfView",null),Object(r.a)([Object(s.b)({readOnly:!0,dependsOn:[]})],sl.prototype,"updatingRemaining",null),Object(r.a)([Object(s.b)({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],sl.prototype,"displayFeatureLimit",null),Object(r.a)([Object(s.b)({readOnly:!0,dependsOn:[]})],sl.prototype,"averageSymbolComplexity",null),Object(r.a)([Object(s.b)({constructOnly:!0})],sl.prototype,"hasZ",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],sl.prototype,"hasM",void 0),sl=Zc=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.Graphics3DCore")],sl),function(e){e[e.NEW=0]="NEW",e[e.LOADING=1]="LOADING",e[e.READY=2]="READY",e[e.REJECTED=3]="REJECTED"}(ol||(ol={}));class cl{constructor(){this.add=null,this.renderingInfo=null,this.state=ol.NEW,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=ol.NEW,this.abortController=null,this.remove=null}}const ll=10,dl=Object(z.f)(),hl=Object(z.f)(),ul=new Map;class pl{constructor(){this._extents=new L.a({allocator:e=>e||Object(V.l)()}),this._tmpExtent=Object(V.l)(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this._contains(e)||(this._removeContained(e),Object(V.k)(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(e){return this._mergeTight(e),e.hasProgressed}_mergeTight(e=ce.c){const t=this._extents,i=new Set;let r=0;for(;r!==t.length;){t.sort(((e,t)=>e[0]-t[0])),r=t.length,i.clear();for(let r=0;r<t.length;++r){if(e.done)return;const a=t.getItemAt(r);for(let e=r+1;e<t.length;++e){const r=t.getItemAt(e);if(r[0]>=a[2])break;i.add(r)}i.forEach((r=>{if(a===r)return;if(r[2]<=a[0])return void i.delete(r);const n=Object(V.c)(a),s=Object(V.c)(r),o=this._tmpExtent;Object(V.n)(a,r,o);const c=n+s;(Object(V.c)(o)-c)/c<.05&&(Object(V.k)(a,o),i.delete(r),t.remove(r),e.madeProgress())})),i.add(a)}}this._dirty=!1}_contains(e){return this._extents.some((t=>Object(V.f)(t,e)))}_removeContained(e){this._extents.filterInPlace((t=>!Object(V.f)(e,t)))}get test(){const e=this;return{containsPoint:t=>e._extents.some((e=>Object(V.g)(e,t)))}}}let fl=class extends R.a{constructor(){super(...arguments),this.dirtyExtents=new pl,this.globalDirty=!1,this.averageExtentUpdateSize=0,this.dirtyGraphicsSet=new Set,this.handles=new I.a,this.updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new he.a}setup(e,t,i,r){this.graphicsCoreOwner=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=i,this.elevationProvider=r;const a=this.graphicsCoreOwner.view.resourceController.scheduler;this.handles.add([r.on("elevation-change",(e=>this._elevationChanged(e))),this.graphicsCoreOwner.watch("suspended",(()=>this._suspendedChange())),a.registerTask(ce.b.ELEVATION_ALIGNMENT,this)])}destroy(){this.dirtyGraphicsSet.clear(),this.handles.destroy(),this.handles=null,this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null}clear(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this.updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this.globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty}get updatingRemaining(){return this.dirtyGraphicsSet.size+this.dirtyExtents.size*this.averageExtentUpdateSize}runTask(e){for(this.globalDirty&&(this._markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress()),e.run((()=>this.dirtyExtents.merge(e)));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.graphicsCoreOwner.view.deconflictor.setDirty(),this.notifyChange("updating")}_updateDirtyGraphics(e){const t=this.graphicsCoreOwner.view.renderCoordsHelper,i=this.graphicsCore.effectiveUpdatePolicy===$e.j.ASYNC;for(const r of this.dirtyGraphicsSet.keys()){const n=this.graphicsCore.getGraphics3DGraphicById(r);if(this.dirtyGraphicsSet.delete(r),Object(a.k)(n)&&(n.alignWithElevation(this.elevationProvider,t,i),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this.dirtyExtents.empty&&!e.done;){const t=this.dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});const r=this.dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,i,(e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);Object(a.k)(t)&&t.needsElevationUpdates()&&this.dirtyGraphicsSet.add(e)})),this.averageExtentUpdateSize=.1*(this.dirtyGraphicsSet.size-r)+.9*this.averageExtentUpdateSize,e.madeProgress()}}_markAllGraphicsElevationDirty(){this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach(((e,t)=>this.dirtyGraphicsSet.add(t)))}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:t,spatialReference:i}=e;if(this.graphicsCoreOwner.suspended){if(!this.updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this.updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i})}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.notifyChange("updating")}};Object(r.a)([Object(s.b)({readOnly:!0})],fl.prototype,"updating",null),Object(r.a)([Object(s.b)({readOnly:!0})],fl.prototype,"updatingRemaining",null),fl=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],fl);const bl=fl;var ml=i(620),gl=i(499);function vl(e,t,i,r){return jl(e,t,i,yl(r,t,i,!0))}const Ol={dir:Object(z.f)(),len:0,clip:Object(gi.a)()};function yl(e,t,i,r){const a=Ol;return e?(i&&r&&(a.len=Object(F.m)(t,i)),Object(F.k)(a.dir,e)):r?(a.len=Object(F.m)(t,i),Object(F.j)(a.dir,i,t),Object(F.e)(a.dir,a.dir,1/a.len)):(Object(F.j)(a.dir,i,t),Object(F.r)(a.dir,a.dir)),a}function _l(e,t,i){const r=Object(F.h)(Object(ms.q)(e),i.dir),a=-Object(ms.t)(e,t);if(a<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return a>0;if((a<0||r<0)&&!(a<0&&r<0))return!0;const n=a/r;return r>0?n<i.clip[1]&&(i.clip[1]=n):n>i.clip[0]&&(i.clip[0]=n),i.clip[0]<=i.clip[1]}function jl(e,t,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let a=0;a<e.length;a++)if(!_l(e[a],t,r))return!1;return!0}const xl=.5*Math.PI,Sl=xl/Math.PI*180;class Tl{constructor(e){this.renderCoordsHelper=e.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:Object(z.f)(),direction:Object(z.f)()};for(let t=0;t<4;t++)this.extent[t]={origin:Object(z.f)(),direction:Object(z.f)(),cap:{next:null,direction:Object(z.f)()}},this.planes[t]=Object(ms.d)();this.planes[ml.a.NEAR]=Object(ms.d)(),this.planes[ml.a.FAR]=Object(ms.d)(),this.planesWithoutFar=this.planes.slice(0,5)}update(e,t,i,r=!0){const a=this.extent;this._toRenderBoundingExtent(e,t,i),Object(F.f)(this.center.origin,a[0].origin,a[2].origin),Object(F.e)(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),r||Object(F.e)(this.center.direction,this.center.direction,-1);for(let n=0;n<4;n++){const e=a[n];this.renderCoordsHelper.worldUpAtPosition(e.origin,e.direction);const t=a[3===n?0:n+1];e.cap.next=t.origin,Object(F.v)(e.cap.direction,e.origin,t.origin),Object(ms.i)(e.direction,e.cap.direction,e.origin,this.planes[n]),r||Object(F.e)(e.direction,e.direction,-1)}Object(ms.i)(a[0].cap.direction,a[1].cap.direction,a[0].origin,this.planes[ml.a.NEAR]),r?Object(ms.p)(this.planes[ml.a.NEAR],this.planes[ml.a.FAR]):(Object(ms.c)(this.planes[ml.a.FAR],this.planes[ml.a.NEAR]),Object(ms.p)(this.planes[ml.a.NEAR],this.planes[ml.a.NEAR])),this.maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this.maxSpanSpatialReference=t,this.minGlobalAltitude=.9*Object(yo.e)(this.maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,i=!1){if(null==e)return!1;if(this.renderCoordsHelper.viewingMode===Ai.a.Global){const i=this.maxSpanSpatialReference.isGeographic?Sl:xl*t;if(this.maxSpan>i)return!0;if(e.altitude>=this.minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(0===this.maxSpan){const t=this.extent[0];return!(i||!e.intersectsRay(Object(gs.g)(t.origin,t.direction)))}for(let a=0;a<this.extent.length;a++){const t=this.extent[a];if(!i&&e.intersectsRay(Object(gs.g)(t.origin,t.direction)))return!0;if(e.intersectsLineSegment(Object(gl.f)(t.origin,t.cap.next,Il),t.cap.direction))return!0}const r=i?this.planes:this.planesWithoutFar;for(let a=0;a<e.lines.length;a++){const t=e.lines[a];if(vl(r,t.origin,t.endpoint,t.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,i){Object(V.d)(e,El),El[2]=i,Object(U.d)(t,El,Al,this.renderCoordsHelper.spatialReference),Object(xe.a)(wl,Al),Object(G.h)(Rl);for(const{x0:r,x1:a,y0:n,y1:s}of Cl)for(let o=0;o<5;o++){const c=o/4;El[0]=Object(gr.k)(e[r],e[a],c),El[1]=Object(gr.k)(e[n],e[s],c),El[2]=i,Object(U.t)(El,t,El,this.renderCoordsHelper.spatialReference),Object(F.q)(El,El,wl),Object(G.n)(Rl,El)}Object(F.w)(this.extent[0].origin,Rl[0],Rl[1],Rl[2]),Object(F.w)(this.extent[1].origin,Rl[3],Rl[1],Rl[2]),Object(F.w)(this.extent[2].origin,Rl[3],Rl[4],Rl[2]),Object(F.w)(this.extent[3].origin,Rl[0],Rl[4],Rl[2]);for(let r=0;r<4;++r)Object(F.q)(this.extent[r].origin,this.extent[r].origin,Al)}_toRenderBoundingExtentLocal(e,t,i){Object(U.k)(e,t,Pl,this.renderCoordsHelper.spatialReference),Object(F.w)(this.extent[0].origin,Pl[0],Pl[1],i),Object(F.w)(this.extent[1].origin,Pl[2],Pl[1],i),Object(F.w)(this.extent[2].origin,Pl[2],Pl[3],i),Object(F.w)(this.extent[3].origin,Pl[0],Pl[3],i)}_toRenderBoundingExtent(e,t,i){switch(this.renderCoordsHelper.viewingMode){case Ai.a.Global:this._toRenderBoundingExtentGlobal(e,t,i);break;case Ai.a.Local:this._toRenderBoundingExtentLocal(e,t,i);break;default:Object(st.a)(this.renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if(Object(F.h)(this.center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const i=this.extent[t];if(Object(F.h)(i.direction,e.direction)<0)return!0}return!1}}const Cl=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],El=Object(z.f)(),Al=Object(Se.d)(),wl=Object(Se.d)(),Rl=Object(G.f)(),Pl=Object(V.l)(),Il=Object(gl.d)();let Dl=class extends R.a{constructor(){super(...arguments),this.suspended=!1,this.extent=null,this.extentIntersectionDirty=!0,this._isVisibleBelowSurface=!1,this.handles=new I.a,this.graphicsCoreOwner=null,this.updating=!0}setup(e){this.graphicsCoreOwner=e,this.extentIntersection=new Tl({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,i=t.basemapTerrain,r=t.resourceController.scheduler;this.handles.add([t.on("resize",(()=>this._viewChange())),t.state.watch("camera",(()=>this._viewChange()),!0),r.registerTask(ce.b.FRUSTUM_VISIBILITY,this),i.on("elevation-bounds-change",(()=>this._elevationBoundsChange()))]),"local"===t.viewingMode?this.isVisibleBelowSurface=!0:this.handles.add([Object(h.a)(i,["opacity","wireframe"],(()=>this._updateIsVisibleBelowSurface())),Object(h.a)(t,"map.ground.navigationConstraint.type",(()=>this._updateIsVisibleBelowSurface()))])}destroy(){this.graphicsCoreOwner=null,this.extent=null,this.extentIntersection=null,this.handles&&(this.handles.destroy(),this.handles=null)}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this.extent=e,this.extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this.extentIntersectionDirty=!0}set isVisibleBelowSurface(e){this._isVisibleBelowSurface=e,this._setDirty(),this.extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){const e=this.graphicsCoreOwner.view,t=e.basemapTerrain,i="local"===e.viewingMode,r=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this.isVisibleBelowSurface=i||!t.opaque||r}_updateExtentIntersection(){if(!this.extentIntersectionDirty)return;this.extentIntersectionDirty=!1;const e=this.graphicsCoreOwner.view;let t;if(this._isVisibleBelowSurface)t=-.3*Object(yo.e)(e.spatialReference).radius;else{const{min:i,max:r}=e.basemapTerrain.elevationBounds;t=i-Math.max(1,(r-i)*(1.2-1))}this.extentIntersection.update(this.extent,e.spatialReference,t)}get running(){return this.updating}runTask(){if(this._set("updating",!1),!this.extent)return void this._set("suspended",!1);this._updateExtentIntersection();const e=this.graphicsCoreOwner.view.frustum,t=Object(yo.e)(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this.extentIntersection.isVisibleInFrustum(e,t))}};Object(r.a)([Object(s.b)({readOnly:!0})],Dl.prototype,"suspended",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Dl.prototype,"updating",void 0),Dl=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],Dl);const Ml=Dl;var Ll;!function(e){e[e.Object=0]="Object",e[e.RenderGeometry=1]="RenderGeometry",e[e.External=2]="External",e[e.COUNT=3]="COUNT"}(Ll||(Ll={}));class Nl{constructor(){this.items=[]}addObject(e,t){this.items.push({type:Ll.Object,objectStateId:t,object:e})}addRenderGeometry(e,t,i){this.items.push({type:Ll.RenderGeometry,objectStateId:t,renderGeometry:e,owner:i})}addExternal(e,t){this.items.push({type:Ll.External,objectStateId:t,remove:e})}remove(e){for(let t=this.items.length-1;t>=0;--t){const i=this.items[t];i.objectStateId===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}removeObject(e){for(let t=this.items.length-1;t>=0;--t){const i=this.items[t];i.type===Ll.Object&&i.object===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}removeRenderGeometry(e){for(let t=this.items.length-1;t>=0;--t){const i=this.items[t];i.type===Ll.RenderGeometry&&i.renderGeometry===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}removeAll(){this.items.forEach((e=>{this._removeObjectStateItem(e)})),this.items=[]}_removeObjectStateItem(e){switch(e.type){case Ll.Object:e.objectStateId.channel===$e.d.Highlight?e.object.removeHighlight(e.objectStateId):e.objectStateId.channel===$e.d.MaskOccludee&&e.object.removeOcclude(e.objectStateId);break;case Ll.RenderGeometry:e.owner.removeRenderGeometryObjectState(e.renderGeometry,e.objectStateId);break;case Ll.External:e.remove(e.objectStateId)}}}class Fl{constructor(e,t){this.stateType=e,this.objectIdField=t,this.objectStateSet=new Nl,this.ids=new Set,this.paused=!1}hasGraphic(e){if(this.objectIdField){const t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)}}class zl{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this._stateSets&&this._stateSets.forEach((e=>e.objectStateSet.removeAll())),this._stateSets=null}acquireSet(e,t){const i=new Fl(e,t);this._stateSets.push(i);const r=Object(g.c)((()=>this.releaseSet(i)));return{set:i,handle:r}}releaseSet(e){e.objectStateSet.removeAll();const t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}_addObjectStateSet(e,t){e.addObjectStateSet(t.stateType,t.objectStateSet)}_removeObjectStateSet(e,t){e.removeObjectState(t.objectStateSet)}setUid(e,t){e.ids.add(t);const i=this._graphicsCore.graphics3DGraphics.get(t);i&&this._addObjectStateSet(i,e)}setUids(e,t){t.forEach((t=>this.setUid(e,t)))}setObjectIds(e,t){t.forEach((t=>e.ids.add(t))),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach((t=>{!t.paused&&t.hasGraphic(e)&&this._addObjectStateSet(e,t)}))}removeGraphic(e){this._stateSets.forEach((t=>{t.hasGraphic(e)&&this._removeObjectStateSet(e,t)}))}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach((e=>e.objectStateSet.removeAll()))}_initializeSet(e){const t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach((t=>{t&&e.hasGraphic(t)&&this._addObjectStateSet(t,e)})):e.ids.forEach((i=>{const r=t.get(i);r&&this._addObjectStateSet(r,e)}))}get test(){return{states:this._stateSets}}}var Ul=i(534);let Gl=class extends R.a{constructor(){super(...arguments),this._scaleRangeActive=!1,this.layerScaleRangeVisibilityQuery=!1,this.handles=new I.a,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.extent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this.updating=!0}setup(e,t,i,r,a){this.graphicsCoreOwner=e,this.layer=t,this.queryGraphicUIDsInExtent=i,this.graphicsCore=r,this.basemapTerrain=a,this.updateScaleRangeActive();const n=this.graphicsCoreOwner.view.resourceController.scheduler;this.handles.add(n.registerTask(ce.b.SCALE_VISIBILITY,this))}destroy(){this.handles.destroy(),this.handles=null,this.graphicsCoreOwner=null,this.extent=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){const t=this.graphicsCoreOwner.view.spatialReference,i=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===i)this.extent=e;else{const r=Object(V.l)();Object(U.k)(e,t,r,i)?this.extent=r:this.extent=null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const e=this.layer,t=e.effectiveScaleRange;let i=this.layerScaleEnabled&&Vl(t.minScale,t.maxScale);e.labelingInfo&&!i&&(i=e.labelingInfo.some((e=>e&&Vl(e.minScale,e.maxScale))));const r=this._scaleRangeActive!==i;return this._scaleRangeActive=i,i&&!this.handles.has(Bl)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",(e=>this._scaleUpdateHandler(e))),Bl),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",(()=>this._setDirty())),Bl)):!i&&this.handles.has(Bl)&&this.handles.remove(Bl),r}get running(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(){const e=this.graphicsCoreOwner.view.basemapTerrain;if(this.extent&&e&&e.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(!this.layerScaleRangeVisibilityQuery){this.layerScaleRangeVisibilityQuery=!0;const t=this.layer.effectiveScaleRange;e.queryVisibleScaleRange(this.extent,t.minScale,t.maxScale,(e=>this._finishUpdate(e)))}}else this._finishUpdate(!0)}_finishUpdate(e){this.layerScaleRangeVisibilityQuery=!1,this._set("suspended",!e),this._set("updating",!1)}_visibleAtLayerScale(e){const t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||Object(Ul.b)(e,t.minScale||0,t.maxScale||0)}_visibleAtLabelScale(e,t){return Object(Ul.b)(e,t.minScale||0,t.maxScale||0)}_graphicScale(e){let t;return Object(a.k)(e.centroid)?t=e.centroid:Object(a.k)(e.graphic.geometry)&&"point"===e.graphic.geometry.type&&(t=e.graphic.geometry),t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}_graphicVisible(e){if(!this.layerScaleEnabled)return!0;const t=this._graphicScale(e);return this._visibleAtLayerScale(t)}updateVisibility(e){if(this._scaleRangeActive){const t=this._graphicVisible(e);return e.setVisibilityFlag(ne.SCALE_RANGE,t,ae.GRAPHIC)}return!1}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive)return!1;if(!e.labelGraphics||0===e.labelGraphics.length)return!1;const t=this._graphicScale(e),i=this._updateLabelScaleVisibility(e,t);return i&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()),i}_updateLabelScaleVisibility(e,t){if(!e.labelGraphics||0===e.labelGraphics.length)return!1;const i=e.labelGraphics[0]._labelClass;if(i&&null!=i.minScale&&null!=i.maxScale){const r=this._visibleAtLabelScale(t,i);if(e.setVisibilityFlag(ne.SCALE_RANGE,r,ae.LABEL))return!0}return!1}_scaleUpdateHandler(e){if(this._setDirty(),this.graphicsCoreOwner.suspended)return;const t=e.extent,i=e.scale,r=this._visibleAtLayerScale(i);let n=!1;this.queryGraphicUIDsInExtent(t,e.spatialReference,(e=>{const s=this.graphicsCore.getGraphics3DGraphicById(e);if(Object(a.j)(s))return;const o=s.centroid;Object(a.k)(o)&&(t[0]>o.x||t[1]>o.y||t[2]<o.x||t[3]<o.y)||(s.setVisibilityFlag(ne.SCALE_RANGE,r,ae.GRAPHIC)&&(n=!0),this._updateLabelScaleVisibility(s,i)&&(n=!0))})),n&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities((e=>e.clearVisibilityFlag(ne.SCALE_RANGE))):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}};function Vl(e,t){return e>0||t>0}Object(r.a)([Object(s.b)({constructOnly:!0})],Gl.prototype,"layerScaleEnabled",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Gl.prototype,"suspended",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Gl.prototype,"updating",void 0),Gl=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],Gl);const Bl="terrain-events",kl=Gl;let Hl=class extends m.a{constructor(e){super(e),this.type="graphics-3d",this.graphicsCore=null,this.elevationAlignment=new bl,this._suspendResumeExtent=null}normalizeCtorArgs(e){const t={...e,scaleVisibility:null,frustumVisibility:null};return delete t.scaleVisibilityEnabled,delete t.frustumVisibilityEnabled,e.scaleVisibilityEnabled&&(t.scaleVisibility=new kl),e.frustumVisibilityEnabled&&(t.frustumVisibility=new Ml),t}initialize(){const e=new sl({owner:this,layer:this.owner.layer,preferredUpdatePolicy:$e.j.SYNC,graphicSymbolSupported:!0});this._set("graphicsCore",e);const{layer:t,scaleVisibility:i}=this;if(Object(a.k)(i)&&"effectiveScaleRange"in t){const e=t;this.updatingHandles.add((()=>e.effectiveScaleRange),(()=>i.layerMinMaxScaleChangeHandler()))}if("fullOpacity"in this.owner){const e=this.owner;this.updatingHandles.add((()=>e.fullOpacity),(()=>this.graphicsCore.opacityChange()))}if("elevationInfo"in t){const e=t;this.updatingHandles.add((()=>e.elevationInfo),((e,t)=>{Object(O.a)(e,t)&&this.updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())}))}}async setup(){const e=(e,t,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i);if(this.elevationAlignment.setup(this,e,this.graphicsCore,this.view.elevationProvider),Object(a.k)(this.scaleVisibility)&&"effectiveScaleRange"in this.layer){const t=this.owner.view.basemapTerrain;this.scaleVisibility.setup(this,this.layer,e,this.graphicsCore,t)}Object(a.k)(this.frustumVisibility)&&this.frustumVisibility.setup(this),this._set("objectStates",new zl(this.graphicsCore));try{await this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,objectStates:this.objectStates})}catch(t){if(Object(v.l)(t))return;throw t}this.destroyed||(this.handles.add(this.view.watch("clippingArea",(()=>this._updateClippingExtent()),!0)),this._updateClippingExtent(),this._setupSuspendResumeExtent(),this.graphicsCore.startCreateGraphics())}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("elevationAlignment",Object(a.d)(this.elevationAlignment)),this._set("scaleVisibility",Object(a.d)(this.scaleVisibility)),this._set("frustumVisibility",Object(a.d)(this.frustumVisibility)),this._set("objectStates",Object(a.d)(this.objectStates)),this._set("graphicsCore",Object(a.d)(this.graphicsCore))}get layer(){return this.owner.layer}get view(){return this.owner.view}get scaleVisibilitySuspended(){return!(!Object(a.k)(this.scaleVisibility)||!this.scaleVisibility.suspended)}get frustumVisibilitySuspended(){return!(!Object(a.k)(this.frustumVisibility)||!this.frustumVisibility.suspended)}get suspended(){var e;return null!=(e=this.owner.suspended)&&e}get updating(){var e;return!!(null!=(e=this.graphicsCore)&&e.updating||Object(a.k)(this.scaleVisibility)&&this.scaleVisibility.updating||Object(a.k)(this.frustumVisibility)&&this.frustumVisibility.updating||this.updatingHandles.updating)}get graphics3DGraphics(){var e;return null==(e=this.graphicsCore)?void 0:e.graphics3DGraphics}get graphics3DGraphicsByObjectID(){var e;return null==(e=this.graphicsCore)?void 0:e.graphics3DGraphicsByObjectID}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){var e;return null!=(e=this.owner.fullOpacity)?e:1}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get drapeSourceType(){return this.owner.drapeSourceType}get updatePolicy(){return this.owner.updatePolicy}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}getRenderingInfo(e,t,i){const r=T(e,{renderer:t,arcade:i});if(Object(a.k)(r)&&r.color){const e=r.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255}return r}getRenderingInfoAsync(e,t,i,r){return C(e,{renderer:t,arcade:i,...r})}getGraphicFromGraphicUid(e){if(this.owner.loadedGraphics){const t=this.owner.loadedGraphics.find((t=>t.uid===e));if(t){const e=this.layer instanceof y.a?this.layer:null;return Object(_.c)(t,e)}}}whenGraphicBounds(e,t){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(e,t):Promise.reject()}computeAttachmentOrigin(e,t){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(e,t):null}getSymbolLayerSize(e,t){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(e,t):null}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet($e.d.MaskOccludee,null);return this.objectStates.setUid(t,e.uid),i}highlight(e){if(e instanceof E.a)return Wl;if("number"==typeof e)return this.highlight([e]);if(e instanceof f.a)return this.highlight([e]);if(e instanceof b.a&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof f.a){const t=e.map((e=>e.uid)),{set:i,handle:r}=this.objectStates.acquireSet($e.d.Highlight,null);return this.objectStates.setUids(i,t),r}if("number"==typeof e[0]){const t=e,{set:i,handle:r}=this.objectStates.acquireSet($e.d.Highlight,null);return this.objectStates.setObjectIds(i,t),r}}return Wl}_setupSuspendResumeExtent(){const{scaleVisibility:e,frustumVisibility:t}=this;if(Object(a.j)(e)&&Object(a.j)(t))return;const i=({computedExtent:i,extentPadding:r})=>{this._suspendResumeExtent=Object(Ce.e)(i,this._suspendResumeExtent,A.a,r),Object(a.k)(e)&&e.setExtent(this._suspendResumeExtent),Object(a.k)(t)&&t.setExtent(this._suspendResumeExtent)};this.handles.add(Object(n.e)((()=>{var e,t;return{computedExtent:null==(e=this.graphicsCore)?void 0:e.computedExtent,extentPadding:null==(t=this.graphicsCore)?void 0:t.extentPadding}}),(e=>i(e)),n.d))}_updateClippingExtent(){const e=this.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()}};Object(r.a)([Object(s.b)()],Hl.prototype,"type",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Hl.prototype,"owner",void 0),Object(r.a)([Object(s.b)()],Hl.prototype,"layer",null),Object(r.a)([Object(s.b)()],Hl.prototype,"view",null),Object(r.a)([Object(s.b)({constructOnly:!0})],Hl.prototype,"graphicsCore",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Hl.prototype,"scaleVisibility",void 0),Object(r.a)([Object(s.b)({constructOnly:!0})],Hl.prototype,"frustumVisibility",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Hl.prototype,"elevationAlignment",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Hl.prototype,"objectStates",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Hl.prototype,"scaleVisibilitySuspended",null),Object(r.a)([Object(s.b)({readOnly:!0})],Hl.prototype,"frustumVisibilitySuspended",null),Object(r.a)([Object(s.b)()],Hl.prototype,"suspended",null),Object(r.a)([Object(s.b)({readOnly:!0})],Hl.prototype,"updating",null),Object(r.a)([Object(s.b)()],Hl.prototype,"loadedGraphics",null),Object(r.a)([Object(s.b)()],Hl.prototype,"fullOpacity",null),Object(r.a)([Object(s.b)()],Hl.prototype,"slicePlaneEnabled",null),Object(r.a)([Object(s.b)()],Hl.prototype,"drapeSourceType",null),Object(r.a)([Object(s.b)()],Hl.prototype,"updatePolicy",null),Hl=Object(r.a)([Object(l.a)("esri.views.3d.layers.graphics.GraphicsProcessor")],Hl);const Wl=Object(g.c)();var ql=i(182),$l=i(1213);var Xl=i(489);let Yl=class extends(p(Xl.a)){constructor(){super(...arguments),this.type="graphics-3d",this.slicePlaneEnabled=!1,this.drapeSourceType=d.a.Features,this.fullExtentInLocalViewSpatialReference=null}initialize(){this._set("processor",new Hl({owner:this,scaleVisibilityEnabled:!0,frustumVisibilityEnabled:!0})),this.addResolvingPromise(this.processor.setup()),this.handles.add(this.layer.on("graphic-update",(e=>this.processor.graphicsCore.graphicUpdateHandler(e)))),this.addResolvingPromise(function(e){const t=e.view.spatialReference,i=e.layer.fullExtent,r=Object(a.k)(i)&&i.spatialReference;if(Object(a.j)(i)||!r)return Promise.resolve(null);if(r.equals(t))return Promise.resolve(i.clone());const n=Object(ql.d)(i,t);return Object(a.k)(n)?Promise.resolve(n):e.view.state.isLocal?Object($l.projectGeometry)(i,t,e.layer.portalItem).then((t=>!e.destroyed&&t?t:void 0)).catch((()=>null)):Promise.resolve(null)}(this).then((e=>this.fullExtentInLocalViewSpatialReference=e))),this.layer.internal?this.notifyChange("updating"):this.handles.add(Object(n.f)((()=>{var e,t;return null==(e=this.view)||null==(t=e.basemapTerrain)?void 0:t.ready}),(()=>()=>this.notifyChange("updating")),{once:!0}))}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("processor",Object(a.d)(this.processor))}get loadedGraphics(){return this.layer.graphics}get legendEnabled(){var e;return this.canResume()&&!(null!=(e=this.processor)&&e.frustumVisibilitySuspended)}getSuspendInfo(){var e,t,i,r;const a=super.getSuspendInfo();return a.outsideScaleRange=null!=(e=null==(t=this.processor)?void 0:t.scaleVisibilitySuspended)&&e,a.outsideOfView=null!=(i=null==(r=this.processor)?void 0:r.frustumVisibilitySuspended)&&i,a}async fetchPopupFeatures(e,t){return Object(a.k)(t)?t.clientGraphics:null}getGraphicFromGraphicUid(e){return this.processor.getGraphicFromGraphicUid(e)}whenGraphicBounds(e,t){return this.processor.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){var i;return null==(i=this.processor)?void 0:i.computeAttachmentOrigin(e,t)}getSymbolLayerSize(e,t){return this.processor.getSymbolLayerSize(e,t)}queryGraphics(){return Promise.resolve(this.loadedGraphics)}maskOccludee(e){return this.processor.maskOccludee(e)}highlight(e){return this.processor.highlight(e)}get updatePolicy(){var e;return(null==(e=this.processor)?void 0:e.graphicsCore.effectiveUpdatePolicy)||$e.j.SYNC}canResume(){var e;return super.canResume()&&!(null!=(e=this.processor)&&e.scaleVisibilitySuspended)}isUpdating(){var e,t,i;return!((null==(e=this.processor)||!e.updating)&&(this.layer.internal||null!=(t=this.view)&&null!=(i=t.basemapTerrain)&&i.ready))}get performanceInfo(){var e,t,i,r;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:-1,totalNumberOfFeatures:-1,nodes:0,core:null,updating:this.updating,elevationUpdating:null!=(e=null==(t=this.processor)?void 0:t.elevationAlignment.updating)&&e,visibilityFrustum:null!=(i=!(null!=(r=this.processor)&&r.frustumVisibilitySuspended))&&i}}};Object(r.a)([Object(s.b)()],Yl.prototype,"loadedGraphics",null),Object(r.a)([Object(s.b)({readOnly:!0})],Yl.prototype,"legendEnabled",null),Object(r.a)([Object(s.b)()],Yl.prototype,"layer",void 0),Object(r.a)([Object(s.b)({readOnly:!0})],Yl.prototype,"processor",void 0),Object(r.a)([Object(s.b)({type:Boolean})],Yl.prototype,"slicePlaneEnabled",void 0),Yl=Object(r.a)([Object(l.a)("esri.views.3d.layers.GraphicsLayerView3D")],Yl);const Zl=Yl},139:function(e,t,i){"use strict";var r;i.d(t,"a",(function(){return r})),function(e){e.POSITION="position",e.NORMAL="normal",e.UV0="uv0",e.AUXPOS1="auxpos1",e.AUXPOS2="auxpos2",e.MAPPOS="mapPos",e.COLOR="color",e.SYMBOLCOLOR="symbolColor",e.SIZE="size",e.TANGENT="tangent",e.OFFSET="offset",e.SUBDIVISIONFACTOR="subdivisionFactor",e.COLORFEATUREATTRIBUTE="colorFeatureAttribute",e.SIZEFEATUREATTRIBUTE="sizeFeatureAttribute",e.OPACITYFEATUREATTRIBUTE="opacityFeatureAttribute",e.DISTANCETOSTART="distanceToStart",e.UVMAPSPACE="uvMapSpace",e.BOUNDINGRECT="boundingRect",e.UVREGION="uvRegion",e.NORMALCOMPRESSED="normalCompressed",e.PROFILERIGHT="profileRight",e.PROFILEUP="profileUp",e.PROFILEVERTEXANDNORMAL="profileVertexAndNormal",e.FEATUREVALUE="featureValue",e.MODELORIGINHI="modelOriginHi",e.MODELORIGINLO="modelOriginLo",e.MODEL="model",e.MODELNORMAL="modelNormal",e.INSTANCECOLOR="instanceColor",e.INSTANCEFEATUREATTRIBUTE="instanceFeatureAttribute",e.LOCALTRANSFORM="localTransform",e.GLOBALTRANSFORM="globalTransform",e.BOUNDINGSPHERE="boundingSphere",e.MODELORIGIN="modelOrigin",e.MODELSCALEFACTORS="modelScaleFactors",e.FEATUREATTRIBUTE="featureAttribute",e.STATE="state",e.LODLEVEL="lodLevel",e.POSITION0="position0",e.POSITION1="position1",e.NORMALA="normalA",e.NORMALB="normalB",e.COMPONENTINDEX="componentIndex",e.VARIANTOFFSET="variantOffset",e.VARIANTSTROKE="variantStroke",e.VARIANTEXTENSION="variantExtension",e.U8PADDING="u8padding",e.U16PADDING="u16padding",e.SIDENESS="sideness",e.START="start",e.END="end",e.UP="up",e.EXTRUDE="extrude"}(r||(r={}))},163:function(e,t,i){"use strict";var r,a,n,s,o,c,l,d,h,u,p,f,b,m;i.d(t,"a",(function(){return b})),i.d(t,"b",(function(){return r})),i.d(t,"c",(function(){return a})),i.d(t,"d",(function(){return h})),i.d(t,"e",(function(){return p})),i.d(t,"f",(function(){return u})),i.d(t,"g",(function(){return c})),i.d(t,"h",(function(){return l})),i.d(t,"i",(function(){return s})),i.d(t,"j",(function(){return d})),i.d(t,"k",(function(){return f})),function(e){e[e.None=0]="None",e[e.Front=1]="Front",e[e.Back=2]="Back",e[e.COUNT=3]="COUNT"}(r||(r={})),function(e){e[e.Less=0]="Less",e[e.Lequal=1]="Lequal",e[e.COUNT=2]="COUNT"}(a||(a={})),function(e){e[e.NONE=0]="NONE",e[e.SMAA=1]="SMAA"}(n||(n={})),function(e){e[e.Color=0]="Color",e[e.Alpha=1]="Alpha",e[e.FrontFace=2]="FrontFace",e[e.NONE=3]="NONE",e[e.COUNT=4]="COUNT"}(s||(s={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.UPDATE=1]="UPDATE"}(o||(o={})),function(e){e[e.NOT_LOADED=0]="NOT_LOADED",e[e.LOADING=1]="LOADING",e[e.LOADED=2]="LOADED"}(c||(c={})),function(e){e[e.IntegratedMeshMaskExcluded=1]="IntegratedMeshMaskExcluded",e[e.OutlineVisualElementMask=2]="OutlineVisualElementMask"}(l||(l={})),function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"}(d||(d={})),function(e){e[e.Highlight=0]="Highlight",e[e.MaskOccludee=1]="MaskOccludee",e[e.COUNT=2]="COUNT"}(h||(h={})),function(e){e[e.Triangle=0]="Triangle",e[e.Point=1]="Point",e[e.Line=2]="Line"}(u||(u={})),function(e){e[e.STRETCH=1]="STRETCH",e[e.PAD=2]="PAD"}(p||(p={})),function(e){e[e.CHANGED=0]="CHANGED",e[e.UNCHANGED=1]="UNCHANGED"}(f||(f={})),function(e){e[e.Blend=0]="Blend",e[e.Opaque=1]="Opaque",e[e.Mask=2]="Mask",e[e.MaskBlend=3]="MaskBlend",e[e.COUNT=4]="COUNT"}(b||(b={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(m||(m={}))},188:function(e,t,i){"use strict";function r(){return new Float32Array(2)}function a(e,t){const i=new Float32Array(2);return i[0]=e,i[1]=t,i}function n(){return r()}function s(){return a(1,1)}function o(){return a(1,0)}function c(){return a(0,1)}i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return a}));const l=n(),d=s(),h=o(),u=c();Object.freeze({__proto__:null,create:r,clone:function(e){const t=new Float32Array(2);return t[0]=e[0],t[1]=e[1],t},fromValues:a,createView:function(e,t){return new Float32Array(e,t,2)},zeros:n,ones:s,unitX:o,unitY:c,ZEROS:l,ONES:d,UNIT_X:h,UNIT_Y:u})},210:function(e,t,i){"use strict";var r;i.d(t,"a",(function(){return r})),function(e){e[e.Color=0]="Color",e[e.Depth=1]="Depth",e[e.Normal=2]="Normal",e[e.Shadow=3]="Shadow",e[e.Highlight=4]="Highlight",e[e.Draped=5]="Draped",e[e.Occlusion=6]="Occlusion",e[e.Alpha=7]="Alpha",e[e.COUNT=8]="COUNT"}(r||(r={}))},272:function(e,t,i){"use strict";var r;function a(e){return e===r.Global?"global":"local"}i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return a})),function(e){e[e.Global=1]="Global",e[e.Local=2]="Local"}(r||(r={}))},278:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return u})),i.d(t,"c",(function(){return p})),i.d(t,"d",(function(){return d})),i.d(t,"e",(function(){return h})),i.d(t,"f",(function(){return f})),i.d(t,"g",(function(){return l})),i.d(t,"h",(function(){return o})),i.d(t,"i",(function(){return c}));var r=i(151),a=(i(219),i(271),i(257));Object(a.e)();class n{constructor(e){this.message=e}toString(){return`AssertException: ${this.message}`}}function s(e,t){if(!e)throw t=t||"assert",console.log(new Error(t).stack),new n(t)}function o(e,t,i,r){let a,n=(i[0]-e[0])/t[0],s=(r[0]-e[0])/t[0];n>s&&(a=n,n=s,s=a);let o=(i[1]-e[1])/t[1],c=(r[1]-e[1])/t[1];if(o>c&&(a=o,o=c,c=a),n>c||o>s)return!1;o>n&&(n=o),c<s&&(s=c);let l=(i[2]-e[2])/t[2],d=(r[2]-e[2])/t[2];return l>d&&(a=l,l=d,d=a),!(n>d||l>s)&&(d<s&&(s=d),!(s<0))}function c(e,t,i,r){e[12]=t,e[13]=i,e[14]=r}function l(e){return 1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&1===e[15]}function d(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/t)}function h(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/i)}function u(e,t,i){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}function p(e,t,i){return 2*Math.atan(i*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}function f(e,t,i,a,n){const s=e;0===e[11]?(a[0]=2/(t*s[0]),a[1]=2/(i*s[5]),a[2]=(1+s[12])/s[0],a[3]=(1+s[13])/s[5],Object(r.s)(n,0,1)):(a[0]=-2/(t*s[0]),a[1]=-2/(i*s[5]),a[2]=(1-s[8])/s[0],a[3]=(1-s[9])/s[5],Object(r.s)(n,1,0))}},279:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));class r{constructor(e,t,i,r,a,n=!1,s=0){this.name=e,this.count=t,this.type=i,this.offset=r,this.stride=a,this.normalized=n,this.divisor=s}}},297:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));const r=i(87).a.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class a{constructor(){this.includedModules=new Map}include(e,t){this.includedModules.has(e)?this.includedModules.get(e)!==t&&r.error("Trying to include shader module multiple times with different sets of options."):(this.includedModules.set(e,t),e(this.builder,t))}}class n extends a{constructor(){super(...arguments),this.vertex=new c,this.fragment=new c,this.attributes=new l,this.varyings=new d,this.extensions=new h,this.constants=new u}get fragmentUniforms(){return this.fragment.uniforms}get builder(){return this}generateSource(e){const t=this.extensions.generateSource(e),i=this.attributes.generateSource(e),r=this.varyings.generateSource(),a="vertex"===e?this.vertex:this.fragment,n=a.uniforms.generateSource(),s=a.code.generateSource(),o="vertex"===e?f:p,c=this.constants.generateSource().concat(a.constants.generateSource());return`\n${t.join("\n")}\n\n${o}\n\n${c.join("\n")}\n\n${n.join("\n")}\n\n${i.join("\n")}\n\n${r.join("\n")}\n\n${s.join("\n")}`}}class s{constructor(){this._entries=new Map}add(e,t,i){const r=`${e}_${t}_${i}`;return this._entries.set(r,{name:e,type:t,arraySize:i}),this}generateSource(){return Array.from(this._entries.values()).map((e=>`uniform ${e.type} ${e.name}${(e=>e?`[${e}]`:"")(e.arraySize)};`))}get entries(){return Array.from(this._entries.values())}}class o{constructor(){this._entries=new Array}add(e){this._entries.push(e)}generateSource(){return this._entries}}class c extends a{constructor(){super(...arguments),this.uniforms=new s,this.code=new o,this.constants=new u}get builder(){return this}}class l{constructor(){this._entries=new Array}add(e,t){this._entries.push([e,t])}generateSource(e){return"fragment"===e?[]:this._entries.map((e=>`attribute ${e[1]} ${e[0]};`))}}class d{constructor(){this._entries=new Array}add(e,t){this._entries.push([e,t])}generateSource(){return this._entries.map((e=>`varying ${e[1]} ${e[0]};`))}}class h{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const t="vertex"===e?h.ALLOWLIST_VERTEX:h.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter((e=>t.includes(e))).map((e=>`#extension ${e} : enable`))}}h.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],h.ALLOWLIST_VERTEX=[];class u{constructor(){this._entries=[]}add(e,t,i){let r="ERROR_CONSTRUCTOR_STRING";switch(t){case"float":r=u._numberToFloatStr(i);break;case"int":r=u._numberToIntStr(i);break;case"bool":r=i.toString();break;case"vec2":r=`vec2(${u._numberToFloatStr(i[0])},                            ${u._numberToFloatStr(i[1])})`;break;case"vec3":r=`vec3(${u._numberToFloatStr(i[0])},                            ${u._numberToFloatStr(i[1])},                            ${u._numberToFloatStr(i[2])})`;break;case"vec4":r=`vec4(${u._numberToFloatStr(i[0])},                            ${u._numberToFloatStr(i[1])},                            ${u._numberToFloatStr(i[2])},                            ${u._numberToFloatStr(i[3])})`;break;case"ivec2":r=`ivec2(${u._numberToIntStr(i[0])},                             ${u._numberToIntStr(i[1])})`;break;case"ivec3":r=`ivec3(${u._numberToIntStr(i[0])},                             ${u._numberToIntStr(i[1])},                             ${u._numberToIntStr(i[2])})`;break;case"ivec4":r=`ivec4(${u._numberToIntStr(i[0])},                             ${u._numberToIntStr(i[1])},                             ${u._numberToIntStr(i[2])},                             ${u._numberToIntStr(i[3])})`;break;case"mat2":case"mat3":case"mat4":r=`${t}(${Array.prototype.map.call(i,(e=>u._numberToFloatStr(e))).join(", ")})`}return this._entries.push(`const ${t} ${e} = ${r};`),this}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}}const p="#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n  precision highp sampler2D;\n#else\n  precision mediump float;\n  precision mediump sampler2D;\n#endif",f="precision highp float;\nprecision highp sampler2D;"},301:function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return h})),i.d(t,"c",(function(){return d}));var r=i(85),a=i(147),n=i(200),s=i(117),o=i(109),c=i(126);function l(e,t){if(t.slicePlaneEnabled){e.extensions.add("GL_OES_standard_derivatives"),t.sliceEnabledForVertexPrograms&&(e.vertex.uniforms.add("slicePlaneOrigin","vec3"),e.vertex.uniforms.add("slicePlaneBasis1","vec3"),e.vertex.uniforms.add("slicePlaneBasis2","vec3")),e.fragment.uniforms.add("slicePlaneOrigin","vec3"),e.fragment.uniforms.add("slicePlaneBasis1","vec3"),e.fragment.uniforms.add("slicePlaneBasis2","vec3");const i=c.a`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
#define rejectBySlice(_pos_) sliceByPlane(_pos_)
#define discardBySlice(_pos_) { if (sliceByPlane(_pos_)) discard; }`,r=c.a`vec4 applySliceHighlight(vec4 color, vec3 pos) {
SliceFactors factors = calculateSliceFactors(pos);
const float HIGHLIGHT_WIDTH = 1.0;
const vec4 HIGHLIGHT_COLOR = vec4(0.0, 0.0, 0.0, 0.3);
factors.front /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.front);
factors.side0 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side0);
factors.side1 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side1);
factors.side2 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side2);
factors.side3 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side3);
if (sliceByFactors(factors)) {
return color;
}
float highlightFactor = (1.0 - step(0.5, factors.front))
* (1.0 - step(0.5, factors.side0))
* (1.0 - step(0.5, factors.side1))
* (1.0 - step(0.5, factors.side2))
* (1.0 - step(0.5, factors.side3));
return mix(color, vec4(HIGHLIGHT_COLOR.rgb, color.a), highlightFactor * HIGHLIGHT_COLOR.a);
}`,a=t.sliceHighlightDisabled?c.a`#define highlightSlice(_color_, _pos_) (_color_)`:c.a`
        ${r}
        #define highlightSlice(_color_, _pos_) (sliceEnabled() ? applySliceHighlight(_color_, _pos_) : (_color_))
      `;t.sliceEnabledForVertexPrograms&&e.vertex.code.add(i),e.fragment.code.add(i),e.fragment.code.add(a)}else{const i=c.a`#define rejectBySlice(_pos_) false
#define discardBySlice(_pos_) {}
#define highlightSlice(_color_, _pos_) (_color_)`;t.sliceEnabledForVertexPrograms&&e.vertex.code.add(i),e.fragment.code.add(i)}}function d(e,t,i){h(e,t,i.slicePlane,{origin:i.origin})}function h(e,t,i,n){if(t.slicePlaneEnabled)if(Object(r.k)(i)){if(Object(s.k)(u,i.origin),Object(s.k)(p,i.basis1),Object(s.k)(f,i.basis2),Object(r.k)(n)&&Object(r.k)(n.origin)&&Object(s.j)(u,i.origin,n.origin),Object(r.k)(n)&&Object(r.k)(n.view)){const e=Object(r.k)(n.origin)?Object(a.j)(b,n.view,n.origin):n.view;Object(s.f)(p,p,u),Object(s.f)(f,f,u),Object(s.q)(u,u,e),Object(s.q)(p,p,e),Object(s.q)(f,f,e),Object(s.j)(p,p,u),Object(s.j)(f,f,u)}e.setUniform3fv("slicePlaneOrigin",u),e.setUniform3fv("slicePlaneBasis1",p),e.setUniform3fv("slicePlaneBasis2",f)}else e.setUniform3fv("slicePlaneBasis1",o.c),e.setUniform3fv("slicePlaneBasis2",o.c),e.setUniform3fv("slicePlaneOrigin",o.c)}const u=Object(o.f)(),p=Object(o.f)(),f=Object(o.f)(),b=Object(n.d)()},335:function(e,t,i){"use strict";i.d(t,"a",(function(){return h})),i.d(t,"b",(function(){return d})),i.d(t,"c",(function(){return r}));var r,a,n=i(85),s=i(560),o=i(544),c=i(382),l=i(434);class d extends s.a{constructor(e,t){super(),this.type=o.a.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._insertOrder=0,this._vertexAttributeLocations=c.a,this._parameters=Object(l.c)(e,t),this.validateParameters(this._parameters)}dispose(){}get parameters(){return this._parameters}update(e){return!1}setParameters(e){Object(l.h)(this._parameters,e)&&(this.validateParameters(this._parameters),this.parametersChanged())}validateParameters(e){}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.parametersChanged())}shouldRender(e){return this.isVisible()&&this.isVisibleInPass(e.pass)&&0!=(this.renderOccluded&e.renderOccludedMask)}isVisibleInPass(e){return!0}get renderOccluded(){return this.parameters.renderOccluded}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this.parametersChanged())}get insertOrder(){return this._insertOrder}set insertOrder(e){e!==this._insertOrder&&(this._insertOrder=e,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){Object(n.k)(this.repository)&&this.repository.materialChanged(this)}}(a=r||(r={}))[a.Occlude=1]="Occlude",a[a.Transparent=2]="Transparent",a[a.OccludeAndTransparent=4]="OccludeAndTransparent",a[a.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",a[a.Opaque=16]="Opaque";const h={renderOccluded:r.Occlude}},339:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return l})),i.d(t,"c",(function(){return o})),i.d(t,"d",(function(){return c}));var r,a,n=i(82),s=i(85);function o(e,t,i={}){const r=c(e);for(;r.length>1;){const e=l(t,r.shift(),i);if(Object(s.k)(e))return e}return function(e,t,i={}){if(!window.WebGLRenderingContext)return d(e,h),null;const r=l(e,t,i);return Object(s.j)(r)&&d(e,u),r}(t,r.shift(),i)}function c(e){const t=Object(n.a)("esri-force-webgl");if(t===r.WEBGL1||t===r.WEBGL2)return[t];switch(e){case"2d":return[r.WEBGL1];case"3d":return[r.WEBGL2,r.WEBGL1]}}function l(e,t,i={}){const a=t===r.WEBGL1?["webgl","experimental-webgl","webkit-3d","moz-webgl"]:["webgl2"];let n=null;for(const r of a){try{n=e.getContext(r,i)}catch(s){}if(n)break}return n}function d(e,t){const i=e.parentNode;i&&(i.innerHTML='<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+t+"</div></div></td></tr></table>")}(a=r||(r={}))[a.WEBGL1=1]="WEBGL1",a[a.WEBGL2=2]="WEBGL2";const h='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',u='It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>'},355:function(e,t,i){"use strict";i.d(t,"a",(function(){return G})),i.d(t,"b",(function(){return l})),i.d(t,"c",(function(){return h})),i.d(t,"d",(function(){return d})),i.d(t,"e",(function(){return c})),i.d(t,"f",(function(){return y})),i.d(t,"g",(function(){return s})),i.d(t,"h",(function(){return n}));var r=i(163),a=i(94);function n(e,t,i=a.c.ADD,r=[0,0,0,0]){return{srcRgb:e,srcAlpha:e,dstRgb:t,dstAlpha:t,opRgb:i,opAlpha:i,color:{r:r[0],g:r[1],b:r[2],a:r[3]}}}function s(e,t,i,r,n=a.c.ADD,s=a.c.ADD,o=[0,0,0,0]){return{srcRgb:e,srcAlpha:t,dstRgb:i,dstAlpha:r,opRgb:n,opAlpha:s,color:{r:o[0],g:o[1],b:o[2],a:o[3]}}}const o={face:a.n.BACK,mode:a.j.CCW},c={face:a.n.FRONT,mode:a.j.CCW},l=e=>e===r.b.Back?o:e===r.b.Front?c:null,d={zNear:0,zFar:1},h={r:!0,g:!0,b:!0,a:!0};function u(e){return x.intern(e)}function p(e){return T.intern(e)}function f(e){return E.intern(e)}function b(e){return w.intern(e)}function m(e){return P.intern(e)}function g(e){return D.intern(e)}function v(e){return L.intern(e)}function O(e){return F.intern(e)}function y(e){return U.intern(e)}class _{constructor(e,t){this.makeKey=e,this.makeRef=t,this.interns=new Map}intern(e){if(!e)return null;const t=this.makeKey(e),i=this.interns;return i.has(t)||i.set(t,this.makeRef(e)),i.get(t)}}function j(e){return"["+e.join(",")+"]"}const x=new _(S,(e=>({__tag:"Blending",...e})));function S(e){return e?j([e.srcRgb,e.srcAlpha,e.dstRgb,e.dstAlpha,e.opRgb,e.opAlpha,e.color.r,e.color.g,e.color.b,e.color.a]):null}const T=new _(C,(e=>({__tag:"Culling",...e})));function C(e){return e?j([e.face,e.mode]):null}const E=new _(A,(e=>({__tag:"PolygonOffset",...e})));function A(e){return e?j([e.factor,e.units]):null}const w=new _(R,(e=>({__tag:"DepthTest",...e})));function R(e){return e?j([e.func]):null}const P=new _(I,(e=>({__tag:"StencilTest",...e})));function I(e){return e?j([e.function.func,e.function.ref,e.function.mask,e.operation.fail,e.operation.zFail,e.operation.zPass]):null}const D=new _(M,(e=>({__tag:"DepthWrite",...e})));function M(e){return e?j([e.zNear,e.zFar]):null}const L=new _(N,(e=>({__tag:"ColorWrite",...e})));function N(e){return e?j([e.r,e.g,e.b,e.a]):null}const F=new _(z,(e=>({__tag:"StencilWrite",...e})));function z(e){return e?j([e.mask]):null}const U=new _((function(e){return e?j([S(e.blending),C(e.culling),A(e.polygonOffset),R(e.depthTest),I(e.stencilTest),M(e.depthWrite),N(e.colorWrite),z(e.stencilWrite)]):null}),(e=>({blending:u(e.blending),culling:p(e.culling),polygonOffset:f(e.polygonOffset),depthTest:b(e.depthTest),stencilTest:m(e.stencilTest),depthWrite:g(e.depthWrite),colorWrite:v(e.colorWrite),stencilWrite:O(e.stencilWrite)})));class G{constructor(e){this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._stateSetters=e}setPipeline(e){(this._pipelineInvalid||e!==this._pipeline)&&(this._setBlending(e.blending),this._setCulling(e.culling),this._setPolygonOffset(e.polygonOffset),this._setDepthTest(e.depthTest),this._setStencilTest(e.stencilTest),this._setDepthWrite(e.depthWrite),this._setColorWrite(e.colorWrite),this._setStencilWrite(e.stencilWrite),this._pipeline=e),this._pipelineInvalid=!1}invalidateBlending(){this._blendingInvalid=!0,this._pipelineInvalid=!0}invalidateCulling(){this._cullingInvalid=!0,this._pipelineInvalid=!0}invalidatePolygonOffset(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}invalidateDepthTest(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}invalidateStencilTest(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDepthWrite(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}invalidateColorWrite(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}invalidateStencilWrite(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}_setBlending(e){this._blending=this._setSubState(e,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}_setCulling(e){this._culling=this._setSubState(e,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}_setPolygonOffset(e){this._polygonOffset=this._setSubState(e,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}_setDepthTest(e){this._depthTest=this._setSubState(e,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}_setStencilTest(e){this._stencilTest=this._setSubState(e,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}_setDepthWrite(e){this._depthWrite=this._setSubState(e,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}_setColorWrite(e){this._colorWrite=this._setSubState(e,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}_setStencilWrite(e){this._stencilWrite=this._setSubState(e,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}_setSubState(e,t,i,r){return(i||e!==t)&&(r(e),this._pipelineInvalid=!0),e}}},356:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return a}));var r=i(126);function a(e,t){e.fragment.uniforms.add("terrainDepthTexture","sampler2D"),e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("inverseViewport","vec2"),e.fragment.code.add(r.a`
    // Compare the linearized depths of fragment and terrain. Discard fragments on the wrong side of the terrain.
    void terrainDepthTest(vec4 fragCoord, float fragmentDepth){

      float terrainDepth = linearDepthFromTexture(terrainDepthTexture, fragCoord.xy * inverseViewport, nearFar);
      if(fragmentDepth ${t.cullAboveGround?">":"<="} terrainDepth){
        discard;
      }
    }
  `)}function n(e,t){t.multipassTerrainEnabled&&t.terrainLinearDepthTexture&&e.bindTexture(t.terrainLinearDepthTexture,"terrainDepthTexture")}},359:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r,a,n,s={exports:{}};r=s,a=function(){function e(e,i,a){a=a||2;var n,s,o,l,d,h,u,p=i&&i.length,f=p?i[0]*a:e.length,b=t(e,0,f,a,!0),m=[];if(!b||b.next===b.prev)return m;if(p&&(b=c(e,i,b,a)),e.length>80*a){n=o=e[0],s=l=e[1];for(var g=a;g<f;g+=a)(d=e[g])<n&&(n=d),(h=e[g+1])<s&&(s=h),d>o&&(o=d),h>l&&(l=h);u=0!==(u=Math.max(o-n,l-s))?1/u:0}return r(b,m,a,n,s,u),m}function t(e,t,i,r,a){var n,s;if(a===A(e,t,i,r)>0)for(n=t;n<i;n+=r)s=T(n,e[n],e[n+1],s);else for(n=i-r;n>=t;n-=r)s=T(n,e[n],e[n+1],s);if(s&&O(s,s.next)){var o=s.next;C(s),s=o}return s}function i(e,t){if(!e)return e;t||(t=e);var i,r=e;do{if(i=!1,r.steiner||!O(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{var a=r.prev;if(C(r),(r=t=a)===r.next)break;i=!0}}while(i||r!==t);return t}function r(e,t,c,l,d,h,u){if(e){!u&&h&&p(e,l,d,h);for(var f,b,m=e;e.prev!==e.next;)if(f=e.prev,b=e.next,h?n(e,l,d,h):a(e))t.push(f.i/c),t.push(e.i/c),t.push(b.i/c),C(e),e=b.next,m=b.next;else if((e=b)===m){u?1===u?r(e=s(i(e),t,c),t,c,l,d,h,2):2===u&&o(e,t,c,l,d,h):r(i(e),t,c,l,d,h,1);break}}}function a(e){var t=e.prev,i=e,r=e.next;if(v(t,i,r)>=0)return!1;for(var a=e.next.next;a!==e.prev;){if(m(t.x,t.y,i.x,i.y,r.x,r.y,a.x,a.y)&&v(a.prev,a,a.next)>=0)return!1;a=a.next}return!0}function n(e,t,i,r){var a=e.prev,n=e,s=e.next;if(v(a,n,s)>=0)return!1;for(var o=a.x<n.x?a.x<s.x?a.x:s.x:n.x<s.x?n.x:s.x,c=a.y<n.y?a.y<s.y?a.y:s.y:n.y<s.y?n.y:s.y,l=a.x>n.x?a.x>s.x?a.x:s.x:n.x>s.x?n.x:s.x,d=a.y>n.y?a.y>s.y?a.y:s.y:n.y>s.y?n.y:s.y,h=f(o,c,t,i,r),u=f(l,d,t,i,r),p=e.prevZ,b=e.nextZ;p&&p.z>=h&&b&&b.z<=u;){if(p!==e.prev&&p!==e.next&&m(a.x,a.y,n.x,n.y,s.x,s.y,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,b!==e.prev&&b!==e.next&&m(a.x,a.y,n.x,n.y,s.x,s.y,b.x,b.y)&&v(b.prev,b,b.next)>=0)return!1;b=b.nextZ}for(;p&&p.z>=h;){if(p!==e.prev&&p!==e.next&&m(a.x,a.y,n.x,n.y,s.x,s.y,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;b&&b.z<=u;){if(b!==e.prev&&b!==e.next&&m(a.x,a.y,n.x,n.y,s.x,s.y,b.x,b.y)&&v(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function s(e,t,r){var a=e;do{var n=a.prev,s=a.next.next;!O(n,s)&&y(n,a,a.next,s)&&x(n,s)&&x(s,n)&&(t.push(n.i/r),t.push(a.i/r),t.push(s.i/r),C(a),C(a.next),a=e=s),a=a.next}while(a!==e);return i(a)}function o(e,t,a,n,s,o){var c=e;do{for(var l=c.next.next;l!==c.prev;){if(c.i!==l.i&&g(c,l)){var d=S(c,l);return c=i(c,c.next),d=i(d,d.next),r(c,t,a,n,s,o),void r(d,t,a,n,s,o)}l=l.next}c=c.next}while(c!==e)}function c(e,r,a,n){var s,o,c,d=[];for(s=0,o=r.length;s<o;s++)(c=t(e,r[s]*n,s<o-1?r[s+1]*n:e.length,n,!1))===c.next&&(c.steiner=!0),d.push(b(c));for(d.sort(l),s=0;s<d.length;s++)a=i(a=h(d[s],a),a.next);return a}function l(e,t){return e.x-t.x}function d(e){if(e.next.prev===e)return e;let t=e;for(;;){const i=t.next;if(i.prev===t||i===t||i===e)break;t=i}return t}function h(e,t){var r=function(e,t){var i,r=t,a=e.x,n=e.y,s=-1/0;do{if(n<=r.y&&n>=r.next.y&&r.next.y!==r.y){var o=r.x+(n-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(o<=a&&o>s){if(s=o,o===a){if(n===r.y)return r;if(n===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!i)return null;if(a===s)return i;var c,l=i,d=i.x,h=i.y,p=1/0;r=i;do{a>=r.x&&r.x>=d&&a!==r.x&&m(n<h?a:s,n,d,h,n<h?s:a,n,r.x,r.y)&&(c=Math.abs(n-r.y)/(a-r.x),x(r,e)&&(c<p||c===p&&(r.x>i.x||r.x===i.x&&u(i,r)))&&(i=r,p=c)),r=r.next}while(r!==l);return i}(e,t);if(!r)return t;var a=S(r,e),n=i(r,r.next);let s=d(a);return i(s,s.next),n=d(n),d(t===r?n:t)}function u(e,t){return v(e.prev,e,t.prev)<0&&v(t.next,e,e.next)<0}function p(e,t,i,r){var a=e;do{null===a.z&&(a.z=f(a.x,a.y,t,i,r)),a.prevZ=a.prev,a.nextZ=a.next,a=a.next}while(a!==e);a.prevZ.nextZ=null,a.prevZ=null,function(e){var t,i,r,a,n,s,o,c,l=1;do{for(i=e,e=null,n=null,s=0;i;){for(s++,r=i,o=0,t=0;t<l&&(o++,r=r.nextZ);t++);for(c=l;o>0||c>0&&r;)0!==o&&(0===c||!r||i.z<=r.z)?(a=i,i=i.nextZ,o--):(a=r,r=r.nextZ,c--),n?n.nextZ=a:e=a,a.prevZ=n,n=a;i=r}n.nextZ=null,l*=2}while(s>1)}(a)}function f(e,t,i,r,a){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*a)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*a)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function b(e){var t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function m(e,t,i,r,a,n,s,o){return(a-s)*(t-o)-(e-s)*(n-o)>=0&&(e-s)*(r-o)-(i-s)*(t-o)>=0&&(i-s)*(n-o)-(a-s)*(r-o)>=0}function g(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&y(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&(x(e,t)&&x(t,e)&&function(e,t){var i=e,r=!1,a=(e.x+t.x)/2,n=(e.y+t.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&a<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==e);return r}(e,t)&&(v(e.prev,e,t.prev)||v(e,t.prev,t))||O(e,t)&&v(e.prev,e,e.next)>0&&v(t.prev,t,t.next)>0)}function v(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function O(e,t){return e.x===t.x&&e.y===t.y}function y(e,t,i,r){var a=j(v(e,t,i)),n=j(v(e,t,r)),s=j(v(i,r,e)),o=j(v(i,r,t));return a!==n&&s!==o||!(0!==a||!_(e,i,t))||!(0!==n||!_(e,r,t))||!(0!==s||!_(i,e,r))||!(0!==o||!_(i,t,r))}function _(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function j(e){return e>0?1:e<0?-1:0}function x(e,t){return v(e.prev,e,e.next)<0?v(e,t,e.next)>=0&&v(e,e.prev,t)>=0:v(e,t,e.prev)<0||v(e,e.next,t)<0}function S(e,t){var i=new E(e.i,e.x,e.y),r=new E(t.i,t.x,t.y),a=e.next,n=t.prev;return e.next=t,t.prev=e,i.next=a,a.prev=i,r.next=i,i.prev=r,n.next=r,r.prev=n,r}function T(e,t,i,r){var a=new E(e,t,i);return r?(a.next=r.next,a.prev=r,r.next.prev=a,r.next=a):(a.prev=a,a.next=a),a}function C(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function E(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function A(e,t,i,r){for(var a=0,n=t,s=i-r;n<i;n+=r)a+=(e[s]-e[n])*(e[n+1]+e[s+1]),s=n;return a}return e.deviation=function(e,t,i,r){var a=t&&t.length,n=a?t[0]*i:e.length,s=Math.abs(A(e,0,n,i));if(a)for(var o=0,c=t.length;o<c;o++){var l=t[o]*i,d=o<c-1?t[o+1]*i:e.length;s-=Math.abs(A(e,l,d,i))}var h=0;for(o=0;o<r.length;o+=3){var u=r[o]*i,p=r[o+1]*i,f=r[o+2]*i;h+=Math.abs((e[u]-e[f])*(e[p+1]-e[u+1])-(e[u]-e[p])*(e[f+1]-e[u+1]))}return 0===s&&0===h?0:Math.abs((h-s)/s)},e.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},r=0,a=0;a<e.length;a++){for(var n=0;n<e[a].length;n++)for(var s=0;s<t;s++)i.vertices.push(e[a][n][s]);a>0&&(r+=e[a-1].length,i.holes.push(r))}return i},e},void 0!==(n=a())&&(r.exports=n);const o=s.exports},360:function(e,t,i){"use strict";i.d(t,"a",(function(){return p})),i.d(t,"b",(function(){return l})),i.d(t,"c",(function(){return o})),i.d(t,"d",(function(){return u})),i.d(t,"e",(function(){return d})),i.d(t,"f",(function(){return h})),i.d(t,"g",(function(){return c}));i(84);var r=i(485),a=i(117),n=i(109),s=i(288);function o(e){return e?{origin:Object(n.d)(e.origin),direction:Object(n.d)(e.direction)}:{origin:Object(n.f)(),direction:Object(n.f)()}}function c(e,t){const i=f.get();return i.origin=e,i.direction=t,i}function l(e,t=o()){return h(e.origin,e.direction,t)}function d(e,t,i=o()){return Object(a.k)(i.origin,e),Object(a.j)(i.direction,t,e),i}function h(e,t,i=o()){return Object(a.k)(i.origin,e),Object(a.k)(i.direction,t),i}function u(e,t){const i=Object(a.g)(s.d.get(),Object(a.r)(s.d.get(),e.direction),Object(a.j)(s.d.get(),t,e.origin));return Object(a.h)(i,i)}function p(e,t,i){const r=Object(a.h)(e.direction,Object(a.j)(i,t,e.origin));return Object(a.f)(i,e.origin,Object(a.e)(i,e.direction,r)),i}const f=new r.a((function(){return{origin:null,direction:null}}))},382:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(139);const a=new Map([[r.a.POSITION,0],[r.a.NORMAL,1],[r.a.UV0,2],[r.a.COLOR,3],[r.a.SIZE,4],[r.a.TANGENT,4],[r.a.AUXPOS1,5],[r.a.SYMBOLCOLOR,5],[r.a.AUXPOS2,6],[r.a.FEATUREATTRIBUTE,6],[r.a.INSTANCEFEATUREATTRIBUTE,6],[r.a.INSTANCECOLOR,7],[r.a.MODEL,8],[r.a.MODELNORMAL,12],[r.a.MODELORIGINHI,11],[r.a.MODELORIGINLO,15]])},388:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));class r{constructor(e,t){this._module=e,this._loadModule=t}get(){return this._module}async reload(){return this._module=await this._loadModule(),this._module}}},389:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(85),a=i(212),n=i(493);class s{constructor(e,t,i){this._context=e,this._locations=i,this._textures=new Map,this._freeTextureUnits=new a.a({deallocator:null}),this._glProgram=e.programCache.acquire(t.generateSource("vertex"),t.generateSource("fragment"),i),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this._fragmentUniforms=Object(n.b)()?t.fragmentUniforms.entries:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get isCompiled(){return this._glProgram.isCompiled}setUniform1b(e,t){this._glProgram.setUniform1i(e,t?1:0)}setUniform1i(e,t){this._glProgram.setUniform1i(e,t)}setUniform1f(e,t){this._glProgram.setUniform1f(e,t)}setUniform1fv(e,t){this._glProgram.setUniform1fv(e,t)}setUniform1iv(e,t){this._glProgram.setUniform1iv(e,t)}setUniform2f(e,t,i){this._glProgram.setUniform2f(e,t,i)}setUniform2fv(e,t){this._glProgram.setUniform2fv(e,t)}setUniform2iv(e,t){this._glProgram.setUniform2iv(e,t)}setUniform3f(e,t,i,r){this._glProgram.setUniform3f(e,t,i,r)}setUniform3fv(e,t){this._glProgram.setUniform3fv(e,t)}setUniform3iv(e,t){this._glProgram.setUniform3iv(e,t)}setUniform4f(e,t,i,r,a){this._glProgram.setUniform4f(e,t,i,r,a)}setUniform4fv(e,t){this._glProgram.setUniform4fv(e,t)}setUniform4iv(e,t){this._glProgram.setUniform4iv(e,t)}setUniformMatrix3fv(e,t){this._glProgram.setUniformMatrix3fv(e,t)}setUniformMatrix4fv(e,t){this._glProgram.setUniformMatrix4fv(e,t)}assertCompatibleVertexAttributeLocations(e){e.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(e,t){if(Object(r.j)(e)||null==e.glName){const e=this._textures.get(t);return e&&(this._context.bindTexture(null,e.unit),this._freeTextureUnit(e),this._textures.delete(t)),null}let i=this._textures.get(t);return null==i?(i=this._allocTextureUnit(e),this._textures.set(t,i)):i.texture=e,this._context.useProgram(this),this.setUniform1i(t,i.unit),this._context.bindTexture(e,i.unit),i.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach(((e,t)=>{this._context.bindTexture(e.texture,e.unit),this.setUniform1i(t,e.unit)})),Object(r.k)(this._fragmentUniforms)&&this._fragmentUniforms.forEach((e=>{if(("sampler2D"===e.type||"samplerCube"===e.type)&&!this._textures.has(e.name))throw new Error(`Texture sampler ${e.name} has no bound texture`)}))}_allocTextureUnit(e){return{texture:e,unit:0===this._freeTextureUnits.length?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(e){this._freeTextureUnits.push(e.unit)}}},397:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return n})),i.d(t,"c",(function(){return s}));var r=i(126),a=i(163);const n=.1,s=.001;function o(e,t){const i=e.fragment;switch(t.alphaDiscardMode){case a.a.Blend:i.code.add(r.a`
        #define discardOrAdjustAlpha(color) { if (color.a < ${r.a.float(s)}) { discard; } }
      `);break;case a.a.Opaque:i.code.add(r.a`void discardOrAdjustAlpha(inout vec4 color) {
color.a = 1.0;
}`);break;case a.a.Mask:i.uniforms.add("textureAlphaCutoff","float"),i.code.add(r.a`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } else { color.a = 1.0; } }`);break;case a.a.MaskBlend:e.fragment.uniforms.add("textureAlphaCutoff","float"),e.fragment.code.add(r.a`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } }`)}}},404:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(85),a=i(94);class n{constructor(e,t,i){this.release=i,t&&(this._config=t.snapshot()),this._program=this.initializeProgram(e),this._pipeline=this.initializePipeline(e)}destroy(){this._program=Object(r.e)(this._program),this._pipeline=this._config=null}reload(e){Object(r.e)(this._program),this._program=this.initializeProgram(e),this._pipeline=this.initializePipeline(e)}get program(){return this._program}get key(){return this._config.key}get configuration(){return this._config}bindPass(e,t){}bindMaterial(e,t){}bindDraw(e){}bindPipelineState(e,t=null,i){e.setPipelineState(this.getPipelineState(t,i))}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}get primitiveType(){return a.r.TRIANGLES}getPipelineState(e,t){return this._pipeline}}},410:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(500),a=i(126);function n(e){e.include(r.a),e.code.add(a.a`float linearDepthFromFloat(float depth, vec2 nearFar) {
return -(depth * (nearFar[1] - nearFar[0]) + nearFar[0]);
}
float linearDepthFromTexture(sampler2D depthTex, vec2 uv, vec2 nearFar) {
return linearDepthFromFloat(rgba2float(texture2D(depthTex, uv)), nearFar);
}`)}},411:function(e,t,i){"use strict";var r;i.d(t,"a",(function(){return r})),function(e){e[e.INTEGRATED_MESH=0]="INTEGRATED_MESH",e[e.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",e[e.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",e[e.OPAQUE_PLUGIN=3]="OPAQUE_PLUGIN",e[e.TRANSPARENT_MATERIAL=4]="TRANSPARENT_MATERIAL",e[e.TRANSPARENT_PLUGIN=5]="TRANSPARENT_PLUGIN",e[e.TRANSPARENT_TERRAIN=6]="TRANSPARENT_TERRAIN",e[e.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL=7]="TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL",e[e.OCCLUDED_TERRAIN=8]="OCCLUDED_TERRAIN",e[e.OCCLUDER_MATERIAL=9]="OCCLUDER_MATERIAL",e[e.TRANSPARENT_OCCLUDER_MATERIAL=10]="TRANSPARENT_OCCLUDER_MATERIAL",e[e.OCCLUSION_PIXELS=11]="OCCLUSION_PIXELS",e[e.POSTPROCESSING_ENVIRONMENT_OPAQUE=12]="POSTPROCESSING_ENVIRONMENT_OPAQUE",e[e.POSTPROCESSING_ENVIRONMENT_TRANSPARENT=13]="POSTPROCESSING_ENVIRONMENT_TRANSPARENT",e[e.LASERLINES=14]="LASERLINES",e[e.LASERLINES_CONTRAST_CONTROL=15]="LASERLINES_CONTRAST_CONTROL",e[e.HUD_MATERIAL=16]="HUD_MATERIAL",e[e.LABEL_MATERIAL=17]="LABEL_MATERIAL",e[e.LINE_CALLOUTS=18]="LINE_CALLOUTS",e[e.LINE_CALLOUTS_HUD_DEPTH=19]="LINE_CALLOUTS_HUD_DEPTH",e[e.DRAPED_MATERIAL=20]="DRAPED_MATERIAL",e[e.DRAPED_WATER=21]="DRAPED_WATER",e[e.VOXEL=22]="VOXEL",e[e.MAX_SLOTS=23]="MAX_SLOTS"}(r||(r={}))},419:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return a}));class r{constructor(){this._key="",this._keyDirty=!1,this._parameterBits=this._parameterBits?this._parameterBits.map((()=>0)):[],this._parameterNames||(this._parameterNames=[])}get key(){return this._keyDirty&&(this._keyDirty=!1,this._key=String.fromCharCode.apply(String,this._parameterBits)),this._key}snapshot(){const e=this._parameterNames,t={key:this.key};for(const i of e)t[i]=this[i];return t}}function a(e={}){return(t,i)=>{var r,a;t._parameterNames=null!=(r=t._parameterNames)?r:[],t._parameterNames.push(i);const n=t._parameterNames.length-1,s=e.count||2,o=Math.ceil(Math.log2(s)),c=null!=(a=t._parameterBits)?a:[0];let l=0;for(;c[l]+o>16;)l++,l>=c.length&&c.push(0);t._parameterBits=c;const d=c[l],h=(1<<o)-1<<d;c[l]+=o,Object.defineProperty(t,i,{get(){return this[n]},set(e){if(this[n]!==e&&(this[n]=e,this._keyDirty=!0,this._parameterBits[l]=this._parameterBits[l]&~h|+e<<d&h,"number"!=typeof e&&"boolean"!=typeof e))throw"Configuration value for "+i+" must be boolean or number, got "+typeof e}})}}},420:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return c}));var r=i(257),a=i(126);const n=Object(r.g)(1,1,0,1),s=Object(r.g)(1,0,1,1);function o(e){e.fragment.uniforms.add("depthTex","sampler2D"),e.fragment.uniforms.add("highlightViewportPixelSz","vec4"),e.fragment.constants.add("occludedHighlightFlag","vec4",n).add("unoccludedHighlightFlag","vec4",s),e.fragment.code.add(a.a`void outputHighlight() {
vec4 fragCoord = gl_FragCoord;
float sceneDepth = texture2D(depthTex, (fragCoord.xy - highlightViewportPixelSz.xy) * highlightViewportPixelSz.zw).r;
if (fragCoord.z > sceneDepth + 5e-7) {
gl_FragColor = occludedHighlightFlag;
}
else {
gl_FragColor = unoccludedHighlightFlag;
}
}`)}function c(e,t){e.bindTexture(t.highlightDepthTexture,"depthTex"),e.setUniform4f("highlightViewportPixelSz",0,0,t.inverseViewport[0],t.inverseViewport[1])}},423:function(e,t,i){"use strict";i.d(t,"a",(function(){return R})),i.d(t,"b",(function(){return P})),i.d(t,"c",(function(){return d})),i.d(t,"d",(function(){return c})),i.d(t,"e",(function(){return f})),i.d(t,"f",(function(){return p})),i.d(t,"g",(function(){return u})),i.d(t,"h",(function(){return h})),i.d(t,"i",(function(){return x})),i.d(t,"j",(function(){return S})),i.d(t,"k",(function(){return C})),i.d(t,"l",(function(){return E})),i.d(t,"m",(function(){return T})),i.d(t,"n",(function(){return w})),i.d(t,"o",(function(){return A})),i.d(t,"p",(function(){return j})),i.d(t,"q",(function(){return L})),i.d(t,"r",(function(){return I})),i.d(t,"s",(function(){return _})),i.d(t,"t",(function(){return D})),i.d(t,"u",(function(){return l}));var r=i(116),a=i(85),n=i(117),s=i(109),o=(i(498),i(288));function c(e=N){return[e[0],e[1],e[2],e[3]]}function l(e,t,i,r){return h(e,t,i,r,o.e.get())}function d(e,t){return h(t[0],t[1],t[2],t[3],e)}function h(e,t,i,r,a=c()){return a[0]=e,a[1]=t,a[2]=i,a[3]=r,a}function u(e,t,i){const r=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],a=Math.abs(r-1)>1e-5&&r>1e-12?1/Math.sqrt(r):1;return i[0]=t[0]*a,i[1]=t[1]*a,i[2]=t[2]*a,i[3]=-(i[0]*e[0]+i[1]*e[1]+i[2]*e[2]),i}function p(e,t,i,r=c()){const a=i[0]-t[0],n=i[1]-t[1],s=i[2]-t[2],o=e[0]-t[0],l=e[1]-t[1],d=e[2]-t[2],h=n*d-s*l,u=s*o-a*d,p=a*l-n*o,f=h*h+u*u+p*p,b=Math.abs(f-1)>1e-5&&f>1e-12?1/Math.sqrt(f):1;r[0]=h*b,r[1]=u*b,r[2]=p*b,r[3]=-(r[0]*e[0]+r[1]*e[1]+r[2]*e[2])}function f(e,t,i,r,a){if(e.count<3)return!1;e.getVec(i,m);let s=r,o=!1;for(;s<e.count-1&&!o;)e.getVec(s,g),s++,o=!Object(n.o)(m,g);if(!o)return!1;for(s=Math.max(s,a),o=!1;s<e.count&&!o;)e.getVec(s,v),s++,Object(n.j)(O,m,g),Object(n.r)(O,O),Object(n.j)(y,g,v),Object(n.r)(y,y),o=!Object(n.o)(m,v)&&!Object(n.o)(g,v)&&Math.abs(Object(n.h)(O,y))<b;return o?(p(m,g,v,t),!0):(0!==i||1!==r||2!==a)&&f(e,t,0,1,2)}const b=.99619469809,m=Object(s.f)(),g=Object(s.f)(),v=Object(s.f)(),O=Object(s.f)(),y=Object(s.f)();function _(e,t,i){return t!==e&&d(e,t),e[3]=-Object(n.h)(e,i),e}function j(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function x(e,t,i,r){return Object(n.g)(v,t,e),u(i,v,r)}function S(e,t,i,r){return M(e,t,Object(n.j)(o.d.get(),i,t),U,r)}function T(e,t,i){return!!Object(a.k)(t)&&M(e,t.origin,t.direction,G,i)}function C(e,t,i){return M(e,t.origin,t.vector,F.NONE,i)}function E(e,t,i){return M(e,t.origin,t.vector,F.CLAMP,i)}function A(e,t){return D(e,t)>=0}function w(e,t){const i=t[0],r=t[1],a=t[2],n=t[3],s=t[4],o=t[5];return e[0]*(e[0]>0?i:n)+e[1]*(e[1]>0?r:s)+e[2]*(e[2]>0?a:o)+e[3]>=0}function R(e,t){const i=Object(n.h)(e,t.ray.direction),r=-D(e,t.ray.origin);if(r<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return r>0;if((r<0||i<0)&&!(r<0&&i<0))return!0;const a=r/i;return i>0?a<t.c1&&(t.c1=a):a>t.c0&&(t.c0=a),t.c0<=t.c1}function P(e,t){const i=Object(n.h)(e,t.ray.direction),r=-D(e,t.ray.origin);if(i>-1e-6&&i<1e-6)return r>0;const a=r/i;return i>0?a<t.c1&&(t.c1=a):a>t.c0&&(t.c0=a),t.c0<=t.c1}function I(e,t,i){const r=Object(n.e)(o.d.get(),e,-e[3]),a=function(e,t,i){const r=Object(n.e)(o.d.get(),e,Object(n.h)(e,t));return Object(n.j)(i,t,r),i}(e,Object(n.j)(o.d.get(),t,r),o.d.get());return Object(n.f)(i,a,r),i}function D(e,t){return Object(n.h)(e,t)+e[3]}function M(e,t,i,a,s){const o=Object(n.h)(e,i);if(0===o)return!1;let c=-(Object(n.h)(e,t)+e[3])/o;return a&F.CLAMP&&(c=Object(r.e)(c,0,1)),!(!(a&F.INFINITE_MIN)&&c<0||!(a&F.INFINITE_MAX)&&c>1)&&(Object(n.f)(s,t,Object(n.e)(s,i,c)),!0)}function L(e){return e}const N=[0,0,1,0];var F,z;(z=F||(F={}))[z.NONE=0]="NONE",z[z.CLAMP=1]="CLAMP",z[z.INFINITE_MIN=4]="INFINITE_MIN",z[z.INFINITE_MAX=8]="INFINITE_MAX";const U=F.INFINITE_MIN|F.INFINITE_MAX,G=F.INFINITE_MAX},434:function(e,t,i){"use strict";i.d(t,"a",(function(){return S})),i.d(t,"b",(function(){return w})),i.d(t,"c",(function(){return T})),i.d(t,"d",(function(){return j})),i.d(t,"e",(function(){return E})),i.d(t,"f",(function(){return f})),i.d(t,"g",(function(){return v})),i.d(t,"h",(function(){return C})),i.d(t,"i",(function(){return x}));var r=i(116),a=i(85),n=i(117),s=i(109),o=i(223),c=i(163),l=i(768),d=i(278),h=i(139),u=i(513);const p=Object(o.f)();function f(e,t,i,r,a,n,s){if(!Object(u.d)(t))if(e.boundingInfo){Object(d.a)(e.primitiveType===c.f.Triangle);const t=i.tolerance;m(e.boundingInfo,r,a,t,n,s)}else{const t=e.indices.get(h.a.POSITION),i=e.vertexAttributes.get(h.a.POSITION);v(r,a,0,t.length/3,t,i,void 0,n,s)}}const b=Object(s.f)();function m(e,t,i,r,s,c){if(Object(a.j)(e))return;const l=function(e,t,i){return Object(n.w)(i,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}(t,i,b);if(Object(o.y)(p,e.getBBMin()),Object(o.x)(p,e.getBBMax()),Object(a.k)(s)&&s.applyToAabb(p),j(p,t,l,r)){const{primitiveIndices:a,indices:n,position:o}=e,l=a?a.length:n.length/3;if(l>R){const a=e.getChildren();if(void 0!==a){for(let e=0;e<8;++e)void 0!==a[e]&&m(a[e],t,i,r,s,c);return}}v(t,i,0,l,n,o,a,s,c)}}const g=Object(s.f)();function v(e,t,i,r,n,s,o,c,l){if(o)return function(e,t,i,r,n,s,o,c,l){const d=s.data,h=s.stride||s.size,u=e[0],p=e[1],f=e[2],b=t[0]-u,m=t[1]-p,v=t[2]-f;for(let O=i;O<r;++O){const e=o[O];let t=3*e,i=h*n[t++],r=d[i++],s=d[i++],y=d[i];i=h*n[t++];let j=d[i++],x=d[i++],S=d[i];i=h*n[t];let T=d[i++],C=d[i++],E=d[i];Object(a.k)(c)&&([r,s,y]=c.applyToVertex(r,s,y,O),[j,x,S]=c.applyToVertex(j,x,S,O),[T,C,E]=c.applyToVertex(T,C,E,O));const A=j-r,w=x-s,R=S-y,P=T-r,I=C-s,D=E-y,M=m*D-I*v,L=v*P-D*b,N=b*I-P*m,F=A*M+w*L+R*N;if(Math.abs(F)<=Number.EPSILON)continue;const z=u-r,U=p-s,G=f-y,V=z*M+U*L+G*N;if(F>0){if(V<0||V>F)continue}else if(V>0||V<F)continue;const B=U*R-w*G,k=G*A-R*z,H=z*w-A*U,W=b*B+m*k+v*H;if(F>0){if(W<0||V+W>F)continue}else if(W>0||V+W<F)continue;const q=(P*B+I*k+D*H)/F;q>=0&&l(q,_(A,w,R,P,I,D,g),e,!1)}}(e,t,i,r,n,s,o,c,l);const d=s.data,h=s.stride||s.size,u=e[0],p=e[1],f=e[2],b=t[0]-u,m=t[1]-p,v=t[2]-f;for(let O=i,y=3*i;O<r;++O){let e=h*n[y++],t=d[e++],i=d[e++],r=d[e];e=h*n[y++];let s=d[e++],o=d[e++],j=d[e];e=h*n[y++];let x=d[e++],S=d[e++],T=d[e];Object(a.k)(c)&&([t,i,r]=c.applyToVertex(t,i,r,O),[s,o,j]=c.applyToVertex(s,o,j,O),[x,S,T]=c.applyToVertex(x,S,T,O));const C=s-t,E=o-i,A=j-r,w=x-t,R=S-i,P=T-r,I=m*P-R*v,D=v*w-P*b,M=b*R-w*m,L=C*I+E*D+A*M;if(Math.abs(L)<=Number.EPSILON)continue;const N=u-t,F=p-i,z=f-r,U=N*I+F*D+z*M;if(L>0){if(U<0||U>L)continue}else if(U>0||U<L)continue;const G=F*A-E*z,V=z*C-A*N,B=N*E-C*F,k=b*G+m*V+v*B;if(L>0){if(k<0||U+k>L)continue}else if(k>0||U+k<L)continue;const H=(w*G+R*V+P*B)/L;H>=0&&l(H,_(C,E,A,w,R,P,g),O,!1)}}const O=Object(s.f)(),y=Object(s.f)();function _(e,t,i,r,a,s,o){return Object(n.w)(O,e,t,i),Object(n.w)(y,r,a,s),Object(n.g)(o,O,y),Object(n.r)(o,o),o}function j(e,t,i,r){return function(e,t,i,r,a){const n=(e[0]-r-t[0])*i[0],s=(e[3]+r-t[0])*i[0];let o=Math.min(n,s),c=Math.max(n,s);const l=(e[1]-r-t[1])*i[1],d=(e[4]+r-t[1])*i[1];if(c=Math.min(c,Math.max(l,d)),c<0)return!1;if(o=Math.max(o,Math.min(l,d)),o>c)return!1;const h=(e[2]-r-t[2])*i[2],u=(e[5]+r-t[2])*i[2];return c=Math.min(c,Math.max(h,u)),!(c<0)&&(o=Math.max(o,Math.min(h,u)),!(o>c)&&o<a)}(e,t,i,r,1/0)}function x(e,t,i,a,n){let s=(i.screenLength||0)*e.pixelRatio;n&&(s=Object(l.d)(s,a,t,n));const o=s*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return Object(r.e)(o*t,i.minWorldLength||0,null!=i.maxWorldLength?i.maxWorldLength:1/0)}function S(e,t,i){if(!e)return;const r=e.parameters,a=e.paddingPixelsOverride;t.setUniform4f(i,r.divisor,r.offset,r.minPixelSize,a)}function T(e,t){const i=t?T(t):{};for(const r in e){let t=e[r];t&&t.forEach&&(t=A(t)),null==t&&r in i||(i[r]=t)}return i}function C(e,t){let i=!1;for(const r in t){const a=t[r];void 0!==a&&(i=!0,Array.isArray(a)?e[r]=a.slice():e[r]=a)}return i}function E(e,t,i,a,n,s){if(!t.options.selectionMode)return;const o=e.vertexAttributes.get(h.a.POSITION).data,c=e.vertexAttributes.get(h.a.SIZE),l=c&&c.data[0],d=a[0],u=a[1],p=((l+n)/2+4)*e.screenToWorldRatio;let f=Number.MAX_VALUE,b=0;for(let h=0;h<o.length-5;h+=3){const e=o[h],t=o[h+1],i=d-e,a=u-t,n=o[h+3]-e,s=o[h+4]-t,c=Object(r.e)((n*i+s*a)/(n*n+s*s),0,1),l=n*c-i,p=s*c-a,m=l*l+p*p;m<f&&(f=m,b=h/3)}f<p*p&&s(i.dist,i.normal,b,!1)}function A(e){const t=[];return e.forEach((e=>t.push(e))),t}const w={multiply:1,ignore:2,replace:3,tint:4},R=1e3},436:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return n}));var r=i(116);function a(e,t,i=0){const a=Object(r.e)(e,0,c);for(let r=0;r<4;r++)t[i+r]=Math.floor(256*l(a*s[r]))}function n(e,t=0){let i=0;for(let r=0;r<4;r++)i+=e[t+r]*o[r];return i}const s=[1,256,65536,16777216],o=[1/256,1/65536,1/16777216,1/4294967296],c=n(new Uint8ClampedArray([255,255,255,255]));function l(e){return e-Math.floor(e)}},445:function(e,t,i){"use strict";i.d(t,"a",(function(){return u})),i.d(t,"b",(function(){return h})),i.d(t,"c",(function(){return c})),i.d(t,"d",(function(){return s})),i.d(t,"e",(function(){return p})),i.d(t,"f",(function(){return l})),i.d(t,"g",(function(){return f})),i.d(t,"h",(function(){return d}));var r=i(163),a=i(94),n=i(355);const s=Object(n.g)(a.b.SRC_ALPHA,a.b.ONE,a.b.ONE_MINUS_SRC_ALPHA,a.b.ONE_MINUS_SRC_ALPHA),o=Object(n.h)(a.b.ONE,a.b.ONE),c=Object(n.h)(a.b.ZERO,a.b.ONE_MINUS_SRC_ALPHA);function l(e){return e===r.i.FrontFace?null:e===r.i.Alpha?c:o}function d(e){return e===r.i.FrontFace?n.d:null}const h=5e5,u={factor:-1,units:-2};function p(e){return e?u:null}function f(e,t=a.h.LESS){return e===r.i.NONE||e===r.i.FrontFace?t:a.h.LEQUAL}},446:function(e,t,i){"use strict";function r(){return new Float32Array(3)}function a(e){const t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function n(e,t,i){const r=new Float32Array(3);return r[0]=e,r[1]=t,r[2]=i,r}function s(){return r()}function o(){return n(1,1,1)}function c(){return n(1,0,0)}function l(){return n(0,1,0)}function d(){return n(0,0,1)}i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return r})),i.d(t,"c",(function(){return n}));const h=s(),u=o(),p=c(),f=l(),b=d();Object.freeze({__proto__:null,create:r,clone:a,fromValues:n,createView:function(e,t){return new Float32Array(e,t,3)},zeros:s,ones:o,unitX:c,unitY:l,unitZ:d,ZEROS:h,ONES:u,UNIT_X:p,UNIT_Y:f,UNIT_Z:b})},463:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return h})),i.d(t,"d",(function(){return u})),i.d(t,"e",(function(){return p})),i.d(t,"f",(function(){return o})),i.d(t,"g",(function(){return l})),i.d(t,"h",(function(){return d}));i(409),i(82);var r=i(85),a=(i(549),i(244),i(96),i(223)),n=i(118);i(328),i(205),i(154),i(488);class s{constructor(e,t,i){this.uid=e,this.geometry=t,this.attributes=i,this.visible=!0,this.objectId=null,this.centroid=null}}function o(e){return Object(r.k)(e.geometry)}class c{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}}function l(e,t,i,r){return{x:e,y:t,z:i,hasZ:null!=i,hasM:!1,spatialReference:r,type:"point"}}function d(e){if(Object(r.j)(e))return 0;switch(e.type){case"point":return 1;case"polyline":{let t=0;for(const i of e.paths)t+=i.length;return t}case"polygon":{let t=0;for(const i of e.rings)t+=i.length;return t}case"multipoint":return e.points.length;case"extent":return 2;case"mesh":{const t=e.vertexAttributes&&e.vertexAttributes.position;return t?t.length/3:0}default:return}}function h(e,t){switch(Object(a.h)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(let i=0;i<e.paths.length;i++)Object(a.l)(t,e.paths[i],e.hasZ);break;case"polygon":for(let i=0;i<e.rings.length;i++)Object(a.l)(t,e.rings[i],e.hasZ);break;case"multipoint":Object(a.l)(t,e.points,e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,null!=e.zmin&&(t[2]=e.zmin),null!=e.zmax&&(t[5]=e.zmax)}}function u(e,t){switch(Object(n.m)(t),"mesh"===e.type&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(let i=0;i<e.paths.length;i++)Object(n.p)(t,e.paths[i]);break;case"polygon":for(let i=0;i<e.rings.length;i++)Object(n.p)(t,e.rings[i]);break;case"multipoint":Object(n.p)(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}}function p(e,t){return null!=e.objectId?e.objectId:e.attributes&&t?e.attributes[t]:null}Object(a.f)(),Object(n.l)()},464:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(126);function a(e){e.code.add(r.a`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}},478:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(126);function a(e,t){const i={hasModelTransformation:!1,...t};if(i.hasModelTransformation)return i.linearDepth?void e.vertex.code.add(r.a`vec4 transformPositionWithDepth(mat4 proj, mat4 view, mat4 model, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * (model * vec4(pos, 1.0));
depth = (-eye.z - nearFar[0]) / (nearFar[1] - nearFar[0]) ;
return proj * eye;
}`):void e.vertex.code.add(r.a`vec4 transformPosition(mat4 proj, mat4 view, mat4 model, vec3 pos) {
return proj * (view * (model * vec4(pos, 1.0)));
}`);i.linearDepth?e.vertex.code.add(r.a`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = (-eye.z - nearFar[0]) / (nearFar[1] - nearFar[0]) ;
return proj * eye;
}`):e.vertex.code.add(r.a`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}},487:function(e,t,i){"use strict";function r(e){return e=e||globalThis.location.hostname,l.some((t=>{var i;return null!=(null==(i=e)?void 0:i.match(t))}))}function a(e,t){return e&&(t=t||globalThis.location.hostname)?null!=t.match(n)||null!=t.match(o)?e.replace("static.arcgis.com","staticdev.arcgis.com"):null!=t.match(s)||null!=t.match(c)?e.replace("static.arcgis.com","staticqa.arcgis.com"):e:e}i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return r}));const n=/^devext.arcgis.com$/,s=/^qaext.arcgis.com$/,o=/^[\w-]*\.mapsdevext.arcgis.com$/,c=/^[\w-]*\.mapsqa.arcgis.com$/,l=[/^([\w-]*\.)?[\w-]*\.zrh-dev-local.esri.com$/,n,s,/^jsapps.esri.com$/,o,c]},488:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));i(82),i(85);function r(e,t){return!!a(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function a(e,t){return e===t||e&&t&&e.equals(t)}},489:function(e,t,i){"use strict";i.d(t,"a",(function(){return f}));var r=i(79),a=i(100),n=i(138),s=i(134),o=i(159),c=i(87),l=i(85),d=i(280),h=i(81),u=(i(84),i(82),i(83),i(80));let p=class extends(Object(s.b)(Object(o.a)(Object(d.b)(n.a.EventedMixin(a.a))))){constructor(e){super(e),this.layer=null,this.parent=null}initialize(){this.when().catch((e=>{if("layerview:create-error"!==e.name){const t=this.layer&&this.layer.id||"no id",i=this.layer&&this.layer.title||"no title";throw c.a.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${i}', id: '${t}')`,e),e}}))}get fullOpacity(){return Object(l.t)(this.get("layer.opacity"),1)*Object(l.t)(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer.legendEnabled}get updating(){var e;return!!(null!=(e=this.updatingHandles)&&e.updating||this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){var e;return!0===(null==(e=this.layer)?void 0:e.visible)}set visible(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")}canResume(){var e,t,i;return this.visible&&(null==(e=this.layer)?void 0:e.loaded)&&!(null!=(t=this.parent)&&t.suspended)&&(null==(i=this.view)?void 0:i.ready)||!1}getSuspendInfo(){const e=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(e.viewNotReady=!0),this.layer&&this.layer.loaded||(e.layerNotLoaded=!0),this.visible||(e.layerInvisible=!0),e}isUpdating(){return!1}};Object(r.a)([Object(h.b)()],p.prototype,"fullOpacity",null),Object(r.a)([Object(h.b)()],p.prototype,"layer",void 0),Object(r.a)([Object(h.b)()],p.prototype,"parent",void 0),Object(r.a)([Object(h.b)({readOnly:!0})],p.prototype,"suspended",null),Object(r.a)([Object(h.b)({readOnly:!0})],p.prototype,"suspendInfo",null),Object(r.a)([Object(h.b)({readOnly:!0})],p.prototype,"legendEnabled",null),Object(r.a)([Object(h.b)({type:Boolean,readOnly:!0})],p.prototype,"updating",null),Object(r.a)([Object(h.b)({readOnly:!0})],p.prototype,"updatingProgress",null),Object(r.a)([Object(h.b)()],p.prototype,"visible",null),Object(r.a)([Object(h.b)()],p.prototype,"view",void 0),p=Object(r.a)([Object(u.a)("esri.views.layers.LayerView")],p);const f=p},494:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(88),a=i(87),n=i(328);function s(e,t,i,r,n){const s=e.referencesGeometry()&&n?c(t,r,n):t,o=e.repurposeFeature(s);try{return e.evaluate({...i,$feature:o})}catch(l){return a.a.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",l),null}}const o=new Map;function c(e,t,i){const{transform:s,hasZ:c,hasM:l}=i;o.has(t)||o.set(t,function(e){const t={};switch(e){case"esriGeometryPoint":return(e,i,r,a)=>Object(n.e)(i,t,e,r,a);case"esriGeometryPolygon":return(e,i,r,a)=>Object(n.f)(i,t,e,r,a);case"esriGeometryPolyline":return(e,i,r,a)=>Object(n.g)(i,t,e,r,a);case"esriGeometryMultipoint":return(e,i,r,a)=>Object(n.d)(i,t,e,r,a);default:return a.a.getLogger("esri.views.2d.support.arcadeOnDemand").error(new r.a("mapview-arcade",`Unable to handle geometryType: ${e}`)),e=>e}}(t));const d=o.get(t)(e.geometry,s,c,l);return{...e,geometry:d}}},495:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i(421),a=i(743);class n{constructor(e,t){this.layout=e,this.buffer="number"==typeof t?new ArrayBuffer(t*e.stride):t;for(const i of e.fieldNames){const t=e.fields.get(i);this[i]=new t.constructor(this.buffer,t.offset,this.stride)}}get stride(){return this.layout.stride}get count(){return this.buffer.byteLength/this.stride}get byteLength(){return this.buffer.byteLength}getField(e,t){const i=this[e];return i&&i.elementCount===t.ElementCount&&i.elementType===t.ElementType?i:null}slice(e,t){return new n(this.layout,this.buffer.slice(e*this.stride,t*this.stride))}copyFrom(e,t,i,r){const a=this.stride;if(a%4==0){const n=new Uint32Array(e.buffer,t*a,r*a/4);new Uint32Array(this.buffer,i*a,r*a/4).set(n)}else{const n=new Uint8Array(e.buffer,t*a,r*a);new Uint8Array(this.buffer,i*a,r*a).set(n)}}}class s{constructor(){this.stride=0,this.fields=new Map,this.fieldNames=[]}vec2f(e,t){return this._appendField(e,r.m,t),this}vec2f64(e,t){return this._appendField(e,r.n,t),this}vec3f(e,t){return this._appendField(e,r.u,t),this}vec3f64(e,t){return this._appendField(e,r.v,t),this}vec4f(e,t){return this._appendField(e,r.C,t),this}vec4f64(e,t){return this._appendField(e,r.D,t),this}mat3f(e,t){return this._appendField(e,r.f,t),this}mat3f64(e,t){return this._appendField(e,r.g,t),this}mat4f(e,t){return this._appendField(e,r.h,t),this}mat4f64(e,t){return this._appendField(e,r.i,t),this}vec4u8(e,t){return this._appendField(e,r.J,t),this}f32(e,t){return this._appendField(e,r.a,t),this}f64(e,t){return this._appendField(e,r.b,t),this}u8(e,t){return this._appendField(e,r.l,t),this}u16(e,t){return this._appendField(e,r.j,t),this}i8(e,t){return this._appendField(e,r.e,t),this}vec2i8(e,t){return this._appendField(e,r.q,t),this}vec2i16(e,t){return this._appendField(e,r.o,t),this}vec2u8(e,t){return this._appendField(e,r.t,t),this}vec4u16(e,t){return this._appendField(e,r.H,t),this}u32(e,t){return this._appendField(e,r.k,t),this}_appendField(e,t,i){const r=t.ElementCount*Object(a.a)(t.ElementType),n=this.stride;this.fields.set(e,{size:r,constructor:t,offset:n,optional:i}),this.stride+=r,this.fieldNames.push(e)}alignTo(e){return this.stride=Math.floor((this.stride+e-1)/e)*e,this}hasField(e){return this.fieldNames.indexOf(e)>=0}createBuffer(e){return new n(this,e)}createView(e){return new n(this,e)}clone(){const e=new s;return e.stride=this.stride,e.fields=new Map,this.fields.forEach(((t,i)=>e.fields.set(i,t))),e.fieldNames=this.fieldNames.slice(),e.BufferType=this.BufferType,e}}function o(){return new s}},498:function(e,t,i){"use strict";i.d(t,"a",(function(){return O})),i.d(t,"b",(function(){return g})),i.d(t,"c",(function(){return m})),i.d(t,"d",(function(){return j})),i.d(t,"e",(function(){return _})),i.d(t,"f",(function(){return T})),i.d(t,"g",(function(){return M})),i.d(t,"h",(function(){return v}));i(82);var r=i(87),a=i(116),n=i(85),s=i(147),o=i(117),c=i(109),l=i(271),d=i(257),h=i(584),u=i(360),p=i(526),f=i(288);const b=r.a.getLogger("esri.geometry.support.sphere");function m(){return Object(d.e)()}function g(e,t=m()){return Object(l.c)(t,e)}function v(e){return e}function O(e){e[0]=e[1]=e[2]=e[3]=0}function y(e){return Array.isArray(e)?e[3]:e}function _(e){return Array.isArray(e)?e:I}function j(e,t,i,r){return Object(d.g)(e,t,i,r)}function x(e,t,i){if(Object(n.j)(t))return!1;const{origin:r,direction:a}=t,s=S;s[0]=r[0]-e[0],s[1]=r[1]-e[1],s[2]=r[2]-e[2];const o=a[0]*a[0]+a[1]*a[1]+a[2]*a[2],c=2*(a[0]*s[0]+a[1]*s[1]+a[2]*s[2]),l=c*c-4*o*(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]-e[3]*e[3]);if(l<0)return!1;const d=Math.sqrt(l);let h=(-c-d)/(2*o);const u=(-c+d)/(2*o);return(h<0||u<h&&u>0)&&(h=u),!(h<0)&&(i&&(i[0]=r[0]+a[0]*h,i[1]=r[1]+a[1]*h,i[2]=r[2]+a[2]*h),!0)}const S=Object(c.f)();function T(e,t){return x(e,t,null)}function C(e,t,i){const r=f.d.get(),a=f.a.get();Object(o.g)(r,t.origin,t.direction);const n=y(e);Object(o.g)(i,r,t.origin),Object(o.e)(i,i,1/Object(o.p)(i)*n);const c=A(e,t.origin),l=Object(p.a)(t.origin,i);return Object(s.d)(a,l+c,r),Object(o.q)(i,i,a),i}function E(e,t,i){const r=Object(o.j)(f.d.get(),t,_(e)),a=Object(o.e)(f.d.get(),r,e[3]/Object(o.p)(r));return Object(o.f)(i,a,_(e))}function A(e,t){const i=Object(o.j)(f.d.get(),t,_(e)),r=Object(o.p)(i),n=y(e),s=n+Math.abs(n-r);return Object(a.b)(n/s)}const w=Object(c.f)();function R(e,t,i,r){const n=Object(o.j)(w,t,_(e));switch(i){case h.a.X:{const e=Object(a.d)(n,w)[2];return Object(o.w)(r,-Math.sin(e),Math.cos(e),0)}case h.a.Y:{const e=Object(a.d)(n,w),t=e[1],i=e[2],s=Math.sin(t);return Object(o.w)(r,-s*Math.cos(i),-s*Math.sin(i),Math.cos(t))}case h.a.Z:return Object(o.r)(r,n);default:return}}function P(e,t){const i=Object(o.j)(D,t,_(e));return Object(o.p)(i)-e[3]}const I=Object(c.f)(),D=Object(c.f)(),M=Object.freeze({__proto__:null,create:m,copy:g,fromCenterAndRadius:function(e,t){return Object(d.g)(e[0],e[1],e[2],t)},wrap:v,clear:O,fromRadius:function(e){return e},getRadius:y,getCenter:_,fromValues:j,elevate:function(e,t,i){return e!==i&&Object(o.k)(i,e),i[3]=e[3]+t,i},setExtent:function(e,t,i){return b.error("sphere.setExtent is not yet supported"),e===i?i:g(e,i)},intersectRay:x,intersectsRay:T,intersectRayClosestSilhouette:function(e,t,i){if(x(e,t,i))return i;const r=C(e,t,f.d.get());return Object(o.f)(i,t.origin,Object(o.e)(f.d.get(),t.direction,Object(o.m)(t.origin,r)/Object(o.p)(t.direction))),i},closestPointOnSilhouette:C,closestPoint:function(e,t,i){return x(e,t,i)?i:(Object(u.a)(t,_(e),i),E(e,i,i))},projectPoint:E,distanceToSilhouette:function(e,t){const i=Object(o.j)(f.d.get(),t,_(e)),r=Object(o.t)(i),a=e[3]*e[3];return Math.sqrt(Math.abs(r-a))},angleToSilhouette:A,axisAt:R,altitudeAt:P,setAltitudeAt:function(e,t,i,r){const a=P(e,t),n=R(e,t,h.a.Z,D),s=Object(o.e)(D,n,i-a);return Object(o.f)(r,t,s)}})},500:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(126);function a(e){e.code.add(r.a`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}
const vec4 RGBA_2_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, RGBA_2_FLOAT_FACTORS);
}`)}},501:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return c})),i.d(t,"d",(function(){return o})),i.d(t,"e",(function(){return l}));var r=i(147),a=i(920);function n(e,t,i){e.setUniform3f("cameraPosition",i[3]-t[0],i[7]-t[1],i[11]-t[2])}function s(e,t){e.setUniformMatrix4fv("proj",t)}function o(e,t,i){Object(r.j)(d,i,t),e.setUniform3fv("localOrigin",t),e.setUniformMatrix4fv("view",d)}function c(e,t){o(e,t.origin,t.camera.viewMatrix)}function l(e,t){e.setUniform4fv("viewport",t.camera.fullViewport)}const d=Object(a.a)()},502:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return l}));var r=i(446),a=i(913),n=i(126);Object(r.c)(0,.6,.2);var s,o;function c(e,t){const i=e.fragment,r=t.hasMetalnessAndRoughnessTexture||t.hasEmissionTexture||t.hasOcclusionTexture;t.pbrMode===s.Normal&&r&&e.include(a.a,t),t.pbrMode!==s.Schematic?(t.pbrMode===s.Disabled&&i.code.add(n.a`float getBakedOcclusion() { return 1.0; }`),t.pbrMode===s.Normal&&(i.uniforms.add("emissionFactor","vec3"),i.uniforms.add("mrrFactors","vec3"),i.code.add(n.a`vec3 mrr;
vec3 emission;
float occlusion;`),t.hasMetalnessAndRoughnessTexture&&(i.uniforms.add("texMetallicRoughness","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texMetallicRoughnessSize","vec2"),i.code.add(n.a`void applyMetallnessAndRoughness(TextureLookupParameter params) {
vec3 metallicRoughness = textureLookup(texMetallicRoughness, params).rgb;
mrr[0] *= metallicRoughness.b;
mrr[1] *= metallicRoughness.g;
}`)),t.hasEmissionTexture&&(i.uniforms.add("texEmission","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texEmissionSize","vec2"),i.code.add(n.a`void applyEmission(TextureLookupParameter params) {
emission *= textureLookup(texEmission, params).rgb;
}`)),t.hasOcclusionTexture?(i.uniforms.add("texOcclusion","sampler2D"),t.supportsTextureAtlas&&i.uniforms.add("texOcclusionSize","vec2"),i.code.add(n.a`void applyOcclusion(TextureLookupParameter params) {
occlusion *= textureLookup(texOcclusion, params).r;
}
float getBakedOcclusion() {
return occlusion;
}`)):i.code.add(n.a`float getBakedOcclusion() { return 1.0; }`),i.code.add(n.a`
    void applyPBRFactors() {
      mrr = mrrFactors;
      emission = emissionFactor;
      occlusion = 1.0;
      ${r?"vtc.uv = vuv0;":""}
      ${t.hasMetalnessAndRoughnessTexture?t.supportsTextureAtlas?"vtc.size = texMetallicRoughnessSize; applyMetallnessAndRoughness(vtc);":"applyMetallnessAndRoughness(vtc);":""}
      ${t.hasEmissionTexture?t.supportsTextureAtlas?"vtc.size = texEmissionSize; applyEmission(vtc);":"applyEmission(vtc);":""}
      ${t.hasOcclusionTexture?t.supportsTextureAtlas?"vtc.size = texOcclusionSize; applyOcclusion(vtc);":"applyOcclusion(vtc);":""}
    }
  `))):i.code.add(n.a`const vec3 mrr = vec3(0.0, 0.6, 0.2);
const vec3 emission = vec3(0.0);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`)}function l(e,t,i=!1){i||(e.setUniform3fv("mrrFactors",t.mrrFactors),e.setUniform3fv("emissionFactor",t.emissiveFactor))}(o=s||(s={}))[o.Disabled=0]="Disabled",o[o.Normal=1]="Normal",o[o.Schematic=2]="Schematic",o[o.Water=3]="Water",o[o.WaterOnIntegratedMesh=4]="WaterOnIntegratedMesh",o[o.COUNT=5]="COUNT"},513:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return h})),i.d(t,"c",(function(){return u})),i.d(t,"d",(function(){return d})),i.d(t,"e",(function(){return l}));var r=i(85),a=i(147),n=i(200),s=i(278),o=i(725);function c(e,t){return Object(r.j)(e)&&(e=[]),e.push(t),e}function l(e,t){if(Object(r.j)(e))return null;const i=e.filter((e=>e!==t));return 0===i.length?null:i}function d(e){return!!Object(r.k)(e)&&!e.visible}function h(e,t,i){const n=e.origin.vec3;Object(s.i)(b,-n[0],-n[1],-n[2]),Object(r.k)(e.transformation)?Object(a.m)(t,b,e.transformation):Object(a.c)(t,b),i&&(Object(a.a)(i,t),Object(a.t)(i,i))}function u(e,t,i,r,a){p[0]=e.get(t,0),p[1]=e.get(t,1),p[2]=e.get(t,2),Object(o.a)(p,f,3),i.set(a,0,f[0]),r.set(a,0,f[1]),i.set(a,1,f[2]),r.set(a,1,f[3]),i.set(a,2,f[4]),r.set(a,2,f[5])}const p=new Float64Array(3),f=new Float32Array(6),b=Object(n.d)()},514:function(e,t,i){"use strict";i.d(t,"a",(function(){return I})),i.d(t,"b",(function(){return O})),i.d(t,"c",(function(){return P}));var r=i(79),a=i(100),n=i(124),s=i(87),o=i(85),c=i(481),l=i(212),d=i(91),h=i(144),u=i(448),p=i(81),f=(i(84),i(82),i(83),i(80));let b=class extends a.a{constructor(){super(...arguments),this._tasks=new Array,this.running=!1}get length(){return this._tasks.length}destroy(){this.cancelAll()}runTask(e){for(;!e.done&&this._process(e);)e.madeProgress()}push(e,t,i){return this.running=!0,new Promise(((r,a)=>this._tasks.push(new m(r,a,e,t,i))))}unshift(e,t,i){return this.running=!0,new Promise(((r,a)=>this._tasks.unshift(new m(r,a,e,t,i))))}_process(e){if(0===this._tasks.length)return!1;const t=this._tasks.shift();try{const i=Object(d.m)(t.signal);if(i&&!t.abortCallback)t.reject(Object(d.d)());else{const r=i?t.abortCallback(Object(d.d)()):t.callback(e);Object(d.n)(r)?r.then(t.resolve,t.reject):t.resolve(r)}}catch(i){t.reject(i)}return this.running=this._tasks.length>0,!0}cancelAll(){const e=Object(d.d)();for(const t of this._tasks)if(t.abortCallback){const i=t.abortCallback(e);t.resolve(i)}else t.reject(e);this._tasks.length=0,this.running=!1}};Object(r.a)([Object(p.b)()],b.prototype,"running",void 0),b=Object(r.a)([Object(f.a)("esri.layers.support.PromiseQueue")],b);class m{constructor(e,t,i,r,a){this.resolve=e,this.reject=t,this.callback=i,this.signal=r,this.abortCallback=a}}var g=i(633);const v=s.a.getLogger("esri.views.support.Scheduler");var O,y;(y=O||(O={})).RESOURCE_CONTROLLER="schedule",y.SLIDE="slide",y.STREAM_DATA_LOADER="stream loader",y.ELEVATION_QUERY="elevation query",y.TERRAIN_SURFACE="terrain",y.SURFACE_GEOMETRY_UPDATES="surface geometry updates",y.GRAPHICS_CORE="Graphics3D",y.I3S_CONTROLLER="I3S",y.POINT_CLOUD_LAYER="point cloud",y.FEATURE_TILE_FETCHER="feature fetcher",y.OVERLAY="overlay",y.STAGE="stage",y.GRAPHICS_DECONFLICTOR="graphics deconflictor",y.FILTER_VISIBILITY="Graphics3D filter visibility",y.SCALE_VISIBILITY="Graphics3D scale visibility",y.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",y.POINT_OF_INTEREST_FREQUENT="POI frequent",y.POINT_OF_INTEREST_INFREQUENT="POI infrequent",y.LABELER="labeler",y.FEATURE_QUERY_ENGINE="feature query",y.FEATURE_TILE_TREE="feature tile tree",y.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",y.ELEVATION_ALIGNMENT="elevation alignment",y.TEXT_TEXTURE_ATLAS="text texture atlas",y.TEXTURE_UNLOAD="texture unload",y.LINE_OF_SIGHT_TOOL="line of sight tool",y.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",y.ELEVATION_PROFILE="elevation profile",y.SNAPPING="snapping",y.SHADOW_ACCUMULATOR="shadow accumulator",y.CLOUDS_GENERATOR="cloud generator",y[y.TEST_PRIO=1]="TEST_PRIO";const _=new Map([[O.RESOURCE_CONTROLLER,0],[O.SLIDE,0],[O.STREAM_DATA_LOADER,0],[O.ELEVATION_QUERY,0],[O.TERRAIN_SURFACE,1],[O.SURFACE_GEOMETRY_UPDATES,1],[O.GRAPHICS_CORE,2],[O.I3S_CONTROLLER,2],[O.POINT_CLOUD_LAYER,2],[O.FEATURE_TILE_FETCHER,2],[O.OVERLAY,4],[O.STAGE,4],[O.GRAPHICS_DECONFLICTOR,4],[O.FILTER_VISIBILITY,4],[O.SCALE_VISIBILITY,4],[O.FRUSTUM_VISIBILITY,4],[O.POINT_OF_INTEREST_FREQUENT,6],[O.POINT_OF_INTEREST_INFREQUENT,30],[O.LABELER,8],[O.FEATURE_QUERY_ENGINE,8],[O.FEATURE_TILE_TREE,16],[O.FEATURE_TILE_TREE_ACTIVE,0],[O.ELEVATION_ALIGNMENT,12],[O.TEXT_TEXTURE_ATLAS,12],[O.CLOUDS_GENERATOR,12],[O.TEXTURE_UNLOAD,12],[O.LINE_OF_SIGHT_TOOL,16],[O.LINE_OF_SIGHT_TOOL_INTERACTIVE,0],[O.SNAPPING,0],[O.SHADOW_ACCUMULATOR,30]]);function j(e){return _.has(e)?_.get(e):"number"==typeof e?e:1}var x;!function(e){e[e.ANIMATING=0]="ANIMATING",e[e.INTERACTING=1]="INTERACTING",e[e.IDLE=2]="IDLE"}(x||(x={}));const S=Object(u.a)(6.5),T=Object(u.a)(1),C=Object(u.a)(30),E=Object(u.a)(1e3/30),A=Object(u.a)(100);var w,R;!function(e){let t=class extends a.a{constructor(e){super(e),this.updating=!0,this._microTaskQueued=!1,this.performanceInfo={total:new c.a("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=null,this._state=x.INTERACTING,this._tasks=new l.a,this._runQueue=new l.a,this._load=0,this._idleStateCallbacks=new l.a,this._idleUpdatesStartFired=!1,this._maxReschedule=D,this._forceTask=!1,this._debug=!1,this._debugHandle=Object(h.e)((()=>g.a.SCHEDULER_LOG_SLOW_TASKS),(e=>this._debug=e),h.a),this._budget=new s(e.nowFunc);for(const r of Object.keys(O))this.performanceInfo.tasks.set(O[r],new c.a(O[r]));let t;const i=this;this._test={get state(){return Object(o.t)(t,i._state)},set state(e){t=e},FRAME_SAFETY_BUDGET:S,INTERACTING_BUDGET:E,IDLE_BUDGET:A,get budget(){return i._budget.budget},usedBudget:0,setBudget:e=>i._budget=e,updateTask:e=>this._updateTask(e),getState:e=>this._getState(e),getRuntime:e=>this._getRuntime(e),frameTaskTimes:this._frameTaskTimes,resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}destroy(){this._tasks.toArray().forEach((e=>e.remove())),this._tasks.clear(),Object(o.r)(this._debugHandle),this._microTaskQueued=!1,this.updating=!1}activate(){this._budget.done||this._microTaskQueued||(this._microTaskQueued=!0,queueMicrotask((()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.done||(this._maxReschedule=D,this._schedule(),this.frame()))})))}registerTask(e,t){const r=j(e),a=new i(this,e,t,r);return this._tasks.push(a),this.performanceInfo.tasks.has(e)||this.performanceInfo.tasks.set(e,new c.a(e)),a}registerIdleStateCallbacks(e,t){const i={idleBegin:e,idleEnd:t};this._idleStateCallbacks.push(i),this.state===x.IDLE&&this._idleUpdatesStartFired&&i.idleBegin();const r=this;return{remove:()=>this._removeIdleStateCallbacks(i),set idleBegin(e){r._idleUpdatesStartFired&&(i.idleEnd(),r._state===x.IDLE&&e()),i.idleBegin=e},set idleEnd(e){i.idleEnd=e}}}get now(){return this.nowFunc()}get load(){return this._load}set state(e){this._state!==e&&(this._state=e,this.state!==x.IDLE&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll((e=>e.idleEnd()))))}get state(){return Object(o.j)(this._test.state)?this._state:this._test.state}updateBudget(e){this._test.usedBudget=0;let t=S,i=e.frameDuration,r=T;switch(this.state){case x.IDLE:t=Object(u.a)(0),i=Object(u.a)(Math.max(A,e.frameDuration)),r=C;break;case x.INTERACTING:i=Object(u.a)(Math.max(E,e.frameDuration));case x.ANIMATING:}return i=Object(u.a)(i-e.elapsedFrameTime-t),this.state!==x.IDLE&&i<T&&!this._forceTask?(this._forceTask=!0,!1):(i=Object(u.a)(Math.max(i,r)),this._budget.reset(i,this.state),this._maxReschedule=D,this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case x.IDLE:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll((e=>e.idleBegin()))),this._runIdle();break;case x.INTERACTING:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed}stopFrame(){this._budget.reset(Object(u.a)(0),this._state),this._budget.madeProgress()}_removeIdleStateCallbacks(e){this._idleUpdatesStartFired&&e.idleEnd(),this._idleStateCallbacks.removeUnordered(e)}removeTask(e){this._tasks.removeUnordered(e),this._runQueue.removeUnordered(e)}_updateTask(e){this._tasks.forAll((t=>{t.name===e&&t.setPriority(e)}))}_getState(e){if(this._runQueue.some((t=>t.name===e)))return R.SCHEDULED;let t=R.IDLE;return this._tasks.forAll((i=>{i.name===e&&i.needsUpdate&&(i.schedulePriority<=1?t=R.READY:t!==R.READY&&(t=R.WAITING))})),t}_getRuntime(e){let t=0;return this._tasks.forAll((i=>{i.name===e&&(t+=i.runtime)})),t}_resetRuntimes(){this._tasks.forAll((e=>e.runtime=0))}_getRunning(){const e=new Map;if(this._tasks.forAll((t=>{t.needsUpdate&&e.set(t.name,(e.get(t.name)||0)+1)})),0===e.size)return null;let t="";return e.forEach(((e,i)=>{t+=e>1?` ${e}x ${i}`:` ${i}`})),t}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const e=this._tasks.reduce(((e,t)=>t.needsUpdate?++e:e),0);this._load=.9*this._load+e*(1-.9)}_schedule(){if(this._maxReschedule<=0)return!1;for(this._runQueue.filterInPlace((e=>!!e.needsUpdate||(e.schedulePriority=e.basePriority,!1))),this._tasks.forAll((e=>{0===e.basePriority&&e.needsUpdate&&!this._runQueue.some((t=>t===e))&&this._runQueue.unshift(e)}));0===this._runQueue.length;){let e=!1,t=0;if(this._tasks.forAll((i=>{i.needsUpdate&&0!==i.schedulePriority&&0!==i.basePriority&&(e=!0,t=Math.max(t,i.basePriority),1===i.schedulePriority?(i.schedulePriority=0,this._runQueue.push(i)):--i.schedulePriority)})),!e)return this.updating=!1,!1;this._maxReschedule===D&&(this._maxReschedule=t),--this._maxReschedule}return this.updating=!0,!0}_run(){const e=this._budget.now();this._startFrameTaskTimes();do{for(;this._runQueue.length>0;){const i=this._budget.now(),r=this._runQueue.pop();this._budget.resetProgress();try{r.task.runTask(this._budget)}catch(t){v.error(`Exception in task "${r.name}"`,t)}r.schedulePriority=r.basePriority;const a=this._budget.now()-i;if(r.runtime+=a,this._frameTaskTimes.set(r.priority,this._frameTaskTimes.get(r.priority)+a),this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",r.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return this.updating=this._tasks.some((e=>e.needsUpdate)),void this._recordFrameTaskTimes(this._budget.now()-e)}}while(this._schedule());this.updating=this._tasks.some((e=>e.needsUpdate)),this._recordFrameTaskTimes(this._budget.now()-e)}_startFrameTaskTimes(){for(const e of Object.keys(O))this._frameTaskTimes.set(O[e],0)}_recordFrameTaskTimes(e){this._frameTaskTimes.forEach(((e,t)=>this.performanceInfo.tasks.get(t).record(e))),this.performanceInfo.total.record(e)}get test(){return this._test}};Object(r.a)([Object(p.b)()],t.prototype,"updating",void 0),Object(r.a)([Object(p.b)()],t.prototype,"nowFunc",void 0),t=Object(r.a)([Object(f.a)("esri.views.support.Scheduler")],t),e.Scheduler=t;let i=class extends a.a{constructor(e,t,i,r){super({}),this._scheduler=e,this.name=t,this._basePriority=r,this.runtime=0,this._queue=new b,this._handles=new n.a,this.schedulePriority=this._basePriority,this.task=Object(o.k)(i)?i:this._queue,this._handles.add(Object(h.f)((()=>this.task.running),(()=>e.activate())))}get updating(){return this._queue.running}normalizeCtorArgs(){return{}}remove(){this.processQueue(P),this._scheduler.removeTask(this),this.schedule=I.schedule,this.reschedule=I.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(e){this.name=e;const t=j(e);0!==this._basePriority&&0===this.schedulePriority||(this.schedulePriority=t),this._basePriority=t}get priority(){return this.name}set priority(e){this.setPriority(e)}get needsUpdate(){return this.updating||this.task.running}schedule(e,t,i){return this._queue.push(e,t,i)}reschedule(e,t,i){return this._queue.unshift(e,t,i)}processQueue(e){this._queue.runTask(e)}};Object(r.a)([Object(p.b)({constructOnly:!0})],i.prototype,"task",void 0),Object(r.a)([Object(p.b)({readOnly:!0})],i.prototype,"updating",null),i=Object(r.a)([Object(f.a)("esri.views.support.SchedulerTask")],i);class s{constructor(e){this.now=e,this._begin=0,this._budget=0,this._state=x.IDLE,this._didWork=!1,this._enabled=!0}run(e){return!this.done&&(!0===e()&&(this._didWork=!0),!0)}get done(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}get budget(){return this._budget}madeProgress(){this._didWork=!0}get state(){return this._state}get enabled(){return this._enabled}set enabled(e){this._enabled=e}reset(e,t){this._begin=this.now(),this._budget=e,this._state=t,this._didWork=!1}get remaining(){return Math.max(this._budget-this.elapsed,0)}get elapsed(){return this.now()-this._begin}resetProgress(){this._didWork=!1}get hasProgressed(){return this._didWork}}e.Budget=s}(w||(w={})),function(e){e.SCHEDULED="s",e.READY="r",e.WAITING="w",e.IDLE="i"}(R||(R={}));const P=(()=>{const e=new w.Budget((()=>performance.now()));return e.enabled=!1,e})();const I=new class{remove(){}processQueue(){}schedule(e,t,i){try{if(Object(d.m)(t)){const e=Object(d.d)();return i?Promise.resolve(i(e)):Promise.reject(e)}return Object(d.w)(e(P))}catch(r){return Promise.reject(r)}}reschedule(e,t,i){return this.schedule(e,t,i)}},D=Number.MAX_SAFE_INTEGER},526:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return l})),i.d(t,"c",(function(){return s})),i.d(t,"d",(function(){return o}));var r=i(116),a=i(117),n=i(109);function s(e,t,i){const r=Object(a.h)(e,t)/Object(a.h)(e,e);return Object(a.e)(i,e,r)}function o(e,t){return Object(a.h)(e,t)/Object(a.p)(e)}function c(e,t){const i=Object(a.h)(e,t)/(Object(a.p)(e)*Object(a.p)(t));return-Object(r.b)(i)}function l(e,t,i){Object(a.r)(d,e),Object(a.r)(h,t);const n=Object(a.h)(d,h),s=Object(r.b)(n),o=Object(a.g)(d,d,h);return Object(a.h)(o,i)<0?2*Math.PI-s:s}const d=Object(n.f)(),h=Object(n.f)()},544:function(e,t,i){"use strict";var r;i.d(t,"a",(function(){return r})),function(e){e[e.Layer=0]="Layer",e[e.Object=1]="Object",e[e.Geometry=2]="Geometry",e[e.Material=3]="Material",e[e.Texture=4]="Texture",e[e.COUNT=5]="COUNT"}(r||(r={}))},545:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(163);class a{constructor(e){this._material=e.material,this._techniqueRep=e.techniqueRep,this._output=e.output}dispose(){this._techniqueRep.release(this._technique)}get technique(){return this._technique}ensureTechnique(e,t,i=this._output){return this._technique=this._techniqueRep.releaseAndAcquire(e,this._material.getTechniqueConfig(i,t),this._technique),this._technique}ensureResources(e){return r.g.LOADED}}},560:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(244);class a{constructor(){this.id=Object(r.a)()}unload(){}}},567:function(e,t,i){"use strict";var r;i.d(t,"a",(function(){return r})),function(e){e[e.MATERIAL=0]="MATERIAL",e[e.MATERIAL_ALPHA=1]="MATERIAL_ALPHA",e[e.MATERIAL_DEPTH=2]="MATERIAL_DEPTH",e[e.MATERIAL_NORMAL=3]="MATERIAL_NORMAL",e[e.MATERIAL_DEPTH_SHADOWMAP_ALL=4]="MATERIAL_DEPTH_SHADOWMAP_ALL",e[e.MATERIAL_HIGHLIGHT=5]="MATERIAL_HIGHLIGHT",e[e.MATERIAL_DEPTH_SHADOWMAP_DEFAULT=6]="MATERIAL_DEPTH_SHADOWMAP_DEFAULT",e[e.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT=7]="MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT",e[e.MAX_PASS=8]="MAX_PASS"}(r||(r={}))},568:function(e,t,i){"use strict";i.d(t,"a",(function(){return g})),i.d(t,"b",(function(){return C})),i.d(t,"c",(function(){return x})),i.d(t,"d",(function(){return E})),i.d(t,"e",(function(){return y})),i.d(t,"f",(function(){return T})),i.d(t,"g",(function(){return j})),i.d(t,"h",(function(){return _})),i.d(t,"i",(function(){return S}));var r=i(85),a=i(147),n=i(200),s=i(109),o=i(271),c=i(257),l=i(187),d=i(223),h=i(118),u=i(438),p=i(294),f=i(463),b=i(638),m=i(139);function g(e,t){if("point"===e.type)return O(e,t,!1);if(Object(b.d)(e))switch(e.type){case"extent":return O(e.center,t,!1);case"polygon":return O(e.centroid,t,!1);case"polyline":return O(v(e),t,!0);case"mesh":return O(e.origin,t,!1)}else switch(e.type){case"extent":return O(function(e){const t=isFinite(e.zmin);return Object(f.g)(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),t?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}(e),t,!0);case"polygon":return O(function(e){const t=e.rings[0];if(!t||0===t.length)return null;const i=Object(u.c)(e.rings,e.hasZ);return Object(f.g)(i[0],i[1],i[2],e.spatialReference)}(e),t,!0);case"polyline":return O(v(e),t,!0)}}function v(e){const t=e.paths[0];if(!t||0===t.length)return null;const i=Object(p.f)(t,Object(p.e)(t)/2);return Object(f.g)(i[0],i[1],i[2],e.spatialReference)}function O(e,t,i){const r=i?e:Object(b.a)(e);return t&&e?Object(l.n)(e,r,t)?r:null:r}function y(e,t,i,r=0){if(e){t||(t=Object(h.l)());const a=e;let n=.5*a.width*(i-1),s=.5*a.height*(i-1);return a.width<1e-7*a.height?n+=s/20:a.height<1e-7*a.width&&(s+=n/20),Object(o.l)(t,a.xmin-n-r,a.ymin-s-r,a.xmax+n+r,a.ymax+s+r),t}return null}function _(e,t){for(let i=0;i<e.geometries.length;++i){const r=e.geometries[i].getMutableAttribute(m.a.AUXPOS1);r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttrsUpdated(e.geometryRecords[i]))}}function j(e,t){const i=Object(c.d)(c.a);return Object(r.k)(e)&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),Object(r.k)(t)?i[3]=t:Object(r.k)(e)&&e.length>3&&(i[3]=e[3]),i}function x(e=s.a,t,i,a=1){const n=new Array(3);if(Object(r.j)(t)||Object(r.j)(i))n[0]=1,n[1]=1,n[2]=1;else{let r,a=0;for(let s=2;s>=0;s--){const o=e[s];let c;const l=null!=o,d=0===s&&!r&&!l,h=i[s];"symbol-value"===o||d?c=0!==h?t[s]/h:1:l&&"proportional"!==o&&isFinite(o)&&(c=0!==h?o/h:1),null!=c&&(n[s]=c,r=c,a=Math.max(a,Math.abs(c)))}for(let e=2;e>=0;e--)null==n[e]?n[e]=r:0===n[e]&&(n[e]=.001*a)}for(let r=2;r>=0;r--)n[r]/=a;return Object(s.g)(n)}function S(e){return function(e){return null!=e.isPrimitive}(e)&&(e=[e.width,e.depth,e.height]),T(e)?null:"Symbol sizes may not be negative values"}function T(e){if(Array.isArray(e)){for(const t of e)if(!T(t))return!1;return!0}return null==e||e>=0}function C(e,t,i,r=Object(n.d)()){const s=e||0,o=t||0,c=i||0;return 0!==s&&Object(a.g)(r,r,-s/180*Math.PI),0!==o&&Object(a.r)(r,r,o/180*Math.PI),0!==c&&Object(a.o)(r,r,c/180*Math.PI),r}function E(e,t){return null!=t.minDemResolution?t.minDemResolution:Object(d.s)(e)?t.minDemResolutionForPoints:.01*Object(d.t)(e)}},584:function(e,t,i){"use strict";var r;i.d(t,"a",(function(){return r})),function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(r||(r={}))},594:function(e,t,i){"use strict";i.d(t,"a",(function(){return j}));var r,a,n=i(117),s=i(446),o=i(109),c=i(423),l=i(360),d=i(163);(a=r||(r={})).length=function(e,t){const i=e[t],r=e[t+1],a=e[t+2];return Math.sqrt(i*i+r*r+a*a)},a.normalize=function(e,t){const i=e[t],r=e[t+1],a=e[t+2],n=1/Math.sqrt(i*i+r*r+a*a);e[t]*=n,e[t+1]*=n,e[t+2]*=n},a.scale=function(e,t,i){e[t]*=i,e[t+1]*=i,e[t+2]*=i},a.add=function(e,t,i,r,a,n=t){(a=a||e)[n]=e[t]+i[r],a[n+1]=e[t+1]+i[r+1],a[n+2]=e[t+2]+i[r+2]},a.subtract=function(e,t,i,r,a,n=t){(a=a||e)[n]=e[t]-i[r],a[n+1]=e[t+1]-i[r+1],a[n+2]=e[t+2]-i[r+2]};var h=i(595),u=i(562),p=i(278),f=i(139);const b=r;var m,g,v,O;!function(e){const t=.5,i=[[-t,-t,t],[t,-t,t],[t,t,t],[-t,t,t],[-t,-t,-t],[t,-t,-t],[t,t,-t],[-t,t,-t]],r=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],a=[0,0,1,0,1,1,0,1],n=new Uint16Array([0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5]),s=new Uint16Array(36);for(let c=0;c<6;c++)for(let e=0;e<6;e++)s[6*c+e]=c;const o=new Uint16Array(36);for(let c=0;c<6;c++)o[6*c+0]=0,o[6*c+1]=1,o[6*c+2]=2,o[6*c+3]=2,o[6*c+4]=3,o[6*c+5]=0;e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(24);for(let r=0;r<8;r++)t[3*r]=i[r][0]*e[0],t[3*r+1]=i[r][1]*e[1],t[3*r+2]=i[r][2]*e[2];return new h.a([[f.a.POSITION,{size:3,data:t,exclusive:!0}],[f.a.NORMAL,{size:3,data:r}],[f.a.UV0,{size:2,data:a}]],[[f.a.POSITION,n],[f.a.NORMAL,s],[f.a.UV0,o]])}}(m||(m={})),function(e){const t=.5,i=[[-t,0,-t],[t,0,-t],[t,0,t],[-t,0,t],[0,-t,0],[0,t,0]],r=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],a=new Uint16Array([5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0]),n=new Uint16Array([0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7]);e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(18);for(let r=0;r<6;r++)t[3*r]=i[r][0]*e[0],t[3*r+1]=i[r][1]*e[1],t[3*r+2]=i[r][2]*e[2];return new h.a([[f.a.POSITION,{size:3,data:t,exclusive:!0}],[f.a.NORMAL,{size:3,data:r}]],[[f.a.POSITION,a],[f.a.NORMAL,n]])}}(g||(g={})),function(e){const t=.5,i=Object(s.c)(-t,0,-t),r=Object(s.c)(t,0,-t),a=Object(s.c)(0,0,t),o=Object(s.c)(0,.5,0),c=Object(s.b)(),l=Object(s.b)(),d=Object(s.b)(),u=Object(s.b)(),p=Object(s.b)();Object(n.j)(c,i,o),Object(n.j)(l,i,r),Object(n.g)(d,c,l),Object(n.r)(d,d),Object(n.j)(c,r,o),Object(n.j)(l,r,a),Object(n.g)(u,c,l),Object(n.r)(u,u),Object(n.j)(c,a,o),Object(n.j)(l,a,i),Object(n.g)(p,c,l),Object(n.r)(p,p);const b=[i,r,a,o],m=[0,-1,0,d[0],d[1],d[2],u[0],u[1],u[2],p[0],p[1],p[2]],g=[0,1,2,3,1,0,3,2,1,3,0,2],v=[0,0,0,1,1,1,2,2,2,3,3,3];e.createGeometry=function(e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(12);for(let i=0;i<4;i++)t[3*i]=b[i][0]*e[0],t[3*i+1]=b[i][1]*e[1],t[3*i+2]=b[i][2]*e[2];return new h.a([[f.a.POSITION,{size:3,data:t,exclusive:!0}],[f.a.NORMAL,{size:3,data:m}]],[[f.a.POSITION,new Uint16Array(g)],[f.a.NORMAL,new Uint16Array(v)]])}}(v||(v={})),function(e){e.createBoxGeometry=m.createGeometry,e.createDiamondGeometry=g.createGeometry,e.createTetrahedronGeometry=v.createGeometry,e.createSphereGeometry=function(e,t,i,r={uv:!0}){const a=-Math.PI,n=2*Math.PI,s=-Math.PI/2,o=Math.PI,c=Math.max(3,Math.floor(t)),l=Math.max(2,Math.floor(i)),d=(c+1)*(l+1),u=new Float32Array(3*d),p=new Float32Array(3*d),b=new Float32Array(2*d),m=[];let g=0;for(let h=0;h<=l;h++){const t=[],i=h/l,r=s+i*o,d=Math.cos(r);for(let s=0;s<=c;s++){const o=s/c,l=a+o*n,h=Math.cos(l)*d,f=Math.sin(r),m=-Math.sin(l)*d;u[3*g]=h*e,u[3*g+1]=f*e,u[3*g+2]=m*e,p[3*g]=h,p[3*g+1]=f,p[3*g+2]=m,b[2*g]=o,b[2*g+1]=i,t.push(g),++g}m.push(t)}const v=new Uint32Array(2*c*(l-1)*3);g=0;for(let h=0;h<l;h++)for(let e=0;e<c;e++){const t=m[h][e],i=m[h][e+1],r=m[h+1][e+1],a=m[h+1][e];0===h?(v[g++]=t,v[g++]=r,v[g++]=a):h===l-1?(v[g++]=t,v[g++]=i,v[g++]=r):(v[g++]=t,v[g++]=i,v[g++]=r,v[g++]=r,v[g++]=a,v[g++]=t)}const O=[[f.a.POSITION,v],[f.a.NORMAL,v]],y=[[f.a.POSITION,{size:3,data:u,exclusive:!0}],[f.a.NORMAL,{size:3,data:p,exclusive:!0}]];return r.uv&&(y.push([f.a.UV0,{size:2,data:b,exclusive:!0}]),O.push([f.a.UV0,v])),r.offset&&(O[0][0]=f.a.OFFSET,y[0][0]=f.a.OFFSET,O.push([f.a.POSITION,new Uint32Array(v.length)]),y.push([f.a.POSITION,{size:3,data:Float64Array.from(r.offset),exclusive:!0}])),new h.a(y,O)},e.createPolySphereGeometry=function(e,t,i){const r=e;let a,n;if(i)a=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],n=new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1]);else{const e=r*(1+Math.sqrt(5))/2;a=[-r,e,0,r,e,0,-r,-e,0,r,-e,0,0,-r,e,0,r,e,0,-r,-e,0,r,-e,e,0,-r,e,0,r,-e,0,-r,-e,0,r],n=new Uint32Array([0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1])}for(let h=0;h<a.length;h+=3)b.scale(a,h,e/b.length(a,h));let s={};function o(t,i){t>i&&([t,i]=[i,t]);const r=t.toString()+"."+i.toString();if(s[r])return s[r];let n=a.length;return a.length+=3,b.add(a,3*t,a,3*i,a,n),b.scale(a,n,e/b.length(a,n)),n/=3,s[r]=n,n}for(let h=0;h<t;h++){const e=n.length,t=new Uint32Array(4*e);for(let i=0;i<e;i+=3){const e=n[i],r=n[i+1],a=n[i+2],s=o(e,r),c=o(r,a),l=o(a,e),d=4*i;t[d]=e,t[d+1]=s,t[d+2]=l,t[d+3]=r,t[d+4]=c,t[d+5]=s,t[d+6]=a,t[d+7]=l,t[d+8]=c,t[d+9]=s,t[d+10]=c,t[d+11]=l}n=t,s={}}const c=new Float32Array(a);for(let h=0;h<c.length;h+=3)b.normalize(c,h);const l=[[f.a.POSITION,n],[f.a.NORMAL,n]],d=[[f.a.POSITION,{size:3,data:new Float32Array(a),exclusive:!0}],[f.a.NORMAL,{size:3,data:c,exclusive:!0}]];return new h.a(d,l)},e.createPointGeometry=function(e,t,i,r,a,n,s){const o=t?[t[0],t[1],t[2]]:[0,0,0],c=e?[e[0],e[1],e[2]]:[0,0,1];n=n||[0,0];const l=i?[255*i[0],255*i[1],255*i[2],i.length>3?255*i[3]:255]:[255,255,255,255],u=null!=r&&2===r.length?r:[1,1],p=[[f.a.POSITION,{size:3,data:o,exclusive:!0}],[f.a.NORMAL,{size:3,data:c,exclusive:!0}],[f.a.UV0,{size:n.length,data:n}],[f.a.COLOR,{size:4,data:l,exclusive:!0}],[f.a.SIZE,{size:2,data:u}]];if(null!=a){const e=new Float32Array([a[0],a[1],a[2],a[3]]);p.push([f.a.AUXPOS1,{size:4,data:e}])}if(null!=s){const e=new Float32Array([s[0],s[1],s[2],s[3]]);p.push([f.a.AUXPOS2,{size:4,data:e}])}return new h.a(p,null,d.f.Point)},e.updatePointGeometry=function(e,t,i,r,a,n,s,o){if(null!=e){const{data:t}=o.getMutableAttribute(f.a.NORMAL);t[0]=e[0],t[1]=e[1],t[2]=e[2]}if(null!=t){const{data:e}=o.getMutableAttribute(f.a.POSITION);e[0]=t[0],e[1]=t[1],e[2]=t[2]}if(null!=i){const{data:e}=o.getMutableAttribute(f.a.COLOR);e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3]}if(null!=r){const{data:e}=o.getMutableAttribute(f.a.SIZE);e[0]=r[0],e[1]=r[1]}if(null!=a){const{data:e}=o.getMutableAttribute(f.a.AUXPOS1);e[0]=a[0],e[1]=a[1],e[2]=a[2],e[3]=a[3]}if(null!=n){const{data:e}=o.getMutableAttribute(f.a.UV0);e[0]=n[0],e[1]=n[1]}if(null!=s){const{data:e}=o.getMutableAttribute(f.a.AUXPOS2);e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3]}},e.createPointArrayGeometry=function(e,t){const i=new Float32Array(3*e.length),r=new Float32Array(t?3*e.length:3),a=new Uint32Array(e.length),n=new Uint32Array(e.length);for(let c=0;c<e.length;c++)i[3*c]=e[c][0],i[3*c+1]=e[c][1],i[3*c+2]=e[c][2],t&&(r[3*c]=t[c][0],r[3*c+1]=t[c][1],r[3*c+2]=t[c][2]),a[c]=c,n[c]=0;t||(r[0]=0,r[1]=1,r[2]=0);const s=[[f.a.POSITION,a],[f.a.NORMAL,t?a:n],[f.a.UV0,n]],o=[[f.a.POSITION,{size:3,data:i,exclusive:!0}],[f.a.NORMAL,{size:3,data:r,exclusive:!0}],[f.a.UV0,{size:2,data:[0,0],exclusive:!0}]];return new h.a(o,s,d.f.Point)},e.createTriangleGeometry=function(){const e=new Uint16Array([0,1,2]),t=new Uint16Array([0,0,0]),i=new Uint16Array([0,0,0]),r=[[f.a.POSITION,e],[f.a.NORMAL,t],[f.a.UV0,i]],a=[[f.a.POSITION,{size:3,data:[0,0,0,0,0,100,100,0,0],exclusive:!0}],[f.a.NORMAL,{size:3,data:[0,1,0],exclusive:!0}],[f.a.UV0,{size:2,data:[0,0],exclusive:!0}]];return new h.a(a,r)};const t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function i(e,t,i,r,a){return!(Math.abs(Object(n.h)(t,e))>a)&&(Object(n.g)(i,e,t),Object(n.r)(i,i),Object(n.g)(r,i,e),Object(n.r)(r,r),!0)}function r(e,t,r,a,n,s,o){return i(e,t,n,s,o)||i(e,r,n,s,o)||i(e,a,n,s,o)}e.createSquareGeometry=function(e=t){const i=new Array(12);for(let t=0;t<4;t++)for(let r=0;r<3;r++)i[3*t+r]=e[t][r];const r=new Uint32Array([0,1,2,2,3,0]),a=new Uint32Array([0,0,0,0,0,0]),n=[[f.a.POSITION,r],[f.a.NORMAL,a],[f.a.UV0,r],[f.a.COLOR,a]],s=[[f.a.POSITION,{size:3,data:i,exclusive:!0}],[f.a.NORMAL,{size:3,data:[0,0,1],exclusive:!0}],[f.a.UV0,{size:2,data:[0,0,1,0,1,1,0,1],exclusive:!0}],[f.a.COLOR,{size:4,data:[255,255,255,255],exclusive:!0}]];return new h.a(s,n)},e.createConeGeometry=function(e,t,i,r,a=!0,n=!0){let o=0;const c=t,l=e;let d=Object(s.c)(0,o,0),u=Object(s.c)(0,o+l,0),p=Object(s.c)(0,-1,0),b=Object(s.c)(0,1,0);r&&(o=l,u=Object(s.c)(0,0,0),d=Object(s.c)(0,o,0),p=Object(s.c)(0,1,0),b=Object(s.c)(0,-1,0));const m=[u,d],g=[p,b],v=i+2,O=Math.sqrt(l*l+c*c);if(r)for(let h=i-1;h>=0;h--){const e=h*(2*Math.PI/i),t=Object(s.c)(Math.cos(e)*c,o,Math.sin(e)*c);m.push(t);const r=Object(s.c)(l*Math.cos(e)/O,-c/O,l*Math.sin(e)/O);g.push(r)}else for(let h=0;h<i;h++){const e=h*(2*Math.PI/i),t=Object(s.c)(Math.cos(e)*c,o,Math.sin(e)*c);m.push(t);const r=Object(s.c)(l*Math.cos(e)/O,c/O,l*Math.sin(e)/O);g.push(r)}const y=new Uint32Array(2*(i+2)*3),_=new Uint32Array(2*(i+2)*3);let j=0,x=0;if(a){for(let e=3;e<m.length;e++)y[j++]=1,y[j++]=e-1,y[j++]=e,_[x++]=0,_[x++]=0,_[x++]=0;y[j++]=m.length-1,y[j++]=2,y[j++]=1,_[x++]=0,_[x++]=0,_[x++]=0}if(n){for(let e=3;e<m.length;e++)y[j++]=e,y[j++]=e-1,y[j++]=0,_[x++]=e,_[x++]=e-1,_[x++]=1;y[j++]=0,y[j++]=2,y[j++]=m.length-1,_[x++]=1,_[x++]=2,_[x++]=g.length-1}const S=new Float32Array(3*v);for(let s=0;s<v;s++)S[3*s]=m[s][0],S[3*s+1]=m[s][1],S[3*s+2]=m[s][2];const T=new Float32Array(3*v);for(let s=0;s<v;s++)T[3*s]=g[s][0],T[3*s+1]=g[s][1],T[3*s+2]=g[s][2];const C=[[f.a.POSITION,y],[f.a.NORMAL,_]],E=[[f.a.POSITION,{size:3,data:S,exclusive:!0}],[f.a.NORMAL,{size:3,data:T,exclusive:!0}]];return new h.a(E,C)},e.createCylinderGeometry=function(e,t,i,r,a,o){const c=r?Object(s.a)(r):Object(s.c)(1,0,0),l=a?Object(s.a)(a):Object(s.c)(0,0,0);o=null==o||o;const d=Object(s.b)();Object(n.r)(d,c);const u=Object(s.b)();Object(n.e)(u,d,Math.abs(e));const p=Object(s.b)();Object(n.e)(p,u,-.5),Object(n.f)(p,p,l);const b=Object(s.c)(0,1,0);Math.abs(1-Object(n.h)(d,b))<.2&&Object(n.w)(b,0,0,1);const m=Object(s.b)();Object(n.g)(m,d,b),Object(n.r)(m,m),Object(n.g)(b,m,d);const g=2*i+(o?2:0),v=i+(o?2:0),O=new Float32Array(3*g),y=new Float32Array(3*v),_=new Float32Array(2*g),j=new Uint32Array(3*i*(o?4:2)),x=new Uint32Array(3*i*(o?4:2));o&&(O[3*(g-2)+0]=p[0],O[3*(g-2)+1]=p[1],O[3*(g-2)+2]=p[2],_[2*(g-2)]=0,_[2*(g-2)+1]=0,O[3*(g-1)+0]=O[3*(g-2)+0]+u[0],O[3*(g-1)+1]=O[3*(g-2)+1]+u[1],O[3*(g-1)+2]=O[3*(g-2)+2]+u[2],_[2*(g-1)]=1,_[2*(g-1)+1]=1,y[3*(v-2)+0]=-d[0],y[3*(v-2)+1]=-d[1],y[3*(v-2)+2]=-d[2],y[3*(v-1)+0]=d[0],y[3*(v-1)+1]=d[1],y[3*(v-1)+2]=d[2]);const S=function(e,t,i){j[e]=t,x[e]=i};let T=0;const C=Object(s.b)(),E=Object(s.b)();for(let s=0;s<i;s++){const e=s*(2*Math.PI/i);Object(n.e)(C,b,Math.sin(e)),Object(n.e)(E,m,Math.cos(e)),Object(n.f)(C,C,E),y[3*s+0]=C[0],y[3*s+1]=C[1],y[3*s+2]=C[2],Object(n.e)(C,C,t),Object(n.f)(C,C,p),O[3*s+0]=C[0],O[3*s+1]=C[1],O[3*s+2]=C[2],_[2*s+0]=s/i,_[2*s+1]=0,O[3*(s+i)+0]=O[3*s+0]+u[0],O[3*(s+i)+1]=O[3*s+1]+u[1],O[3*(s+i)+2]=O[3*s+2]+u[2],_[2*(s+i)+0]=s/i,_[2*s+1]=1;const r=(s+1)%i;S(T++,s,s),S(T++,s+i,s),S(T++,r,r),S(T++,r,r),S(T++,s+i,s),S(T++,r+i,r)}if(o){for(let e=0;e<i;e++){const t=(e+1)%i;S(T++,g-2,v-2),S(T++,e,v-2),S(T++,t,v-2)}for(let e=0;e<i;e++){const t=(e+1)%i;S(T++,e+i,v-1),S(T++,g-1,v-1),S(T++,t+i,v-1)}}const A=[[f.a.POSITION,j],[f.a.NORMAL,x],[f.a.UV0,j]],w=[[f.a.POSITION,{size:3,data:O,exclusive:!0}],[f.a.NORMAL,{size:3,data:y,exclusive:!0}],[f.a.UV0,{size:2,data:_,exclusive:!0}]];return new h.a(w,A)},e.createTubeGeometry=function(t,i,r,a,n){r=r||10,a=null==a||a,Object(p.a)(t.length>1);const s=[],o=[];for(let e=0;e<r;e++){s.push([0,-e-1,-(e+1)%r-1]);const t=e/r*2*Math.PI;o.push([Math.cos(t)*i,Math.sin(t)*i])}return e.createPathExtrusionGeometry(o,t,[[0,0,0]],s,a,n)},e.createPathExtrusionGeometry=function(e,t,i,a,d,u=Object(s.c)(0,0,0)){const p=e.length,b=new Float32Array(t.length*p*3+(6*i.length||0)),m=new Float32Array(t.length*p*3+(i?6:0)),g=(t.length-1)*p*6+3*a.length*2,v=new Uint32Array(g),O=new Uint32Array(g);let _=0,j=0,x=0,S=0;const T=Object(s.b)(),C=Object(s.b)(),E=Object(s.b)(),A=Object(s.b)(),w=Object(s.b)(),R=Object(s.b)(),P=Object(s.b)(),I=Object(o.f)(),D=Object(s.b)(),M=Object(s.b)(),L=Object(s.b)(),N=Object(s.b)(),F=Object(s.b)(),z=Object(c.d)();Object(n.w)(D,0,1,0),Object(n.j)(C,t[1],t[0]),Object(n.r)(C,C),d?(Object(n.f)(I,t[0],u),Object(n.r)(E,I)):Object(n.w)(E,0,0,1),r(C,E,D,D,w,E,y),Object(n.k)(A,E),Object(n.k)(N,w);for(let r=0;r<i.length;r++)Object(n.e)(R,w,i[r][0]),Object(n.e)(I,E,i[r][2]),Object(n.f)(R,R,I),Object(n.f)(R,R,t[0]),b[_++]=R[0],b[_++]=R[1],b[_++]=R[2];m[j++]=-C[0],m[j++]=-C[1],m[j++]=-C[2];for(let r=0;r<a.length;r++)v[x++]=a[r][0]>0?a[r][0]:-a[r][0]-1+i.length,v[x++]=a[r][1]>0?a[r][1]:-a[r][1]-1+i.length,v[x++]=a[r][2]>0?a[r][2]:-a[r][2]-1+i.length,O[S++]=0,O[S++]=0,O[S++]=0;let U=i.length;const G=i.length-1;for(let s=0;s<t.length;s++){let i=!1;s>0&&(Object(n.k)(T,C),s<t.length-1?(Object(n.j)(C,t[s+1],t[s]),Object(n.r)(C,C)):i=!0,Object(n.f)(M,T,C),Object(n.r)(M,M),Object(n.f)(L,t[s-1],A),Object(c.g)(t[s],M,z),Object(c.m)(z,Object(l.g)(L,T),I)?(Object(n.j)(I,I,t[s]),Object(n.r)(E,I),Object(n.g)(w,M,E),Object(n.r)(w,w)):r(M,A,N,D,w,E,y),Object(n.k)(A,E),Object(n.k)(N,w)),d&&(Object(n.f)(I,t[s],u),Object(n.r)(F,I));for(let r=0;r<p;r++)if(Object(n.e)(R,w,e[r][0]),Object(n.e)(I,E,e[r][1]),Object(n.f)(R,R,I),Object(n.r)(P,R),m[j++]=P[0],m[j++]=P[1],m[j++]=P[2],Object(n.f)(R,R,t[s]),b[_++]=R[0],b[_++]=R[1],b[_++]=R[2],!i){const e=(r+1)%p;v[x++]=U+r,v[x++]=U+p+r,v[x++]=U+e,v[x++]=U+e,v[x++]=U+p+r,v[x++]=U+p+e;for(let t=0;t<6;t++)O[S++]=v[x-6+t]-G}U+=p}const V=t[t.length-1];for(let r=0;r<i.length;r++)Object(n.e)(R,w,i[r][0]),Object(n.e)(I,E,i[r][1]),Object(n.f)(R,R,I),Object(n.f)(R,R,V),b[_++]=R[0],b[_++]=R[1],b[_++]=R[2];const B=j/3;m[j++]=C[0],m[j++]=C[1],m[j++]=C[2];const k=U-p;for(let r=0;r<a.length;r++)v[x++]=a[r][0]>=0?U+a[r][0]:-a[r][0]-1+k,v[x++]=a[r][2]>=0?U+a[r][2]:-a[r][2]-1+k,v[x++]=a[r][1]>=0?U+a[r][1]:-a[r][1]-1+k,O[S++]=B,O[S++]=B,O[S++]=B;const H=[[f.a.POSITION,v],[f.a.NORMAL,O]],W=[[f.a.POSITION,{size:3,data:b,exclusive:!0}],[f.a.NORMAL,{size:3,data:m,exclusive:!0}]];return new h.a(W,H)},e.createPolylineGeometry=function(e,t,i){Object(p.a)(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),Object(p.a)(3===e[0].length,"createPolylineGeometry(): malformed vertex"),Object(p.a)(null==t||t.length===e.length,"createPolylineGeometry: need same number of points and normals"),Object(p.a)(null==t||3===t[0].length,"createPolylineGeometry(): malformed normal");const r=new Float64Array(3*e.length),a=new Uint32Array(2*(e.length-1));let n=0,s=0;for(let l=0;l<e.length;l++){for(let t=0;t<3;t++)r[n++]=e[l][t];l>0&&(a[s++]=l-1,a[s++]=l)}const o=[],c=[];if(o.push([f.a.POSITION,a]),c.push([f.a.POSITION,{size:3,data:r,exclusive:!0}]),t){const i=new Float32Array(3*t.length);let r=0;for(let a=0;a<e.length;a++)for(let e=0;e<3;e++)i[r++]=t[a][e];o.push([f.a.NORMAL,a]),c.push([f.a.NORMAL,{size:3,data:i,exclusive:!0}])}return i&&(c.push([f.a.COLOR,{size:4,data:i}]),o.push([f.a.COLOR,Object(u.d)(i.length/4)])),new h.a(c,o,d.f.Line)},e.createExtrudedTriangle=function(e,t,i,r,a=0){const n=new Array(18),s=[[-t,a,r/2],[i,a,r/2],[0,e+a,r/2],[-t,a,-r/2],[i,a,-r/2],[0,e+a,-r/2]],o=new Uint16Array([0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5]);for(let c=0;c<6;c++)n[3*c]=s[c][0],n[3*c+1]=s[c][1],n[3*c+2]=s[c][2];return new h.a([[f.a.POSITION,{size:3,data:n,exclusive:!0}]],[[f.a.POSITION,o]])},e.transformInPlace=function(e,t){const i=e.getMutableAttribute(f.a.POSITION).data;for(let r=0;r<i.length;r+=3){const e=i[r],a=i[r+1],s=i[r+2];Object(n.w)(_,e,a,s),Object(n.q)(_,_,t),i[r]=_[0],i[r+1]=_[1],i[r+2]=_[2]}},e.cgToGIS=function(e,t=e){const i=e.vertexAttributes,r=i.get(f.a.POSITION).data,a=i.get(f.a.NORMAL).data;if(a){const e=t.getMutableAttribute(f.a.NORMAL).data;for(let t=0;t<a.length;t+=3){const i=a[t+1];e[t+1]=-a[t+2],e[t+2]=i}}if(r){const e=t.getMutableAttribute(f.a.POSITION).data;for(let t=0;t<r.length;t+=3){const i=r[t+1];e[t+1]=-r[t+2],e[t+2]=i}}return t},e.makeOrthoBasisDirUp=i,e.makeOrthoBasisDirUpFallback=r}(O||(O={}));const y=.99619469809,_=Object(s.b)(),j=O},595:function(e,t,i){"use strict";i.d(t,"a",(function(){return b}));var r=i(85),a=i(163),n=i(212),s=i(117),o=i(109),c=i(278);class l{constructor(e,t,i,r){this.primitiveIndices=e,this._numIndexPerPrimitive=t,this.indices=i,this.position=r,this.center=Object(o.f)(),Object(c.a)(e.length>=1),Object(c.a)(i.length%this._numIndexPerPrimitive==0),Object(c.a)(i.length>=e.length*this._numIndexPerPrimitive),Object(c.a)(3===r.size||4===r.size);const{data:a,size:n}=r,l=e.length;let h=n*i[this._numIndexPerPrimitive*e[0]];d.clear(),d.push(h),this.bbMin=Object(o.h)(a[h],a[h+1],a[h+2]),this.bbMax=Object(o.d)(this.bbMin);for(let s=0;s<l;++s){const t=this._numIndexPerPrimitive*e[s];for(let e=0;e<this._numIndexPerPrimitive;++e){h=n*i[t+e],d.push(h);let r=a[h];this.bbMin[0]=Math.min(r,this.bbMin[0]),this.bbMax[0]=Math.max(r,this.bbMax[0]),r=a[h+1],this.bbMin[1]=Math.min(r,this.bbMin[1]),this.bbMax[1]=Math.max(r,this.bbMax[1]),r=a[h+2],this.bbMin[2]=Math.min(r,this.bbMin[2]),this.bbMax[2]=Math.max(r,this.bbMax[2])}}Object(s.i)(this.center,this.bbMin,this.bbMax,.5),this.radius=.5*Math.max(Math.max(this.bbMax[0]-this.bbMin[0],this.bbMax[1]-this.bbMin[1]),this.bbMax[2]-this.bbMin[2]);let u=this.radius*this.radius;for(let s=0;s<d.length;++s){h=d.getItemAt(s);const e=a[h]-this.center[0],t=a[h+1]-this.center[1],i=a[h+2]-this.center[2],r=e*e+t*t+i*i;if(r<=u)continue;const n=Math.sqrt(r),o=.5*(n-this.radius);this.radius=this.radius+o,u=this.radius*this.radius;const c=o/n;this.center[0]+=e*c,this.center[1]+=t*c,this.center[2]+=i*c}d.clear()}getCenter(){return this.center}getBSRadius(){return this.radius}getBBMin(){return this.bbMin}getBBMax(){return this.bbMax}getChildren(){if(this._children)return this._children;if(Object(s.l)(this.bbMin,this.bbMax)>1){const e=Object(s.i)(Object(o.f)(),this.bbMin,this.bbMax,.5),t=this.primitiveIndices.length,i=new Uint8Array(t),r=new Array(8);for(let s=0;s<8;++s)r[s]=0;const{data:a,size:n}=this.position;for(let s=0;s<t;++s){let t=0;const o=this._numIndexPerPrimitive*this.primitiveIndices[s];let c=n*this.indices[o],l=a[c],d=a[c+1],h=a[c+2];for(let e=1;e<this._numIndexPerPrimitive;++e){c=n*this.indices[o+e];const t=a[c],i=a[c+1],r=a[c+2];t<l&&(l=t),i<d&&(d=i),r<h&&(h=r)}l<e[0]&&(t|=1),d<e[1]&&(t|=2),h<e[2]&&(t|=4),i[s]=t,++r[t]}let c=0;for(let s=0;s<8;++s)r[s]>0&&++c;if(c<2)return;const d=new Array(8);for(let s=0;s<8;++s)d[s]=r[s]>0?new Uint32Array(r[s]):void 0;for(let s=0;s<8;++s)r[s]=0;for(let s=0;s<t;++s){const e=i[s];d[e][r[e]++]=this.primitiveIndices[s]}this._children=new Array(8);for(let s=0;s<8;++s)void 0!==d[s]&&(this._children[s]=new l(d[s],this._numIndexPerPrimitive,this.indices,this.position))}return this._children}static prune(){d.prune()}}const d=new n.a({deallocator:null});var h=i(560),u=i(544),p=i(562),f=i(139);class b extends h.a{constructor(e,t=[],i=a.f.Triangle,r=-1){super(),this._primitiveType=i,this.edgeIndicesLength=r,this.type=u.a.Geometry,this._vertexAttributes=new Map,this._indices=new Map,this._boundingInfo=null;for(const[a,n]of e)n&&this._vertexAttributes.set(a,{...n});if(null==t||0===t.length){const e=function(e){const t=e.values().next().value;return null==t?0:t.data.length/t.size}(this._vertexAttributes),t=Object(p.d)(e);this.edgeIndicesLength=this.edgeIndicesLength<0?e:this.edgeIndicesLength;for(const i of this._vertexAttributes.keys())this._indices.set(i,t)}else for(const[a,n]of t)n&&(this._indices.set(a,m(n)),a===f.a.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._indices.get(a).length:this.edgeIndicesLength))}cloneShallow(){const e=new b([],void 0,this._primitiveType,void 0),{_vertexAttributes:t,_indices:i}=e;return this._vertexAttributes.forEach(((e,i)=>{t.set(i,e)})),this._indices.forEach(((e,t)=>{i.set(t,e)})),e.screenToWorldRatio=this.screenToWorldRatio,e._boundingInfo=this._boundingInfo,e}get vertexAttributes(){return this._vertexAttributes}getMutableAttribute(e){const t=this._vertexAttributes.get(e);return t&&!t.exclusive&&(t.data=Array.from(t.data),t.exclusive=!0),t}get indices(){return this._indices}get indexCount(){const e=this._indices.values().next().value;return e?e.length:0}get primitiveType(){return this._primitiveType}get faceCount(){return this.indexCount/3}get boundingInfo(){return Object(r.j)(this._boundingInfo)&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(e){return this.primitiveType===a.f.Triangle?this._computeAttachmentOriginTriangles(e):this._computeAttachmentOriginPoints(e)}_computeAttachmentOriginTriangles(e){const t=this.indices.get(f.a.POSITION),i=this.vertexAttributes.get(f.a.POSITION);return Object(p.c)(i,t,e)}_computeAttachmentOriginPoints(e){const t=this.indices.get(f.a.POSITION),i=this.vertexAttributes.get(f.a.POSITION);return Object(p.b)(i,t,e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.indices.get(f.a.POSITION);if(0===e.length)return null;const t=this.primitiveType===a.f.Triangle?3:1;Object(c.a)(e.length%t==0,"Indexing error: "+e.length+" not divisible by "+t);const i=Object(p.d)(e.length/t),r=this.vertexAttributes.get(f.a.POSITION);return new l(i,t,e,r)}}function m(e){if(e.BYTES_PER_ELEMENT===Uint16Array.BYTES_PER_ELEMENT)return e;for(const t of e)if(t>=65536)return e;return new Uint16Array(e)}},604:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return d})),i.d(t,"c",(function(){return f})),i.d(t,"d",(function(){return b})),i.d(t,"e",(function(){return u})),i.d(t,"f",(function(){return h}));var r=i(147),a=i(421),n=i(278),s=i(139);function o(e,t,i,r,a=1){const n=i.typedBuffer,s=i.typedBufferStride,o=e.length;if(r*=s,1===a)for(let c=0;c<o;++c)n[r]=t[e[c]],r+=s;else for(let c=0;c<o;++c){const i=t[e[c]];for(let e=0;e<a;e++)n[r]=i,r+=s}}function c(e,t,i,r){const a=i.typedBuffer,n=i.typedBufferStride,s=e.length;r*=n;for(let o=0;o<s;++o){const i=2*e[o];a[r]=t[i],a[r+1]=t[i+1],r+=n}}function l(e,t,i,r,a){const n=i.typedBuffer,s=i.typedBufferStride,o=e.length;if(r*=s,null==a||1===a)for(let c=0;c<o;++c){const i=3*e[c];n[r]=t[i],n[r+1]=t[i+1],n[r+2]=t[i+2],r+=s}else for(let c=0;c<o;++c){const i=3*e[c];for(let e=0;e<a;++e)n[r]=t[i],n[r+1]=t[i+1],n[r+2]=t[i+2],r+=s}}function d(e,t,i,r,a=1){const n=i.typedBuffer,s=i.typedBufferStride,o=e.length;if(r*=s,1===a)for(let c=0;c<o;++c){const i=4*e[c];n[r]=t[i],n[r+1]=t[i+1],n[r+2]=t[i+2],n[r+3]=t[i+3],r+=s}else for(let c=0;c<o;++c){const i=4*e[c];for(let e=0;e<a;++e)n[r]=t[i],n[r+1]=t[i+1],n[r+2]=t[i+2],n[r+3]=t[i+3],r+=s}}function h(e,t,i,r,a,n=1){if(!i)return void l(e,t,r,a,n);const s=r.typedBuffer,o=r.typedBufferStride,c=e.length,d=i[0],h=i[1],u=i[2],p=i[4],f=i[5],b=i[6],m=i[8],g=i[9],v=i[10],O=i[12],y=i[13],_=i[14];if(a*=o,1===n)for(let l=0;l<c;++l){const i=3*e[l],r=t[i],n=t[i+1],c=t[i+2];s[a]=d*r+p*n+m*c+O,s[a+1]=h*r+f*n+g*c+y,s[a+2]=u*r+b*n+v*c+_,a+=o}else for(let l=0;l<c;++l){const i=3*e[l],r=t[i],c=t[i+1],j=t[i+2],x=d*r+p*c+m*j+O,S=h*r+f*c+g*j+y,T=u*r+b*c+v*j+_;for(let e=0;e<n;++e)s[a]=x,s[a+1]=S,s[a+2]=T,a+=o}}function u(e,t,i,a,n,s=1){if(!i)return void l(e,t,a,n,s);const o=i,c=a.typedBuffer,d=a.typedBufferStride,h=e.length,u=o[0],p=o[1],f=o[2],b=o[4],m=o[5],g=o[6],v=o[8],O=o[9],y=o[10],_=!Object(r.p)(o),j=1e-6,x=1-j;if(n*=d,1===s)for(let r=0;r<h;++r){const i=3*e[r],a=t[i],s=t[i+1],o=t[i+2];let l=u*a+b*s+v*o,h=p*a+m*s+O*o,S=f*a+g*s+y*o;if(_){const e=l*l+h*h+S*S;if(e<x&&e>j){const t=1/Math.sqrt(e);l*=t,h*=t,S*=t}}c[n+0]=l,c[n+1]=h,c[n+2]=S,n+=d}else for(let r=0;r<h;++r){const i=3*e[r],a=t[i],o=t[i+1],l=t[i+2];let h=u*a+b*o+v*l,S=p*a+m*o+O*l,T=f*a+g*o+y*l;if(_){const e=h*h+S*S+T*T;if(e<x&&e>j){const t=1/Math.sqrt(e);h*=t,S*=t,T*=t}}for(let e=0;e<s;++e)c[n+0]=h,c[n+1]=S,c[n+2]=T,n+=d}}function p(e,t,i,a,n,s=1){if(!i)return void d(e,t,a,n,s);const o=i,c=a.typedBuffer,l=a.typedBufferStride,h=e.length,u=o[0],p=o[1],f=o[2],b=o[4],m=o[5],g=o[6],v=o[8],O=o[9],y=o[10],_=!Object(r.p)(o),j=1e-6,x=1-j;if(n*=l,1===s)for(let r=0;r<h;++r){const i=4*e[r],a=t[i],s=t[i+1],o=t[i+2],d=t[i+3];let h=u*a+b*s+v*o,S=p*a+m*s+O*o,T=f*a+g*s+y*o;if(_){const e=h*h+S*S+T*T;if(e<x&&e>j){const t=1/Math.sqrt(e);h*=t,S*=t,T*=t}}c[n+0]=h,c[n+1]=S,c[n+2]=T,c[n+3]=d,n+=l}else for(let r=0;r<h;++r){const i=4*e[r],a=t[i],o=t[i+1],d=t[i+2],h=t[i+3];let S=u*a+b*o+v*d,T=p*a+m*o+O*d,C=f*a+g*o+y*d;if(_){const e=S*S+T*T+C*C;if(e<x&&e>j){const t=1/Math.sqrt(e);S*=t,T*=t,C*=t}}for(let e=0;e<s;++e)c[n+0]=S,c[n+1]=T,c[n+2]=C,c[n+3]=h,n+=l}}function f(e,t,i,r,a,n=1){const s=r.typedBuffer,o=r.typedBufferStride,c=e.length;if(a*=o,1===n){if(4===i)for(let l=0;l<c;++l){const i=4*e[l];s[a]=t[i],s[a+1]=t[i+1],s[a+2]=t[i+2],s[a+3]=t[i+3],a+=o}else if(3===i)for(let l=0;l<c;++l){const i=3*e[l];s[a]=t[i],s[a+1]=t[i+1],s[a+2]=t[i+2],s[a+3]=255,a+=o}}else if(4===i)for(let l=0;l<c;++l){const i=4*e[l];for(let e=0;e<n;++e)s[a]=t[i],s[a+1]=t[i+1],s[a+2]=t[i+2],s[a+3]=t[i+3],a+=o}else if(3===i)for(let l=0;l<c;++l){const i=3*e[l];for(let e=0;e<n;++e)s[a]=t[i],s[a+1]=t[i+1],s[a+2]=t[i+2],s[a+3]=255,a+=o}}function b(e,t,i,r,o,l){for(const d of t.fieldNames){const t=e.vertexAttributes.get(d),b=e.indices.get(d);if(t&&b)switch(d){case s.a.POSITION:{Object(n.a)(3===t.size);const e=o.getField(d,a.u);e&&h(b,t.data,i,e,l);break}case s.a.NORMAL:{Object(n.a)(3===t.size);const e=o.getField(d,a.u);e&&u(b,t.data,r,e,l);break}case s.a.UV0:{Object(n.a)(2===t.size);const e=o.getField(d,a.m);e&&c(b,t.data,e,l);break}case s.a.COLOR:{Object(n.a)(3===t.size||4===t.size);const e=o.getField(d,a.J);e&&f(b,t.data,t.size,e,l);break}case s.a.SYMBOLCOLOR:{Object(n.a)(3===t.size||4===t.size);const e=o.getField(d,a.J);e&&f(b,t.data,t.size,e,l);break}case s.a.TANGENT:{Object(n.a)(4===t.size);const e=o.getField(d,a.C);e&&p(b,t.data,r,e,l);break}}}}},607:function(e,t,i){"use strict";i.d(t,"a",(function(){return _})),i.d(t,"b",(function(){return r})),i.d(t,"c",(function(){return y})),i.d(t,"d",(function(){return f})),i.d(t,"e",(function(){return g})),i.d(t,"f",(function(){return m})),i.d(t,"g",(function(){return b})),i.d(t,"h",(function(){return v})),i.d(t,"i",(function(){return O}));var r,a,n=i(222),s=i(85),o=i(147),c=i(200),l=i(109),d=i(187),h=i(797),u=i(568),p=i(746);function f(e,t,i,r,a,n,s,o,c,l,h){const u=j[h.mode];let p,f,b=0;if(Object(d.l)(e,t,i,r,c.spatialReference,a,o))return u.requiresAlignment(h)?(b=u.applyElevationAlignmentBuffer(r,a,n,s,o,c,l,h),p=n,f=s):(p=r,f=a),Object(d.l)(p,c.spatialReference,f,n,l.spatialReference,s,o)?b:void 0}function b(e,t,i,r,a){const o=(Object(h.a)(e)?e.z:Object(p.c)(e)?e.array[e.offset+2]:e[2])||0;switch(i.mode){case"on-the-ground":{const i=Object(s.t)(Object(p.b)(t,e,"ground"),0);return a.verticalDistanceToGround=0,a.sampledElevation=i,void(a.z=i)}case"relative-to-ground":{const n=Object(s.t)(Object(p.b)(t,e,"ground"),0),c=i.geometryZWithOffset(o,r);return a.verticalDistanceToGround=c,a.sampledElevation=n,void(a.z=c+n)}case"relative-to-scene":{const n=Object(s.t)(Object(p.b)(t,e,"scene"),0),c=i.geometryZWithOffset(o,r);return a.verticalDistanceToGround=c,a.sampledElevation=n,void(a.z=c+n)}case"absolute-height":{const n=i.geometryZWithOffset(o,r),c=Object(s.t)(Object(p.b)(t,e,"ground"),0);return a.verticalDistanceToGround=n-c,a.sampledElevation=c,void(a.z=n)}default:return Object(n.a)(i.mode),void(a.z=0)}}function m(e,t,i,r){return b(e,t,i,r,S),S.z}function g(e,t,i){return null==t||null==i?e.definedChanged:"on-the-ground"===t&&"on-the-ground"===i?e.staysOnTheGround:t===i||"on-the-ground"!==t&&"on-the-ground"!==i?r.UPDATE:e.onTheGroundChanged}function v(e){return"relative-to-ground"===e||"relative-to-scene"===e}function O(e){return"absolute-height"!==e}function y(e,t,i,r,a){b(t,i,a,r,S),Object(u.h)(e,S.verticalDistanceToGround);const n=S.sampledElevation,s=Object(o.c)(x,e.transformation);return T[0]=t.x,T[1]=t.y,T[2]=S.z,Object(d.d)(t.spatialReference,T,s,r.spatialReference)?e.transformation=s:console.warn("Could not locate symbol object properly, it might be misplaced"),n}class _{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}(a=r||(r={}))[a.NONE=0]="NONE",a[a.UPDATE=1]="UPDATE",a[a.RECREATE=2]="RECREATE";const j={"absolute-height":{applyElevationAlignmentBuffer:function(e,t,i,r,a,n,s,o){const c=o.calculateOffsetRenderUnits(s),l=o.featureExpressionInfoContext;t*=3,r*=3;for(let d=0;d<a;++d){const a=e[t+0],n=e[t+1],s=e[t+2];i[r+0]=a,i[r+1]=n,i[r+2]=null==l?s+c:c,t+=3,r+=3}return 0},requiresAlignment:function(e){const t=e.meterUnitOffset,i=e.featureExpressionInfoContext;return 0!==t||null!=i}},"on-the-ground":{applyElevationAlignmentBuffer:function(e,t,i,r,a,n){let o=0;const c=n.spatialReference;t*=3,r*=3;for(let l=0;l<a;++l){const a=e[t+0],l=e[t+1],d=e[t+2],h=Object(s.t)(n.getElevation(a,l,d,c,"ground"),0);o+=h,i[r+0]=a,i[r+1]=l,i[r+2]=h,t+=3,r+=3}return o/a},requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:function(e,t,i,r,a,n,o,c){let l=0;const d=c.calculateOffsetRenderUnits(o),h=c.featureExpressionInfoContext,u=n.spatialReference;t*=3,r*=3;for(let p=0;p<a;++p){const a=e[t+0],o=e[t+1],c=e[t+2],p=Object(s.t)(n.getElevation(a,o,c,u,"ground"),0);l+=p,i[r+0]=a,i[r+1]=o,i[r+2]=null==h?c+p+d:p+d,t+=3,r+=3}return l/a},requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:function(e,t,i,r,a,n,o,c){let l=0;const d=c.calculateOffsetRenderUnits(o),h=c.featureExpressionInfoContext,u=n.spatialReference;t*=3,r*=3;for(let p=0;p<a;++p){const a=e[t+0],o=e[t+1],c=e[t+2],p=Object(s.t)(n.getElevation(a,o,c,u,"scene"),0);l+=p,i[r+0]=a,i[r+1]=o,i[r+2]=null==h?c+p+d:p+d,t+=3,r+=3}return l/a},requiresAlignment:()=>!0}},x=Object(c.d)(),S=new _,T=Object(l.f)()},608:function(e,t,i){"use strict";var r,a;i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return r})),i.d(t,"c",(function(){return a})),function(e){e[e.OBJECT=0]="OBJECT",e[e.HUD=1]="HUD",e[e.TERRAIN=2]="TERRAIN",e[e.OVERLAY=3]="OVERLAY",e[e.I3S=4]="I3S",e[e.PCL=5]="PCL",e[e.LOD=6]="LOD",e[e.VOXEL=7]="VOXEL"}(r||(r={}));class n{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=a.ALL}}!function(e){e[e.MIN=0]="MIN",e[e.MINMAX=1]="MINMAX",e[e.ALL=2]="ALL"}(a||(a={}))},620:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return m})),i.d(t,"c",(function(){return b})),i.d(t,"d",(function(){return g})),i.d(t,"e",(function(){return O})),i.d(t,"f",(function(){return v}));var r,a,n,s=i(485),o=i(147),c=i(117),l=i(109),d=i(271),h=i(257),u=i(767),p=i(423),f=i(288);function b(e){return e?[Object(p.d)(e[0]),Object(p.d)(e[1]),Object(p.d)(e[2]),Object(p.d)(e[3]),Object(p.d)(e[4]),Object(p.d)(e[5])]:[Object(p.d)(),Object(p.d)(),Object(p.d)(),Object(p.d)(),Object(p.d)(),Object(p.d)()]}function m(e,t){for(let i=0;i<y.NUM;i++)Object(p.c)(e[i],t[i])}function g(e,t,i,n=x){const s=Object(o.m)(f.a.get(),t,e);Object(o.a)(s,s);for(let r=0;r<_.NUM;++r){const e=Object(d.m)(f.e.get(),j[r],s);Object(c.w)(n[r],e[0]/e[3],e[1]/e[3],e[2]/e[3])}!function(e,t){Object(p.f)(t[a.FAR_BOTTOM_LEFT],t[a.NEAR_BOTTOM_LEFT],t[a.NEAR_TOP_LEFT],e[r.LEFT]),Object(p.f)(t[a.NEAR_BOTTOM_RIGHT],t[a.FAR_BOTTOM_RIGHT],t[a.FAR_TOP_RIGHT],e[r.RIGHT]),Object(p.f)(t[a.FAR_BOTTOM_LEFT],t[a.FAR_BOTTOM_RIGHT],t[a.NEAR_BOTTOM_RIGHT],e[r.BOTTOM]),Object(p.f)(t[a.NEAR_TOP_LEFT],t[a.NEAR_TOP_RIGHT],t[a.FAR_TOP_RIGHT],e[r.TOP]),Object(p.f)(t[a.NEAR_BOTTOM_LEFT],t[a.NEAR_BOTTOM_RIGHT],t[a.NEAR_TOP_RIGHT],e[r.NEAR]),Object(p.f)(t[a.FAR_BOTTOM_RIGHT],t[a.FAR_BOTTOM_LEFT],t[a.FAR_TOP_LEFT],e[r.FAR])}(i,n)}function v(e,t){for(let i=0;i<y.NUM;i++){const r=e[i];if(r[0]*t[0]+r[1]*t[1]+r[2]*t[2]+r[3]>=t[3])return!1}return!0}function O(e,t){for(let i=0;i<y.NUM;i++){const r=e[i];if(!Object(p.b)(r,t))return!1}return!0}(n=r||(r={}))[n.LEFT=0]="LEFT",n[n.RIGHT=1]="RIGHT",n[n.BOTTOM=2]="BOTTOM",n[n.TOP=3]="TOP",n[n.NEAR=4]="NEAR",n[n.FAR=5]="FAR",function(e){e[e.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",e[e.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",e[e.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",e[e.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",e[e.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",e[e.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",e[e.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",e[e.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(a||(a={}));a.FAR_BOTTOM_RIGHT,a.NEAR_BOTTOM_RIGHT,a.NEAR_BOTTOM_LEFT,a.FAR_BOTTOM_LEFT,a.NEAR_BOTTOM_LEFT,a.NEAR_BOTTOM_RIGHT,a.NEAR_TOP_RIGHT,a.NEAR_TOP_LEFT,a.FAR_BOTTOM_RIGHT,a.FAR_BOTTOM_LEFT,a.FAR_TOP_LEFT,a.FAR_TOP_RIGHT,a.NEAR_BOTTOM_RIGHT,a.FAR_BOTTOM_RIGHT,a.FAR_TOP_RIGHT,a.NEAR_TOP_RIGHT,a.FAR_BOTTOM_LEFT,a.NEAR_BOTTOM_LEFT,a.NEAR_TOP_LEFT,a.FAR_TOP_LEFT,a.FAR_TOP_LEFT,a.NEAR_TOP_LEFT,a.NEAR_TOP_RIGHT,a.FAR_TOP_RIGHT;var y,_;!function(e){e[e.NUM=6]="NUM"}(y||(y={})),function(e){e[e.NUM=8]="NUM"}(_||(_={}));const j=[Object(h.g)(-1,-1,-1,1),Object(h.g)(1,-1,-1,1),Object(h.g)(1,1,-1,1),Object(h.g)(-1,1,-1,1),Object(h.g)(-1,-1,1,1),Object(h.g)(1,-1,1,1),Object(h.g)(1,1,1,1),Object(h.g)(-1,1,1,1)],x=(new s.a(u.a),[Object(l.f)(),Object(l.f)(),Object(l.f)(),Object(l.f)(),Object(l.f)(),Object(l.f)(),Object(l.f)(),Object(l.f)()])},621:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return c}));var r=i(85),a=i(210),n=i(163),s=i(567);class o{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}destroy(){this._map.forEach(((e,t)=>{Object(r.k)(e)&&this._repository.release(this._material,c(t))}))}load(e,t){this._map.has(t)||this._map.set(t,this._repository.acquire(this._material,c(t)));const i=this._map.get(t);if(Object(r.k)(i)){if(i.ensureResources(e)===n.g.LOADED)return i;this._repository.requestRender()}return null}}function c(e){switch(e){default:case s.a.MATERIAL:return a.a.Color;case s.a.MATERIAL_ALPHA:return a.a.Alpha;case s.a.MATERIAL_DEPTH_SHADOWMAP_ALL:return a.a.Shadow;case s.a.MATERIAL_NORMAL:return a.a.Normal;case s.a.MATERIAL_DEPTH:return a.a.Depth;case s.a.MATERIAL_HIGHLIGHT:return a.a.Highlight;case s.a.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT:case s.a.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return a.a.Shadow}}},622:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(210),a=i(500),n=i(126);function s(e,t){e.fragment.include(a.a),t.output===r.a.Shadow?(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(n.a`float _calculateFragDepth(const in float depth) {
const float SLOPE_SCALE = 2.0;
const float BIAS = 2.0 * .000015259;
float m = max(abs(dFdx(depth)), abs(dFdy(depth)));
float result = depth + SLOPE_SCALE * m + BIAS;
return clamp(result, .0, .999999);
}
void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_calculateFragDepth(_linearDepth));
}`)):t.output===r.a.Depth&&e.fragment.code.add(n.a`void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_linearDepth);
}`)}},623:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return c})),i.d(t,"d",(function(){return o}));var r=i(126),a=i(139);function n(e,t){t.vvInstancingEnabled&&(t.vvSize||t.vvColor)&&e.attributes.add(a.a.INSTANCEFEATUREATTRIBUTE,"vec4"),t.vvSize?(e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.uniforms.add("vvSymbolRotationMatrix","mat3"),e.vertex.uniforms.add("vvSymbolAnchor","vec3"),e.vertex.code.add(r.a`vec3 vvScale(vec4 _featureAttribute) {
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),e.vertex.code.add(r.a`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);
        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);
      }

      ${t.vvInstancingEnabled?r.a`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):e.vertex.code.add(r.a`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),t.vvColor?(e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(r.a`
      uniform float vvColorValues[vvColorNumber];
      uniform vec4 vvColorColors[vvColorNumber];

      vec4 vvGetColor(vec4 featureAttribute, float values[vvColorNumber], vec4 colors[vvColorNumber]) {
        float value = featureAttribute.y;
        if (value <= values[0]) {
          return colors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (values[i] >= value) {
            float f = (value - values[i-1]) / (values[i] - values[i-1]);
            return mix(colors[i-1], colors[i], f);
          }
        }
        return colors[vvColorNumber - 1];
      }

      ${t.vvInstancingEnabled?r.a`
      vec4 vvColor() {
        return vvGetColor(instanceFeatureAttribute, vvColorValues, vvColorColors);
      }`:""}
    `)):e.vertex.code.add(r.a`vec4 vvColor() { return vec4(1.0); }`)}function s(e,t){t.vvSizeEnabled&&(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors))}function o(e,t){s(e,t),t.vvOpacityEnabled&&(e.setUniform1fv("vvOpacityValues",t.vvOpacityValues),e.setUniform1fv("vvOpacityOpacities",t.vvOpacityOpacities))}function c(e,t){s(e,t),t.vvSizeEnabled&&(e.setUniform3fv("vvSymbolAnchor",t.vvSymbolAnchor),e.setUniformMatrix3fv("vvSymbolRotationMatrix",t.vvSymbolRotationMatrix))}},624:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(126),a=i(139);function n(e,t){t.attributeColor?(e.attributes.add(a.a.COLOR,"vec4"),e.varyings.add("vColor","vec4"),e.vertex.code.add(r.a`void forwardVertexColor() { vColor = color; }`),e.vertex.code.add(r.a`void forwardNormalizedVertexColor() { vColor = color * 0.003921568627451; }`)):e.vertex.code.add(r.a`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}},625:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return c})),i.d(t,"d",(function(){return o}));var r=i(500),a=i(126);function n(e){e.fragment.include(r.a),e.fragment.uniforms.add("shadowMapTex","sampler2D"),e.fragment.uniforms.add("numCascades","int"),e.fragment.uniforms.add("cascadeDistances","vec4"),e.fragment.uniforms.add("shadowMapMatrix","mat4",4),e.fragment.uniforms.add("depthHalfPixelSz","float"),e.fragment.code.add(a.a`int chooseCascade(float _linearDepth, out mat4 mat) {
vec4 distance = cascadeDistances;
float depth = _linearDepth;
int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;
mat = i == 0 ? shadowMapMatrix[0] : i == 1 ? shadowMapMatrix[1] : i == 2 ? shadowMapMatrix[2] : shadowMapMatrix[3];
return i;
}
vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
vec4 lv = mat * vec4(_vpos, 1.0);
lv.xy /= lv.w;
return 0.5 * lv.xyz + vec3(0.5);
}
vec2 cascadeCoordinates(int i, vec3 lvpos) {
return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;
}
float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {
return rgba2float(texture2D(_depthTex, uv));
}
float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {
return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;
}
float filterShadow(vec2 uv, vec3 lvpos, float halfPixelSize, sampler2D _depthTex) {
float texSize = 0.5 / halfPixelSize;
vec2 st = fract((vec2(halfPixelSize) + uv) * texSize);
float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);
float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float readShadowMap(const in vec3 _vpos, float _linearDepth) {
mat4 mat;
int i = chooseCascade(_linearDepth, mat);
if (i >= numCascades) { return 0.0; }
vec3 lvpos = lightSpacePosition(_vpos, mat);
if (lvpos.z >= 1.0) { return 0.0; }
if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }
vec2 uv = cascadeCoordinates(i, lvpos);
return filterShadow(uv, lvpos, depthHalfPixelSz, shadowMapTex);
}`)}function s(e,t){t.shadowMappingEnabled&&(t.shadowMap.bind(e),t.shadowMap.bindView(e,t.origin))}function o(e,t,i){t.shadowMappingEnabled&&t.shadowMap.bindView(e,i)}function c(e,t){t.shadowMappingEnabled&&t.shadowMap.bindView(e,t.origin)}},626:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return l})),i.d(t,"c",(function(){return c}));var r,a,n=i(126),s=i(297),o=i(139);function c(e){const t=new s.a,{mode:i,isAttributeDriven:a}=e;return t.attributes.add(o.a.POSITION,"vec3"),t.attributes.add(o.a.UV0,"vec2"),e.isAttributeDriven&&(t.attributes.add(o.a.FEATUREATTRIBUTE,"float"),t.varyings.add("attributeValue","float")),t.varyings.add("unitCirclePos","vec2"),t.vertex.uniforms.add("radius","float"),t.vertex.uniforms.add("proj","mat4"),t.vertex.uniforms.add("view","mat4"),t.vertex.code.add(n.a`
    void main() {
      unitCirclePos = uv0;

      vec4 posProj = proj * (view * vec4(${o.a.POSITION}, 1.0));
      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

      ${a?n.a`attributeValue = ${o.a.FEATUREATTRIBUTE};`:""}
      gl_Position = posProj + quadOffset;
    }
  `),i===r.KernelDensity?t.fragment.code.add(n.a`
      void main() {
        float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
        if (radiusRatioSquared > 1.0) {
          discard;
        }

        float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
        float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${a?n.a` * attributeValue`:""};
        gl_FragColor = vec4(density);
      }
    `):i===r.GaussianBlur&&(t.fragment.uniforms.add("kernel","sampler2D"),t.fragment.code.add(n.a`
    void main() {
      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
      if (radiusRatioSquared > 1.0) {
        discard;
      }

      vec2 uv = abs(unitCirclePos);
      vec2 uvX = vec2(uv.x, 0.5);
      vec2 uvY = vec2(uv.y, 0.5);
      float intensity = texture2D(kernel, uvX).r * texture2D(kernel, uvY).r${a?n.a` * attributeValue`:""};
      gl_FragColor = vec4(intensity);
    }
  `)),t}(a=r||(r={}))[a.GaussianBlur=0]="GaussianBlur",a[a.KernelDensity=1]="KernelDensity";const l=Object.freeze({__proto__:null,get HeatmapMode(){return r},build:c})},629:function(e,t,i){"use strict";i.d(t,"a",(function(){return f})),i.d(t,"b",(function(){return p})),i.d(t,"c",(function(){return s})),i.d(t,"d",(function(){return l})),i.d(t,"e",(function(){return o}));var r=i(116),a=i(117),n=i(109);function s(e){const t=e[0]*e[0]+e[4]*e[4]+e[8]*e[8],i=e[1]*e[1]+e[5]*e[5]+e[9]*e[9],r=e[2]*e[2]+e[6]*e[6]+e[10]*e[10];return Math.sqrt(Math.max(t,i,r))}function o(e,t){const i=Math.sqrt(t[0]*t[0]+t[4]*t[4]+t[8]*t[8]),r=Math.sqrt(t[1]*t[1]+t[5]*t[5]+t[9]*t[9]),n=Math.sqrt(t[2]*t[2]+t[6]*t[6]+t[10]*t[10]);return Object(a.w)(e,i,r,n),e}class c{constructor(e,t){this.min=e,this.max=t,this.range=t-e}ndiff(e,t=0){return Math.ceil((e-t)/this.range)*this.range+t}_normalize(e,t,i,r=0,a=!1){return(i-=r)<e?i+=this.ndiff(e-i):i>t&&(i-=this.ndiff(i-t)),a&&i===t&&(i=e),i+r}normalize(e,t=0,i=!1){return this._normalize(this.min,this.max,e,t,i)}clamp(e,t=0){return Object(r.e)(e-t,this.min,this.max)+t}monotonic(e,t,i){return e<t?t:t+this.ndiff(e-t,i)}minimalMonotonic(e,t,i){return this._normalize(e,e+this.range,t,i)}center(e,t,i){return t=this.monotonic(e,t,i),this.normalize((e+t)/2,i)}diff(e,t,i){return this.monotonic(e,t,i)-e}shortestSignedDiff(e,t){e=this.normalize(e);const i=(t=this.normalize(t))-e,r=t<e?this.minimalMonotonic(e,t)-e:t-this.minimalMonotonic(t,e);return Math.abs(i)<Math.abs(r)?i:r}contains(e,t,i){return t=this.minimalMonotonic(e,t),(i=this.minimalMonotonic(e,i))>e&&i<t}}function l(e,t,i,r){Object(a.j)(d,t,e),Object(a.j)(h,i,e),Object(a.g)(r,d,h),Object(a.r)(r,r),r[3]=-Object(a.h)(e,r)}const d=Object(n.f)(),h=Object(n.f)();function u(e){for(const t in e){const i=e[t];i instanceof Function&&(e[t]=i.bind(e))}return e}u(new c(0,2*Math.PI));const p=u(new c(-Math.PI,Math.PI)),f=u(new c(0,360));Object(n.f)(),Object(n.f)(),Object(n.f)()},633:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r=i(79),a=i(100),n=i(81),s=(i(84),i(82),i(83),i(80));let o=class extends a.a{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};Object(r.a)([Object(n.b)()],o.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),Object(r.a)([Object(n.b)()],o.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),o=Object(r.a)([Object(s.a)("esri.views.support.DebugFlags")],o);const c=new o},638:function(e,t,i){"use strict";i.d(t,"a",(function(){return m})),i.d(t,"b",(function(){return u})),i.d(t,"c",(function(){return h})),i.d(t,"d",(function(){return l}));var r=i(125),a=(i(82),i(89)),n=i(85),s=i(549),o=i(97),c=i(463);function l(e){return"declaredClass"in e}function d(e){return"declaredClass"in e}function h(e,t){if(!e)return null;if("declaredClass"in e)return e;const i=new r.a({layer:t,sourceLayer:t});return i.visible=e.visible,i.symbol=Object(a.a)(e.symbol),i.attributes=Object(a.a)(e.attributes),i.geometry=u(e.geometry),i}function u(e){return Object(n.j)(e)?null:l(e)?e:Object(o.a)(function(e){const t=e.spatialReference.toJSON();switch(e.type){case"point":{const{x:i,y:r,z:a,m:n}=e;return{x:i,y:r,z:a,m:n,spatialReference:t}}case"polygon":{const{rings:i,hasZ:r,hasM:a}=e;return{rings:p(i),hasZ:r,hasM:a,spatialReference:t}}case"polyline":{const{paths:i,hasZ:r,hasM:a}=e;return{paths:p(i),hasZ:r,hasM:a,spatialReference:t}}case"extent":{const{xmin:i,xmax:r,ymin:a,ymax:n,zmin:s,zmax:o,mmin:c,mmax:l,hasZ:d,hasM:h}=e;return{xmin:i,xmax:r,ymin:a,ymax:n,zmin:s,zmax:o,mmin:c,mmax:l,hasZ:d,hasM:h,spatialReference:t}}case"multipoint":{const{points:i,hasZ:r,hasM:a}=e;return{points:b(i)?f(i):i,hasZ:r,hasM:a,spatialReference:t}}default:return}}(e))}function p(e){return function(e){for(const t of e)if(0!==t.length)return b(t);return!1}(e)?e.map((e=>f(e))):e}function f(e){return e.map((e=>Object(s.n)(e)))}function b(e){return e.length&&(Object(s.d)(e[0])||Object(s.e)(e[0]))}function m(e,t){if(!e)return null;let i;if(d(e)){if(null==t)return e.clone();if(d(t))return t.copy(e)}return null!=t?(i=t,i.x=e.x,i.y=e.y,i.spatialReference=e.spatialReference,e.hasZ?(i.z=e.z,i.hasZ=e.hasZ):(i.z=null,i.hasZ=!1),e.hasM?(i.m=e.m,i.hasM=!0):(i.m=null,i.hasM=!1)):(i=Object(c.g)(e.x,e.y,e.z,e.spatialReference),e.hasM&&(i.m=e.m,i.hasM=!0)),i}},639:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return r}));var r,a,n=i(126),s=i(139);function o(e,t){t.attributeTextureCoordinates===r.Default&&(e.attributes.add(s.a.UV0,"vec2"),e.varyings.add("vuv0","vec2"),e.vertex.code.add(n.a`void forwardTextureCoordinates() {
vuv0 = uv0;
}`)),t.attributeTextureCoordinates===r.Atlas&&(e.attributes.add(s.a.UV0,"vec2"),e.varyings.add("vuv0","vec2"),e.attributes.add(s.a.UVREGION,"vec4"),e.varyings.add("vuvRegion","vec4"),e.vertex.code.add(n.a`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`)),t.attributeTextureCoordinates===r.None&&e.vertex.code.add(n.a`void forwardTextureCoordinates() {}`)}(a=r||(r={}))[a.None=0]="None",a[a.Default=1]="Default",a[a.Atlas=2]="Atlas",a[a.COUNT=3]="COUNT"},643:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var r=i(79),a=i(86),n=i(81),s=(i(84),i(82),i(83),i(80)),o=i(97);let c=class extends a.a{constructor(e){super(e),this.geometries=null,this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const e=this.geometries.map((function(e){return e.toJSON()})),t=this.geometries[0],i={};return i.outSR=this.outSpatialReference.wkid||JSON.stringify(this.outSpatialReference.toJSON()),i.inSR=t.spatialReference.wkid||JSON.stringify(t.spatialReference.toJSON()),i.geometries=JSON.stringify({geometryType:Object(o.c)(t),geometries:e}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),null!=this.transformForward&&(i.transformForward=this.transformForward),i}};Object(r.a)([Object(n.b)()],c.prototype,"geometries",void 0),Object(r.a)([Object(n.b)({json:{read:{source:"outSR"}}})],c.prototype,"outSpatialReference",void 0),Object(r.a)([Object(n.b)()],c.prototype,"transformation",void 0),Object(r.a)([Object(n.b)()],c.prototype,"transformForward",void 0),c=Object(r.a)([Object(s.a)("esri.rest.support.ProjectParameters")],c);const l=c},654:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n})),i.d(t,"c",(function(){return l})),i.d(t,"d",(function(){return d})),i.d(t,"e",(function(){return h})),i.d(t,"f",(function(){return u})),i.d(t,"g",(function(){return c})),i.d(t,"h",(function(){return o}));var r=i(163),a=i(94);const n={func:a.h.LESS},s={func:a.h.ALWAYS},o={mask:255},c={mask:0},l={function:{func:a.h.ALWAYS,ref:r.h.OutlineVisualElementMask,mask:r.h.OutlineVisualElementMask},operation:{fail:a.w.KEEP,zFail:a.w.KEEP,zPass:a.w.ZERO}},d={function:{func:a.h.ALWAYS,ref:r.h.OutlineVisualElementMask,mask:r.h.OutlineVisualElementMask},operation:{fail:a.w.KEEP,zFail:a.w.KEEP,zPass:a.w.REPLACE}},h={function:{func:a.h.EQUAL,ref:r.h.OutlineVisualElementMask,mask:r.h.OutlineVisualElementMask},operation:{fail:a.w.KEEP,zFail:a.w.KEEP,zPass:a.w.KEEP}},u={function:{func:a.h.NOTEQUAL,ref:r.h.OutlineVisualElementMask,mask:r.h.OutlineVisualElementMask},operation:{fail:a.w.KEEP,zFail:a.w.KEEP,zPass:a.w.KEEP}}},659:function(e,t,i){"use strict";i.d(t,"a",(function(){return O}));var r=i(85),a=i(147),n=i(200),s=i(117),o=i(109),c=i(498),l=i(629),d=i(163),h=i(560),u=i(544),p=i(211),f=i(244);class b{constructor(){this._disposed=!1}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(e,t,i,r,a,n){this.id=Object(f.a)(),this.geometry=e,this.material=t,this.transformation=i,this.instanceParameters=r,this.origin=a,this._shaderTransformation=n,this._disposed=!1}release(){this._disposed=!1}dispose(){this._disposed=!0}getStaticTransformation(){return this.transformation}getShaderTransformation(){return Object(r.k)(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(e){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,e):this.geometry.computeAttachmentOrigin(e))&&(Object(s.q)(e,e,this.getStaticTransformation()),!0)}}b.pool=new p.a(b);var m=i(796),g=i(278),v=i(513);class O extends h.a{constructor(e={}){super(),this.type=u.a.Object,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=Object(n.d)(),this._bvObjectSpace=new _,this._bvWorldSpace=new _,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=null==e.castShadow||e.castShadow,this.metadata=e.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new y),this.transformation=Object(n.d)();const{geometries:t,materials:i,transformations:r,origins:a}=e;if(Array.isArray(t)){Object(g.a)(i.length===t.length,"Object3D: materials don't match geometries"),Object(g.a)(r.length===t.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=t.length,this._geometries.length=t.length;for(let e=0;e<t.length;e++)this._geometries[e]=t[e],this._geometryRecords[e]=b.pool.acquire(t[e],i[e],Object(n.c)(r[e]),{highlights:null,occludees:null,visible:this._visible},a&&a[e])}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(e){Object(a.c)(this._objectTransformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}dispose(){this._geometryRecords.length=0,this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){Object(g.a)(null==this._parentLayer||null==e,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e,t,i,a,s){i=i||n.a,this._geometries.push(e);const o=b.pool.acquire(e,t,i,{highlights:null,occludees:null,visible:this._visible},a,s);return this._geometryRecords.push(o),this._hasVolatileTransformation=this._hasVolatileTransformation||Object(r.k)(o.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:o}),this._invalidateBoundingVolume(),o}removeGeometry(e){const t=this._geometryRecords.splice(e,1)[0];return this._hasVolatileTransformation=Object(r.k)(t.shaderTransformation)?this._geometryRecords.some((e=>Object(r.k)(e.shaderTransformation))):this._hasVolatileTransformation,t.dispose(),this._geometries.splice(e,1),this._emit("objectGeometryRemoved",{object:this,record:t}),this._invalidateBoundingVolume(),t}removeAllGeometries(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(e){this._emit("vertexAttrsUpdated",{object:this,record:e}),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(e){if(this._visible!==e){this._visible=e;for(const e of this._geometryRecords)e.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new m.a(d.d.MaskOccludee);for(const t of this._geometryRecords)t.instanceParameters.occludees=Object(v.a)(t.instanceParameters.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometryRecords)t.instanceParameters.occludees=Object(v.e)(t.instanceParameters.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new m.a(d.d.Highlight);for(const t of this._geometryRecords)t.instanceParameters.highlights=Object(v.a)(t.instanceParameters.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const t of this._geometryRecords)t.instanceParameters.highlights=Object(v.e)(t.instanceParameters.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,t){return Object(a.m)(Object(r.t)(t,Object(n.d)()),this.transformation,e.getStaticTransformation())}_getCombinedShaderTransformation(e,t){return t=t||Object(n.d)(),Object(a.m)(t,this.transformation,e.getShaderTransformation()),t}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let a=0;a<this._geometryRecords.length;++a){const e=this._geometries[a],t=this._geometryRecords[a],i=e.boundingInfo;Object(r.k)(i)&&(this._calculateTransformedBoundingVolume(i,this._bvObjectSpace,t.getShaderTransformation()),this._calculateTransformedBoundingVolume(i,this._bvWorldSpace,this._getCombinedShaderTransformation(t)))}Object(s.i)(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),Object(s.i)(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const e=Object(o.f)(),t=Object(o.f)(),i=Object(l.c)(this.transformation);for(let a=0;a<this._geometryRecords.length;++a){const n=this._geometries[a].boundingInfo;if(Object(r.j)(n))continue;const o=this._geometryRecords[a].getShaderTransformation(),c=Object(l.c)(o);Object(s.q)(e,n.getCenter(),o);const d=Object(s.m)(e,this._bvObjectSpace.bounds),h=n.getBSRadius()*c;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],d+h),Object(s.q)(t,e,this.transformation);const u=Object(s.m)(t,this._bvWorldSpace.bounds),p=h*i;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],u+p)}this._bvDirty=!1}_calculateTransformedBoundingVolume(e,t,i){const r=e.getBBMin(),a=e.getBBMax(),n=Object(o.d)(r),c=Object(o.d)(a);Object(s.q)(n,n,i),Object(s.q)(c,c,i);for(let s=0;s<3;++s)t.min[s]=Math.min(t.min[s],n[s],c[s]),t.max[s]=Math.max(t.max[s],n[s],c[s]);for(let o=0;o<3;++o){Object(s.k)(n,r),Object(s.k)(c,a),n[o]=a[o],c[o]=r[o],Object(s.q)(n,n,i),Object(s.q)(c,c,i);for(let e=0;e<3;++e)t.min[e]=Math.min(t.min[e],n[e],c[e]),t.max[e]=Math.max(t.max[e],n[e],c[e])}}_invalidateBoundingVolume(){this._bvDirty=!0,Object(r.k)(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(e,t){Object(r.k)(this._parentLayer)&&this._parentLayer.events.emit(e,t)}get test(){const e=this;return{hasGeometry:t=>e._geometries.indexOf(t)>-1,getGeometryIndex:t=>e._geometries.indexOf(t)}}}class y{constructor(){this.min=Object(o.h)(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=Object(o.h)(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class _ extends y{constructor(){super(...arguments),this.bounds=Object(c.c)()}init(){Object(s.w)(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),Object(s.w)(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),Object(c.a)(this.bounds)}}},664:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return a}));var r=i(97);function a(e){return{geometryType:Object(r.c)(e[0]),geometries:e.map((e=>e.toJSON()))}}function n(e,t,i){const a=Object(r.b)(t);return e.map((e=>{const t=a.fromJSON(e);return t.spatialReference=i,t}))}},676:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(85),a=i(645),n=i(855);class s{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=Object(a.a)(e)}get requiresSampledElevationInfo(){return"absolute-height"!==this.mode}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const i=this.calculateOffsetRenderUnits(t);return null!=this.featureExpressionInfoContext?i:e+i}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return null!=i&&(t+=Object(n.d)(i)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=Object(a.c)(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=Object(r.t)(e.offset,0)}updateFeatureExpressionInfoContext(e,t,i){if(Object(r.j)(e))return void(this._featureExpressionInfoContext=null);const a=e&&e.arcade;a&&Object(r.k)(t)&&Object(r.k)(i)?(this._featureExpressionInfoContext=Object(n.a)(e),Object(n.f)(this._featureExpressionInfoContext,Object(n.c)(a.modules,t,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new s;return Object(r.k)(e)&&t.setFromElevationInfo(e),t}}},687:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(126),a=i(139);function n(e,t=!0){e.attributes.add(a.a.POSITION,"vec2"),t&&e.varyings.add("uv","vec2"),e.vertex.code.add(r.a`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      ${t?r.a`uv = position * 0.5 + vec2(0.5);`:""}
    }
  `)}},689:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return r}));var r,a,n=i(222),s=i(126);function o(e,t){const i=e.fragment;switch(i.code.add(s.a`struct ShadingNormalParameters {
vec3 normalView;
vec3 viewDirection;
} shadingParams;`),t.doubleSidedMode){case r.None:i.code.add(s.a`vec3 shadingNormal(ShadingNormalParameters params) {
return normalize(params.normalView);
}`);break;case r.View:i.code.add(s.a`vec3 shadingNormal(ShadingNormalParameters params) {
return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
}`);break;case r.WindingOrder:i.code.add(s.a`vec3 shadingNormal(ShadingNormalParameters params) {
return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
}`);break;default:Object(n.a)(t.doubleSidedMode);case r.COUNT:}}(a=r||(r={}))[a.None=0]="None",a[a.View=1]="View",a[a.WindingOrder=2]="WindingOrder",a[a.COUNT=3]="COUNT"},692:function(e,t,i){"use strict";i.d(t,"a",(function(){return p})),i.d(t,"b",(function(){return u}));var r=i(382),a=i(139),n=i(94),s=i(279);new s.a(a.a.POSITION,3,n.k.FLOAT,0,12),new s.a(a.a.POSITION,3,n.k.FLOAT,0,20),new s.a(a.a.UV0,2,n.k.FLOAT,12,20),new s.a(a.a.POSITION,3,n.k.FLOAT,0,32),new s.a(a.a.NORMAL,3,n.k.FLOAT,12,32),new s.a(a.a.UV0,2,n.k.FLOAT,24,32),new s.a(a.a.POSITION,3,n.k.FLOAT,0,16),new s.a(a.a.COLOR,4,n.k.UNSIGNED_BYTE,12,16);const o=[new s.a(a.a.POSITION,2,n.k.FLOAT,0,8)],c=[new s.a(a.a.POSITION,2,n.k.FLOAT,0,16),new s.a(a.a.UV0,2,n.k.FLOAT,8,16)];var l=i(162),d=i(203),h=i(164);function u(e,t=o,i=r.a,a=-1,s=1){let d=null;return d=t===c?new Float32Array([a,a,0,0,s,a,1,0,a,s,0,1,s,s,1,1]):new Float32Array([a,a,s,a,a,s,s,s]),new h.a(e,i,{geometry:t},{geometry:l.a.createVertex(e,n.D.STATIC_DRAW,d)})}function p(e){return new d.a(e,{target:n.A.TEXTURE_2D,pixelFormat:n.p.RGBA,dataType:n.q.UNSIGNED_BYTE,samplingMode:n.z.NEAREST,width:1,height:1},new Uint8Array([255,255,255,255]))}},703:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return n}));var r=i(126);function a(e){const t=r.a`vec3 decodeNormal(vec2 f) {
float z = 1.0 - abs(f.x) - abs(f.y);
return vec3(f + sign(f) * min(z, 0.0), z);
}`;e.fragment.code.add(t),e.vertex.code.add(t)}var n,s,o=i(139);function c(e,t){t.normalType===n.Attribute&&(e.attributes.add(o.a.NORMAL,"vec3"),e.vertex.code.add(r.a`vec3 normalModel() {
return normal;
}`)),t.normalType===n.CompressedAttribute&&(e.include(a),e.attributes.add(o.a.NORMALCOMPRESSED,"vec2"),e.vertex.code.add(r.a`vec3 normalModel() {
return decodeNormal(normalCompressed);
}`)),t.normalType===n.ScreenDerivative&&(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(r.a`vec3 screenDerivativeNormal(vec3 positionView) {
return normalize(cross(dFdx(positionView), dFdy(positionView)));
}`))}(s=n||(n={}))[s.Attribute=0]="Attribute",s[s.CompressedAttribute=1]="CompressedAttribute",s[s.Ground=2]="Ground",s[s.ScreenDerivative=3]="ScreenDerivative",s[s.COUNT=4]="COUNT"},713:function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return s})),i.d(t,"d",(function(){return o}));var r=i(495),a=i(139),n=i(604);const s=Object(r.a)().vec3f(a.a.POSITION),o=Object(r.a)().vec3f(a.a.POSITION).vec2f(a.a.UV0),c=Object(r.a)().vec3f(a.a.POSITION).vec4u8(a.a.COLOR);class l{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(a.a.POSITION).length}write(e,t,i,r){Object(n.d)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)}}},718:function(e,t,i){"use strict";i.d(t,"a",(function(){return d}));var r=i(103),a=i(83),n=i(97),s=i(137),o=i(664),c=i(643);const l=Object(a.m)(c.a);async function d(e,t,i){t=l(t);const a=Object(s.c)(e),c={...a.query,f:"json",...t.toJSON()},d=t.outSpatialReference,h=Object(n.c)(t.geometries[0]),u=Object(s.a)(c,i);return Object(r.default)(a.path+"/project",u).then((({data:{geometries:e}})=>Object(o.a)(e,h,d)))}},725:function(e,t,i){"use strict";function r(e,t,i){for(let r=0;r<i;++r)t[2*r]=e[r],t[2*r+1]=e[r]-t[2*r]}function a(e,t,i,a){for(let o=0;o<a;++o)n[0]=e[o],r(n,s,1),t[o]=s[0],i[o]=s[1]}i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return a}));const n=new Float64Array(1),s=new Float32Array(2)},726:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(94),a=i(279);function n(e,t=0){const i=e.stride;return e.fieldNames.filter((t=>{const i=e.fields.get(t).optional;return!(i&&i.glPadding)})).map((r=>{const n=e.fields.get(r),o=n.constructor.ElementCount,c=s(n.constructor.ElementType),l=n.offset,d=!(!n.optional||!n.optional.glNormalized);return new a.a(r,o,c,l,i,d,t)}))}function s(e){const t=o[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const o={u8:r.k.UNSIGNED_BYTE,u16:r.k.UNSIGNED_SHORT,u32:r.k.UNSIGNED_INT,i8:r.k.BYTE,i16:r.k.SHORT,i32:r.k.INT,f32:r.k.FLOAT}},730:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(126);function a(e){e.vertex.code.add(r.a`const float PI = 3.141592653589793;`),e.fragment.code.add(r.a`const float PI = 3.141592653589793;
const float LIGHT_NORMALIZATION = 1.0 / PI;
const float INV_PI = 0.3183098861837907;
const float HALF_PI = 1.570796326794897;`)}},731:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));var r=i(272),a=i(747),n=i(126);function s(e,t){const i=e.vertex.code;t.verticalOffsetEnabled?(e.vertex.uniforms.add("verticalOffset","vec4"),t.screenSizePerspectiveEnabled&&(e.include(a.a),e.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4")),i.add(n.a`
    vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
      float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
      ${t.viewingMode===r.a.Global?n.a`vec3 worldNormal = normalize(worldPos + localOrigin);`:n.a`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
      ${t.screenSizePerspectiveEnabled?n.a`
          float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
          float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:n.a`
          float verticalOffsetScreenHeight = verticalOffset.x;`}
      // Screen sized offset in world space, used for example for line callouts
      float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
      return worldNormal * worldOffset;
    }

    vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
      return worldPos + calculateVerticalOffset(worldPos, localOrigin);
    }
    `)):i.add(n.a`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)}function o(e,t,i){if(!t.verticalOffset)return;const r=function(e,t,i,r=c){return r.screenLength=e.screenLength,r.perDistance=Math.tan(.5*t)/(.5*i),r.minWorldLength=e.minWorldLength,r.maxWorldLength=e.maxWorldLength,r}(t.verticalOffset,i.camera.fovY,i.camera.fullViewport[3]),a=i.camera.pixelRatio||1;e.setUniform4f("verticalOffset",r.screenLength*a,r.perDistance,r.minWorldLength,r.maxWorldLength)}const c={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}},732:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(210),a=i(126);function n(e,t){t.output===r.a.Color&&t.receiveShadows?(e.varyings.add("linearDepth","float"),e.vertex.code.add(a.a`void forwardLinearDepth() { linearDepth = gl_Position.w; }`)):t.output===r.a.Depth||t.output===r.a.Shadow?(e.varyings.add("linearDepth","float"),e.vertex.uniforms.add("nearFar","vec2"),e.vertex.code.add(a.a`void forwardLinearDepth() {
linearDepth = (-position_view().z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)):e.vertex.code.add(a.a`void forwardLinearDepth() {}`)}},733:function(e,t,i){"use strict";i.d(t,"a",(function(){return v})),i.d(t,"b",(function(){return q})),i.d(t,"c",(function(){return g})),i.d(t,"d",(function(){return R})),i.d(t,"e",(function(){return O})),i.d(t,"f",(function(){return w})),i.d(t,"g",(function(){return j})),i.d(t,"h",(function(){return x})),i.d(t,"i",(function(){return D})),i.d(t,"j",(function(){return I})),i.d(t,"k",(function(){return y}));i(82);var r=i(87),a=i(116),n=i(485),s=i(147),o=i(200),c=i(117),l=i(109),d=i(584),h=i(499),u=i(423),p=i(360),f=i(526),b=i(288);const m=r.a.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");function g(e=z){return{plane:Object(u.d)(e.plane),origin:Object(l.d)(e.origin),basis1:Object(l.d)(e.basis1),basis2:Object(l.d)(e.basis2)}}function v(e,t=g()){return O(e.origin,e.basis1,e.basis2,t)}function O(e,t,i,r=g()){return Object(c.k)(r.origin,e),Object(c.k)(r.basis1,t),Object(c.k)(r.basis2,i),y(r),function(e,t){Math.abs(Object(c.h)(e.basis1,e.basis2)/(Object(c.p)(e.basis1)*Object(c.p)(e.basis2)))>1e-6&&m.warn(t,"Provided basis vectors are not perpendicular"),Math.abs(Object(c.h)(e.basis1,D(e)))>1e-6&&m.warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-Object(c.h)(D(e),e.origin)-e.plane[3])>1e-6&&m.warn(t,"Plane offset is not consistent with plane origin")}(r,"fromValues()"),r}function y(e){Object(u.i)(e.basis2,e.basis1,e.origin,e.plane)}function _(e,t,i){e!==i&&v(e,i);const r=Object(c.e)(b.d.get(),D(e),t);return Object(c.f)(i.origin,i.origin,r),i.plane[3]-=t,i}function j(e,t=g()){const i=(e[2]-e[0])/2,r=(e[3]-e[1])/2;return Object(c.w)(t.origin,e[0]+i,e[1]+r,0),Object(c.w)(t.basis1,i,0,0),Object(c.w)(t.basis2,0,r,0),Object(u.h)(0,0,1,0,t.plane),t}function x(e,t,i){return!!Object(u.m)(e.plane,t,i)&&M(e,i)}function S(e,t,i){const r=U.get();F(e,t,r,U.get());let n=Number.POSITIVE_INFINITY;for(const s of k){const o=N(e,s,G.get()),l=b.d.get();if(Object(u.k)(r,o,l)){const e=Object(c.v)(b.d.get(),t.origin,l),r=Math.abs(Object(a.b)(Object(c.h)(t.direction,e)));r<n&&(n=r,Object(c.k)(i,l))}}return n===Number.POSITIVE_INFINITY?T(e,t,i):i}function T(e,t,i){if(x(e,t,i))return i;const r=U.get(),a=U.get();F(e,t,r,a);let n=Number.POSITIVE_INFINITY;for(const s of k){const o=N(e,s,G.get()),l=b.d.get();if(Object(u.l)(r,o,l)){const e=Object(p.d)(t,l);if(!Object(u.o)(a,l))continue;e<n&&(n=e,Object(c.k)(i,l))}}return A(e,t.origin)<n&&C(e,t.origin,i),i}function C(e,t,i){const r=Object(u.r)(e.plane,t,b.d.get()),a=Object(h.i)(L(e,e.basis1),r,-1,1,b.d.get()),n=Object(h.i)(L(e,e.basis2),r,-1,1,b.d.get());return Object(c.j)(i,Object(c.f)(b.d.get(),a,n),e.origin),i}function E(e,t,i){const{origin:r,basis1:a,basis2:n}=e,s=Object(c.j)(b.d.get(),t,r),o=Object(f.d)(a,s),l=Object(f.d)(n,s),d=Object(f.d)(D(e),s);return Object(c.w)(i,o,l,d)}function A(e,t){const i=E(e,t,b.d.get()),{basis1:r,basis2:a}=e,n=Object(c.p)(r),s=Object(c.p)(a),o=Math.max(Math.abs(i[0])-n,0),l=Math.max(Math.abs(i[1])-s,0),d=i[2];return o*o+l*l+d*d}function w(e,t){return Math.sqrt(A(e,t))}function R(e,t){return Object(u.o)(e.plane,t)&&M(e,t)}function P(e,t){const i=-e.plane[3];return Object(f.d)(D(e),t)-i}function I(e,t,i,r){return e!==r&&v(e,r),Object(s.d)(W,t,i),Object(c.q)(r.basis1,e.basis1,W),Object(c.q)(r.basis2,e.basis2,W),y(r),r}function D(e){return Object(u.q)(e.plane)}function M(e,t){const i=Object(c.j)(b.d.get(),t,e.origin),r=Object(c.t)(e.basis1),a=Object(c.t)(e.basis2),n=Object(c.h)(e.basis1,i),s=Object(c.h)(e.basis2,i);return-n-r<0&&n-r<0&&-s-a<0&&s-a<0}function L(e,t){const i=G.get();return Object(c.k)(i.origin,e.origin),Object(c.k)(i.vector,t),i}function N(e,t,i){const{basis1:r,basis2:a,origin:n}=e,s=Object(c.e)(b.d.get(),r,t.origin[0]),o=Object(c.e)(b.d.get(),a,t.origin[1]);Object(c.f)(i.origin,s,o),Object(c.f)(i.origin,i.origin,n);const l=Object(c.e)(b.d.get(),r,t.direction[0]),d=Object(c.e)(b.d.get(),a,t.direction[1]);return Object(c.e)(i.vector,Object(c.f)(l,l,d),2),i}function F(e,t,i,r){const a=D(e);Object(u.i)(a,t.direction,t.origin,i),Object(u.i)(Object(u.q)(i),a,t.origin,r)}const z={plane:Object(u.d)(),origin:Object(l.h)(0,0,0),basis1:Object(l.h)(1,0,0),basis2:Object(l.h)(0,1,0)},U=new n.a(u.d),G=new n.a(h.d),V=Object(l.f)(),B=new n.a((()=>({origin:null,basis1:null,basis2:null,plane:null}))),k=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],H=Object(o.d)(),W=Object(o.d)(),q=Object.freeze({__proto__:null,BoundedPlaneClass:class{constructor(){this.plane=Object(u.d)(),this.origin=Object(l.f)(),this.basis1=Object(l.f)(),this.basis2=Object(l.f)()}},create:g,wrap:function(e,t,i){const r=B.get();return r.origin=e,r.basis1=t,r.basis2=i,r.plane=Object(u.u)(0,0,0,0),y(r),r},copy:v,copyWithoutVerify:function(e,t){Object(c.k)(t.origin,e.origin),Object(c.k)(t.basis1,e.basis1),Object(c.k)(t.basis2,e.basis2),Object(u.c)(t.plane,e.plane)},fromValues:O,updateUnboundedPlane:y,elevate:_,setExtent:function(e,t,i){return j(t,i),_(i,P(e,e.origin),i),i},fromAABoundingRect:j,intersectRay:x,intersectRayClosestSilhouette:function(e,t,i){if(x(e,t,i))return i;const r=S(e,t,b.d.get());return Object(c.f)(i,t.origin,Object(c.e)(b.d.get(),t.direction,Object(c.m)(t.origin,r)/Object(c.p)(t.direction))),i},closestPointOnSilhouette:S,closestPoint:T,projectPoint:C,projectPointLocal:E,distance2:A,distance:w,distanceToSilhouette:function(e,t){let i=Number.NEGATIVE_INFINITY;for(const r of k){const a=N(e,r,G.get()),n=Object(h.e)(a,t);n>i&&(i=n)}return Math.sqrt(i)},extrusionContainsPoint:R,axisAt:function(e,t,i,r){return function(e,t,i){switch(t){case d.a.X:Object(c.k)(i,e.basis1),Object(c.r)(i,i);break;case d.a.Y:Object(c.k)(i,e.basis2),Object(c.r)(i,i);break;case d.a.Z:Object(c.k)(i,D(e))}return i}(e,i,r)},altitudeAt:P,setAltitudeAt:function(e,t,i,r){const a=P(e,t),n=Object(c.e)(V,D(e),i-a);return Object(c.f)(r,t,n),r},equals:function(e,t){return Object(c.o)(e.basis1,t.basis1)&&Object(c.o)(e.basis2,t.basis2)&&Object(c.o)(e.origin,t.origin)},transform:function(e,t,i){return e!==i&&v(e,i),Object(s.a)(H,t),Object(s.t)(H,H),Object(c.q)(i.basis1,e.basis1,H),Object(c.q)(i.basis2,e.basis2,H),Object(c.q)(Object(u.q)(i.plane),Object(u.q)(e.plane),H),Object(c.q)(i.origin,e.origin,t),Object(u.s)(i.plane,i.plane,i.origin),i},rotate:I,normal:D,UP:z})},734:function(e,t,i){"use strict";i.d(t,"a",(function(){return b})),i.d(t,"b",(function(){return O})),i.d(t,"c",(function(){return v}));var r=i(85),a=i(233),n=i(367),s=i(147),o=i(200),c=i(543),l=i(462),d=i(117),h=i(446),u=i(109),p=i(257),f=i(498);class b{constructor(){this._transform=Object(o.d)(),this._transformInverse=new m({value:this._transform},s.a,o.d),this._transformInverseTranspose=new m(this._transformInverse,s.t,o.d),this._transformTranspose=new m({value:this._transform},s.t,o.d),this._transformInverseRotation=new m({value:this._transform},a.k,n.b)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){Object(s.c)(this._transform,e)}multiplyTransform(e){Object(s.m)(this._transform,this._transform,e)}set(e){Object(s.c)(this._transform,e),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,t){this.setTransformMatrix(e),this.multiplyTransform(t),this._invalidateLazyTransforms()}}class m{constructor(e,t,i){this.original=e,this.update=t,this.dirty=!0,this.transform=i()}invalidate(){this.dirty=!0}get value(){return this.dirty&&(this.update(this.transform,this.original.value),this.dirty=!1),this.transform}}const g=new class{constructor(e=0){this.offset=e,this.sphere=Object(f.c)(),this.tmpVertex=Object(u.f)()}applyToVertex(e,t,i){const r=this.objectTransform.transform;let a=r[0]*e+r[4]*t+r[8]*i+r[12],n=r[1]*e+r[5]*t+r[9]*i+r[13],s=r[2]*e+r[6]*t+r[10]*i+r[14];const o=this.offset/Math.sqrt(a*a+n*n+s*s);a+=a*o,n+=n*o,s+=s*o;const c=this.objectTransform.inverse;return this.tmpVertex[0]=c[0]*a+c[4]*n+c[8]*s+c[12],this.tmpVertex[1]=c[1]*a+c[5]*n+c[9]*s+c[13],this.tmpVertex[2]=c[2]*a+c[6]*n+c[10]*s+c[14],this.tmpVertex}applyToMinMax(e,t){const i=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*i,e[1]+=e[1]*i,e[2]+=e[2]*i;const r=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*r,t[1]+=t[1]*r,t[2]+=t[2]*r}applyToAabb(e){const t=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;const i=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*i,e[4]+=e[4]*i,e[5]+=e[5]*i,e}applyToBoundingSphere(e){const t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=this.offset/t;return this.sphere[0]=e[0]+e[0]*i,this.sphere[1]=e[1]+e[1]*i,this.sphere[2]=e[2]+e[2]*i,this.sphere[3]=e[3]+e[3]*this.offset/t,this.sphere}};function v(e){return Object(r.k)(e)?(g.offset=e,g):null}new class{constructor(e=0){this.offset=e,this.componentLocalOriginLength=0,this.tmpVertex=Object(u.f)(),this.mbs=Object(p.e)(),this.obb={center:Object(u.f)(),halfSize:Object(h.b)(),quaternion:null}}set localOrigin(e){this.componentLocalOriginLength=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}applyToVertex(e,t,i){const r=e,a=t,n=i+this.componentLocalOriginLength,s=this.offset/Math.sqrt(r*r+a*a+n*n);return this.tmpVertex[0]=e+r*s,this.tmpVertex[1]=t+a*s,this.tmpVertex[2]=i+n*s,this.tmpVertex}applyToAabb(e){const t=e[0],i=e[1],r=e[2]+this.componentLocalOriginLength,a=e[3],n=e[4],s=e[5]+this.componentLocalOriginLength,o=this.offset/Math.sqrt(t*t+i*i+r*r);e[0]+=t*o,e[1]+=i*o,e[2]+=r*o;const c=this.offset/Math.sqrt(a*a+n*n+s*s);return e[3]+=a*c,e[4]+=n*c,e[5]+=s*c,e}applyToMbs(e){const t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=this.offset/t;return this.mbs[0]=e[0]+e[0]*i,this.mbs[1]=e[1]+e[1]*i,this.mbs[2]=e[2]+e[2]*i,this.mbs[3]=e[3]+e[3]*this.offset/t,this.mbs}applyToObb(e){const t=e.center,i=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);this.obb.center[0]=t[0]+t[0]*i,this.obb.center[1]=t[1]+t[1]*i,this.obb.center[2]=t[2]+t[2]*i,Object(d.u)(this.obb.halfSize,e.halfSize,e.quaternion),Object(d.f)(this.obb.halfSize,this.obb.halfSize,e.center);const r=this.offset/Math.sqrt(this.obb.halfSize[0]*this.obb.halfSize[0]+this.obb.halfSize[1]*this.obb.halfSize[1]+this.obb.halfSize[2]*this.obb.halfSize[2]);return this.obb.halfSize[0]+=this.obb.halfSize[0]*r,this.obb.halfSize[1]+=this.obb.halfSize[1]*r,this.obb.halfSize[2]+=this.obb.halfSize[2]*r,Object(d.j)(this.obb.halfSize,this.obb.halfSize,e.center),Object(c.a)(y,e.quaternion),Object(d.u)(this.obb.halfSize,this.obb.halfSize,y),this.obb.halfSize[0]*=this.obb.halfSize[0]<0?-1:1,this.obb.halfSize[1]*=this.obb.halfSize[1]<0?-1:1,this.obb.halfSize[2]*=this.obb.halfSize[2]<0?-1:1,this.obb.quaternion=e.quaternion,this.obb}};new class{constructor(e=0){this.offset=e,this.tmpVertex=Object(u.f)()}applyToVertex(e,t,i){const r=e+this.localOrigin[0],a=t+this.localOrigin[1],n=i+this.localOrigin[2],s=this.offset/Math.sqrt(r*r+a*a+n*n);return this.tmpVertex[0]=e+r*s,this.tmpVertex[1]=t+a*s,this.tmpVertex[2]=i+n*s,this.tmpVertex}applyToAabb(e){const t=e[0]+this.localOrigin[0],i=e[1]+this.localOrigin[1],r=e[2]+this.localOrigin[2],a=e[3]+this.localOrigin[0],n=e[4]+this.localOrigin[1],s=e[5]+this.localOrigin[2],o=this.offset/Math.sqrt(t*t+i*i+r*r);e[0]+=t*o,e[1]+=i*o,e[2]+=r*o;const c=this.offset/Math.sqrt(a*a+n*n+s*s);return e[3]+=a*c,e[4]+=n*c,e[5]+=s*c,e}};const O="terrain",y=Object(l.b)()},746:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return o})),i.d(t,"c",(function(){return s}));var r=i(85),a=i(797);class n{constructor(e,t=null,i=0){this.array=e,this.spatialReference=t,this.offset=i}}function s(e){return"array"in e}function o(e,t,i="ground"){if(Object(a.a)(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,i);if(s(t)){let a=t.offset;return e.getElevation(t.array[a++],t.array[a++],t.array[a]||0,Object(r.t)(t.spatialReference,e.spatialReference),i)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,i)}},747:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s}));var r=i(126),a=i(434);function n(e){e.vertex.code.add(r.a`float screenSizePerspectiveMinSize(float size, vec4 factor) {
float nonZeroSize = 1.0 - step(size, 0.0);
return (
factor.z * (
1.0 +
nonZeroSize *
2.0 * factor.w / (
size + (1.0 - nonZeroSize)
)
)
);
}`),e.vertex.code.add(r.a`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),e.vertex.code.add(r.a`vec4 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec4 params) {
return vec4(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z,
params.w
);
}`),e.vertex.code.add(r.a`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec4 factor) {
return max(mix(size * factor.x, size, factor.y), screenSizePerspectiveMinSize(size, factor));
}`),e.vertex.code.add(r.a`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),e.vertex.code.add(r.a`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec4 factor) {
return mix(size * clamp(factor.x, screenSizePerspectiveMinSize(size.y, factor) / max(1e-5, size.y), 1.0), size, factor.y);
}`),e.vertex.code.add(r.a`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function s(e,t){if(t.screenSizePerspective){Object(a.a)(t.screenSizePerspective,e,"screenSizePerspective");const i=t.screenSizePerspectiveAlignment||t.screenSizePerspective;Object(a.a)(i,e,"screenSizePerspectiveAlignment")}}},748:function(e,t,i){"use strict";i.d(t,"a",(function(){return _}));var r=i(87),a=i(116),n=i(85),s=i(102),o=i(147),c=i(200),l=i(151),d=i(219),h=i(117),u=i(109),p=i(271),f=i(257),b=i(620),m=i(360),g=i(526),v=i(272),O=i(278);const y=r.a.getLogger("esri.views.3d.webgl-engine.lib.Camera");class _{constructor(e=null,t=null,i=null){this._viewUp=Object(u.f)(),this._viewForward=Object(u.f)(),this._viewRight=Object(u.f)(),this._ray=Object(m.c)(),this._viewport=Object(f.g)(0,0,1,1),this._padding=Object(f.g)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Object(d.e)(1,1e3),this._viewDirty=!0,this._viewMatrix=Object(c.d)(),this._projectionDirty=!0,this._projectionMatrix=Object(c.d)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Object(c.d)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Object(c.d)(),this._frustumDirty=!0,this._frustum=Object(b.c)(),this._fullViewport=Object(f.e)(),this.pixelRatio=1,this.relativeElevation=0,Object(n.k)(e)&&Object(h.k)(this._ray.origin,e),this._center=Object(n.k)(t)?Object(u.d)(t):Object(u.f)(),this._up=Object(n.k)(i)?Object(u.d)(i):Object(u.h)(0,0,1)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center)}get ray(){return Object(h.j)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){Object(o.c)(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get x(){return this._viewport[0]}set x(e){e+=this._padding[E.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(e){e+=this._padding[E.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[E.RIGHT]+this._padding[E.LEFT]}set fullWidth(e){this.width=e-(this._padding[E.RIGHT]+this._padding[E.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[E.TOP]+this._padding[E.BOTTOM]}set fullHeight(e){this.height=e-(this._padding[E.TOP]+this._padding[E.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[E.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[E.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){this._padding[E.TOP]===e[E.TOP]&&this._padding[E.RIGHT]===e[E.RIGHT]&&this._padding[E.BOTTOM]===e[E.BOTTOM]&&this._padding[E.LEFT]===e[E.LEFT]||(this._viewport[0]+=e[E.LEFT]-this._padding[E.LEFT],this._viewport[1]+=e[E.BOTTOM]-this._padding[E.BOTTOM],this._viewport[2]-=e[E.RIGHT]+e[E.LEFT]-(this._padding[E.RIGHT]+this._padding[E.LEFT]),this._viewport[3]-=e[E.TOP]+e[E.BOTTOM]-(this._padding[E.TOP]+this._padding[E.BOTTOM]),Object(p.c)(this._padding,e),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&(Object(o.m)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const e=this.width,t=this.height,i=this.near*Math.tan(this.fovY/2),r=i*this.aspect;Object(o.l)(this._projectionMatrix,-r*(1+2*this._padding[E.LEFT]/e),r*(1+2*this._padding[E.RIGHT]/e),-i*(1+2*this._padding[E.BOTTOM]/t),i*(1+2*this._padding[E.TOP]/t),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}set projectionMatrix(e){Object(o.c)(this._projectionMatrix,e),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(e){this._fov=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Object(O.b)(this._fov,this.width,this.height)}set fovX(e){this._fov=Object(O.d)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Object(O.c)(this._fov,this.width,this.height)}set fovY(e){this._fov=Object(O.e)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return Object(h.m)(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Object(o.a)(this._viewInverseTransposeMatrix,this.viewMatrix),Object(o.t)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){Object(h.k)(this._ray.origin,e.eye),Object(h.k)(this._center,e.center),Object(h.k)(this._up,e.up),Object(p.c)(this._viewport,e.viewport),Object(p.c)(this._padding,e.padding),Object(l.c)(this._nearFar,e.nearFar),this._fov=e.fov,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||(Object(o.c)(this._viewMatrix,e.viewMatrix),Object(h.k)(this._viewRight,e.viewRight),Object(h.k)(this._viewUp,e.viewUp),Object(h.k)(this._viewForward,e.viewForward)),t._projectionDirty?this._projectionDirty=!0:(Object(o.c)(this._projectionMatrix,e.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(Object(b.b)(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(Object(o.c)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Object(p.c)(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return(new _).copyFrom(this)}equals(e){return Object(h.o)(this.eye,e.eye)&&Object(h.o)(this._center,e.center)&&Object(h.o)(this._up,e.up)&&Object(p.g)(this._viewport,e.viewport)&&Object(p.g)(this._padding,e.padding)&&Object(l.e)(this._nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}almostEquals(e){if(this.pixelRatio!==e.pixelRatio||Math.abs(e.fov-this._fov)>=.001)return!1;const t=5e-4;Object(h.z)(S,e.eye,e.center),Object(h.z)(T,this.eye,this._center);const i=Object(h.h)(S,T),r=Object(h.A)(S),a=Object(h.A)(T);return i*i>=(1-1e-10)*r*a&&Object(h.B)(e.eye,this.eye)<Math.max(r,a)*t*t&&Object(p.i)(e.padding,this._padding)<.5&&Object(p.i)(e.viewport,this._viewport)<.5}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs(Object(g.d)(this.viewForward,Object(h.j)(S,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=Object(s.f)()){return e[0]=(this.padding[E.LEFT]+this.width/2)/this.pixelRatio,e[1]=(this.padding[E.TOP]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,i=.5){return e[0]=this.padding[E.LEFT]+this.width*t,e[1]=this.padding[E.BOTTOM]+this.height*i,e[2]=.5,e}setGLViewport(e){const t=this.viewport,i=this.padding;e.setViewport(t[0]-i[3],t[1]-i[2],t[2]+i[1]+i[3],t[3]+i[0]+i[2])}applyProjection(e,t,i=!1){e!==j&&Object(h.k)(j,e),j[3]=1,i&&(t[2]=-j[2]),Object(p.m)(j,j,this.projectionMatrix),Object(h.e)(j,j,1/Math.abs(j[3]));const r=this.fullViewport;return t[0]=Object(a.k)(0,r[0]+r[2],.5+.5*j[0]),t[1]=Object(a.k)(0,r[1]+r[3],.5+.5*j[1]),i||(t[2]=.5*(j[2]+1)),t}projectToScreen(e,t){this.projectToRenderScreen(e,C),this.renderToScreen(C,t)}projectToRenderScreen(e,t){if(j[0]=e[0],j[1]=e[1],j[2]=e[2],j[3]=1,Object(p.m)(j,j,this.viewProjectionMatrix),0===j[3])return null;Object(h.e)(j,j,1/Math.abs(j[3]));const i=this.fullViewport;return"x"in t?(t.x=Object(a.k)(0,i[0]+i[2],.5+.5*j[0]),t.y=Object(a.k)(0,i[1]+i[3],.5+.5*j[1])):(t[0]=Object(a.k)(0,i[0]+i[2],.5+.5*j[0]),t[1]=Object(a.k)(0,i[1]+i[3],.5+.5*j[1]),t.length>2&&(t[2]=.5*(j[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,C),t)}unprojectFromRenderScreen(e,t){if(Object(o.m)(x,this.projectionMatrix,this.viewMatrix),!Object(o.a)(x,x))return null;const i=this.fullViewport;return j[0]=2*(e[0]-i[0])/i[2]-1,j[1]=2*(e[1]-i[1])/i[3]-1,j[2]=2*e[2]-1,j[3]=1,Object(p.m)(j,j,x),0===j[3]?null:(t[0]=j[0]/j[3],t[1]=j[1]/j[3],t[2]=j[2]/j[3],t)}constrainWindowSize(e,t,i,r=i){const a=e*this.pixelRatio,n=t*this.pixelRatio,s=Math.max(a-i/2,0),o=Math.max(this.fullHeight-n-r/2,0),c=-Math.min(a-i/2,0),l=-Math.min(this.fullHeight-n-r/2,0);return[s,o,i-c- -Math.min(this.fullWidth-a-i/2,0),r-l- -Math.min(n-r/2,0)]}computeUp(e){e===v.a.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const i=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=i,t[1]=r,t}renderToScreen(e,t){const i=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;t[0]=i,t[1]=r}_computeUpGlobal(){Object(h.j)(S,this.center,this.eye);const e=Object(h.p)(this.center);e<1?(Object(h.w)(this._up,0,0,1),this._markViewDirty()):Math.abs(Object(h.h)(S,this.center))>.9999*Object(h.p)(S)*e||(Object(h.g)(this._up,S,this.center),Object(h.g)(this._up,this._up,S),Object(h.r)(this._up,this._up),this._markViewDirty())}_computeUpLocal(){Object(h.v)(S,this.eye,this.center),Math.abs(S[2])<=.9999&&(Object(h.e)(S,S,S[2]),Object(h.w)(this._up,-S[0],-S[1],1-S[2]),Object(h.r)(this._up,this._up),this._markViewDirty())}_compareAndSetView(e,t){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?Object(h.o)(e,t)||(Object(h.k)(t,e),this._markViewDirty()):y.warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(Object(b.d)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(Object(o.n)(this._viewMatrix,this.eye,this._center,this._up),Object(h.w)(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),Object(h.w)(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),Object(h.w)(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const j=Object(f.e)(),x=Object(c.d)(),S=Object(u.f)(),T=Object(u.f)(),C=Object(s.d)();var E,A;(A=E||(E={}))[A.TOP=0]="TOP",A[A.RIGHT=1]="RIGHT",A[A.BOTTOM=2]="BOTTOM",A[A.LEFT=3]="LEFT"},750:function(e,t,i){"use strict";i.d(t,"a",(function(){return H}));var r=i(222),a=i(88),n=i(138),s=i(116),o=i(85),c=i(91),l=i(549),d=i(98),h=i(819),u=i(528),p=i(163),f=i(157);let b;var m,g;(g=m||(m={}))[g.ETC1_RGB=0]="ETC1_RGB",g[g.ETC2_RGBA=1]="ETC2_RGBA",g[g.BC1_RGB=2]="BC1_RGB",g[g.BC3_RGBA=3]="BC3_RGBA",g[g.BC4_R=4]="BC4_R",g[g.BC5_RG=5]="BC5_RG",g[g.BC7_M6_RGB=6]="BC7_M6_RGB",g[g.BC7_M5_RGBA=7]="BC7_M5_RGBA",g[g.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",g[g.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",g[g.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",g[g.ATC_RGB=11]="ATC_RGB",g[g.ATC_RGBA=12]="ATC_RGBA",g[g.FXT1_RGB=17]="FXT1_RGB",g[g.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",g[g.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",g[g.ETC2_EAC_R11=20]="ETC2_EAC_R11",g[g.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",g[g.RGBA32=13]="RGBA32",g[g.RGB565=14]="RGB565",g[g.BGR565=15]="BGR565",g[g.RGBA4444=16]="RGBA4444";var v=i(94),O=i(203),y=i(647);let _=null,j=null;async function x(){return Object(o.j)(j)&&(j=function(){if(Object(o.j)(b)){const e=e=>Object(f.a)(`esri/libs/basisu/${e}`);b=Promise.all([i.e(241),i.e(260)]).then(i.bind(null,1344)).then((e=>e.b)).then((({default:t})=>t({locateFile:e}).then((e=>(e.initializeBasis(),delete e.then,e)))))}return b}(),_=await j),j}function S(e,t,i,r,a){const n=Object(y.b)(t?v.i.COMPRESSED_RGBA8_ETC2_EAC:v.i.COMPRESSED_RGB8_ETC2),s=a&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(i*r*n*s)}function T(e){return e.getNumImages()>=1&&!e.isUASTC()}function C(e){return e.getFaces()>=1&&e.isETC1S()}function E(e,t,i,r,a,n,s,o){const{compressedTextureETC:c,compressedTextureS3TC:l}=e.capabilities,[d,h]=c?r?[m.ETC2_RGBA,v.i.COMPRESSED_RGBA8_ETC2_EAC]:[m.ETC1_RGB,v.i.COMPRESSED_RGB8_ETC2]:l?r?[m.BC3_RGBA,v.i.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[m.BC1_RGB,v.i.COMPRESSED_RGB_S3TC_DXT1_EXT]:[m.RGBA32,v.p.RGBA],u=t.hasMipmap?i:Math.min(1,i),p=[];for(let m=0;m<u;m++)p.push(new Uint8Array(s(m,d))),o(m,d,p[m]);const f=p.length>1,b=f?v.z.LINEAR_MIPMAP_LINEAR:v.z.LINEAR,g={...t,samplingMode:b,hasMipmap:f,internalFormat:h,width:a,height:n};return new O.a(e,g,{type:"compressed",levels:p})}var A=i(560),w=i(544);const R=i(87).a.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),P=542327876,I=131072;function D(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const M=D("DXT1"),L=D("DXT3"),N=D("DXT5");function F(e,t,i){const{textureData:r,internalFormat:a,width:n,height:o}=function(e,t){const i=new Int32Array(e,0,31);if(i[0]!==P)return R.error("Invalid magic number in DDS header"),null;if(!(4&i[20]))return R.error("Unsupported format, must contain a FourCC code"),null;const r=i[21];let a,n;switch(r){case M:a=8,n=v.i.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case L:a=16,n=v.i.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case N:a=16,n=v.i.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return R.error("Unsupported FourCC code:",function(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}(r)),null}let o=1,c=i[4],l=i[3];0==(3&c)&&0==(3&l)||(R.warn("Rounding up compressed texture size to nearest multiple of 4."),c=c+3&-4,l=l+3&-4);const d=c,h=l;let u,p;i[2]&I&&!1!==t&&(o=Math.max(1,i[7])),1===o||Object(s.j)(c)&&Object(s.j)(l)||(R.warn("Ignoring mipmaps of non power of two sized compressed texture."),o=1);let f=i[1]+4;const b=[];for(let s=0;s<o;++s)p=(c+3>>2)*(l+3>>2)*a,u=new Uint8Array(e,f,p),b.push(u),f+=p,c=Math.max(1,c>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:b},internalFormat:n,width:d,height:h}}(i,t.hasMipmap);return t.samplingMode=r.levels.length>1?v.z.LINEAR_MIPMAP_LINEAR:v.z.LINEAR,t.hasMipmap=r.levels.length>1,t.internalFormat=a,t.width=n,t.height=o,new O.a(e,t,r)}var z,U,G=i(692),V=i(278),B=i(314),k=i(788);class H extends A.a{constructor(e,t){super(),this.data=e,this.type=w.a.Texture,this._glTexture=null,this._powerOfTwoStretchInfo=null,this._loadingPromise=null,this._loadingController=null,this.events=new n.a,this.params=t||{},this.params.mipmap=!1!==this.params.mipmap,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:v.B.REPEAT,t:v.B.REPEAT},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||p.e.STRETCH,this.estimatedTexMemRequired=H._estimateTexMemRequired(this.data,this.params),this._startPreload()}_startPreload(){const e=this.data;Object(o.j)(e)||(e instanceof HTMLVideoElement?this._startPreloadVideoElement(e):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){Object(d.v)(e.src)||"auto"===e.preload&&e.crossOrigin||(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src)}_startPreloadImageElement(e){Object(d.w)(e.src)||Object(d.v)(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}static _getDataDimensions(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}static _estimateTexMemRequired(e,t){if(Object(o.j)(e))return 0;if(Object(l.c)(e)||Object(l.k)(e))return t.encoding===H.KTX2_ENCODING?function(e,t){if(Object(o.j)(_))return e.byteLength;const i=new _.KTX2File(new Uint8Array(e)),r=C(i)?S(i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),t):0;return i.close(),i.delete(),r}(e,t.mipmap):t.encoding===H.BASIS_ENCODING?function(e,t){if(Object(o.j)(_))return e.byteLength;const i=new _.BasisFile(new Uint8Array(e)),r=T(i)?S(i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),t):0;return i.close(),i.delete(),r}(e,t.mipmap):e.byteLength;const{width:i,height:r}=e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement?H._getDataDimensions(e):t;return(t.mipmap?4/3:1)*i*r*(t.components||4)||0}dispose(){this.data=void 0}get width(){return this.params.width}get height(){return this.params.height}_createDescriptor(e){var t;return{target:v.A.TEXTURE_2D,pixelFormat:v.p.RGBA,dataType:v.q.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?v.z.LINEAR_MIPMAP_LINEAR:v.z.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:null!=(t=this.params.maxAnisotropy)?t:this.params.mipmap?e.parameters.maxMaxAnisotropy:1}}get glTexture(){return this._glTexture}load(e,t){if(Object(o.k)(this._glTexture))return this._glTexture;if(Object(o.k)(this._loadingPromise))return this._loadingPromise;const i=this.data;return Object(o.j)(i)?(this._glTexture=new O.a(e,this._createDescriptor(e),null),this._glTexture):"string"==typeof i?this._loadFromURL(e,t,i):i instanceof Image?this._loadFromImageElement(e,t,i):i instanceof HTMLVideoElement?this._loadFromVideoElement(e,t,i):i instanceof ImageData||i instanceof HTMLCanvasElement?this._loadFromImage(e,i,t):(Object(l.c)(i)||Object(l.k)(i))&&this.params.encoding===H.DDS_ENCODING?(this.data=void 0,this._loadFromDDSData(e,i)):(Object(l.c)(i)||Object(l.k)(i))&&this.params.encoding===H.KTX2_ENCODING?(this.data=void 0,this._loadFromKTX2(e,i)):(Object(l.c)(i)||Object(l.k)(i))&&this.params.encoding===H.BASIS_ENCODING?(this.data=void 0,this._loadFromBasis(e,i)):Object(l.k)(i)?this._loadFromPixelData(e,i):Object(l.c)(i)?this._loadFromPixelData(e,new Uint8Array(i)):null}get requiresFrameUpdates(){return this.data instanceof HTMLVideoElement}frameUpdate(e,t,i){if(!(this.data instanceof HTMLVideoElement)||Object(o.j)(this._glTexture))return i;if(this.data.readyState<z.HAVE_CURRENT_DATA||i===this.data.currentTime)return i;if(Object(o.k)(this._powerOfTwoStretchInfo)){const{framebuffer:i,vao:r,sourceTexture:a}=this._powerOfTwoStretchInfo;a.setData(this.data),this._drawStretchedTexture(e,t,i,r,a,this._glTexture)}else{const{width:e,height:t}=this.data,{width:i,height:r}=this._glTexture.descriptor;e!==i||t!==r?this._glTexture.updateData(0,0,0,Math.min(e,i),Math.min(t,r),this.data):this._glTexture.setData(this.data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.data.currentTime}_loadFromDDSData(e,t){return this._glTexture=F(e,this._createDescriptor(e),t),this._glTexture}_loadFromKTX2(e,t){return this._loadAsync((()=>async function(e,t,i){Object(o.j)(_)&&(_=await x());const r=new _.KTX2File(new Uint8Array(i));if(!C(r))return null;r.startTranscoding();const a=E(e,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),((e,t)=>r.getImageTranscodedSizeInBytes(e,0,0,t)),((e,t,i)=>r.transcodeImage(i,e,0,0,t,0,-1,-1)));return r.close(),r.delete(),a}(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromBasis(e,t){return this._loadAsync((()=>async function(e,t,i){Object(o.j)(_)&&(_=await x());const r=new _.BasisFile(new Uint8Array(i));if(!T(r))return null;r.startTranscoding();const a=E(e,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),((e,t)=>r.getImageTranscodedSizeInBytes(0,e,t)),((e,t,i)=>r.transcodeImage(i,0,e,t,0,0)));return r.close(),r.delete(),a}(e,this._createDescriptor(e),t).then((e=>(this._glTexture=e,e)))))}_loadFromPixelData(e,t){Object(V.a)(this.params.width>0&&this.params.height>0);const i=this._createDescriptor(e);return i.pixelFormat=1===this.params.components?v.p.LUMINANCE:3===this.params.components?v.p.RGB:v.p.RGBA,i.width=this.params.width,i.height=this.params.height,this._glTexture=new O.a(e,i,t),this._glTexture}_loadFromURL(e,t,i){return this._loadAsync((async r=>{const a=await Object(h.a)(i,{signal:r});return Object(c.t)(r),this._loadFromImage(e,a,t)}))}_loadFromImageElement(e,t,i){return i.complete?this._loadFromImage(e,i,t):this._loadAsync((async r=>{const a=await Object(u.a)(i,i.src,!1,r);return Object(c.t)(r),this._loadFromImage(e,a,t)}))}_loadFromVideoElement(e,t,i){return i.readyState>=z.HAVE_CURRENT_DATA?this._loadFromImage(e,i,t):this._loadFromVideoElementAsync(e,t,i)}_loadFromVideoElementAsync(e,t,i){return this._loadAsync((r=>new Promise(((n,s)=>{const l=()=>{i.removeEventListener("loadeddata",d),i.removeEventListener("error",h),Object(o.r)(u)},d=()=>{i.readyState>=z.HAVE_CURRENT_DATA&&(l(),n(this._loadFromImage(e,i,t)))},h=e=>{l(),s(e||new a.a("Failed to load video"))};i.addEventListener("loadeddata",d),i.addEventListener("error",h);const u=Object(c.o)(r,(()=>h(Object(c.d)())))}))))}_loadFromImage(e,t,i){const r=H._getDataDimensions(t);this.params.width=r.width,this.params.height=r.height;const a=this._createDescriptor(e);return a.pixelFormat=3===this.params.components?v.p.RGB:v.p.RGBA,!this._requiresPowerOfTwo(e,a)||Object(s.j)(r.width)&&Object(s.j)(r.height)?(a.width=r.width,a.height=r.height,this._glTexture=new O.a(e,a,t),this._glTexture):(this._glTexture=this._makePowerOfTwoTexture(e,t,r,a,i),this._glTexture)}_loadAsync(e){const t=new AbortController;this._loadingController=t;const i=e(t.signal);this._loadingPromise=i;const r=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===i&&(this._loadingPromise=null)};return i.then(r,r),i}_requiresPowerOfTwo(e,t){const i=v.B.CLAMP_TO_EDGE,r="number"==typeof t.wrapMode?t.wrapMode===i:t.wrapMode.s===i&&t.wrapMode.t===i;return!Object(k.a)(e.gl)&&(t.hasMipmap||!r)}_makePowerOfTwoTexture(e,t,i,a,n){const{width:o,height:c}=i,l=Object(s.l)(o),d=Object(s.l)(c);let h;switch(a.width=l,a.height=d,this.params.powerOfTwoResizeMode){case p.e.PAD:a.textureCoordinateScaleFactor=[o/l,c/d],h=new O.a(e,a),h.updateData(0,0,0,o,c,t);break;case p.e.STRETCH:case null:case void 0:h=this._stretchToPowerOfTwo(e,t,a,n());break;default:Object(r.a)(this.params.powerOfTwoResizeMode)}return a.hasMipmap&&h.generateMipmap(),h}_stretchToPowerOfTwo(e,t,i,r){const a=new O.a(e,i),n=new B.a(e,{colorTarget:v.y.TEXTURE,depthStencilTarget:v.m.NONE},a),s=new O.a(e,{target:v.A.TEXTURE_2D,pixelFormat:i.pixelFormat,dataType:v.q.UNSIGNED_BYTE,wrapMode:v.B.CLAMP_TO_EDGE,samplingMode:v.z.LINEAR,flipped:!!i.flipped,maxAnisotropy:8,preMultiplyAlpha:i.preMultiplyAlpha},t),o=Object(G.b)(e),c=e.getBoundFramebufferObject();return this._drawStretchedTexture(e,r,n,o,s,a),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:o,sourceTexture:s,framebuffer:n}:(o.dispose(!0),s.dispose(),n.detachColorTexture(),n.dispose()),e.bindFramebuffer(c),a}_drawStretchedTexture(e,t,i,r,a,n){e.bindFramebuffer(i);const s=e.getViewport();e.setViewport(0,0,n.descriptor.width,n.descriptor.height);const o=e.useTechnique(t);o.setUniform4f("uColor",1,1,1,1),o.bindTexture(a,"tex"),e.bindVAO(r),e.drawArrays(v.r.TRIANGLE_STRIP,0,Object(y.f)(r,"geometry")),e.bindFramebuffer(null),e.setViewport(s.x,s.y,s.width,s.height)}unload(){if(Object(o.k)(this._powerOfTwoStretchInfo)){const{framebuffer:e,vao:t,sourceTexture:i}=this._powerOfTwoStretchInfo;t.dispose(!0),i.dispose(),e.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if(Object(o.k)(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),Object(o.k)(this._loadingController)){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}}H.DDS_ENCODING="image/vnd-ms.dds",H.KTX2_ENCODING="image/ktx2",H.BASIS_ENCODING="image/x.basis",(U=z||(z={}))[U.HAVE_NOTHING=0]="HAVE_NOTHING",U[U.HAVE_METADATA=1]="HAVE_METADATA",U[U.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",U[U.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",U[U.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"},751:function(e,t,i){"use strict";i.d(t,"a",(function(){return A}));var r=i(210),a=i(163),n=i(545),s=i(621),o=i(335),c=i(445),l=i(411),d=i(713),h=i(434),u=i(79),p=i(301),f=i(420),b=i(356),m=i(501),g=i(388),v=i(404),O=i(419),y=i(382),_=i(389),j=i(654),x=i(828),S=i(355);class T extends v.a{initializeProgram(e){const t=T.shader.get(),i=this.configuration,r=t.build({output:i.output,oitEnabled:i.transparencyPassType===a.i.Color,attributeColor:i.vertexColors,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new _.a(e.rctx,r,y.a)}bindPass(e,t){Object(m.b)(this.program,t.camera.projectionMatrix),this.program.setUniform4fv("eColor",e.color),this.configuration.output===r.a.Highlight&&Object(f.b)(this.program,t),(this.configuration.output===r.a.Depth||t.multipassTerrainEnabled)&&this.program.setUniform2fv("nearFar",t.camera.nearFar),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(b.a)(this.program,t))}bindDraw(e){Object(m.c)(this.program,e),this.program.rebindTextures(),Object(p.c)(this.program,this.configuration,e)}_createPipeline(e,t){const i=this.configuration,n=e===a.i.NONE,s=e===a.i.FrontFace;return Object(S.f)({blending:i.output!==r.a.Color&&i.output!==r.a.Alpha||!i.transparent?null:n?c.d:Object(c.f)(e),culling:Object(S.b)(i.cullFace),depthTest:{func:Object(c.g)(e)},depthWrite:n||s?i.writeDepth&&S.d:null,colorWrite:S.c,stencilWrite:i.sceneHasOcludees?j.h:null,stencilTest:i.sceneHasOcludees?t?j.d:j.c:null,polygonOffset:n||s?i.polygonOffset&&C:Object(c.e)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}T.shader=new g.a(x.a,(()=>i.e(321).then(i.bind(null,1346))));const C={factor:1,units:1};class E extends O.a{constructor(){super(...arguments),this.output=r.a.Color,this.cullFace=a.b.None,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparencyPassType=a.i.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}Object(u.a)([Object(O.b)({count:r.a.COUNT})],E.prototype,"output",void 0),Object(u.a)([Object(O.b)({count:a.b.COUNT})],E.prototype,"cullFace",void 0),Object(u.a)([Object(O.b)()],E.prototype,"slicePlaneEnabled",void 0),Object(u.a)([Object(O.b)()],E.prototype,"vertexColors",void 0),Object(u.a)([Object(O.b)()],E.prototype,"transparent",void 0),Object(u.a)([Object(O.b)()],E.prototype,"polygonOffset",void 0),Object(u.a)([Object(O.b)()],E.prototype,"enableOffset",void 0),Object(u.a)([Object(O.b)()],E.prototype,"writeDepth",void 0),Object(u.a)([Object(O.b)()],E.prototype,"sceneHasOcludees",void 0),Object(u.a)([Object(O.b)({count:a.i.COUNT})],E.prototype,"transparencyPassType",void 0),Object(u.a)([Object(O.b)()],E.prototype,"multipassTerrainEnabled",void 0),Object(u.a)([Object(O.b)()],E.prototype,"cullAboveGround",void 0);class A extends o.b{constructor(e){super(e,R),this.supportsEdges=!0,this.techniqueConfig=new E}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.enableOffset=t.camera.relativeElevation<c.b,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig}getPassParameters(){return this.parameters}intersect(e,t,i,r,a,n,s){Object(h.f)(e,t,r,a,n,void 0,s)}requiresSlot(e,t){return e===l.a.DRAPED_MATERIAL||(Object(s.b)(t)===r.a.Highlight?e===l.a.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?l.a.TRANSPARENT_MATERIAL:l.a.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:l.a.OPAQUE_MATERIAL))}createGLMaterial(e){return e.output===r.a.Color||e.output===r.a.Alpha||e.output===r.a.Highlight||e.output===r.a.Depth&&this.parameters.writeLinearDepth?new w(e):null}createBufferWriter(){return new d.a(d.b)}}class w extends n.a{updateParameters(e){return this.ensureTechnique(T,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output!==r.a.Color&&this._output!==r.a.Alpha||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}const R={color:[1,1,1,1],transparent:!1,writeDepth:!0,writeLinearDepth:!1,vertexColors:!1,polygonOffset:!1,slicePlaneEnabled:!1,cullFace:a.b.None,sceneHasOcludees:!1,...o.a}},752:function(e,t,i){"use strict";i.d(t,"a",(function(){return v})),i.d(t,"b",(function(){return _}));var r=i(85),a=i(147),n=i(200),s=i(117),o=i(109),c=i(271),l=i(257),d=i(360),h=i(272),u=i(608);i(733);function p(e){return Object(r.k)(e)&&Object(r.k)(e.dist)}Object(o.f)();var f=i(734),b=i(513);const m=1e-5;class g{constructor(e){this.options=new u.a,this._results=new O,this.transform=new f.a,this.tolerance=m,this.verticalOffset=null,this._ray=Object(d.c)(),this._rayEnd=Object(o.f)(),this._rayBeginTransformed=Object(o.f)(),this._rayEndTransformed=Object(o.f)(),this.viewingMode=null==e?h.a.Global:e}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,i){this.resetWithRay(Object(d.e)(e,t,this._ray),i)}resetWithRay(e,t){this.camera=t,e!==this._ray&&Object(d.b)(e,this._ray),0!==this.options.verticalOffset?this.viewingMode===h.a.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,Object(s.f)(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,t,i,a,n){this.point=t,this.filterPredicate=a,this.tolerance=null==i?m:i;const s=Object(f.c)(this.verticalOffset);if(Object(r.k)(e)&&e.length>0){const t=n?e=>{n(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(const i of e){const e=i.getSpatialQueryAccelerator&&i.getSpatialQueryAccelerator();Object(r.k)(e)?(Object(r.k)(s)?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,s):e.forEachAlongRay(this._ray.origin,this._ray.direction,t),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t)):i.objects.forAll((e=>t(e)))}}this.sortResults()}intersectObject(e){const t=e.geometryRecords;if(!t)return;const i=e.transformation,a=Object(f.c)(this.verticalOffset);for(const o of t){const{geometry:t,material:c,instanceParameters:l}=o;if(Object(b.d)(l))continue;const d=t.id;this.transform.setAndInvalidateLazyTransforms(i,o.getShaderTransformation()),Object(s.q)(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),Object(s.q)(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const h=this.transform.transform;Object(r.k)(a)&&(a.objectTransform=this.transform),c.intersect(t,l,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,((t,i,a,s,o,c)=>{if(t>=0){if(Object(r.k)(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;if(s){if(null==this._results.hud.dist||t<this._results.hud.dist){const r={object:e,geometryId:d,triangleNr:a,center:c};this._results.hud.set(u.b.HUD,r,t,i,n.a,o)}return}const l=r=>r.set(u.b.OBJECT,{object:e,geometryId:d,triangleNr:a},t,i,h,o);if((null==this._results.min.drapedLayerOrder||o>=this._results.min.drapedLayerOrder)&&(null==this._results.min.dist||t<this._results.min.dist)&&l(this._results.min),this.options.store!==u.c.MIN&&(null==this._results.max.drapedLayerOrder||o<this._results.max.drapedLayerOrder)&&(null==this._results.max.dist||t>this._results.max.dist)&&l(this._results.max),this.options.store===u.c.ALL){const r=_(this._ray);r.set(u.b.OBJECT,{object:e,geometryId:d,triangleNr:a},t,i,h),this._results.all.push(r)}}}),o.shaderTransformation)}}sortResults(){this._results.all.sort(((e,t)=>e.dist!==t.dist?Object(r.t)(e.dist,0)-Object(r.t)(t.dist,0):e.drapedLayerOrder!==t.drapedLayerOrder?Object(r.t)(e.drapedLayerOrder,Number.MAX_VALUE)-Object(r.t)(t.drapedLayerOrder,Number.MAX_VALUE):Object(r.t)(t.drapedLayerGraphicOrder,Number.MIN_VALUE)-Object(r.t)(e.drapedLayerGraphicOrder,Number.MIN_VALUE)))}}function v(e){return new g(e)}class O{constructor(){this._min=new y(Object(d.c)()),this._max=new y(Object(d.c)()),this._hud=new y(Object(d.c)()),this._ground=new y(Object(d.c)())}get min(){return this._min}get max(){return this._max}get hud(){return this._hud}get ground(){return this._ground}init(e){this._min.init(e),this._max.init(e),this._hud.init(e),this._ground.init(e),this.all=[]}}class y{constructor(e){this.intersector=u.b.OBJECT,this.normal=Object(o.f)(),this.transformation=Object(n.d)(),this._ray=Object(d.c)(),this.init(e)}get ray(){return this._ray}get distanceInRenderSpace(){return Object(r.k)(this.dist)?(Object(s.e)(j,this.ray.direction,this.dist),Object(s.p)(j)):null}getIntersectionPoint(e){return!!p(this)&&(Object(s.e)(j,this.ray.direction,this.dist),Object(s.f)(e,this.ray.origin,j),!0)}getTransformedNormal(e){return Object(s.k)(x,this.normal),x[3]=0,Object(c.m)(x,x,this.transformation),Object(s.k)(e,x),Object(s.r)(e,e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=u.b.OBJECT,Object(d.b)(e,this._ray)}set(e,t,i,c,l,d,h){this.intersector=e,this.dist=i,Object(s.k)(this.normal,Object(r.t)(c,o.b)),Object(a.c)(this.transformation,Object(r.t)(l,n.a)),this.target=t,this.drapedLayerOrder=d,this.drapedLayerGraphicOrder=h}copy(e){Object(d.b)(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,Object(s.k)(this.normal,e.normal),Object(a.c)(this.transformation,e.transformation)}}function _(e){return new y(e)}const j=Object(o.f)(),x=Object(l.e)()},753:function(e,t,i){"use strict";var r;i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return a})),i.d(t,"c",(function(){return d})),function(e){e[e.OCCLUDED=0]="OCCLUDED",e[e.NOTOCCLUDED=1]="NOTOCCLUDED",e[e.BOTH=2]="BOTH",e[e.COUNT=3]="COUNT"}(r||(r={}));var a,n,s=i(747),o=i(126),c=i(139);function l(e,t){const i=e;i.include(s.a),i.attributes.add(c.a.POSITION,"vec3"),i.attributes.add(c.a.NORMAL,"vec3"),i.attributes.add(c.a.AUXPOS1,"vec4"),i.vertex.uniforms.add("proj","mat4"),i.vertex.uniforms.add("view","mat4"),i.vertex.uniforms.add("viewNormal","mat4"),i.vertex.uniforms.add("viewport","vec4"),i.vertex.uniforms.add("cameraPosition","vec3"),i.vertex.uniforms.add("polygonOffset","float"),i.vertex.uniforms.add("cameraGroundRelative","float"),i.vertex.uniforms.add("pixelRatio","float"),i.vertex.uniforms.add("perDistancePixelRatio","float"),i.vertex.uniforms.add("renderTransparentlyOccludedHUD","float"),t.verticalOffsetEnabled&&i.vertex.uniforms.add("verticalOffset","vec4"),t.screenSizePerspectiveEnabled&&i.vertex.uniforms.add("screenSizePerspectiveAlignment","vec4"),i.vertex.uniforms.add("hudVisibilityTexture","sampler2D"),i.vertex.constants.add("smallOffsetAngle","float",.984807753012208),i.vertex.code.add(o.a`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),i.vertex.code.add(o.a`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),t.isDraped||i.vertex.code.add(o.a`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`),i.vertex.code.add(o.a`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${t.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${t.screenSizePerspectiveEnabled&&(t.verticalOffsetEnabled||t.screenCenterOffsetUnitsEnabled===a.Screen)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${t.verticalOffsetEnabled?t.screenSizePerspectiveEnabled?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${t.verticalOffsetEnabled?o.a`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${t.screenCenterOffsetUnitsEnabled!==a.Screen?o.a`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${t.screenCenterOffsetUnitsEnabled===a.Screen?t.screenSizePerspectiveEnabled?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${t.screenCenterOffsetUnitsEnabled===a.Screen?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),i.vertex.code.add(o.a`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}function d(e,t){e.setUniform1f("renderTransparentlyOccludedHUD",t.renderTransparentlyOccludedHUD===r.OCCLUDED?1:t.renderTransparentlyOccludedHUD===r.NOTOCCLUDED?0:.75)}(n=a||(a={}))[n.World=0]="World",n[n.Screen=1]="Screen",n[n.COUNT=2]="COUNT"},754:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i(126);function a(e){const t=e.fragment.code;t.add(r.a`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)
{
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),t.add(r.a`float integratedRadiance(float cosTheta2, float roughness)
{
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),t.add(r.a`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)
{
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)}var n=i(502),s=i(730);function o(e,t){const i=e.fragment.code;e.include(s.a),t.pbrMode===n.a.Water||t.pbrMode===n.a.WaterOnIntegratedMesh?(i.add(r.a`
    struct PBRShadingWater
    {
        float NdotL;   // cos angle between normal and light direction
        float NdotV;   // cos angle between normal and view direction
        float NdotH;   // cos angle between normal and half vector
        float VdotH;   // cos angle between view direction and half vector
        float LdotH;   // cos angle between light direction and half vector
        float VdotN;   // cos angle between view direction and normal vector
    };

    float dtrExponent = ${t.useCustomDTRExponentForWater?"2.2":"2.0"};
    `),i.add(r.a`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),i.add(r.a`float normalDistributionWater(float NdotH, float roughness)
{
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),i.add(r.a`float geometricOcclusionKelemen(float LoH)
{
return 0.25 / (LoH * LoH);
}`),i.add(r.a`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)
{
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}
vec3 tonemapACES(const vec3 x) {
return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);
}`)):t.pbrMode!==n.a.Normal&&t.pbrMode!==n.a.Schematic||(e.include(a),i.add(r.a`struct PBRShadingInfo
{
float NdotL;
float NdotV;
float NdotH;
float VdotH;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),i.add(r.a`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),i.add(r.a`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`),i.add(r.a`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`),i.add(r.a`float gamutMapChanel(float x, vec2 p){
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),i.add(r.a`vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){
vec3 outColor;
vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));
outColor.x = gamutMapChanel(inColor.x, p) ;
outColor.y = gamutMapChanel(inColor.y, p) ;
outColor.z = gamutMapChanel(inColor.z, p) ;
return outColor;
}`))}},767:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return o})),i.d(t,"d",(function(){return d})),i.d(t,"e",(function(){return l}));var r=i(485),a=i(117),n=i(360);i(288);function s(e){return e?{ray:Object(n.c)(e.ray),c0:e.c0,c1:e.c1}:{ray:Object(n.c)(),c0:0,c1:Number.MAX_VALUE}}function o(e,t=s()){return Object(n.b)(e,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function c(e,t,i=s()){const r=Object(a.p)(e.vector);return Object(n.f)(e.origin,t,i.ray),i.c0=0,i.c1=r,i}function l(e,t){return h(e,e.c0,t)}function d(e,t){return h(e,e.c1,t)}function h(e,t,i){return Object(a.f)(i,e.ray.origin,Object(a.e)(i,e.ray.direction,t))}new r.a((()=>({c0:0,c1:0,ray:null})))},768:function(e,t,i){"use strict";i.d(t,"a",(function(){return c})),i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return o})),i.d(t,"d",(function(){return l}));var r=i(116);i(272);function a(e,t,i){const r=i.parameters,a=i.paddingPixelsOverride;return d.scale=Math.min(r.divisor/(t-r.offset),1),d.factor=function(e){return Math.abs(e*e*e)}(e),d.minPixelSize=r.minPixelSize,d.paddingPixels=a,d}function n(e,t){return 0===e?t.minPixelSize:t.minPixelSize*(1+2*t.paddingPixels/e)}function s(e,t){return Math.max(Object(r.k)(e*t.scale,e,t.factor),n(e,t))}function o(e,t,i,r){r.scale=function(e,t,i){const r=a(e,t,i);return r.minPixelSize=0,r.paddingPixels=0,s(1,r)}(e,t,i),r.factor=0,r.minPixelSize=i.parameters.minPixelSize,r.paddingPixels=i.paddingPixelsOverride}function c(e,t,i=[0,0]){const r=Math.min(Math.max(t.scale,n(e[1],t)/Math.max(1e-5,e[1])),1);return i[0]=e[0]*r,i[1]=e[1]*r,i}function l(e,t,i,r){return s(e,a(t,i,r))}Object(r.g)(10),Object(r.g)(12),Object(r.g)(70),Object(r.g)(40);const d={scale:0,factor:0,minPixelSize:0,paddingPixels:0}},770:function(e,t,i){"use strict";i.d(t,"a",(function(){return g})),i.d(t,"b",(function(){return m})),i.d(t,"c",(function(){return y})),i.d(t,"d",(function(){return O}));var r=i(210),a=i(301),n=i(945),s=i(622),o=i(410),c=i(894),l=i(356),d=i(730),h=i(397),u=i(464),p=i(126),f=i(297),b=i(139);const m=1;var g,v;function O(e){const t=new f.a,i=e.capType!==g.BUTT,v=e.capType===g.ROUND,O=e.stippleEnabled&&v,y=e.falloffEnabled||O,_=e.innerColorEnabled||v,j=e.stippleEnabled&&e.stippleScaleWithLineWidth||v,x=e.stippleEnabled&&e.stippleScaleWithLineWidth,S=e.stippleEnabled||v;return t.include(d.a),t.include(n.a,e),t.include(c.a,{...e,stippleRequiresStretchMeasure:!0}),e.output===r.a.Depth&&t.include(s.a,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("nearFar","vec2").add("pixelRatio","float").add("miterLimit","float").add("screenSize","vec2").add("inverseProjectionMatrix","mat4"),t.vertex.constants.add("LARGE_HALF_FLOAT","float",65500),t.attributes.add(b.a.POSITION,"vec3"),t.attributes.add(b.a.SUBDIVISIONFACTOR,"float"),t.attributes.add(b.a.UV0,"vec2"),t.attributes.add(b.a.AUXPOS1,"vec3"),t.attributes.add(b.a.AUXPOS2,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("linearDepth","float"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),j&&t.varyings.add("vLineWidth","float"),x&&t.varyings.add("vLineSizeInv","float"),_&&t.varyings.add("vLineDistance","float"),y&&t.varyings.add("vLineDistanceNorm","float"),e.falloffEnabled&&t.fragment.uniforms.add("falloff","float"),e.innerColorEnabled&&(t.fragment.uniforms.add("innerColor","vec4"),t.fragment.uniforms.add("innerWidth","float")),v&&(t.varyings.add("vSegmentSDF","float"),t.varyings.add("vReverseSegmentSDF","float")),t.vertex.code.add(p.a`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),t.vertex.code.add(p.a`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= screenSize / posNdc.w;
return posNdc;
}`),t.vertex.code.add(p.a`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${e.multipassTerrainEnabled?"depth = pos.z;":""}
      linearDepth = (-pos.z - nearFar[0]) / (nearFar[1] - nearFar[0]);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),t.vertex.code.add(p.a`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${j?p.a`vLineWidth = lineWidth;`:""}
      ${x?p.a`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);

      clipAndTransform(pos, prev, next, isStartVertex);

      vec2 left = (pos.xy - prev.xy);
      vec2 right = (next.xy - pos.xy);

      float leftLen = length(left);
      float rightLen = length(right);
  `),S&&t.vertex.code.add(p.a`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${v?p.a`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),t.vertex.code.add(p.a`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),e.roundJoins?t.vertex.code.add(p.a`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${e.stippleEnabled?p.a`min(1.0, subdivisionFactor * ${p.a.float((m+2)/(m+1))})`:p.a`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):t.vertex.code.add(p.a`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`),t.vertex.code.add(p.a`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${i?p.a`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),t.vertex.code.add(p.a`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${y||_?p.a`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${_?p.a`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${y?p.a`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),v&&t.vertex.code.add(p.a`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),e.stippleEnabled&&(e.draped||t.vertex.code.add(p.a`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),t.vertex.code.add(p.a`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),e.draped?t.vertex.code.add(p.a`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):t.vertex.code.add(p.a`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),t.vertex.code.add(p.a`
      float patternLength = ${e.stippleScaleWithLineWidth?"lineSize * ":""} stipplePatternPixelSize;

      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader
      vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);

      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);

      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)
      if (segmentLengthScreenDouble >= 0.001) {
        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the
        // original vertex positions, and slightly outside of that range at the displaced positions
        vec2 stippleDisplacement = pos.xy - segmentOrigin;
        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);

        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)
        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
      }

      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance
      vStippleDistanceLimits *= pos.w;
      vStippleDistance *= pos.w;

      // Disable stipple distance limits on caps
      vStippleDistanceLimits = isJoin ?
                                 vStippleDistanceLimits :
                                 isStartVertex ?
                                  vec2(-1e038, vStippleDistanceLimits.y) :
                                  vec2(vStippleDistanceLimits.x, 1e038);
    `)),t.vertex.code.add(p.a`
      // Convert back into NDC
      pos.xy = (pos.xy / screenSize) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${e.wireframe&&!e.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
    }
  }
  `),e.multipassTerrainEnabled&&(t.fragment.include(o.a),t.include(l.b,e)),t.include(a.a,e),t.fragment.uniforms.add("intrinsicColor","vec4"),t.fragment.include(u.a),t.fragment.code.add(p.a`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
  `),e.wireframe?t.fragment.code.add(p.a`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(v&&t.fragment.code.add(p.a`
      float sdf = min(vSegmentSDF, vReverseSegmentSDF);
      vec2 fragmentPosition = vec2(
        min(sdf, 0.0),
        vLineDistance
      ) * gl_FragCoord.w;

      float fragmentRadius = length(fragmentPosition);
      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

      if (capCoverage < ${p.a.float(h.c)}) {
        discard;
      }
    `),O?t.fragment.code.add(p.a`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${p.a.float(h.c)}, stippleCoverage);
      `):t.fragment.code.add(p.a`float stippleAlpha = getStippleAlpha();`),t.fragment.code.add(p.a`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);
vec4 color = intrinsicColor * vColor;`),e.innerColorEnabled&&t.fragment.code.add(p.a`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`),t.fragment.code.add(p.a`vec4 finalColor = blendStipple(color, stippleAlpha);`),e.falloffEnabled&&t.fragment.code.add(p.a`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`)),t.fragment.code.add(p.a`
    if (finalColor.a < ${p.a.float(h.c)}) {
      discard;
    }

    ${e.output===r.a.Alpha?p.a`gl_FragColor = vec4(finalColor.a);`:""}
    ${e.output===r.a.Color?p.a`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===r.a.Color&&e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${e.output===r.a.Highlight?p.a`gl_FragColor = vec4(1.0);`:""}
    ${e.output===r.a.Depth?p.a`outputDepth(linearDepth);`:""}
  }
  `),t}(v=g||(g={}))[v.BUTT=0]="BUTT",v[v.SQUARE=1]="SQUARE",v[v.ROUND=2]="ROUND",v[v.COUNT=3]="COUNT";const y=Object.freeze({__proto__:null,NUM_ROUND_JOIN_SUBDIVISIONS:m,get CapType(){return g},build:O})},773:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(126);function a(e,t){const i=e.fragment;t.receiveAmbientOcclusion?(i.uniforms.add("ssaoTex","sampler2D"),i.uniforms.add("viewportPixelSz","vec4"),i.code.add(r.a`float evaluateAmbientOcclusion() {
return 1.0 - texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
}
float evaluateAmbientOcclusionInverse() {
float ssao = texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
return viewportPixelSz.z < 0.0 ? 1.0 : ssao;
}`)):i.code.add(r.a`float evaluateAmbientOcclusion() { return 0.0; }
float evaluateAmbientOcclusionInverse() { return 1.0; }`)}},776:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r=i(138),a=i(124),n=i(85),s=i(212),o=i(163),c=i(560),l=i(544);const d=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"];var h=i(826);class u extends c.a{constructor(e,t=""){var i,n,c;super(),this.apiLayerUid=t,this.type=l.a.Layer,this.events=new r.a,this.isSliceable=!1,this._objects=new s.a,this._stageHandles=new a.a,this.apiLayerUid=t,this.isVisible=null==(i=null==e?void 0:e.isVisible)||i,this.isPickable=null==(n=null==e?void 0:e.isPickable)||n,this.updatePolicy=null!=(c=null==e?void 0:e.updatePolicy)?c:o.j.ASYNC}get objects(){return this._objects}destroy(){this.detachStage(),this._stage=null}attachStage(e){this.detachStage(),this._stage=e;for(const t of d)this._stageHandles.add(this.events.on(t,(i=>e.handleEvent(t,i))))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),Object(n.k)(this._octree)&&this._octree.add([e])}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),Object(n.k)(this._octree)&&this._octree.remove([e]))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),Object(n.k)(this._octree)&&this._octree.add(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),0!==t.length){for(const e of t)e.parentLayer=null;this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),Object(n.k)(this._octree)&&this._octree.remove(t)}}sync(){Object(n.k)(this._stage)&&this.updatePolicy!==o.j.SYNC&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){Object(n.k)(this._octree)&&this._octree.update(e,t)}getSpatialQueryAccelerator(){return Object(n.j)(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=Object(n.d)(this._octree)}_createOctree(){this._octree=new h.b((e=>e.boundingVolumeWorldSpace.bounds)),this._octree.add(this._objects.data,this._objects.length)}}},777:function(e,t,i){"use strict";i.d(t,"a",(function(){return Y}));var r=i(87),a=i(116),n=i(85),s=i(102),o=i(151),c=i(117),l=i(109),d=i(620),h=i(499),u=i(423),p=i(495),f=i(210),b=i(562),m=i(545),g=i(621),v=i(335),O=i(411),y=i(278),_=i(139),j=i(1001),x=i(513),S=i(770),T=i(79),C=i(147),E=i(288),A=i(301),w=i(420),R=i(356),P=i(623),I=i(501),D=i(388),M=i(404),L=i(419),N=i(163),F=i(445),z=i(389),U=i(654),G=i(94),V=i(355);const B=new Map([[_.a.POSITION,0],[_.a.SUBDIVISIONFACTOR,1],[_.a.UV0,2],[_.a.AUXPOS1,3],[_.a.AUXPOS2,4],[_.a.SIZE,6],[_.a.SIZEFEATUREATTRIBUTE,6],[_.a.COLOR,5],[_.a.COLORFEATUREATTRIBUTE,5],[_.a.OPACITYFEATUREATTRIBUTE,7]]);class k extends M.a{constructor(e,t,i){super(e,t,i),this.stippleTextureRepository=e.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==f.a.Highlight}initializeProgram(e){const t=k.shader.get(),i=this.configuration,r=t.build({oitEnabled:i.transparencyPassType===N.i.Color,output:i.output,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,draped:i.draped,stippleEnabled:this.stippleEnabled,stippleOffColorEnabled:i.stippleOffColorEnabled,stippleRequiresClamp:!0,stippleScaleWithLineWidth:i.stippleScaleWithLineWidth,stipplePreferContinuous:i.stipplePreferContinuous,capType:i.capType,roundJoins:i.roundJoins,vvColor:i.vvColor,vvSize:i.vvSize,vvInstancingEnabled:!0,vvOpacity:i.vvOpacity,falloffEnabled:i.falloffEnabled,innerColorEnabled:i.innerColorEnabled,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround,wireframe:i.wireframe});return new z.a(e.rctx,r,B)}destroy(){super.destroy(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,t){if(Object(I.b)(this.program,t.camera.projectionMatrix),this.configuration.output===f.a.Highlight&&Object(w.b)(this.program,t),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(R.a)(this.program,t)),this.program.setUniform1f("intrinsicWidth",e.width),this.program.setUniform4fv("intrinsicColor",e.color),this.program.setUniform1f("miterLimit","miter"!==e.join?0:e.miterLimit),this.program.setUniform2fv("nearFar",t.camera.nearFar),this.program.setUniform1f("pixelRatio",t.camera.pixelRatio),this.program.setUniform2f("screenSize",t.camera.fullViewport[2],t.camera.fullViewport[3]),Object(P.d)(this.program,e),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.stippleEnabled){const{pixelSize:i,sdfNormalizer:r,pixels:a}=Object(n.k)(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};if(this.program.setUniform1f("stipplePatternSDFNormalizer",r),this.program.setUniform1f("stipplePatternTextureSize",a),this.program.setUniform1f("stipplePatternPixelSize",i),this.program.setUniform1f("stipplePatternPixelSizeInv",1/i),this.configuration.draped?this.program.setUniform1f("worldToScreenRatio",1/t.screenToPCSRatio):this.program.setUniform1f("worldToScreenPerDistanceRatio",1/t.camera.perScreenPixelRatio),this.configuration.stippleOffColorEnabled){const t=Object(n.s)(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}}this.configuration.falloffEnabled&&this.program.setUniform1f("falloff",e.falloff),this.configuration.innerColorEnabled&&(this.program.setUniform4fv("innerColor",Object(n.t)(e.innerColor,e.color)),this.program.setUniform1f("innerWidth",e.innerWidth*t.camera.pixelRatio))}bindDraw(e){Object(I.c)(this.program,e),this.stippleEnabled&&!this.configuration.draped&&Object(I.a)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),Object(A.b)(this.program,this.configuration,e.slicePlane,{origin:e.origin,view:e.camera.viewMatrix}),this.program.setUniformMatrix4fv("inverseProjectionMatrix",Object(C.a)(E.a.get(),e.camera.projectionMatrix)),this.program.rebindTextures()}_makePipelineState(e,t){const i=this.configuration,r=e===N.i.NONE,a=e===N.i.FrontFace;return Object(V.f)({blending:i.output===f.a.Color||i.output===f.a.Alpha?r?F.d:Object(F.f)(e):null,depthTest:{func:Object(F.g)(e)},depthWrite:r?i.writeDepth&&V.d:Object(F.h)(e),colorWrite:V.c,stencilWrite:i.sceneHasOcludees?U.h:null,stencilTest:i.sceneHasOcludees?t?U.d:U.c:null,polygonOffset:r||a?i.polygonOffset&&H:F.a})}initializePipeline(){const e=this.configuration,t=e.polygonOffset&&H;return e.occluder&&(this._occluderPipelineTransparent=Object(V.f)({blending:F.d,polygonOffset:t,depthTest:U.a,depthWrite:null,colorWrite:V.c,stencilWrite:null,stencilTest:U.f}),this._occluderPipelineOpaque=Object(V.f)({blending:F.d,polygonOffset:t,depthTest:U.a,depthWrite:null,colorWrite:V.c,stencilWrite:U.g,stencilTest:U.e}),this._occluderPipelineMaskWrite=Object(V.f)({blending:null,polygonOffset:t,depthTest:U.b,depthWrite:null,colorWrite:null,stencilWrite:U.h,stencilTest:U.d})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?G.r.LINES:G.r.TRIANGLE_STRIP}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===O.a.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===O.a.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,t)}}k.shader=new D.a(S.c,(()=>i.e(335).then(i.bind(null,1343))));const H={factor:0,units:-4};class W extends L.a{constructor(){super(...arguments),this.output=f.a.Color,this.occluder=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.polygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.capType=S.a.BUTT,this.roundJoins=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.sceneHasOcludees=!1,this.transparencyPassType=N.i.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1,this.wireframe=!1}}Object(T.a)([Object(L.b)({count:f.a.COUNT})],W.prototype,"output",void 0),Object(T.a)([Object(L.b)()],W.prototype,"occluder",void 0),Object(T.a)([Object(L.b)()],W.prototype,"slicePlaneEnabled",void 0),Object(T.a)([Object(L.b)()],W.prototype,"transparent",void 0),Object(T.a)([Object(L.b)()],W.prototype,"polygonOffset",void 0),Object(T.a)([Object(L.b)()],W.prototype,"writeDepth",void 0),Object(T.a)([Object(L.b)()],W.prototype,"draped",void 0),Object(T.a)([Object(L.b)()],W.prototype,"stippleEnabled",void 0),Object(T.a)([Object(L.b)()],W.prototype,"stippleOffColorEnabled",void 0),Object(T.a)([Object(L.b)()],W.prototype,"stippleScaleWithLineWidth",void 0),Object(T.a)([Object(L.b)()],W.prototype,"stipplePreferContinuous",void 0),Object(T.a)([Object(L.b)({count:S.a.COUNT})],W.prototype,"capType",void 0),Object(T.a)([Object(L.b)()],W.prototype,"roundJoins",void 0),Object(T.a)([Object(L.b)()],W.prototype,"vvSize",void 0),Object(T.a)([Object(L.b)()],W.prototype,"vvColor",void 0),Object(T.a)([Object(L.b)()],W.prototype,"vvOpacity",void 0),Object(T.a)([Object(L.b)()],W.prototype,"falloffEnabled",void 0),Object(T.a)([Object(L.b)()],W.prototype,"innerColorEnabled",void 0),Object(T.a)([Object(L.b)()],W.prototype,"sceneHasOcludees",void 0),Object(T.a)([Object(L.b)({count:N.i.COUNT})],W.prototype,"transparencyPassType",void 0),Object(T.a)([Object(L.b)()],W.prototype,"multipassTerrainEnabled",void 0),Object(T.a)([Object(L.b)()],W.prototype,"cullAboveGround",void 0),Object(T.a)([Object(L.b)()],W.prototype,"wireframe",void 0);const q=r.a.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");var $,X;(X=$||($={}))[X.LEFT_JOIN_START=-2]="LEFT_JOIN_START",X[X.LEFT_JOIN_END=-1]="LEFT_JOIN_END",X[X.LEFT_CAP_START=-4]="LEFT_CAP_START",X[X.LEFT_CAP_END=-5]="LEFT_CAP_END",X[X.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",X[X.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",X[X.RIGHT_CAP_START=4]="RIGHT_CAP_START",X[X.RIGHT_CAP_END=5]="RIGHT_CAP_END";class Y extends v.b{constructor(e){super(e,Q),this._vertexAttributeLocations=B,this.techniqueConfig=new W,this.layout=this.createLayout()}isClosed(e,t){return te(this.parameters,e,t)}dispose(){}getPassParameters(){return this.parameters}getTechniqueConfig(e,t){this.techniqueConfig.output=e,this.techniqueConfig.draped=t.slot===O.a.DRAPED_MATERIAL;const i=Object(n.k)(this.parameters.stipplePattern);return this.techniqueConfig.stippleEnabled=i,this.techniqueConfig.stippleOffColorEnabled=i&&Object(n.k)(this.parameters.stippleOffColor),this.techniqueConfig.stippleScaleWithLineWidth=i&&this.parameters.stippleScaleWithLineWidth,this.techniqueConfig.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.roundJoins="round"===this.parameters.join,this.techniqueConfig.capType=this.parameters.cap,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.parameters.innerWidth>0&&Object(n.k)(this.parameters.innerColor),this.techniqueConfig.falloffEnabled=this.parameters.falloff>0,this.techniqueConfig.occluder=this.parameters.renderOccluded===v.c.OccludeAndTransparentStencil,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig.wireframe=this.parameters.wireframe,this.techniqueConfig}intersect(e,t,i,r,a,s,o,c,l){Object(n.k)(l)?this._intersectDrapedLineGeometry(e,r,l,s,o):this._intersectLineGeometry(e,t,i,r,o)}_intersectDrapedLineGeometry(e,t,i,r,n){if(!t.options.selectionMode)return;const s=e.vertexAttributes.get(_.a.POSITION).data,o=e.vertexAttributes.get(_.a.SIZE);let c=this.parameters.width;if(this.parameters.vvSizeEnabled){const t=e.vertexAttributes.get(_.a.SIZEFEATUREATTRIBUTE).data[0];c*=Object(a.e)(this.parameters.vvSizeOffset[0]+t*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else o&&(c*=o.data[0]);const l=r[0],d=r[1],h=(c/2+4)*e.screenToWorldRatio;let u=Number.MAX_VALUE,p=0;for(let f=0;f<s.length-5;f+=3){const e=s[f],t=s[f+1],i=l-e,r=d-t,n=s[f+3]-e,o=s[f+4]-t,c=Object(a.e)((n*i+o*r)/(n*n+o*o),0,1),h=n*c-i,b=o*c-r,m=h*h+b*b;m<u&&(u=m,p=f/3)}u<h*h&&n(i.dist,i.normal,p,!1)}_intersectLineGeometry(e,t,i,r,n){if(!r.options.selectionMode||Object(x.d)(t))return;if(!Object(y.g)(i))return void q.error("intersection assumes a translation-only matrix");const s=e.vertexAttributes,l=s.get(_.a.POSITION).data;let p=this.parameters.width;if(this.parameters.vvSizeEnabled){const e=s.get(_.a.SIZEFEATUREATTRIBUTE).data[0];p*=Object(a.e)(this.parameters.vvSizeOffset[0]+e*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else s.has(_.a.SIZE)&&(p*=s.get(_.a.SIZE).data[0]);const f=r.camera,b=se;Object(o.c)(b,r.point);const m=p*f.pixelRatio/2+4*f.pixelRatio;Object(c.w)(me[0],b[0]-m,b[1]+m,0),Object(c.w)(me[1],b[0]+m,b[1]+m,0),Object(c.w)(me[2],b[0]+m,b[1]-m,0),Object(c.w)(me[3],b[0]-m,b[1]-m,0);for(let a=0;a<4;a++)if(!f.unprojectFromRenderScreen(me[a],ge[a]))return;Object(u.f)(f.eye,ge[0],ge[1],ve),Object(u.f)(f.eye,ge[1],ge[2],Oe),Object(u.f)(f.eye,ge[2],ge[3],ye),Object(u.f)(f.eye,ge[3],ge[0],_e);let g=Number.MAX_VALUE,v=0;const O=ee(this.parameters,s,e.indices)?l.length-2:l.length-5;for(let a=0;a<O;a+=3){ie[0]=l[a]+i[12],ie[1]=l[a+1]+i[13],ie[2]=l[a+2]+i[14];const e=(a+3)%l.length;if(re[0]=l[e]+i[12],re[1]=l[e+1]+i[13],re[2]=l[e+2]+i[14],Object(u.t)(ve,ie)<0&&Object(u.t)(ve,re)<0||Object(u.t)(Oe,ie)<0&&Object(u.t)(Oe,re)<0||Object(u.t)(ye,ie)<0&&Object(u.t)(ye,re)<0||Object(u.t)(_e,ie)<0&&Object(u.t)(_e,re)<0)continue;if(f.projectToRenderScreen(ie,oe),f.projectToRenderScreen(re,ce),oe[2]<0&&ce[2]>0){Object(c.j)(ae,ie,re);const e=f.frustum,t=-Object(u.t)(e[d.a.NEAR],ie)/Object(c.h)(ae,Object(u.q)(e[d.a.NEAR]));Object(c.e)(ae,ae,t),Object(c.f)(ie,ie,ae),f.projectToRenderScreen(ie,oe)}else if(oe[2]>0&&ce[2]<0){Object(c.j)(ae,re,ie);const e=f.frustum,t=-Object(u.t)(e[d.a.NEAR],re)/Object(c.h)(ae,Object(u.q)(e[d.a.NEAR]));Object(c.e)(ae,ae,t),Object(c.f)(re,re,ae),f.projectToRenderScreen(re,ce)}else if(oe[2]<0&&ce[2]<0)continue;oe[2]=0,ce[2]=0;const t=Object(h.e)(Object(h.f)(oe,ce,he),b);t<g&&(g=t,Object(c.k)(le,ie),Object(c.k)(de,re),v=a/3)}const j=r.rayBegin,S=r.rayEnd;if(g<m*m){let e=Number.MAX_VALUE;if(Object(h.a)(Object(h.f)(le,de,he),Object(h.f)(j,S,ue),ne)){Object(c.j)(ne,ne,j);const t=Object(c.p)(ne);Object(c.e)(ne,ne,1/t),e=t/Object(c.m)(j,S)}n(e,ne,v,!1)}}computeAttachmentOrigin(e,t){const i=e.vertexAttributes;if(!i)return null;const r=e.indices,a=i.get(_.a.POSITION);return Object(b.a)(a,r?r.get(_.a.POSITION):null,r&&ee(this.parameters,i,r),t)}createLayout(){const e=Object(p.a)().vec3f(_.a.POSITION).f32(_.a.SUBDIVISIONFACTOR).vec2f(_.a.UV0).vec3f(_.a.AUXPOS1).vec3f(_.a.AUXPOS2);return this.parameters.vvSizeEnabled?e.f32(_.a.SIZEFEATUREATTRIBUTE):e.f32(_.a.SIZE),this.parameters.vvColorEnabled?e.f32(_.a.COLORFEATUREATTRIBUTE):e.vec4f(_.a.COLOR),this.parameters.vvOpacityEnabled&&e.f32(_.a.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new J(this.layout,this.parameters)}requiresSlot(e,t){if(e===O.a.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===v.c.OccludeAndTransparentStencil)return e===O.a.OPAQUE_MATERIAL||e===O.a.OCCLUDER_MATERIAL||e===O.a.TRANSPARENT_OCCLUDER_MATERIAL;const i=Object(g.b)(t);return i===f.a.Color||i===f.a.Alpha?e===(this.parameters.writeDepth?O.a.TRANSPARENT_MATERIAL:O.a.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===O.a.OPAQUE_MATERIAL}createGLMaterial(e){return e.output===f.a.Color||e.output===f.a.Alpha||e.output===f.a.Highlight||e.output===f.a.Depth?new Z(e):null}validateParameters(e){"miter"!==e.join&&(e.miterLimit=0),this._requiresTransparent(e)&&(e.transparent=!0)}_requiresTransparent(e){return!!((e.color&&e.color[3])<1||e.innerWidth>0&&this._colorRequiresTransparent(e.innerColor)||e.stipplePattern&&this._colorRequiresTransparent(e.stippleOffColor)||e.falloff>0)}_colorRequiresTransparent(e){return Object(n.k)(e)&&e[3]<1&&e[3]>0}}class Z extends m.a{updateParameters(e){return this.ensureTechnique(k,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output!==f.a.Color&&this._output!==f.a.Alpha||this._updateOccludeeState(e),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.getPassParameters(),e)}}const Q={width:0,color:[1,1,1,1],join:"miter",cap:S.a.BUTT,miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleOffColor:null,stippleScaleWithLineWidth:!1,stipplePreferContinuous:!0,slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1,wireframe:!1,...v.a,...j.a};class J{constructor(e,t){this.parameters=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const i=t.stipplePattern?1:0;switch(this.parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=S.b+i}}_isClosed(e){return ee(this.parameters,e.vertexAttributes,e.indices)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const t=e.indices.get(_.a.POSITION).length/2+1,i=this._isClosed(e);let r=i?2:4;return r+=((i?t:t-1)-(i?0:1))*(2*this.numJoinSubdivisions+4),r+=2,this.parameters.wireframe&&(r=2+4*(r-2)),r}write(e,t,i,r){var a;const n=pe,s=fe,o=be,l=t.vertexAttributes.get(_.a.POSITION).data,d=t.indices&&t.indices.get(_.a.POSITION),h=null==(a=t.vertexAttributes.get(_.a.DISTANCETOSTART))?void 0:a.data;d&&d.length!==2*(l.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let u=1,p=0;this.parameters.vvSizeEnabled?p=t.vertexAttributes.get(_.a.SIZEFEATUREATTRIBUTE).data[0]:t.vertexAttributes.has(_.a.SIZE)&&(u=t.vertexAttributes.get(_.a.SIZE).data[0]);let f=[1,1,1,1],b=0;this.parameters.vvColorEnabled?b=t.vertexAttributes.get(_.a.COLORFEATUREATTRIBUTE).data[0]:t.vertexAttributes.has(_.a.COLOR)&&(f=t.vertexAttributes.get(_.a.COLOR).data);let m=0;this.parameters.vvOpacityEnabled&&(m=t.vertexAttributes.get(_.a.OPACITYFEATUREATTRIBUTE).data[0]);const g=l.length/3,v=e.transformation,O=new Float32Array(i.buffer),y=this.vertexBufferLayout.stride/4;let j=r*y;const x=j;let S=0;const T=h?(e,t,i)=>S=h[i]:(e,t,i)=>S+=Object(c.m)(e,t),C=(e,t,i,r,a,n,s)=>{if(O[j++]=t[0],O[j++]=t[1],O[j++]=t[2],O[j++]=r,O[j++]=s,O[j++]=a,O[j++]=e[0],O[j++]=e[1],O[j++]=e[2],O[j++]=i[0],O[j++]=i[1],O[j++]=i[2],this.parameters.vvSizeEnabled?O[j++]=p:O[j++]=u,this.parameters.vvColorEnabled)O[j++]=b;else{const e=Math.min(4*n,f.length-4);O[j++]=f[e+0],O[j++]=f[e+1],O[j++]=f[e+2],O[j++]=f[e+3]}this.parameters.vvOpacityEnabled&&(O[j++]=m)};j+=y,Object(c.w)(s,l[0],l[1],l[2]),v&&Object(c.q)(s,s,v);const E=this._isClosed(t);if(E){const e=l.length-3;Object(c.w)(n,l[e],l[e+1],l[e+2]),v&&Object(c.q)(n,n,v)}else Object(c.w)(o,l[3],l[4],l[5]),v&&Object(c.q)(o,o,v),C(s,s,o,1,$.LEFT_CAP_START,0,0),C(s,s,o,1,$.RIGHT_CAP_START,0,0),Object(c.k)(n,s),Object(c.k)(s,o);const A=E?0:1,w=E?g:g-1;for(let _=A;_<w;_++){const e=(_+1)%g*3;Object(c.w)(o,l[e+0],l[e+1],l[e+2]),v&&Object(c.q)(o,o,v),T(n,s,_),C(n,s,o,0,$.LEFT_JOIN_END,_,S),C(n,s,o,0,$.RIGHT_JOIN_END,_,S);const t=this.numJoinSubdivisions;for(let i=0;i<t;++i){const e=(i+1)/(t+1);C(n,s,o,e,$.LEFT_JOIN_END,_,S),C(n,s,o,e,$.RIGHT_JOIN_END,_,S)}C(n,s,o,1,$.LEFT_JOIN_START,_,S),C(n,s,o,1,$.RIGHT_JOIN_START,_,S),Object(c.k)(n,s),Object(c.k)(s,o)}E?(Object(c.w)(o,l[3],l[4],l[5]),v&&Object(c.q)(o,o,v),S=T(n,s,w),C(n,s,o,0,$.LEFT_JOIN_END,A,S),C(n,s,o,0,$.RIGHT_JOIN_END,A,S)):(S=T(n,s,w),C(n,s,s,0,$.LEFT_CAP_END,w,S),C(n,s,s,0,$.RIGHT_CAP_END,w,S)),K(O,x+y,O,x,y),j=K(O,j-y,O,j,y),this.parameters.wireframe&&this._addWireframeVertices(i,x,j,y)}_addWireframeVertices(e,t,i,r){const a=new Float32Array(e.buffer,i*Float32Array.BYTES_PER_ELEMENT),n=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,i-t);let s=0;const o=e=>s=K(n,e,a,s,r);for(let c=0;c<n.length-1;c+=2*r)o(c),o(c+2*r),o(c+1*r),o(c+2*r),o(c+1*r),o(c+3*r)}}function K(e,t,i,r,a){for(let n=0;n<a;n++)i[r++]=e[t++];return r}function ee(e,t,i){return te(e,t.get(_.a.POSITION).data,i?i.get(_.a.POSITION):null)}function te(e,t,i){return!!e.isClosed&&(i?i.length>2:t.length>6)}const ie=Object(l.f)(),re=Object(l.f)(),ae=Object(l.f)(),ne=Object(l.f)(),se=Object(l.f)(),oe=Object(s.d)(),ce=Object(s.d)(),le=Object(l.f)(),de=Object(l.f)(),he=Object(h.d)(),ue=Object(h.d)(),pe=Object(l.f)(),fe=Object(l.f)(),be=Object(l.f)(),me=[Object(s.d)(),Object(s.d)(),Object(s.d)(),Object(s.d)()],ge=[Object(l.f)(),Object(l.f)(),Object(l.f)(),Object(l.f)()],ve=Object(u.d)(),Oe=Object(u.d)(),ye=Object(u.d)(),_e=Object(u.d)()},796:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(244);class a{constructor(e){this.channel=e,this.id=Object(r.a)()}}},797:function(e,t,i){"use strict";function r(e){return"point"===e.type}i.d(t,"a",(function(){return r}))},798:function(e,t,i){"use strict";i.d(t,"a",(function(){return c}));var r=i(79),a=i(100),n=i(81),s=(i(84),i(82),i(83),i(80));let o=class extends a.a{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1}};Object(r.a)([Object(n.b)()],o.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),Object(r.a)([Object(n.b)()],o.prototype,"SCENEVIEW_LOCKING_LOG",void 0),Object(r.a)([Object(n.b)()],o.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),Object(r.a)([Object(n.b)()],o.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),Object(r.a)([Object(n.b)()],o.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),Object(r.a)([Object(n.b)()],o.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),Object(r.a)([Object(n.b)()],o.prototype,"DECONFLICTOR_SHOW_GRID",void 0),Object(r.a)([Object(n.b)()],o.prototype,"LABELS_SHOW_BORDER",void 0),Object(r.a)([Object(n.b)()],o.prototype,"TEXT_SHOW_BASELINE",void 0),Object(r.a)([Object(n.b)()],o.prototype,"TEXT_SHOW_BORDER",void 0),Object(r.a)([Object(n.b)()],o.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),Object(r.a)([Object(n.b)()],o.prototype,"OVERLAY_SHOW_CENTER",void 0),Object(r.a)([Object(n.b)()],o.prototype,"SHOW_POI",void 0),Object(r.a)([Object(n.b)()],o.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),Object(r.a)([Object(n.b)()],o.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),Object(r.a)([Object(n.b)()],o.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),Object(r.a)([Object(n.b)()],o.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),Object(r.a)([Object(n.b)()],o.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),Object(r.a)([Object(n.b)()],o.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),Object(r.a)([Object(n.b)()],o.prototype,"I3S_TREE_SHOW_TILES",void 0),Object(r.a)([Object(n.b)()],o.prototype,"I3S_SHOW_MODIFICATIONS",void 0),Object(r.a)([Object(n.b)()],o.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),Object(r.a)([Object(n.b)()],o.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),Object(r.a)([Object(n.b)()],o.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),Object(r.a)([Object(n.b)()],o.prototype,"LINE_WIREFRAMES",void 0),o=Object(r.a)([Object(s.a)("esri.views.3d.support.DebugFlags")],o);const c=new o},799:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(502),a=i(126);function n(e,t){const i=e.fragment,n=void 0!==t.lightingSphericalHarmonicsOrder?t.lightingSphericalHarmonicsOrder:2;0===n?(i.uniforms.add("lightingAmbientSH0","vec3"),i.code.add(a.a`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
return ambientLight * (1.0 - ambientOcclusion);
}`)):1===n?(i.uniforms.add("lightingAmbientSH_R","vec4"),i.uniforms.add("lightingAmbientSH_G","vec4"),i.uniforms.add("lightingAmbientSH_B","vec4"),i.code.add(a.a`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec4 sh0 = vec4(
0.282095,
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y
);
vec3 ambientLight = vec3(
dot(lightingAmbientSH_R, sh0),
dot(lightingAmbientSH_G, sh0),
dot(lightingAmbientSH_B, sh0)
);
return ambientLight * (1.0 - ambientOcclusion);
}`)):2===n&&(i.uniforms.add("lightingAmbientSH0","vec3"),i.uniforms.add("lightingAmbientSH_R1","vec4"),i.uniforms.add("lightingAmbientSH_G1","vec4"),i.uniforms.add("lightingAmbientSH_B1","vec4"),i.uniforms.add("lightingAmbientSH_R2","vec4"),i.uniforms.add("lightingAmbientSH_G2","vec4"),i.uniforms.add("lightingAmbientSH_B2","vec4"),i.code.add(a.a`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
vec4 sh1 = vec4(
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y,
1.092548 * normal.x * normal.y
);
vec4 sh2 = vec4(
1.092548 * normal.y * normal.z,
0.315392 * (3.0 * normal.z * normal.z - 1.0),
1.092548 * normal.x * normal.z,
0.546274 * (normal.x * normal.x - normal.y * normal.y)
);
ambientLight += vec3(
dot(lightingAmbientSH_R1, sh1),
dot(lightingAmbientSH_G1, sh1),
dot(lightingAmbientSH_B1, sh1)
);
ambientLight += vec3(
dot(lightingAmbientSH_R2, sh2),
dot(lightingAmbientSH_G2, sh2),
dot(lightingAmbientSH_B2, sh2)
);
return ambientLight * (1.0 - ambientOcclusion);
}`),t.pbrMode!==r.a.Normal&&t.pbrMode!==r.a.Schematic||i.code.add(a.a`const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);
vec3 calculateAmbientRadiance(float ambientOcclusion)
{
vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
}`))}},800:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(126);function a(e){const t=e.fragment;t.uniforms.add("lightingMainDirection","vec3"),t.uniforms.add("lightingMainIntensity","vec3"),t.uniforms.add("lightingFixedFactor","float"),t.uniforms.add("lightingSpecularStrength","float"),t.uniforms.add("lightingEnvironmentStrength","float"),t.code.add(r.a`vec3 evaluateMainLighting(vec3 normal_global, float shadowing) {
float dotVal = clamp(dot(normal_global, lightingMainDirection), 0.0, 1.0);
dotVal = mix(dotVal, 1.0, lightingFixedFactor);
return lightingMainIntensity * ((1.0 - shadowing) * dotVal);
}`)}},802:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(126),a=i(139);function n(e){e.attributes.add(a.a.POSITION,"vec3"),e.vertex.code.add(r.a`vec3 positionModel() { return position; }`)}},804:function(e,t,i){"use strict";i.d(t,"a",(function(){return Q})),i.d(t,"b",(function(){return te}));var r=i(85),a=i(367),n=i(117),s=i(109),o=i(272),c=i(495),l=i(210),d=i(689),h=i(397),u=i(163),p=i(856),f=i(335),b=i(445),m=i(567),g=i(411),v=i(139),O=i(734),y=i(604),_=i(434),j=i(79),x=i(87),S=i(301),T=i(830),C=i(703),E=i(639),A=i(731),w=i(420),R=i(356),P=i(502),I=i(625),D=i(623),M=i(831),L=i(501),N=i(388),F=i(404),z=i(419),U=i(382),G=i(389),V=i(654),B=i(1012),k=i(94),H=i(355);const W=x.a.getLogger("esri.views.3d.webgl-engine.shaders.DefaultTechnique");class q extends F.a{initializeProgram(e){const t=q.shader.get(),i=this.configuration,r=t.build({oitEnabled:i.transparencyPassType===u.i.Color,output:i.output,viewingMode:e.viewingMode,receiveShadows:i.receiveShadows,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:i.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:i.symbolColors,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,instanced:i.instanced,instancedColor:i.instancedColor,instancedDoublePrecision:i.instancedDoublePrecision,pbrMode:i.usePBR?i.isSchematic?P.a.Schematic:P.a.Normal:P.a.Disabled,hasMetalnessAndRoughnessTexture:i.hasMetalnessAndRoughnessTexture,hasEmissionTexture:i.hasEmissionTexture,hasOcclusionTexture:i.hasOcclusionTexture,hasNormalTexture:i.hasNormalTexture,hasColorTexture:i.hasColorTexture,hasModelTransformation:i.hasModelTransformation,receiveAmbientOcclusion:i.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:i.normalsTypeDerivate?C.b.ScreenDerivative:C.b.Attribute,doubleSidedMode:i.doubleSidedMode,vertexTangents:i.vertexTangents,attributeTextureCoordinates:i.hasMetalnessAndRoughnessTexture||i.hasEmissionTexture||i.hasOcclusionTexture||i.hasNormalTexture||i.hasColorTexture?E.b.Default:E.b.None,textureAlphaPremultiplied:i.textureAlphaPremultiplied,attributeColor:i.vertexColors,screenSizePerspectiveEnabled:i.screenSizePerspective,verticalOffsetEnabled:i.verticalOffset,offsetBackfaces:i.offsetBackfaces,doublePrecisionRequiresObfuscation:Object(M.b)(e.rctx),alphaDiscardMode:i.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new G.a(e.rctx,r,U.a)}bindPass(e,t){var i,a;Object(L.b)(this.program,t.camera.projectionMatrix);const n=this.configuration.output;this.configuration.hasModelTransformation&&(Object(r.k)(e.modelTransformation)?this.program.setUniformMatrix4fv("model",e.modelTransformation):W.warnOnce("hasModelTransformation true, but no modelTransformation found.")),(this.configuration.output===l.a.Depth||t.multipassTerrainEnabled||n===l.a.Shadow)&&this.program.setUniform2fv("nearFar",t.camera.nearFar),t.multipassTerrainEnabled&&(this.program.setUniform2fv("inverseViewport",t.inverseViewport),Object(R.a)(this.program,t)),n===l.a.Alpha&&(this.program.setUniform1f("opacity",e.opacity),this.program.setUniform1f("layerOpacity",e.layerOpacity),this.program.setUniform4fv("externalColor",e.externalColor),this.program.setUniform1i("colorMixMode",_.b[e.colorMixMode])),n===l.a.Color?(t.lighting.setUniforms(this.program,!1,t.hasFillLights),this.program.setUniform3fv("ambient",e.ambient),this.program.setUniform3fv("diffuse",e.diffuse),this.program.setUniform4fv("externalColor",e.externalColor),this.program.setUniform1i("colorMixMode",_.b[e.colorMixMode]),this.program.setUniform1f("opacity",e.opacity),this.program.setUniform1f("layerOpacity",e.layerOpacity),this.configuration.usePBR&&Object(P.c)(this.program,e,this.configuration.isSchematic)):n===l.a.Highlight&&Object(w.b)(this.program,t),Object(D.c)(this.program,e),Object(A.b)(this.program,e,t),Object(_.a)(e.screenSizePerspective,this.program,"screenSizePerspectiveAlignment"),e.textureAlphaMode!==u.a.Mask&&e.textureAlphaMode!==u.a.MaskBlend||this.program.setUniform1f("textureAlphaCutoff",e.textureAlphaCutoff),null==(i=t.shadowMap)||i.bind(this.program),null==(a=t.ssaoHelper)||a.bind(this.program,t.camera)}bindDraw(e){const t=this.configuration.instancedDoublePrecision?Object(s.h)(e.camera.viewInverseTransposeMatrix[3],e.camera.viewInverseTransposeMatrix[7],e.camera.viewInverseTransposeMatrix[11]):e.origin;Object(L.d)(this.program,t,e.camera.viewMatrix),this.program.rebindTextures(),(this.configuration.output===l.a.Color||this.configuration.output===l.a.Alpha||this.configuration.output===l.a.Depth&&this.configuration.screenSizePerspective||this.configuration.output===l.a.Normal&&this.configuration.screenSizePerspective||this.configuration.output===l.a.Highlight&&this.configuration.screenSizePerspective)&&Object(L.a)(this.program,t,e.camera.viewInverseTransposeMatrix),this.configuration.output===l.a.Normal&&this.program.setUniformMatrix4fv("viewNormal",e.camera.viewInverseTransposeMatrix),this.configuration.instancedDoublePrecision&&Object(T.b)(this.program,t),Object(S.b)(this.program,this.configuration,e.slicePlane,{origin:t}),this.configuration.output===l.a.Color&&Object(I.d)(this.program,e,t)}_convertDepthTestFunction(e){return e===u.c.Lequal?k.h.LEQUAL:k.h.LESS}_setPipeline(e,t){const i=this.configuration,r=e===u.i.NONE,a=e===u.i.FrontFace;return Object(H.f)({blending:i.output!==l.a.Color&&i.output!==l.a.Alpha||!i.transparent?null:r?b.d:Object(b.f)(e),culling:$(i)&&Object(H.b)(i.cullFace),depthTest:{func:Object(b.g)(e,this._convertDepthTestFunction(i.customDepthTest))},depthWrite:r||a?i.writeDepth&&H.d:null,colorWrite:H.c,stencilWrite:i.sceneHasOcludees?V.h:null,stencilTest:i.sceneHasOcludees?t?V.d:V.c:null,polygonOffset:r||a?null:Object(b.e)(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipeline(this.configuration.transparencyPassType,!0),this._setPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}function $(e){return e.cullFace?e.cullFace!==u.b.None:!e.slicePlaneEnabled&&!e.transparent&&!e.doubleSidedMode}q.shader=new N.a(B.a,(()=>i.e(323).then(i.bind(null,1358))));class X extends z.a{constructor(){super(...arguments),this.output=l.a.Color,this.alphaDiscardMode=u.a.Opaque,this.doubleSidedMode=d.b.None,this.isSchematic=!1,this.vertexColors=!1,this.offsetBackfaces=!1,this.symbolColors=!1,this.vvSize=!1,this.vvColor=!1,this.verticalOffset=!1,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.sliceHighlightDisabled=!1,this.receiveAmbientOcclusion=!1,this.screenSizePerspective=!1,this.textureAlphaPremultiplied=!1,this.hasColorTexture=!1,this.usePBR=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.instanced=!1,this.instancedColor=!1,this.instancedDoublePrecision=!1,this.vertexTangents=!1,this.normalsTypeDerivate=!1,this.writeDepth=!0,this.sceneHasOcludees=!1,this.transparent=!1,this.enableOffset=!0,this.cullFace=u.b.None,this.transparencyPassType=u.i.NONE,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1,this.hasModelTransformation=!1,this.customDepthTest=u.c.Less}}Object(j.a)([Object(z.b)({count:l.a.COUNT})],X.prototype,"output",void 0),Object(j.a)([Object(z.b)({count:u.a.COUNT})],X.prototype,"alphaDiscardMode",void 0),Object(j.a)([Object(z.b)({count:d.b.COUNT})],X.prototype,"doubleSidedMode",void 0),Object(j.a)([Object(z.b)()],X.prototype,"isSchematic",void 0),Object(j.a)([Object(z.b)()],X.prototype,"vertexColors",void 0),Object(j.a)([Object(z.b)()],X.prototype,"offsetBackfaces",void 0),Object(j.a)([Object(z.b)()],X.prototype,"symbolColors",void 0),Object(j.a)([Object(z.b)()],X.prototype,"vvSize",void 0),Object(j.a)([Object(z.b)()],X.prototype,"vvColor",void 0),Object(j.a)([Object(z.b)()],X.prototype,"verticalOffset",void 0),Object(j.a)([Object(z.b)()],X.prototype,"receiveShadows",void 0),Object(j.a)([Object(z.b)()],X.prototype,"slicePlaneEnabled",void 0),Object(j.a)([Object(z.b)()],X.prototype,"sliceHighlightDisabled",void 0),Object(j.a)([Object(z.b)()],X.prototype,"receiveAmbientOcclusion",void 0),Object(j.a)([Object(z.b)()],X.prototype,"screenSizePerspective",void 0),Object(j.a)([Object(z.b)()],X.prototype,"textureAlphaPremultiplied",void 0),Object(j.a)([Object(z.b)()],X.prototype,"hasColorTexture",void 0),Object(j.a)([Object(z.b)()],X.prototype,"usePBR",void 0),Object(j.a)([Object(z.b)()],X.prototype,"hasMetalnessAndRoughnessTexture",void 0),Object(j.a)([Object(z.b)()],X.prototype,"hasEmissionTexture",void 0),Object(j.a)([Object(z.b)()],X.prototype,"hasOcclusionTexture",void 0),Object(j.a)([Object(z.b)()],X.prototype,"hasNormalTexture",void 0),Object(j.a)([Object(z.b)()],X.prototype,"instanced",void 0),Object(j.a)([Object(z.b)()],X.prototype,"instancedColor",void 0),Object(j.a)([Object(z.b)()],X.prototype,"instancedDoublePrecision",void 0),Object(j.a)([Object(z.b)()],X.prototype,"vertexTangents",void 0),Object(j.a)([Object(z.b)()],X.prototype,"normalsTypeDerivate",void 0),Object(j.a)([Object(z.b)()],X.prototype,"writeDepth",void 0),Object(j.a)([Object(z.b)()],X.prototype,"sceneHasOcludees",void 0),Object(j.a)([Object(z.b)()],X.prototype,"transparent",void 0),Object(j.a)([Object(z.b)()],X.prototype,"enableOffset",void 0),Object(j.a)([Object(z.b)({count:u.b.COUNT})],X.prototype,"cullFace",void 0),Object(j.a)([Object(z.b)({count:u.i.COUNT})],X.prototype,"transparencyPassType",void 0),Object(j.a)([Object(z.b)()],X.prototype,"multipassTerrainEnabled",void 0),Object(j.a)([Object(z.b)()],X.prototype,"cullAboveGround",void 0),Object(j.a)([Object(z.b)()],X.prototype,"hasModelTransformation",void 0),Object(j.a)([Object(z.b)({count:u.c.COUNT})],X.prototype,"customDepthTest",void 0);var Y=i(1013);class Z extends q{initializeProgram(e){const t=Z.shader.get(),i=this.configuration,r=t.build({oitEnabled:i.transparencyPassType===u.i.Color,output:i.output,viewingMode:e.viewingMode,receiveShadows:i.receiveShadows,slicePlaneEnabled:i.slicePlaneEnabled,sliceHighlightDisabled:i.sliceHighlightDisabled,sliceEnabledForVertexPrograms:!1,symbolColor:i.symbolColors,vvSize:i.vvSize,vvColor:i.vvColor,vvInstancingEnabled:!0,instanced:i.instanced,instancedColor:i.instancedColor,instancedDoublePrecision:i.instancedDoublePrecision,pbrMode:i.usePBR?P.a.Normal:P.a.Disabled,hasMetalnessAndRoughnessTexture:!1,hasEmissionTexture:!1,hasOcclusionTexture:!1,hasNormalTexture:!1,hasColorTexture:i.hasColorTexture,hasModelTransformation:!1,receiveAmbientOcclusion:i.receiveAmbientOcclusion,useCustomDTRExponentForWater:!1,normalType:C.b.Attribute,doubleSidedMode:d.b.WindingOrder,vertexTangents:!1,attributeTextureCoordinates:i.hasColorTexture?E.b.Default:E.b.None,textureAlphaPremultiplied:i.textureAlphaPremultiplied,attributeColor:i.vertexColors,screenSizePerspectiveEnabled:i.screenSizePerspective,verticalOffsetEnabled:i.verticalOffset,offsetBackfaces:i.offsetBackfaces,doublePrecisionRequiresObfuscation:Object(M.b)(e.rctx),alphaDiscardMode:i.alphaDiscardMode,supportsTextureAtlas:!1,multipassTerrainEnabled:i.multipassTerrainEnabled,cullAboveGround:i.cullAboveGround});return new G.a(e.rctx,r,U.a)}}Z.shader=new N.a(Y.a,(()=>i.e(319).then(i.bind(null,1359))));class Q extends f.b{constructor(e){super(e,K),this.supportsEdges=!0,this.techniqueConfig=new X,this.vertexBufferLayout=function(e){const t=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId,i=Object(c.a)().vec3f(v.a.POSITION).vec3f(v.a.NORMAL);return e.vertexTangents&&i.vec4f(v.a.TANGENT),t&&i.vec2f(v.a.UV0),e.vertexColors&&i.vec4u8(v.a.COLOR),e.symbolColors&&i.vec4u8(v.a.SYMBOLCOLOR),i}(this.parameters),this.instanceBufferLayout=e.instanced?te(this.parameters):null}isVisibleInPass(e){return e!==m.a.MATERIAL_DEPTH_SHADOWMAP_ALL&&e!==m.a.MATERIAL_DEPTH_SHADOWMAP_DEFAULT&&e!==m.a.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||this.parameters.castShadows}isVisible(){const e=this.parameters;if(!super.isVisible()||0===e.layerOpacity)return!1;const t=e.instanced,i=e.vertexColors,r=e.symbolColors,a=!!t&&t.indexOf("color")>-1,n=e.vvColorEnabled,s="replace"===e.colorMixMode,o=e.opacity>0,c=e.externalColor&&e.externalColor[3]>0;return i&&(a||n||r)?!!s||o:i?s?c:o:a||n||r?!!s||o:s?c:o}getTechniqueConfig(e,t){return this.techniqueConfig.output=e,this.techniqueConfig.hasNormalTexture=!!this.parameters.normalTextureId,this.techniqueConfig.hasColorTexture=!!this.parameters.textureId,this.techniqueConfig.vertexTangents=this.parameters.vertexTangents,this.techniqueConfig.instanced=!!this.parameters.instanced,this.techniqueConfig.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.verticalOffset=null!==this.parameters.verticalOffset,this.techniqueConfig.screenSizePerspective=null!==this.parameters.screenSizePerspective,this.techniqueConfig.slicePlaneEnabled=this.parameters.slicePlaneEnabled,this.techniqueConfig.sliceHighlightDisabled=this.parameters.sliceHighlightDisabled,this.techniqueConfig.alphaDiscardMode=this.parameters.textureAlphaMode,this.techniqueConfig.normalsTypeDerivate="screenDerivative"===this.parameters.normals,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,Object(r.k)(this.parameters.customDepthTest)&&(this.techniqueConfig.customDepthTest=this.parameters.customDepthTest),this.techniqueConfig.sceneHasOcludees=this.parameters.sceneHasOcludees,this.techniqueConfig.cullFace=this.parameters.slicePlaneEnabled?u.b.None:this.parameters.cullFace,this.techniqueConfig.multipassTerrainEnabled=t.multipassTerrainEnabled,this.techniqueConfig.cullAboveGround=t.cullAboveGround,this.techniqueConfig.hasModelTransformation=Object(r.k)(this.parameters.modelTransformation),e!==l.a.Color&&e!==l.a.Alpha||(this.techniqueConfig.vertexColors=this.parameters.vertexColors,this.techniqueConfig.symbolColors=this.parameters.symbolColors,this.parameters.treeRendering?this.techniqueConfig.doubleSidedMode=d.b.WindingOrder:this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?d.b.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?d.b.WindingOrder:d.b.None,this.techniqueConfig.instancedColor=!!this.parameters.instanced&&this.parameters.instanced.indexOf("color")>-1,this.techniqueConfig.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this.techniqueConfig.receiveAmbientOcclusion=!!t.ssaoEnabled&&this.parameters.receiveSSAO,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this.techniqueConfig.usePBR=this.parameters.usePBR,this.techniqueConfig.hasMetalnessAndRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this.techniqueConfig.hasEmissionTexture=!!this.parameters.emissiveTextureId,this.techniqueConfig.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this.techniqueConfig.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this.techniqueConfig.isSchematic=this.parameters.usePBR&&this.parameters.isSchematic,this.techniqueConfig.transparencyPassType=t.transparencyPassType,this.techniqueConfig.enableOffset=t.camera.relativeElevation<b.b),this.techniqueConfig}intersect(e,t,i,r,a,s,c){if(null!==this.parameters.verticalOffset){const e=r.camera;Object(n.w)(oe,i[12],i[13],i[14]);let t=null;switch(r.viewingMode){case o.a.Global:t=Object(n.r)(ne,oe);break;case o.a.Local:t=Object(n.k)(ne,ae)}let c=0;if(null!==this.parameters.verticalOffset){const i=Object(n.j)(ce,oe,e.eye),r=Object(n.p)(i),a=Object(n.e)(i,i,1/r);let s=null;this.parameters.screenSizePerspective&&(s=Object(n.h)(t,a)),c+=Object(_.i)(e,r,this.parameters.verticalOffset,s,this.parameters.screenSizePerspective)}Object(n.e)(t,t,c),Object(n.x)(se,t,r.transform.inverseRotation),a=Object(n.j)(ie,a,se),s=Object(n.j)(re,s,se)}Object(_.f)(e,t,r,a,s,Object(O.c)(r.verticalOffset),c)}requiresSlot(e){return e===(this.parameters.transparent?this.parameters.writeDepth?g.a.TRANSPARENT_MATERIAL:g.a.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:g.a.OPAQUE_MATERIAL)||e===g.a.DRAPED_MATERIAL}createGLMaterial(e){return e.output===l.a.Color||e.output===l.a.Alpha||e.output===l.a.Depth||e.output===l.a.Normal||e.output===l.a.Shadow||e.output===l.a.Highlight?new J(e):null}createBufferWriter(){return new ee(this.vertexBufferLayout,this.instanceBufferLayout)}}class J extends p.a{constructor(e){super({...e,...e.material.parameters})}updateParameters(e){const t=this._material.parameters;return this.updateTexture(t.textureId),this.ensureTechnique(t.treeRendering?Z:q,e)}_updateShadowState(e){e.shadowMappingEnabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMappingEnabled})}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.sceneHasOcludees&&this._material.setParameters({sceneHasOcludees:e.hasOccludees})}beginSlot(e){return this._output!==l.a.Color&&this._output!==l.a.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this.updateParameters(e)}bind(e,t){t.bindPass(this._material.parameters,e),this.bindTextures(t.program)}}const K={textureId:void 0,initTextureTransparent:!1,isSchematic:!1,usePBR:!1,normalTextureId:void 0,vertexTangents:!1,occlusionTextureId:void 0,emissiveTextureId:void 0,metallicRoughnessTextureId:void 0,emissiveFactor:[0,0,0],mrrFactors:[0,1,.5],ambient:[.2,.2,.2],diffuse:[.8,.8,.8],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,vertexColors:!1,symbolColors:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:u.b.Back,instanced:void 0,instancedDoublePrecision:!1,normals:"default",receiveSSAO:!0,fillLightsEnabled:!0,receiveShadows:!0,castShadows:!0,shadowMappingEnabled:!1,verticalOffset:null,screenSizePerspective:null,slicePlaneEnabled:!1,sliceHighlightDisabled:!1,offsetTransparentBackfaces:!1,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotationMatrix:Object(a.b)(),modelTransformation:null,transparent:!1,writeDepth:!0,customDepthTest:u.c.Less,textureAlphaMode:u.a.Blend,textureAlphaCutoff:h.b,textureAlphaPremultiplied:!1,sceneHasOcludees:!1,...f.a};class ee{constructor(e,t){this.vertexBufferLayout=e,this.instanceBufferLayout=t}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(v.a.POSITION).length}write(e,t,i,r){Object(y.d)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,i,r)}}function te(e){let t=Object(c.a)();return t=e.instancedDoublePrecision?t.vec3f(v.a.MODELORIGINHI).vec3f(v.a.MODELORIGINLO).mat3f(v.a.MODEL).mat3f(v.a.MODELNORMAL):t.mat4f(v.a.MODEL).mat4f(v.a.MODELNORMAL),e.instanced&&e.instanced.indexOf("color")>-1&&(t=t.vec4f(v.a.INSTANCECOLOR)),e.instanced&&e.instanced.indexOf("featureAttribute")>-1&&(t=t.vec4f(v.a.INSTANCEFEATUREATTRIBUTE)),t}const ie=Object(s.f)(),re=Object(s.f)(),ae=Object(s.h)(0,0,1),ne=Object(s.f)(),se=Object(s.f)(),oe=Object(s.f)(),ce=Object(s.f)()},810:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r,a,n,s={exports:{}};r=s,a=function(){function e(i,r,a,n,s){for(;n>a;){if(n-a>600){var o=n-a+1,c=r-a+1,l=Math.log(o),d=.5*Math.exp(2*l/3),h=.5*Math.sqrt(l*d*(o-d)/o)*(c-o/2<0?-1:1);e(i,r,Math.max(a,Math.floor(r-c*d/o+h)),Math.min(n,Math.floor(r+(o-c)*d/o+h)),s)}var u=i[r],p=a,f=n;for(t(i,a,r),s(i[n],u)>0&&t(i,a,n);p<f;){for(t(i,p,f),p++,f--;s(i[p],u)<0;)p++;for(;s(i[f],u)>0;)f--}0===s(i[a],u)?t(i,a,f):t(i,++f,n),f<=r&&(a=f+1),r<=f&&(n=f-1)}}function t(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}function i(e,t){return e<t?-1:e>t?1:0}return function(t,r,a,n,s){e(t,r,a||0,n||t.length-1,s||i)}},void 0!==(n=a())&&(r.exports=n);const o=s.exports},818:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));class r{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return 0===this._outer.size}get(e,t){var i;return null==(i=this._outer.get(e))?void 0:i.get(t)}set(e,t,i){const r=this._outer.get(e);r?r.set(t,i):this._outer.set(e,new Map([[t,i]]))}delete(e,t){const i=this._outer.get(e);i&&(i.delete(t),0===i.size&&this._outer.delete(e))}forEach(e){this._outer.forEach(((t,i)=>e(t,i)))}}},819:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(103);async function a(e,t){const{data:i}=await Object(r.default)(e,{responseType:"image",...t});return i}},826:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return f}));var r,a,n=i(85),s=i(211),o=i(212),c=i(117),l=i(109),d=i(620),h=i(360),u=i(498),p=i(278);class f{constructor(e,t){this._objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new b,this._objectCount=0,t&&(void 0!==t.maximumObjectsPerNode&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),void 0!==t.maximumDepth&&(this._maximumDepth=t.maximumDepth))}get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}destroy(){this._degenerateObjects.clear(),b.clearPool(),C[0]=null,P.prune(),F.prune()}add(e,t=e.length){this._objectCount+=t,this._grow(e,t);const i=b.acquire();for(let r=0;r<t;r++){const t=e[r];this._isDegenerate(t)?this._degenerateObjects.add(t):(i.init(this._root),this._add(t,i))}b.release(i)}remove(e,t=null){this._objectCount-=e.length;const i=b.acquire();for(const r of e){const e=Object(n.k)(t)?t:Object(u.b)(this._objectToBoundingSphere(r),I);j(e[3])?(i.init(this._root),this._remove(r,e,i)):this._degenerateObjects.delete(r)}b.release(i),this._shrink()}update(e,t){if(!j(t[3])&&this._isDegenerate(e))return;const i=function(e){return C[0]=e,C}(e);this.remove(i,t),this.add(i)}forEachAlongRay(e,t,i){const r=Object(h.g)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNode(r,e))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObject(r,e)&&i(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObject(r,e)&&i(e)})),!0}))}forEachAlongRayWithVerticalOffset(e,t,i,r){const a=Object(h.g)(e,t);this._forEachNode(this._root,(e=>{if(!this._intersectsNodeWithOffset(a,e,r))return!1;const t=e.node;return t.terminals.forAll((e=>{this._intersectsObjectWithOffset(a,e,r)&&i(e)})),null!==t.residents&&t.residents.forAll((e=>{this._intersectsObjectWithOffset(a,e,r)&&i(e)})),!0}))}forEach(e){this._forEachNode(this._root,(t=>{const i=t.node;return i.terminals.forAll(e),null!==i.residents&&i.residents.forAll(e),!0})),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,t,i,r=(()=>!0),a=1/0){let n=1/0,s=1/0,o=null;const l=y(e,t),h=c=>{if(--a,!r(c))return;const l=this._objectToBoundingSphere(c);if(!Object(d.f)(i,l))return;const h=_(e,t,Object(u.e)(l)),p=h-l[3],f=h+l[3];p<n&&(n=p,s=f,o=c)};return this._forEachNodeDepthOrdered(this._root,(r=>{if(a<=0||!Object(d.f)(i,r.bounds))return!1;if(Object(c.e)(A,l,r.halfSize),Object(c.f)(A,A,r.bounds),_(e,t,A)>s)return!1;const n=r.node;return n.terminals.forAll((e=>h(e))),null!==n.residents&&n.residents.forAll((e=>h(e))),!0}),e,t),o}forEachInDepthRange(e,t,i,a,n,s,o){let l=-1/0,h=1/0;const p={setRange:e=>{i===r.FRONT_TO_BACK?(l=Math.max(l,e.near),h=Math.min(h,e.far)):(l=Math.max(l,-e.far),h=Math.min(h,-e.near))}};p.setRange(a);const f=_(t,i,e),b=y(t,i),m=y(t,-i),g=e=>{if(!o(e))return;const r=this._objectToBoundingSphere(e),a=Object(u.e)(r),c=_(t,i,a)-f,b=c-r[3],m=c+r[3];b>h||m<l||!Object(d.f)(s,r)||n(e,p)};this._forEachNodeDepthOrdered(this._root,(e=>{if(!Object(d.f)(s,e.bounds))return!1;if(Object(c.e)(A,b,e.halfSize),Object(c.f)(A,A,e.bounds),_(t,i,A)-f>h)return!1;if(Object(c.e)(A,m,e.halfSize),Object(c.f)(A,A,e.bounds),_(t,i,A)-f<l)return!1;const r=e.node;return r.terminals.forAll((e=>g(e))),null!==r.residents&&r.residents.forAll((e=>g(e))),!0}),t,i)}forEachNode(e){this._forEachNode(this._root,(t=>e(t.node,t.bounds,t.halfSize)))}_intersectsNode(e,t){return v(t.bounds,2*-t.halfSize,w),v(t.bounds,2*t.halfSize,R),Object(p.h)(e.origin,e.direction,w,R)}_intersectsNodeWithOffset(e,t,i){return v(t.bounds,2*-t.halfSize,w),v(t.bounds,2*t.halfSize,R),i.applyToMinMax(w,R),Object(p.h)(e.origin,e.direction,w,R)}_intersectsObject(e,t){const i=this._objectToBoundingSphere(t);return!(i[3]>0)||Object(u.f)(i,e)}_intersectsObjectWithOffset(e,t,i){const r=this._objectToBoundingSphere(t);return!(r[3]>0)||Object(u.f)(i.applyToBoundingSphere(r),e)}_forEachNode(e,t){let i=b.acquire().init(e);const r=[i];for(;0!==r.length;){if(i=r.pop(),t(i)&&!i.isLeaf())for(let e=0;e<i.node.children.length;e++)i.node.children[e]&&r.push(b.acquire().init(i).advance(e));b.release(i)}}_forEachNodeDepthOrdered(e,t,i,a=r.FRONT_TO_BACK){let n=b.acquire().init(e);const s=[n];for(function(e,t,i){if(!F.length)for(let r=0;r<8;++r)F.push({index:0,distance:0});for(let r=0;r<8;++r){const i=x[r];F.data[r].index=r,F.data[r].distance=_(e,t,i)}F.sort(((e,t)=>e.distance-t.distance));for(let r=0;r<8;++r)i[r]=F.data[r].index}(i,a,z);0!==s.length;){if(n=s.pop(),t(n)&&!n.isLeaf())for(let e=7;e>=0;--e){const t=z[e];n.node.children[t]&&s.push(b.acquire().init(n).advance(t))}b.release(n)}}_remove(e,t,i){P.clear();const r=i.advanceTo(t,((e,t)=>{P.push(e.node),P.push(t)}))?i.node.terminals:i.node.residents;if(r.removeUnordered(e),0===r.length)for(let a=P.length-2;a>=0;a-=2){const e=P.data[a],t=P.data[a+1];if(!this._purge(e,t))break}}_nodeIsEmpty(e){if(0!==e.terminals.length)return!1;if(null!==e.residents)return 0===e.residents.length;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}_purge(e,t){return t>=0&&(e.children[t]=null),!!this._nodeIsEmpty(e)&&(null===e.residents&&(e.residents=new o.a({shrink:!0})),!0)}_add(e,t){t.advanceTo(this._objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){const t=e.node.residents;e.node.residents=null;for(let i=0;i<t.length;i++){const r=b.acquire().init(e);this._add(t.getItemAt(i),r),b.release(r)}}_grow(e,t){if(0!==t&&(O(e,t,(e=>this._objectToBoundingSphere(e)),D),j(D[3])&&!this._fitsInsideTree(D)))if(this._nodeIsEmpty(this._root.node))Object(u.b)(D,this._root.bounds),this._root.halfSize=1.25*D[3];else{const e=this._rootBoundsForRootAsSubNode(D);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(D,e):this._growRootAsSubNode(e),b.release(e)}}_rebuildTree(e,t){Object(c.k)(M,t.bounds),M[3]=t.halfSize,O([e,M],2,(e=>e),L);const i=b.acquire().init(this._root);this._root.initFrom(null,L,1.25*L[3]),this._forEachNode(i,(e=>(this.add(e.node.terminals.data,e.node.terminals.length),null!==e.node.residents&&this.add(e.node.residents.data,e.node.residents.length),!0))),b.release(i)}_placingRootViolatesMaxDepth(e){const t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let i=0;return this._forEachNode(this._root,(e=>(i=Math.max(i,e.depth),i+t<=this._maximumDepth))),i+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const t=e[3],i=e;let r=-1/0;const a=this._root.bounds,n=this._root.halfSize;for(let s=0;s<3;s++){const e=a[s]-n-(i[s]-t),o=i[s]+t-(a[s]+n),c=Math.max(0,Math.ceil(e/(2*n))),l=Math.max(0,Math.ceil(o/(2*n)))+1,d=2**Math.ceil(Math.log(c+l)*Math.LOG2E);r=Math.max(r,d),N[s].min=c,N[s].max=l}for(let s=0;s<3;s++){let e=N[s].min,t=N[s].max;const i=(r-(e+t))/2;e+=Math.ceil(i),t+=Math.floor(i);const o=a[s]-n-e*n*2;E[s]=o+(t+e)*n}return E[3]=r*n*T,b.acquire().initFrom(null,E,r*n,0)}_growRootAsSubNode(e){const t=this._root.node;Object(c.k)(D,this._root.bounds),D[3]=this._root.halfSize,this._root.init(e),e.advanceTo(D,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(-1===e)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(0!==this._root.node.terminals.length||this._root.isLeaf())return-1;let e=null;const t=this._root.node.children;let i=0,r=0;for(;r<t.length&&null==e;)i=r++,e=t[i];for(;r<t.length;)if(t[r++])return-1;return i}_isDegenerate(e){return!j(this._objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const t=this._root.bounds,i=this._root.halfSize;return e[3]<=i&&e[0]>=t[0]-i&&e[0]<=t[0]+i&&e[1]>=t[1]-i&&e[1]<=t[1]+i&&e[2]>=t[2]-i&&e[2]<=t[2]+i}}class b{constructor(){this.bounds=Object(u.c)(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,t,i,r=this.depth){return this.node=Object(n.k)(e)?e:b.createEmptyNode(),Object(n.k)(t)&&Object(u.b)(t,this.bounds),this.halfSize=i,this.depth=r,this}advance(e){let t=this.node.children[e];t||(t=b.createEmptyNode(),this.node.children[e]=t),this.node=t,this.halfSize/=2,this.depth++;const i=x[e];return this.bounds[0]+=i[0]*this.halfSize,this.bounds[1]+=i[1]*this.halfSize,this.bounds[2]+=i[2]*this.halfSize,this.bounds[3]=this.halfSize*T,this}advanceTo(e,t,i=!1){for(;;){if(this.isTerminalFor(e))return t&&t(this,-1),!0;if(this.isLeaf()){if(!i)return t&&t(this,-1),!1;this.node.residents=null}const r=this._childIndex(e);t&&t(this,r),this.advance(r)}}isLeaf(){return null!=this.node.residents}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const t=this.bounds;return(t[0]<e[0]?1:0)+(t[1]<e[1]?2:0)+(t[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new o.a({shrink:!0}),residents:new o.a({shrink:!0})}}static acquire(){return b._pool.acquire()}static release(e){b._pool.release(e)}static clearPool(){b._pool.prune()}}function m(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function g(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function v(e,t,i){i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t}function O(e,t,i,r){if(1===t){const t=i(e[0]);Object(u.b)(t,r)}else{w[0]=1/0,w[1]=1/0,w[2]=1/0,R[0]=-1/0,R[1]=-1/0,R[2]=-1/0;for(let r=0;r<t;r++){const t=i(e[r]);j(t[3])&&(m(w,t),g(R,t))}Object(c.i)(r,w,R,.5),r[3]=Math.max(R[0]-w[0],R[1]-w[1],R[2]-w[2])/2}}function y(e,t){let i=1/0,r=null;for(let a=0;a<8;++a){const n=_(e,t,S[a]);n<i&&(i=n,r=S[a])}return r}function _(e,t,i){return t*(e[0]*i[0]+e[1]*i[1]+e[2]*i[2])}function j(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}b._pool=new s.a(b),(a=r||(r={}))[a.FRONT_TO_BACK=1]="FRONT_TO_BACK",a[a.BACK_TO_FRONT=-1]="BACK_TO_FRONT";const x=[Object(l.h)(-1,-1,-1),Object(l.h)(1,-1,-1),Object(l.h)(-1,1,-1),Object(l.h)(1,1,-1),Object(l.h)(-1,-1,1),Object(l.h)(1,-1,1),Object(l.h)(-1,1,1),Object(l.h)(1,1,1)],S=[Object(l.h)(-1,-1,-1),Object(l.h)(-1,-1,1),Object(l.h)(-1,1,-1),Object(l.h)(-1,1,1),Object(l.h)(1,-1,-1),Object(l.h)(1,-1,1),Object(l.h)(1,1,-1),Object(l.h)(1,1,1)],T=Math.sqrt(3),C=[null];const E=Object(u.c)(),A=Object(l.f)(),w=Object(l.f)(),R=Object(l.f)(),P=new o.a,I=Object(u.c)(),D=Object(u.c)(),M=Object(u.c)(),L=Object(u.c)(),N=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],F=new o.a,z=[0,0,0,0,0,0,0,0]},827:function(e,t,i){"use strict";i.d(t,"a",(function(){return T})),i.d(t,"b",(function(){return _})),i.d(t,"c",(function(){return j})),i.d(t,"d",(function(){return x}));var r=i(151),a=i(219),n=i(257),s=i(895),o=i(210),c=i(301),l=i(946),d=i(753),h=i(1084),u=i(420),p=i(623),f=i(397),b=i(464),m=i(500),g=i(747),v=i(126),O=i(297),y=i(139);function _(e){const t=new O.a,i=e.signedDistanceFieldEnabled;if(t.include(l.a),t.include(d.a,e),t.include(c.a,e),e.output===o.a.Occlusion)return t.include(h.a,e),t;t.include(g.a),t.fragment.include(m.a),t.fragment.include(b.a),t.include(p.a,e),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),e.binaryHighlightOcclusionEnabled&&t.varyings.add("voccluded","float"),t.vertex.uniforms.add("screenOffset","vec2").add("anchorPos","vec2").add("textureCoordinateScaleFactor","vec2").add("materialColor","vec4"),i&&t.vertex.uniforms.add("outlineColor","vec4"),e.screenSizePerspectiveEnabled&&t.vertex.uniforms.add("screenSizePerspective","vec4"),(e.debugDrawLabelBorder||e.binaryHighlightOcclusionEnabled)&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(y.a.UV0,"vec2"),t.attributes.add(y.a.COLOR,"vec4"),t.attributes.add(y.a.SIZE,"vec2"),t.attributes.add(y.a.AUXPOS2,"vec4"),t.vertex.code.add(v.a`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${e.screenSizePerspectiveEnabled?v.a`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:v.a`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${e.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${e.occlusionTestEnabled||e.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${e.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const r=v.a`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPos) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,a=e.pixelSnappingEnabled?i?v.a`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:v.a`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:v.a`posProj += quadOffset;`;t.vertex.code.add(v.a`
      ${e.occlusionTestEnabled?"if (visible) {":""}
      ${r}
      ${e.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

      bool alphaDiscard = vcolor.a < ${v.a.float(f.c)};
      ${i?`alphaDiscard = alphaDiscard && outlineColor.a < ${v.a.float(f.c)};`:""}
      if (alphaDiscard) {
        // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      } else {
        ${a}
        gl_Position = posProj;
      }

      vtc = uv * textureCoordinateScaleFactor;

      ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
      vsize = inputSize;
      ${e.occlusionTestEnabled?v.a`} else { vtc = vec2(0.0);
        ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
    }
    `),t.fragment.uniforms.add("tex","sampler2D"),i&&(t.fragment.uniforms.add("outlineColor","vec4"),t.fragment.uniforms.add("outlineSize","float"));const n=e.debugDrawLabelBorder?v.a`(isBorder > 0.0 ? 0.0 : ${v.a.float(f.b)})`:v.a.float(f.b),_=v.a`
    ${e.debugDrawLabelBorder?v.a`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${i?v.a`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = ${v.a.float(s.b)};
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${n} ||
          fillPixelColor.a + outlinePixelColor.a < ${v.a.float(f.c)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${n}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:v.a`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${n}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    // Draw debug border with transparency, so that original texels along border are still partially visible
    ${e.debugDrawLabelBorder?v.a`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`:""}
  `;return e.output===o.a.Alpha&&t.fragment.code.add(v.a`
      void main() {
        ${_}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),e.output===o.a.Color&&t.fragment.code.add(v.a`
    void main() {
      ${_}
      ${e.frontFacePass?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),e.output===o.a.Highlight&&(t.include(u.a),t.fragment.code.add(v.a`
    void main() {
      ${_}
      ${e.binaryHighlightOcclusionEnabled?v.a`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),t}function j(e,t,i){e.setUniform4fv("materialColor",t.color),t.textureIsSignedDistanceField&&(t.outlineColor[3]<=0||t.outlineSize<=0?(e.setUniform4fv("outlineColor",n.b),e.setUniform1f("outlineSize",0)):(e.setUniform4fv("outlineColor",t.outlineColor),e.setUniform1f("outlineSize",t.outlineSize))),e.setUniform2f("screenOffset",2*t.screenOffset[0]*i,2*t.screenOffset[1]*i),e.setUniform2fv("anchorPos",x(t))}function x(e,t=S){return e.textureIsSignedDistanceField?function(e,t,i){i[0]=e[0]*(t[2]-t[0])+t[0],i[1]=e[1]*(t[3]-t[1])+t[1]}(e.anchorPos,e.distanceFieldBoundingBox,t):Object(r.c)(t,e.anchorPos),t}const S=Object(a.a)(),T=Object.freeze({__proto__:null,build:_,bindHUDMaterialUniforms:j,calculateAnchorPosForRendering:x})},828:function(e,t,i){"use strict";i.d(t,"a",(function(){return g})),i.d(t,"b",(function(){return m}));var r=i(210),a=i(301),n=i(478),s=i(624),o=i(622),c=i(420),l=i(410),d=i(356),h=i(397),u=i(464),p=i(126),f=i(297),b=i(139);function m(e){const t=new f.a,i=e.output===r.a.Depth;return t.include(n.a,{linearDepth:i}),t.include(s.a,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add(b.a.POSITION,"vec3"),t.varyings.add("vpos","vec3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),i&&(t.include(o.a,e),t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("linearDepth","float")),t.vertex.code.add(p.a`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${i?p.a`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:p.a`transformPosition(proj, view, vpos);`}
    }
  `),t.include(a.a,e),t.fragment.include(u.a),e.multipassTerrainEnabled&&(t.fragment.include(l.a),t.include(d.b,e)),t.fragment.uniforms.add("eColor","vec4"),e.output===r.a.Highlight&&t.include(c.a),t.fragment.code.add(p.a`
  void main() {
    discardBySlice(vpos);
    ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 fColor = ${e.attributeColor?"vColor * eColor;":"eColor;"}

    if (fColor.a < ${p.a.float(h.c)}) {
      discard;
    }

    ${e.output===r.a.Alpha?p.a`gl_FragColor = vec4(fColor.a);`:""}

    ${e.output===r.a.Color?p.a`gl_FragColor = highlightSlice(fColor, vpos); ${e.oitEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${e.output===r.a.Highlight?p.a`outputHighlight();`:""};
    ${e.output===r.a.Depth?p.a`outputDepth(linearDepth);`:""};
  }
  `),t}const g=Object.freeze({__proto__:null,build:m})},830:function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return d}));var r=i(109),a=i(210),n=i(831),s=i(126),o=i(139),c=i(725);function l(e,t){t.instanced&&t.instancedDoublePrecision&&(e.attributes.add(o.a.MODELORIGINHI,"vec3"),e.attributes.add(o.a.MODELORIGINLO,"vec3"),e.attributes.add(o.a.MODEL,"mat3"),e.attributes.add(o.a.MODELNORMAL,"mat3")),t.instancedDoublePrecision&&(e.vertex.include(n.a,t),e.vertex.uniforms.add("viewOriginHi","vec3"),e.vertex.uniforms.add("viewOriginLo","vec3"));const i=[s.a`
    vec3 calculateVPos() {
      ${t.instancedDoublePrecision?"return model * localPosition().xyz;":"return localPosition().xyz;"}
    }
    `,s.a`
    vec3 subtractOrigin(vec3 _pos) {
      ${t.instancedDoublePrecision?s.a`
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -modelOriginHi, -modelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `,s.a`
    vec3 dpNormal(vec4 _normal) {
      ${t.instancedDoublePrecision?"return normalize(modelNormal * _normal.xyz);":"return normalize(_normal.xyz);"}
    }
    `,s.a`
    vec3 dpNormalView(vec4 _normal) {
      ${t.instancedDoublePrecision?"return normalize((viewNormal * vec4(modelNormal * _normal.xyz, 1.0)).xyz);":"return normalize((viewNormal * _normal).xyz);"}
    }
    `,t.vertexTangents?s.a`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${t.instancedDoublePrecision?"return vec4(modelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}

    }
    `:s.a``];e.vertex.code.add(i[0]),e.vertex.code.add(i[1]),e.vertex.code.add(i[2]),t.output===a.a.Normal&&e.vertex.code.add(i[3]),e.vertex.code.add(i[4])}function d(e,t){Object(c.b)(t,h,u,3),e.setUniform3fv("viewOriginHi",h),e.setUniform3fv("viewOriginLo",u)}const h=Object(r.f)(),u=Object(r.f)()},831:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s}));var r=i(82),a=i(126);function n({code:e},t){t.doublePrecisionRequiresObfuscation?e.add(a.a`vec3 dpPlusFrc(vec3 a, vec3 b) {
return mix(a, a + b, vec3(notEqual(b, vec3(0))));
}
vec3 dpMinusFrc(vec3 a, vec3 b) {
return mix(vec3(0), a - b, vec3(notEqual(a, b)));
}
vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = dpPlusFrc(hiA, hiB);
vec3 e = dpMinusFrc(t1, hiA);
vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
return t1 + t2;
}`):e.add(a.a`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = hiA + hiB;
vec3 e = t1 - hiA;
vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
return t1 + t2;
}`)}function s(e){return!!Object(r.a)("force-double-precision-obfuscation")||e.driverTest.doublePrecisionRequiresObfuscation}},832:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r=i(272),a=i(799),n=i(773),s=i(800),o=i(754),c=i(502),l=i(730),d=i(625),h=i(126);function u(e,t){const i=e.fragment;e.include(s.a),e.include(n.a,t),t.pbrMode!==c.a.Disabled&&e.include(o.a,t),e.include(a.a,t),t.receiveShadows&&e.include(d.a,t),i.uniforms.add("lightingGlobalFactor","float"),i.uniforms.add("ambientBoostFactor","float"),i.uniforms.add("hasFillLights","bool"),e.include(l.a),i.code.add(h.a`
    const float GAMMA_SRGB = 2.1;
    const float INV_GAMMA_SRGB = 0.4761904;
    ${t.pbrMode===c.a.Disabled?"":"const vec3 GROUND_REFLECTANCE = vec3(0.2);"}
  `),i.code.add(h.a`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${t.viewingMode===r.a.Global?h.a`normalize(vPosWorld)`:h.a`vec3(0.0, 0.0, 1.0)`}, lightingMainDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),i.code.add(h.a`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * lightingMainIntensity;
}`),t.pbrMode===c.a.Disabled||t.pbrMode===c.a.WaterOnIntegratedMesh?i.code.add(h.a`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight)
{
vec3 mainLighting = evaluateMainLighting(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`):t.pbrMode!==c.a.Normal&&t.pbrMode!==c.a.Schematic||(i.code.add(h.a`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)
{
vec3 viewDirection = -viewDir;
vec3 mainLightDirection = lightingMainDirection;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);
inputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);
inputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),i.code.add(h.a`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),i.code.add(h.a`vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);
ambientDir = ambientDir != vec3(0.0)? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;
vec3 mainLightIrradianceComponent = inputs.NdotL * (1.0 - shadow) * lightingMainIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * lightingMainIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),i.code.add(h.a`vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
vec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(inputs.NdotH, inputs.roughness) * lightingMainIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * lightingMainIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;
inputs.skyRadianceToSurface = ambientLightRadianceComponent + mainLightRadianceComponent + horizonLightRadianceComponent;
inputs.groundRadianceToSurface = GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);`),i.code.add(h.a`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = pow(_emission, vec3(GAMMA_SRGB));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${t.pbrMode===c.a.Schematic?h.a`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:h.a`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `))}},850:function(e,t,i){"use strict";i.d(t,"a",(function(){return y})),i.d(t,"b",(function(){return v})),i.d(t,"c",(function(){return g})),i.d(t,"d",(function(){return T})),i.d(t,"e",(function(){return S})),i.d(t,"f",(function(){return O})),i.d(t,"g",(function(){return j})),i.d(t,"h",(function(){return _})),i.d(t,"i",(function(){return x}));var r=i(87),a=i(85),n=i(233),s=i(367),o=i(200),c=i(117),l=i(109),d=i(187),h=i(208),u=i(110),p=i(182),f=i(421),b=i(744);const m=r.a.getLogger("esri.geometry.support.meshUtils.normalProjection");function g(e,t,i,r,a){return E(r)?(C(w.TO_PCPF,f.u.fromTypedArray(e),f.v.fromTypedArray(t),f.v.fromTypedArray(i),r,f.u.fromTypedArray(a)),a):(m.error("Cannot convert spatial reference to PCPF"),a)}function v(e,t,i,r,a){return E(r)?(C(w.FROM_PCPF,f.u.fromTypedArray(e),f.v.fromTypedArray(t),f.v.fromTypedArray(i),r,f.u.fromTypedArray(a)),a):(m.error("Cannot convert to spatial reference from PCPF"),a)}function O(e,t,i){return Object(d.l)(e,t,0,i,Object(h.g)(t),0,e.length/3),i}function y(e,t,i){return Object(d.l)(e,Object(h.g)(i),0,t,i,0,e.length/3),t}function _(e,t,i){if(Object(a.j)(e))return t;const r=f.v.fromTypedArray(e),n=f.v.fromTypedArray(t);return Object(b.e)(n,r,i),t}function j(e,t,i){if(Object(a.j)(e))return t;Object(n.a)(M,i);const r=f.u.fromTypedArray(e),s=f.u.fromTypedArray(t);return Object(b.a)(s,r,M),Object(n.g)(M)||Object(b.c)(s,s),t}function x(e,t,i){if(Object(a.j)(e))return t;Object(n.a)(M,i);const r=f.u.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),s=f.u.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT);if(Object(b.a)(s,r,M),Object(n.g)(M)||Object(b.c)(s,s),e!==t)for(let a=3;a<e.length;a+=4)t[a]=e[a];return t}function S(e,t,i,r,a){if(!E(r))return m.error("Cannot convert spatial reference to PCPF"),a;C(w.TO_PCPF,f.u.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),f.v.fromTypedArray(t),f.v.fromTypedArray(i),r,f.u.fromTypedArray(a,4*Float32Array.BYTES_PER_ELEMENT));for(let n=3;n<e.length;n+=4)a[n]=e[n];return a}function T(e,t,i,r,a){if(!E(r))return m.error("Cannot convert to spatial reference from PCPF"),a;C(w.FROM_PCPF,f.u.fromTypedArray(e,16),f.v.fromTypedArray(t),f.v.fromTypedArray(i),r,f.u.fromTypedArray(a,16));for(let n=3;n<e.length;n+=4)a[n]=e[n];return a}function C(e,t,i,r,a,s){if(!t)return;const o=i.count,l=Object(h.g)(a);if(A(a))for(let h=0;h<o;h++)r.getVec(h,P),t.getVec(h,I),Object(d.d)(l,P,D,l),Object(n.f)(M,D),e===w.FROM_PCPF&&Object(n.n)(M,M),Object(c.x)(I,I,M),s.setVec(h,I);else for(let h=0;h<o;h++){r.getVec(h,P),t.getVec(h,I),Object(d.d)(l,P,D,l),Object(n.f)(M,D);const a=Object(p.h)(i.get(h,1));let o=Math.cos(a);e===w.TO_PCPF&&(o=1/o),M[0]*=o,M[1]*=o,M[2]*=o,M[3]*=o,M[4]*=o,M[5]*=o,e===w.FROM_PCPF&&Object(n.n)(M,M),Object(c.x)(I,I,M),Object(c.r)(I,I),s.setVec(h,I)}return s}function E(e){return A(e)||function(e){return e.isWebMercator}(e)}function A(e){return e.isWGS84||Object(u.f)(e)||Object(u.i)(e)||Object(u.j)(e)}var w,R;(R=w||(w={}))[R.TO_PCPF=0]="TO_PCPF",R[R.FROM_PCPF=1]="FROM_PCPF";const P=Object(l.f)(),I=Object(l.f)(),D=Object(o.d)(),M=Object(s.b)()},855:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return l})),i.d(t,"d",(function(){return h})),i.d(t,"e",(function(){return u})),i.d(t,"f",(function(){return d})),i.d(t,"g",(function(){return p}));var r=i(87),a=i(638),n=i(130);const s=r.a.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function o(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}async function c(e,t,i){const r=e&&e.expression;if("string"!=typeof r)return null;const a=b(r);if(null!=a)return{cachedResult:a};const s=await Object(n.e)(),o=s.arcadeUtils,c=o.createSyntaxTree(r);return o.dependsOnView(c)?(null!=i&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:o.createFunction(c),context:o.createExecContext(null,{sr:t}),modules:s}}}function l(e,t,i){return e.arcadeUtils.createFeature(t.attributes,t.geometry,i)}function d(e,t){if(null!=e&&!f(e)){if(!t||!e.arcade)return void s.errorOncePerTick("Arcade support required but not provided");const i=t;i._geometry&&(i._geometry=Object(a.b)(i._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function h(e){if(null!=e){if(f(e))return e.cachedResult;const t=e.arcade;let i=e.arcade.modules.arcadeUtils.executeFunction(t.func,t.context);return"number"!=typeof i&&(e.cachedResult=0,i=0),i}return 0}function u(e,t=!1){let i=e&&e.featureExpressionInfo;const r=i&&i.expression;return t||"0"===r||(i=null),i}const p={cachedResult:0};function f(e){return null!=e.cachedResult}function b(e){return"0"===e?0:null}},856:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i(85),a=i(91),n=i(163),s=i(545);class o extends s.a{constructor(e){super(e),this._numLoading=0,this._disposed=!1,this._textureRepository=e.textureRep,this._textureId=e.textureId,this._acquire(e.textureId,(e=>this._texture=e)),this._acquire(e.normalTextureId,(e=>this._textureNormal=e)),this._acquire(e.emissiveTextureId,(e=>this._textureEmissive=e)),this._acquire(e.occlusionTextureId,(e=>this._textureOcclusion=e)),this._acquire(e.metallicRoughnessTextureId,(e=>this._textureMetallicRoughness=e))}dispose(){this._texture=Object(r.q)(this._texture),this._textureNormal=Object(r.q)(this._textureNormal),this._textureEmissive=Object(r.q)(this._textureEmissive),this._textureOcclusion=Object(r.q)(this._textureOcclusion),this._textureMetallicRoughness=Object(r.q)(this._textureMetallicRoughness),this._disposed=!0}ensureResources(e){return 0===this._numLoading?n.g.LOADED:n.g.LOADING}updateTexture(e){(Object(r.j)(this._texture)||e!==this._texture.id)&&(this._texture=Object(r.q)(this._texture),this._textureId=e,this._acquire(this._textureId,(e=>this._texture=e)))}bindTextures(e){Object(r.k)(this._texture)&&e.bindTexture(this._texture.glTexture,"tex"),Object(r.k)(this._textureNormal)&&e.bindTexture(this._textureNormal.glTexture,"normalTexture"),Object(r.k)(this._textureEmissive)&&e.bindTexture(this._textureEmissive.glTexture,"texEmission"),Object(r.k)(this._textureOcclusion)&&e.bindTexture(this._textureOcclusion.glTexture,"texOcclusion"),Object(r.k)(this._textureMetallicRoughness)&&e.bindTexture(this._textureMetallicRoughness.glTexture,"texMetallicRoughness")}bindTextureScale(e){const t=Object(r.k)(this._texture)?this._texture.glTexture:null;Object(r.k)(t)&&t.descriptor.textureCoordinateScaleFactor?e.setUniform2fv("textureCoordinateScaleFactor",t.descriptor.textureCoordinateScaleFactor):e.setUniform2f("textureCoordinateScaleFactor",1,1)}_acquire(e,t){if(Object(r.j)(e))return void t(null);const i=this._textureRepository.acquire(e);if(Object(a.n)(i))return++this._numLoading,void i.then((e=>{if(this._disposed)return Object(r.q)(e),void t(null);t(e)})).finally((()=>--this._numLoading));t(i)}}},857:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n}));var r=i(410),a=i(126);function n(e){e.include(r.a),e.uniforms.add("geometryDepthTexture","sampler2D"),e.uniforms.add("nearFar","vec2"),e.code.add(a.a`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}function s(e,t){t.multipassGeometryEnabled&&t.geometryLinearDepthTexture&&e.bindTexture(t.geometryLinearDepthTexture,"geometryDepthTexture")}},858:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return o})),i.d(t,"c",(function(){return s})),i.d(t,"d",(function(){return a}));var r=i(116);const a=(()=>{if(!("document"in globalThis))return()=>null;const e=document.createElement("canvas"),t=e.getContext("2d");return e.height=512,e.width=1,i=>{t.clearRect(0,0,1,e.height);const r=t.createLinearGradient(0,0,0,e.height);for(const{ratio:e,color:t}of i)r.addColorStop(Math.max(e,.001),`rgba(${t.r}, ${t.g}, ${t.b}, ${t.a})`);return t.fillStyle=r,t.fillRect(0,0,1,e.height),t.getImageData(0,0,1,e.height).data}})();function n(e,t,i,r){const{blurRadius:a,fieldOffset:n,field:s}=t,c=new Float64Array(i*r),l=o(a),d=Math.round(3*a);let h,u=Number.NEGATIVE_INFINITY;const p=function(e,t){return null!=e?"string"==typeof t?t=>-1*+t.readAttribute(e):i=>+i.readAttribute(e)+t:e=>1}(s,n),f=new Set;for(const o of e){const e=o.getCursor();for(;e.next();){const t=e.getObjectId();if(f.has(t))continue;f.add(t);const a=e.readLegacyPointGeometry(),n=128;if(a.x<-n||a.x>=i+n||a.y<-n||a.y>r+n)continue;const s=+p(e),o=Math.round(a.x)-d,b=Math.round(a.y)-d,m=Math.max(0,o),g=Math.max(0,b),v=Math.min(r,Math.round(a.y)+d),O=Math.min(i,Math.round(a.x)+d);for(let e=g;e<v;e++){const t=l[e-b];for(let r=m;r<O;r++){const a=l[r-o];h=c[e*i+r]+=t*a*s,h>u&&(u=h)}}}}return{matrix:c.buffer,max:u}}function s(e,t,i,a,n,s){e.canvas.width=e.canvas.height=t,e.clearRect(0,0,t,t);const o=e.getImageData(0,0,t,t);i&&a&&o.data.set(new Uint8ClampedArray(function(e,t,i,a,n){const s=new Uint32Array(e*e),o="buffer"in t?t:new Float64Array(t),c="buffer"in i?new Uint32Array(i.buffer):new Uint32Array(new Uint8Array(i).buffer),l=c.length/(n-a);for(let d=0;d<o.length;d++){const e=o[d],t=Math.floor((e-a)*l);s[d]=c[Object(r.e)(t,0,c.length-1)]}return s.buffer}(t,i,a,n,s))),e.putImageData(o,0,0)}function o(e){const t=Math.round(3*e),i=2*e*e,r=new Float64Array(2*t+1);for(let a=0;a<=r.length;a++)r[a]=Math.exp(-((a-t)**2)/i)/Math.sqrt(2*Math.PI)*(e/2);return r}},859:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return l})),i.d(t,"c",(function(){return c}));var r,a,n=i(687),s=i(126),o=i(297);function c(e){const t=new o.a;return t.include(n.a),t.fragment.uniforms.add("tex","sampler2D"),e.function===r.Standard&&(e.hasOpacityFactor?(t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(s.a`void main() {
gl_FragColor = texture2D(tex, uv) * opacity;
}`)):t.fragment.code.add(s.a`void main() {
gl_FragColor = texture2D(tex, uv);
}`)),e.function===r.OverlayWithTransparency&&(t.fragment.uniforms.add("overlayIdx","int"),e.hasOpacityFactor&&t.fragment.uniforms.add("opacity","float"),t.fragment.code.add(s.a`
      void main() {
        vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
        gl_FragColor = texture2D(tex, overlayUV) ${e.hasOpacityFactor?"* opacity":""};
      }`)),e.function===r.TransparentToHUDVisibility&&t.fragment.code.add(s.a`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),e.function===r.Transparency&&(t.fragment.uniforms.add("colorTexture","sampler2D"),t.fragment.uniforms.add("alphaTexture","sampler2D"),t.fragment.uniforms.add("frontFaceTexture","sampler2D"),t.fragment.code.add(s.a`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`)),t}(a=r||(r={}))[a.Standard=0]="Standard",a[a.TransparentToHUDVisibility=1]="TransparentToHUDVisibility",a[a.Transparency=2]="Transparency",a[a.OverlayWithTransparency=3]="OverlayWithTransparency",a[a.COUNT=4]="COUNT";const l=Object.freeze({__proto__:null,get CompositingFunction(){return r},build:c})},882:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(116);function a(e,t,i){var a;const l=e.byteLength/(4*t),d=new Uint32Array(e,0,l*t);let h=new Uint32Array(l);const u=null!=(a=null==i?void 0:i.minReduction)?a:0,p=(null==i?void 0:i.originalIndices)||null,f=p?p.length:0,b=(null==i?void 0:i.componentOffsets)||null;let m=0;if(b)for(let r=0;r<b.length-1;r++){const e=b[r+1]-b[r];e>m&&(m=e)}else m=l;const g=Math.floor(1.1*m)+1;(null==c||c.length<2*g)&&(c=new Uint32Array(Object(r.l)(2*g)));for(let r=0;r<2*g;r++)c[r]=0;let v=0;const O=!!b&&!!p,y=O?f:l,_=O?new Uint32Array(f):null,j=1.96;let x=0!==u?Math.ceil(4*j*j/(u*u)*u*(1-u)):y,S=1,T=b?b[1]:y;for(let r=0;r<y;r++){if(r===x){const e=1-v/r;if(e+j*Math.sqrt(e*(1-e)/r)<u)return null;x*=2}if(r===T){for(let e=0;e<2*g;e++)c[e]=0;if(p)for(let e=b[S-1];e<b[S];e++)_[e]=h[p[e]];T=b[++S]}const e=O?p[r]:r,i=e*t,a=o(d,i,t);let s=a%g,l=v;for(;0!==c[2*s+1];){if(c[2*s]===a){const e=c[2*s+1]-1;if(n(d,i,e*t,t)){l=h[e];break}}s++,s>=g&&(s-=g)}l===v&&(c[2*s]=a,c[2*s+1]=e+1,v++),h[e]=l}if(0!==u&&1-v/l<u)return null;if(O){for(let e=b[S-1];e<_.length;e++)_[e]=h[p[e]];h=_}const C=new Uint32Array(t*v);v=0;for(let r=0;r<y;r++)h[r]===v&&(s(d,(O?p[r]:r)*t,C,v*t,t),v++);if(p&&!O){const e=new Uint32Array(f);for(let t=0;t<e.length;t++)e[t]=h[p[t]];h=e}return{buffer:C.buffer,indices:h,uniqueCount:v}}function n(e,t,i,r){for(let a=0;a<r;a++)if(e[t+a]!==e[i+a])return!1;return!0}function s(e,t,i,r,a){for(let n=0;n<a;n++)i[r+n]=e[t+n]}function o(e,t,i){let r=0;for(let a=0;a<i;a++)r=e[t+a]+r|0,r=r+(r<<11)+(r>>>2)|0;return r>>>0}let c=null},894:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(500),a=i(126);function n(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?function(e,t){const i=!(t.draped&&t.stipplePreferContinuous);e.fragment.include(r.a),e.vertex.uniforms.add("stipplePatternPixelSize","float"),e.vertex.uniforms.add("pixelRatio","float"),t.draped?e.vertex.uniforms.add("worldToScreenRatio","float"):(e.vertex.uniforms.add("worldToScreenPerDistanceRatio","float"),e.vertex.uniforms.add("cameraPosition","vec3"),e.vertex.code.add(a.a`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),t.stippleRequiresClamp&&e.varyings.add("vStippleDistanceLimits","vec2"),t.stippleRequiresStretchMeasure&&e.varyings.add("vStipplePatternStretch","float"),e.vertex.code.add(a.a`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${s};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),e.vertex.code.add(a.a`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),e.vertex.code.add(a.a`
    if (segmentLengthPseudoScreen >= ${i?"patternLength":"1e4"}) {
  `),e.vertex.code.add(a.a`
        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        ${t.stippleRequiresStretchMeasure?a.a`
              float stretch = repetitions / flooredRepetitions;

              // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.
              // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.
              vStipplePatternStretch = max(0.75, stretch);`:""}

        return vec2(0.0, segmentLengthScreenRounded);
      }
      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
    }
  `),e.fragment.uniforms.add("stipplePatternTexture","sampler2D"),e.fragment.uniforms.add("stipplePatternSDFNormalizer","float"),e.fragment.uniforms.add("stipplePatternTextureSize","float"),e.fragment.uniforms.add("stipplePatternPixelSizeInv","float"),t.stippleOffColorEnabled&&e.fragment.uniforms.add("stippleOffColor","vec4"),e.fragment.code.add(a.a`float padTexture(float u) {
return (u * stipplePatternTextureSize + 1.0)/(stipplePatternTextureSize + 2.0);
}`),e.fragment.code.add(a.a`
    float getStippleSDF(out bool isClamped) {
      ${t.stippleRequiresClamp?a.a`
          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;`:a.a`
          float stippleDistanceClamped = vStippleDistance;
          isClamped = false;`}

      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;
      ${t.stippleScaleWithLineWidth?a.a`u *= vLineSizeInv;`:""}
      u = padTexture(fract(u));

      float encodedSDF = rgba2float(texture2D(stipplePatternTexture, vec2(u, 0.5)));
      float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;

      ${t.stippleRequiresStretchMeasure?a.a`return (sdf - 0.5) * vStipplePatternStretch + 0.5;`:a.a`return sdf;`}
    }

    float getStippleSDF() {
      bool ignored;
      return getStippleSDF(ignored);
    }

    float getStippleAlpha() {
      bool isClamped;
      float stippleSDF = getStippleSDF(isClamped);

      float antiAliasedResult = ${t.stippleScaleWithLineWidth?a.a`clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);`:a.a`clamp(stippleSDF + 0.5, 0.0, 1.0);`}

      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
    }
  `),t.stippleOffColorEnabled?e.fragment.code.add(a.a`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`):e.fragment.code.add(a.a`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}(e,t):function(e){e.fragment.code.add(a.a`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}(e)}const s=a.a.float(.4)},895:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return c}));i(82);var r=i(436),a=i(750),n=i(94);const s=128,o=.5;function c(e,t=s,i=t*o,r=0){const c=l(e,t,i,r);return new a.a(c,{mipmap:!1,wrap:{s:n.B.CLAMP_TO_EDGE,t:n.B.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0})}function l(e,t=s,i=t*o,r=0){switch(e){default:return function(e,t){const i=e/2-.5;return f(e,u(i,i,t/2))}(t,i);case"square":return function(e,t){return d(e,t,!1)}(t,i);case"cross":return function(e,t,i=0){return h(e,t,!1,i)}(t,i,r);case"x":return function(e,t,i=0){return h(e,t,!0,i)}(t,i,r);case"kite":return function(e,t){return d(e,t,!0)}(t,i);case"triangle":return function(e,t){return f(e,p(e/2,t,t/2))}(t,i);case"arrow":return function(e,t){const i=t,r=t/2,a=e/2,n=.8*i,s=u(a,(e-t)/2-n,Math.sqrt(n*n+r*r)),o=p(a,i,r);return f(e,((e,t)=>Math.max(o(e,t),-s(e,t))))}(t,i)}}function d(e,t,i){return i&&(t/=Math.SQRT2),f(e,((r,a)=>{let n=r-.5*e+.25,s=.5*e-a-.75;if(i){const e=(n+s)/Math.SQRT2;s=(s-n)/Math.SQRT2,n=e}return Math.max(Math.abs(n),Math.abs(s))-.5*t}))}function h(e,t,i,r=0){t-=r,i&&(t*=Math.SQRT2);const a=.5*t;return f(e,((t,n)=>{let s,o=t-.5*e,c=.5*e-n-1;if(i){const e=(o+c)/Math.SQRT2;c=(c-o)/Math.SQRT2,o=e}return o=Math.abs(o),c=Math.abs(c),s=o>c?o>a?Math.sqrt((o-a)*(o-a)+c*c):c:c>a?Math.sqrt(o*o+(c-a)*(c-a)):o,s-=r/2,s}))}function u(e,t,i){return(r,a)=>{const n=r-e,s=a-t;return Math.sqrt(n*n+s*s)-i}}function p(e,t,i){const r=Math.sqrt(t*t+i*i);return(a,n)=>{const s=Math.abs(a-e)-i,o=n-e+t/2+.75,c=(t*s+i*o)/r,l=-o;return Math.max(c,l)}}function f(e,t){const i=new Uint8Array(4*e*e);for(let a=0;a<e;a++)for(let n=0;n<e;n++){const s=n+e*a;let o=t(n,a);o=o/e+.5,Object(r.a)(o,i,4*s)}return i}},896:function(e,t,i){"use strict";var r;i.d(t,"a",(function(){return r})),function(e){var t,i;(t=e.Geometry||(e.Geometry={}))[t.ADD=1]="ADD",t[t.UPDATE=2]="UPDATE",t[t.REMOVE=4]="REMOVE",(i=e.State||(e.State={}))[i.VISIBILITIES=1]="VISIBILITIES",i[i.VERTEXATTRS=2]="VERTEXATTRS",i[i.TRANSFORMATION=4]="TRANSFORMATION",i[i.HIGHLIGHTS=8]="HIGHLIGHTS",i[i.OCCLUDEES=16]="OCCLUDEES"}(r||(r={}))},898:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(126);function a(e){e.vertex.code.add(r.a`vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
vec3 camToVert = posWorld - camPosWorld;
bool isBackface = dot(camToVert, normalWorld) > 0.0;
if (isBackface) {
posClip.z += 0.0000003 * posClip.w;
}
return posClip;
}`)}},899:function(e,t,i){"use strict";i.d(t,"a",(function(){return f}));var r=i(210),a=i(301),n=i(478),s=i(703),o=i(639),c=i(915),l=i(622),d=i(420),h=i(623),u=i(397),p=i(126);function f(e,t){const i=e.vertex.code,f=e.fragment.code,b=t.hasModelTransformation;t.output!==r.a.Depth&&t.output!==r.a.Shadow||(e.include(n.a,{linearDepth:!0,hasModelTransformation:b}),e.include(o.a,t),e.include(h.a,t),e.include(l.a,t),e.include(a.a,t),e.vertex.uniforms.add("nearFar","vec2"),e.varyings.add("depth","float"),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),i.add(p.a`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPositionWithDepth(proj, view, ${b?"model,":""} vpos, nearFar, depth);
        forwardTextureCoordinates();
      }
    `),e.include(u.a,t),f.add(p.a`
      void main(void) {
        discardBySlice(vpos);
        ${t.hasColorTexture?p.a`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputDepth(depth);
      }
    `)),t.output===r.a.Normal&&(e.include(n.a,{linearDepth:!1,hasModelTransformation:b}),e.include(s.a,t),e.include(c.a,t),e.include(o.a,t),e.include(h.a,t),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),e.vertex.uniforms.add("viewNormal","mat4"),e.varyings.add("vPositionView","vec3"),i.add(p.a`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        ${t.normalType===s.b.Attribute?p.a`
        vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));`:""}
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, ${b?"model,":""} vpos);
        forwardTextureCoordinates();
      }
    `),e.include(a.a,t),e.include(u.a,t),f.add(p.a`
      void main() {
        discardBySlice(vpos);
        ${t.hasColorTexture?p.a`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}

        ${t.normalType===s.b.ScreenDerivative?p.a`
            vec3 normal = screenDerivativeNormal(vPositionView);`:p.a`
            vec3 normal = normalize(vNormalWorld);
            if (gl_FrontFacing == false) normal = -normal;`}
        gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
      }
    `)),t.output===r.a.Highlight&&(e.include(n.a,{linearDepth:!1,hasModelTransformation:b}),e.include(o.a,t),e.include(h.a,t),t.hasColorTexture&&e.fragment.uniforms.add("tex","sampler2D"),i.add(p.a`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, ${b?"model,":""} vpos);
        forwardTextureCoordinates();
      }
    `),e.include(a.a,t),e.include(u.a,t),e.include(d.a),f.add(p.a`
      void main() {
        discardBySlice(vpos);
        ${t.hasColorTexture?p.a`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputHighlight();
      }
    `))}},900:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(952),a=i(464),n=i(126);function s(e){e.include(a.a),e.code.add(n.a`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${n.a.int(r.a.Multiply)}) {
        return allMixed;
      }
      else if (mode == ${n.a.int(r.a.Ignore)}) {
        return internalMixed;
      }
      else if (mode == ${n.a.int(r.a.Replace)}) {
        return externalColor;
      }
      else {
        // tint (or something invalid)
        float vIn = rgb2v(internalMixed);
        vec3 hsvTint = rgb2hsv(externalColor);
        vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
        return hsv2rgb(hsvOut);
      }
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${n.a.int(r.a.Ignore)}) {
        return internalMixed;
      }
      else if (mode == ${n.a.int(r.a.Replace)}) {
        return externalOpacity;
      }
      else {
        // multiply or tint (or something invalid)
        return allMixed;
      }
    }
  `)}},913:function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));var r=i(639),a=i(126);function n(e){e.extensions.add("GL_EXT_shader_texture_lod"),e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(a.a`#ifndef GL_EXT_shader_texture_lod
float calcMipMapLevel(const vec2 ddx, const vec2 ddy) {
float deltaMaxSqr = max(dot(ddx, ddx), dot(ddy, ddy));
return max(0.0, 0.5 * log2(deltaMaxSqr));
}
#endif
vec4 textureAtlasLookup(sampler2D texture, vec2 textureSize, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
#ifdef GL_EXT_shader_texture_lod
return texture2DGradEXT(texture, uvAtlas, dUVdx, dUVdy);
#else
vec2 dUVdxAuto = dFdx(uvAtlas);
vec2 dUVdyAuto = dFdy(uvAtlas);
float mipMapLevel = calcMipMapLevel(dUVdx * textureSize, dUVdy * textureSize);
float autoMipMapLevel = calcMipMapLevel(dUVdxAuto * textureSize, dUVdyAuto * textureSize);
return texture2D(texture, uvAtlas, mipMapLevel - autoMipMapLevel);
#endif
}`)}function s(e,t){e.include(r.a,t),e.fragment.code.add(a.a`
  struct TextureLookupParameter {
    vec2 uv;
    ${t.supportsTextureAtlas?"vec2 size;":""}
  } vtc;
  `),t.attributeTextureCoordinates===r.b.Default&&e.fragment.code.add(a.a`vec4 textureLookup(sampler2D tex, TextureLookupParameter params) {
return texture2D(tex, params.uv);
}`),t.attributeTextureCoordinates===r.b.Atlas&&(e.include(n),e.fragment.code.add(a.a`vec4 textureLookup(sampler2D tex, TextureLookupParameter params) {
return textureAtlasLookup(tex, params.size, params.uv, vuvRegion);
}`))}},914:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i(952),a=i(126);function n(e){e.vertex.code.add(a.a`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${a.a.int(r.a.Multiply)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${a.a.int(r.a.Replace)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${a.a.int(r.a.Tint)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${a.a.int(r.a.Multiply)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}var s=i(139);function o(e,t){t.symbolColor?(e.include(n),e.attributes.add(s.a.SYMBOLCOLOR,"vec4"),e.varyings.add("colorMixMode","mediump float")):e.fragment.uniforms.add("colorMixMode","int"),t.symbolColor?e.vertex.code.add(a.a`int symbolColorMixMode;
vec4 getSymbolColor() {
return decodeSymbolColor(symbolColor, symbolColorMixMode) * 0.003921568627451;
}
void forwardColorMixMode() {
colorMixMode = float(symbolColorMixMode) + 0.5;
}`):e.vertex.code.add(a.a`vec4 getSymbolColor() { return vec4(1.0); }
void forwardColorMixMode() {}`)}},915:function(e,t,i){"use strict";i.d(t,"a",(function(){return l})),i.d(t,"b",(function(){return d}));var r=i(272),a=i(703),n=(i(367),i(200),i(109),i(802)),s=i(831),o=i(126);function c(e,t){e.include(n.a),e.vertex.include(s.a,t),e.varyings.add("vPositionWorldCameraRelative","vec3"),e.varyings.add("vPosition_view","vec3"),e.vertex.uniforms.add("transformWorldFromModelRS","mat3"),e.vertex.uniforms.add("transformWorldFromModelTH","vec3"),e.vertex.uniforms.add("transformWorldFromModelTL","vec3"),e.vertex.uniforms.add("transformWorldFromViewTH","vec3"),e.vertex.uniforms.add("transformWorldFromViewTL","vec3"),e.vertex.uniforms.add("transformViewFromCameraRelativeRS","mat3"),e.vertex.uniforms.add("transformProjFromView","mat4"),e.vertex.code.add(o.a`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = transformWorldFromModelRS * positionModel();
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}
vec3 position_view() {
return transformViewFromCameraRelativeRS * positionWorldCameraRelative();
}
void forwardPosition() {
vPositionWorldCameraRelative = positionWorldCameraRelative();
vPosition_view = position_view();
gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);
}
vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`),e.fragment.uniforms.add("transformWorldFromViewTL","vec3"),e.fragment.code.add(o.a`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`)}function l(e,t){t.normalType===a.b.Attribute||t.normalType===a.b.CompressedAttribute?(e.include(a.a,t),e.varyings.add("vNormalWorld","vec3"),e.varyings.add("vNormalView","vec3"),e.vertex.uniforms.add("transformNormalGlobalFromModel","mat3"),e.vertex.uniforms.add("transformNormalViewFromGlobal","mat3"),e.vertex.code.add(o.a`void forwardNormal() {
vNormalWorld = transformNormalGlobalFromModel * normalModel();
vNormalView = transformNormalViewFromGlobal * vNormalWorld;
}`)):t.normalType===a.b.Ground?(e.include(c,t),e.varyings.add("vNormalWorld","vec3"),e.vertex.code.add(o.a`
    void forwardNormal() {
      vNormalWorld = ${t.viewingMode===r.a.Global?o.a`normalize(vPositionWorldCameraRelative);`:o.a`vec3(0.0, 0.0, 1.0);`}
    }
    `)):e.vertex.code.add(o.a`void forwardNormal() {}`)}function d(e,t){e.setUniformMatrix4fv("viewNormal",t)}},921:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return a})),i.d(t,"c",(function(){return n})),i.d(t,"d",(function(){return s})),i.d(t,"e",(function(){return l})),i.d(t,"f",(function(){return c}));i(82);var r=i(116);function a(e,t,i,r){r.premultipliedAlpha&&function(e){const t=e.data,i=t.length;for(let r=0;r<i;r+=4){const e=t[r+3];if(e>0){const i=e/255;t[r+0]=t[r+0]/i,t[r+1]=t[r+1]/i,t[r+2]=t[r+2]/i}}}(e),i.width=e.width,i.height=e.height;const a=i.getContext("2d");a.putImageData(e,0,0),r.flipY&&function(e){e.save(),e.globalCompositeOperation="copy",e.scale(1,-1),e.translate(0,-e.canvas.height),e.drawImage(e.canvas,0,0),e.restore()}(a);const n=a.getImageData(0,0,e.width,e.height),s=function(e,t){const i=f[t.format],r=t.quality/100;return e.toDataURL(i,r)}(i,t);return i.width=0,i.height=0,{dataUrl:s,data:n}}function n(e,t){const i=p(e),a=m[i];return{format:i,quality:Object(r.e)(null!=t?t:a,0,100)}}function s(e,t){return t/Math.max(e[0],e[1])}function o(e,t,i){if(!e||!t)throw new Error("Cannot construct image data without dimensions");if(u)try{return new ImageData(e,t)}catch(r){u=!1}return d(e,t,i)}function c(e,t,i,r){if(!t||!i)throw new Error("Cannot construct image data without dimensions");if(u)try{return new ImageData(e,t,i)}catch(n){u=!1}const a=d(t,i,r);return a.data.set(e,0),a}function l(e,t,i,r=0,a=0,n=e.width-r,s=e.height-a,o=!1){const{data:c}=e,{width:l,height:d,data:h}=t,u=n/l,p=s/d,f=Math.ceil(u/2),b=Math.ceil(p/2),m=e.width;for(let g=0;g<d;g++)for(let e=0;e<l;e++){const t=4*(e+(o?d-g-1:g)*l);let n=0,s=0,v=0,O=0,y=0,_=0;const j=(g+.5)*p;for(let o=Math.floor(g*p);o<(g+1)*p;o++){const t=Math.abs(j-(o+.5))/b,l=(e+.5)*u,d=t*t;for(let h=Math.floor(e*u);h<(e+1)*u;h++){const e=Math.abs(l-(h+.5))/f,t=Math.sqrt(d+e*e);if(t>=1)continue;let u=2*t*t*t-3*t*t+1;const p=4*(r+h+(a+o)*m);_+=u*c[p+3],s+=u,!i&&c[p+3]<255&&(u=u*c[p+3]/255),v+=u*c[p],O+=u*c[p+1],y+=u*c[p+2],n+=u}}h[t]=v/n,h[t+1]=O/n,h[t+2]=y/n,h[t+3]=_/s}return t}function d(e,t,i){return i||(h||(h=document.createElement("canvas"),h.width=1,h.height=1),i=h),i.getContext("2d").createImageData(e,t)}let h=null,u=!0;function p(e){switch(e){case"png":case"jpg":case"jpeg":return e;default:return b}}const f={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},b="png",m={png:100,jpg:98,jpeg:98}},940:function(e,t,i){"use strict";i.d(t,"a",(function(){return m}));var r,a=i(79),n=(i(82),i(86)),s=i(81),o=(i(84),i(83)),c=i(93),l=i(80),d=i(92),h=i(150),u=i(921);const p=new WeakMap;let f=0,b=r=class extends n.a{constructor(e){super(e),this.wrap="repeat"}get url(){return this._get("url")||null}set url(e){this._set("url",e),e&&this._set("data",null)}get data(){return this._get("data")||null}set data(e){this._set("data",e),e&&this._set("url",null)}writeData(e,t,i,r){if(e instanceof HTMLImageElement){const a={type:"image-element",src:Object(h.f)(e.src,r),crossOrigin:e.crossOrigin};t[i]=a}else if(e instanceof HTMLCanvasElement){const r=e.getContext("2d").getImageData(0,0,e.width,e.height),a={type:"canvas-element",imageData:this._encodeImageData(r)};t[i]=a}else if(e instanceof HTMLVideoElement){const a={type:"video-element",src:Object(h.f)(e.src,r),autoplay:e.autoplay,loop:e.loop,muted:e.muted,crossOrigin:e.crossOrigin,preload:e.preload};t[i]=a}else{const r={type:"image-data",imageData:this._encodeImageData(e)};t[i]=r}}readData(e){switch(e.type){case"image-element":{const t=new Image;return t.src=e.src,t.crossOrigin=e.crossOrigin,t}case"canvas-element":{const t=this._decodeImageData(e.imageData),i=document.createElement("canvas");return i.width=t.width,i.height=t.height,i.getContext("2d").putImageData(t,0,0),i}case"image-data":return this._decodeImageData(e.imageData);case"video-element":{const t=document.createElement("video");return t.src=e.src,t.crossOrigin=e.crossOrigin,t.autoplay=e.autoplay,t.loop=e.loop,t.muted=e.muted,t.preload=e.preload,t}default:return}}get transparent(){const e=this.data,t=this.url;if(e instanceof HTMLCanvasElement)return this._imageDataContainsTransparent(e.getContext("2d").getImageData(0,0,e.width,e.height));if(e instanceof ImageData)return this._imageDataContainsTransparent(e);if(t){const e=t.substr(t.length-4,4).toLowerCase(),i=t.substr(0,15).toLocaleLowerCase();if(".png"===e||"data:image/png;"===i)return!0}return!1}set transparent(e){null!=e?this._override("transparent",e):this._clearOverride("transparent")}get contentHash(){const e="string"==typeof this.wrap?this.wrap:"object"==typeof this.wrap?`${this.wrap.horizontal}/${this.wrap.vertical}`:"",t=(t="")=>`d:${t},t:${this.transparent},w:${e}`;return null!=this.url?t(this.url):null!=this.data?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?t(this.data.src):(p.has(this.data)||p.set(this.data,++f),t(p.get(this.data))):t()}clone(){const e={url:this.url,data:this.data,wrap:this._cloneWrap()};return new r(e)}cloneWithDeduplication(e){const t=e.get(this);if(t)return t;const i=this.clone();return e.set(this,i),i}_cloneWrap(){return"string"==typeof this.wrap?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}}_encodeImageData(e){let t="";for(let i=0;i<e.data.length;i++)t+=String.fromCharCode(e.data[i]);return{data:btoa(t),width:e.width,height:e.height}}_decodeImageData(e){const t=atob(e.data),i=new Uint8ClampedArray(t.length);for(let r=0;r<t.length;r++)i[r]=t.charCodeAt(r);return Object(u.f)(i,e.width,e.height)}_imageDataContainsTransparent(e){for(let t=3;t<e.data.length;t+=4)if(255!==e.data[t])return!0;return!1}static from(e){return"string"==typeof e?new r({url:e}):e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof ImageData||e instanceof HTMLVideoElement?new r({data:e}):Object(o.d)(r,e)}};Object(a.a)([Object(s.b)({type:String,json:{write:h.g}})],b.prototype,"url",null),Object(a.a)([Object(s.b)({json:{write:{overridePolicy(){return{enabled:!this.url}}}}}),Object(s.b)()],b.prototype,"data",null),Object(a.a)([Object(d.a)("data")],b.prototype,"writeData",null),Object(a.a)([Object(c.a)("data")],b.prototype,"readData",null),Object(a.a)([Object(s.b)({type:Boolean,json:{write:{overridePolicy(){return{enabled:this._isOverridden("transparent")}}}}})],b.prototype,"transparent",null),Object(a.a)([Object(s.b)({json:{write:!0}})],b.prototype,"wrap",void 0),Object(a.a)([Object(s.b)({readOnly:!0})],b.prototype,"contentHash",null),b=r=Object(a.a)([Object(l.a)("esri.geometry.support.MeshTexture")],b);const m=b},941:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r,a=i(79),n=i(105),s=i(85),o=i(81),c=(i(84),i(82),i(83),i(80)),l=i(997),d=i(940);let h=r=class extends l.a{constructor(e){super(e),this.emissiveColor=null,this.emissiveTexture=null,this.occlusionTexture=null,this.metallic=1,this.roughness=1,this.metallicRoughnessTexture=null}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(e,t){const i=Object(s.k)(e)?e.get(this):null;if(i)return i;const a=new r(this.clonePropertiesWithDeduplication(t));return Object(s.k)(e)&&e.set(this,a),a}clonePropertiesWithDeduplication(e){return{...super.clonePropertiesWithDeduplication(e),emissiveColor:Object(s.k)(this.emissiveColor)?this.emissiveColor.clone():null,emissiveTexture:Object(s.k)(this.emissiveTexture)?this.emissiveTexture.cloneWithDeduplication(e):null,occlusionTexture:Object(s.k)(this.occlusionTexture)?this.occlusionTexture.cloneWithDeduplication(e):null,metallic:this.metallic,roughness:this.roughness,metallicRoughnessTexture:Object(s.k)(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.cloneWithDeduplication(e):null}}};Object(a.a)([Object(o.b)({type:n.a,json:{write:!0}})],h.prototype,"emissiveColor",void 0),Object(a.a)([Object(o.b)({type:d.a,json:{write:!0}})],h.prototype,"emissiveTexture",void 0),Object(a.a)([Object(o.b)({type:d.a,json:{write:!0}})],h.prototype,"occlusionTexture",void 0),Object(a.a)([Object(o.b)({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],h.prototype,"metallic",void 0),Object(a.a)([Object(o.b)({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],h.prototype,"roughness",void 0),Object(a.a)([Object(o.b)({type:d.a,json:{write:!0}})],h.prototype,"metallicRoughnessTexture",void 0),h=r=Object(a.a)([Object(c.a)("esri.geometry.support.MeshMaterialMetallicRoughness")],h);const u=h},942:function(e,t,i){"use strict";i.d(t,"a",(function(){return u})),i.d(t,"b",(function(){return f}));var r,a=i(79),n=i(86),s=i(89),o=i(87),c=i(81),l=i(104),d=i(80);const h=o.a.getLogger("esri.geometry.support.MeshVertexAttributes");let u=r=class extends n.a{constructor(e){super(e),this.color=null,this.position=new Float64Array(0),this.uv=null,this.normal=null,this.tangent=null}castColor(e){return f(e,Uint8Array,[Uint8ClampedArray],{loggerTag:".color=",stride:4},h)}castPosition(e){return e&&e instanceof Float32Array&&h.warn(".position=","Setting position attribute from a Float32Array may cause precision problems. Consider storing data in a Float64Array or a regular number array"),f(e,Float64Array,[Float32Array],{loggerTag:".position=",stride:3},h)}castUv(e){return f(e,Float32Array,[Float64Array],{loggerTag:".uv=",stride:2},h)}castNormal(e){return f(e,Float32Array,[Float64Array],{loggerTag:".normal=",stride:3},h)}castTangent(e){return f(e,Float32Array,[Float64Array],{loggerTag:".tangent=",stride:4},h)}clone(){const e={position:Object(s.a)(this.position),uv:Object(s.a)(this.uv),normal:Object(s.a)(this.normal),tangent:Object(s.a)(this.tangent),color:Object(s.a)(this.color)};return new r(e)}clonePositional(){const e={position:Object(s.a)(this.position),normal:Object(s.a)(this.normal),tangent:Object(s.a)(this.tangent),uv:this.uv,color:this.color};return new r(e)}};function p(e,t,i,r){const{loggerTag:a,stride:n}=t;return e.length%n!=0?(r.error(a,`Invalid array length, expected a multiple of ${n}`),new i([])):e}function f(e,t,i,r,a){if(!e)return e;if(e instanceof t)return p(e,r,t,a);for(const n of i)if(e instanceof n)return p(new t(e),r,t,a);if(Array.isArray(e))return p(new t(e),r,t,a);{const r=i.map((e=>`'${e.name}'`));return a.error(`Failed to set property, expected one of ${r}, but got ${e.constructor.name}`),new t([])}}function b(e,t,i){t[i]=function(e){const t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e[i];return t}(e)}Object(a.a)([Object(c.b)({json:{write:b}})],u.prototype,"color",void 0),Object(a.a)([Object(l.a)("color")],u.prototype,"castColor",null),Object(a.a)([Object(c.b)({nonNullable:!0,json:{write:b}})],u.prototype,"position",void 0),Object(a.a)([Object(l.a)("position")],u.prototype,"castPosition",null),Object(a.a)([Object(c.b)({json:{write:b}})],u.prototype,"uv",void 0),Object(a.a)([Object(l.a)("uv")],u.prototype,"castUv",null),Object(a.a)([Object(c.b)({json:{write:b}})],u.prototype,"normal",void 0),Object(a.a)([Object(l.a)("normal")],u.prototype,"castNormal",null),Object(a.a)([Object(c.b)({json:{write:b}})],u.prototype,"tangent",void 0),Object(a.a)([Object(l.a)("tangent")],u.prototype,"castTangent",null),u=r=Object(a.a)([Object(d.a)("esri.geometry.support.MeshVertexAttributes")],u)},943:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return l})),i.d(t,"c",(function(){return c}));var r,a,n=i(359),s=i(294),o=i(882);function c(e){const t=l(e.rings,e.hasZ,r.CCW_IS_HOLE),i=[];let a=0,s=0;for(const r of t.polygons){const e=r.count,o=r.index,c=new Float64Array(t.position.buffer,3*o*t.position.BYTES_PER_ELEMENT,3*e),l=r.holeIndices.map((e=>e-o)),d=new Uint32Array(Object(n.a)(c,l,3));i.push({position:c,faces:d}),a+=c.length,s+=d.length}const c=function(e,t,i){if(1===e.length)return e[0];const r=new Float64Array(t),a=new Uint32Array(i);let n=0,s=0,o=0;for(const c of e){for(let e=0;e<c.position.length;e++)r[n++]=c.position[e];for(let e=0;e<c.faces.length;e++)a[s++]=c.faces[e]+o;o=n/3}return{position:r,faces:a}}(i,a,s),d=Object(o.a)(c.position.buffer,6,{originalIndices:c.faces});return c.position=new Float64Array(d.buffer),c.faces=d.indices,c}function l(e,t,i){const a=e.length,n=new Array(a),s=new Array(a),o=new Array(a);let c=0,l=0,u=0,p=0;for(let r=0;r<a;++r)p+=e[r].length;const f=new Float64Array(3*p);let b=0;for(let m=a-1;m>=0;m--){const p=e[m],g=i===r.CCW_IS_HOLE&&h(p);if(g&&1!==a)n[c++]=p;else{let e=p.length;for(let t=0;t<c;++t)e+=n[t].length;const i={index:b,pathLengths:new Array(c+1),count:e,holeIndices:new Array(c)};i.pathLengths[0]=p.length,p.length>0&&(o[u++]={index:b,count:p.length}),b=g?d(p,p.length-1,-1,f,b,p.length,t):d(p,0,1,f,b,p.length,t);for(let r=0;r<c;++r){const e=n[r];i.holeIndices[r]=b,i.pathLengths[r+1]=e.length,e.length>0&&(o[u++]={index:b,count:e.length}),b=d(e,0,1,f,b,e.length,t)}c=0,i.count>0&&(s[l++]=i)}}for(let r=0;r<c;++r){const e=n[r];e.length>0&&(o[u++]={index:b,count:e.length}),b=d(e,0,1,f,b,e.length,t)}return l<a&&(s.length=l),u<a&&(o.length=u),{position:f,polygons:s,outlines:o}}function d(e,t,i,r,a,n,s){a*=3;for(let o=0;o<n;++o){const n=e[t];r[a++]=n[0],r[a++]=n[1],r[a++]=s?n[2]:0,t+=i}return a/3}function h(e){return!Object(s.g)(e,!1,!1)}(a=r||(r={}))[a.NONE=0]="NONE",a[a.CCW_IS_HOLE=1]="CCW_IS_HOLE"},945:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(126),a=i(139);function n(e,t){e.vertex.uniforms.add("intrinsicWidth","float"),t.vvSize?(e.attributes.add(a.a.SIZEFEATUREATTRIBUTE,"float"),e.vertex.uniforms.add("vvSizeMinSize","vec3"),e.vertex.uniforms.add("vvSizeMaxSize","vec3"),e.vertex.uniforms.add("vvSizeOffset","vec3"),e.vertex.uniforms.add("vvSizeFactor","vec3"),e.vertex.code.add(r.a`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(e.attributes.add(a.a.SIZE,"float"),e.vertex.code.add(r.a`float getSize(){
return intrinsicWidth * size;
}`)),t.vvOpacity?(e.attributes.add(a.a.OPACITYFEATUREATTRIBUTE,"float"),e.vertex.constants.add("vvOpacityNumber","int",8),e.vertex.code.add(r.a`uniform float vvOpacityValues[vvOpacityNumber];
uniform float vvOpacityOpacities[vvOpacityNumber];
float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):e.vertex.code.add(r.a`vec4 applyOpacity( vec4 color ){
return color;
}`),t.vvColor?(e.attributes.add(a.a.COLORFEATUREATTRIBUTE,"float"),e.vertex.constants.add("vvColorNumber","int",8),e.vertex.code.add(r.a`uniform float vvColorValues[vvColorNumber];
uniform vec4 vvColorColors[vvColorNumber];
vec4 interpolateColor( float value ) {
if (value <= vvColorValues[0]) {
return vvColorColors[0];
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return mix(vvColorColors[i-1], vvColorColors[i], f);
}
}
return vvColorColors[vvColorNumber - 1];
}
vec4 getColor(){
return applyOpacity(interpolateColor(colorFeatureAttribute));
}`)):(e.attributes.add(a.a.COLOR,"vec4"),e.vertex.code.add(r.a`vec4 getColor(){
return applyOpacity(color);
}`))}},946:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(126);function a(e){const t=r.a`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`,i=r.a`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`;e.vertex.code.add(t),e.vertex.code.add(i),e.fragment.code.add(t),e.fragment.code.add(i)}},947:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(126);function a(e){e.fragment.code.add(r.a`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}},948:function(e,t,i){"use strict";i.d(t,"a",(function(){return a}));var r=i(126);function a(e){e.fragment.uniforms.add("anchorPosition","vec3").add("anchorPositionCrossFade","vec3").add("fadeInOutFactor","float").add("cloudsHeight","float").add("rotationMatrixClouds","mat4").add("rotationMatrixCloudsCrossFade","mat4").add("radiusCurvatureCorrectionFactor","float").add("radius","float").add("cameraPosition","vec3").add("totalFadeInOut","float").add("crossFade","int").add("crossFadeAnchorFactor","float").add("cloudVariables","vec2").add("cubeMap","samplerCube"),e.fragment.code.add(r.a`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos, float radiusReduction)
{
vec3 dirAnchor = normalize(spherePos);
vec3 sphereOriginOffset = dirAnchor * radiusReduction;
float radiusClouds = radius + cloudsHeight - radiusReduction;
float B = 2.0 * dot(cameraPosition - sphereOriginOffset, dir);
float C = dot(cameraPosition - sphereOriginOffset, cameraPosition - sphereOriginOffset) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),e.fragment.code.add(r.a`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),e.fragment.code.add(r.a`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),e.fragment.code.add(r.a`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(lightingMainDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(lightingMainDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((lightingMainIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * pow(dirDotLight, RIM_SCATTERING_FACTOR) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),e.fragment.code.add(r.a`vec4 getCloudData(vec3 rayDir)
{
vec4 cloudData = textureCube(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
return mix(vec4(vec3(clamp(1.0 - cloudVariables.y, 0.6, 1.0)), 0.0), cloudData, smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(mu)));
}`),e.fragment.code.add(r.a`vec4 renderCloud(vec3 worldRay, vec3 position)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), position, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(normalize(-worldRay), cloudData), totalTransmittance);
}`),e.fragment.code.add(r.a`vec4 renderCloudCrossFade(vec3 worldRay, vec3 position)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), position, anchorPosition, 0.0);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColor = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), position, anchorPositionCrossFade, 0.0);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`)}},949:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return s}));var r=i(1007),a=i(126);function n(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(r.b),e.fragment.code.add(a.a`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}function s(e,t){e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}},950:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var r=i(272),a=i(126);function n(e,t){t.viewingMode===r.a.Global?e.vertex.code.add(a.a`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(a.a`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),t.viewingMode===r.a.Global?e.vertex.code.add(a.a`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(a.a`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}},951:function(e,t,i){"use strict";i.d(t,"a",(function(){return f})),i.d(t,"b",(function(){return b})),i.d(t,"c",(function(){return g})),i.d(t,"d",(function(){return m}));var r=i(85),a=i(200),n=i(109),s=i(187),o=i(223),c=i(294),l=i(463),d=i(607),h=i(568),u=i(659);const p=Object(n.f)();function f(e,t,i,n,c,l,h,f){const b=i?i.length:0,m=e.clippingExtent;if(Object(s.o)(t,p,e.elevationProvider.spatialReference),Object(r.k)(m)&&!Object(o.e)(m,p))return null;Object(s.o)(t,p,e.renderCoordsHelper.spatialReference);const g=e.localOriginFactory.getOrigin(p),v=new u.a({castShadow:!1,metadata:{layerUid:l,graphicUid:h,usesVerticalDistanceToGround:!0}});for(let r=0;r<b;r++){const e=a.a;v.addGeometry(i[r],n[r],e,g,f)}return{object:v,sampledElevation:Object(d.c)(v,t,e.elevationProvider,e.renderCoordsHelper,c)}}function b(e,t,i){const r=e.elevationContext,a=i.spatialReference;Object(s.o)(t,p,a),r.centerPointInElevationSR=Object(l.g)(p[0],p[1],t.hasZ?p[2]:0,a)}function m(e){switch(e.type){case"point":return e;case"polygon":case"extent":return Object(h.a)(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const i=Object(c.f)(t,Object(c.e)(t)/2);return Object(l.g)(i[0],i[1],i[2],e.spatialReference)}case"mesh":return e.origin}return null}function g(e,t,i,r,a){const n=new Float64Array(3*e.length),s=new Float64Array(n.length);e.forEach(((e,t)=>{n[3*t+0]=e[0],n[3*t+1]=e[1],n[3*t+2]=e.length>2?e[2]:0}));const o=Object(d.d)(n,t,0,s,0,n,0,n.length/3,i,r,a),c=null!=o;return{numVertices:e.length,position:n,mapPosition:s,projectionSuccess:c,sampledElevation:o}}},952:function(e,t,i){"use strict";i.d(t,"a",(function(){return r})),i.d(t,"b",(function(){return c})),i.d(t,"c",(function(){return o}));var r,a,n=i(116),s=i(85);function o(e){switch(e){default:return r.Multiply;case"ignore":return r.Ignore;case"replace":return r.Replace;case"tint":return r.Tint}}function c(e,t,i){if(Object(s.j)(e)||t===r.Ignore)return i[0]=255,i[1]=255,i[2]=255,void(i[3]=255);const a=Object(n.e)(Math.round(e[3]*d),0,d),o=0===a||t===r.Tint?0:t===r.Replace?h:u;i[0]=Object(n.e)(Math.round(e[0]*l),0,l),i[1]=Object(n.e)(Math.round(e[1]*l),0,l),i[2]=Object(n.e)(Math.round(e[2]*l),0,l),i[3]=a+o}(a=r||(r={}))[a.Multiply=1]="Multiply",a[a.Ignore=2]="Ignore",a[a.Replace=3]="Replace",a[a.Tint=4]="Tint";const l=255,d=85,h=d,u=2*d},963:function(e,t,i){"use strict";i.d(t,"a",(function(){return m}));var r=i(85),a=i(244),n=i(147),s=i(200),o=i(117),c=i(257),l=i(629),d=i(163),h=i(562);class u{constructor(){this.visible=!0}}var p=i(796),f=i(139),b=i(513);class m{constructor(e,t,i={}){this.data=e,this.material=t,this.boundingSphere=Object(c.e)(),this.instanceParameters=new u,this._transformation=Object(s.d)(),this._shaderTransformationDirty=!0,this.layerUid=Object(r.t)(i.layerUid,null),this.graphicUid=Object(r.t)(i.graphicUid,null),this.id=i.id?i.id:Object(a.a)(),this.boundingInfo=Object(r.t)(i.boundingInfo,null),this.calculateShaderTransformation=Object(r.t)(this.calculateShaderTransformation,null),this.castShadow=!!i.castShadow&&i.castShadow}get transformation(){return this._transformation}updateTransformation(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(e,t,i=Object(l.c)(e)){Object(r.j)(this.boundingInfo)||(Object(o.q)(t,this.boundingInfo.getCenter(),e),t[3]=this.boundingInfo.getBSRadius()*i)}get hasShaderTransformation(){return Object(r.k)(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return Object(r.j)(this.calculateShaderTransformation)?Object(r.t)(this.transformation,s.a):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=Object(s.d)()),Object(n.c)(this._shaderTransformation,this.calculateShaderTransformation(Object(r.t)(this.transformation,s.a))),this._shaderTransformationDirty=!1),this._shaderTransformation)}computeAttachmentOrigin(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&(Object(r.k)(this._transformation)&&Object(o.q)(e,e,this._transformation),!0);const t=this.indices.get(f.a.POSITION),i=this.vertexAttributes.get(f.a.POSITION);return!!Object(h.c)(i,t,e)&&(Object(r.k)(this._transformation)&&Object(o.q)(e,e,this._transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const e=new p.a(d.d.Highlight),t=this.instanceParameters;return t.highlights=Object(b.a)(t.highlights,e),e}removeHighlight(e){const t=this.instanceParameters;t.highlights=Object(b.e)(t.highlights,e)}}},984:function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return o}));i(82);var r=i(88),a=i(85),n=i(306);function s(e){return Object(a.j)(e)||"simple"===e.type||"unique-value"===e.type||"class-breaks"===e.type||"dictionary"===e.type||"heatmap"===e.type}function o(e){if(Object(a.j)(e))return null;if(!s(e))return new r.a("renderer-conversion-3d:unsupported-renderer",`Unsupported renderer of type '${e.type||e.declaredClass}'`,{renderer:e});switch(e.type){case"simple":return c(t=e,Object(n.a)(t.symbol).error);case"unique-value":return function(e){const t=e.uniqueValueInfos.map((e=>Object(n.a)(e.symbol).error)).filter((e=>!!e)),i=Object(n.a)(e.defaultSymbol);return i.error&&t.unshift(i.error),c(e,t)}(e);case"class-breaks":return function(e){const t=e.classBreakInfos.map((e=>Object(n.a)(e.symbol).error)).filter((e=>!!e)),i=Object(n.a)(e.defaultSymbol);return i.error&&t.unshift(i.error),c(e,t)}(e);case"dictionary":case"heatmap":return null}var t;return null}function c(e,t){if(!t)return null;let i;if(i=Array.isArray(t)?t:[t],i.length>0){const t=i.map((e=>e.details.symbol.type||e.details.symbol.declaredClass)).filter((e=>!!e));t.sort();const a=[];return t.forEach(((e,i)=>{0!==i&&e===t[i-1]||a.push(e)})),new r.a("renderer-conversion-3d:unsupported-symbols",`Renderer contains symbols (${a.join(", ")}) which are not supported in 3D`,{renderer:e,symbolErrors:i})}return null}},991:function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var r=i(84),a=i(85),n=i(212),s=i(810);class o{constructor(e=9,t){this.compareMinX=h,this.compareMinY=u,this._toBBox=function(e){return e},this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&("function"==typeof t?this._toBBox=t:this._initFormat(t)),this.clear()}destroy(){this.clear(),y.prune(),_.prune(),j.prune(),x.prune()}all(e){this._all(this.data,e)}search(e,t){let i=this.data;const r=this._toBBox;if(v(e,i))for(y.clear();i;){for(let a=0,n=i.children.length;a<n;a++){const n=i.children[a],s=i.leaf?r(n):n;v(e,s)&&(i.leaf?t(n):g(e,s)?this._all(n,t):y.push(n))}i=y.pop()}}collides(e){let t=this.data;const i=this._toBBox;if(!v(e,t))return!1;for(y.clear();t;){for(let r=0,a=t.children.length;r<a;r++){const a=t.children[r],n=t.leaf?i(a):a;if(v(e,n)){if(t.leaf||g(e,n))return!0;y.push(a)}}t=y.pop()}return!1}load(e){if(!e.length)return this;if(e.length<this._minEntries){for(let t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}let t=this._build(e.slice(0,e.length),0,e.length-1,0);if(this.data.children.length)if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const e=this.data;this.data=t,t=e}this._insert(t,this.data.height-t.height-1,!0)}else this.data=t;return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=new T([]),this}remove(e){if(!e)return this;let t,i=this.data,n=null,s=0,o=!1;const c=this._toBBox(e);for(j.clear(),x.clear();i||j.length>0;){var l;if(i||(i=Object(a.c)(j.pop()),n=j.data[j.length-1],s=null!=(l=x.pop())?l:0,o=!0),i.leaf&&(t=Object(r.e)(i.children,e,i.children.length,i.indexHint),-1!==t))return i.children.splice(t,1),j.push(i),this._condense(j),this;o||i.leaf||!g(i,c)?n?(s++,i=n.children[s],o=!1):i=null:(j.push(i),x.push(s),s=0,n=i,i=i.children[0])}return this}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){let i=e;for(_.clear();i;){var r;if(!0===i.leaf)for(const e of i.children)t(e);else _.pushArray(i.children);i=null!=(r=_.pop())?r:null}}_build(e,t,i,r){const a=i-t+1;let n=this._maxEntries;if(a<=n){const r=new T(e.slice(t,i+1));return c(r,this._toBBox),r}r||(r=Math.ceil(Math.log(a)/Math.log(n)),n=Math.ceil(a/n**(r-1)));const s=new C([]);s.height=r;const o=Math.ceil(a/n),l=o*Math.ceil(Math.sqrt(n));O(e,t,i,l,this.compareMinX);for(let c=t;c<=i;c+=l){const t=Math.min(c+l-1,i);O(e,c,t,o,this.compareMinY);for(let i=c;i<=t;i+=o){const a=Math.min(i+o-1,t);s.children.push(this._build(e,i,a,r-1))}}return c(s,this._toBBox),s}_chooseSubtree(e,t,i,r){for(;r.push(t),!0!==t.leaf&&r.length-1!==i;){let i,r=1/0,a=1/0;for(let n=0,s=t.children.length;n<s;n++){const s=t.children[n],o=p(s),c=b(e,s)-o;c<a?(a=c,r=o<r?o:r,i=s):c===a&&o<r&&(r=o,i=s)}t=i||t.children[0]}return t}_insert(e,t,i){const r=this._toBBox,a=i?e:r(e);j.clear();const n=this._chooseSubtree(a,this.data,t,j);for(n.children.push(e),d(n,a);t>=0&&j.data[t].children.length>this._maxEntries;)this._split(j,t),t--;this._adjustParentBBoxes(a,j,t)}_split(e,t){const i=e.data[t],r=i.children.length,a=this._minEntries;this._chooseSplitAxis(i,a,r);const n=this._chooseSplitIndex(i,a,r);if(!n)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const s=i.children.splice(n,i.children.length-n),o=i.leaf?new T(s):new C(s);o.height=i.height,c(i,this._toBBox),c(o,this._toBBox),t?e.data[t-1].children.push(o):this._splitRoot(i,o)}_splitRoot(e,t){this.data=new C([e,t]),this.data.height=e.height+1,c(this.data,this._toBBox)}_chooseSplitIndex(e,t,i){let r,a,n;r=a=1/0;for(let s=t;s<=i-t;s++){const t=l(e,0,s,this._toBBox),o=l(e,s,i,this._toBBox),c=m(t,o),d=p(t)+p(o);c<r?(r=c,n=s,a=d<a?d:a):c===r&&d<a&&(a=d,n=s)}return n}_chooseSplitAxis(e,t,i){const r=e.leaf?this.compareMinX:h,a=e.leaf?this.compareMinY:u;this._allDistMargin(e,t,i,r)<this._allDistMargin(e,t,i,a)&&e.children.sort(r)}_allDistMargin(e,t,i,r){e.children.sort(r);const a=this._toBBox,n=l(e,0,t,a),s=l(e,i-t,i,a);let o=f(n)+f(s);for(let c=t;c<i-t;c++){const t=e.children[c];d(n,e.leaf?a(t):t),o+=f(n)}for(let c=i-t-1;c>=t;c--){const t=e.children[c];d(s,e.leaf?a(t):t),o+=f(s)}return o}_adjustParentBBoxes(e,t,i){for(let r=i;r>=0;r--)d(t.data[r],e)}_condense(e){for(let t=e.length-1;t>=0;t--){const i=e.data[t];if(0===i.children.length)if(t>0){const a=e.data[t-1],n=a.children;n.splice(Object(r.e)(n,i,n.length,a.indexHint),1)}else this.clear();else c(i,this._toBBox)}}_initFormat(e){const t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this._toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}function c(e,t){l(e,0,e.children.length,t,e)}function l(e,t,i,r,a){a||(a=new T([])),a.minX=1/0,a.minY=1/0,a.maxX=-1/0,a.maxY=-1/0;for(let n,s=t;s<i;s++)n=e.children[s],d(a,e.leaf?r(n):n);return a}function d(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function h(e,t){return e.minX-t.minX}function u(e,t){return e.minY-t.minY}function p(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function f(e){return e.maxX-e.minX+(e.maxY-e.minY)}function b(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function m(e,t){const i=Math.max(e.minX,t.minX),r=Math.max(e.minY,t.minY),a=Math.min(e.maxX,t.maxX),n=Math.min(e.maxY,t.maxY);return Math.max(0,a-i)*Math.max(0,n-r)}function g(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function v(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function O(e,t,i,r,n){const o=[t,i];for(;o.length;){const t=Object(a.c)(o.pop()),i=Object(a.c)(o.pop());if(t-i<=r)continue;const c=i+Math.ceil((t-i)/r/2)*r;Object(s.a)(e,c,i,t,n),o.push(i,c,c,t)}}const y=new n.a,_=new n.a,j=new n.a,x=new n.a({deallocator:void 0});class S extends class{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}{constructor(){super(...arguments),this.height=1,this.indexHint=new r.a}}class T extends S{constructor(e){super(),this.children=e,this.leaf=!0}}class C extends S{constructor(e){super(),this.children=e,this.leaf=!1}}},996:function(e,t,i){"use strict";i.d(t,"a",(function(){return g}));var r,a=i(79),n=i(86),s=i(89),o=i(87),c=i(81),l=i(104),d=i(80),h=i(83),u=i(997),p=i(941),f=i(942);const b=o.a.getLogger("esri.geometry.support.MeshComponent");let m=r=class extends n.a{constructor(e){super(e),this.faces=null,this.material=null,this.shading="source",this.trustSourceNormals=!1}static from(e){return Object(h.d)(r,e)}castFaces(e){return Object(f.b)(e,Uint32Array,[Uint16Array],{loggerTag:".faces=",stride:3},b)}castMaterial(e){return Object(h.d)(e&&"object"==typeof e&&("metallic"in e||"roughness"in e||"metallicRoughnessTexture"in e)?p.a:u.a,e)}clone(){return new r({faces:Object(s.a)(this.faces),shading:this.shading,material:Object(s.a)(this.material),trustSourceNormals:this.trustSourceNormals})}cloneWithDeduplication(e,t){const i={faces:Object(s.a)(this.faces),shading:this.shading,material:this.material?this.material.cloneWithDeduplication(e,t):null,trustSourceNormals:this.trustSourceNormals};return new r(i)}};Object(a.a)([Object(c.b)({json:{write:!0}})],m.prototype,"faces",void 0),Object(a.a)([Object(l.a)("faces")],m.prototype,"castFaces",null),Object(a.a)([Object(c.b)({type:u.a,json:{write:!0}})],m.prototype,"material",void 0),Object(a.a)([Object(l.a)("material")],m.prototype,"castMaterial",null),Object(a.a)([Object(c.b)({type:String,json:{write:!0}})],m.prototype,"shading",void 0),Object(a.a)([Object(c.b)({type:Boolean})],m.prototype,"trustSourceNormals",void 0),m=r=Object(a.a)([Object(d.a)("esri.geometry.support.MeshComponent")],m);const g=m},997:function(e,t,i){"use strict";i.d(t,"a",(function(){return u}));var r,a=i(79),n=i(105),s=i(86),o=i(85),c=i(81),l=(i(84),i(82),i(83),i(80)),d=i(940);let h=r=class extends s.a{constructor(e){super(e),this.color=null,this.colorTexture=null,this.normalTexture=null,this.alphaMode="auto",this.alphaCutoff=.5,this.doubleSided=!0}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(e,t){const i=Object(o.k)(e)?e.get(this):null;if(i)return i;const a=new r(this.clonePropertiesWithDeduplication(t));return Object(o.k)(e)&&e.set(this,a),a}clonePropertiesWithDeduplication(e){return{color:Object(o.k)(this.color)?this.color.clone():null,colorTexture:Object(o.k)(this.colorTexture)?this.colorTexture.cloneWithDeduplication(e):null,normalTexture:Object(o.k)(this.normalTexture)?this.normalTexture.cloneWithDeduplication(e):null,alphaMode:this.alphaMode,alphaCutoff:this.alphaCutoff,doubleSided:this.doubleSided}}};Object(a.a)([Object(c.b)({type:n.a,json:{write:!0}})],h.prototype,"color",void 0),Object(a.a)([Object(c.b)({type:d.a,json:{write:!0}})],h.prototype,"colorTexture",void 0),Object(a.a)([Object(c.b)({type:d.a,json:{write:!0}})],h.prototype,"normalTexture",void 0),Object(a.a)([Object(c.b)({nonNullable:!0,json:{write:!0}})],h.prototype,"alphaMode",void 0),Object(a.a)([Object(c.b)({nonNullable:!0,json:{write:!0}})],h.prototype,"alphaCutoff",void 0),Object(a.a)([Object(c.b)({nonNullable:!0,json:{write:!0}})],h.prototype,"doubleSided",void 0),h=r=Object(a.a)([Object(l.a)("esri.geometry.support.MeshMaterial")],h);const u=h}}]);
//# sourceMappingURL=73.f6856e58.chunk.js.map