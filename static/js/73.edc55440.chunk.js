(this.webpackJsonpimaps=this.webpackJsonpimaps||[]).push([[73],{1235:function(e,t,i){"use strict";i.r(t);var a=i(15),r=i(7),n=i.n(r),s=i(16),l=i(2),o=i(3),c=i(30),h=i(28),u=i(4),y=i(5),d=i(0),f=i(14),v=i(6),p=i(12),_=(i(17),i(1)),b=i(8),g=i(20),m=(i(11),i(18),i(19),i(24)),w=i(72),O=i(49),j=i(540),k=i(105),S=i(596),T=i(652),x=i(636),R=i(845),C=i(846),I=i(10),P=i(54),L=i(569),M=i(357),D=i(200),q=i(629),U=(i(292),i(512),i(100)),z=(i(352),i(912)),H=function(){function e(t,i){Object(l.a)(this,e),this._width=0,this._height=0,this._free=[],this._width=t,this._height=i,this._free.push(new z.a(0,0,t,i))}return Object(o.a)(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"allocate",value:function(e,t){if(e>this._width||t>this._height)return new z.a;for(var i=null,a=-1,r=0;r<this._free.length;++r){var n=this._free[r];e<=n.width&&t<=n.height&&(null===i||n.y<=i.y&&n.x<=i.x)&&(i=n,a=r)}return null===i?new z.a:(this._free.splice(a,1),i.width<i.height?(i.width>e&&this._free.push(new z.a(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new z.a(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new z.a(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new z.a(i.x,i.y+t,e,i.height-t))),new z.a(i.x,i.y,e,t))}},{key:"release",value:function(e){for(var t=0;t<this._free.length;++t){var i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}]),e}(),A=function(){function e(t,i,a){Object(l.a)(this,e),this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=i,this._glyphSource=a,this._binPack=new H(t-4,i-4),this._glyphData.push(new Uint8Array(t*i)),this._dirties.push(!0),this._textures.push(void 0)}return Object(o.a)(e,[{key:"getGlyphItems",value:function(e,t){var i,r=this,n=[],s=this._glyphSource,l=new Set,o=Object(a.a)(t);try{for(o.s();!(i=o.n()).done;){var c=i.value,h=Math.floor(.00390625*c);l.add(h)}}catch(y){o.e(y)}finally{o.f()}var u=[];return l.forEach((function(t){if(t<=256){var i=e+t;if(r._rangePromises.has(i))u.push(r._rangePromises.get(i));else{var a=s.getRange(e,t).then((function(){r._rangePromises.delete(i)}),(function(){r._rangePromises.delete(i)}));r._rangePromises.set(i,a),u.push(a)}}})),Promise.all(u).then((function(){var i=r._glyphIndex[e];i||(i={},r._glyphIndex[e]=i);var l,o=Object(a.a)(t);try{for(o.s();!(l=o.n()).done;){var c=l.value,h=i[c];if(h)n[c]={sdf:!0,rect:h.rect,metrics:h.metrics,page:h.page,code:c};else{var u=s.getGlyph(e,c);if(u&&u.metrics){var d=u.metrics,f=void 0;if(0===d.width)f=new z.a(0,0,0,0);else{var v=d.width+6,p=d.height+6,_=v%4?4-v%4:4,b=p%4?4-p%4:4;1===_&&(_=5),1===b&&(b=5),(f=r._binPack.allocate(v+_,p+b)).isEmpty&&(r._dirties[r._currentPage]||(r._glyphData[r._currentPage]=null),r._currentPage=r._glyphData.length,r._glyphData.push(new Uint8Array(r.width*r.height)),r._dirties.push(!0),r._textures.push(void 0),r._binPack=new H(r.width-4,r.height-4),f=r._binPack.allocate(v+_,p+b));var g=r._glyphData[r._currentPage],m=u.bitmap,w=void 0,O=void 0;if(m)for(var j=0;j<p;j++){w=v*j,O=r.width*(f.y+j+1)+f.x;for(var k=0;k<v;k++)g[O+k+1]=m[w+k]}}i[c]={rect:f,metrics:d,tileIDs:null,page:r._currentPage},n[c]={sdf:!0,rect:f,metrics:d,page:r._currentPage,code:c},r._dirties[r._currentPage]=!0}}}}catch(y){o.e(y)}finally{o.f()}return n}))}},{key:"removeGlyphs",value:function(e){for(var t in this._glyphIndex){var i=this._glyphIndex[t];if(i){var a=void 0;for(var r in i)if((a=i[r]).tileIDs.delete(e),0===a.tileIDs.size){for(var n=this._glyphData[a.page],s=a.rect,l=void 0,o=void 0,c=0;c<s.height;c++)for(l=this.width*(s.y+c)+s.x,o=0;o<s.width;o++)n[l+o]=0;delete i[r],this._dirties[a.page]=!0}}}}},{key:"bind",value:function(e,t,i){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this._textures[i]||(this._textures[i]=new U.a(e,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));var r=this._textures[i];r.setSamplingMode(t),this._dirties[i]&&r.setData(this._glyphData[i]),e.bindTexture(r,a),this._dirties[i]=!1}},{key:"dispose",value:function(){this._binPack=null;var e,t=Object(a.a)(this._textures);try{for(t.s();!(e=t.n()).done;){var i=e.value;i&&i.dispose()}}catch(r){t.e(r)}finally{t.f()}this._textures.length=0}}]),e}(),V=i(555),F=function(){function e(t){if(Object(l.a)(this,e),this._metrics=[],this._bitmaps=[],t)for(;t.next();)switch(t.tag()){case 1:for(var i=t.getMessage();i.next();)switch(i.tag()){case 3:for(var a=i.getMessage(),r=void 0,n=void 0,s=void 0,o=void 0,c=void 0,h=void 0,u=void 0;a.next();)switch(a.tag()){case 1:r=a.getUInt32();break;case 2:n=a.getBytes();break;case 3:s=a.getUInt32();break;case 4:o=a.getUInt32();break;case 5:c=a.getSInt32();break;case 6:h=a.getSInt32();break;case 7:u=a.getUInt32();break;default:a.skip()}a.release(),r&&(this._metrics[r]={width:s,height:o,left:c,top:h,advance:u},this._bitmaps[r]=n);break;default:i.skip()}i.release();break;default:t.skip()}}return Object(o.a)(e,[{key:"getMetrics",value:function(e){return this._metrics[e]}},{key:"getBitmap",value:function(e){return this._bitmaps[e]}}]),e}(),N=function(){function e(){Object(l.a)(this,e),this._ranges=[]}return Object(o.a)(e,[{key:"getRange",value:function(e){return this._ranges[e]}},{key:"addRange",value:function(e,t){this._ranges[e]=t}}]),e}(),B=function(){function e(t){Object(l.a)(this,e),this._glyphInfo={},this._baseURL=t}return Object(o.a)(e,[{key:"getRange",value:function(e,t){var i=this._getFontStack(e);if(i.getRange(t))return Promise.resolve();var a=256*t,r=a+255,n=this._baseURL.replace("{fontstack}",e).replace("{range}",a+"-"+r);return Object(P.default)(n,{responseType:"array-buffer"}).then((function(e){i.addRange(t,new F(new V.a(new Uint8Array(e.data),new DataView(e.data))))})).catch((function(){i.addRange(t,new F)}))}},{key:"getGlyph",value:function(e,t){var i=this._getFontStack(e);if(i){var a=Math.floor(t/256);if(!(a>256)){var r=i.getRange(a);return r?{metrics:r.getMetrics(t),bitmap:r.getBitmap(t)}:void 0}}}},{key:"_getFontStack",value:function(e){var t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new N),t}}]),e}(),Q=i(29),E=function(){function e(t,i){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;Object(l.a)(this,e),this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,(t<=0||i<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=i,a>0&&(this._maxItemSize=a),this._binPack=new H(t-4,i-4)}return Object(o.a)(e,[{key:"getWidth",value:function(e){return e>=this._size.length?-1:this._size[e][0]}},{key:"getHeight",value:function(e){return e>=this._size.length?-1:this._size[e][1]}},{key:"setSpriteSource",value:function(e){if(this.dispose(),this.pixelRatio=e.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new H(this._pageWidth-4,this._pageHeight-4);var t=Math.floor(this._pageWidth),i=Math.floor(this._pageHeight),a=new Uint32Array(t*i);this._mosaicsData[0]=a,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=e}},{key:"getSpriteItem",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this._mosaicRects[e];if(i)return i;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;var a=this._sprites.getSpriteInfo(e);if(!a||!a.width||!a.height||a.width<0||a.height<0)return null;var r=a.width,n=a.height,s=this._allocateImage(r,n),l=Object(Q.a)(s,3),o=l[0],c=l[1],h=l[2];return o.width<=0?null:(this._copy(o,a,c,h,t),i={rect:o,width:r,height:n,sdf:a.sdf,simplePattern:!1,pixelRatio:a.pixelRatio,page:c},this._mosaicRects[e]=i,i)}},{key:"getSpriteItems",value:function(e){var t,i={},r=Object(a.a)(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;i[n]=this.getSpriteItem(n)}}catch(s){r.e(s)}finally{r.f()}return i}},{key:"getMosaicItemPosition",value:function(e,t){var i=this.getSpriteItem(e,t),a=i&&i.rect;if(!a)return null;a.width=i.width,a.height=i.height;var r=i.width,n=i.height,s=this._size[i.page];return{size:[i.width,i.height],tl:[(a.x+2)/s[0],(a.y+2)/s[1]],br:[(a.x+2+r)/s[0],(a.y+2+n)/s[1]],page:i.page}}},{key:"bind",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this._textures[i]||(this._textures[i]=new U.a(e,{pixelFormat:6408,dataType:5121,wrapMode:33071,width:this._size[i][0],height:this._size[i][1]},new Uint8Array(this._mosaicsData[i].buffer)));var r=this._textures[i];r.setSamplingMode(t),this._dirties[i]&&r.setData(new Uint8Array(this._mosaicsData[i].buffer)),e.bindTexture(r,a),this._dirties[i]=!1}},{key:"_copy",value:function(t,i,a,r,n,s){if(this._sprites&&"loaded"===this._sprites.loadStatus&&!(a>=this._mosaicsData.length)){var l=new Uint32Array(s?s.buffer:this._sprites.image.buffer),o=this._mosaicsData[a];o&&l||console.error("Source or target images are uninitialized!");var c=s?i.width:this._sprites.width;e._copyBits(l,c,i.x,i.y,o,r[0],t.x+2,t.y+2,i.width,i.height,n),this._dirties[a]=!0}}},{key:"_allocateImage",value:function(e,t){e+=2,t+=2;var i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){var a=new z.a(0,0,e,t);return this._mosaicsData.push(new Uint32Array(e*t)),this._dirties.push(!0),this._size.push([e,t]),this._textures.push(void 0),[a,this._mosaicsData.length-1,[e,t]]}var r=e%4?4-e%4:4,n=t%4?4-t%4:4;1===r&&(r=5),1===n&&(n=5);var s=this._binPack.allocate(e+r,t+n);return s.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new H(this._pageWidth-4,this._pageHeight-4),this._allocateImage(e,t)):[s,this._currentPage,[this._pageWidth,this._pageHeight]]}},{key:"dispose",value:function(){this._binPack=null,this._mosaicRects={};var e,t=Object(a.a)(this._textures);try{for(t.s();!(e=t.n()).done;){var i=e.value;i&&i.dispose()}}catch(r){t.e(r)}finally{t.f()}this._textures.length=0}}],[{key:"_copyBits",value:function(e,t,i,a,r,n,s,l,o,c,h){var u=a*t+i,y=l*n+s;if(h){y-=n;for(var d=-1;d<=c;u=((++d+c)%c+a)*t+i,y+=n)for(var f=-1;f<=o;f++)r[y+f]=e[u+(f+o)%o]}else for(var v=0;v<c;v++){for(var p=0;p<o;p++)r[y+p]=e[u+p];u+=t,y+=n}}}]),e}();function J(e,t,i,a,r,n){e.fillStyle=t,e.fillRect(i,a,r,n)}function W(e,t,i,a,r,n){e.strokeStyle=t,e.strokeRect(i,a,r,n)}function G(e,t){e.strokeStyle="black";for(var i=t.cellSize,a=t.rows,r=t.columns,n=0;n<a;n++)for(var s=t.cells[n],l=n*i,o=(n+1)*i,c=0;c<r;c++){var h=s[c],u=c*i,y=(c+1)*i;e.strokeRect(u,l,y-u,o-l),e.fillText("cells:".concat(h.length),u+4,l+12)}}function K(e,t){for(var i=window.COLLISION_XRAY,r=0;r<t.length;++r){var n=!t[r].unique.show;if(i||!n){var s,l=Object(a.a)(t[r].colliders);try{for(l.s();!(s=l.n()).done;){var o=s.value;if(o.enabled){var c=!t[r].unique.parts[o.partIndex].show;if(i||!c){var h=o.xScreen,u=o.yScreen,y=o.dxScreen,d=o.dyScreen;e.globalAlpha=n||c?.2:1,J(e,"green",h-1,u-1,3,3),W(e,"red",h+y,u+d,o.width,o.height),J(e,"blue",h+y-1,u+d-1,3,3),e.globalAlpha=1}}}}catch(f){l.e(f)}finally{l.f()}}}}var X=new L.a(10),Z=new Map,Y=function(){function e(t,i,a){Object(l.a)(this,e),this._vectorTileLayer=t,this._styleRepository=i,this.devicePixelRatio=a,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null}return Object(o.a)(e,[{key:"destroy",value:function(){this._connection&&(this._connection.close(),this._connection=null),this._styleRepository=null,this._vectorTileLayer=null,this._spriteMosaic&&(this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic=null)}},{key:"spriteMosaic",get:function(){var e=this;return this._spriteSourcePromise.then((function(){return e._spriteMosaic}))}},{key:"glyphMosaic",get:function(){return this._glyphMosaic}},{key:"start",value:function(){var e=Object(s.a)(n.a.mark((function e(t){var i,a,r,s,l,o,c=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(s in i=this._vectorTileLayer,a=i.sourceNameToSource,r=[],a)r.push(this._fetchTileMap(a[s],t));return this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,t),this._spriteSourcePromise.then((function(e){c._spriteMosaic=new E(1024,1024,250),c._spriteMosaic.setSpriteSource(e)})),l=this._styleRepository,o=new B(l.glyphs),e.abrupt("return",(this._glyphMosaic=new A(1024,1024,o),this._broadcastPromise=Object(M.b)("WorkerTileHandler",{client:this,scheduler:t.scheduler,signal:t.signal}).then((function(e){return c._connection=e,Promise.all(c._connection.broadcast("setStyle",{style:i.currentStyleInfo.style,vectorTileLayerMaxBuffers:Object(f.a)("vectortilelayer-max-buffers")},t))})),Promise.all(r)));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateStyle",value:function(){var e=Object(s.a)(n.a.mark((function e(t){var i=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._broadcastPromise;case 2:return this._broadcastPromise=new Promise((function(e,a){Promise.all(i._connection.broadcast("updateStyle",t)).then(e,a)})),e.abrupt("return",this._broadcastPromise);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setStyle",value:function(){var e=Object(s.a)(n.a.mark((function e(t,i){var a,r,s,l,o=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._broadcastPromise;case 2:for(s in this._styleRepository=t,a=this._vectorTileLayer.sourceNameToSource,r=[],a)r.push(this._fetchTileMap(a[s],null));return this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,null),this._spriteSourcePromise.then((function(e){o._spriteMosaic=new E(1024,1024,250),o._spriteMosaic.setSpriteSource(e)})),l=new B(t.glyphs),e.abrupt("return",(this._glyphMosaic=new A(1024,1024,l),this._broadcastPromise=new Promise((function(e,t){Promise.all(o._connection.broadcast("setStyle",{style:i,vectorTileLayerMaxBuffers:Object(f.a)("vectortilelayer-max-buffers")})).then(e,t)})),r.push(this._broadcastPromise),Promise.all(r)));case 8:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"fetchTileData",value:function(e,t){var i=this;return this._getRefKeys(e,t).then((function(e){var a=i._vectorTileLayer.sourceNameToSource,r=[];for(var n in a)r.push(n);return i._getSourcesData(r,e,t)}))}},{key:"parseTileData",value:function(e,t){var i=this,a=e&&e.data;if(!a)return Promise.resolve(null);var r=a.sourceName2DataAndRefKey,n=a.transferList;return 0===Object.keys(r).length?Promise.resolve(null):this._broadcastPromise.then((function(){return i._connection.getAvailableClient().then((function(i){return i.invoke("createTileAndParse",{key:e.key.id,sourceName2DataAndRefKey:r,styleLayerUIDs:e.styleLayerUIDs},Object(I.a)(Object(I.a)({},t),{},{transferList:n})).then((function(e){return{tileData:e}}))}))}))}},{key:"getSprites",value:function(){var e=Object(s.a)(n.a.mark((function e(t){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._spriteSourcePromise;case 2:return e.abrupt("return",this._spriteMosaic.getSpriteItems(t));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getGlyphs",value:function(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)}},{key:"perfReport",value:function(e){!function(e,t,i){if(window.PERFORMANCE_RECORDING_STORAGE){var a=window.PERFORMANCE_RECORDING_STORAGE;a.perf=a.perf||{};var r=a.perf;r[e]=r[e]||{start:null,time:0,min:void 0,max:void 0,samples:[],unit:i},r[e].time+=t,r[e].samples.push(t),(null==r[e].min||t<r[e].min)&&(r[e].min=t),(null==r[e].max||t>r[e].max)&&(r[e].max=t)}}(e.key,e.milliseconds,"ms")}},{key:"_getTilePayload",value:function(){var e=Object(s.a)(n.a.mark((function e(t,i,a){var r,s;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=D.a.pool.acquire(t.id),s=this._vectorTileLayer.sourceNameToSource[i].getSourceTileUrl(r.level,r.row,r.col),D.a.pool.release(r),e.prev=2,e.next=5,this.request(s,a);case 5:return e.t0=e.sent,e.t1=i,e.abrupt("return",{protobuff:e.t0,sourceName:e.t1});case 10:if(e.prev=10,e.t2=e.catch(2),!Object(m.m)(e.t2)){e.next=14;break}throw e.t2;case 14:return e.abrupt("return",{protobuff:null,sourceName:i});case 15:case"end":return e.stop()}}),e,this,[[2,10]])})));return function(t,i,a){return e.apply(this,arguments)}}()},{key:"request",value:function(e,t){return Object(P.default)(e,Object(I.a)({responseType:"array-buffer"},t)).then((function(e){return e.data}))}},{key:"_fetchTileMap",value:function(){var e=Object(s.a)(n.a.mark((function e(t,i){var a,r,s;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.capabilities.operations.supportsTileMap||!t.tileIndex){e.next=2;break}return e.abrupt("return",Promise.resolve());case 2:if(t.tileMapURL){e.next=4;break}return e.abrupt("return");case 4:if(!(a=X.get(t.tileMapURL))){e.next=7;break}return e.abrupt("return",void(t.tileIndex=a));case 7:if(!Z.has(t.tileMapURL)){e.next=20;break}return e.prev=8,e.next=11,Z.get(t.tileMapURL);case 11:r=e.sent,t.tileIndex=new q.a(r.data),e.next=19;break;case 15:if(e.prev=15,e.t0=e.catch(8),!Object(m.m)(e.t0)){e.next=19;break}throw e.t0;case 19:return e.abrupt("return");case 20:return s=Object(P.default)(t.tileMapURL,i),Z.set(t.tileMapURL,s),e.prev=22,e.next=25,s;case 25:r=e.sent,Z.delete(t.tileMapURL),X.put(t.tileMapURL,t.tileIndex),t.tileIndex=new q.a(r.data),e.next=35;break;case 31:if(e.prev=31,e.t1=e.catch(22),Z.delete(t.tileMapURL),!Object(m.m)(e.t1)){e.next=35;break}throw e.t1;case 35:case"end":return e.stop()}}),e,null,[[8,15],[22,31]])})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_getRefKeys",value:function(e,t){var i=this._vectorTileLayer.sourceNameToSource,a=new Array;for(var r in i){var n=i[r].getRefKey(e,t);a.push(n)}return Object(m.j)(a)}},{key:"_getSourcesData",value:function(e,t,i){for(var a=[],r=0;r<t.length;r++)if(null==t[r].value||null==e[r])a.push(null);else{var n=this._getTilePayload(t[r].value,e[r],i);a.push(n)}return Object(m.j)(a).then((function(e){for(var i={},a=[],r=0;r<e.length;r++)if(e[r].value&&e[r].value&&e[r].value.protobuff&&e[r].value.protobuff.byteLength>0){var n=t[r].value.id;i[e[r].value.sourceName]={refKey:n,protobuff:e[r].value.protobuff},a.push(e[r].value.protobuff)}return{sourceName2DataAndRefKey:i,transferList:a}}))}}]),e}(),$=i(436),ee=i(401),te=function(e,t){return e+1/(1<<2*t)},ie=function(){function e(t,i){Object(l.a)(this,e),this._tiles=new Map,this._tileCache=new $.a(40,(function(e){return e.dispose()})),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this._container=i}return Object(o.a)(e,[{key:"destroy",value:function(){var e,t=Object(a.a)(this._tiles);try{for(t.s();!(e=t.n()).done;){var i=Object(Q.a)(e.value,2);i[0];i[1].dispose()}}catch(r){t.e(r)}finally{t.f()}this._tiles=null,this._tileCache.clear(),this._tileCache=null}},{key:"update",value:function(e){this._updateCacheSize(e);var t,i=this.tileInfoView,r=i.getTileCoverage(e.state,0,"smallest"),n=r.spans,s=r.lodInfo,l=s.level,o=new Set,c=new Set,h=Object(a.a)(n);try{for(h.s();!(t=h.n()).done;)for(var u=t.value,y=u.row,d=u.colFrom,f=u.colTo,v=d;v<=f;v++){var p=D.a.getId(l,y,s.normalizeCol(v),s.getWorldForColumn(v)),_=this._getOrAcquireTile(p);o.add(p),_.processed()?this._addToContainer(_):c.add(new D.a(p))}}catch(U){h.e(U)}finally{h.f()}var b,g=Object(a.a)(this._tiles);try{for(g.s();!(b=g.n()).done;){var m=Object(Q.a)(b.value,2),w=m[0];m[1].isCoverage=o.has(w)}}catch(U){g.e(U)}finally{g.f()}var O,j=Object(a.a)(c);try{for(j.s();!(O=j.n()).done;){var k=O.value;this._findPlaceholdersForMissingTiles(k,o)}}catch(U){j.e(U)}finally{j.f()}var S,T=!1,x=Object(a.a)(this._tiles);try{for(x.s();!(S=x.n()).done;){var R=Object(Q.a)(S.value,2),C=R[0],I=R[1];I.neededForCoverage=o.has(C),I.neededForCoverage||I.isHoldingForFade&&i.intersects(r,I.key)&&o.add(C),I.isFading&&(T=!0)}}catch(U){x.e(U)}finally{x.f()}var P,L=Object(a.a)(this._tiles);try{for(L.s();!(P=L.n()).done;){var M=Object(Q.a)(P.value,2),q=M[0];M[1];o.has(q)||this._releaseTile(q)}}catch(U){L.e(U)}finally{L.f()}return ee.a.pool.release(r),!T}},{key:"clear",value:function(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}},{key:"clearCache",value:function(){this._tileCache.clear()}},{key:"_findPlaceholdersForMissingTiles",value:function(e,t){var i,r=[],n=Object(a.a)(this._tiles);try{for(n.s();!(i=n.n()).done;){var s=Object(Q.a)(i.value,2),l=(s[0],s[1]);this._addPlaceholderChild(r,l,e,t)}}catch(c){n.e(c)}finally{n.f()}var o=r.reduce(te,0);Math.abs(1-o)<1e-6||this._addPlaceholderParent(e.id,t)}},{key:"_addPlaceholderChild",value:function(e,t,i,a){t.key.level<=i.level||!t.hasData()||function(e,t){var i=t.level-e.level;return e.row===t.row>>i&&e.col===t.col>>i&&e.world===t.world}(i,t.key)&&(this._addToContainer(t),a.add(t.id),e.push(t.key.level-i.level))}},{key:"_addPlaceholderParent",value:function(e,t){for(var i=e;;){if(!(i=ae(i))||t.has(i))return;var a=this._getTile(i);if(a&&a.hasData())return this._addToContainer(a),void t.add(a.id)}}},{key:"_getOrAcquireTile",value:function(e){var t=this._tiles.get(e);return t||((t=this._tileCache.pop(e))||(t=this.acquireTile(new D.a(e))),this._tiles.set(e,t),t)}},{key:"_getTile",value:function(e){var t=this._tiles.get(e);return t||((t=this._tileCache.pop(e))&&this._tiles.set(e,t),t)}},{key:"_releaseTile",value:function(e){var t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}},{key:"_addToContainer",value:function(e){var t,i=[],r=this._container;if(!r.contains(e)){var n,s=this._visibleTiles,l=Object(a.a)(s);try{for(l.s();!(n=l.n()).done;){var o=Object(Q.a)(n.value,2),c=(o[0],o[1]);this._canConnectDirectly(e,c)&&i.push(c),Object(v.j)(t)&&this._canConnectDirectly(c,e)&&(t=c)}}catch(_){l.e(_)}finally{l.f()}if(Object(v.k)(t)){var h,u=Object(a.a)(i);try{for(u.s();!(h=u.n()).done;){var y=h.value;t.childrenTiles.delete(y),e.childrenTiles.add(y),y.parentTile=e}}catch(_){u.e(_)}finally{u.f()}t.childrenTiles.add(e),e.parentTile=t}else{var d,f=Object(a.a)(i);try{for(f.s();!(d=f.n()).done;){var p=d.value;e.childrenTiles.add(p),p.parentTile=e}}catch(_){f.e(_)}finally{f.f()}}s.set(e.id,e),r.addChild(e)}}},{key:"_removeFromContainer",value:function(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),Object(v.k)(e.parentTile)){e.parentTile.childrenTiles.delete(e);var t,i=Object(a.a)(e.childrenTiles);try{for(i.s();!(t=i.n()).done;){var r=t.value;Object(v.k)(e.parentTile)&&e.parentTile.childrenTiles.add(r)}}catch(l){i.e(l)}finally{i.f()}}var n,s=Object(a.a)(e.childrenTiles);try{for(s.s();!(n=s.n()).done;){n.value.parentTile=e.parentTile}}catch(l){s.e(l)}finally{s.f()}e.parentTile=null,e.childrenTiles.clear()}},{key:"_canConnectDirectly",value:function(e,t){for(var i=e.key,a=t.key,r=a.level,n=a.row,s=a.col,l=a.world,o=this._visibleTiles;r>0;){if(r--,n>>=1,s>>=1,i.level===r&&i.row===n&&i.col===s&&i.world===l)return!0;if(o.has("".concat(r,"/").concat(n,"/").concat(s,"/").concat(l)))return!1}return!1}},{key:"_updateCacheSize",value:function(e){var t=e.state.size;if(t[0]!==this._viewSize[0]||t[1]!==this._viewSize[1]){var i=Math.ceil(t[0]/512)+1,a=Math.ceil(t[1]/512)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*i*a}}}]),e}();function ae(e){var t=e.split("/"),i=Object(Q.a)(t,4),a=i[0],r=i[1],n=i[2],s=i[3],l=parseInt(a,10);return 0===l?null:"".concat(l-1,"/").concat(parseInt(r,10)>>1,"/").concat(parseInt(n,10)>>1,"/").concat(parseInt(s,10))}var re=i(32),ne=i(542),se=i(821),le=i(859),oe=i(70),ce=i(515),he=i(631),ue=i(576),ye=i(276);function de(e,t,i,r,n,s){var l,o=r.iconRotationAlignment,c=r.textRotationAlignment,h=r.iconTranslate,u=r.iconTranslateAnchor,y=r.textTranslate,d=r.textTranslateAnchor,f=0,v=Object(a.a)(e.colliders);try{for(v.s();!(l=v.n()).done;){var p=l.value,_=0===p.partIndex?h:y,b=Object(Q.a)(_,2),g=b[0],m=b[1],w=0===p.partIndex?u:d,O=p.minLod<=s&&s<=p.maxLod;f+=O?0:1,p.enabled=O,p.xScreen=p.xTile*n[0]+p.yTile*n[3]+n[6],p.yScreen=p.xTile*n[1]+p.yTile*n[4]+n[7],0===w?(p.xScreen+=i*g-t*m,p.yScreen+=t*g+i*m):(p.xScreen+=g,p.yScreen+=m),1===(0===p.partIndex?o:c)?(p.dxScreen=p.dxPixels,p.dyScreen=p.dyPixels):(p.dxScreen=i*(p.dxPixels+p.width/2)-t*(p.dyPixels+p.height/2)-p.width/2,p.dyScreen=t*(p.dxPixels+p.width/2)+i*(p.dyPixels+p.height/2)-p.height/2)}}catch(j){v.e(j)}finally{v.f()}e.colliders.length>0&&f===e.colliders.length&&(e.unique.show=!1)}var fe=function(){function e(t,i,r,n,s,o){Object(l.a)(this,e),this._symbols=t,this._styleRepository=n,this._zoom=s,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new ue.a(i,r,ce.a),this._si=Math.sin(Math.PI*o/180),this._co=Math.cos(Math.PI*o/180);var c,h=Object(a.a)(t);try{for(h.s();!(c=h.n()).done;){var u,y=c.value,d=Object(a.a)(y.symbols);try{for(d.s();!(u=d.n()).done;){var f=u.value;this._allNeededMatrices.has(f.tile)||this._allNeededMatrices.set(f.tile,Object(ye.a)(f.tile.transforms.tileUnitsToPixels))}}catch(v){d.e(v)}finally{d.f()}}}catch(v){h.e(v)}finally{h.f()}}return Object(o.a)(e,[{key:"work",value:function(e){var t=this._gridIndex;function i(e){for(var i=e.xScreen+e.dxScreen,r=e.yScreen+e.dyScreen,n=i+e.width,s=r+e.height,l=t.getCellSpan(i,r,n,s),o=Object(Q.a)(l,4),c=o[0],h=o[1],u=o[2],y=o[3],d=h;d<=y;d++)for(var f=c;f<=u;f++){var v,p=t.cells[d][f],_=Object(a.a)(p);try{for(_.s();!(v=_.n()).done;){var b=v.value,g=b.xScreen+b.dxScreen,m=b.yScreen+b.dyScreen,w=g+b.width,O=m+b.height;if(!(n<g||i>w||s<m||r>O))return!0}}catch(j){_.e(j)}finally{_.f()}}return!1}for(var r=performance.now();this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0)for(var n=this._symbols[this._currentLayerCursor],s=this._getProperties(n.styleLayerUID);this._currentSymbolCursor<n.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-r>e)return!1;var l=n.symbols[this._currentSymbolCursor];if(l.unique.show){de(l,this._si,this._co,s,this._allNeededMatrices.get(l.tile),this._zoom);var o=l.unique;if(o.show){var c,h=s.iconAllowOverlap,u=s.iconIgnorePlacement,y=s.textAllowOverlap,d=s.textIgnorePlacement,f=Object(a.a)(l.colliders);try{for(f.s();!(c=f.n()).done;){var v=c.value;if(v.enabled){var p=o.parts[v.partIndex];p.show&&!(v.partIndex?y:h)&&i(v)&&(v.hard?o.show=!1:p.show=!1)}}}catch(L){f.e(L)}finally{f.f()}if(o.show){var _,b=Object(a.a)(l.colliders);try{for(b.s();!(_=b.n()).done;){var g=_.value;if(g.enabled&&(!(g.partIndex?d:u)&&o.parts[g.partIndex].show))for(var m=g.xScreen+g.dxScreen,w=g.yScreen+g.dyScreen,O=m+g.width,j=w+g.height,k=this._gridIndex.getCellSpan(m,w,O,j),S=Object(Q.a)(k,4),T=S[0],x=S[1],R=S[2],C=S[3],I=x;I<=C;I++)for(var P=T;P<=R;P++)this._gridIndex.cells[I][P].push(g)}}catch(L){b.e(L)}finally{b.f()}}}}}return!0}},{key:"_getProperties",value:function(e){var t=this._styleProps.get(e);if(t)return t;var i=this._zoom,a=this._styleRepository.getStyleLayerByUID(e),r=0!==a.getLayoutValue("symbol-placement",i),n=a.getLayoutValue("icon-rotation-alignment",i);2===n&&(n=r?0:1);var s=a.getLayoutValue("text-rotation-alignment",i);2===s&&(s=r?0:1);var l=a.getPaintValue("icon-translate",i),o=a.getPaintValue("icon-translate-anchor",i),c=a.getPaintValue("text-translate",i),h=a.getPaintValue("text-translate-anchor",i),u={iconAllowOverlap:a.getLayoutValue("icon-allow-overlap",i),iconIgnorePlacement:a.getLayoutValue("icon-ignore-placement",i),textAllowOverlap:a.getLayoutValue("text-allow-overlap",i),textIgnorePlacement:a.getLayoutValue("text-ignore-placement",i),iconRotationAlignment:n,textRotationAlignment:s,iconTranslateAnchor:o,iconTranslate:l,textTranslateAnchor:h,textTranslate:c};return this._styleProps.set(e,u),u}}]),e}();function ve(e,t){if(e.priority-t.priority)return e.priority-t.priority;var i=e.tile.key,a=t.tile.key;return i.world-a.world?i.world-a.world:i.level-a.level?i.level-a.level:i.row-a.row?i.row-a.row:i.col-a.col?i.col-a.col:e.xTile-t.xTile?e.xTile-t.xTile:e.yTile-t.yTile}var pe=function(){function e(t,i,a,r,n,s){Object(l.a)(this,e),this._visibleTiles=t,this._symbolRepository=i,this._createCollisionJob=a,this._assignTileSymbolsOpacity=r,this._symbolLayerSorter=n,this._isLayerVisible=s,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}return Object(o.a)(e,[{key:"running",get:function(){return this._running}},{key:"setScreenSize",value:function(e,t){this._screenWidth===e&&this._screenHeight===t||this.restart(),this._screenWidth=e,this._screenHeight=t}},{key:"restart",value:function(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}},{key:"continue",value:function(e){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){var t=performance.now();if(!this._selectionJob.work(e))return!1;if(this._selectionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-t))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){var i=performance.now();if(!this._collisionJob.work(e))return!1;if(this._collisionJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-i))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){var a=performance.now();if(!this._opacityJob.work(e))return!1;if(this._opacityJobCompleted=!0,0===(e=Math.max(0,e-(performance.now()-a))))return!1}return this._running=!1,!0}},{key:"_createSelectionJob",value:function(){var e=this._symbolRepository.uniqueSymbols,t=[],i=0,r=0,n=this._isLayerVisible;var s=this._symbolLayerSorter;return{work:function(s){for(var l,o=performance.now();r<e.length;r++,i=0){var c=e[r],h=c.styleLayerUID;if(n(h)){t[r]=t[r]||{styleLayerUID:h,symbols:[]};for(var u=t[r];i<c.uniqueSymbols.length;i++){if(l=c.uniqueSymbols[i],i%100==99&&performance.now()-o>s)return!1;var y,d=null,f=!1,v=!1,p=Object(a.a)(l.tileSymbols);try{for(p.s();!(y=p.n()).done;){var _=y.value;if(_.selectedForRendering=!1,!v||!f){var b=_.tile;(!d||b.isCoverage||b.neededForCoverage&&!f)&&(d=_,(b.neededForCoverage||b.isCoverage)&&(v=!0),b.isCoverage&&(f=!0))}}}catch(j){p.e(j)}finally{p.f()}if(d.selectedForRendering=!0,v){u.symbols.push(d),l.show=!0;var g,m=Object(a.a)(l.parts);try{for(m.s();!(g=m.n()).done;){g.value.show=!0}}catch(j){m.e(j)}finally{m.f()}}else l.show=!1}}else t[r]||(t[r]={styleLayerUID:h,symbols:[]})}var w,O=Object(a.a)(t);try{for(O.s();!(w=O.n()).done;){w.value.symbols.sort(ve)}}catch(j){O.e(j)}finally{O.f()}return!0},get sortedSymbols(){return t.sort(s)}}}},{key:"_createOpacityJob",value:function(){var e=this._assignTileSymbolsOpacity,t=this._visibleTiles,i=0;function r(t,i){var n,s=t.symbols,l=Object(a.a)(s);try{for(l.s();!(n=l.n()).done;){var o=Object(Q.a)(n.value,2);o[0];_e(o[1],i)}}catch(u){l.e(u)}finally{l.f()}e(t,i);var c,h=Object(a.a)(t.childrenTiles);try{for(h.s();!(c=h.n()).done;){r(c.value,i)}}catch(u){h.e(u)}finally{h.f()}}return{work:function(e){for(var a=performance.now();i<t.length;i++){if(performance.now()-a>e)return!1;var n=t[i];Object(v.k)(n.parentTile)||r(n,performance.now())}return!0}}}}]),e}();function _e(e,t){var i,r=Object(a.a)(e);try{for(r.s();!(i=r.n()).done;){var n,s=i.value.unique,l=Object(a.a)(s.parts);try{for(l.s();!(n=l.n()).done;){var o=n.value,c=o.targetOpacity>.5?1:-1;o.startOpacity+=c*((t-o.startTime)/ce.d),o.startOpacity=Math.min(Math.max(o.startOpacity,0),1),o.startTime=t,o.targetOpacity=s.show&&o.show?1:0}}catch(h){l.e(h)}finally{l.f()}}}catch(h){r.e(h)}finally{r.f()}}var be=function(){function e(t,i,a){Object(l.a)(this,e),this.tileCoordRange=t,this._visibleTiles=i,this._createUnique=a,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}return Object(o.a)(e,[{key:"uniqueSymbols",get:function(){return Object(v.j)(this._uniqueSymbolLayerArray)&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}},{key:"add",value:function(e,t){this._uniqueSymbolLayerArray=null;var i=this._tiles.get(e.id);i||(i={symbols:new Map},this._tiles.set(e.id,i));var r=new Map;if(t){var n,s=Object(a.a)(t);try{for(s.s();!(n=s.n()).done;){var l=n.value;i.symbols.has(l)&&(r.set(l,i.symbols.get(l)),i.symbols.delete(l))}}catch(S){s.e(S)}finally{s.f()}}else{var o,c=Object(a.a)(e.layerData);try{for(c.s();!(o=c.n()).done;){var h=Object(Q.a)(o.value,2),u=h[0];h[1];i.symbols.has(u)&&(r.set(u,i.symbols.get(u)),i.symbols.delete(u))}}catch(S){c.e(S)}finally{c.f()}}this._removeSymbols(r);var y,d=e.symbols,f=new Map,v=Object(a.a)(d);try{for(v.s();!(y=v.n()).done;){var p=Object(Q.a)(y.value,2),_=p[0],b=p[1],g=b.length;if(g>=32){var m=this.tileCoordRange;do{m/=2,g/=4}while(g>8&&m>64);var w=new ue.a(this.tileCoordRange,this.tileCoordRange,m);f.set(_,{flat:b,index:w}),i.symbols.set(_,{flat:b,index:w});var O,j=Object(a.a)(b);try{for(j.s();!(O=j.n()).done;){var k=O.value;w.getCell(k.xTile,k.yTile).push(k)}}catch(S){j.e(S)}finally{j.f()}}else f.set(_,{flat:b}),i.symbols.set(_,{flat:b})}}catch(S){v.e(S)}finally{v.f()}this._addSymbols(e.key,d)}},{key:"deleteStyleLayers",value:function(e){this._uniqueSymbolLayerArray=null;var t,i=Object(a.a)(this._tiles);try{for(i.s();!(t=i.n()).done;){var r,n=Object(Q.a)(t.value,2),s=n[0],l=n[1],o=new Map,c=Object(a.a)(e);try{for(c.s();!(r=c.n()).done;){var h=r.value;l.symbols.has(h)&&(o.set(h,l.symbols.get(h)),l.symbols.delete(h))}}catch(u){c.e(u)}finally{c.f()}this._removeSymbols(o),0===l.symbols.size&&this._tiles.delete(s)}}catch(u){i.e(u)}finally{i.f()}}},{key:"removeTile",value:function(e){this._uniqueSymbolLayerArray=null;var t=this._tiles.get(e.id);if(t){var i,r=new Map,n=Object(a.a)(e.symbols);try{for(n.s();!(i=n.n()).done;){var s=Object(Q.a)(i.value,2),l=s[0];s[1];t.symbols.has(l)&&(r.set(l,t.symbols.get(l)),t.symbols.delete(l))}}catch(o){n.e(o)}finally{n.f()}this._removeSymbols(r),0===t.symbols.size&&this._tiles.delete(e.id)}}},{key:"_removeSymbols",value:function(e){var t,i=Object(a.a)(e);try{for(i.s();!(t=i.n()).done;){var r,n=Object(Q.a)(t.value,2),s=n[0],l=n[1].flat,o=Object(a.a)(l);try{for(o.s();!(r=o.n()).done;){for(var c=r.value,h=c.unique,u=h.tileSymbols,y=u.length-1,d=0;d<y;d++)if(u[d]===c){u[d]=u[y];break}if(u.length=y,0===y){var f=this._uniqueSymbolsReferences.get(s);f.delete(h),0===f.size&&this._uniqueSymbolsReferences.delete(s)}c.unique=null}}catch(v){o.e(v)}finally{o.f()}}}catch(v){i.e(v)}finally{i.f()}}},{key:"_addSymbols",value:function(e,t){if(0!==t.size){var i,r=this._visibleTiles,n=Object(a.a)(r);try{for(n.s();!(i=n.n()).done;){var s=i.value;s.parentTile||s.key.world!==e.world||s.key.level===e.level&&!s.key.equals(e)||this._matchSymbols(s,e,t)}}catch(b){n.e(b)}finally{n.f()}var l,o=Object(a.a)(t);try{for(o.s();!(l=o.n()).done;){var c,h=Object(Q.a)(l.value,2),u=h[0],y=h[1],d=Object(a.a)(y);try{for(d.s();!(c=d.n()).done;){var f=c.value;if(Object(v.j)(f.unique)){var p=this._createUnique();f.unique=p,p.tileSymbols.push(f);var _=this._uniqueSymbolsReferences.get(u);_||(_=new Set,this._uniqueSymbolsReferences.set(u,_)),_.add(p)}}}catch(b){d.e(b)}finally{d.f()}}}catch(b){o.e(b)}finally{o.f()}}}},{key:"_matchSymbols",value:function(e,t,i){if(e.key.level>t.level){var r=e.key.level-t.level;if(e.key.row>>r!==t.row||e.key.col>>r!==t.col)return}if(t.level>e.key.level){var n=t.level-e.key.level;if(t.row>>n!==e.key.row||t.col>>n!==e.key.col)return}if(t.equals(e.key)){var s,l=Object(a.a)(e.childrenTiles);try{for(l.s();!(s=l.n()).done;){var o=s.value;this._matchSymbols(o,t,i)}}catch(N){l.e(N)}finally{l.f()}}else{var c,h=new Map,u=Object(a.a)(i);try{for(u.s();!(c=u.n()).done;){var y,d=Object(Q.a)(c.value,2),f=d[0],p=d[1],_=[],b=Object(a.a)(p);try{for(b.s();!(y=b.n()).done;){var g=y.value,m=Object(ue.c)(this.tileCoordRange,g.xTile,t.level,t.col,e.key.level,e.key.col),w=Object(ue.c)(this.tileCoordRange,g.yTile,t.level,t.row,e.key.level,e.key.row);m>=0&&m<this.tileCoordRange&&w>=0&&w<this.tileCoordRange&&_.push({symbol:g,xTransformed:m,yTransformed:w})}}catch(N){b.e(N)}finally{b.f()}var O=[],j=e.key.level<t.level?1:1<<e.key.level-t.level,k=this._tiles.get(e.id).symbols.get(f);if(k){var S,T=k.flat,x=Object(a.a)(_);try{for(x.s();!(S=x.n()).done;){var R,C=S.value,I=!1,P=C.xTransformed,L=C.yTransformed;R=Object(v.k)(k.index)?k.index.getCell(P,L):T;var M,D=C.symbol,q=D.hash,U=Object(a.a)(R);try{for(U.s();!(M=U.n()).done;){var z=M.value;if(q===z.hash&&Math.abs(P-z.xTile)<=j&&Math.abs(L-z.yTile)<=j){var H=z.unique;D.unique=H,H.tileSymbols.push(D),I=!0;break}}}catch(N){U.e(N)}finally{U.f()}I||O.push(D)}}catch(N){x.e(N)}finally{x.f()}}O.length>0&&h.set(f,O)}}catch(N){u.e(N)}finally{u.f()}var A,V=Object(a.a)(e.childrenTiles);try{for(V.s();!(A=V.n()).done;){var F=A.value;this._matchSymbols(F,t,h)}}catch(N){V.e(N)}finally{V.f()}}}},{key:"_createUniqueSymbolLayerArray",value:function(){var e,t,i=this._uniqueSymbolsReferences,r=new Array(i.size),n=0,s=Object(a.a)(i);try{for(s.s();!(t=s.n()).done;){var l=Object(Q.a)(t.value,2),o=l[0],c=l[1],h=new Array(c.size);e=0;var u,y=Object(a.a)(c);try{for(y.s();!(u=y.n()).done;){var d=u.value;h[e++]=d}}catch(f){y.e(f)}finally{y.f()}r[n]={styleLayerUID:o,uniqueSymbols:h},n++}}catch(f){s.e(f)}finally{s.f()}return r}}]),e}(),ge=function(e){Object(u.a)(i,e);var t=Object(y.a)(i);function i(e,a){var r;return Object(l.a)(this,i),(r=t.call(this)).styleRepository=e,r._tileToHandle=new Map,r._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},r._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},r._completed=!1,r._symbolRepository=new be(4096,a,(function(){return new he.b})),r._symbolDeclutterer=new pe(a,r._symbolRepository,(function(e,t,i){return new fe(e,t,i,r.styleRepository,r._zoom,r._viewState.rotation)}),(function(e,t){e.allSymbolsFadingOut=!0,e.lastOpacityUpdate=t,Object(ue.d)(e,t,!0),e.decluttered=!0,e.requestRender()}),(function(e,t){return r.styleRepository.getStyleLayerByUID(e.styleLayerUID).z-r.styleRepository.getStyleLayerByUID(t.styleLayerUID).z}),(function(e){var t=r.styleRepository.getStyleLayerByUID(e).getLayoutProperty("visibility");return!t||1!==t.getValue()})),r}return Object(o.a)(i,[{key:"addTile",value:function(e){var t=this;e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",(function(){t._symbolRepository.add(e),t.restartDeclutter()}))),this._symbolRepository.add(e),this.restartDeclutter()}},{key:"removeTile",value:function(e){var t=this._tileToHandle.get(e);t&&(this._symbolRepository.removeTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}},{key:"update",value:function(e,t){return this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]},this._continueDeclutter(),this._completed}},{key:"restartDeclutter",value:function(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}},{key:"clear",value:function(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach((function(e){return e.remove()})),this._tileToHandle.clear()}},{key:"stale",get:function(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}},{key:"deleteStyleLayers",value:function(e){this._symbolRepository.deleteStyleLayers(e)}},{key:"_continueDeclutter",value:function(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(ce.b),this._completed&&this._scheduleNotifyStable())}},{key:"_scheduleNotifyStable",value:function(){var e=this;Object(v.k)(this._stableNotificationHandle)&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout((function(){e._stableNotificationHandle=null,e.emit("fade-complete")}),1.5*ce.d)}},{key:"_notifyUnstable",value:function(){Object(v.k)(this._stableNotificationHandle)&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this.emit("fade-start")}}]),i}(oe.a),me=1e-6;function we(e,t){if(e){var i=e.getLayoutProperty("visibility");if(!i||1!==i.getValue()&&(void 0===e.minzoom||e.minzoom<t+me)&&(void 0===e.maxzoom||e.maxzoom>=t-me))return!0}return!1}var Oe=function(e){Object(u.a)(i,e);var t=Object(y.a)(i);function i(e){var a;return Object(l.a)(this,i),(a=t.call(this,e))._backgroundTiles=[],a._pointToCallbacks=new Map,a._fading=!1,a}return Object(o.a)(i,[{key:"destroy",value:function(){this.removeAllChildren(),this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null),Object(v.k)(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}},{key:"setStyleResources",value:function(e,t,i){var a=this;if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=i,Object(v.j)(this._symbolFader)){var r=new ge(this._styleRepository,this.children);r.on("fade-start",(function(){a.emit("fade-start"),a._fading=!0,a.requestRender()})),r.on("fade-complete",(function(){a.emit("fade-complete"),a._fading=!1,a.requestRender()})),this._symbolFader=r}Object(v.q)(this._symbolFader).styleRepository=i}},{key:"deleteStyleLayers",value:function(e){Object(v.k)(this._symbolFader)&&this._symbolFader.deleteStyleLayers(e)}},{key:"hitTest",value:function(){var e=Object(s.a)(n.a.mark((function e(t,i){var a,r;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=[t,i],r=Object(m.g)(),e.abrupt("return",(this._pointToCallbacks.set(a,r),this.requestRender(),r.promise));case 2:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"enterTileInvalidation",value:function(){var e,t=Object(a.a)(this.children);try{for(t.s();!(e=t.n()).done;){e.value.invalidating=!0}}catch(i){t.e(i)}finally{t.f()}}},{key:"createRenderParams",value:function(e){return Object(I.a)(Object(I.a)({},Object(c.a)(Object(h.a)(i.prototype),"createRenderParams",this).call(this,e)),{},{renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos})}},{key:"doRender",value:function(e){!this.visible||e.drawPhase!==se.c.MAP&&e.drawPhase!==se.c.DEBUG||void 0===this._spriteMosaic||Object(c.a)(Object(h.a)(i.prototype),"doRender",this).call(this,e)}},{key:"addChild",value:function(e){return Object(c.a)(Object(h.a)(i.prototype),"addChild",this).call(this,e),Object(v.k)(this._symbolFader)?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}},{key:"removeChild",value:function(e){return Object(v.k)(this._symbolFader)&&this._symbolFader.removeTile(e),this.requestRender(),Object(c.a)(Object(h.a)(i.prototype),"removeChild",this).call(this,e)}},{key:"renderChildren",value:function(e){if(e.drawPhase!==se.c.DEBUG){if(this._doRender(e),this._pointToCallbacks.size>0){var t=e.context,a=t.getBoundFramebufferObject();e.drawPhase=se.c.HITTEST;var r=e.painter.effects.hittest;r.bind(e),this._doRender(e),r.draw(e,this._pointToCallbacks),t.bindFramebuffer(a)}}else Object(c.a)(Object(h.a)(i.prototype),"renderChildren",this).call(this,e)}},{key:"removeAllChildren",value:function(){for(var e=0;e<this.children.length;e++){var t=this.children[e];Object(v.k)(this._symbolFader)&&this._symbolFader.removeTile(t),t.dispose()}Object(c.a)(Object(h.a)(i.prototype),"removeAllChildren",this).call(this)}},{key:"getStencilTarget",value:function(){return this.children.filter((function(e){return e.neededForCoverage&&e.hasData()}))}},{key:"restartDeclutter",value:function(){Object(v.k)(this._symbolFader)&&this._symbolFader.restartDeclutter()}},{key:"_doRender",value:function(e){var t=this,r=e.context,n=this._styleRepository;if(n){var s=n.layers,l=!0;e.drawPhase===se.c.HITTEST&&(l=!1),n.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,n.backgroundBucketIds)),Object(c.a)(Object(h.a)(i.prototype),"renderChildren",this).call(this,e),e.drawPhase===se.c.MAP&&this._fade(e.displayLevel,e.state);var o=this.children.filter((function(e){return e.visible&&e.hasData()}));if(o&&0!==o.length){var u,y=Object(a.a)(o);try{for(y.s();!(u=y.n()).done;){u.value.triangleCount=0}}catch(k){y.e(k)}finally{y.f()}r.setStencilWriteMask(0),r.setColorMask(!0,!0,!0,!0),r.setStencilOp(7680,7680,7681),r.setStencilTestEnabled(!0),r.setBlendingEnabled(!1),r.setDepthTestEnabled(!0),r.setDepthWriteEnabled(!0),r.setDepthFunction(515),r.setClearDepth(1),r.clear(r.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(var d=s.length-1;d>=0;d--)this._renderStyleLayer(s[d],e,o);r.setDepthWriteEnabled(!1),r.setBlendingEnabled(l),r.setBlendFunctionSeparate(1,771,1,771),e.renderPass="translucent";for(var f=0;f<s.length;f++)this._renderStyleLayer(s[f],e,o);r.setDepthTestEnabled(!1),e.renderPass="symbol";for(var p=0;p<s.length;p++)this._renderStyleLayer(s[p],e,o);if(r.bindVAO(),r.setStencilTestEnabled(!0),r.setBlendingEnabled(!0),e.drawPhase===se.c.MAP){var _=window.COLLISION_DEBUG_CTX;if(_&&Object(v.k)(this._symbolFader)&&(_.clearRect(0,0,_.canvas.width,_.canvas.height),!this._fading||window.COLLISION_XRAY)){var b,g=Object(a.a)(this.children);try{for(g.s();!(b=g.n()).done;){var m,w,O,j=b.value;if(j.symbols)!function(){var e=[];if(j.symbols.forEach((function(t){e.push.apply(e,Object(re.a)(t))})),window.COLLISION_SHOW_GRID){var i=null==(m=t._symbolFader)||null==(w=m._symbolDeclutterer)||null==(O=w._collisionJob)?void 0:O._gridIndex;i&&G(_,i)}K(_,e)}()}}catch(k){g.e(k)}finally{g.f()}}}}}}},{key:"_fade",value:function(e,t){Object(v.k)(this._symbolFader)&&(this._symbolFader.update(e,t)||this.requestRender())}},{key:"_renderStyleLayer",value:function(e,t,i){var r=t.painter,n=t.renderPass;if(void 0!==e){var s=e.getLayoutProperty("visibility");if(!s||1!==s.getValue()){var l;switch(e.type){case 0:return;case 1:if("opaque"!==n&&"translucent"!==t.renderPass)return;l="vtlFill";break;case 2:if("translucent"!==n)return;l="vtlLine";break;case 4:if("symbol"!==n)return;l="vtlCircle";break;case 3:if("symbol"!==n)return;l="vtlSymbol"}if(i=3===e.type?i.filter((function(e){return e.decluttered})):i.filter((function(e){return e.neededForCoverage})),"vtlSymbol"!==l){var o=t.displayLevel;if(0===i.length||void 0!==e.minzoom&&e.minzoom>=o+me||void 0!==e.maxzoom&&e.maxzoom<o-me)return}var c=e.uid;t.styleLayerUID=c,t.styleLayer=e;var h,u=Object(a.a)(i);try{for(u.s();!(h=u.n()).done;){if(h.value.layerData.has(c)){r.renderObjects(t,i,l);break}}}catch(y){u.e(y)}finally{u.f()}}}}},{key:"_renderBackgroundLayers",value:function(e,t){var i,r=e.context,n=e.displayLevel,s=e.painter,l=e.state,o=this._styleRepository,c=!1,h=Object(a.a)(t);try{for(h.s();!(i=h.n()).done;){var u=i.value;if(we(o.getLayerById(u),n)){c=!0;break}}}catch(H){h.e(H)}finally{h.f()}if(c){var y=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),d=y.spans,f=y.lodInfo,p=f.level,_=Object(k.i)(),b=[];if(this._renderPasses){var g=this._renderPasses[0];Object(v.k)(this._clippingInfos)&&(g.brushes[0].prepareState(e,this._clippingInfos[0]),g.brushes[0].drawMany(e,this._clippingInfos))}var m,w,O=this._backgroundTiles,j=0,S=Object(a.a)(d);try{for(S.s();!(w=S.n()).done;)for(var T=w.value,x=T.row,R=T.colFrom,C=T.colTo,I=R;I<=C;I++){if(j<O.length)(m=O[j]).key.set(p,x,f.normalizeCol(I),f.getWorldForColumn(I)),this._tileInfoView.getTileBounds(_,m.key,!1),m.bounds=_,m.coords[0]=_[0],m.coords[1]=_[3];else{var P=new D.a(p,x,f.normalizeCol(I),f.getWorldForColumn(I));m=new ne.a(P,this._tileInfoView.getTileBounds(Object(k.i)(),P),[512,512],[4096,4096]),O.push(m)}m.setTransform(l,this._tileInfoView.getTileResolution(m.key)),b.push(m),j++}}catch(H){S.e(H)}finally{S.f()}r.setStencilWriteMask(0),r.setColorMask(!0,!0,!0,!0),r.setStencilOp(7680,7680,7681),r.setStencilFunction(514,0,255);var L=!0;e.drawPhase===se.c.HITTEST&&(L=!1),r.setStencilTestEnabled(L);var M,q=Object(a.a)(t);try{for(q.s();!(M=q.n()).done;){var U=M.value,z=o.getLayerById(U);we(z,n)&&(e.styleLayerUID=z.uid,e.styleLayer=z,s.renderObjects(e,b,"vtlBackground"))}}catch(H){q.e(H)}finally{q.f()}ee.a.pool.release(y)}}}]),i}(le.a),je=i(131),ke=function(e){Object(u.a)(i,e);var t=Object(y.a)(i);function i(){var e;return Object(l.a)(this,i),(e=t.apply(this,arguments))._fullCacheLodInfos=null,e._levelByScale={},e}return Object(o.a)(i,[{key:"getTileParentId",value:function(e){var t=D.a.pool.acquire(e),i=0===t.level?null:D.a.getId(t.level-1,t.row>>1,t.col>>1,t.world);return D.a.pool.release(t),i}},{key:"getTileCoverage",value:function(e,t,a){var r=Object(c.a)(Object(h.a)(i.prototype),"getTileCoverage",this).call(this,e,t,a);if(!r)return r;var n=1<<r.lodInfo.level;return r.spans=r.spans.filter((function(e){return e.row>=0&&e.row<n})),r}},{key:"scaleToLevel",value:function(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];var t,i,a=this._fullCacheLodInfos;if(e>a[0].scale)return a[0].level;for(var r=0;r<a.length-1;r++)if(e>(i=a[r+1]).scale)return(t=a[r]).level+(t.scale-e)/(t.scale-i.scale);return a[a.length-1].level}},{key:"_initializeFullCacheLODs",value:function(e){var t;if(0===e[0].level)t=e.map((function(e){return{level:e.level,resolution:e.resolution,scale:e.scale}}));else{var i=this.tileInfo.size[0],a=this.tileInfo.spatialReference;t=je.a.create({size:i,spatialReference:a}).lods.map((function(e){return{level:e.level,resolution:e.resolution,scale:e.scale}}))}for(var r=0;r<t.length;r++)this._levelByScale[t[r].scale]=t[r].level;this._fullCacheLodInfos=t}}]),i}(i(539).a),Se=p.a.getLogger("esri.views.2d.layers.VectorTileLayerView2D"),Te=function(e){Object(u.a)(i,e);var t=Object(y.a)(i);function i(){var e;return Object(l.a)(this,i),(e=t.apply(this,arguments))._styleChanges=[],e._handles=new O.a,e._fetchQueue=null,e._parseQueue=null,e._isTileHandlerReady=!1,e.fading=!1,e}return Object(o.a)(i,[{key:"initialize",value:function(){var e=this,t=this.layer.tileInfo;if((t&&t.spatialReference).equals(this.view.spatialReference)){var i=this.layer.currentStyleInfo,a=i.style,r=i.spriteUrl,n=i.glyphsUrl;this._styleRepository=new S.a(a,{spriteUrl:r,glyphsUrl:n}),this._tileInfoView=new ke(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new Oe(this._tileInfoView),this._tileHandler=new Y(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this.handles.add([this._vectorTileContainer.on("fade-start",(function(){e.fading=!0,e.notifyChange("updating"),e.requestUpdate()})),this._vectorTileContainer.on("fade-complete",(function(){e.fading=!1,e.notifyChange("updating"),e.requestUpdate()}))])}else this.addResolvingPromise(Promise.reject(new g.a("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer})))}},{key:"destroy",value:function(){var e;this._stop(),this.container.removeAllChildren(),this._vectorTileContainer&&(this._vectorTileContainer.destroy(),this._vectorTileContainer=null),null==(e=this._tileHandler)||e.destroy(),this._tileHandler=null}},{key:"hitTest",value:function(){var e=Object(s.a)(n.a.mark((function e(t,i){var a,r,s,l,o,c;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.suspended&&this._tileHandlerPromise){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,this._tileHandlerPromise;case 4:return e.next=6,this._vectorTileContainer.hitTest(t,i);case 6:if((a=e.sent)&&0!==a.length){e.next=9;break}return e.abrupt("return",null);case 9:if(r=a[0]-1,s=this._styleRepository,l=s.getStyleLayerByUID(r)){e.next=12;break}return e.abrupt("return",null);case 12:return o=s.getStyleLayerIndex(l.id),c=new w.a({attributes:{layerId:o,layerName:l.id,layerUID:r}}),e.abrupt("return",(c.layer=this.layer,c.sourceLayer=this.layer,c));case 14:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"update",value:function(e){if(this._tileHandlerPromise&&this._isTileHandlerReady)return e.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=e.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=e.state,this._parseQueue.state=e.state,this._tileManager.update(e)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}},{key:"attach",value:function(){var e=this;this._start(),this._handles.add([this.layer.on("paint-change",(function(t){if(t.isDataDriven)e._styleChanges.push({type:0,data:t}),e.notifyChange("updating"),e.requestUpdate();else{var i=e._styleRepository,a=i.getLayerById(t.layerName);if(!a)return;var r=3===a.type;i.setPaintProperties(t.layerName,t.paint),r&&e._vectorTileContainer.restartDeclutter(),e._vectorTileContainer.requestRender()}})),this.layer.on("layout-change",(function(t){var i=e._styleRepository,a=i.getLayerById(t.layer);if(a){var r=Object(j.a)(a.layout,t.layout);if(!Object(v.j)(r)){if(Object(j.b)(r,"visibility")&&1===function(e){if(Object(v.j)(e))return 0;switch(e.type){case"partial":return Object.keys(e.diff).length;case"complete":return Math.max(Object.keys(e.oldValue).length,Object.keys(e.newValue).length);case"collection":return Object.keys(e.added).length+Object.keys(e.changed).length+Object.keys(e.removed).length}}(r))return i.setLayoutProperties(t.layer,t.layout),3===a.type&&e._vectorTileContainer.restartDeclutter(),void e._vectorTileContainer.requestRender();e._styleChanges.push({type:1,data:t}),e.notifyChange("updating"),e.requestUpdate()}}})),this.layer.on("style-layer-visibility-change",(function(t){var i=e._styleRepository,a=i.getLayerById(t.layer);a&&(i.setStyleLayerVisibility(t.layer,t.visibility),3===a.type&&e._vectorTileContainer.restartDeclutter(),e._vectorTileContainer.requestRender())})),this.layer.on("style-layer-change",(function(t){e._styleChanges.push({type:2,data:t}),e.notifyChange("updating"),e.requestUpdate()})),this.layer.on("delete-style-layer",(function(t){e._styleChanges.push({type:3,data:t}),e.notifyChange("updating"),e.requestUpdate()})),this.layer.on("load-style",(function(){return e._loadStyle()}))])}},{key:"detach",value:function(){this._stop(),this._handles.removeAll()}},{key:"moveStart",value:function(){this.requestUpdate()}},{key:"viewChange",value:function(){this.requestUpdate()}},{key:"moveEnd",value:function(){this.requestUpdate()}},{key:"canResume",value:function(){var e=Object(c.a)(Object(h.a)(i.prototype),"canResume",this).call(this),t=this.layer;if(e&&t.currentStyleInfo){var a=this.view.scale,r=t.currentStyleInfo;if(r&&r.layerDefinition){var n=r.layerDefinition;n.minScale&&n.minScale<a&&(e=!1),n.maxScale&&n.maxScale>a&&(e=!1)}}return e}},{key:"isUpdating",value:function(){var e=this._vectorTileContainer.children;return!this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||e.length>0&&e.filter((function(e){return e.invalidating})).length>0||this.fading}},{key:"acquireTile",value:function(e){var t=this,i=this._createVectorTile(e);return this._tileHandlerPromise.then((function(){t._fetchQueue.push(i.key).then((function(e){return t._parseQueue.push({key:i.key,data:e})})).then((function(e){i.once("attach",(function(){return t.requestUpdate()})),e&&(i.setData(e.tileData),t.requestUpdate(),t.notifyChange("updating"))})).catch((function(e){t.notifyChange("updating"),Object(m.m)(e)||Se.error(e)}))})),i}},{key:"releaseTile",value:function(e){var t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}},{key:"_start",value:function(){var e=this;if(this._stop(),this._tileManager=new ie({acquireTile:function(t){return e.acquireTile(t)},releaseTile:function(t){return e.releaseTile(t)},tileInfoView:this._tileInfoView},this._vectorTileContainer),this.layer.currentStyleInfo){var t=new AbortController,i=this._tileHandler.start({signal:t.signal}).then((function(){e._fetchQueue=new T.a({tileInfoView:e._tileInfoView,process:function(t,i){return e._getTileData(t,i)},concurrency:15}),e._parseQueue=new T.a({tileInfoView:e._tileInfoView,process:function(t,i){return e._parseTileData(t,i)},concurrency:8}),e.requestUpdate(),e._isTileHandlerReady=!0}));this._tileHandler.spriteMosaic.then((function(t){e._vectorTileContainer.setStyleResources(t,e._tileHandler.glyphMosaic,e._styleRepository),e.requestUpdate()})),this._tileHandlerAbortController=t,this._tileHandlerPromise=i}}},{key:"_stop",value:function(){if(this._tileHandlerAbortController&&this._vectorTileContainer){var e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue&&(this._fetchQueue.destroy(),this._fetchQueue=null),this._parseQueue&&(this._parseQueue.destroy(),this._parseQueue=null),this._tileManager&&(this._tileManager.destroy(),this._tileManager=null),this._vectorTileContainer.removeAllChildren()}}},{key:"_getTileData",value:function(){var e=Object(s.a)(n.a.mark((function e(t,i){var a;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._tileHandler.fetchTileData(t,i);case 2:return a=e.sent,e.abrupt("return",(this.notifyChange("updating"),a));case 4:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_parseTileData",value:function(){var e=Object(s.a)(n.a.mark((function e(t,i){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._tileHandler.parseTileData(t,i));case 1:case"end":return e.stop()}}),e,this)})));return function(t,i){return e.apply(this,arguments)}}()},{key:"_applyStyleChanges",value:function(){var e=Object(s.a)(n.a.mark((function e(){var t,i,r,s,l,o,c,h,u,y,d,f,v=this;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache(),t=this._styleChanges,e.prev=2,e.next=5,this._tileHandler.updateStyle(t);case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(2),Se.error("error applying vector-tiles style update",e.t0.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0;case 10:if(i=this._styleRepository,r=[],t.forEach((function(e){if(3===e.type){var t=e.data,a=i.getLayerById(t.layerName);a&&r.push(a.uid)}})),s=[],t.forEach((function(e){var t=e.type,a=e.data;switch(t){case 0:i.setPaintProperties(a.layerName,a.paint),l=a.layerName;break;case 1:i.setLayoutProperties(a.layerName,a.layout),l=a.layerName;break;case 3:return void i.deleteStyleLayer(a.layerName);case 2:i.setStyleLayer(a.layer,a.index),l=a.layer.id}var r=i.getLayerById(l);r&&s.push(r.uid)})),o=this._vectorTileContainer.children,r.length>0){this._vectorTileContainer.deleteStyleLayers(r),c=Object(a.a)(o);try{for(c.s();!(h=c.n()).done;)h.value.deleteLayerData(r)}catch(n){c.e(n)}finally{c.f()}}if(this._fetchQueue.resume(),this._parseQueue.resume(),!(s.length>0)){e.next=22;break}u=[],y=Object(a.a)(o);try{for(f=function(){var e=d.value,t=v._fetchQueue.push(e.key).then((function(t){return v._parseQueue.push({key:e.key,data:t,styleLayerUIDs:s})})).then((function(t){return e.setData(t.tileData)}));u.push(t)},y.s();!(d=y.n()).done;)f()}catch(n){y.e(n)}finally{y.f()}return e.next=22,Promise.all(u);case 22:this._styleChanges=[],this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate();case 23:case"end":return e.stop()}}),e,this,[[2,7]])})));return function(){return e.apply(this,arguments)}}()},{key:"_loadStyle",value:function(){var e=Object(s.a)(n.a.mark((function e(){var t,i,a,r,s,l;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.layer.currentStyleInfo,i=t.style,a=t.spriteUrl,r=t.glyphsUrl,this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this.notifyChange("updating"),this._styleRepository=new S.a(i,{spriteUrl:a,glyphsUrl:r}),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=Object(m.d)(),s=this._tileHandlerAbortController.signal,e.prev=3,this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,i),e.next=7,this._tileHandlerPromise;case 7:e.next=13;break;case 9:if(e.prev=9,e.t0=e.catch(3),Object(m.m)(e.t0)){e.next=13;break}throw e.t0;case 13:if(!s.aborted){e.next=15;break}return e.abrupt("return",(this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),void this.requestUpdate()));case 15:return e.next=17,this._tileHandler.spriteMosaic;case 17:l=e.sent,this._vectorTileContainer.setStyleResources(l,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate();case 19:case"end":return e.stop()}}),e,this,[[3,9]])})));return function(){return e.apply(this,arguments)}}()},{key:"_createVectorTile",value:function(e){var t=this._tileInfoView.getTileBounds(Object(k.i)(),e);return new x.a(e,this._styleRepository,t,[512,512])}}]),i}(Object(C.a)(R.a));Object(d.a)([Object(_.b)()],Te.prototype,"_fetchQueue",void 0),Object(d.a)([Object(_.b)()],Te.prototype,"_parseQueue",void 0),Object(d.a)([Object(_.b)()],Te.prototype,"_isTileHandlerReady",void 0),Object(d.a)([Object(_.b)()],Te.prototype,"suspended",void 0),Object(d.a)([Object(_.b)()],Te.prototype,"fading",void 0),Object(d.a)([Object(_.b)()],Te.prototype,"updating",void 0);var xe=Te=Object(d.a)([Object(b.a)("esri.views.2d.layers.VectorTileLayerView2D")],Te);t.default=xe},845:function(e,t,i){"use strict";var a=i(2),r=i(3),n=i(4),s=i(5),l=i(0),o=(i(14),i(12)),c=(i(17),i(1)),h=i(8),u=(i(11),i(18),i(19),i(31)),y=i(70),d=i(179),f=i(181),v=i(99),p=function(e){Object(n.a)(i,e);var t=Object(s.a)(i);function i(e){var r;return Object(a.a)(this,i),(r=t.call(this,e)).layer=null,r.parent=null,r}return Object(r.a)(i,[{key:"initialize",value:function(){var e=this;this.when().catch((function(t){if("layerview:create-error"!==t.name){var i=e.layer&&e.layer.id||"no id",a=e.layer&&e.layer.title||"no title";throw o.a.getLogger(e.declaredClass).error("#resolve()","Failed to resolve layer view (layer title: '".concat(a,"', id: '").concat(i,"')"),t),t}}))}},{key:"fullOpacity",get:function(){var e=function(e){return null==e?1:e};return e(this.get("layer.opacity"))*e(this.get("parent.fullOpacity"))}},{key:"suspended",get:function(){return!this.canResume()}},{key:"suspendInfo",get:function(){return this.getSuspendInfo()}},{key:"legendEnabled",get:function(){return!this.suspended&&!0===this.layer.legendEnabled}},{key:"updating",get:function(){return!!(this.updatingHandles&&this.updatingHandles.updating||this.isUpdating())}},{key:"visible",get:function(){return!0===this.get("layer.visible")},set:function(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")}},{key:"canResume",value:function(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.get("layer.loaded")&&this.visible||!1}},{key:"getSuspendInfo",value:function(){var e=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(e.viewNotReady=!0),this.layer&&this.layer.loaded||(e.layerNotLoaded=!0),this.visible||(e.layerInvisible=!0),e}},{key:"isUpdating",value:function(){return!1}}]),i}(Object(v.b)(Object(d.a)(Object(f.b)(y.a.EventedMixin(u.a)))));Object(l.a)([Object(c.b)()],p.prototype,"fullOpacity",null),Object(l.a)([Object(c.b)()],p.prototype,"layer",void 0),Object(l.a)([Object(c.b)()],p.prototype,"parent",void 0),Object(l.a)([Object(c.b)({readOnly:!0})],p.prototype,"suspended",null),Object(l.a)([Object(c.b)({readOnly:!0})],p.prototype,"suspendInfo",null),Object(l.a)([Object(c.b)({readOnly:!0})],p.prototype,"legendEnabled",null),Object(l.a)([Object(c.b)({type:Boolean,readOnly:!0})],p.prototype,"updating",null),Object(l.a)([Object(c.b)()],p.prototype,"visible",null);var _=p=Object(l.a)([Object(h.a)("esri.views.layers.LayerView")],p);t.a=_},846:function(e,t,i){"use strict";i.d(t,"a",(function(){return L}));var a,r=i(2),n=i(3),s=i(30),l=i(28),o=i(4),c=i(5),h=i(0),u=(i(14),i(12),i(17),i(1)),y=i(8),d=(i(11),i(18),i(19),i(40)),f=i(171),v=i(25),p=function(e){Object(o.a)(i,e);var t=Object(c.a)(i);function i(){return Object(r.a)(this,i),t.apply(this,arguments)}return i}(i(22).a),_=p=Object(h.a)([Object(y.a)("esri.views.layers.support.ClipArea")],p),b=a=function(e){Object(o.a)(i,e);var t=Object(c.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments)).type="rect",e.left=null,e.right=null,e.top=null,e.bottom=null,e}return Object(n.a)(i,[{key:"clone",value:function(){return new a({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}},{key:"version",get:function(){return(this._get("version")||0)+1}}]),i}(_);Object(h.a)([Object(u.b)({type:[Number,String],json:{write:!0}})],b.prototype,"left",void 0),Object(h.a)([Object(u.b)({type:[Number,String],json:{write:!0}})],b.prototype,"right",void 0),Object(h.a)([Object(u.b)({type:[Number,String],json:{write:!0}})],b.prototype,"top",void 0),Object(h.a)([Object(u.b)({type:[Number,String],json:{write:!0}})],b.prototype,"bottom",void 0),Object(h.a)([Object(u.b)({readOnly:!0})],b.prototype,"version",null);var g,m=b=a=Object(h.a)([Object(y.a)("esri.views.layers.support.ClipRect")],b),w=i(881),O=i(136),j=i(57),k=i(95),S=i(67),T=(i(78),{base:O.a,key:"type",typeMap:{extent:j.a,polygon:k.a}}),x=g=function(e){Object(o.a)(i,e);var t=Object(c.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments)).type="geometry",e.geometry=null,e}return Object(n.a)(i,[{key:"version",get:function(){return(this._get("version")||0)+1}},{key:"clone",value:function(){return new g({geometry:this.geometry.clone()})}}]),i}(_);Object(h.a)([Object(u.b)({types:T,json:{read:S.a,write:!0}})],x.prototype,"geometry",void 0),Object(h.a)([Object(u.b)({readOnly:!0})],x.prototype,"version",null);var R=x=g=Object(h.a)([Object(y.a)("esri.views.layers.support.Geometry")],x),C=function(e){Object(o.a)(i,e);var t=Object(c.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments)).type="path",e.path=[],e}return Object(n.a)(i,[{key:"version",get:function(){return(this._get("version")||0)+1}}]),i}(_);Object(h.a)([Object(u.b)({type:[[[Number]]],json:{write:!0}})],C.prototype,"path",void 0),Object(h.a)([Object(u.b)({readOnly:!0})],C.prototype,"version",null);var I=C=Object(h.a)([Object(y.a)("esri.views.layers.support.Path")],C),P=d.a.ofType({key:"type",base:_,typeMap:{rect:m,path:I,geometry:R}}),L=function(e){var t=function(e){Object(o.a)(i,e);var t=Object(c.a)(i);function i(){var e;return Object(r.a)(this,i),(e=t.apply(this,arguments)).clips=new P,e.moving=!1,e.attached=!1,e.lastUpdateId=-1,e.updateRequested=!1,e}return Object(n.a)(i,[{key:"initialize",value:function(){var e,t=this;this.container||(this.container=new w.a),this.container.fadeTransitionEnabled=!0,this.container.opacity=0,this.container.clips=this.clips,this.handles.add([Object(v.a)(this,"suspended",(function(e){t.container&&(t.container.visible=!e),t.view&&!e&&t.updateRequested&&t.view.requestUpdate()}),!0),Object(v.a)(this,["layer.opacity","container"],(function(){var e,i;t.container&&(t.container.opacity=null!=(e=null==(i=t.layer)?void 0:i.opacity)?e:1)}),!0),Object(v.a)(this,["layer.blendMode"],(function(e){t.container&&(t.container.blendMode=e)}),!0),Object(v.a)(this,["layer.effect"],(function(e){t.container&&(t.container.effect=e)}),!0),this.clips.on("change",(function(){t.container.clips=t.clips,t.notifyChange("clips")}))]),null!=(e=this.view)&&e.whenLayerView?this.view.whenLayerView(this.layer).then((function(e){e!==t||t.attached||t.destroyed||(t.attach(),t.requestUpdate(),t.attached=!0)}),(function(){})):this.when().then((function(){t.attached||t.destroyed||(t.attach(),t.requestUpdate(),t.attached=!0)}),(function(){}))}},{key:"destroy",value:function(){this.attached&&(this.detach(),this.attached=!1),this.handles.remove("initialize"),this.updateRequested=!1}},{key:"updating",get:function(){return!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())}},{key:"isVisibleAtScale",value:function(e){var t=!0,i=this.layer,a=i.minScale,r=i.maxScale;if(null!=a&&null!=r){var n=!a,s=!r;!n&&e<=a&&(n=!0),!s&&e>=r&&(s=!0),t=n&&s}return t}},{key:"requestUpdate",value:function(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.suspended||this.view.requestUpdate())}},{key:"processUpdate",value:function(e){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",e),this.updateRequested&&!this.suspended&&(this.updateRequested=!1,this.update(e))):this.updateRequested=!1}},{key:"isUpdating",value:function(){return!1}},{key:"isRendering",value:function(){return!1}},{key:"canResume",value:function(){return!!Object(s.a)(Object(l.a)(i.prototype),"canResume",this).call(this)&&this.isVisibleAtScale(this.view.scale)}}]),i}(e);return Object(h.a)([Object(u.b)({type:P,set:function(e){var t=Object(f.b)(e,this._get("clips"),P);this._set("clips",t)}})],t.prototype,"clips",void 0),Object(h.a)([Object(u.b)()],t.prototype,"moving",void 0),Object(h.a)([Object(u.b)()],t.prototype,"attached",void 0),Object(h.a)([Object(u.b)()],t.prototype,"container",void 0),Object(h.a)([Object(u.b)()],t.prototype,"suspended",void 0),Object(h.a)([Object(u.b)({readOnly:!0})],t.prototype,"updateParameters",void 0),Object(h.a)([Object(u.b)()],t.prototype,"updateRequested",void 0),Object(h.a)([Object(u.b)()],t.prototype,"updating",null),Object(h.a)([Object(u.b)()],t.prototype,"view",void 0),t=Object(h.a)([Object(y.a)("esri.views.2d.layers.LayerView2D")],t)}},859:function(e,t,i){"use strict";var a=i(15),r=i(32),n=i(10),s=i(2),l=i(3),o=i(30),c=i(28),h=i(4),u=i(5),y=i(821),d=i(897),f=i(895),v=i(879),p=function(e,t){return e.key.level-t.key.level!=0?e.key.level-t.key.level:e.key.row-t.key.row!=0?e.key.row-t.key.row:e.key.col-t.key.col},_=function(e){Object(h.a)(i,e);var t=Object(u.a)(i);function i(e){var a;return Object(s.a)(this,i),(a=t.call(this))._tileInfoView=e,a}return Object(l.a)(i,[{key:"requiresDedicatedFBO",get:function(){return!1}},{key:"renderChildren",value:function(e){this.sortChildren(p),this.setStencilReference(),Object(o.a)(Object(c.a)(i.prototype),"renderChildren",this).call(this,e)}},{key:"createRenderParams",value:function(e){var t=e.state;return Object(n.a)(Object(n.a)({},Object(o.a)(Object(c.a)(i.prototype),"createRenderParams",this).call(this,e)),{},{requiredLevel:this._tileInfoView.getClosestInfoForScale(t.scale).level,displayLevel:this._tileInfoView.tileInfo.scaleToZoom(t.scale)})}},{key:"prepareRenderPasses",value:function(e){var t=this,a=e.registerRenderPass({name:"stencil",brushes:[f.a],drawPhase:y.c.DEBUG|y.c.MAP|y.c.HIGHLIGHT,target:function(){return t.getStencilTarget()}}),n=e.registerRenderPass({name:"tileInfo",brushes:[d.a],drawPhase:y.c.DEBUG,target:function(){return t.children},has:"esri-tiles-debug"});return[].concat(Object(r.a)(Object(o.a)(Object(c.a)(i.prototype),"prepareRenderPasses",this).call(this,e)),[a,n])}},{key:"getStencilTarget",value:function(){return this.children}},{key:"updateTransforms",value:function(e){var t,i=Object(a.a)(this.children);try{for(i.s();!(t=i.n()).done;){var r=t.value,n=this._tileInfoView.getTileResolution(r.key);r.setTransform(e,n)}}catch(s){i.e(s)}finally{i.f()}}},{key:"setStencilReference",value:function(){var e,t=1,i=Object(a.a)(this.children);try{for(i.s();!(e=i.n()).done;){e.value.stencilRef=t++}}catch(r){i.e(r)}finally{i.f()}}}]),i}(v.a);t.a=_},912:function(e,t,i){"use strict";var a=i(2),r=i(3),n=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;Object(a.a)(this,e),this.x=t,this.y=i,this.width=r,this.height=n}return Object(r.a)(e,[{key:"isEmpty",get:function(){return this.width<=0||this.height<=0}},{key:"union",value:function(e){this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.width=Math.max(this.width,e.width),this.height=Math.max(this.height,e.height)}}]),e}();t.a=n}}]);
//# sourceMappingURL=73.edc55440.chunk.js.map