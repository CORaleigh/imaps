(this.webpackJsonpimaps=this.webpackJsonpimaps||[]).push([[14],{536:function(e,t,r){"use strict";function n(e,t,r){var n,i,s,d,l,c=t&&t.length,h=c?t[0]*r:e.length,f=a(e,0,h,r,!0),p=new Array;if(!f||f.next===f.prev)return p;if(c&&(f=u(e,t,f,r)),e.length>80*r){n=s=e[0],i=d=e[1];for(var g=r;g<h;g+=r){var v=e[g],m=e[g+1];n=Math.min(n,v),i=Math.min(i,m),s=Math.max(s,v),d=Math.max(d,m)}l=0!==(l=Math.max(s-n,d-i))?1/l:0}return o(f,p,r,n,i,l),p}function a(e,t,r,n,a){var i;if(a===b(e,t,r,n)>0)for(var o=t;o<r;o+=n)i=l(o,e[o],e[o+1],i);else for(var s=r-n;s>=t;s-=n)i=l(s,e[s],e[s+1],i);return i&&x(i,i.next)&&(c(i),i=i.next),i}function i(e,t=e){if(!e)return e;var r,n=e;do{if(r=!1,n.steiner||!x(n,n.next)&&0!==v(n.prev,n,n.next))n=n.next;else{if(c(n),(n=t=n.prev)===n.next)break;r=!0}}while(r||n!==t);return t}function o(e,t,r,n,a,l,h=0){if(e){!h&&l&&(e=p(e,n,a,l));for(var u=e;e.prev!==e.next;){var f=e.prev,g=e.next;if(l?d(e,n,a,l):s(e))t.push(f.index/r),t.push(e.index/r),t.push(g.index/r),c(e),e=g.next,u=g.next;else if((e=g)===u){h?1===h?o(e=j(e,t,r),t,r,n,a,l,2):2===h&&R(e,t,r,n,a,l):o(i(e),t,r,n,a,l,1);break}}}}function s(e){var t=e.prev,r=e,n=e.next;if(v(t,r,n)>=0)return!1;for(var a=e.next.next,i=a,o=0;a!==e.prev&&(0===o||a!==i);){if(o++,_(t.x,t.y,r.x,r.y,n.x,n.y,a.x,a.y)&&v(a.prev,a,a.next)>=0)return!1;a=a.next}return!0}function d(e,t,r,n){var a=e.prev,i=e,o=e.next;if(v(a,i,o)>=0)return!1;for(var s=a.x<i.x?a.x<o.x?a.x:o.x:i.x<o.x?i.x:o.x,d=a.y<i.y?a.y<o.y?a.y:o.y:i.y<o.y?i.y:o.y,l=a.x>i.x?a.x>o.x?a.x:o.x:i.x>o.x?i.x:o.x,c=a.y>i.y?a.y>o.y?a.y:o.y:i.y>o.y?i.y:o.y,h=O(s,d,t,r,n),u=O(l,c,t,r,n),f=e.prevZ,p=e.nextZ;f&&f.z>=h&&p&&p.z<=u;){if(f!==e.prev&&f!==e.next&&_(a.x,a.y,i.x,i.y,o.x,o.y,f.x,f.y)&&v(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,p!==e.prev&&p!==e.next&&_(a.x,a.y,i.x,i.y,o.x,o.y,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.nextZ}for(;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&_(a.x,a.y,i.x,i.y,o.x,o.y,f.x,f.y)&&v(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;p&&p.z<=u;){if(p!==e.prev&&p!==e.next&&_(a.x,a.y,i.x,i.y,o.x,o.y,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.nextZ}return!0}function l(e,t,r,n){var a=new T(e,t,r);return n?(a.next=n.next,a.prev=n,n.next.prev=a,n.next=a):(a.prev=a,a.next=a),a}function c(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function h(e){var t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function u(e,t,r,n){for(var o=new Array,s=0,d=t.length;s<d;s++){var l=a(e,t[s]*n,s<d-1?t[s+1]*n:e.length,n,!1);l===l.next&&(l.steiner=!0),o.push(h(l))}for(var c of(o.sort(w),o))f(c,r),r=i(r,r.next);return r}function f(e,t){if(t=function(e,t){var r,n=t,a=e.x,i=e.y,o=-1/0;do{if(i<=n.y&&i>=n.next.y&&n.next.y!==n.y){var s=n.x+(i-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=a&&s>o){if(o=s,s===a){if(i===n.y)return n;if(i===n.next.y)return n.next}r=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!r)return null;if(a===o)return r.prev;var d,l=r,c=r.x,h=r.y,u=1/0;for(n=r.next;n!==l;)a>=n.x&&n.x>=c&&a!==n.x&&_(i<h?a:o,i,c,h,i<h?o:a,i,n.x,n.y)&&(((d=Math.abs(i-n.y)/(a-n.x))<u||d===u&&n.x>r.x)&&y(n,e)&&(r=n,u=d)),n=n.next;return r}(e,t)){var r=S(t,e);i(r,r.next)}}function p(e,t,r,n){for(var a;a!==e;a=a.next){if(null===(a=a||e).z&&(a.z=O(a.x,a.y,t,r,n)),a.prev.next!==a||a.next.prev!==a)return a.prev.next=a,a.next.prev=a,p(e,t,r,n);a.prevZ=a.prev,a.nextZ=a.next}return e.prevZ.nextZ=null,e.prevZ=null,function(e){for(var t,r=1;;){var n=void 0,a=e;e=null,t=null;for(var i=0;a;){i++,n=a;for(var o=0;o<r&&n;o++)n=n.nextZ;for(var s=r;o>0||s>0&&n;){var d=void 0;0===o?(d=n,n=n.nextZ,s--):0!==s&&n?a.z<=n.z?(d=a,a=a.nextZ,o--):(d=n,n=n.nextZ,s--):(d=a,a=a.nextZ,o--),t?t.nextZ=d:e=d,d.prevZ=t,t=d}a=n}if(t.nextZ=null,r*=2,i<2)return e}}(e)}function g(e,t,r,n){var a=t&&t.length,i=a?t[0]*r:e.length,o=Math.abs(b(e,0,i,r));if(a)for(var s=0,d=t.length;s<d;s++){var l=t[s]*r,c=s<d-1?t[s+1]*r:e.length;o-=Math.abs(b(e,l,c,r))}for(var h=0,u=0;u<n.length;u+=3){var f=n[u]*r,p=n[u+1]*r,g=n[u+2]*r;h+=Math.abs((e[f]-e[g])*(e[p+1]-e[f+1])-(e[f]-e[p])*(e[g+1]-e[f+1]))}return 0===o&&0===h?0:Math.abs((h-o)/o)}function v(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function m(e,t,r,n){return!!(x(e,t)&&x(r,n)||x(e,n)&&x(r,t))||v(e,t,r)>0!=v(e,t,n)>0&&v(r,n,e)>0!=v(r,n,t)>0}function b(e,t,r,n){for(var a=0,i=t,o=r-n;i<r;i+=n)a+=(e[o]-e[i])*(e[i+1]+e[o+1]),o=i;return a}function _(e,t,r,n,a,i,o,s){return(a-o)*(t-s)-(e-o)*(i-s)>=0&&(e-o)*(n-s)-(r-o)*(t-s)>=0&&(r-o)*(i-s)-(a-o)*(n-s)>=0}function y(e,t){return v(e.prev,e,e.next)<0?v(e,t,e.next)>=0&&v(e,e.prev,t)>=0:v(e,t,e.prev)<0||v(e,e.next,t)<0}function O(e,t,r,n,a){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*a)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*a)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function x(e,t){return e.x===t.x&&e.y===t.y}function w(e,t){return e.x-t.x}function j(e,t,r){var n=e;do{var a=n.prev,i=n.next.next;!x(a,i)&&m(a,n,n.next,i)&&y(a,i)&&y(i,a)&&(t.push(a.index/r),t.push(n.index/r),t.push(i.index/r),c(n),c(n.next),n=e=i),n=n.next}while(n!==e);return n}function R(e,t,r,n,a,s){var d=e;do{for(var l=d.next.next;l!==d.prev;){if(d.index!==l.index&&C(d,l)){var c=S(d,l);return d=i(d,d.next),c=i(c,c.next),o(d,t,r,n,a,s),void o(c,t,r,n,a,s)}l=l.next}d=d.next}while(d!==e)}function C(e,t){return e.next.index!==t.index&&e.prev.index!==t.index&&!function(e,t){var r=e;do{if(r.index!==e.index&&r.next.index!==e.index&&r.index!==t.index&&r.next.index!==t.index&&m(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&y(e,t)&&y(t,e)&&function(e,t){var r=e,n=!1,a=(e.x+t.x)/2,i=(e.y+t.y)/2;do{r.y>i!=r.next.y>i&&r.next.y!==r.y&&a<(r.next.x-r.x)*(i-r.y)/(r.next.y-r.y)+r.x&&(n=!n),r=r.next}while(r!==e);return n}(e,t)}function S(e,t){var r=new T(e.index,e.x,e.y),n=new T(t.index,t.x,t.y),a=e.next,i=t.prev;return e.next=t,t.prev=e,r.next=a,a.prev=r,n.next=r,r.prev=n,i.next=n,n.prev=i,n}r.d(t,"a",(function(){return g})),r.d(t,"b",(function(){return n}));class T{constructor(e,t,r){this.index=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}}},622:function(e,t,r){"use strict";r.d(t,"a",(function(){return d}));var n,a,i=r(120),o=r(119),s=r(417);function d(e){e.fragment.include(s.a),e.fragment.uniforms.add("uShadowMapTex","sampler2D"),e.fragment.uniforms.add("uShadowMapNum","int"),e.fragment.uniforms.add("uShadowMapDistance","vec4"),e.fragment.uniforms.add("uShadowMapMatrix","mat4",4),e.fragment.uniforms.add("uDepthHalfPixelSz","float"),e.fragment.code.add(Object(o.a)(n||(n=Object(i.a)(["\n    int chooseCascade(float _linearDepth, out mat4 mat) {\n      vec4 distance = uShadowMapDistance;\n      float depth = _linearDepth;\n\n      //choose correct cascade\n      int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;\n\n      mat = i == 0 ? uShadowMapMatrix[0] : i == 1 ? uShadowMapMatrix[1] : i == 2 ? uShadowMapMatrix[2] : uShadowMapMatrix[3];\n\n      return i;\n    }\n\n    vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {\n      vec4 lv = mat * vec4(_vpos, 1.0);\n      lv.xy /= lv.w;\n      return 0.5 * lv.xyz + vec3(0.5);\n    }\n\n    vec2 cascadeCoordinates(int i, vec3 lvpos) {\n      return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;\n    }\n\n    float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {\n      return rgba2float(texture2D(_depthTex, uv));\n    }\n\n    float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {\n      return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;\n    }\n\n    float filterShadow(vec2 uv, vec3 lvpos, float halfPixelSize, sampler2D _depthTex) {\n      float texSize = 0.5 / halfPixelSize;\n\n      // filter, offset by half pixels\n      vec2 st = fract((vec2(halfPixelSize) + uv) * texSize);\n\n      float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);\n      float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);\n      float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);\n      float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);\n\n      return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);\n    }\n\n    float readShadowMap(const in vec3 _vpos, float _linearDepth) {\n      mat4 mat;\n      int i = chooseCascade(_linearDepth, mat);\n\n      if (i >= uShadowMapNum) { return 0.0; }\n\n      vec3 lvpos = lightSpacePosition(_vpos, mat);\n\n      // vertex completely outside? -> no shadow\n      if (lvpos.z >= 1.0) { return 0.0; }\n      if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }\n\n      // calc coord in cascade texture\n      vec2 uv = cascadeCoordinates(i, lvpos);\n\n      return filterShadow(uv, lvpos, uDepthHalfPixelSz, uShadowMapTex);\n    }\n  "]))))}(a=d||(d={})).bindUniforms=function(e,t,r){t.shadowMappingEnabled&&(t.shadowMap.bind(e,r),t.shadowMap.bindView(e,t.origin))},a.bindViewCustomOrigin=function(e,t,r){t.shadowMappingEnabled&&t.shadowMap.bindView(e,r)},a.bindView=function(e,t){t.shadowMappingEnabled&&t.shadowMap.bindView(e,t.origin)}},699:function(e,t,r){"use strict";r.d(t,"a",(function(){return d}));var n,a,i,o=r(120),s=r(119);function d(e,t){0===t.output&&t.receiveShadows?(e.varyings.add("linearDepth","float"),e.vertex.code.add(Object(s.a)(n||(n=Object(o.a)(["\n      void forwardLinearDepth() { linearDepth = gl_Position.w; }\n    "]))))):1===t.output||3===t.output?(e.varyings.add("linearDepth","float"),e.vertex.uniforms.add("cameraNearFar","vec2"),e.vertex.code.add(Object(s.a)(a||(a=Object(o.a)(["\n      void forwardLinearDepth() {\n        linearDepth = (-position_view().z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);\n      }\n    "]))))):e.vertex.code.add(Object(s.a)(i||(i=Object(o.a)(["\n      void forwardLinearDepth() {}\n    "]))))}},710:function(e,t,r){"use strict";r.d(t,"a",(function(){return O}));var n,a,i,o,s,d,l,c,h,u,f,p,g,v,m=r(120),b=r(119),_=r(551);function y(e){var t=e.fragment.code;t.add(Object(b.a)(n||(n=Object(m.a)(["\n    vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)\n    {\n      return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;\n    }\n    "])))),t.add(Object(b.a)(a||(a=Object(m.a)(["\n    float integratedRadiance(float cosTheta2, float roughness)\n    {\n      return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);\n    }\n    "])))),t.add(Object(b.a)(i||(i=Object(m.a)(["\n    vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)\n    {\n      float cosTheta2 = 1.0 - RdotNG * RdotNG;\n      float intRadTheta = integratedRadiance(cosTheta2, roughness);\n\n      // Calculate the integrated directional radiance of the ground and the sky\n      float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;\n      float sky = 2.0 - ground;\n      return (ground * ambientGround + sky * ambientSky) * 0.5;\n    }\n    "]))))}function O(e,t){var r=e.fragment.code;e.include(_.a),3===t.pbrMode||4===t.pbrMode?(r.add(Object(b.a)(o||(o=Object(m.a)(["\n    struct PBRShadingWater\n    {\n        float NdotL;   // cos angle between normal and light direction\n        float NdotV;   // cos angle between normal and view direction\n        float NdotH;   // cos angle between normal and half vector\n        float VdotH;   // cos angle between view direction and half vector\n        float LdotH;   // cos angle between light direction and half vector\n        float VdotN;   // cos angle between view direction and normal vector\n    };\n\n    float dtrExponent = ",";\n    "])),t.useCustomDTRExponentForWater?"2.2":"2.0")),r.add(Object(b.a)(s||(s=Object(m.a)(["\n    vec3 fresnelReflection(float angle, vec3 f0, float f90) {\n      return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);\n    }\n    "])))),r.add(Object(b.a)(d||(d=Object(m.a)(["\n    float normalDistributionWater(float NdotH, float roughness)\n    {\n      float r2 = roughness * roughness;\n      float NdotH2 = NdotH * NdotH;\n      float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;\n      return r2 / denom;\n    }\n    "])))),r.add(Object(b.a)(l||(l=Object(m.a)(["\n    float geometricOcclusionKelemen(float LoH)\n    {\n        return 0.25 / (LoH * LoH);\n    }\n    "])))),r.add(Object(b.a)(c||(c=Object(m.a)(["\n    vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)\n    {\n      vec3  F = fresnelReflection(props.VdotH, F0, F0Max);\n      float dSun = normalDistributionWater(props.NdotH, roughness);\n      float V = geometricOcclusionKelemen(props.LdotH);\n\n      float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);\n      float strengthSunHaze  = 1.2;\n      float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;\n\n      return ((dSun + dSunHaze) * V) * F;\n    }\n\n    vec3 tonemapACES(const vec3 x) {\n      return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);\n    }\n    "]))))):1!==t.pbrMode&&2!==t.pbrMode||(e.include(y),r.add(Object(b.a)(h||(h=Object(m.a)(["\n    struct PBRShadingInfo\n    {\n        float NdotL;                  // cos angle between normal and light direction\n        float NdotV;                  // cos angle between normal and view direction\n        float NdotH;                  // cos angle between normal and half vector\n        float VdotH;                  // cos angle between view direction and half vector\n        float LdotH;                  // cos angle between view light direction and half vector\n        float NdotNG;                 // cos angle between normal and normal of the ground\n        float RdotNG;                 // cos angle between view direction reflected of the normal and normal of the ground\n        float NdotAmbDir;             // cos angle between view direction and the fill light in ambient illumination\n        float NdotH_Horizon;          // cos angle between normal and half vector defined with horizon illumination\n        vec3 skyRadianceToSurface;         // integrated radiance of the sky based on the surface roughness (used for specular reflection)\n        vec3 groundRadianceToSurface;      // integrated radiance of the ground based on the surface roughness (used for specular reflection)\n        vec3 skyIrradianceToSurface;       // irradiance of the sky (used for diffuse reflection)\n        vec3 groundIrradianceToSurface;    // irradiance of the ground (used for diffuse reflection)\n\n        float averageAmbientRadiance;      // average ambient radiance used to deduce black level in gamut mapping\n        float ssao;                   // ssao coefficient\n        vec3 albedoLinear;            // linear color of the albedo\n        vec3 f0;                      // fresnel value at normal incident light\n        vec3 f90;                     // fresnel value at 90o of incident light\n\n        vec3 diffuseColor;            // diffuse color of the material used in environment illumination\n        float metalness;              // metalness of the material\n        float roughness;              // roughness of the material\n    };\n    "])))),r.add(Object(b.a)(u||(u=Object(m.a)(["\n    float normalDistribution(float NdotH, float roughness)\n    {\n        float a = NdotH * roughness;\n        float b = roughness / (1.0 - NdotH * NdotH + a * a);\n        return b * b * INV_PI;\n    }\n    "])))),r.add(Object(b.a)(f||(f=Object(m.a)(["\n    const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);\n    const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);\n    const vec2 c2 = vec2(-1.04, 1.04);\n\n    vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {\n        vec4 r = roughness * c0 + c1;\n        float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;\n        return c2 * a004 + r.zw;\n    }\n    "])))),r.add(Object(b.a)(p||(p=Object(m.a)(["\n    vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {\n      vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);\n      vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);\n\n      // From diffuse illumination calculate reflected color\n      vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;\n\n      // From specular illumination calculate reflected color\n      vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);\n      vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;\n      vec3 specularComponent = specularColor * indirectSpecular;\n\n      return (diffuseComponent + specularComponent);\n    }\n    "])))),r.add(Object(b.a)(g||(g=Object(m.a)(["\n    float gamutMapChanel(float x, vec2 p){\n      return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );\n    }"])))),r.add(Object(b.a)(v||(v=Object(m.a)(["\n    vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){\n      vec3 outColor;\n      vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));\n      outColor.x = gamutMapChanel(inColor.x, p) ;\n      outColor.y = gamutMapChanel(inColor.y, p) ;\n      outColor.z = gamutMapChanel(inColor.z, p) ;\n      return outColor;\n    }\n    "])))))}},786:function(e,t,r){"use strict";r.d(t,"a",(function(){return i})),r.d(t,"b",(function(){return o})),r.d(t,"c",(function(){return s}));r(80);var n=r(89),a=(r(208),r(263),r(205));r(192);class i{constructor(){this.cache=new Map}dispose(){this.cache.forEach((e=>{Object(n.k)(e.texture)&&(e.texture.dispose(),e.texture=null)})),this.cache.clear()}acquire(e){if(Object(n.j)(e))return null;var t=this.patternId(e),r=this.cache.get(t);if(r)return r.refCount++,r.bind;var i=this.patternToTextureData(e,2),o=i.length/2,s={refCount:1,texture:null,bind:(e,t)=>(Object(n.j)(s.texture)&&(s.texture=new a.a(e,{width:i.length,height:1,internalFormat:6406,pixelFormat:6406,dataType:5121,wrapMode:33071},i)),e.bindTexture(s.texture,t),o)};return this.cache.set(t,s),s.bind}release(e){if(!Object(n.j)(e)){var t=this.patternId(e),r=this.cache.get(t);r&&(r.refCount--,0===r.refCount&&(Object(n.k)(r.texture)&&r.texture.dispose(),this.cache.delete(t)))}}swap(e,t){var r=this.acquire(t);return this.release(e),r}patternId(e){return e.join(",")}patternToTextureData(e,t){var r=e.reduce(((e,t)=>e+t))*t,n=new Uint8Array(r),a=!0,i=0;for(var o of e){for(var s=0;s<o*t;s++)n[i++]=a?255:0;a=!a}return n}}function o(e){return Object(n.j)(e)?e:e.slice()}function s(e){return[e,e]}},787:function(e,t,r){"use strict";r.d(t,"a",(function(){return s}));var n,a=r(120),i=r(119),o=r(842);function s(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(o.b),e.fragment.code.add(Object(i.a)(n||(n=Object(a.a)(["\n      const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);\n\n      vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {\n        return 2.0 * texture2D(_tex, _uv).rg - 1.0;\n      }\n\n      float sampleNoiseTexture(vec2 _uv) {\n        return texture2D(texWavePerturbation, _uv).b;\n      }\n\n      vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {\n        return 2.0 * texture2D(_tex, _uv).rgb - 1.0;\n      }\n\n      float computeProgress(vec2 uv, float time) {\n        return fract(time);\n      }\n\n      float computeWeight(vec2 uv, float time) {\n        float progress = computeProgress(uv, time);\n        return 1.0 - abs(1.0 - 2.0 * progress);\n      }\n\n      vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {\n        float flowStrength = waveParams[2];\n        float flowOffset = waveParams[3];\n\n        vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;\n\n        float progress = computeProgress(uv, time + phaseOffset);\n        float weight = computeWeight(uv, time + phaseOffset);\n\n        vec2 result = uv;\n        result -= flowVector * (progress + flowOffset);\n        result += phaseOffset;\n        result += (time - progress) * FLOW_JUMP;\n\n        return vec3(result, weight);\n      }\n\n      const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;\n      const float TIME_NOISE_STRENGTH = 7.77;\n\n      vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {\n        float waveStrength = waveParams[0];\n\n        // overall directional shift in uv's for directional wave movement for\n        // now we do a hard coded scale for wave speed such that a unit length\n        // direction is not too fast.\n        vec2 waveMovement = time * -_waveDir;\n\n        float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;\n\n        // compute two perturbed uvs and blend weights\n        // then sample the wave normals at the two positions and blend\n        vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);\n        vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);\n\n        vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;\n        vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;\n\n        // logic to flatten the wave pattern\n        // scale xy components of the normal, then adjust z (up) component\n        vec3 mixNormal = normalize(normal_A + normal_B);\n        mixNormal.xy *= waveStrength;\n        mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));\n\n        return mixNormal;\n      }\n\n      vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {\n        float waveTextureRepeat = waveParams[1];\n        vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);\n        float foam  = normals2FoamIntensity(normal, waveParams[0]);\n        return vec4(normal, foam);\n      }\n    "]))))}(s||(s={})).bindUniforms=function(e,t){e.setUniform1i("texWaveNormal",0),e.setUniform1i("texWavePerturbation",1),e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}},838:function(e,t,r){"use strict";r.d(t,"a",(function(){return a}));var n=r(110);function a(e,t,r){var a,l=e.byteLength/(4*t),c=new Uint32Array(e,0,l*t),h=new Uint32Array(l),u=null!=(a=null==r?void 0:r.minReduction)?a:0,f=(null==r?void 0:r.originalIndices)||null,p=f?f.length:0,g=(null==r?void 0:r.componentOffsets)||null,v=0;if(g)for(var m=0;m<g.length-1;m++){var b=g[m+1]-g[m];b>v&&(v=b)}else v=l;var _=Math.floor(1.1*v)+1;(null==d||d.length<2*_)&&(d=new Uint32Array(Object(n.o)(2*_)));for(var y=0;y<2*_;y++)d[y]=0;for(var O=0,x=!!g&&!!f,w=x?p:l,j=x?new Uint32Array(p):null,R=1.96,C=0!==u?Math.ceil(4*R*R/(u*u)*u*(1-u)):w,S=1,T=g?g[1]:w,E=0;E<w;E++){if(E===C){var M=1-O/E;if(M+R*Math.sqrt(M*(1-M)/E)<u)return null;C*=2}if(E===T){for(var D=0;D<2*_;D++)d[D]=0;if(f)for(var I=g[S-1];I<g[S];I++)j[I]=h[f[I]];T=g[++S]}for(var P=x?f[E]:E,A=P*t,H=s(c,A,t),L=H%_,N=O;0!==d[2*L+1];){if(d[2*L]===H){var z=d[2*L+1]-1;if(i(c,A,z*t,t)){N=h[z];break}}++L>=_&&(L-=_)}N===O&&(d[2*L]=H,d[2*L+1]=P+1,O++),h[P]=N}if(0!==u&&1-O/l<u)return null;if(x){for(var F=g[S-1];F<j.length;F++)j[F]=h[f[F]];h=j}var U=new Uint32Array(t*O);O=0;for(var G=0;G<w;G++)h[G]===O&&(o(c,(x?f[G]:G)*t,U,O*t,t),O++);if(f&&!x){for(var V=new Uint32Array(p),W=0;W<V.length;W++)V[W]=h[f[W]];h=V}return{buffer:U.buffer,indices:h,uniqueCount:O}}function i(e,t,r,n){for(var a=0;a<n;a++)if(e[t+a]!==e[r+a])return!1;return!0}function o(e,t,r,n,a){for(var i=0;i<a;i++)r[n+i]=e[t+i]}function s(e,t,r){for(var n=0,a=0;a<r;a++)n=(n=e[t+a]+n|0)+(n<<11)+(n>>>2)|0;return n>>>0}var d=null},842:function(e,t,r){"use strict";r.d(t,"a",(function(){return d})),r.d(t,"b",(function(){return s}));var n,a,i=r(120),o=r(119);function s(e){e.fragment.code.add(Object(o.a)(n||(n=Object(i.a)(["\n    float normals2FoamIntensity(vec3 n, float waveStrength){\n      float normalizationFactor =  max(0.015, waveStrength);\n      return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);\n    }\n  "]))))}function d(e){e.fragment.code.add(Object(o.a)(a||(a=Object(i.a)(["\n    vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){\n      return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;\n    }\n  "]))))}},843:function(e,t,r){"use strict";r.d(t,"a",(function(){return E})),r.d(t,"b",(function(){return T}));var n,a,i,o,s,d,l,c,h,u,f=r(120),p=r(119),g=r(413),v=r(254),m=r(358),b=r(249),_=r(308),y=r(322),O=r(333),x=r(280),w=r(622),j=r(787),R=r(699),C=r(906),S=r(933);function T(e){var t=new v.a;return t.include(g.a,{linearDepth:!1}),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),0!==e.output&&7!==e.output||(t.include(C.a,e),t.include(R.a,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(Object(p.a)(n||(n=Object(f.a)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vuv = uv0;\n        vpos = position;\n\n        vnormal = getLocalUp(vpos, localOrigin);\n        vtbnMatrix = getTBNMatrix(vnormal);\n\n        ","\n\n        gl_Position = transformPosition(proj, view, vpos);\n        ","\n      }\n    "])),p.a.float(O.c),e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":"",0===e.output?"forwardLinearDepth();":""))),e.multipassTerrainEnabled&&(t.fragment.include(_.a),t.include(x.b,e)),7===e.output&&(t.include(b.a,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(Object(p.a)(a||(a=Object(f.a)(["\n        void main() {\n          discardBySlice(vpos);\n          ","\n\n          gl_FragColor = vec4(waterColor.a);\n        }\n      "])),e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""))),0===e.output&&(t.include(j.a,e),t.include(b.a,e),e.receiveShadows&&t.include(w.a,e),t.include(S.a,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(m.a),t.fragment.code.add(Object(p.a)(i||(i=Object(f.a)(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        vec3 localUp = vnormal;\n        // the created normal is in tangent space\n        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\n\n        // we rotate the normal according to the tangent-bitangent-normal-Matrix\n        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);\n        vec3 v = -normalize(vpos - camPos);\n        vec3 l = normalize(-lightingMainDirection);\n        float shadow = ",";\n        vec4 vPosView = view*vec4(vpos, 1.0);\n        vec4 final = vec4(getSeaColor(n, v, l, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);\n\n        // gamma correction\n        gl_FragColor = delinearizeGamma(final);\n        gl_FragColor = highlightSlice(gl_FragColor, vpos);\n        ","\n      }\n    "])),e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":"",e.receiveShadows?Object(p.a)(o||(o=Object(f.a)(["1.0 - readShadowMap(vpos, linearDepth)"]))):"1.0",e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""))),2===e.output&&(t.include(C.a,e),t.include(j.a,e),t.include(b.a,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(Object(p.a)(s||(s=Object(f.a)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vuv = uv0;\n          vpos = position;\n\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),p.a.float(O.c))),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(Object(p.a)(d||(d=Object(f.a)(["\n        void main() {\n          discardBySlice(vpos);\n\n          // the created normal is in tangent space and foam\n          vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\n          tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);\n\n          gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);\n        }\n    "]))))),5===e.output&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(Object(p.a)(l||(l=Object(f.a)(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vpos = position;\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),p.a.float(O.c))),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(Object(p.a)(c||(c=Object(f.a)(["\n        void main() {\n          gl_FragColor = waterColor;\n        }\n    "]))))),4===e.output&&(t.include(y.a),t.varyings.add("vpos","vec3"),t.vertex.code.add(Object(p.a)(h||(h=Object(f.a)(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vpos = position;\n        gl_Position = transformPosition(proj, view, vpos);\n      }\n    "])),p.a.float(O.c))),t.include(b.a,e),t.fragment.code.add(Object(p.a)(u||(u=Object(f.a)(["\n      void main() {\n        discardBySlice(vpos);\n        outputHighlight();\n      }\n    "]))))),t}var E=Object.freeze({__proto__:null,build:T})},844:function(e,t,r){"use strict";r.d(t,"a",(function(){return l})),r.d(t,"b",(function(){return d}));var n,a=r(120),i=r(119),o=r(254),s=r(581);function d(){var e=new o.a;return e.include(s.a),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("color","vec4"),e.fragment.code.add(Object(i.a)(n||(n=Object(a.a)(["\n    void main() {\n      vec4 texColor = texture2D(tex, uv);\n      gl_FragColor = texColor * color;\n    }\n  "])))),e}var l=Object.freeze({__proto__:null,build:d})},880:function(e,t,r){"use strict";r.d(t,"a",(function(){return l}));var n,a,i=r(120),o=r(119),s=r(308);function d(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMat","mat4"),e.fragment.uniforms.add("rpProjectionMat","mat4"),e.fragment.code.add(Object(o.a)(n||(n=Object(i.a)(["\n  vec2 reprojectionCoordinate(vec3 projectionCoordinate)\n  {\n    vec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);\n    vec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);\n    reprojectedCoord.xy /= reprojectedCoord.w;\n    return reprojectedCoord.xy*0.5 + 0.5;\n  }\n  "]))))}function l(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("ssrViewMat","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.fragment.include(s.a),e.include(d),e.fragment.code.add(Object(o.a)(a||(a=Object(i.a)(["\n  const int maxSteps = ","\n\n  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)\n  {\n    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);\n    projectedCoord.xy /= projectedCoord.w;\n    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;\n    return projectedCoord;\n  }\n\n  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)\n  {\n    vec3 viewPos = startPosition;\n    vec3 viewPosEnd = startPosition;\n\n    // Project the start position to the screen\n    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);\n    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space\n    float k0 = 1.0/ projectedCoordStart.w;\n\n    // advance the position in the direction of the reflection\n    viewPos += dir;\n\n    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);\n\n    // Project the advanced position to the screen\n    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);\n    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space\n    float k1 = 1.0/ projectedCoordEnd.w;\n\n    // calculate the reflection direction in the screen space\n    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);\n    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);\n\n    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);\n\n    float projectedCoordDirLength = length(projectedCoordDir);\n    float maxSt = float(maxSteps);\n\n    // normalize the projection direction depending on maximum steps\n    // this determines how blocky the reflection looks\n    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);\n\n    // Normalize the homogeneous camera space coordinates\n    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);\n    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);\n\n    // initialize the variables for ray marching\n    vec2 P = projectedCoordStart.xy;\n    vec3 Q = Q0;\n    float k = k0;\n    float rayStartZ = -startPosition.z; // estimated ray start depth value\n    float rayEndZ = -startPosition.z;   // estimated ray end depth value\n    float prevEstimateZ = -startPosition.z;\n    float rayDiffZ = 0.0;\n    float dDepth;\n    float depth;\n    float rayDiffZOld = 0.0;\n\n    // early outs\n    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)\n      return vec3(P, 0.0);\n\n    for(int i = 0; i < maxSteps-1; i++)\n    {\n      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer\n\n      // estimate depth of the marching ray\n      rayStartZ = prevEstimateZ;\n      dDepth = -rayStartZ - depth;\n      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));\n      rayDiffZ = rayEndZ- rayStartZ;\n      prevEstimateZ = rayEndZ;\n\n      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )\n      {\n        return vec3(P, 0.);\n      }\n\n      // If we detect a hit - return the intersection point, two conditions:\n      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth\n      //  - if difference between dDepth and rayDiffZOld is not too large\n      //  - if difference between dDepth and 0.025/abs(k) is not too large\n      //  - if the sampled depth is not behind far plane or in front of near plane\n\n      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)\n      {\n          return vec3(P, depth);\n      }\n\n      // continue with ray marching\n      P += dP;\n      Q.z += dQ.z;\n      k += dk;\n      rayDiffZOld = rayDiffZ;\n    }\n    return vec3(P, 0.0);\n  }\n  "])),t.highStepCount?"150;":"75;"))}(d||(d={})).bindUniforms=function(e,t,r){e.setUniform1i("lastFrameColorMap",r.lastFrameColorTextureUnit),t.bindTexture(r.lastFrameColorTexture,r.lastFrameColorTextureUnit),e.setUniformMatrix4fv("reprojectionMat",r.reprojectionMat),e.setUniformMatrix4fv("rpProjectionMat",r.camera.projectionMatrix)},(l||(l={})).bindUniforms=function(e,t,r){r.ssrEnabled&&(e.setUniform1i("depthMapView",r.linearDepthTextureUnit),t.bindTexture(r.linearDepthTexture,r.linearDepthTextureUnit),e.setUniform2fv("nearFar",r.camera.nearFar),e.setUniformMatrix4fv("ssrViewMat",r.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/r.camera.height),d.bindUniforms(e,t,r))}},906:function(e,t,r){"use strict";r.d(t,"a",(function(){return l}));var n,a,i,o,s=r(120),d=r(119);function l(e,t){1===t.viewingMode?e.vertex.code.add(Object(d.a)(n||(n=Object(s.a)(["\n      vec3 getLocalUp(in vec3 pos, in vec3 origin) {\n          return normalize(pos + origin);\n      }\n    "])))):e.vertex.code.add(Object(d.a)(a||(a=Object(s.a)(["\n      vec3 getLocalUp(in vec3 pos, in vec3 origin) {\n          return vec3(0.0, 0.0, 1.0); // WARNING: up-axis dependent code\n      }\n    "])))),1===t.viewingMode?e.vertex.code.add(Object(d.a)(i||(i=Object(s.a)(["\n        mat3 getTBNMatrix(in vec3 n) {\n            vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));\n            vec3 b = normalize(cross(n, t));\n            return mat3(t, b, n);\n        }\n    "])))):e.vertex.code.add(Object(d.a)(o||(o=Object(s.a)(["\n        mat3 getTBNMatrix(in vec3 n) {\n            vec3 t = vec3(1.0, 0.0, 0.0);\n            vec3 b = normalize(cross(n, t));\n            return mat3(t, b, n);\n        }\n    "]))))}},907:function(e,t,r){"use strict";r.d(t,"a",(function(){return f}));var n=r(89),a=r(104),i=r(111),o=r(157),s=r(174),d=r(191),l=r(373),c=r(471),h=r(920),u=r(468);class f extends u.a{constructor(e){super(e),this._renderOccluded=4,this._width=1,this._color=Object(l.c)(1,0,1,1),this._innerWidth=1,this._innerColor=null,this._stipplePattern=null,this._stippleOffColor=null,this._stippleIntegerRepeats=!1,this._writeDepthEnabled=!0,this._falloff=0,this._polygonOffset=!1,this.applyProps(e)}setGeometryFromExtent(e){var t=this.view.spatialReference,r=Object(a.e)(),n=Object(a.e)(),o=100,s=[];Object(i.v)(r,e[0],e[1],o),this.view.renderCoordsHelper.toRenderCoords(r,t,n),s.push([n[0],n[1],n[2]]),Object(i.v)(r,e[2],e[1],o),this.view.renderCoordsHelper.toRenderCoords(r,t,n),s.push([n[0],n[1],n[2]]),Object(i.v)(r,e[2],e[3],o),this.view.renderCoordsHelper.toRenderCoords(r,t,n),s.push([n[0],n[1],n[2]]),Object(i.v)(r,e[0],e[3],o),this.view.renderCoordsHelper.toRenderCoords(r,t,n),s.push([n[0],n[1],n[2]]),Object(i.v)(r,e[0],e[1],o),this.view.renderCoordsHelper.toRenderCoords(r,t,n),s.push([n[0],n[1],n[2]]),Object(i.v)(r,e[0],e[1],o),this.view.renderCoordsHelper.toRenderCoords(r,t,n),s.push([n[0],n[1],n[2]]),this.geometry=[s]}setGeometryFromFrustum(e){var t=[];e.lines.forEach((e=>{t.push([e.origin[0],e.origin[1],e.origin[2]]),t.push([e.endpoint[0],e.endpoint[1],e.endpoint[2]])})),this.geometry=[t]}setGeometryFromSegment(e){var t=e.endRenderSpace;Object(o.i)(p),Object(o.s)(p,p,t),this.transform=p;var{points:r}=e.createRenderGeometry(t,this.view.renderCoordsHelper);this.geometry=[r]}setGeometryFromSegments(e,t=a.b){Object(o.i)(p),Object(o.s)(p,p,t),this.transform=p,this.geometry=e.map((e=>e.createRenderGeometry(t,this.view.renderCoordsHelper).points))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){Object(d.g)(e,this._color)||(Object(d.c)(this._color,e),this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){Object(n.k)(e)?!Object(n.j)(this._innerColor)&&Object(d.g)(e,this._innerColor)||(this._innerColor=Object(d.c)(Object(l.b)(),e),this._updateMaterial()):Object(n.k)(this._innerColor)&&(this._innerColor=null,this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){var t=Object(n.k)(e)!==Object(n.k)(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(Object(n.j)(e)||Object(n.j)(this._stippleOffColor)||!Object(d.g)(e,this._stippleOffColor))&&(this._stippleOffColor=Object(n.k)(e)?Object(l.a)(e):null,this._updateMaterial())}get stippleIntegerRepeats(){return this._stippleIntegerRepeats}set stippleIntegerRepeats(e){this._stippleIntegerRepeats!==e&&(this._stippleIntegerRepeats=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}createExternalResources(){this._material=new c.a(this.materialParameters)}destroyExternalResources(){this._material=null}createGeometries(e){var t=this._createLineGeometries();if(0!==t.length)for(var r=0;r<t.length;++r){var n=Object(h.a)(t[r]);e.addGeometry(n,this._material)}}forEachExternalMaterial(e){e(this._material)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,isClosed:!1,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,stippleIntegerRepeats:this._stippleIntegerRepeats,polygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateMaterial(){this.attached&&this._material.setParameterValues(this.materialParameters)}_createLineGeometries(){var e=this.geometry;if(Object(n.j)(e)||0===e.length)return[];var t=[];return e.forEach((e=>{var r=e.length,n=new Float64Array(3*r);e.forEach(((e,t)=>{n[3*t+0]=e[0],n[3*t+1]=e[1],n[3*t+2]=e[2]}));var a={attributeData:{position:n},removeDuplicateStartEnd:0};t.push(a)})),t}}var p=Object(s.b)()},920:function(e,t,r){"use strict";r.d(t,"a",(function(){return It})),r.d(t,"b",(function(){return Pt})),r.d(t,"c",(function(){return Ht}));var n=r(295),a=r(89),i=r(110),o=r(104),s=r(111),d=r(223),l=r(276);r(536),r(838);function c(e,t,r){for(var n=e.length,a=new Array(n),i=new Array(n),o=new Array(n),s=0,d=0,l=0,c=0,f=0;f<n;++f)c+=e[f].length;for(var p=new Float64Array(3*c),g=0,v=n-1;v>=0;v--){var m=e[v],b=1===r&&u(m);if(b&&1!==n)a[s++]=m;else{for(var _=m.length,y=0;y<s;++y)_+=a[y].length;var O={index:g,pathLengths:new Array(s+1),count:_,holeIndices:new Array(s)};O.pathLengths[0]=m.length,m.length>0&&(o[l++]={index:g,count:m.length}),g=b?h(m,m.length-1,-1,p,g,m.length,t):h(m,0,1,p,g,m.length,t);for(var x=0;x<s;++x){var w=a[x];O.holeIndices[x]=g,O.pathLengths[x+1]=w.length,w.length>0&&(o[l++]={index:g,count:w.length}),g=h(w,0,1,p,g,w.length,t)}s=0,O.count>0&&(i[d++]=O)}}for(var j=0;j<s;++j){var R=a[j];R.length>0&&(o[l++]={index:g,count:R.length}),g=h(R,0,1,p,g,R.length,t)}return d<n&&(i.length=d),l<n&&(o.length=l),{position:p,polygons:i,outlines:o}}function h(e,t,r,n,a,i,o){a*=3;for(var s=0;s<i;++s){var d=e[t];n[a++]=d[0],n[a++]=d[1],n[a++]=o?d[2]:0,t+=r}return a/3}function u(e){return!Object(l.g)(e,!1,!1)}var f=r(463),p=r(601),g=r(7),v=r(82),m=(r(80),r(81)),b=(r(88),r(85)),_=r(84),y=(r(83),r(86),r(87),r(176)),O=r(97),x=r(189),w=r(115),j=r(108),R=r(157),C=r(289),S=r(567),T=r(202),E=r(205),M=r(478),D=r(523);class I{constructor(e=Object(o.e)(),t=Object(o.g)(.57735,.57735,.57735),r=!0){this.intensity=e,this.direction=t,this.castShadows=r}}class P{constructor(e=Object(o.e)(),t=Object(o.g)(.57735,.57735,.57735)){this.intensity=Object(o.e)(),this.direction=Object(o.e)(),this.intensity=e,this.direction=t}}class A{constructor(e=Object(o.e)()){this.intensity=e}}class H{constructor(){this.sh={r:[0],g:[0],b:[0]}}}var L=r(634),N=r(698),z=class extends O.a{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_UPDATE_THRESHOLDS=!1,this.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET=!1,this.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.ENABLE_PROFILE_DEPTH_RANGE=!1,this.DISABLE_FAST_UPDATES=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1}};Object(v.a)([Object(b.b)()],z.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),Object(v.a)([Object(b.b)()],z.prototype,"SCENEVIEW_LOCKING_LOG",void 0),Object(v.a)([Object(b.b)()],z.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),Object(v.a)([Object(b.b)()],z.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),Object(v.a)([Object(b.b)()],z.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),Object(v.a)([Object(b.b)()],z.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),Object(v.a)([Object(b.b)()],z.prototype,"DECONFLICTOR_SHOW_GRID",void 0),Object(v.a)([Object(b.b)()],z.prototype,"LABELS_SHOW_BORDER",void 0),Object(v.a)([Object(b.b)()],z.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),Object(v.a)([Object(b.b)()],z.prototype,"OVERLAY_SHOW_CENTER",void 0),Object(v.a)([Object(b.b)()],z.prototype,"SHOW_POI",void 0),Object(v.a)([Object(b.b)()],z.prototype,"TESTS_DISABLE_UPDATE_THRESHOLDS",void 0),Object(v.a)([Object(b.b)()],z.prototype,"DISABLE_DECONFLICTOR_VISIBILITY_OFFSET",void 0),Object(v.a)([Object(b.b)()],z.prototype,"DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES",void 0),Object(v.a)([Object(b.b)()],z.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),Object(v.a)([Object(b.b)()],z.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),Object(v.a)([Object(b.b)()],z.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),Object(v.a)([Object(b.b)()],z.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),Object(v.a)([Object(b.b)()],z.prototype,"I3S_TREE_SHOW_TILES",void 0),Object(v.a)([Object(b.b)()],z.prototype,"I3S_SHOW_MODIFICATIONS",void 0),Object(v.a)([Object(b.b)()],z.prototype,"ENABLE_PROFILE_DEPTH_RANGE",void 0),Object(v.a)([Object(b.b)()],z.prototype,"DISABLE_FAST_UPDATES",void 0),Object(v.a)([Object(b.b)()],z.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),Object(v.a)([Object(b.b)()],z.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),Object(v.a)([Object(b.b)()],z.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0);var F=new(z=Object(v.a)([Object(_.a)("esri.views.3d.support.DebugFlags")],z)),U=r(569),G=(r(208),r(263),r(192));class V{constructor(e,t){this.id=Object(x.a)(),this._renderTarget=null,this._renderTarget=new G.a(e,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:t,maxAnisotropy:8,width:0,height:0})}dispose(){this._renderTarget=Object(a.f)(this._renderTarget)}getTexture(){return this._renderTarget?this._renderTarget.colorTexture:null}isValid(){return null!==this._renderTarget}resize(e,t){this._renderTarget.resize(e,t)}bind(e){e.bindFramebuffer(this._renderTarget)}generateMipMap(){this._renderTarget.colorTexture.descriptor.hasMipmap&&this._renderTarget.colorTexture.generateMipmap()}disposeRenderTargetMemory(){this._renderTarget&&this._renderTarget.resize(0,0)}getGpuMemoryUsage(){var e=0;return this._renderTarget&&(e+=Object(M.c)(this._renderTarget)),e}}var W=r(125);class k{constructor(e,t){this.vec3=e,this.id=t}}function B(e,t,r,n){return new k(Object(o.g)(e,t,r),n)}class Z{constructor(e){this.extent=Object(W.i)(),this.resolution=0,this.renderLocalOrigin=B(0,0,0,"O"),this.pixelRatio=1,this.renderTargets={color:{fbo:new V(e,!0),valid:!1,lastUsed:1/0},colorWithoutRasterImage:{fbo:new V(e,!0),valid:!1,lastUsed:1/0},highlight:{fbo:new V(e,!1),valid:!1,lastUsed:1/0},water:{fbo:new V(e,!0),valid:!1,lastUsed:1/0},occluded:{fbo:new V(e,!0),valid:!1,lastUsed:1/0}}}dispose(){this.renderTargets.color.fbo.dispose(),this.renderTargets.colorWithoutRasterImage.fbo.dispose(),this.renderTargets.highlight.fbo.dispose(),this.renderTargets.water.fbo.dispose(),this.renderTargets.occluded.fbo.dispose()}drawRenderTargets(e,t,r){var n=this.renderTargets;n.color.valid=e.drawPass(0,n.color.fbo,t),n.highlight.valid=e.drawPass(5,n.highlight.fbo,t),n.water.valid=e.drawPass(3,n.water.fbo,t),n.occluded.valid=e.drawPass(0,n.occluded.fbo,t,1),n.colorWithoutRasterImage.valid=r&&e.drawPass(0,n.colorWithoutRasterImage.fbo,t,2)}computeRenderTargetValidityBitfield(){var e=this.renderTargets;return+e.color.valid|+e.colorWithoutRasterImage.valid<<1|+e.highlight.valid<<2|+e.water.valid<<3|+e.occluded.valid<<4}validateUsage(e,t){if(e.valid)e.lastUsed=t;else if(t-e.lastUsed>q)e.fbo.disposeRenderTargetMemory(),e.lastUsed=1/0;else if(e.lastUsed<1/0)return!0;return!1}collectUnusedMemory(e){var t=!1;return t=this.validateUsage(this.renderTargets.color,e)||t,t=this.validateUsage(this.renderTargets.colorWithoutRasterImage,e)||t,t=this.validateUsage(this.renderTargets.highlight,e)||t,t=this.validateUsage(this.renderTargets.occluded,e)||t,t=this.validateUsage(this.renderTargets.water,e)||t}getGpuMemoryUsage(){return this.renderTargets.color.fbo.getGpuMemoryUsage()+this.renderTargets.colorWithoutRasterImage.fbo.getGpuMemoryUsage()+this.renderTargets.highlight.fbo.getGpuMemoryUsage()+this.renderTargets.water.fbo.getGpuMemoryUsage()+this.renderTargets.occluded.fbo.getGpuMemoryUsage()}}var q=1e3,Y=r(209);class Q{constructor(){this._uniforms={proj:[],uShadowMapDistance:[],viewportPixelSz:[],lightingMainDirection:[]}}dispose(){this._uniforms=null}getPrograms(e){return this._uniforms[e]||[]}subscribeProgram(e){for(var t in this._uniforms)e.hasUniform(t)&&this._uniforms[t].push(e)}unsubscribeProgram(e){for(var t in this._uniforms)Object(Y.j)(this._uniforms[t],e)}}class X{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}class J{constructor(e){this._context=e,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.dispose())))),this._perConstructorInstances.clear()}acquire(e,t){var r=t.key,n=this._perConstructorInstances.get(e);n||(n=new Map,this._perConstructorInstances.set(e,n));var a=n.get(r);return void 0===a&&(a=new X(new e(this._context,t)),n.set(r,a)),++a.refCount,a.technique}acquireAndReleaseExisting(e,t,r){return Object(a.j)(r)?this.acquire(e,t):t.key===r.key&&r instanceof e?r:(this.release(r),this.acquire(e,t))}release(e){if(!Object(a.j)(e)){var t=this._perConstructorInstances.get(e.constructor).get(e.key);t.refCount-=1,0===t.refCount&&(t.refZeroFrame=this._frameCounter)}}frameUpdate(){this._frameCounter++,this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((t,r)=>{0===t.refCount&&t.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(t.technique.dispose(),e.delete(r))})),0===e.size&&this._perConstructorInstances.delete(t)}))}getProgramsUsingUniform(e){return this._context.commonUniformStore.getPrograms(e)}hotReload(){var e=this;return Object(g.a)((function*(){var t=new Array;e._perConstructorInstances.forEach(((r,n)=>{var a=function(){var t=Object(g.a)((function*(t,r){var n=r.shader;n&&(yield n.reload(),t.forEach((t=>{t.technique.reload(e._context)})))}));return function(e,r){return t.apply(this,arguments)}}();t.push(a(r,n))})),yield Promise.all(t)}))()}}var K=r(179),$=[{output:0,name:"color"},{output:1,name:"depth"},{output:2,name:"normal"},{output:3,name:"depthShadowMap"},{output:4,name:"highlight"},{output:5,name:"draped"},{output:6,name:"occlusion"},{output:7,name:"alpha"}];function ee(e,t){return e+"_"+$.find((e=>e.output===t)).name}var te=m.a.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRep");class re{constructor(e){this.refCnt=0,this.glMaterial=e}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,Object(K.a)(this.refCnt>=0)}getRefCnt(){return this.refCnt}getGLMaterial(){return this.glMaterial}}var ne=class{constructor(e,t,r){this._textureRep=e,this._techniqueRep=t,this.onMaterialChanged=r,this._id2glMaterialRef=new Map}dispose(){this._textureRep.dispose()}acquire(e,t){this.ownMaterial(e);var r=ee(e.id,t),n=this._id2glMaterialRef.get(r);if(null==n){var a=e.getGLMaterial({material:e,techniqueRep:this._techniqueRep,textureRep:this._textureRep,output:t});return(n=new re(a)).incRefCnt(),this._id2glMaterialRef.set(r,n),a}return n.incRefCnt(),n.getGLMaterial()}release(e,t){var r=ee(e.id,t),n=this._id2glMaterialRef.get(r);if(n.decRefCnt(),0===n.getRefCnt()){var a=n.getGLMaterial();a&&a.dispose(),this._id2glMaterialRef.delete(r)}}materialChanged(e){for(var t of $)if(5!==t.output&&6!==t.output){var r=this._id2glMaterialRef.get(ee(e.id,t.output));if(r&&r.getGLMaterial()){var n=r.getGLMaterial();n.updateParameters&&n.updateParameters()}}this.onMaterialChanged&&this.onMaterialChanged(e)}ownMaterial(e){Object(a.k)(e.materialRepository)&&e.materialRepository!==this&&te.error("Material is already owned by a different material repository"),e.materialRepository=this}},ae=r(99),ie=r(174),oe=r(453),se=r(509),de=r(471),le=0;class ce{constructor(){this.ROOT_ORIGIN_ID="rg_root_"+le++,this._origins=new Map,this._gridSize=42e5}getOrigin(e){var t=this._origins.get(this.ROOT_ORIGIN_ID);if(null==t){if(Object(a.k)(ce.testOrigin)){var r=ce.testOrigin;return this._origins.set(this.ROOT_ORIGIN_ID,B(r[0],r[1],r[2],this.ROOT_ORIGIN_ID)),this.getOrigin(e)}var n=B(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,n),n}Object(s.i)(he,e,t.vec3),he[0]=Math.abs(he[0]),he[1]=Math.abs(he[1]),he[2]=Math.abs(he[2]);var i=this._gridSize;if(he[0]<i&&he[1]<i&&he[2]<i)return t;var o=Math.round(e[0]/i),d=Math.round(e[1]/i),l=Math.round(e[2]/i),c="".concat("rg_").concat(o,"/").concat(d,"/").concat(l),h=this._origins.get(c);return h||(h=B(o*i,d*i,l*i,c),this._origins.set(c,h)),h}_drawOriginBox(e){var t=window.view,r=t._stage;if(null==this._object){this._material=new de.a({width:2,color:[0,1,0,1]}),r.add(this._material);var n=new se.a({isPickable:!1});this._object=new oe.a({castShadow:!1}),r.add(this._object),n.add(this._object),r.add(n)}for(var a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],i=a.length,o=new Array(3*i),s=new Uint16Array(2*(i-1)),l=.5*this._gridSize,c=0;c<i;c++)o[3*c+0]=e[0]+(1&a[c]?l:-l),o[3*c+1]=e[1]+(2&a[c]?l:-l),o[3*c+2]=e[2]+(4&a[c]?l:-l),c>0&&(s[2*c+0]=c-1,s[2*c+1]=c);Object(d.k)(o,ae.a.WebMercator,0,o,t.spatialReference,0,i);var h=new f.a([["position",{size:3,data:o,exclusive:!0}]],[["position",s]],2);r.add(h),this._object.addGeometry(h,this._material,ie.a),console.log(this._origins.size,e)}}var he=Object(o.e)();(ce||(ce={})).testOrigin=null;var ue=ce;var fe=13,pe=class{constructor(e,t,r,n,a,i){this.rctx=e,this.offscreenRenderingHelper=t,this.scenelightingData=r,this.shadowMap=n,this.ssaoHelper=a,this.sliceHelper=i,this.camera=null,this.lastFrameCamera=new N.a,this.pass=0,this.slot=0,this.highlightDepthTexture=null,this.renderOccludedMask=fe,this.hasOccludees=!1}resetRenderOccludedMask(){this.renderOccludedMask=fe}get isHighlightPass(){return 5===this.pass}},ge=r(379);class ve{constructor(){this.adds=new y.a,this.removes=new y.a,this.updates=new y.a({allocator:e=>e||new me,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class me{}class be{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}function _e(e){return e.data.indexCount>=1}var ye=r(570),Oe=r(325),xe=r(326),we=r(357);class je{constructor(e){null==e?e=16:e<65536&&(e=Object(i.o)(e)),this._array=new Float32Array(e),this._size=0}resize(e,t){if(this._size=e,this._size>this._array.length){for(var r=this._array.length||1;r<this._size;)r*=2;var n=new Float32Array(r);return t&&n.set(this._array),this._array=n,!0}var a=2*this._size;if(a<=this._array.length){for(var i=this._array.length;i>=a;)i=Math.floor(i/2);var o=new Float32Array(i);return t&&o.set(this._array.subarray(0,i)),this._array=o,!0}return!1}append(e){var t=this._size;this.resize(this._size+e.length,!0),this._array.set(e,t)}erase(e,t){for(var r=e;r<t;++r)this._array[r]=0}get array(){return this._array}get size(){return this._size}}var Re=r(388),Ce=r(300),Se=r(307),Te=r(313),Ee=r(306),Me=r(286),De=r(267),Ie=r(380),Pe=r(617),Ae=r(249),He=r(322),Le=r(349),Ne=r(280),ze=r(622),Fe=r(880),Ue=r(787),Ge=r(843);class Ve extends Se.a{constructor(e,t){super(e,t),this.waterTextureRepository=e.waterTextureRepository}initializeProgram(e){var t=Ve.shader.get(),r=this.configuration,n=t.build({OITEnabled:0===r.transparencyPassType,output:r.output,viewingMode:e.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:r.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:r.useSSR,highStepCount:!0,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Me.a(e.rctx,n.generateSource("vertex"),n.generateSource("fragment"),Ee.a)}ensureResource(e){return this.waterTextureRepository.ready||this.waterTextureRepository.updating||this.waterTextureRepository.loadTextures(e),this.waterTextureRepository.ready?2:1}bindPass(e,t,r){Ie.a.bindProjectionMatrix(this.program,r.camera.projectionMatrix),r.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",r.camera.nearFar),this.program.setUniform2fv("inverseViewport",r.inverseViewport),Object(Ne.a)(this.program,e,r)),0===this.configuration.output&&(r.lighting.setUniforms(this.program,!1),Fe.a.bindUniforms(this.program,e,r)),0!==this.configuration.output&&2!==this.configuration.output||(Ue.a.bindUniforms(this.program,t),this.waterTextureRepository.bindRepo(e)),this.program.setUniform4fv("waterColor",t.color),4===this.configuration.output&&He.a.bindOutputHighlight(e,this.program,r)}bindDraw(e){Ie.a.bindView(this.program,e),0!==this.configuration.output&&7!==this.configuration.output||Ie.a.bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&ze.a.bindUniforms(this.program,e,Pe.a.SHADOW_MAP),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||Ae.a.bindUniformsWithOrigin(this.program,this.configuration,e)}setPipelineState(e){var t=this.configuration,r=3===e,n=2===e;return Object(De.d)({blending:2!==t.output&&4!==t.output&&t.transparent?r?Le.f:Object(Le.a)(e):null,depthTest:{func:Object(Le.b)(e)},depthWrite:r?t.writeDepth&&De.c:Object(Le.c)(e),colorWrite:De.b,polygonOffset:r||n?null:Object(Le.g)(t.enableOffset)})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}Ve.shader=new Ce.a(Ge.a,(()=>r.e(304).then(r.bind(null,1209))));class We extends Te.a{constructor(){super(...arguments),this.output=0,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!0}}Object(v.a)([Object(Te.b)({count:8})],We.prototype,"output",void 0),Object(v.a)([Object(Te.b)()],We.prototype,"receiveShadows",void 0),Object(v.a)([Object(Te.b)()],We.prototype,"slicePlaneEnabled",void 0),Object(v.a)([Object(Te.b)()],We.prototype,"transparent",void 0),Object(v.a)([Object(Te.b)()],We.prototype,"enableOffset",void 0),Object(v.a)([Object(Te.b)()],We.prototype,"writeDepth",void 0),Object(v.a)([Object(Te.b)()],We.prototype,"useSSR",void 0),Object(v.a)([Object(Te.b)()],We.prototype,"isDraped",void 0),Object(v.a)([Object(Te.b)({count:4})],We.prototype,"transparencyPassType",void 0),Object(v.a)([Object(Te.b)()],We.prototype,"multipassTerrainEnabled",void 0),Object(v.a)([Object(Te.b)()],We.prototype,"cullAboveGround",void 0);class ke extends Re.a{constructor(e){super(e),this.updateParameters()}updateParameters(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(Ve,this.material.getTechniqueConfig(this.output,e),this.technique)}beginSlot(e){if(2===this.output)return 22===e;if(5===this.output)return null==e;if(4===this.output)return 3===e;var t=3;return this.material.params.transparent&&(t=this.material.params.writeDepth?5:8),e===t}setElapsedTimeUniform(e){var t=.001*this.material.animation.time;e.setUniform1f("timeElapsed",t*this.material.params.animationSpeed)}_updateShadowState(e){e.shadowMappingEnabled!==this.material.params.receiveShadows&&this.material.setParameterValues({receiveShadows:e.shadowMappingEnabled})}_updateSSRState(e){e.ssrEnabled!==this.material.params.ssrEnabled&&this.material.setParameterValues({ssrEnabled:e.ssrEnabled})}ensureResources(e){return this.technique.ensureResource(e)}ensureParameters(e){0===this.output&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}bind(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.params,t),2!==this.output&&0!==this.output||this.setElapsedTimeUniform(this.technique.program)}}class Be{constructor(e,t,r,n,a,i){this.from=e,this.to=t,this.isVisible=r,this.hasHighlights=n,this.hasOccludees=a,this.transformation=i,null!=i&&(this.transformationNormal=Object(ie.c)(i),Object(R.a)(this.transformationNormal,this.transformationNormal),Object(R.b)(this.transformationNormal,this.transformationNormal))}}function Ze(e,t){var r=e=>({first:e.from,count:e.to-e.from});if(0!==e.length){var n=e[e.length-1];if(function(e,t){return e.first+e.count>=t.from}(n,t)){var a=t.from-n.first+t.to-t.from;n.count=a}else e.push(r(t))}else e.push(r(t))}r(126);var qe=r(343);function Ye(e,t,r){Object(a.k)(r)&&(r.drawCalls+=e,r.triangles+=t)}qe.a;function Qe(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}var Xe={begin:0,end:0},Je=Object(ie.b)(),Ke=Object(ie.b)(),$e=Object(ie.b)(),et=class{constructor(e,t,r){this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=e,this._material=r,this._materialRep=t,this._glMaterials=Object(we.a)(this._material,this._materialRep),this._bufferWriter=r.createBufferWriter()}dispose(){Object(we.e)(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((e=>{e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((e=>{e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&Object(S.a)(this._glMaterials,(e=>e instanceof ke))}get rendersOccluded(){return!this.isEmpty&&1!==this._material.renderOccluded}modify(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()}addAndRemoveGeometries(e,t){var r=this._bufferWriter,n=r.vertexBufferLayout,a=n.stride/4,i=this._dataByOrigin,o=function(e,t,r,n){var a=new Map,i=t.vertexBufferLayout.stride/4,o=(r,n)=>{var o=r.origin,s=e.get(o.id),d=a.get(o.id);null==d&&(d={optimalCount:null==s?0:s.optimalCount,sparseCount:null==s?0:s.buffer.size,toAdd:[],toRemove:[],origin:o.vec3},a.set(o.id,d));var l=t.elementCount(r.data)*i;n?(d.optimalCount+=l,d.sparseCount+=l,d.toAdd.push(r)):(d.optimalCount-=l,d.toRemove.push(r))};for(var s of r)o(s,!0);for(var d of n)o(d,!1);return a}(i,r,e,t);o.forEach(((e,t)=>{o.delete(t);var r=e.optimalCount,s=e.sparseCount,d=i.get(t);if(null==d)Object(K.a)(r>0),d=this.createData(n,r,e.origin),i.set(t,d);else if(0===r)return d.vao.dispose(!0),d.vao=null,void i.delete(t);var l=r<e.sparseCount/2,c=l?r:s,h=Xe,u=d.buffer.size,f=d.buffer.array,p=d.buffer.resize(c,!1);l||p?this.removeAndRebuild(d,e.toRemove,a,f,h):e.toRemove.length>0?(this.removeByErasing(d,e.toRemove,a,h),e.toAdd.length>0&&(h.end=u)):(h.begin=u,h.end=u);var g=Je;Object(K.j)(g,-e.origin[0],-e.origin[1],-e.origin[2]),this.append(d,e.toAdd,a,g,h);var v=d.vao.vertexBuffers.geometry;if(v.byteSize!==d.buffer.array.buffer.byteLength)v.setData(d.buffer.array);else{var{begin:m,end:b}=h;if(m<b){var _=d.buffer.array,y=4*m,O=4*b;v.setSubData(_,y,y,O)}}d.drawCommandsDirty=!0}))}updateGeometries(e){var t=this._bufferWriter,r=t.vertexBufferLayout.stride/4;for(var n of e){var a=n.updateType,i=n.renderGeometry,o=this._dataByOrigin.get(i.origin.id),s=o&&o.instances.get(i.id);if(!s)return;if(1&a&&(s.isVisible=i.instanceParameters.visible),9&a){var d=i.instanceParameters.visible;s.hasHighlights=!!i.instanceParameters.highlights&&d}if(16&a&&(s.hasOccludees=!!i.instanceParameters.occludees),6&a){var l=o.buffer.array,c=o.vao;Object(we.c)(i,Ke,$e),t.write({transformation:Ke,invTranspTransformation:$e},i.data,t.vertexBufferLayout.createView(l.buffer),s.from),Object(K.a)(s.from+t.elementCount(i.data)===s.to,"material VBO layout has changed"),c.vertexBuffers.geometry.setSubData(l,s.from*r*4,s.from*r*4,s.to*r*4)}o.drawCommandsDirty=!0}}updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,Object(S.a)(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))}));this._dataByOrigin.forEach((e=>{e.drawCommandsDirty&&((e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,e.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0},0!==e.instances.size){if(!Qe(e)){var t=4*e.buffer.size/Object(M.d)(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0,shadowHighlightRest:0})}var r=function(e){return e.sort(((e,t)=>e.from===t.from?e.to>t.to?1:e.to<t.to?-1:0:e.from>t.from?1:e.from<t.from?-1:0))}([...e.instances.values()]);for(var n of(e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[],r))n.isVisible&&(n.hasOccludees?Ze(e.drawCommandsOccludees,n):Ze(e.drawCommandsDefault,n),n.hasHighlights?Ze(e.drawCommandsHighlight,n):Ze(e.drawCommandsShadowHighlightRest,n));var a=e=>{var t=0;for(var r of e)t+=r.count;return t/3};e.stats={default:a(e.drawCommandsDefault),highlight:a(e.drawCommandsHighlight),occludees:a(e.drawCommandsOccludees),shadowHighlightRest:a(e.drawCommandsShadowHighlightRest)}}})(e),e.drawCommandsDirty=!1)}))}updateLogic(e){return this._material.update(e)}render(e,t,r,n){var i=this._rctx,o=this._glMaterials.get(t.pass),s=5===t.pass||7===t.pass,d=6===t.pass,l=!(s||d),c=e;if(3===t.pass&&null===c&&(c=22),!o||2!==o.ensureResources(i)||null!=c&&!o.beginSlot(c)||s&&!this._hasHighlights)return!1;o.ensureParameters(r);var h=o.getTechnique(),u=o.getPipelineState(c,!1);i.setPipelineState(u),o.bind(i,r);var f=!1;return this._dataByOrigin.forEach((e=>{if(!(Object(a.j)(e.drawCommandsDefault)&&Object(a.j)(e.drawCommandsHighlight)&&Object(a.j)(e.drawCommandsOccludees)&&Object(a.j)(e.drawCommandsShadowHighlightRest))&&(!s||e.hasHighlights)){r.origin=e.origin,h.bindDraw(r),h.ensureAttributeLocations(e.vao),i.bindVAO(e.vao);var t=h.primitiveType,p=s?e.drawCommandsHighlight:d&&Qe(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault,g=s?e.stats.highlight:d&&Qe(e)?e.stats.shadowHighlightRest:e.stats.default;if(Object(a.k)(p)&&(this.renderCommands(i,t,p),Ye(p.length,g,n),f=!0),l&&(p=e.drawCommandsOccludees,Object(a.k)(p))){var v=o.getPipelineState(c,!0);i.setPipelineState(v),this.renderCommands(i,t,p),i.setPipelineState(u),Ye(p.length,e.stats.occludees,n),f=!0}}})),f}renderCommands(e,t,r){for(var n=0;n<r.length;n++)e.drawArrays(t,r[n].first,r[n].count)}createData(e,t,r){return{instances:new Map,vao:new xe.a(this._rctx,this._material.vertexAttributeLocations,{geometry:Object(ye.a)(e)},{geometry:Oe.a.createVertex(this._rctx,35044)}),buffer:new je(t),optimalCount:0,origin:r,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}}removeAndRebuild(e,t,r,n,a){for(var i of t){var o=i.id,s=e.instances.get(o);e.optimalCount-=(s.to-s.from)*r,e.instances.delete(o)}var d=0,l=e.buffer.array;a.begin=0,a.end=0;var c=-1,h=-1,u=0;e.instances.forEach((e=>{var t=e.from*r,a=e.to*r,i=a-t;c!==h&&h!==t?(l.set(n.subarray(c,h),u),u+=h-c,c=t):-1===c&&(c=t),h=a,e.from=d/r,d+=i,e.to=d/r})),c!==h&&l.set(n.subarray(c,h),u),a.end=d}removeByErasing(e,t,r,n){n.begin=1/0,n.end=-1/0;var a=-1,i=-1;for(var o of t){var s=o.id,d=e.instances.get(s),l=d.from*r,c=d.to*r;a!==i&&i!==l?(e.buffer.erase(a,i),a=l):-1===a&&(a=l),i=c,e.instances.delete(s),e.optimalCount-=c-l,l<n.begin&&(n.begin=l),c>n.end&&(n.end=c)}a!==i&&e.buffer.erase(a,i)}append(e,t,r,n,i){var o=this._bufferWriter;for(var s of t){var d=Object(a.k)(s.transformation)?Object(R.l)(Ke,n,s.transformation):n;Object(R.a)($e,d),Object(R.b)($e,$e);var l=i.end;o.write({transformation:d,invTranspTransformation:$e},s.data,o.vertexBufferLayout.createView(e.buffer.array.buffer),i.end/r);var c=o.elementCount(s.data)*r,h=l+c;Object(K.a)(null==e.instances.get(s.id));var u=s.instanceParameters.visible,f=!!s.instanceParameters.highlights&&u,p=!!s.instanceParameters.occludees,g=new Be(l/r,h/r,u,f,p);e.instances.set(s.id,g),e.optimalCount+=c,i.end+=c}}get test(){return{material:this._material,glMaterials:this._glMaterials}}},tt=class extends O.a{constructor(){super(...arguments),this._pendingAddsRemoves=new Map,this._changes=new ve,this._materialRenderers=new Map,this._sortedMaterialRenderers=new y.a,this._hasHighlights=!1,this._hasWater=!1}dispose(){this._changes.prune(),this._materialRenderers&&(this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear())}get updating(){return this._pendingAddsRemoves.size>0||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return Object(S.a)(this._materialRenderers,(e=>e.rendersOccluded))}stopAnimationsAtTime(e){this._sortedMaterialRenderers.forAll((t=>Object(a.c)(t.material.animation,(t=>t.stopAtTime(e)))))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size}commitChanges(){var e=!1;if(!this.updating)return!1;this.updateAddsRemoves();var t=function(e){var t=new Map,r=e=>{var r=t.get(e);return r||(r=new be,t.set(e,r)),r};return e.adds.forAll((e=>{_e(e)&&r(e.material).adds.push(e)})),e.removes.forAll((e=>{_e(e)&&r(e.material).removes.push(e)})),e.updates.forAll((e=>{_e(e.renderGeometry)&&r(e.renderGeometry.material).updates.push(e)})),t}(this._changes),r=!1,n=!1;return t.forEach(((t,a)=>{var i=this._materialRenderers.get(a);if(!i&&t.adds.length>0&&(i=new et(this.rctx,this.materialRepository,a),this._materialRenderers.set(a,i),e=!0,r=!0,n=!0),i){var o=r||i.hasHighlights,s=n||i.hasWater;i.modify(t),r=r||o!==i.hasHighlights,n=n||s!==i.hasWater,i.isEmpty&&(this._materialRenderers.delete(a),i.dispose(),e=!0)}})),this._changes.clear(),this._pendingAddsRemoves.clear(),e&&this.updateSortedMaterialRenderers(),r&&(this._hasHighlights=Object(S.a)(this._materialRenderers,(e=>e.hasHighlights))),n&&(this._hasWater=Object(S.a)(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0}add(e){if(0!==e.length){var t=0===this._pendingAddsRemoves.size;for(var r of e)this._pendingAddsRemoves.set(r,0);t&&this.notifyChange("updating")}}remove(e){var t=0===this._pendingAddsRemoves.size;for(var r of e){var n=this._pendingAddsRemoves.get(r);0===n?this._pendingAddsRemoves.set(r,2):2!==n&&this._pendingAddsRemoves.set(r,1)}t&&this._pendingAddsRemoves.size>0&&this.notifyChange("updating")}modify(e,t){var r=0===this._changes.updates.length;for(var n of e){var a=this._changes.updates.pushNew();a.renderGeometry=n,a.updateType=t}r&&this._changes.updates.length>0&&this.notifyChange("updating")}updateLogic(e){var t=!1;return this._sortedMaterialRenderers.forAll((({materialRenderer:r})=>{r.updateLogic&&r.updateLogic(e)&&(t=!0)})),t}draw(e,t){for(var r=0;r<this._sortedMaterialRenderers.length;r++){var n=this._sortedMaterialRenderers.data[r];Object(ge.c)(n.material,e)&&n.materialRenderer.render(null,e,t,null)}}updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();var e=0;this._materialRenderers.forEach(((t,r)=>{r.insertOrder=e++,this._sortedMaterialRenderers.push({material:r,materialRenderer:t})})),this._sortedMaterialRenderers.sort(((e,t)=>{var r=t.material.renderPriority-e.material.renderPriority;return 0!==r?r:e.material.insertOrder-t.material.insertOrder}))}updateAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._pendingAddsRemoves.forEach(((e,t)=>{switch(e){case 0:this._changes.adds.push(t);break;case 1:this._changes.removes.push(t)}}));for(var e=0;e<this._changes.updates.length;){var t=this._changes.updates.data[e].renderGeometry;this._pendingAddsRemoves.has(t)?this._changes.updates.removeUnorderedIndex(e):e++}}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};Object(v.a)([Object(b.b)()],tt.prototype,"rctx",void 0),Object(v.a)([Object(b.b)()],tt.prototype,"materialRepository",void 0),Object(v.a)([Object(b.b)()],tt.prototype,"updating",null),tt=Object(v.a)([Object(_.a)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],tt);var rt=r(844);class nt extends Se.a{initializeProgram(e){var t=nt.shader.get().build();return new Me.a(e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),Ee.a)}initializePipeline(){return this.configuration.hasAlpha?Object(De.d)({blending:Object(De.e)(770,1,771,771),colorWrite:De.b}):Object(De.d)({colorWrite:De.b})}}nt.shader=new Ce.a(rt.a,(()=>r.e(291).then(r.bind(null,1210))));class at extends Te.a{constructor(){super(...arguments),this.hasAlpha=!1}}function it(e,t,r){(r=r||e).length=e.length;for(var n=0;n<e.length;n++)r[n]=e[n]*t[n];return r}function ot(e,t,r){(r=r||e).length=e.length;for(var n=0;n<e.length;n++)r[n]=e[n]*t;return r}function st(e,t,r){(r=r||e).length=e.length;for(var n=0;n<e.length;n++)r[n]=e[n]+t[n];return r}function dt(e){return(e+1)*(e+1)}function lt(e,t,r){var n=e[0],a=e[1],i=e[2],o=r||[];return o.length=dt(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*n,o[2]=.4886025119*i,o[3]=.4886025119*a),t>=2&&(o[4]=1.09254843059*n*a,o[5]=1.09254843059*a*i,o[6]=.31539156525*(3*i*i-1),o[7]=1.09254843059*n*i,o[8]=.54627421529*(n*n-a*a)),o}function ct(e,t){var r=function(e){return Object(i.d)(Math.floor(Math.sqrt(e)-1),0,2)}(t.r.length);for(var n of e)Object(s.s)(mt,n.direction),lt(mt,r,gt),it(gt,bt),ot(gt,n.intensity[0],vt),st(t.r,vt),ot(gt,n.intensity[1],vt),st(t.g,vt),ot(gt,n.intensity[2],vt),st(t.b,vt);return t}function ht(e,t,r){(function(e,t){var r=dt(e),n=t||{r:[],g:[],b:[]};n.r.length=n.g.length=n.b.length=r;for(var a=0;a<r;a++)n.r[a]=n.g[a]=n.b[a]=0})(t,r.sphericalHarmonics.sh),Object(s.v)(r.main.intensity,0,0,0);var n=!1,a=ut,i=ft,o=pt;for(var d of(a.length=0,i.length=0,o.length=0,e))d instanceof I&&!n?(Object(s.j)(r.main.direction,d.direction),r.main.intensity[0]=d.intensity[0],r.main.intensity[1]=d.intensity[1],r.main.intensity[2]=d.intensity[2],r.main.castShadows=d.castShadows,n=!0):d instanceof I||d instanceof P?a.push(d):d instanceof A?i.push(d):d instanceof H&&o.push(d);for(var l of(ct(a,r.sphericalHarmonics.sh),function(e,t){for(var r of(lt(mt,0,gt),e))t.r[0]+=gt[0]*bt[0]*r.intensity[0]*4*Math.PI,t.g[0]+=gt[0]*bt[0]*r.intensity[1]*4*Math.PI,t.b[0]+=gt[0]*bt[0]*r.intensity[2]*4*Math.PI}(i,r.sphericalHarmonics.sh),o))st(r.sphericalHarmonics.sh.r,l.sh.r),st(r.sphericalHarmonics.sh.g,l.sh.g),st(r.sphericalHarmonics.sh.b,l.sh.b)}Object(v.a)([Object(Te.b)()],at.prototype,"hasAlpha",void 0);var ut=[],ft=[],pt=[],gt=[0],vt=[0],mt=Object(o.e)(),bt=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398],_t=Object(o.e)();class yt{constructor(){this._renderLighting={main:{intensity:Object(o.e)(),direction:Object(o.g)(1,0,0),castShadows:!1},sphericalHarmonics:{sh:{r:[0],g:[0],b:[0]}}},this._shOrder=2,this._oldSunlight={direction:Object(o.e)(),ambient:{color:Object(o.e)(),intensity:0},diffuse:{color:Object(o.e)(),intensity:0}}}setLightDirectionUniform(e){e.setUniform3fv("lightingMainDirection",this._renderLighting.main.direction)}setUniforms(e,t=!1){if(t){var r=(1-this._info.groundLightingFactor)*(1-this._info.globalFactor);e.setUniform1f("lightingFixedFactor",r)}else e.setUniform1f("lightingFixedFactor",0);e.setUniform1f("lightingGlobalFactor",this._info.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._renderLighting.main.intensity),e.setUniform1f("ambientBoostFactor",.4);var n=this._renderLighting.sphericalHarmonics.sh;0===this._shOrder?e.setUniform3f("lightingAmbientSH0",n.r[0],n.g[0],n.b[0]):1===this._shOrder?(e.setUniform4f("lightingAmbientSH_R",n.r[0],n.r[1],n.r[2],n.r[3]),e.setUniform4f("lightingAmbientSH_G",n.g[0],n.g[1],n.g[2],n.g[3]),e.setUniform4f("lightingAmbientSH_B",n.b[0],n.b[1],n.b[2],n.b[3])):2===this._shOrder&&(e.setUniform3f("lightingAmbientSH0",n.r[0],n.g[0],n.b[0]),e.setUniform4f("lightingAmbientSH_R1",n.r[1],n.r[2],n.r[3],n.r[4]),e.setUniform4f("lightingAmbientSH_G1",n.g[1],n.g[2],n.g[3],n.g[4]),e.setUniform4f("lightingAmbientSH_B1",n.b[1],n.b[2],n.b[3],n.b[4]),e.setUniform4f("lightingAmbientSH_R2",n.r[5],n.r[6],n.r[7],n.r[8]),e.setUniform4f("lightingAmbientSH_G2",n.g[5],n.g[6],n.g[7],n.g[8]),e.setUniform4f("lightingAmbientSH_B2",n.b[5],n.b[6],n.b[7],n.b[8]))}set(e){this._info=e,ht(e.lights,this._shOrder,this._renderLighting),Object(s.s)(this._oldSunlight.direction,this._renderLighting.main.direction);var t=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._renderLighting.sphericalHarmonics.sh.r[0]*t,this._oldSunlight.ambient.color[1]=.282095*this._renderLighting.sphericalHarmonics.sh.g[0]*t,this._oldSunlight.ambient.color[2]=.282095*this._renderLighting.sphericalHarmonics.sh.b[0]*t,this._oldSunlight.ambient.intensity=1,this._oldSunlight.diffuse.color[0]=this._renderLighting.main.intensity[0]*t,this._oldSunlight.diffuse.color[1]=this._renderLighting.main.intensity[1]*t,this._oldSunlight.diffuse.color[2]=this._renderLighting.main.intensity[2]*t,this._oldSunlight.diffuse.intensity=1;var r=Object(s.j)(_t,this._oldSunlight.diffuse.color);Object(s.d)(r,r,.4*this._info.globalFactor),Object(s.e)(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,r)}get globalFactor(){return this._info.globalFactor}get old(){return this._oldSunlight}}var Ot=r(786),xt=m.a.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer"),wt=class extends(Object(U.b)(O.a)){constructor(e){super(e),this._overlays=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new yt,this._localOrigins=new ue,this._handles=new w.a,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new y.a,this._geometries=new Map,this.globalUnitScale=1,this.longitudeCyclical=null}initialize(){this._rctx=this.renderView.renderingContext,this._renderContext=new pe(this._rctx,null,null,null,null,null),this._stippleTextureRepository=new Ot.a,this.waterTextureRepository=this.renderView.waterTextureRepository,this._shaderTechniqueRepository=new J({rctx:this._rctx,viewingMode:2,commonUniformStore:new Q,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),Object(j.a)(this.waterTextureRepository,"loadingState",(()=>this.emitContentChanged())),this._materialRepository=new ne(this.renderView.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=e=>{(e.renderOccluded&Et)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.emitContentChanged(),this.notifyChange("updating")},this._compositingHelper=this.renderView.compositingHelper,this._lighting.set({lights:[new A(Object(o.g)(1,1,1))],groundLightingFactor:1,globalFactor:0}),this._bindParameters={slot:null,highlightDepthTexture:Object(D.a)(this._rctx),camera:Ct,inverseViewport:Object(T.a)(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureUnit:0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!0,multipassGeometryEnabled:!1},this._handles.add(this.scheduler.registerTask(C.b.STAGE,(()=>this.commitChanges()),(()=>this.updating)))}dispose(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.dispose())),this._layerRenderers.clear(),this._bindParameters.highlightDepthTexture=Object(a.f)(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=Object(a.f)(this._shaderTechniqueRepository),this._temporaryRenderTarget=Object(a.f)(this._temporaryRenderTarget),this._debugPatternTexture=Object(a.f)(this._debugPatternTexture),this._quadVAO=Object(a.f)(this._quadVAO)}get updating(){return this._sortedLayerRenderersDirty||Object(S.a)(this._layerRenderers,(e=>e.updating))||this.waterTextureRepository.updating}get hasOverlays(){return Object(a.k)(this._overlays)}get gpuMemoryUsage(){return Object(a.k)(this._overlays)?this._overlays[0].getGpuMemoryUsage()+this._overlays[1].getGpuMemoryUsage():0}get overlays(){return this._overlays}forEachOverlay(e){Object(a.k)(this._overlays)&&(e(this._overlays[0],0),e(this._overlays[1],1))}ensureOverlays(){if(Object(a.j)(this._overlays)){var e=this.renderView.renderingContext;this._overlays=[new Z(e),new Z(e)]}}disposeOverlays(){Object(a.k)(this._overlays)&&(this._overlays.forEach((e=>e.dispose())),this._overlays=null)}commitChanges(){var e=!1;this._layerRenderers.forEach(((t,r)=>{t.commitChanges()&&(e=!0),t.isEmpty&&(this._layerRenderers.delete(r),this._sortedLayerRenderersDirty=!0,this._handles.remove(r))})),this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),e=!0),e&&(this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}addGeometries(e,t,r){for(var n of e)null==n.origin&&(n.origin=this._localOrigins.getOrigin(n.boundingSphere)),Object(a.j)(n.id)&&(n.id=Object(x.a)()),this._geometries.set(n.id,n);this.ensureLayerRenderer(t).add(e),2===r&&this.notifyGraphicGeometryChanged(e,t)}removeGeometries(e,t,r){for(var n of e)this._geometries.delete(Object(a.q)(n.id));var i=this._layerRenderers.get(t);i&&(i.remove(e),2===r&&this.notifyGraphicGeometryChanged(e,t))}updateGeometries(e,t,r){var n=this._layerRenderers.get(t);if(n)switch(n.modify(e,r),r){case 4:case 2:return this.notifyGraphicGeometryChanged(e,t);case 1:return this.notifyGraphicVisibilityChanged(e,t)}else xt.warn("Attempted to update geometry for nonexistent layer")}notifyGraphicGeometryChanged(e,t){var r;if(!Object(a.j)(t.notifyGraphicGeometryChanged))for(var n of e){var i=n.graphicUid;i!==r&&(t.notifyGraphicGeometryChanged(i),r=i)}}notifyGraphicVisibilityChanged(e,t){var r;if(!Object(a.j)(t.notifyGraphicVisibilityChanged))for(var n of e){var i=n.graphicUid;i!==r&&(t.notifyGraphicVisibilityChanged(i),r=i)}}updateHighlights(e,t){var r=this._layerRenderers.get(t);r?r.modify(e,8):xt.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return 0===this._geometries.size&&!F.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateLogic(e){var t=!1;return this._layerRenderers.forEach((r=>{r.updateLogic(e)&&(t=!0)})),t}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawPass(e,t,r,n=0){if(0===r.numViews)return!1;if(this._screenToWorldRatio=r.pixelRatio*Math.abs(r.views[0].extent[2]-r.views[0].extent[0])/Math.abs(r.views[0].viewport[2]-r.views[0].viewport[0]),this.isEmpty()||5===e&&!this.hasHighlights||3===e&&!this.hasWater)return!1;if(!this.hasNonZeroSizedView(r))return!1;var i=r.width,o=r.height;if(!t.isValid())return!1;t.resize(i,o);var s=this._rctx;if(Ct.pixelRatio=r.pixelRatio||1,this._renderContext.pass=e,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,t.bind(s),s.setClearColor(0,0,0,0),s.clearSafe(16384),1===n&&(this._renderContext.renderOccludedMask=Et),F.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==n)for(var d=0;d<r.numViews;d++)this.setViewParameters(r.views[d],Ct),this.drawDebugTexture(i,o,Rt[r.index%Rt.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({layerView:d,renderer:l})=>{if(2!==n||!Object(a.k)(d)||0!==d.drapeSourceType){var c=Object(a.k)(d)&&Object(a.k)(d.fullOpacity)&&d.fullOpacity<1&&0===e;c&&(this.bindTemporaryFramebuffer(this._rctx,i,o),s.clearSafe(16384));for(var h=0;h<r.numViews;h++)this.setViewParameters(r.views[h],Ct),l.draw(this._renderContext,this._bindParameters);c&&Object(a.k)(this._temporaryRenderTarget)&&(t.bind(s),this._compositingHelper.composite(this._temporaryRenderTarget.getTexture(),2,Object(a.q)(Object(a.q)(d).fullOpacity)))}})),s.bindFramebuffer(null),t.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,r){Object(a.j)(this._temporaryRenderTarget)&&(this._temporaryRenderTarget=new V(e,!1)),this._temporaryRenderTarget.resize(t,r),this._temporaryRenderTarget.bind(e)}reloadShaders(){var e=this;return Object(g.a)((function*(){yield e._shaderTechniqueRepository.hotReload()}))()}intersect(e,t,r){var n=0;this._geometries.forEach((a=>{if(!r||r(a)){this.intersectRenderGeometry(a,t,0,e,n);var i=this.longitudeCyclical;i&&(a.boundingSphere[0]-a.boundingSphere[3]<i.min&&this.intersectRenderGeometry(a,t,i.range,e,n),a.boundingSphere[0]+a.boundingSphere[3]>i.max&&this.intersectRenderGeometry(a,t,-i.range,e,n)),n++}}))}intersectRenderGeometry(e,t,r,n,i){if(e.instanceParameters.visible){var o=0;Object(a.k)(e.transformation)&&(r+=e.transformation[12],o=e.transformation[13]),St[0]=t[0]-r,St[1]=t[1]-o,St[2]=1,Tt[0]=t[0]-r,Tt[1]=t[1]-o,Tt[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),n,St,Tt,((t,r,a)=>{this.addIntersectionResult(a,e.material.renderPriority,i,n,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,!0)}}addIntersectionResult(e,t,r,n,a,i){var o={type:"external",metadata:{layerUid:a,graphicUid:i}},s=a=>{a.set(o,null,n.results.ground.dist,n.results.ground.normal,n.results.ground.transformation,t,null,null,e,r),a.intersector="OverlayRenderer"};if((null==n.results.min.drapedLayerOrder||t>=n.results.min.drapedLayerOrder)&&(null==n.results.min.dist||n.results.ground.dist<=n.results.min.dist)&&s(n.results.min),0!==n.options.store&&(null==n.results.max.drapedLayerOrder||t<n.results.max.drapedLayerOrder)&&(null==n.results.max.dist||n.results.ground.dist>n.results.max.dist)&&s(n.results.max),2===n.options.store){var d=new L.b(n.ray);s(d),n.results.all.push(d)}}stopAnimationsAtTime(e){this._sortedLayerRenderers.forAll((t=>t.renderer.stopAnimationsAtTime(e)))}ensureLayerRenderer(e){var t=this._layerRenderers.get(e);return t||(t=new tt({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,t),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.emitContentChanged())),e),this._handles.add(Object(j.a)(t,"updating",(()=>this.notifyChange("updating"))),e)),t}updateSortedLayerRenderers(){if(this._sortedLayerRenderersDirty&&(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0!==this._layerRenderers.size)){var[{view:{allLayerViews:e}}]=this._layerRenderers.keys(),t=new Set(this._layerRenderers.values());e.forEach((e=>{var r=e,n=this._layerRenderers.get(r);n&&(this._sortedLayerRenderers.push(new jt(r,n)),t.delete(n))})),t.forEach((e=>{this._sortedLayerRenderers.push(new jt(null,e))}))}}setViewParameters(e,t){t.viewport=e.viewport;var r=e.extent;Object(R.n)(t.projectionMatrix,0,r[2]-r[0],0,r[3]-r[1],t.near,t.far),Object(R.i)(t.viewMatrix),Object(R.s)(t.viewMatrix,t.viewMatrix,[-e.extent[0],-e.extent[1],0]),t.setGLViewport(this._rctx),this._renderContext.camera=t,this._bindParameters.camera=t,this._bindParameters.inverseViewport[0]=1/t.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.fullViewport[3]}hasNonZeroSizedView(e){for(var t=0;t<e.numViews;t++){var r=e.views[t];if(r.extent[0]!==r.extent[2]&&r.extent[1]!==r.extent[3])return!0}return!1}emitContentChanged(){this.onContentChanged&&this.onContentChanged()}updateHasWater(){var e=Object(S.a)(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e)}updateHasHighlights(){var e=Object(S.a)(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))}updateRendersOccluded(){var e=Object(S.a)(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))}drawDebugTexture(e,t,r){var n=this._rctx;this.ensureDebugPatternResources(e,t);var a=this._debugTextureTechnique.program;n.bindProgram(a),n.setPipelineState(this._debugTextureTechnique.pipeline),a.setUniform4f("color",r[0],r[1],r[2],1),a.setUniform1i("tex",0),n.bindTexture(this._debugPatternTexture,0),n.bindVAO(this._quadVAO),n.drawArrays(5,0,Object(M.f)(this._quadVAO,"geometry"))}ensureDebugPatternResources(e,t){if(!this._debugPatternTexture){for(var r=new Uint8Array(e*t*4),n=0,a=0;a<t;a++)for(var i=0;i<e;i++){var o=Math.floor(i/10),s=Math.floor(a/10);o<2||s<2||10*o>e-20||10*s>t-20?(r[n++]=255,r[n++]=255,r[n++]=255,r[n++]=255):(r[n++]=255,r[n++]=255,r[n++]=255,r[n++]=1&o&&1&s?1&i^1&a?0:255:1&o^1&s?0:128)}this._debugPatternTexture=new E.a(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},r);var d=new at;d.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(nt,d,this._debugTextureTechnique),this._quadVAO=Object(D.b)(this._rctx)}}get test(){return{layerRenderers:this._layerRenderers}}};Object(v.a)([Object(U.c)()],wt.prototype,"_shaderTechniqueRepository",void 0),Object(v.a)([Object(U.c)()],wt.prototype,"_stippleTextureRepository",void 0),Object(v.a)([Object(b.b)(),Object(U.c)()],wt.prototype,"waterTextureRepository",void 0),Object(v.a)([Object(b.b)({constructOnly:!0})],wt.prototype,"renderView",void 0),Object(v.a)([Object(b.b)({constructOnly:!0})],wt.prototype,"scheduler",void 0),Object(v.a)([Object(b.b)()],wt.prototype,"globalUnitScale",void 0),Object(v.a)([Object(b.b)({type:Boolean,readOnly:!0})],wt.prototype,"updating",null),wt=Object(v.a)([Object(_.a)("esri.views.3d.terrain.OverlayRenderer")],wt);class jt{constructor(e,t){this.layerView=e,this.renderer=t}}var Rt=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],Ct=new N.a;Ct.near=1,Ct.far=1e4,Ct.relativeElevation=null;var St=Object(o.e)(),Tt=Object(o.e)(),Et=4,Mt=r(200),Dt=(Mt.b,Mt.a);function It(e){var t=[],r=[];!function(e,t,r){for(var{attributeData:{position:a},removeDuplicateStartEnd:i}=e,o=function(e){var t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(a)&&1===i,s=a.length/3-(o?1:0),d=new Uint32Array(2*(s-1)),l=o?Object(n.m)(a,0,a.length-3):a,c=0,h=0;h<s-1;h++)d[c++]=h,d[c++]=h+1;t.push(["position",{size:3,data:l,exclusive:o}]),r.push(["position",d])}(e,r,t);var o=r[0][1].data,d=t[0][1].length,l=new Uint16Array(d);return function(e,t,r){var n=e.attributeData.mapPosition;Object(a.j)(n)||(r.push(["mapPos",r[0][1]]),t.push(["mapPos",{size:3,data:n}]))}(e,r,t),function(e,t,r,n){if(Object(a.k)(e.attributeData.colorFeature))return;var i=e.attributeData.color;t.push(["color",{size:4,data:Object(a.r)(i,Dt)}]),r.push(["color",n])}(e,r,t,l),function(e,t,r,n){if(Object(a.k)(e.attributeData.sizeFeature))return;var i=e.attributeData.size;t.push(["size",{size:1,data:[Object(a.r)(i,1)]}]),r.push(["size",n])}(e,r,t,l),function(e,t,r,n){var i=e.attributeData.colorFeature;Object(a.j)(i)||(t.push(["colorFeatureAttribute",{size:1,data:new Float32Array([i])}]),r.push(["color",n]))}(e,r,t,l),function(e,t,r,n){var i=e.attributeData.sizeFeature;Object(a.j)(i)||(t.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([i])}]),r.push(["sizeFeatureAttribute",n]))}(e,r,t,l),function(e,t,r,n){var i=e.attributeData.opacityFeature;Object(a.j)(i)||(t.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([i])}]),r.push(["opacityFeatureAttribute",n]))}(e,r,t,l),function(e,t,r,n){if("round"!==e.join)return;var o=n.length/3,d=new Float32Array(o),l=Nt,c=zt;Object(s.v)(l,0,0,0);for(var h=Object(a.r)(e.uniformSize,1),u=-1;u<o;++u){var f=u<0?o+u:u,p=(u+1)%o;if(Object(s.v)(c,n[3*p+0]-n[3*f+0],n[3*p+1]-n[3*f+1],n[3*p+2]-n[3*f+2]),Object(s.q)(c,c),u>=0){var g=(Math.PI-Object(i.b)(Object(s.g)(l,c)))*Ft*1*Lt(h);d[u]=Math.max(Math.floor(g),0)}Object(s.d)(l,c,-1)}t.push(["subdivisions",{size:1,data:d}]),r.push(["subdivisions",r[0][1]])}(e,r,t,o),new f.a(r,t,2)}function Pt(e,t,r,n){var a="polygon"===e.type?1:0,i="polygon"===e.type?e.rings:e.paths,{position:o,outlines:s}=c(i,e.hasZ,a),d=new Float64Array(o.length),l=Object(p.b)(o,e.spatialReference,0,d,0,o,0,o.length/3,t,r,n),h=null!=l;return{lines:h?At(s,o,d):[],projectionSuccess:h,sampledElevation:l}}function At(e,t,r){var n=new Array;for(var{index:a,count:i}of e)if(!(i<=1)){var o=3*a,s=o+3*i;n.push({position:t.subarray(o,s),mapPosition:r?r.subarray(o,s):void 0})}return n}function Ht(e,t){for(var r="polygon"===e.type?1:0,n="polygon"===e.type?e.rings:e.paths,{position:a,outlines:i}=c(n,!1,r),o=Object(d.k)(a,e.spatialReference,0,a,t,0,a.length/3),s=2;s<a.length;s+=3)a[s]=-2;return{lines:o?At(i,a):[],projectionSuccess:o}}function Lt(e){return 1.863798+-2.0062872/Math.pow(1+e/18.2313,.8856294)}var Nt=Object(o.e)(),zt=Object(o.e)(),Ft=4/Math.PI},933:function(e,t,r){"use strict";r.d(t,"a",(function(){return f}));var n,a=r(120),i=r(119),o=r(880),s=r(842);function d(e){e.fragment.code.add(Object(i.a)(n||(n=Object(a.a)(["\n    const float GAMMA = 2.2;\n    const float INV_GAMMA = 0.4545454545;\n\n    vec4 delinearizeGamma(vec4 color) {\n      return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);\n    }\n\n    vec3 linearizeGamma(vec3 color) {\n      return pow(color, vec3(GAMMA));\n    }\n  "]))))}var l,c,h,u=r(710);function f(e,t){e.include(u.a,t),e.include(d),e.include(s.a),t.ssrEnabled&&e.include(o.a,t),e.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.775).add("waterSeeColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]),e.fragment.code.add(Object(i.a)(l||(l=Object(a.a)(["\n    PBRShadingWater shadingInfo;\n\n    /*\n    *   This function is an approximation for the sky gradient reflected\n    *   the water surface and describes a combination of two fresnel terms.\n    *   @parameter: cosTheta = is the result of max(dot(n,v), 0.0)\n    *   @parameter: horizon = the dominant color of the sky horizon\n    *   @parameter: cosTheta = the dominant color of the sky zenit\n    */\n    vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {\n      float exponent = pow((1.0 - cosTheta), fresnelSky[2]);\n      return mix(zenit, horizon, exponent);\n    }\n\n    /*\n    *   This function determines the water color per pixel.\n    *   @parameter: n = normal facing away from the surface\n    *   @parameter: v = view direction facing away from the surface.\n    *   @parameter: l = light direction facing away from the surface\n    *   @parameter: lightIntensity = light intensity, currently between 0...PI\n    *   @parameter: localUp = a normal for the general direction of the surface\n    *   @parameter: shadow = the amount of shadow at this pixel (0 = no shadow)\n    */\n    vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {\n\n      float reflectionHit = 0.;\n      vec3 seaWaterColor = linearizeGamma(color);\n      // using half vector to determine the specular light\n      vec3 h = normalize(l + v);\n      shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);\n      shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);\n      shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);\n      shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);\n      shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);\n      shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);\n\n      // angle between vertex normal and view direction\n      float upDotV = max(dot(localUp,v), 0.0);\n      // reflected sky color: the reflected sky color consists of two main colors, the\n      // reflected color at the horizon and the reflected color of the zenit.\n      // the reflected sky color is then an approximation based on the fresnel term.\n      vec3 skyHorizon = linearizeGamma(skyColor);\n      vec3 skyZenit = linearizeGamma(skyZenitColor);\n      vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );\n\n      // we use the upDotL to smoothen out the\n      // reflected color of the water\n      float upDotL = max(dot(localUp,l),0.0);\n\n      // The approximated sky color is adjusted according to the sun position.\n      // This is done as approximation for e.g. night views.\n      float daytimeMod = 0.1 + upDotL * 0.9;\n      skyColor *= daytimeMod;\n\n      // If a water surface is in shadow we just use a slight darkening of the\n      // water surface expressed with this shadowModifier.\n      float shadowModifier = clamp(shadow, 0.8, 1.0);\n\n      // The reflected sky color consists of the fresnel reflection multiplied with the approximated sky color.\n      // The shadow is influencing the frensel term to keep the shadow impression for really near views. As long\n      // as reflection are absent there is a need to have a slight shadow for depth perception.\n      vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);\n      vec3 reflSky = fresnelModifier * skyColor * shadowModifier;\n\n      // The reflected sea color is the input water color combined with the reflected sky color.\n      // The reflected sky color is modified by the incoming light.\n      vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;\n\n      vec3 specular = vec3(0.0);\n      // This prevents the specular light to be rendered when:\n      // - sun is behind a polygon (e.g. sundown for elevated polygons where nDotL might be still ok)\n      // - viewer is under water (for this localUp is better than n)\n      if(upDotV > 0.0 && upDotL > 0.0) {\n        // calculate the cook torrance BRDF but with simplified occlusion\n        vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);\n\n        // Normalize light intensity to be between 0...1. Shadow cancels out specular light here\n        vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;\n\n        specular = shadingInfo.NdotL * incidentLight * specularSun;\n      }\n\n      vec3 foam = vec3(0.0);\n      if(upDotV > 0.0) {\n        foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);\n      }\n      "])))),t.ssrEnabled?e.fragment.code.add(Object(i.a)(c||(c=Object(a.a)(["\n      // Convert the world position to view position\n      vec4 viewPosition = vec4(positionView.xyz, 1.0);\n      vec3 viewDir = normalize(viewPosition.xyz);\n      vec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);\n      vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);\n      vec4 viewUp = ssrViewMat *vec4(localUp, 0.0);\n\n      // at steeper viewing angles we use more of a vertex normal (in this case up) then the wave normal\n      // this removes some artifacts of normal mapping\n      float correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);\n      vec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);\n\n      vec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));\n\n      // perform screen space reflection to detect hit\n      vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);\n      vec3 reflectedColor = vec3(0.0);\n\n      // if there is a hit with ssr find reflected color from the reprojeted frame\n      if (hitCoordinate.z > 0.0)\n      {\n        vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);\n\n        // fade out if there if the hit is near end of Y axis\n        vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));\n        float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);\n        reflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;\n\n        reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;\n      }\n      float seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);\n      // combining reflected sky, reflected sea, specular highlight and SSR reflections.\n      return tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);\n    }\n  "])))):e.fragment.code.add(Object(i.a)(h||(h=Object(a.a)(["\n      // combining reflected sky, reflected sea, specular highlight and SSR reflections.\n      return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);\n    }\n  "]))))}}}]);
//# sourceMappingURL=14.29f26591.chunk.js.map