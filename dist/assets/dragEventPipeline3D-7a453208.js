import{v as hr,e as v,y as dt,a as dr,K as ur,I as p,cE as L,as as _,x as Ke,B as pr,d4 as _r,cc as Dt,c9 as Ce,_ as Je,aB as u,cF as se,aD as M,ap as $e,cg as N,ce as Ne,fY as qe,ef as $,aC as w,jH as Ei,d3 as Ae,aF as B,et as Di,c$ as Te,a1 as jt,fM as Ft,e$ as It,dt as zt,jk as fe,cC as _e,cD as ne,c2 as ie,fc as gr,cd as fr,cf as mr,jI as We,av as ge,cr as ut,ct as Me,cv as ae,cB as Oi,dB as q,d8 as vr,jJ as yr,cS as yt,cH as br,dO as bt,cW as Gt,d6 as Nt,cL as xi,j9 as qt,cQ as be,jK as Wt,jL as Ut,jM as Ht,c as Z,j0 as R,ch as Pr,jN as pt,jO as wr,jP as Sr,cw as Rr,aG as Ue,eh as Er,jQ as Dr,jR as Pt,jd as Bt,ah as Ge,dk as ue,L as Or,de as xr,jS as $r,dF as He,ek as Ar,eS as kt,jT as Yt,jU as Qt,dv as Tr,cp as Lr,aT as Cr,e8 as wt,jV as Mr,cX as T,eU as Vr,cZ as Zt,fn as jr,jW as Fr,jX as Ir,dC as zr,jY as Gr,eM as Nr,d1 as qr,cP as Wr,aE as Ur}from"./index-7753bab1.js";import{r as St,t as Hr}from"./vec4f32-0d1b2306.js";import{a as $i,y as Ai,b as Ti,p as Li,g as Ci}from"./Octree-d70a1310.js";import{l as ee,v as Le,h as Be,m as Br,b as ke,M as kr,B as Yr}from"./lineSegment-94ce77e4.js";import{R as Qr,p as Zr,d as Ot,h as _t,c as S,f as Xr,t as Xt,g as Kr}from"./sphere-89c2d6c4.js";import{ar as Jr,C as xt,at as Ee,Q as Kt,l as Mi,x as Vi,z as oe,h as $t,i as me,N as Ye,W as es,$ as ts,d as is,a as rs,Y as ss,Z as ns,f as Qe,af as as,au as gt,al as os,av as cs,q as ls,F as hs,n as ds,ap as us,ad as ps,ac as _s}from"./NativeLineMaterial-0aac9ae8.js";import{x as ce,G as gs,ae as fs,af as ms,a as x,Z as H,H as Rt,f as re,o as et,C as Jt,b as tt,d as it,t as rt,V as vs,r as y,ag as ys,ah as bs,e as pe,E as ji,ai as Ps,g as C,aj as ws,ak as Ss,c as E,w as Fi,q as Et,a7 as Rs,j as P,a2 as Ii,u as zi,I as Gi,v as Ni,B as Es,F as qi,J as Ds,s as Wi,h as Os,al as ei,k as xs,l as Ui,am as $s,m as As,an as ti,K as Ts,L as Ls,M as Cs,ab as Ms,S as Vs,ao as ii}from"./VertexColor.glsl-a24a5fe4.js";import{o as js}from"./glUtil-7a9be557.js";import{T as Hi}from"./InterleavedLayout-f57c96d2.js";import{n as Fs}from"./DoubleArray-0068ae83.js";import{O as g}from"./VertexAttribute-15d1866a.js";import{e as ve}from"./mat4f64-65d35099.js";import{o as m,W as st,s as At,_ as nt,n as Is,b as W,c as zs,A as Bi,h as ki,a as Yi,E as Qi,f as Gs,d as Ns,g as qs,S as Ws}from"./OrderIndependentTransparency-92d1201d.js";import{R as ye,E as Zi,F as Us,I as ft}from"./enums-64ab819c.js";import{E as Hs}from"./VertexArrayObject-6236f727.js";import{p as Tt,_ as Ze,x as Xe}from"./plane-32e6467c.js";import{r as Bs}from"./SnappingContext-ff99808f.js";import{M as ri,k as ks,f as Ys}from"./hydratedFeatures-e18f5d50.js";import{e as Qs}from"./mat3f64-221ce671.js";import{n as k}from"./basicInterfaces-04e01328.js";import{i as Zs}from"./BufferView-7ae97da4.js";import{s as Xs}from"./Util-d77dfa33.js";import{U as Ks}from"./SnappingDragPipelineStep-4df9c5ad.js";let Js=class{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1,this._renderGroup=Ee.Outline}destroy(){this._destroyResources()}get resources(){return p(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}get renderGroup(){return this._renderGroup}set renderGroup(e){var i;this._renderGroup=e;const t=(i=L(this._resources))==null?void 0:i.layerView;t&&(t.renderGroup=e)}recreate(){this.attached&&this._createResources()}recreateGeometry(){this._resourceFactory.recreateGeometry?_(this._resources)||(this._ensureRenderGeometriesRemoved(),this._resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}_createOrDestroyResources(){this._attached?_(this._resources)&&this._createResources():this._destroyResources()}_createResources(){var r;this._destroyResources();const e=this._resourceFactory.createResources(),t=new te({view:this._resourceFactory.view,renderGroup:this._renderGroup}),i=(r=this._resourceFactory.view.basemapTerrain)==null?void 0:r.overlayManager;this._resources={layerView:new te({view:this._resourceFactory.view,renderGroup:this._renderGroup}),external:e,geometriesAdded:!1},i&&(this._resources.drapeSourceRenderer=i.registerGeometryDrapeSource(t)),this._syncGeometriesToRenderer()}_destroyResources(){var t;if(_(this._resources))return;this._ensureRenderGeometriesRemoved();const e=(t=this._resourceFactory.view.basemapTerrain)==null?void 0:t.overlayManager;e&&e.unregisterDrapeSource(this._resources.layerView),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){_(this._resources)||_(this._resources.drapeSourceRenderer)||this._resources.geometriesAdded&&(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,Kt.UPDATE),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){_(this._resources)||_(this._resources.drapeSourceRenderer)||this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,Kt.UPDATE),this._resources.geometriesAdded=!0)}},te=class extends hr(ur){constructor(e){super(e),this.drapeSourceType=Jr.Features,this.updatePolicy=xt.SYNC,this.renderGroup=Ee.Outline}};v([dt({constructOnly:!0})],te.prototype,"view",void 0),v([dt({readOnly:!0})],te.prototype,"drapeSourceType",void 0),v([dt()],te.prototype,"renderGroup",void 0),te=v([dr("DrapedVisualElementLayerView")],te);let Xi=class{constructor(e){this._attached=!1,this._resourcesCreated=!1,this._visible=!0,this.view=e,this._handle=Ke(()=>this.view.ready,t=>{this._resourcesCreated&&(t?this._createResources():this._destroyResources())})}applyProps(e){let t=!1;for(const i in e)i in this?i==="attached"?t=e[i]:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this.attached=!1,this._handle.remove()}get attached(){return this._attached}set attached(e){e!==this._attached&&this.view._stage&&(this._attached=e,this._attached&&!this._resourcesCreated?this._createResources():!this._attached&&this._resourcesCreated&&this._destroyResources(),this.onAttachedChange(e))}onAttachedChange(e){}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.attached&&this.updateVisibility(e))}_createResources(){this.createResources(),this._resourcesCreated=!0,this.updateVisibility(this.visible)}_destroyResources(){this.destroyResources(),this._resourcesCreated=!1}},Ki=class{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return p(this._resources)?this._resources.object:null}get resources(){return p(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this._resourceFactory.recreateGeometry)return void this.recreate();const e=this._resourceFactory.view._stage;if(_(this._resources)||!e)return;const t=this._resources.object;this._resources.external.forEach(i=>{i.type!==ce.Mesh&&i.type!==ce.Line&&i.type!==ce.Point||e.remove(i)}),t.removeAllGeometries(),this._resourceFactory.recreateGeometry(this._resources.external,t,this._resources.layer),this._resources.external.forEach(i=>{i.type!==ce.Mesh&&i.type!==ce.Line&&i.type!==ce.Point||e.add(i)})}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory,t=e.view,i=t._stage;if(!i)return;const r=new Mi({pickable:!1,updatePolicy:xt.SYNC});i.add(r);const n=new Vi({castShadow:!1}),a=e.createResources(n,r);a.forEach(l=>{i.add(l),l instanceof gs&&i.loadImmediate(l)}),i.add(n),r.add(n);const o=e.cameraChanged,c=o?Ke(()=>t.state.camera,l=>o(l),pr):null;this._resources={layer:r,object:n,external:a,cameraHandle:c},this._syncVisible()}_destroyResources(){var t;if(_(this._resources))return;const e=this._resourceFactory.view._stage;e&&(e.remove(this._resources.object),e.remove(this._resources.layer),this._resources.external.forEach(i=>e.remove(i))),this._resources.object.dispose(),(t=this._resources.cameraHandle)==null||t.remove(),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncVisible(){_(this._resources)||(this._resources.object.visible=this._visible)}};class Lt extends Xi{constructor({view:e,isDraped:t}){super(e),this._isDraped=!1,this.object3dResources=new Ki(this.createObject3DResourceFactory(e)),this.drapedResources=new Js(this.createDrapedResourceFactory(e)),this.isDraped=t??!1}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this.object3dResources.attached=this.attached&&!e,this.drapedResources.attached=this.attached&&e)}get renderGroup(){return this.drapedResources.renderGroup}set renderGroup(e){this.drapedResources.renderGroup=e}createResources(){this.object3dResources.attached=!this._isDraped,this.drapedResources.attached=this._isDraped}destroyResources(){this.object3dResources.attached=!1,this.drapedResources.attached=!1}recreate(){this.object3dResources.recreate(),this.drapedResources.recreate()}recreateGeometry(){this.object3dResources.recreateGeometry(),this.drapedResources.recreateGeometry()}destroy(){this.object3dResources.destroy(),this.drapedResources.destroy(),super.destroy()}updateVisibility(e){this.object3dResources.visible=e,this.drapedResources.visible=e}}function Ji(s,e){s.extensions.add("GL_OES_standard_derivatives");const t=s.fragment;t.include(fs),s.include(ms),t.uniforms.add([new x("globalAlpha",i=>i.globalAlpha),new H("glowColor",i=>i.glowColor),new x("glowWidth",(i,r)=>i.glowWidth*r.camera.pixelRatio),new x("glowFalloff",i=>i.glowFalloff),new H("innerColor",i=>i.innerColor),new x("innerWidth",(i,r)=>i.innerWidth*r.camera.pixelRatio),new Rt("depthMap",(i,r)=>r.linearDepthTexture),new re("nearFar",(i,r)=>r.camera.nearFar),new Rt("frameColor",(i,r)=>r.mainColorTexture)]),t.code.add(m`vec4 blendPremultiplied(vec4 source, vec4 dest) {
float oneMinusSourceAlpha = 1.0 - source.a;
return vec4(
source.rgb + dest.rgb * oneMinusSourceAlpha,
source.a + dest.a * oneMinusSourceAlpha
);
}`),t.code.add(m`vec4 premultipliedColor(vec3 rgb, float alpha) {
return vec4(rgb * alpha, alpha);
}`),t.code.add(m`vec4 laserlineProfile(float dist) {
if (dist > glowWidth) {
return vec4(0.0);
}
float innerAlpha = (1.0 - smoothstep(0.0, innerWidth, dist));
float glowAlpha = pow(max(0.0, 1.0 - dist / glowWidth), glowFalloff);
return blendPremultiplied(
premultipliedColor(innerColor, innerAlpha),
premultipliedColor(glowColor, glowAlpha)
);
}`),t.code.add(m`bool laserlineReconstructFromDepth(out vec3 pos, out vec3 normal, out float depthDiscontinuityAlpha) {
float depth = linearDepthFromTexture(depthMap, uv, nearFar);
if (-depth == nearFar[0]) {
return false;
}
pos = reconstructPosition(gl_FragCoord.xy, depth);
normal = normalize(cross(dFdx(pos), dFdy(pos)));
float ddepth = fwidth(depth);
depthDiscontinuityAlpha = 1.0 - smoothstep(0.0, 0.01, -ddepth / depth);
return true;
}`),e.contrastControlEnabled?(t.uniforms.add(new x("globalAlphaContrastBoost",i=>p(i.globalAlphaContrastBoost)?i.globalAlphaContrastBoost:1)),t.code.add(m`float rgbToLuminance(vec3 color) {
return dot(vec3(0.2126, 0.7152, 0.0722), color);
}
vec4 laserlineOutput(vec4 color) {
float backgroundLuminance = rgbToLuminance(texture2D(frameColor, uv).rgb);
float alpha = clamp(globalAlpha * max(backgroundLuminance * globalAlphaContrastBoost, 1.0), 0.0, 1.0);
return color * alpha;
}`)):t.code.add(m`vec4 laserlineOutput(vec4 color) {
return color * globalAlpha;
}`)}function en(s){const e=new et;e.include(Ji,s);const{vertex:t,fragment:i}=e;return t.uniforms.add([new Jt("modelView",(r,n)=>_r(rn,n.camera.viewMatrix,r.origin)),new Jt("proj",(r,n)=>n.camera.projectionMatrix),new x("glowWidth",(r,n)=>r.glowWidth*n.camera.pixelRatio),new re("pixelToNDC",(r,n)=>Dt(tn,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3]))]),e.attributes.add(g.START,"vec3"),e.attributes.add(g.END,"vec3"),e.attributes.add(g.UP,"vec3"),e.attributes.add(g.EXTRUDE,"vec2"),e.varyings.add("uv","vec2"),e.varyings.add("vViewStart","vec3"),e.varyings.add("vViewEnd","vec3"),e.varyings.add("vViewPlane","vec4"),t.code.add(m`void main() {
vec3 pos = mix(start, end, extrude.x);
vec4 viewPos = modelView * vec4(pos, 1);
vec4 projPos = proj * viewPos;
vec2 ndcPos = projPos.xy / projPos.w;
vec3 viewUp = (modelView * vec4(extrude.y * up, 0)).xyz;
vec4 projPosUp = proj * vec4(viewPos.xyz + viewUp, 1);
vec2 projExtrudeDir = normalize(projPosUp.xy / projPosUp.w - ndcPos);
vec2 lxy = abs(sign(projExtrudeDir) - ndcPos);
ndcPos += length(lxy) * projExtrudeDir;
vec3 worldPlaneNormal = normalize(cross(up, normalize(end - start)));
vec3 viewPlaneNormal = (modelView * vec4(worldPlaneNormal, 0)).xyz;
vViewStart = (modelView * vec4(start, 1)).xyz;
vViewEnd = (modelView * vec4(end, 1)).xyz;
vViewPlane = vec4(viewPlaneNormal, -dot(viewPlaneNormal, vViewStart));
float xPaddingPixels = sign(dot(viewPlaneNormal, viewPos.xyz)) * (extrude.x * 2.0 - 1.0) * glowWidth;
ndcPos.x += xPaddingPixels * pixelToNDC.x;
uv = ndcPos * 0.5 + 0.5;
gl_Position = vec4(ndcPos, 0, 1);
}`),i.uniforms.add(new x("perScreenPixelRatio",(r,n)=>n.camera.perScreenPixelRatio)),i.code.add(m`float planeDistancePixels(vec4 plane, vec3 pos, vec3 start, vec3 end) {
vec3 origin = mix(start, end, 0.5);
vec3 basis = end - origin;
vec3 posAtOrigin = pos - origin;
float x = dot(normalize(basis), posAtOrigin);
float y = dot(plane.xyz, posAtOrigin);
float dx = max(abs(x) - length(basis), 0.0);
float dy = y;
float dist = length(vec2(dx, dy));
float width = fwidth(y);
float maxPixelDistance = length(pos) * perScreenPixelRatio * 2.0;
float pixelDist = dist / min(width, maxPixelDistance);
return abs(pixelDist);
}
void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
float distance = planeDistancePixels(vViewPlane, pos, vViewStart, vViewEnd);
vec4 color = laserlineProfile(distance);
float alpha = 1.0 - smoothstep(0.995, 0.999, abs(dot(normal, vViewPlane.xyz)));
gl_FragColor = laserlineOutput(color * alpha * depthDiscontinuityAlpha);
}`),e}const tn=Ce(),rn=ve(),sn=Object.freeze(Object.defineProperty({__proto__:null,build:en},Symbol.toStringTag,{value:"Module"}));let er=class tr extends tt{initializeProgram(e){return new it(e.rctx,tr.shader.get().build(this.configuration),ir)}initializePipeline(){return st({blending:At(ye.ONE,ye.ONE_MINUS_SRC_ALPHA),colorWrite:nt})}};er.shader=new rt(sn,()=>Je(()=>import("./LaserlinePath.glsl-a14ababa.js"),["assets/LaserlinePath.glsl-a14ababa.js","assets/index-7753bab1.js","assets/index-0be7f32f.css","assets/mat4f64-65d35099.js","assets/OrderIndependentTransparency-92d1201d.js","assets/enums-64ab819c.js","assets/basicInterfaces-04e01328.js","assets/VertexColor.glsl-a24a5fe4.js","assets/requestImageUtils-dc72d397.js","assets/Texture-280a81f5.js","assets/VertexArrayObject-6236f727.js","assets/Util-d77dfa33.js","assets/triangle-86ddbd84.js","assets/sphere-89c2d6c4.js","assets/mat3f64-221ce671.js","assets/quatf64-3363c48e.js","assets/lineSegment-94ce77e4.js","assets/Indices-4fd742c7.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/quat-1a9efe59.js","assets/vec3f32-ad1dc57f.js","assets/BufferView-7ae97da4.js","assets/VertexElementDescriptor-2925c6af.js","assets/vec4f32-0d1b2306.js","assets/Octree-d70a1310.js","assets/plane-32e6467c.js","assets/NativeLineMaterial-0aac9ae8.js","assets/interfaces-736d93d7.js","assets/NestedMap-1b5db22e.js","assets/InterleavedLayout-f57c96d2.js","assets/types-e1c0a5bf.js","assets/boundedPlane-2b6cf7c1.js","assets/glUtil-7a9be557.js","assets/DoubleArray-0068ae83.js","assets/hydratedFeatures-e18f5d50.js","assets/floatRGBA-bba05acf.js","assets/SnappingContext-ff99808f.js","assets/PointSnappingHint-9fd6408b.js","assets/SnappingDragPipelineStep-4df9c5ad.js","assets/drawUtils-394a2d10.js"]));const ir=new Map([[g.START,0],[g.END,1],[g.UP,2],[g.EXTRUDE,3]]);let si=class{constructor(e){this._renderCoordsHelper=e,this._buffers=null,this._origin=u(),this._dirty=!1,this._count=0,this._vao=null}set vertices(e){const t=Fs(3*e.length);let i=0;for(const r of e)t[i++]=r[0],t[i++]=r[1],t[i++]=r[2];this.buffers=[t]}set buffers(e){if(this._buffers=e,this._buffers.length>0){const t=this._buffers[0],i=3*Math.floor(t.length/3/2);se(this._origin,t[i+0],t[i+1],t[i+2])}else se(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(e){const t=this._ensureVAO(e);p(t)&&(e.bindVAO(t),e.drawArrays(Zi.TRIANGLES,0,this._count))}dispose(){p(this._vao)&&this._vao.dispose()}_ensureVAO(e){return _(this._buffers)?null:(_(this._vao)&&(this._vao=this._createVAO(e,this._buffers)),this._ensureVertexData(this._vao,this._buffers),this._vao)}_createVAO(e,t){const i=this._createDataBuffer(t);return this._dirty=!1,new vs(e,ir,{data:js(ai)},{data:Hs.createVertex(e,Us.STATIC_DRAW,i)})}_ensureVertexData(e,t){var r;if(!this._dirty)return;const i=this._createDataBuffer(t);(r=e.vertexBuffers.data)==null||r.setData(i),this._dirty=!1}_numberOfRenderVertices(e){return 3*(2*(e.length/3-1))}_createDataBuffer(e){const t=e.reduce((o,c)=>o+this._numberOfRenderVertices(c),0);this._count=t;const i=ai.createBuffer(t),r=this._origin;let n=0,a=0;for(const o of e){for(let c=0;c<o.length;c+=3){const l=se(ni,o[c+0],o[c+1],o[c+2]);c===0?a=this._renderCoordsHelper.getAltitude(l):this._renderCoordsHelper.setAltitude(l,a);const d=this._renderCoordsHelper.worldUpAtPosition(l,nn),h=n+2*c,f=M(ni,l,r);if(c<o.length-3){i.up.setVec(h,d),i.up.setVec(h+3,d),i.up.setVec(h+5,d);for(let b=0;b<6;b++)i.start.setVec(h+b,f);i.extrude.setValues(h+0,0,-1),i.extrude.setValues(h+1,1,-1),i.extrude.setValues(h+2,1,1),i.extrude.setValues(h+3,0,-1),i.extrude.setValues(h+4,1,1),i.extrude.setValues(h+5,0,1)}if(c>0){i.up.setVec(h-2,d),i.up.setVec(h-4,d),i.up.setVec(h-5,d);for(let b=-6;b<0;b++)i.end.setVec(h+b,f)}}n+=this._numberOfRenderVertices(o)}return i.buffer}};const nn=u(),ni=u(),ai=Hi().vec3f(g.START).vec3f(g.END).vec3f(g.UP).vec2f(g.EXTRUDE);let Ct=class extends ys{constructor(){super(...arguments),this.contrastControlEnabled=!1}};v([y()],Ct.prototype,"contrastControlEnabled",void 0);const rr=$e(6);function an(s){const e=new et;e.extensions.add("GL_OES_standard_derivatives"),e.include(bs),e.include(Ji,s);const t=e.fragment;if(s.lineVerticalPlaneEnabled||s.heightManifoldEnabled)if(t.uniforms.add(new x("maxPixelDistance",(i,r)=>s.heightManifoldEnabled?2*r.camera.computeScreenPixelSizeAt(i.heightManifoldTarget):2*r.camera.computeScreenPixelSizeAt(i.lineVerticalPlaneSegment.origin))),t.code.add(m`float planeDistancePixels(vec4 plane, vec3 pos) {
float dist = dot(plane.xyz, pos) + plane.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),s.spherical){const i=(n,a,o)=>$(n,a.heightManifoldTarget,o.camera.viewMatrix),r=(n,a)=>$(n,[0,0,0],a.camera.viewMatrix);t.uniforms.add([new pe("heightManifoldOrigin",(n,a)=>(i(G,n,a),r(he,a),M(he,he,G),N(A,he),A[3]=Ne(he),A)),new H("globalOrigin",(n,a)=>r(G,a)),new x("cosSphericalAngleThreshold",(n,a)=>1-Math.max(2,qe(a.camera.eye,n.heightManifoldTarget)*a.camera.perRenderPixelRatio)/Ne(n.heightManifoldTarget))]),t.code.add(m`float globeDistancePixels(float posInGlobalOriginLength) {
float dist = abs(posInGlobalOriginLength - heightManifoldOrigin.w);
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}
float heightManifoldDistancePixels(vec4 heightPlane, vec3 pos) {
vec3 posInGlobalOriginNorm = normalize(globalOrigin - pos);
float cosAngle = dot(posInGlobalOriginNorm, heightManifoldOrigin.xyz);
vec3 posInGlobalOrigin = globalOrigin - pos;
float posInGlobalOriginLength = length(posInGlobalOrigin);
float sphericalDistance = globeDistancePixels(posInGlobalOriginLength);
float planarDistance = planeDistancePixels(heightPlane, pos);
return cosAngle < cosSphericalAngleThreshold ? sphericalDistance : planarDistance;
}`)}else t.code.add(m`float heightManifoldDistancePixels(vec4 heightPlane, vec3 pos) {
return planeDistancePixels(heightPlane, pos);
}`);if(s.pointDistanceEnabled&&(t.uniforms.add(new x("maxPixelDistance",(i,r)=>2*r.camera.computeScreenPixelSizeAt(i.pointDistanceTarget))),t.code.add(m`float sphereDistancePixels(vec4 sphere, vec3 pos) {
float dist = distance(sphere.xyz, pos) - sphere.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`)),s.intersectsLineEnabled&&(t.uniforms.add(new x("perScreenPixelRatio",(i,r)=>r.camera.perScreenPixelRatio)),t.code.add(m`float lineDistancePixels(vec3 start, vec3 dir, float radius, vec3 pos) {
float dist = length(cross(dir, pos - start)) / (length(pos) * perScreenPixelRatio);
return abs(dist) - radius;
}`)),(s.lineVerticalPlaneEnabled||s.intersectsLineEnabled)&&t.code.add(m`bool pointIsWithinLine(vec3 pos, vec3 start, vec3 end) {
vec3 dir = end - start;
float t2 = dot(dir, pos - start);
float l2 = dot(dir, dir);
return t2 >= 0.0 && t2 <= l2;
}`),t.code.add(m`void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
vec4 color = vec4(0, 0, 0, 0);`),s.heightManifoldEnabled){t.uniforms.add([new re("angleCutoff",r=>Ve(r)),new pe("heightPlane",(r,n)=>sr(r.heightManifoldTarget,r.renderCoordsHelper.worldUpAtPosition(r.heightManifoldTarget,G),n.camera.viewMatrix))]);const i=s.spherical?m`normalize(globalOrigin - pos)`:m`heightPlane.xyz`;t.code.add(m`
    {
      float heightManifoldAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, ${i})));
      vec4 heightManifoldColor = laserlineProfile(heightManifoldDistancePixels(heightPlane, pos));
      color = max(color, heightManifoldColor * heightManifoldAlpha);
    }
    `)}return s.pointDistanceEnabled&&(t.uniforms.add([new re("angleCutoff",i=>Ve(i)),new pe("pointDistanceSphere",(i,r)=>on(i,r))]),t.code.add(m`{
float pointDistanceSphereDistance = sphereDistancePixels(pointDistanceSphere, pos);
vec4 pointDistanceSphereColor = laserlineProfile(pointDistanceSphereDistance);
float pointDistanceSphereAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, normalize(pos - pointDistanceSphere.xyz))));
color = max(color, pointDistanceSphereColor * pointDistanceSphereAlpha);
}`)),s.lineVerticalPlaneEnabled&&(t.uniforms.add([new re("angleCutoff",i=>Ve(i)),new pe("lineVerticalPlane",(i,r)=>cn(i,r)),new H("lineVerticalStart",(i,r)=>ln(i,r)),new H("lineVerticalEnd",(i,r)=>hn(i,r))]),t.code.add(m`{
if (pointIsWithinLine(pos, lineVerticalStart, lineVerticalEnd)) {
float lineVerticalDistance = planeDistancePixels(lineVerticalPlane, pos);
vec4 lineVerticalColor = laserlineProfile(lineVerticalDistance);
float lineVerticalAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, lineVerticalPlane.xyz)));
color = max(color, lineVerticalColor * lineVerticalAlpha);
}
}`)),s.intersectsLineEnabled&&(t.uniforms.add([new re("angleCutoff",i=>Ve(i)),new H("intersectsLineStart",(i,r)=>$(G,i.lineStartWorld,r.camera.viewMatrix)),new H("intersectsLineEnd",(i,r)=>$(G,i.lineEndWorld,r.camera.viewMatrix)),new H("intersectsLineDirection",(i,r)=>(w(A,i.intersectsLineSegment.vector),A[3]=0,N(G,Ei(A,A,r.camera.viewMatrix)))),new x("intersectsLineRadius",i=>i.intersectsLineRadius)]),t.code.add(m`{
if (pointIsWithinLine(pos, intersectsLineStart, intersectsLineEnd)) {
float intersectsLineDistance = lineDistancePixels(intersectsLineStart, intersectsLineDirection, intersectsLineRadius, pos);
vec4 intersectsLineColor = laserlineProfile(intersectsLineDistance);
float intersectsLineAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, 1.0 - abs(dot(normal, intersectsLineDirection)));
color = max(color, intersectsLineColor * intersectsLineAlpha);
}
}`)),t.code.add(m`gl_FragColor = laserlineOutput(color * depthDiscontinuityAlpha);
}`),e}function Ve(s){return Dt(dn,Math.cos(s.angleCutoff),Math.cos(Math.max(0,s.angleCutoff-$e(2))))}function on(s,e){return $(mt,s.pointDistanceOrigin,e.camera.viewMatrix),mt[3]=qe(s.pointDistanceOrigin,s.pointDistanceTarget),mt}function cn(s,e){const t=ee(s.lineVerticalPlaneSegment,.5,G),i=s.renderCoordsHelper.worldUpAtPosition(t,un),r=N(he,s.lineVerticalPlaneSegment.vector),n=Ae(A,i,r);return N(n,n),sr(s.lineVerticalPlaneSegment.origin,n,e.camera.viewMatrix)}function ln(s,e){const t=w(G,s.lineVerticalPlaneSegment.origin);return s.renderCoordsHelper.setAltitude(t,0),$(t,t,e.camera.viewMatrix)}function hn(s,e){const t=B(G,s.lineVerticalPlaneSegment.origin,s.lineVerticalPlaneSegment.vector);return s.renderCoordsHelper.setAltitude(t,0),$(t,t,e.camera.viewMatrix)}function sr(s,e,t){return $(oi,s,t),w(A,e),A[3]=0,Ei(A,A,t),Ze(oi,A,pn)}const dn=Ce(),G=u(),A=Di(),un=u(),he=u(),oi=u(),pn=Tt(),mt=Qr(),_n=Object.freeze(Object.defineProperty({__proto__:null,build:an,defaultAngleCutoff:rr},Symbol.toStringTag,{value:"Module"}));let gn=class extends Is{constructor(){super(...arguments),this.innerColor=Te(1,1,1),this.innerWidth=1,this.glowColor=Te(1,.5,0),this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.75,this.globalAlphaContrastBoost=2,this.angleCutoff=$e(6),this.pointDistanceOrigin=u(),this.pointDistanceTarget=u(),this.lineVerticalPlaneSegment=Le(),this.intersectsLineSegment=Le(),this.intersectsLineRadius=3,this.heightManifoldTarget=u(),this.lineStartWorld=u(),this.lineEndWorld=u()}},nr=class ar extends tt{initializeProgram(e){return new it(e.rctx,ar.shader.get().build(this.configuration),ji)}initializePipeline(){return st({blending:At(ye.ONE,ye.ONE_MINUS_SRC_ALPHA),colorWrite:nt})}};nr.shader=new rt(_n,()=>Je(()=>import("./Laserlines.glsl-f1d083e9.js"),["assets/Laserlines.glsl-f1d083e9.js","assets/index-7753bab1.js","assets/index-0be7f32f.css","assets/lineSegment-94ce77e4.js","assets/sphere-89c2d6c4.js","assets/mat3f64-221ce671.js","assets/mat4f64-65d35099.js","assets/quatf64-3363c48e.js","assets/plane-32e6467c.js","assets/OrderIndependentTransparency-92d1201d.js","assets/enums-64ab819c.js","assets/basicInterfaces-04e01328.js","assets/VertexColor.glsl-a24a5fe4.js","assets/requestImageUtils-dc72d397.js","assets/Texture-280a81f5.js","assets/VertexArrayObject-6236f727.js","assets/Util-d77dfa33.js","assets/triangle-86ddbd84.js","assets/Indices-4fd742c7.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/quat-1a9efe59.js","assets/vec3f32-ad1dc57f.js","assets/BufferView-7ae97da4.js","assets/VertexElementDescriptor-2925c6af.js","assets/vec4f32-0d1b2306.js","assets/Octree-d70a1310.js","assets/NativeLineMaterial-0aac9ae8.js","assets/interfaces-736d93d7.js","assets/NestedMap-1b5db22e.js","assets/InterleavedLayout-f57c96d2.js","assets/types-e1c0a5bf.js","assets/boundedPlane-2b6cf7c1.js","assets/glUtil-7a9be557.js","assets/DoubleArray-0068ae83.js","assets/hydratedFeatures-e18f5d50.js","assets/floatRGBA-bba05acf.js","assets/SnappingContext-ff99808f.js","assets/PointSnappingHint-9fd6408b.js","assets/SnappingDragPipelineStep-4df9c5ad.js","assets/drawUtils-394a2d10.js"]));class de extends Ct{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1,this.spherical=!1}}v([y()],de.prototype,"heightManifoldEnabled",void 0),v([y()],de.prototype,"pointDistanceEnabled",void 0),v([y()],de.prototype,"lineVerticalPlaneEnabled",void 0),v([y()],de.prototype,"intersectsLineEnabled",void 0),v([y()],de.prototype,"spherical",void 0);let fn=class{constructor(e,t={contrastControlEnabled:!1}){this._config=t,this._technique=null,this._heightManifoldEnabled=!1,this._pointDistanceEnabled=!1,this._lineVerticalPlaneEnabled=!1,this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._viewingMode=jt.Local,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._passParameters=Ps(e,new gn)}get renderSlots(){return[this._config.contrastControlEnabled?C.LASERLINES_CONTRAST_CONTROL:C.LASERLINES]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(e){this._heightManifoldEnabled!==e&&(this._heightManifoldEnabled=e,this._requestRender())}get heightManifoldTarget(){return this._passParameters.heightManifoldTarget}set heightManifoldTarget(e){w(this._passParameters.heightManifoldTarget,e),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(e){e!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=e,this._requestRender())}get pointDistanceTarget(){return this._passParameters.pointDistanceTarget}set pointDistanceTarget(e){w(this._passParameters.pointDistanceTarget,e),this._requestRender()}get pointDistanceOrigin(){return this._passParameters.pointDistanceOrigin}set pointDistanceOrigin(e){w(this._passParameters.pointDistanceOrigin,e),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(e){e!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=e,this._requestRender())}get lineVerticalPlaneSegment(){return this._passParameters.lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){Be(e,this._passParameters.lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(e){e!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=e,this._requestRender())}get intersectsLineSegment(){return this._passParameters.intersectsLineSegment}set intersectsLineSegment(e){Be(e,this._passParameters.intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._passParameters.intersectsLineRadius}set intersectsLineRadius(e){e!==this._passParameters.intersectsLineRadius&&(this._passParameters.intersectsLineRadius=e,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){e!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=e,this._requestRender())}get viewingMode(){return this._viewingMode}set viewingMode(e){e!==this._viewingMode&&(this._viewingMode=e,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(e){e!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=e,p(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(e){_(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new si(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.vertices=e,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(e){_(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new si(this._passParameters.renderCoordsHelper)),this._pathVerticalPlaneData.buffers=e,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameters(e){ws(this._passParameters,e)&&this._requestRender()}initializeRenderContext(e){this._context=e;const t=e.renderContext.rctx;this._quadVAO=Ss(t),this._techniqueRepository=e.techniqueRepository,this._techniqueConfig=new de;const i=new Ct;i.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(er,i)}uninitializeRenderContext(){this._quadVAO=Ft(this._quadVAO),this._technique=It(this._technique),this._pathVerticalPlaneData=Ft(this._pathVerticalPlaneData),this._pathTechnique=It(this._pathTechnique)}prepareTechnique(){return this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled?(this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._techniqueConfig.spherical=this._viewingMode===jt.Global,this._technique=this._techniqueRepository.releaseAndAcquire(nr,this._techniqueConfig,this._technique),this._technique):this._pathTechnique}render(e,t){(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(e,t),this.pathVerticalPlaneEnabled&&this._renderPath(e)}_renderUnified(e,t){const i=e.rctx;this._updatePassParameters(e),i.bindTechnique(t,this._passParameters,e.bindParameters),i.bindVAO(this._quadVAO),i.drawArrays(Zi.TRIANGLE_STRIP,0,4)}_renderPath(e){if(_(this._pathVerticalPlaneData)||_(this._pathTechnique))return;const t=e.rctx,i=this._pathTechnique;t.bindTechnique(i,{...this._passParameters,origin:this._pathVerticalPlaneData.origin},e.bindParameters),this._pathVerticalPlaneData.draw(e.rctx)}_updatePassParameters(e){if(!this._intersectsLineEnabled)return;const t=e.bindParameters.camera;if(this._intersectsLineInfinite){if(Ai(Zr(this._passParameters.intersectsLineSegment.origin,this._passParameters.intersectsLineSegment.vector),Pe),Pe.c0=-Number.MAX_VALUE,!Ti(t.frustum,Pe))return;Li(Pe,this._passParameters.lineStartWorld),Ci(Pe,this._passParameters.lineEndWorld)}else w(this._passParameters.lineStartWorld,this._passParameters.intersectsLineSegment.origin),B(this._passParameters.lineEndWorld,this._passParameters.intersectsLineSegment.origin,this._passParameters.intersectsLineSegment.vector)}_requestRender(){this._context&&this._context.requestRender()}};const Pe=$i();class mn extends Xi{constructor(e){super(e.view),this._angleCutoff=rr,this._style={},this._heightManifoldTarget=u(),this._heightManifoldEnabled=!1,this._intersectsLine=Le(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProps(e)}get testData(){return this._renderer}createResources(){this._ensureRenderer()}destroyResources(){this._disposeRenderer()}updateVisibility(){this._syncRenderer(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(e){this._angleCutoff!==e&&(this._angleCutoff=e,this._syncAngleCutoff())}get style(){return this._style}set style(e){this._style=e,this._syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(e){p(e)?(w(this._heightManifoldTarget,e),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this._syncRenderer(),this._syncHeightManifold()}set intersectsWorldUpAtLocation(e){if(_(e))return void(this.intersectsLine=null);const t=this.view.renderCoordsHelper.worldUpAtPosition(e,vn);this.intersectsLine=Br(e,t),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(e){p(e)?(Be(e,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this._syncIntersectsLine(),this._syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(e){this._intersectsLineInfinite=e,this._syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(e){this._lineVerticalPlaneSegment=p(e)?Be(e):null,this._syncLineVerticalPlane(),this._syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(e){this._pathVerticalPlaneBuffers=e,this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(e){this._pointDistanceLine=p(e)?{origin:zt(e.origin),target:e.target?zt(e.target):null}:null,this._syncPointDistance(),this._syncRenderer()}_syncRenderer(){this.attached&&this.visible&&(this._intersectsLineEnabled||this._heightManifoldEnabled||p(this._pointDistanceLine)||p(this._pathVerticalPlaneBuffers))?this._ensureRenderer():this._disposeRenderer()}_ensureRenderer(){p(this._renderer)||(this._renderer=new fn({renderCoordsHelper:this.view.renderCoordsHelper},{contrastControlEnabled:!0}),this._renderer.viewingMode=this.view.state.viewingMode,this._syncStyle(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncIntersectsLineInfinite(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this._renderer.renderSlots,this._renderer))}_syncStyle(){_(this._renderer)||(this._renderer.setParameters(this._style),this._style.intersectsLineRadius!=null&&(this._renderer.intersectsLineRadius=this._style.intersectsLineRadius))}_syncAngleCutoff(){_(this._renderer)||this._renderer.setParameters({angleCutoff:this._angleCutoff})}_syncHeightManifold(){_(this._renderer)||(this._renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this._renderer.heightManifoldTarget=this._heightManifoldTarget))}_syncIntersectsLine(){_(this._renderer)||(this._renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this._renderer.intersectsLineSegment=this._intersectsLine))}_syncIntersectsLineInfinite(){_(this._renderer)||(this._renderer.intersectsLineInfinite=this._intersectsLineInfinite)}_syncPathVerticalPlane(){_(this._renderer)||(this._renderer.pathVerticalPlaneEnabled=p(this._pathVerticalPlaneBuffers)&&this.visible,p(this._pathVerticalPlaneBuffers)&&(this._renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}_syncLineVerticalPlane(){_(this._renderer)||(this._renderer.lineVerticalPlaneEnabled=p(this._lineVerticalPlaneSegment)&&this.visible,p(this._lineVerticalPlaneSegment)&&(this._renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}_syncPointDistance(){if(_(this._renderer))return;const e=this._pointDistanceLine,t=p(e);this._renderer.pointDistanceEnabled=t&&e.target!=null&&this.visible,t&&(this._renderer.pointDistanceOrigin=e.origin,e.target!=null&&(this._renderer.pointDistanceTarget=e.target))}_disposeRenderer(){p(this._renderer)&&this.view._stage&&(this.view._stage.removeRenderPlugin(this._renderer),this._renderer=null)}}const vn=u();let yn=class extends Lt{constructor(e){super(e),this._ray=Ot(),this._isWorldDown=!1,this._start=u(),this._end=Te(1,0,0),this._width=1,this._color=St(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=St(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=F.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=E.OccludeAndTransparent,this._fadedExtensions=hi,this._laserline=new mn({view:this.view}),this.applyProps(e)}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyExternalResources(t),recreateGeometry:(t,i)=>this._recreateObject3DGeometry(t,i),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyExternalResources(t),recreateGeometry:t=>this._recreateDrapedGeometry(t)}}updateVisibility(e){super.updateVisibility(e),this._laserline.visible=e}onAttachedChange(){this._laserline.attached=this._laserlineAttached}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,w(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),M(this._end,e,this._end),_t(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,fe(this._start,e)||(w(this._start,e),_t(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,fe(this._end,e)||(w(this._end,e),_t(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){_e(e,this._color)||(ne(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){_e(e,this._innerColor)||(ne(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=p(e)!==p(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(_(e)||_(this._stippleOffColor)||!_e(e,this._stippleOffColor))&&(this._stippleOffColor=p(e)?Hr(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&p(this._laserlineStyle)&&this.attached&&!this.isDraped}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,p(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===E.OccludeAndTransparentStencil?E.OccludeAndTransparent:this._renderOccluded}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=ie(e,hi),this.recreateGeometry()}_updateMaterial(){var t,i;const{materialParameters:e}=this;(t=L(this.object3dResources.resources))==null||t.material.setParameters(e),(i=L(this.drapedResources.resources))==null||i.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,writeDepth:this._writeDepthEnabled}}_createObject3DResources(e){const t=new oe(this.materialParameters),i=new Array;return this._createObject3DGeometry(t,e,i),{material:t,geometries:i,forEach:r=>{r(t),i.forEach(r)}}}_destroyExternalResources(e){e.geometries=[],e.material.dispose()}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,i){const r=this._createGeometry(e);i.push(r),t.addGeometry(r),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new oe(this.materialParameters);return{material:e,geometries:[this._createDrapedGeometry(e)]}}_recreateDrapedGeometry(e){e.geometries=[this._createDrapedGeometry(e.material)]}_createDrapedGeometry(e){const t=this._createGeometry(e);this._updateVerticesDraped(t);const i=new $t(t,{boundingInfo:t.boundingInfo});return i.computeBoundingSphere(i.transformation,i.boundingSphere),i}_createGeometry(e){const t=this.extensionType===F.FADED,i=t?[u(),u(),u(),u()]:[u(),u()];return me(e,i,null,t?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null)}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=L(this.object3dResources.object);e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this._lineSegment;this._updateVertexAttributesObject3D(e,t),this._laserline.intersectsLine=t}_updateVerticesDraped(e){this._updateVertexAttributesDraped(e,this._lineSegment)}get _lineSegment(){return this._extensionType===F.FADED?this._updateLineSegmentFinite(ci):this._updateLineSegmentInfinite(this._extensionType,ci)}_updateLineSegmentFinite(e){return ke(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const i=this.view.state.camera;switch(Ai(this._ray,Y),e){case F.LINE:Y.c0=-Number.MAX_VALUE;break;case F.RAY:case F.GROUND_RAY:{const a=this._ray.origin,o=ie(this.view.elevationProvider.getElevation(a[0],a[1],a[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),c=this.view.renderCoordsHelper.getAltitude(a);this._isWorldDown&&c<o&&gr(Y.ray.direction,Y.ray.direction),this._extensionType===F.GROUND_RAY&&o!=null&&(Y.c1=Math.abs(c-o));break}}if(!Ti(i.frustum,Y))return this._updateLineSegmentFinite(t);const r=Li(Y,X),n=Ci(Y,bn);return ke(r,n,t)}_updateVertexAttributesObject3D(e,t){var n;const i=(n=e.geometries[0].getMutableAttribute(g.POSITION))==null?void 0:n.data;if(!i)return;let r=0;for(const a of this._lineVertices(t))i[r++]=a[0],i[r++]=a[1],i[r++]=a[2];e.geometryVertexAttrsUpdated(e.geometries[0])}_updateVertexAttributesDraped(e,t){var n;const i=(n=e.getMutableAttribute(g.POSITION))==null?void 0:n.data;if(!i)return;let r=0;for(const a of this._lineVertices(t))i[r++]=a[0],i[r++]=a[1],i[r++]=Ye;e.invalidateBoundingInfo()}*_lineVertices(e){this.extensionType===F.FADED?(yield ee(e,-this.fadedExtensions.start,X),yield ee(e,0,X),yield ee(e,1,X),yield ee(e,1+this.fadedExtensions.end,X)):(yield ee(e,0,X),yield ee(e,1,X))}};const Y=$i(),X=u(),bn=u(),ci=Le();var F;(function(s){s[s.LINE=0]="LINE",s[s.RAY=1]="RAY",s[s.GROUND_RAY=2]="GROUND_RAY",s[s.FADED=3]="FADED"})(F||(F={}));const li=1/3,hi={start:li,end:li};let Pn=class extends Lt{constructor(e){super(e),this._location=u(),this._direction=Te(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=St(1,0,1,1),this._renderOccluded=E.OccludeAndTransparent,this.applyProps(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyObject3DResources(t),recreateGeometry:(t,i)=>this._recreateObject3DGeometry(t,i),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyDrapedResources(t),recreateGeometry:t=>this._recreateDrapedGeometry(t)}}get location(){return this._location}set location(e){fe(this._location,e)||(w(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){fe(this._direction,e)||(w(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){N(this._direction,M(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){_e(e,this._color)||(ne(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const t=new oe(this.materialParameters),i=new Array;return this._createObject3DGeometry(t,e,i),{material:t,geometries:i,forEach:r=>{r(t),i.forEach(r)}}}_destroyObject3DResources(e){e.geometries.length=0,e.material.dispose()}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,i){const[r,n]=this._createGeometries(e);t.addGeometry(r),t.addGeometry(n),i.push(r),i.push(n),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new oe(this.materialParameters),t=Ke(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_destroyDrapedResources(e){e.pixelRatioHandle.remove(),e.geometries=[],e.material.dispose()}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=this._createGeometries(e);this._updateVerticesDraped(t);const i=t.map(r=>new $t(r,{boundingInfo:r.boundingInfo}));for(const r of i)r.computeBoundingSphere(r.transformation,r.boundingSphere);return i}_createGeometries(e){return[me(e,[u(),u()]),me(e,[u(),u()])]}_updateMaterial(){var t,i;const{materialParameters:e}=this;(t=L(this.object3dResources.resources))==null||t.material.setParameters(e),(i=L(this.drapedResources.resources))==null||i.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=L(this.object3dResources.object);e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,Fe),B(z,this.location,this.direction),t.projectToScreen(z,le),fr(le,mr(le,le,Fe)),this._updateVertexAttributesObject3D(t,e,0,Fe,le,1),this._updateVertexAttributesObject3D(t,e,1,Fe,le,-1)}_updateVertexAttributesObject3D(e,t,i,r,n,a){var h;const o=t.geometries[i],c=(h=o.getMutableAttribute(g.POSITION))==null?void 0:h.data;if(!c)return;const{start:l,end:d}=this._computeStartEnd(n,r,a,this.offset,this.width,this.length);e.unprojectFromScreen(We(l),z),c[0]=z[0],c[1]=z[1],c[2]=z[2],e.unprojectFromScreen(We(d),z),c[3]=z[0],c[4]=z[1],c[5]=z[2],t.geometryVertexAttrsUpdated(o)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:i}}}=this,{location:r,width:n,length:a,offset:o}=this,c=wn;c.spatialReference=ge(t.renderer.spatialReference),c.x=r[0],c.y=r[1];const l=t.overlayPixelSizeInMapUnits(c)*i,d=n*l,h=a*l,f=o*l;this._updateVertexAttributesDraped(e[0],d,h,f,-1),this._updateVertexAttributesDraped(e[1],d,h,f,1)}_updateVertexAttributesDraped(e,t,i,r,n){var h;const a=(h=e.getMutableAttribute(g.POSITION))==null?void 0:h.data;if(!a)return;const{location:o,direction:c}=this,{start:l,end:d}=this._computeStartEnd(c,o,n,r,t,i);a[0]=l[0],a[1]=l[1],a[2]=Ye,a[3]=d[0],a[4]=d[1],a[5]=Ye,e.invalidateBoundingInfo()}_computeStartEnd(e,t,i,r,n,a){const o=ut(di,Dt(di,e[1]*i,e[0]*-i),r+n/2),c=Me(je,Me(je,Me(je,t,ut(je,e,a/2)),o),o);return{start:c,end:Me(ui,c,ut(ui,e,-a))}}};const z=u(),di=Ce(),je=Ce(),ui=Ce(),Fe=ae(),le=ae(),wn=Oi(0,0,void 0,null);let pi=class{constructor(e){this.view=null,this._geometry=null,this._size=3,this._color=q(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=q(1,1,1,1),this._elevationInfo=null,this._resources=new Ki({view:e.view,createResources:i=>this._createResources(i),destroyResources:i=>this._destroyResources(i),recreateGeometry:(i,r)=>{i.geometry=this._recreateGeometry(r,i.material)}});let t=!0;for(const i in e)i in this?i==="attached"?t=e[i]??!1:this[i]=e[i]:console.error("Cannot set unknown property",i);this.attached=t}destroy(){this._resources.destroy()}get visible(){return this._resources.visible}set visible(e){this._resources.visible=e}get attached(){return this._resources.attached}set attached(e){this._resources.attached=e}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this._resources.recreateGeometry()}get size(){return this._size}set size(e){if(e!==this._size){const t=this._preferredTextureSize;this._size=e,t<this._preferredTextureSize?p(this._resources)&&this._resources.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(e){_e(e,this._color)||(ne(this._color,e),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(e){this._pixelSnappingEnabled!==e&&(this._pixelSnappingEnabled=e,this._updateMaterial())}get primitive(){return this._primitive}set primitive(e){this._primitive!==e&&(this._primitive=e,p(this._resources)&&this._resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){_e(e,this._outlineColor)||(ne(this._outlineColor,e),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._resources&&this._resources.recreateGeometry()}_updateMaterial(){const e=this._resources.resources;_(e)||e.material.setParameters(this._materialParameters(e.texture.id))}_updateSizeAttribute(){const e=this._resources.resources,t=this._resources.object;if(_(e)||_(t))return;const i=e.geometry;if(_(i))return;const r=i.getMutableAttribute(g.SIZE).data,n=this._geometrySize;r[0]=n,r[1]=n,t.geometryVertexAttrsUpdated(t.geometries[0])}_materialParameters(e){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:Sn,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:e,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get _geometrySize(){return this._size/Se}_recreateGeometry(e,t){const i=this._createRenderGeometry(t);return p(i)&&e.addGeometry(i),i}_createResources(e){const t=es(this._primitive,this._preferredTextureSize),i=new ts(this._materialParameters(t.id)),r=this._recreateGeometry(e,i);return{material:i,texture:t,geometry:r,forEach(n){n(t),n(i),p(this.geometry)&&n(this.geometry)}}}_destroyResources(e){e.geometry=null,e.material.dispose(),e.texture.dispose()}get _preferredTextureSize(){return vr(yr(2*this._geometrySize),16,128)}calculateMapBounds(e){if(_(this._resources.resources)||_(this._resources.resources.geometry))return!1;const t=this._resources.resources.geometry.vertexAttributes.get(g.POSITION);return yt(t.data,this.view.renderCoordsHelper.spatialReference,_i,this.view.spatialReference),br(e,_i),!0}_createRenderGeometry(e){const t=this.geometry;if(_(t))return null;const{renderCoordsHelper:i,elevationProvider:r}=this.view,n=is(t,r,rs.fromElevationInfo(this.elevationInfo),i),a=se(S.get(),t.x,t.y,n),o=S.get();yt(a,t.spatialReference,o,i.spatialReference);const c=this._geometrySize;return ss(e,null,o,null,[c,c],[0,0,0,1])}};const Se=ns,Sn=[Se/2,Se/2,1-Se/2,1-Se/2],_i=u();class Rn extends Lt{constructor(e){super(e),this._maxSize=0,this._position=u(),this._up=u(),this._right=u(),this._renderOccluded=E.OccludeAndTransparent,this._color=q(1,0,0,1),this._outlineColor=q(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=E.Opaque,this.applyProps(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyObject3DResources(t),cameraChanged:()=>this._updateTransformObject3D()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyDrapedResources(t)}}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateQuadMaterial())}get color(){return this._color}set color(e){ne(this._color,e),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(e){ne(this._outlineColor,e),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(e){const t=this._outlineSize===0!=(e===0);this._outlineSize=e,t?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(e){this._outlineRenderOccluded=e,this._updateOutlineMaterial()}set geometry({previous:e,center:t,next:i}){this._maxSize=Math.min(qe(t,e),qe(t,i))/3,N(this._up,M(this._up,e,t)),N(this._right,M(this._right,i,t)),w(this._position,t),this.recreateGeometry()}_createObject3DResources(e){const t=new Qe(this._quadMaterialParameters),i=this._outlineSize===0?void 0:new oe(this._outlineMaterialParameters);return this._createObject3DGeometries(e,t,i),{quadMaterial:t,outlineMaterial:i,forEach:r=>{r(t),i&&r(i)}}}_destroyObject3DResources(e){var t;e.quadMaterial.dispose(),(t=e.outlineMaterial)==null||t.dispose()}_createObject3DGeometries(e,t,i){if(fe(this._up,bt)&&fe(this._right,bt))return;const r=this._createGeometries(t,i);for(const n of r)e.addGeometry(n);this._updateTransformObject3D(e)}_createDrapedResources(){const e=new Qe(this._quadMaterialParameters),t=this._outlineSize===0?void 0:new oe(this._outlineMaterialParameters),i=this._createGeometries(e,t).map(r=>new $t(r,{boundingInfo:r.boundingInfo}));return this._setTransformDraped(i),{quadMaterial:e,outlineMaterial:t,geometries:i,pixelRatioHandle:Ke(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()})}}_destroyDrapedResources(e){var t;e.pixelRatioHandle.remove(),e.geometries=[],(t=e.outlineMaterial)==null||t.dispose(),e.quadMaterial.dispose()}_createGeometries(e,t){const{up:i,right:r,corner:n}=this._getVertices(),a=this._quadGeometryData(i,r,n,e);return t?[a,me(t,[i,n,r])]:[a]}_getVertices(){let e=this._up,t=this._right;const i=B(S.get(),e,t);return this.isDraped&&(e=w(S.get(),e),t=w(S.get(),t),e[2]=0,t[2]=0,i[2]=0),{up:e,right:t,corner:i}}_updateTransform(){this.isDraped?this.drapedResources.recreateGeometry():this._updateTransformObject3D()}_updateTransformObject3D(e=L(this.object3dResources.object)){if(!e)return;const t=this.view.state.camera,i=this._size*t.computeScreenPixelSizeAt(this._position),r=Math.min(this._maxSize,i);Gt(Q,this._position),Nt(Q,Q,[r,r,r]),e.transformation=Q}_setTransformDraped(e){if(e.length===0)return;const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:i}}}=this,{_position:r,_size:n}=this,a=w(S.get(),r);a[2]=Ye;const o=En;o.spatialReference=ge(t.renderer.spatialReference),o.x=a[0],o.y=a[1];const c=n*(t.overlayPixelSizeInMapUnits(o)*i),l=Math.min(this._maxSize,c);Gt(Q,a),Nt(Q,Q,[l,l,1]);for(const d of e)d.updateTransformation(h=>{xi(h,Q)})}_quadGeometryData(e,t,i,r){return new Fi(r,[[g.POSITION,new Et([0,0,0,...t,...e,...i],3,!0)]],[[g.POSITION,[0,1,2,1,2,3]]])}get _quadMaterialParameters(){return{color:this._color,transparent:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded}}_updateQuadMaterial(){var e,t;(e=L(this.object3dResources.resources))==null||e.quadMaterial.setParameters(this._quadMaterialParameters),(t=L(this.drapedResources.resources))==null||t.quadMaterial.setParameters(this._quadMaterialParameters)}get _outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded}}_updateOutlineMaterial(){var e,t,i,r;(t=(e=L(this.object3dResources.resources))==null?void 0:e.outlineMaterial)==null||t.setParameters(this._outlineMaterialParameters),(r=(i=L(this.drapedResources.resources))==null?void 0:i.outlineMaterial)==null||r.setParameters(this._outlineMaterialParameters)}}const Q=ve(),En=Oi(0,0,void 0,null);let Ga=class extends Bs{sortUniqueHints(e){return e.sort((t,i)=>(i instanceof qt?i.length:0)-(t instanceof qt?t.length:0))}visualizeIntersectionPoint(e,t){const{spatialReference:i,view:r}=t;return be(new pi({view:r,primitive:"circle",geometry:Wt(e.intersectionPoint,i),elevationInfo:e.isDraped?Ut:Ht,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:Z.toUnitRGBA(R.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,t){const{view:i,spatialReference:r}=t,n=this._alignPoint(e.point,e.domain,t);return be(new pi({view:i,primitive:"circle",geometry:Wt(n,r),elevationInfo:this._hintElevationInfo(e,t),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:Z.toUnitRGBA(R.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,t){const{view:i,spatialReference:r}=t,n=this._alignPoint(e.lineStart,e.domain,t),a=this._alignPoint(e.lineEnd,e.domain,t);return be(this._createLineSegmentHint(e.type,n,a,r,this._hintElevationInfo(e,t),i,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:i,spatialReference:r}=t,{isDraped:n}=e,a=this._hintElevationInfo(e,t),o=this._alignPoint(e.lineStart,e.domain,t),c=this._alignPoint(e.lineEnd,e.domain,t),l=K(o,r,a,i,n),d=K(c,r,a,i,n),h=Pr(d,l,d,.5),f=new Pn({view:i,attached:!1,offset:R.parallelLineHintOffset,length:R.parallelLineHintLength,width:R.parallelLineHintWidth,color:Z.toUnitRGBA(R.orange),location:h,renderOccluded:n?E.OccludeAndTransparent:E.Opaque,isDraped:n,renderGroup:Ee.SnappingHint});return f.setDirectionFromPoints(l,h),f.attached=!0,be(f)}visualizeRightAngleQuad(e,t){const{view:i,spatialReference:r}=t,n=this._hintElevationInfo(e,t),{isDraped:a}=e,o=this._alignPoint(e.previousVertex,e.domain,t),c=this._alignPoint(e.centerVertex,e.domain,t),l=this._alignPoint(e.nextVertex,e.domain,t),d=K(o,r,n,i,a),h=K(c,r,n,i,a),f=K(l,r,n,i,a);return be(new Rn({view:i,attached:!0,color:a?Z.toUnitRGBA(R.orangeTransparent):Z.toUnitRGBA(R.orange),renderOccluded:a?E.OccludeAndTransparent:E.Transparent,outlineRenderOccluded:a?E.OccludeAndTransparent:E.Opaque,outlineColor:Z.toUnitRGBA(R.orange),outlineSize:R.rightAngleHintOutlineSize,size:R.rightAngleHintSize,isDraped:a,geometry:{previous:d,center:h,next:f},renderGroup:Ee.SnappingHint}))}_createLineSegmentHint(e,t,i,r,n,a,o=!1,c=!0,l=!0){const d=K(t,r,n,a,o),h=K(i,r,n,a,o),f=new yn({view:a,extensionType:F.FADED,start:d,end:h,isDraped:o,color:Z.toUnitRGBA(R.orange),renderOccluded:o?E.OccludeAndTransparent:E.Opaque,renderGroup:Ee.SnappingHint});switch(e){case pt.TARGET:f.width=R.lineHintWidthTarget,f.fadedExtensions={start:0,end:R.lineHintFadedExtensions};break;case pt.REFERENCE_EXTENSION:f.width=R.lineHintWidthReference,f.fadedExtensions={start:0,end:0};break;case pt.REFERENCE:f.width=R.lineHintWidthReference,f.fadedExtensions={start:c?R.lineHintFadedExtensions:0,end:l?R.lineHintFadedExtensions:0}}return f.attached=!0,f}_alignPoint(e,t,i){const r=this._getSelfSnappingZ(t,i);return _(r)?e:wr(e[0],e[1],r)}_hintElevationInfo(e,t){return p(this._getSelfSnappingZ(e.domain,t))?ge(t.selfSnappingZ).elevationInfo:e.isDraped?Ut:Ht}_getSelfSnappingZ(e,{selfSnappingZ:t}){return e===Sr.SELF&&p(t)?t.value:null}};function K(s,e,t,i,r,n=u()){if(r){const a=i.basemapTerrain.overlayManager.renderer.spatialReference;yt(s,e,n,a)}else Rr(s,e,t,i,n);return n}function Dn(s,e){if(!e.screenSizeEnabled)return;const t=s.vertex;Rs(t,e),t.uniforms.add(new x("perScreenPixelRatio",(i,r)=>r.camera.perScreenPixelRatio)),t.uniforms.add(new x("screenSizeScale",i=>i.screenSizeScale)),t.code.add(m`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - cameraPosition));
return viewDirectionDistance * perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSizeScale * computeRenderPixelSizeAt(anchor) + anchor;
}`)}function On(s){const e=new et,t=s.hasMultipassTerrain&&(s.output===P.Color||s.output===P.Alpha);e.include(Ii,s),e.include(Dn,s),e.include(zi,s);const{vertex:i,fragment:r}=e;return r.include(Gi),Ni(i,s),r.uniforms.add(new pe("uColor",n=>n.color)),e.attributes.add(g.POSITION,"vec3"),e.varyings.add("vWorldPosition","vec3"),t&&e.varyings.add("depth","float"),s.screenSizeEnabled&&e.attributes.add(g.OFFSET,"vec3"),s.shadingEnabled&&(Es(i),e.attributes.add(g.NORMAL,"vec3"),e.varyings.add("vViewNormal","vec3")),i.code.add(m`
    void main(void) {
      vWorldPosition = ${s.screenSizeEnabled?"screenSizeScaling(offset, position)":"position"};
  `),s.shadingEnabled&&i.code.add(m`vec3 worldNormal = normal;
vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`),i.code.add(m`
    ${t?"depth = (view * vec4(vWorldPosition, 1.0)).z;":""}
    gl_Position = transformPosition(proj, view, vWorldPosition);
  }
  `),t&&e.include(qi,s),r.code.add(m`
    void main() {
      discardBySlice(vWorldPosition);
      ${t?"terrainDepthTest(gl_FragCoord, depth);":""}
    `),s.shadingEnabled?(r.uniforms.add(new H("shadingDirection",n=>n.shadingDirection)),r.uniforms.add(new pe("shadedColor",n=>xn(n.shadingTint,n.color))),r.code.add(m`vec3 viewNormalNorm = normalize(vViewNormal);
float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
vec4 finalColor = mix(uColor, shadedColor, shadingFactor);`)):r.code.add(m`vec4 finalColor = uColor;`),r.code.add(m`
      ${s.output===P.ObjectAndLayerIdColor?m`finalColor.a = 1.0;`:""}
      if (finalColor.a < ${m.float(Ds)}) {
        discard;
      }
      ${s.output===P.Alpha?m`gl_FragColor = vec4(finalColor.a);`:""}

      ${s.output===P.Color?m`gl_FragColor = highlightSlice(finalColor, vWorldPosition); ${s.transparencyPassType===W.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    }
    `),e}function xn(s,e){const t=1-s[3],i=s[3]+e[3]*t;return i===0?(J[3]=i,J):(J[0]=(s[0]*s[3]+e[0]*e[3]*t)/i,J[1]=(s[1]*s[3]+e[1]*e[3]*t)/i,J[2]=(s[2]*s[3]+e[2]*e[3]*t)/i,J[3]=e[3],J)}const J=Di(),$n=Object.freeze(Object.defineProperty({__proto__:null,build:On},Symbol.toStringTag,{value:"Module"}));class at extends tt{initializeProgram(e){return new it(e.rctx,at.shader.get().build(this.configuration),or)}_setPipelineState(e){const t=this.configuration,i=e===W.NONE,r=e===W.FrontFace;return st({blending:t.output!==P.Color&&t.output!==P.Alpha||!t.transparent?null:i?zs:Bi(e),culling:ki(t.cullFace),depthTest:{func:r?ft.LESS:t.shadingEnabled?ft.LEQUAL:ft.LESS},depthWrite:i?t.writeDepth?Yi:null:Qi(e),colorWrite:nt,polygonOffset:i||r?null:Gs})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}at.shader=new rt($n,()=>Je(()=>import("./ShadedColorMaterial.glsl-f706c50a.js"),["assets/ShadedColorMaterial.glsl-f706c50a.js","assets/index-7753bab1.js","assets/index-0be7f32f.css","assets/VertexColor.glsl-a24a5fe4.js","assets/requestImageUtils-dc72d397.js","assets/OrderIndependentTransparency-92d1201d.js","assets/enums-64ab819c.js","assets/basicInterfaces-04e01328.js","assets/Texture-280a81f5.js","assets/VertexArrayObject-6236f727.js","assets/Util-d77dfa33.js","assets/mat4f64-65d35099.js","assets/triangle-86ddbd84.js","assets/sphere-89c2d6c4.js","assets/mat3f64-221ce671.js","assets/quatf64-3363c48e.js","assets/lineSegment-94ce77e4.js","assets/Indices-4fd742c7.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/quat-1a9efe59.js","assets/vec3f32-ad1dc57f.js","assets/BufferView-7ae97da4.js","assets/VertexElementDescriptor-2925c6af.js","assets/vec4f32-0d1b2306.js","assets/Octree-d70a1310.js","assets/plane-32e6467c.js","assets/NativeLineMaterial-0aac9ae8.js","assets/interfaces-736d93d7.js","assets/NestedMap-1b5db22e.js","assets/InterleavedLayout-f57c96d2.js","assets/types-e1c0a5bf.js","assets/boundedPlane-2b6cf7c1.js","assets/glUtil-7a9be557.js","assets/DoubleArray-0068ae83.js","assets/hydratedFeatures-e18f5d50.js","assets/floatRGBA-bba05acf.js","assets/SnappingContext-ff99808f.js","assets/PointSnappingHint-9fd6408b.js","assets/SnappingDragPipelineStep-4df9c5ad.js","assets/drawUtils-394a2d10.js"]));let V=class extends Wi{constructor(){super(...arguments),this.output=P.Color,this.cullFace=k.None,this.transparencyPassType=W.NONE,this.hasSlicePlane=!1,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}};v([y({count:P.COUNT})],V.prototype,"output",void 0),v([y({count:k.COUNT})],V.prototype,"cullFace",void 0),v([y({count:W.COUNT})],V.prototype,"transparencyPassType",void 0),v([y()],V.prototype,"hasSlicePlane",void 0),v([y()],V.prototype,"transparent",void 0),v([y()],V.prototype,"writeDepth",void 0),v([y()],V.prototype,"screenSizeEnabled",void 0),v([y()],V.prototype,"shadingEnabled",void 0),v([y()],V.prototype,"hasMultipassTerrain",void 0),v([y()],V.prototype,"cullAboveGround",void 0);const or=new Map([[g.POSITION,0],[g.NORMAL,1],[g.OFFSET,2]]);class An extends Os{constructor(e){super(e,new Ln),this.supportsEdges=!0,this._configuration=new V,this._vertexAttributeLocations=or}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.screenSizeEnabled=this.parameters.screenSizeEnabled,this._configuration.shadingEnabled=this.parameters.shadingEnabled,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(e,t,i,r,n,a){if(this.parameters.screenSizeEnabled){const o=e.vertexAttributes.get(g.OFFSET);ei(e,i,r,n,{applyToVertex:(l,d,h,f)=>{const b=se(gi,o.data[3*f+0],o.data[3*f+1],o.data[3*f+2]),D=se(Mn,l,d,h);return Ue(b,b,this.parameters.screenSizeScale*i.camera.computeRenderPixelSizeAt(b)),B(D,D,b),[D[0],D[1],D[2]]},applyToAabb:l=>{const d=Er(l,gi);return Dr(l,this.parameters.screenSizeScale*i.camera.computeRenderPixelSizeAt(d))}},a)}else ei(e,i,r,n,void 0,a)}requiresSlot(e,t){if(t===P.Highlight)return e===C.OPAQUE_MATERIAL;if(t===P.Color||t===P.Alpha||t===P.ObjectAndLayerIdColor){let i=C.OPAQUE_MATERIAL;return this.parameters.transparent&&(i=this.parameters.writeDepth?C.TRANSPARENT_MATERIAL:C.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===i||e===C.DRAPED_MATERIAL}return!1}createGLMaterial(e){return new Tn(e)}createBufferWriter(){return new Cn(this.parameters.screenSizeEnabled)}}class Tn extends xs{beginSlot(e){return this.ensureTechnique(at,e)}}let Ln=class extends Ui{constructor(){super(...arguments),this.color=q(1,1,1,1),this.shadingTint=q(0,0,0,.25),this.shadingDirection=N(u(),[.5,-.5,-.5]),this.screenSizeScale=14,this.transparent=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=k.None,this.screenSizeEnabled=!1,this.shadingEnabled=!0}};class Cn{constructor(e){this.screenSizeEnabled=e;const t=Hi().vec3f(g.POSITION).vec3f(g.NORMAL);this.screenSizeEnabled&&t.vec3f(g.OFFSET),this.vertexBufferLayout=t}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(g.POSITION).length}write(e,t,i,r,n){if($s(i,this.vertexBufferLayout,e,t,r,n),this.screenSizeEnabled){if(!i.vertexAttributes.has(g.OFFSET))throw new Error(`${g.OFFSET} vertex attribute required for screenSizeEnabled ShadedColorMaterial`);{const a=i.vertexAttributes.get(g.OFFSET),o=i.indices.get(g.OFFSET);Xs(a.size===3);const c=r.getField(g.OFFSET,Zs);if(!c)throw new Error("unable to acquire view for "+g.OFFSET);As(o,a.data,t,c,n)}}}}const gi=u(),Mn=u();function De(s,e,t){return Vn(s,s.screenToRender(e,Pt(S.get())),t)}function Vn(s,e,t){const i=Pt(Bt(S.get(),e));if(i[2]=0,!s.unprojectFromRenderScreen(i,t.origin))return null;const r=Pt(Bt(S.get(),e));r[2]=1;const n=s.unprojectFromRenderScreen(r,S.get());return _(n)?null:(M(t.direction,n,t.origin),t)}class cr{constructor(e){var i;this.metadata=void 0,this._camera=new as,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=new Array,this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=ve(),this._worldFrame=null,this._renderLocation=u(),this._renderLocationDirty=!0,this._location=new Ge({x:0,y:0,z:0}),this._elevationAlignedLocation=new Ge,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.cursor=null,this.grabCursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=ue.None,this._focused=!1,this.events=new Or.EventEmitter,this._screenLocation={screenPointArray:ae(),renderScreenPointArray:xr(),pixelSize:0},this._screenLocationDirty=!0,this._engineResourcesAddedToStage=!1,this._attached=!1,this._location.spatialReference=e.view.spatialReference;for(const r in e)this[r]=e[r];const t=(i=this.view.state)==null?void 0:i.camera;t&&this._camera.copyFrom(t)}destroy(){this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this._camera=null}get _stage(){var e;return(e=this.view)==null?void 0:e._stage}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(e){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=e.slice(),this._updateEngineObject()}set available(e){e!==this._available&&(this._available=e,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,this._noDisplayCount===1&&this._updateEngineObject(),{remove:$r(()=>{this._noDisplayCount--,this._noDisplayCount===0&&this._updateEngineObject()})}}set radius(e){e!==this._radius&&(this._radius=e,this._updateEngineObject())}get radius(){return this._radius}set worldSized(e){e!==this._worldSized&&(this._worldSized=e,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(e){fi(e)&&(this._screenLocationDirty=!0),xi(this._modelTransform,e),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=ve()),jn(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(e){this.view.renderCoordsHelper.fromRenderCoords(e,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(e){ri(e,this._location),this._notifyLocationChanged()}_notifyLocationChanged(){this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(e){ri(e,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){const e=p(this._elevation.override)?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y,this._elevationAlignedLocation.z=e+this._elevation.offset,this._elevationAlignedLocation.spatialReference=ks(this.location.spatialReference),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(e){e!==this._grabbing&&(this._grabbing=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(e){e!==this._hovering&&(this._hovering=e,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(e){e!==this._selected&&(this._selected=e,this._updateEngineObject(),this.events.emit("select-changed",{action:e?"select":"deselect"}))}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._updateEngineObject())}updateStateEnabled(e,t){t?this.state|=e:this.state&=~e}_setFocused(e){e!==this._focused&&(this._focused=e,this.events.emit("focus-changed",{action:e===!0?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;this._screenLocation.pixelSize=this._camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;let e;if(fi(this._modelTransform)){const t=this._calculateModelTransformOffset(zn);e=B(t,t,this.renderLocation)}else e=this.renderLocation;this._camera.projectToRenderScreen(e,this._screenLocation.renderScreenPointArray),this._camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(e){this._applyObjectTransform=e,this._screenLocationDirty=!0,this._updateEngineObject()}get attached(){return this._attached}intersectionDistance(e,t){if(!this.available)return null;const i=He(e,Fn),r=this._getCollisionRadius(t),n=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(Lr(this.screenLocation.screenPointArray,i)<r*r)return this.screenLocation.renderScreenPointArray[2]+n;break;case"line":{const a=this.collisionType.paths,o=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(o,Ie),l=r*this.screenLocation.pixelSize,d=De(this._camera,i,vt);if(_(d))return null;for(const h of a){if(h.length===0)continue;const f=$(Oe,h[0],c);for(let b=1;b<h.length;b++){const D=$(yi,h[b],c),O=Yr(ke(f,D,mi),d);if(O!=null&&O<l*l){const I=B(S.get(),f,D);Ue(I,I,.5);const U=Qt(S.get());return this._camera.projectToRenderScreen(I,U),U[2]+n}w(f,D)}}break}case"disc":{const a=this.collisionType.direction,o=this.collisionType.offset??bt,c=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(c,Ie),d=r*this.screenLocation.pixelSize,h=De(this._camera,i,vt);if(_(h))return null;const f=kt(vi,l),b=Yt(Pi,a,f),D=$(wi,o,l);Ze(D,b,ze);const O=bi;if(Xe(ze,h,O)&&Tr(O,D)<d*d)return this.screenLocation.renderScreenPointArray[2]+n;break}case"ribbon":{const{paths:a,direction:o}=this.collisionType,c=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(c,Ie),d=r*this._camera.computeScreenPixelSizeAt(this.renderLocation),h=De(this._camera,i,vt);if(_(h))return null;const f=kt(vi,l),b=Yt(Pi,o,f),D=this._calculateModelTransformPosition(wi);Ze(D,b,ze);const O=bi;if(!Xe(ze,h,O))break;for(const I of a){if(I.length===0)continue;const U=$(Oe,I[0],l);for(let ct=1;ct<I.length;ct++){const lt=$(yi,I[ct],l),Mt=kr(ke(U,lt,mi),O);if(Mt!=null&&Mt<d*d){const ht=B(S.get(),U,lt);Ue(ht,ht,.5);const Vt=Qt(S.get());return this._camera.projectToRenderScreen(ht,Vt),Vt[2]+n}w(U,lt)}}break}default:Ar(this.collisionType)}return null}attach(e={manipulator3D:{}}){const t=this._stage;if(!t)return;const i=e.manipulator3D;if(_(i.engineLayerId)){const r=new Mi({pickable:!1,updatePolicy:xt.SYNC});t.add(r),i.engineLayerId=r.id,this._engineLayer=r}else t!=null&&t.getObject&&(this._engineLayer=t.getObject(i.engineLayerId));i.engineLayerReferences=(i.engineLayerReferences||0)+1,this._materialIdReferences=i.materialIdReferences,_(this._materialIdReferences)&&(this._materialIdReferences=new Map,i.materialIdReferences=this._materialIdReferences),this._camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),Cr(this._location.spatialReference,this.view.spatialReference)||(this.location=new Ge({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(e={manipulator3D:{}}){const t=e.manipulator3D;t.engineLayerReferences--;const i=t.engineLayerReferences===0;i&&(t.engineLayerId=null),this._removeResourcesFromStage(i),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this._camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(e){wt(this.location,Si,e.spatialReference)&&Mr(e.extent,Si)&&this._notifyLocationChanged()}_evaluateElevationAlignment(){if(_(this.elevationInfo))return;let e=null,t=0;const i=ie(this.elevationInfo.offset,0);switch(this.elevationInfo.mode){case"on-the-ground":e=ie(gt(this.view.elevationProvider,this.location,"ground"),0);break;case"relative-to-ground":t=ie(gt(this.view.elevationProvider,this.location,"ground"),0)+i;break;case"relative-to-scene":t=ie(gt(this.view.elevationProvider,this.location,"scene"),0)+i;break;case"absolute-height":t=i}return t!==this._elevation.offset||e!==this._elevation.override?(this._elevation.offset=t,void(this._elevation.override=e)):void 0}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const e=this._getWorldToScreenObjectScale(),t=Ie;if(this.autoScaleRenderObjects===!0){const a=this._getFocusedSize(this._radius,this.focused)*e;this._calculateObjectTransform(a,t)}else this._calculateObjectTransform(e,t);const{objectsByState:i}=this._ensureEngineResources(),r=(this.focused?T.Focused:T.Unfocused)|(this.selected?T.Selected:T.Unselected),n=this._noDisplayCount>0;for(const{stateMask:a,objects:o}of i){if(n){for(const f of o)f.visible=!1;continue}const c=(a&T.All)!==T.None,l=(a&ue.All)!==ue.None,d=!c||(r&a)==(a&T.All),h=!l||(this.state&a)==(a&ue.All);if(d&&h)for(const f of o)f.visible=!0,f.transformation=t;else for(const f of o)f.visible=!1}}_ensureEngineResources(){if(_(this._engineResources)){const e=ge(this._engineLayer),t=[],i=new Set;this.renderObjects.forEach(({geometry:{material:a}})=>{i.has(a)||(t.push(a),i.add(a))});const r=new Map;this._renderObjects.forEach(a=>{const o=new Vi({castShadow:!1,geometries:[a.geometry]}),c=r.get(a.stateMask)||[];c.push(o),r.set(a.stateMask,c)});const n=[];r.forEach((a,o)=>n.push({stateMask:o,objects:a})),this._engineResources={objectsByState:n,layer:e,materials:t}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){const e=this._stage;if(this._engineResourcesAddedToStage||_(this._engineResources)||!e)return;const{objectsByState:t,layer:i,materials:r}=this._engineResources;r.forEach(n=>{const a=ge(this._materialIdReferences),o=a.get(n.id)||0;o===0&&e.add(n),a.set(n.id,o+1)}),t.forEach(({objects:n})=>{i.addMany(n),e.addMany(n)}),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(e=!1){const t=this._stage;if(!this._engineResourcesAddedToStage||_(this._engineResources)||!t)return;const{objectsByState:i,layer:r,materials:n}=this._engineResources;i.forEach(({objects:a})=>{r.removeMany(a),t.removeMany(a)}),n.forEach(a=>{const o=ge(this._materialIdReferences),c=o.get(a.id);c===1?(t.remove(a),o.delete(a.id)):o.set(a.id,c-1)}),e&&t.remove(r),this._engineResourcesAddedToStage=!1}_getCollisionRadius(e){return this._getFocusedSize(this.radius,!0)*(e==="touch"?this.touchMultiplier:1)}_getFocusedSize(e,t){return e*(t?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(e){const t=this._getWorldToScreenObjectScale(),i=this._calculateObjectTransform(t,In);return se(e,i[12],i[13],i[14])}_calculateModelTransformOffset(e){const t=this._calculateModelTransformPosition(e);return M(e,t,this.renderLocation)}_calculateObjectTransform(e,t){return Vr(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1),this._worldFrame&&Zt(t,t,this._worldFrame),Zt(t,t,this._modelTransform),t[12]+=this.renderLocation[0],t[13]+=this.renderLocation[1],t[14]+=this.renderLocation[2],t[15]=1,p(this._applyObjectTransform)&&this._applyObjectTransform(t),t}get test(){let e=!1;if(p(this._engineResources))for(const t in this._engineResources.objectsByState){const i=this._engineResources.objectsByState[t];for(const r of i.objects)if(r.visible){e=!0;break}if(e)break}return{areAnyResourcesVisible:e}}}function fi(s){return s[12]!==0||s[13]!==0||s[14]!==0}function jn(s,e,t){switch(s.viewingMode){case"local":return zr(t),!0;case"global":{const i=jr(s.renderCoordsHelper.spatialReference);return Fr(e,0,Oe,0,i.radius),Ir($e(Oe[0]),$e(Oe[1]),t),!0}}}const Fn=ae(),mi=Le(),vt=Ot(),vi=Qs(),In=ve(),Ie=ve(),ze=Tt(),Oe=u(),yi=u(),bi=u(),Pi=u(),wi=u(),zn=u(),Si=new Ge({x:0,y:0,z:0,spatialReference:null});class Re{constructor(e,t=T.None){this.geometry=e,this.stateMask=t}}function Gn(s){const e=new et,{vertex:t,fragment:i}=e;return Ni(t,s),e.include(Ii,s),e.attributes.add(g.POSITION,"vec3"),e.attributes.add(g.UV0,"vec2"),e.varyings.add("vpos","vec3"),s.hasMultipassTerrain&&e.varyings.add("depth","float"),t.uniforms.add(new re("textureCoordinateScaleFactor",r=>p(r.texture)&&p(r.texture.descriptor.textureCoordinateScaleFactor)?r.texture.descriptor.textureCoordinateScaleFactor:Gr)),t.code.add(m`
    void main(void) {
      vpos = position;
      ${s.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
      vTexCoord = uv0 * textureCoordinateScaleFactor;
      gl_Position = transformPosition(proj, view, vpos);
    }
  `),e.include(zi,s),e.include(qi,s),i.uniforms.add([new Rt("tex",r=>r.texture),new x("opacity",r=>r.opacity)]),e.varyings.add("vTexCoord","vec2"),s.output===P.Alpha?i.code.add(m`
    void main() {
      discardBySlice(vpos);
      ${s.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

      float alpha = texture2D(tex, vTexCoord).a * opacity;
      if (alpha  < ${m.float(ti)}) {
        discard;
      }

      gl_FragColor = vec4(alpha);
    }
    `):(i.include(Gi),i.code.add(m`
    void main() {
      discardBySlice(vpos);
      ${s.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
      gl_FragColor = texture2D(tex, vTexCoord) * opacity;

      if (gl_FragColor.a < ${m.float(ti)}) {
        discard;
      }

      gl_FragColor = highlightSlice(gl_FragColor, vpos);
      ${s.transparencyPassType===W.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    }
    `)),e}const Nn=Object.freeze(Object.defineProperty({__proto__:null,build:Gn},Symbol.toStringTag,{value:"Module"}));class ot extends tt{initializeProgram(e){return new it(e.rctx,ot.shader.get().build(this.configuration),ji)}_setPipelineState(e,t){const i=this.configuration,r=e===W.NONE,n=e===W.FrontFace;return st({blending:i.output!==P.Color&&i.output!==P.Alpha||!i.transparent?null:r?qn:Bi(e),culling:ki(i.cullFace),depthTest:{func:Ns(e)},depthWrite:r?i.writeDepth?Yi:null:Qi(e),colorWrite:nt,stencilWrite:i.hasOccludees?Ts:null,stencilTest:i.hasOccludees?t?Ls:Cs:null,polygonOffset:r||n?null:qs(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}ot.shader=new rt(Nn,()=>Je(()=>import("./ImageMaterial.glsl-07c1297c.js"),["assets/ImageMaterial.glsl-07c1297c.js","assets/index-7753bab1.js","assets/index-0be7f32f.css","assets/VertexColor.glsl-a24a5fe4.js","assets/requestImageUtils-dc72d397.js","assets/OrderIndependentTransparency-92d1201d.js","assets/enums-64ab819c.js","assets/basicInterfaces-04e01328.js","assets/Texture-280a81f5.js","assets/VertexArrayObject-6236f727.js","assets/Util-d77dfa33.js","assets/mat4f64-65d35099.js","assets/triangle-86ddbd84.js","assets/sphere-89c2d6c4.js","assets/mat3f64-221ce671.js","assets/quatf64-3363c48e.js","assets/lineSegment-94ce77e4.js","assets/Indices-4fd742c7.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/quat-1a9efe59.js","assets/vec3f32-ad1dc57f.js","assets/BufferView-7ae97da4.js","assets/VertexElementDescriptor-2925c6af.js","assets/vec4f32-0d1b2306.js","assets/Octree-d70a1310.js","assets/plane-32e6467c.js","assets/NativeLineMaterial-0aac9ae8.js","assets/interfaces-736d93d7.js","assets/NestedMap-1b5db22e.js","assets/InterleavedLayout-f57c96d2.js","assets/types-e1c0a5bf.js","assets/boundedPlane-2b6cf7c1.js","assets/glUtil-7a9be557.js","assets/DoubleArray-0068ae83.js","assets/hydratedFeatures-e18f5d50.js","assets/floatRGBA-bba05acf.js","assets/SnappingContext-ff99808f.js","assets/PointSnappingHint-9fd6408b.js","assets/SnappingDragPipelineStep-4df9c5ad.js","assets/drawUtils-394a2d10.js"]));const qn=At(ye.ONE,ye.ONE_MINUS_SRC_ALPHA);class j extends Wi{constructor(){super(...arguments),this.output=P.Color,this.cullFace=k.None,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.transparencyPassType=W.NONE,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}v([y({count:P.COUNT})],j.prototype,"output",void 0),v([y({count:k.COUNT})],j.prototype,"cullFace",void 0),v([y()],j.prototype,"hasSlicePlane",void 0),v([y()],j.prototype,"transparent",void 0),v([y()],j.prototype,"enableOffset",void 0),v([y()],j.prototype,"writeDepth",void 0),v([y()],j.prototype,"hasOccludees",void 0),v([y({count:W.COUNT})],j.prototype,"transparencyPassType",void 0),v([y()],j.prototype,"hasMultipassTerrain",void 0),v([y()],j.prototype,"cullAboveGround",void 0);class Wn extends os{constructor(e){super(e,new Hn),this.supportsEdges=!0,this._configuration=new j}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<Ws,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}requiresSlot(e,t){return t===P.Color||t===P.Alpha||t===P.Highlight?e===C.DRAPED_MATERIAL?!0:t===P.Highlight?e===C.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?C.TRANSPARENT_MATERIAL:C.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:C.OPAQUE_MATERIAL):!1}createGLMaterial(e){return new Un(e)}createBufferWriter(){return new Ms(cs)}}class Un extends Vs{constructor(e){super({...e,...e.material.parameters})}_updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(ot,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&(this._material.setParameters({hasOccludees:e.hasOccludees}),this._updateParameters(e))}beginSlot(e){return this._output!==P.Color&&this._output!==P.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}}class Hn extends Ui{constructor(){super(...arguments),this.transparent=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=k.None,this.hasOccludees=!1,this.opacity=1,this.textureId=null,this.initTextureTransparent=!0}}function Bn(s,e=E.OccludeAndTransparent,t=!0){const i=q(s[0],s[1],s[2],s.length>3?s[3]:1),r=s[3]<1;return t?new An({color:i,transparent:r,writeDepth:!0,cullFace:k.Back,renderOccluded:e}):new Qe({color:i,transparent:r,writeDepth:!0,cullFace:k.Back,renderOccluded:e})}function Ua(s,e=E.OccludeAndTransparent){const t=q(s[0],s[1],s[2],s.length===4?s[3]:1);return new Qe({color:t,transparent:!0,writeDepth:!0,cullFace:k.Front,renderOccluded:e})}const we=Object.freeze({calloutLength:40,calloutWidth:1,discRadius:27,focusMultiplier:1.1,calloutColor:Te(1,.5,0)});function Ha(s,e){const t=new cr({view:s,autoScaleRenderObjects:!1,collisionPriority:1,metadata:e.metadata});return kn(t,e),t}function kn(s,e){var D;const t=e.material??new Wn({transparent:!0,writeDepth:!1,textureId:(D=e.texture)==null?void 0:D.id,renderOccluded:E.Opaque}),i=e.focusMultiplier??we.focusMultiplier,r=e.calloutLength??we.calloutLength,n=we.discRadius*(e.discScale??1),a=n*i,o=(O,I)=>{const U=[0,1,2,2,3,0];return new Fi(I,[[g.POSITION,new Et([r-O,-O,0,r+O,-O,0,r+O,O,0,r-O,O,0],3,!0)],[g.UV0,new Et([0,0,1,0,1,1,0,1],2,!0)]],[[g.POSITION,U],[g.UV0,U]])},c=we.calloutColor,l=e.calloutWidth??we.calloutWidth,d=new(l>1?oe:ls)({width:l,color:q(c[0],c[1],c[2],e.calloutOpacity??1),renderOccluded:E.OccludeAndTransparent}),h=me(d,[[0,0,0],[r-n,0,0]]),f=me(d,[[0,0,0],[r-a,0,0]]),b=e.customStateMask??ue.None;s.collisionType={type:"disc",direction:[0,0,1],offset:[r,0,0]},s.focusMultiplier=i,s.metadata=e.metadata,s.radius=n,s.renderObjects=[new Re(o(n,t),T.Unfocused|b),new Re(h,T.Unfocused|b),new Re(o(a,t),T.Focused|b),new Re(f,T.Focused|b)]}function Ba(s,e,t=1,i=ue.None){const r=Bn(q(e[0],e[1],e[2],t??1)),n=[new Re(ds(r,1,32,32),i)];return new cr({view:s,renderObjects:n})}const ka=Object.freeze({autoScaleRenderObjects:!1,worldSized:!0});function Ya(s,e,t,i){const r=M(S.get(),s,t),n=Yn(r,Ae(S.get(),i,r),t,Xr.get());Nr(n,n);const a=$(S.get(),e,n);return Math.atan2(a[1],a[0])}function Yn(s,e,t,i){const r=N(S.get(),s),n=N(S.get(),e),a=Ae(S.get(),r,n);return i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=0,i[4]=n[0],i[5]=n[1],i[6]=n[2],i[7]=0,i[8]=a[0],i[9]=a[1],i[10]=a[2],i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}function Qn(s,e){const t=s.getViewForGraphic(e);return p(t)&&"computeAttachmentOrigin"in t?t.computeAttachmentOrigin(e,s.spatialReference):null}function Qa(s,e,t){const i=Qn(s,t);p(i)?e.elevationAlignedLocation=i:Zn(e,t.geometry)}function Zn(s,e){if(_(e))return;const t=e.type==="mesh"?e.anchor:hs(e);_(t)||(s.location=Ys(t))}function Xn(s,e){return lr(s,()=>e)}function Za(s){return lr(s,e=>e.plane)}function lr(s,e){const t=u(),i=u();let r=!1;return n=>{const a=e(n);if(n.action==="start"){const l=He(n.screenStart,We(Xt.get())),d=De(s.state.camera,l,Ri);p(d)&&(r=Xe(a,d,t))}if(!r)return null;const o=He(n.screenEnd,We(Xt.get())),c=De(s.state.camera,o,Ri);return _(c)?null:Xe(a,c,i)?{...n,renderStart:t,renderEnd:i,plane:a,ray:c}:null}}function Kn(s,e,t=0,i=null,r=null){let n=null;return a=>{if(a.action==="start"&&(n=s.sceneIntersectionHelper.intersectElevationFromScreen(ae(a.screenStart.x,a.screenStart.y),e,t,r),p(n)&&p(i)&&!wt(n,n,i))||_(n))return null;const o=s.sceneIntersectionHelper.intersectElevationFromScreen(ae(a.screenEnd.x,a.screenEnd.y),e,t,r);return p(o)?p(i)&&!wt(o,o,i)?null:{...a,mapStart:n,mapEnd:o}:null}}function Jn(s,e,t,i=null,r=null){return Kn(s,t,qr(e,s,t),i,r)}function ea(s,e,t,i=null,r=null){return Jn(s,t,Wr(e),i,r)}function Xa(s,e,t,i){const r=e.toMap(s.screenStart,{include:[t]});return p(r)?ea(e,t,r,i):null}function ta(s,e){const t=sa,i=na,r=Tt();s.renderCoordsHelper.worldUpAtPosition(e,t);const n=Ae(r,t,M(i,e,s.state.camera.eye));return Ae(n,n,t),Ze(e,n,r)}function Ka(s,e,t){let i=null;const r=new Ks;return r.next(Xn(s,ta(s,e))).next(ia(s,e)).next(ra(s,t)).next(n=>{n.mapEnd.x=n.mapStart.x,n.mapEnd.y=n.mapStart.y,i=n}),n=>(i=null,r.execute(n),i)}function ia(s,e){const t=u(),i=Ne(e);s.renderCoordsHelper.worldUpAtPosition(e,t);const r=u(),n=u(),a=o=>(M(o,o,e),Kr(t,o,o),s.viewingMode==="global"&&Ne(o)*Math.sign(Ur(t,o))<.001-i&&M(o,Ue(o,t,.001),e),B(o,o,e),o);return o=>(o.renderStart=a(w(r,o.renderStart)),o.renderEnd=a(w(n,o.renderEnd)),o)}function ra(s,e){const t=s.renderCoordsHelper;return i=>{const r=t.fromRenderCoords(i.renderStart,e),n=t.fromRenderCoords(i.renderEnd,e);return p(r)&&p(n)?{...i,mapStart:r,mapEnd:n}:null}}var xe;function Ja(s){let e=null;return t=>{switch(t.action){case"start":e=s.disableDisplay();break;case"end":case"cancel":p(e)&&(e.remove(),e=null)}return t}}function eo(s,e=null){const t=us(s.state.viewingMode);t.options.selectionMode=!0,t.options.store=ps.MIN,t.options.hud=!1;const i=ae(),r={requiresGroundFeedback:!0,enableDraped:!0,exclude:new Set},n=u(),a=ie(e,s.spatialReference),o=l=>{s.map.ground&&s.map.ground.opacity<1?r.exclude.add(ii):r.exclude.delete(ii),s.sceneIntersectionHelper.intersectIntersectorScreen(He(l,i),t,r);const d=t.results.min;let h;if(d.getIntersectionPoint(n))h=d.intersector===_s.TERRAIN?xe.GROUND:xe.OTHER;else{if(!t.results.ground.getIntersectionPoint(n))return null;h=xe.GROUND}return{location:s.renderCoordsHelper.fromRenderCoords(n,a),surfaceType:h}};let c;return l=>{if(l.action==="start"){const h=o(l.screenStart);c=p(h)?h.location:null}if(_(c))return null;const d=o(l.screenEnd);return p(d)&&p(d.location)?{...l,mapStart:c,mapEnd:d.location,surfaceType:d.surfaceType}:null}}(function(s){s[s.GROUND=0]="GROUND",s[s.OTHER=1]="OTHER"})(xe||(xe={}));const sa=u(),na=u(),Ri=Ot();export{an as A,eo as B,Xn as C,ra as F,Ka as G,Ua as L,Jn as N,ea as P,Bn as R,pi as S,Za as T,Ha as U,Yn as V,F as W,Xi as a,yn as b,Qa as c,mn as d,Re as e,Ya as f,ka as g,Xa as h,cr as i,Ba as j,Ja as k,On as l,Gn as m,en as n,rr as o,xe as q,De as s,Lt as t,An as v,Ga as x,Qn as z};
