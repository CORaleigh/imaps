import{M as E,x as M,b5 as R,a2 as D,J as r,a7 as O,af as $,at as x,c3 as b,cw as A,cC as K,bb as z,e as n,y as a,a as w,gb as s,cj as l,ga as d,ai as P,I as F,cN as N,L as Y}from"./index-3baec1e8.js";import{u as j}from"./SnappingVisualizer2D-12606f78.js";import{w as B,V as k,g as I,a as J,p as L}from"./SnappingContext-1315d9e2.js";import{h as q}from"./SnappingOperation-637889a7.js";import{k as Q,c as W,o as X,b as U,e as G,S as ee}from"./drawSurfaces-51a47f59.js";import{p as te}from"./SnappingDragPipelineStep-5c33e2b0.js";var H;let _=H=class extends E.EventedAccessor{constructor(e){super(e),this._hasZ=null,this._cursorScreenPoint=null,this._activePointerId=null,this._stagedVertexUnsnapped=null,this._lastVertexUnsnapped=null,this._handles=new M,this._viewHandlesKey="view-handles",this._undoRedoHandlesKey="undo-redo-handles",this._drawToolHandlesKey="draw-tool",this._nativeEventHistory={undoStack:[],redoStack:[]},this.interactiveUndoDisabled=!1,this.history=[],this.redoHistory=[],this.snapToScene=!1,this.view=null,this.elevationInfo=null,this.defaultZ=0,this._coordinateHelper=B(!!e.hasZ,!1,e.view.spatialReference),this._snappingManager=e.snappingManager,this._editGeometryOperations=new k(new I(e.editGeometryType??"polygon",this._coordinateHelper)),this._snappingGraphicsLayer=new R({id:H.SNAPPING_GRAPHICS_LAYER_ID,listMode:"hide",internal:!0}),this._snappingContext=new J({editGeometryOperations:this._editGeometryOperations,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",visualizer:new j(this._snappingGraphicsLayer)}),this._activeComponent=new L(e.view.spatialReference,D.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}normalizeCtorArgs(e){const t={...e};return delete t.editGeometryType,t}initialize(){this._snappingOperation=new q({view:this.view}),this.view.type==="2d"&&this.view.map.layers.add(this._snappingGraphicsLayer)}destroy(){this._handles.destroy(),this.view.map.layers.remove(this._snappingGraphicsLayer),this._snappingGraphicsLayer.destroy(),r(this._snappingManager)&&this._snappingManager.doneSnapping(),this._snappingOperation=O(this._snappingOperation),this._editGeometryOperations.destroy()}get _committedVertices(){return this._editGeometryOperations.data.components[0].vertices.map(e=>e.pos)}get vertices(){return r(this._stagedVertex)?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}get hasZ(){return r(this._hasZ)?this._hasZ:this.view.type==="3d"}set hasZ(e){this._hasZ=e,this.notifyChange("hasZ")}get _stagedVertex(){return this._snappingOperation.stagedPoint}set _stagedVertex(e){this._snappingOperation.stagedPoint=$(e)}canUndo(){return this._editGeometryOperations.canUndo}canRedo(){return this._editGeometryOperations.canRedo}undo(){this.canUndo&&this._editGeometryOperations.undo()}redo(){this.canRedo&&this._editGeometryOperations.redo()}getCoordsFromScreenPoint(e){const t=e&&this.screenToMap(e);return x(t)?null:t.hasZ?[t.x,t.y,t.z]:[t.x,t.y]}getCoordsAndPointFromScreenPoint(e){const t=this.screenToMap(e);return x(t)?null:t.hasZ?{vertex:[t.x,t.y,t.z],mapPoint:t}:{vertex:[t.x,t.y],mapPoint:t}}screenToMap(e){let t=null;if(this.view.type==="3d")if(this.hasZ){const i=b(this.elevationInfo,ie);t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(A(e.x,e.y),i,this._getGeometryZValue())}else{const i=b(this.elevationInfo,oe);t=this.view.sceneIntersectionHelper.intersectElevationFromScreen(A(e.x,e.y),i,0),r(t)&&(t.z=void 0)}else t=this.view.toMap(e),r(t)&&(t.z=this.hasZ?this._getGeometryZValue():void 0);return t}_pushCursorVertex(e,t){const i=K(e[0],e[1],void 0,this.view.spatialReference);this._stagedVertexUnsnapped=i;const o=this._snappingManager;if(x(o))return this._stagedVertex=i,void t();z(this._snappingOperation.snap({point:i},o,this._snappingContext)).then(()=>{t()})}_popCursorVertex(){this._stagedVertexUnsnapped=null,this._stagedVertex=null}_getGeometryZValue(){return this.defaultZ}_abortSnapping(){this._snappingOperation.abort()}_isDuplicateOfLastVertex(e){const t=this._editGeometryOperations.data.components[0].getLastVertex();if(r(t)&&e[0]===t[0]&&e[1]===t[1])return!0;const{x:i,y:o}=this._coordinateHelper.vectorToDehydratedPoint(e);return!(!r(this._lastVertexUnsnapped)||i!==this._lastVertexUnsnapped.x||o!==this._lastVertexUnsnapped.y)}_shouldHandlePointerEvent(e){return this._isPrimaryPointerAction(e)&&(x(this._activePointerId)||this._activePointerId===e.pointerId)}_vertexAddHandler(e){const t=r(this._stagedVertex)?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);r(t)&&this._addVertex(t,e.native)}_drawCompleteHandler(e){this._completeDrawing(e.native)}_isPrimaryPointerAction(e){return e.pointerType!=="mouse"||e.button===0}};_.SNAPPING_GRAPHICS_LAYER_ID="DrawAction-snapping-graphics-layer",n([a({readOnly:!0})],_.prototype,"vertices",null),n([a({type:Boolean,nonNullable:!0})],_.prototype,"interactiveUndoDisabled",void 0),n([a({readOnly:!0})],_.prototype,"history",void 0),n([a({readOnly:!0})],_.prototype,"redoHistory",void 0),n([a()],_.prototype,"snapToScene",void 0),n([a()],_.prototype,"view",void 0),n([a()],_.prototype,"elevationInfo",void 0),n([a({nonNullable:!0})],_.prototype,"defaultZ",void 0),n([a()],_.prototype,"hasZ",null),n([a()],_.prototype,"_snappingOperation",void 0),n([a()],_.prototype,"_stagedVertex",null),_=H=n([w("esri.views.draw.DrawAction")],_);const ie={mode:"absolute-height",offset:0},oe={mode:"on-the-ground",offset:0},V=_;class c{constructor(t,i,o,h){this.view=t,this.native=i,this.vertexIndex=o,this.vertices=h,this.defaultPrevented=!1,this.type="vertex-add"}preventDefault(){this.defaultPrevented=!0}}class C{constructor(t,i,o,h){this.view=t,this.native=i,this.vertexIndex=o,this.vertices=h,this.defaultPrevented=!1,this.type="vertex-remove"}preventDefault(){this.defaultPrevented=!0}}class v{constructor(t,i,o,h,Z=null){this.view=t,this.native=i,this.vertexIndex=o,this.vertices=h,this.mapPoint=Z,this.coordinates=null,this.defaultPrevented=!1,this.type="cursor-update",this.coordinates=h.length===1?h[0]:null}preventDefault(){this.defaultPrevented=!0}}class u{constructor(t,i){this.native=t,this.vertices=i,this.coordinates=null,this.defaultPrevented=!1,this.type="draw-complete",this.coordinates=i.length===1?i[0]:null}preventDefault(){this.defaultPrevented=!0}}let S=class extends V{constructor(t){super(t),this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1}initialize(){this._addViewHandles(),this._addUndoRedoHandles()}destroy(){this._removeViewHandles(),this._removeUndoRedoHandles(),this.emit("destroy")}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){this._completeDrawing()}_addViewHandles(){this._removeViewHandles(),this._handles.add([this.view.on("click",t=>{t.stopPropagation()},s.TOOL),this.view.on("pointer-down",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._activePointerId=t.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=l(t),t.pointerType==="touch"&&this._updateCursor(t.native))},s.TOOL),this.view.on("pointer-move",t=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=l(t),t.pointerType!=="touch"&&this._updateCursor(t.native)},s.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",t=>{if(this._shouldHandlePointerEvent(t))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp)this._vertexAddHandler(t);else{const i=t.pointerType==="touch";this._updateCursor(t.native,i)}},s.TOOL),this.view.on("drag",["Shift"],t=>{t.stopPropagation()},s.TOOL),this.view.on("double-click",t=>{t.stopPropagation(),this._drawCompleteHandler(t)},s.TOOL),this.view.on("double-click",["Control"],t=>{t.stopPropagation(),this._drawCompleteHandler(t)},s.TOOL),this.view.on("key-down",t=>{const{key:i,repeat:o}=t;i===d.vertexAdd&&!o&&this._cursorScreenPoint?(t.stopPropagation(),this._abortSnapping(),this._vertexAddHandler(t)):i!==d.complete||o?i!==d.undo||this.interactiveUndoDisabled||o?i!==d.redo||this.interactiveUndoDisabled||o?i!==d.pan||o||t.stopPropagation():(t.stopPropagation(),this.redo()):(t.stopPropagation(),this.undo()):(t.stopPropagation(),this._drawCompleteHandler(t))},s.TOOL),this.view.on("key-up",t=>{t.key===d.pan&&t.stopPropagation()},s.TOOL)],this._viewHandlesKey)}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this._handles.add([this._editGeometryOperations.on("vertex-remove",t=>{if(this.notifyChange("vertices"),t.operation==="undo"){const i=this._nativeEventHistory.undoStack.pop();this._nativeEventHistory.redoStack.push(i);const o=[...this._committedVertices];r(this._stagedVertex)&&o.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new C(this.view,i,t.vertices[0].index,o))}}),this._editGeometryOperations.on("vertex-add",t=>{if(this.notifyChange("vertices"),t.operation==="apply"){const i=this._nativeEventHistory.undoStack[this._nativeEventHistory.undoStack.length],o=this._committedVertices.length-1,h=new c(this.view,i,o,this.vertices);this.emit("vertex-add",h),h.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(t.operation==="redo"){const i=this._nativeEventHistory.redoStack.pop();this._nativeEventHistory.undoStack.push(i);const o=[...this._committedVertices];r(this._stagedVertex)&&o.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new c(this.view,i,t.vertices[0].index,o))}})],this._undoRedoHandlesKey)}_removeViewHandles(){this._handles.remove(this._viewHandlesKey)}_removeUndoRedoHandles(){this._handles.remove(this._undoRedoHandlesKey)}_addVertex(t,i){const o=this._coordinateHelper.arrayToVector(t);if(this._isDuplicateOfLastVertex(o))return;this._popCursorVertex(),this._editGeometryOperations.appendVertex(o);const h=i||new Event("placeholder");this._nativeEventHistory.undoStack.push(h)}_updateCursor(t,i=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const o=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);r(o)&&!i&&this._pushCursorVertex(o.vertex,()=>this.emit("cursor-update",new v(this.view,t,this._activeComponent.vertices.length,this.vertices,r(this._stagedVertex)?new P(this._stagedVertex):null)))}_completeDrawing(t){if(this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),r(this._snappingManager)&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const i=new u(t,this.vertices);this.emit("draw-complete",i),i.defaultPrevented||this._removeViewHandles()}};S=n([w("esri.views.draw.MultipointDrawAction")],S);let p=class extends F(E.EventedMixin(te)){constructor(e){super(e),this.defaultZ=0,this.elevationInfo=null,this.hasZ=!0,this.mode=null,this.snapToScene=null,this.type="draw-3d"}initialize(){const e=this.view,t=N(this.hasZ,this.elevationInfo);this.drawOperation=new Q({view:e,manipulators:this.manipulators,geometryType:this.geometryType,drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:e.type==="3d"?new W(e,t):null,elevationDrawSurface:e.type==="3d"?new X(t,this.defaultZ,e):null,hasM:!1,elevationInfo:t}),this.handles.add([this.drawOperation.on("vertex-add",i=>this.onVertexAdd(i)),this.drawOperation.on("vertex-remove",i=>this.onVertexRemove(i)),this.drawOperation.on("vertex-update",i=>this.onVertexUpdate(i)),this.drawOperation.on("cursor-update",i=>this.onCursorUpdate(i)),this.drawOperation.on("complete",i=>this.onComplete(i))]),this.finishToolCreation()}destroy(){this.drawOperation=O(this.drawOperation),this._set("view",null)}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set enabled(e){this.drawOperation.interactive=e,this._set("enabled",e)}get updating(){var e;return((e=this.drawOperation)==null?void 0:e.updating)??!1}completeCreateOperation(){this.drawOperation.complete()}onDeactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}getVertexCoords(){return this.drawOperation.vertices}onInputEvent(e){this.drawOperation.onInputEvent(e)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo()}onComplete(e){this.emit("complete",e)}onCursorUpdate(e){this.emit("cursor-update",e)}onVertexAdd(e){this.emit("vertex-add",e)}onVertexRemove(e){this.emit("vertex-remove",e)}onVertexUpdate(e){this.emit("vertex-update",e)}};n([a({constructOnly:!0,nonNullable:!0})],p.prototype,"defaultZ",void 0),n([a()],p.prototype,"drawOperation",void 0),n([a({constructOnly:!0})],p.prototype,"elevationInfo",void 0),n([a({value:!0})],p.prototype,"enabled",null),n([a({constructOnly:!0})],p.prototype,"geometryType",void 0),n([a({constructOnly:!0})],p.prototype,"hasZ",void 0),n([a({constructOnly:!0})],p.prototype,"mode",void 0),n([a()],p.prototype,"snapToScene",void 0),n([a({readOnly:!0})],p.prototype,"type",void 0),n([a({readOnly:!0})],p.prototype,"updating",null),n([a({constructOnly:!0,nonNullable:!0})],p.prototype,"view",void 0),p=n([w("esri.views.draw.DrawTool")],p);let f=class extends V{constructor(e){super(e),this._addVertexOnPointerUp=!1}initialize(){this.view.type==="2d"?this._addViewHandles():this._addDrawTool()}destroy(){this.view.type==="2d"?this._removeViewHandles():this._removeDrawTool(),this.emit("destroy")}complete(){this.view.type==="2d"?this._cursorScreenPoint&&this._completeDrawing():this._drawTool.completeCreateOperation()}_addViewHandles(){this._removeViewHandles(),this._handles.add([this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=l(e),e.pointerType==="touch"&&this._updateCursor(e.native))},s.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._cursorScreenPoint=l(e),e.pointerType!=="touch"&&this._updateCursor(e.native)},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp)e.stopPropagation(),this._vertexAddHandler(e);else{const t=e.pointerType==="touch";this._updateCursor(e.native,t)}},s.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},s.TOOL),this.view.on("key-down",e=>{e.key===d.complete&&this._cursorScreenPoint&&(this._abortSnapping(),this._vertexAddHandler(e))},s.TOOL)],this._viewHandlesKey)}_removeViewHandles(){this._handles.remove(this._viewHandlesKey)}_addDrawTool(){this._drawTool=new p({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"point",mode:"click"}),this.view.addAndActivateTool(this._drawTool),this._handles.add([this._drawTool.on("cursor-update",e=>{e.vertices.length===1&&this.emit("cursor-update",new v(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("complete",e=>{this.emit("draw-complete",new u(null,this._drawTool.getVertexCoords())),this._removeDrawTool()})],this._drawToolHandlesKey)}_removeDrawTool(){this._handles.remove(this._drawToolHandlesKey),this.view.tools.remove(this._drawTool),this._drawTool=O(this._drawTool)}_addVertex(e){const t=this._coordinateHelper.arrayToVector(e);this._isDuplicateOfLastVertex(t)||(this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(t),this.notifyChange("vertices"),this._completeDrawing())}_updateCursor(e,t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);r(i)&&!t&&this._pushCursorVertex(i.vertex,()=>this.emit("cursor-update",new v(this.view,e,this._activeComponent.vertices.length,this.vertices,r(this._stagedVertex)?new P(this._stagedVertex):null)))}_completeDrawing(e){this._activePointerId=null,this._popCursorVertex(),this._abortSnapping(),r(this._snappingManager)&&this._snappingManager.doneSnapping();const t=new u(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}};f=n([w("esri.views.draw.PointDrawAction")],f);let g=class extends V{constructor(t){super(t),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this.mode=G}initialize(){this.view.type==="2d"?(this._addViewHandles(),this._addUndoRedoHandles()):this._addDrawTool()}destroy(){this.view.type==="2d"?(this._removeViewHandles(),this._removeUndoRedoHandles()):this._removeDrawTool(),this.emit("destroy")}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){this.view.type==="2d"?this._completeDrawing():this._drawTool.completeCreateOperation()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this._removeViewHandles(),this._handles.add([this.view.on("click",t=>{t.stopPropagation()},s.TOOL),this.view.on("pointer-down",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._activePointerId=t.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=l(t),t.pointerType==="touch"&&this._updateCursor(t.native))},s.TOOL),this.view.on("pointer-move",t=>{this._abortSnapping(),this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._cursorScreenPoint=l(t),t.pointerType!=="touch"&&this._updateCursor(t.native)},s.TOOL),this.view.on("pointer-drag",t=>{this._shouldHandlePointerEvent(t)&&(this._abortSnapping(),this._cursorScreenPoint=l(t),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(t):this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",t=>{if(this._shouldHandlePointerEvent(t))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(t);this._vertexAddHandler(t)}else{const i=t.pointerType==="touch";this._updateCursor(t.native,i)}},s.TOOL),this.view.on("drag",t=>{this._dragEnabled&&r(this._activePointerId)&&!this._panEnabled&&t.stopPropagation()},s.TOOL),this.view.on("drag",["Shift"],t=>{t.stopPropagation()},s.TOOL),this.view.on("double-click",t=>{t.stopPropagation(),this._drawCompleteHandler(t)},s.TOOL),this.view.on("double-click",["Control"],t=>{t.stopPropagation(),this._drawCompleteHandler(t)},s.TOOL),this.view.on("key-down",t=>{const{key:i,repeat:o}=t;i===d.vertexAdd&&!o&&this._cursorScreenPoint?(t.stopPropagation(),this._abortSnapping(),this._vertexAddHandler(t)):i!==d.complete||o?i!==d.undo||this.interactiveUndoDisabled||o?i!==d.redo||this.interactiveUndoDisabled||o?i!==d.pan||o||(t.stopPropagation(),this._panEnabled=!0):(t.stopPropagation(),this.redo()):(t.stopPropagation(),this.undo()):(t.stopPropagation(),this._drawCompleteHandler(t))},s.TOOL),this.view.on("key-up",t=>{t.key===d.pan&&(t.stopPropagation(),this._panEnabled=!1)},s.TOOL)],this._viewHandlesKey)}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this._handles.add([this._editGeometryOperations.on("vertex-remove",t=>{if(this.notifyChange("vertices"),t.operation==="undo"){const i=this._nativeEventHistory.undoStack.pop();this._nativeEventHistory.redoStack.push(i);const o=[...this._committedVertices];r(this._stagedVertex)&&o.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new C(this.view,i,t.vertices[0].index,o))}}),this._editGeometryOperations.on("vertex-add",t=>{if(this.notifyChange("vertices"),t.operation==="apply"){const i=this._nativeEventHistory.undoStack[this._nativeEventHistory.undoStack.length],o=this._committedVertices.length-1,h=new c(this.view,i,o,this.vertices);this.emit("vertex-add",h),h.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(t.operation==="redo"){const i=this._nativeEventHistory.redoStack.pop();this._nativeEventHistory.undoStack.push(i);const o=[...this._committedVertices];r(this._stagedVertex)&&o.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new c(this.view,i,t.vertices[0].index,o))}})],this._undoRedoHandlesKey)}_removeViewHandles(){this._handles.remove(this._viewHandlesKey)}_removeUndoRedoHandles(){this._handles.remove(this._undoRedoHandlesKey)}_addDrawTool(){this._drawTool=new p({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polygon",mode:this.mode}),this.view.addAndActivateTool(this._drawTool),this._drawTool.on("vertex-add",t=>{t.vertices.length===1&&this.emit("vertex-add",new c(this.view,null,t.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("cursor-update",t=>{t.vertices.length===1&&this.emit("cursor-update",new v(this.view,null,t.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("complete",t=>{this.emit("draw-complete",new u(null,this._drawTool.getVertexCoords())),this._removeDrawTool()})}_removeDrawTool(){this._handles.remove(this._drawToolHandlesKey),this.view.tools.remove(this._drawTool),this._drawTool=O(this._drawTool)}_addVertex(t,i){const o=this._coordinateHelper.arrayToVector(t);if(this._isDuplicateOfLastVertex(o))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(o);const h=i||new Event("placeholder");this._nativeEventHistory.undoStack.push(h)}_updateCursor(t,i=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const o=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);r(o)&&!i&&this._pushCursorVertex(o.vertex,()=>this.emit("cursor-update",new v(this.view,t,this._activeComponent.vertices.length,this.vertices,r(this._stagedVertex)?new P(this._stagedVertex):null)))}_completeDrawing(t){if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<3)return;this._abortSnapping(),r(this._snappingManager)&&this._snappingManager.doneSnapping();const i=new u(t,this.vertices);this.emit("draw-complete",i),i.defaultPrevented||this._removeViewHandles()}};n([a()],g.prototype,"_dragEnabled",null),n([a()],g.prototype,"_clickEnabled",null),n([a({type:U})],g.prototype,"mode",void 0),g=n([w("esri.views.draw.PolygonDrawAction")],g);let m=class extends V{constructor(e){super(e),this._panEnabled=!1,this._popVertexOnPointerMove=!1,this._addVertexOnPointerUp=!1,this.mode=G}initialize(){this.view.type==="2d"?(this._addViewHandles(),this._addUndoRedoHandles()):this._addDrawTool()}destroy(){this.view.type==="2d"?(this._removeViewHandles(),this._removeUndoRedoHandles()):this._removeDrawTool(),this.emit("destroy")}get _clickEnabled(){return this.mode==="click"||this.mode==="hybrid"}get _dragEnabled(){return this.mode==="freehand"||this.mode==="hybrid"}undo(){super.undo(),this.notifyChange("vertices")}redo(){super.redo(),this.notifyChange("vertices")}complete(){this.view.type==="2d"?this._completeDrawing():this._drawTool.completeCreateOperation()}_addViewHandles(){this._removeViewHandles(),this._handles.add([this.view.on("click",e=>{e.stopPropagation()},s.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&!this._panEnabled&&(this._abortSnapping(),this._activePointerId=e.pointerId,this._addVertexOnPointerUp=!0,this._cursorScreenPoint=l(e),e.pointerType==="touch"&&this._updateCursor(e.native))},s.TOOL),this.view.on("pointer-move",e=>{this._popVertexOnPointerMove&&(this.undo(),this._popVertexOnPointerMove=!1),this._abortSnapping(),this._cursorScreenPoint=l(e),e.pointerType!=="touch"&&this._updateCursor(e.native)},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._cursorScreenPoint=l(e),this._dragEnabled&&!this._panEnabled?this._vertexAddHandler(e):this._addVertexOnPointerUp=!1)},s.TOOL),this.view.on("pointer-up",e=>{if(this._shouldHandlePointerEvent(e))if(this._abortSnapping(),this._activePointerId=null,this._addVertexOnPointerUp){if(!this._clickEnabled)return this.vertices.length===1&&this.vertices.pop(),void this._drawCompleteHandler(e);this._vertexAddHandler(e)}else{const t=e.pointerType==="touch";this._updateCursor(e.native,t)}},s.TOOL),this.view.on("drag",e=>{this._dragEnabled&&r(this._activePointerId)&&!this._panEnabled&&e.stopPropagation()},s.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},s.TOOL),this.view.on("double-click",e=>{e.stopPropagation(),this._drawCompleteHandler(e)},s.TOOL),this.view.on("double-click",["Control"],e=>{e.stopPropagation(),this._drawCompleteHandler(e)},s.TOOL),this.view.on("key-down",e=>{const{key:t,repeat:i}=e;t===d.vertexAdd&&!i&&this._cursorScreenPoint?(e.stopPropagation(),this._abortSnapping(),this._vertexAddHandler(e)):t!==d.complete||i?t!==d.undo||this.interactiveUndoDisabled||i?t!==d.redo||this.interactiveUndoDisabled||i?t!==d.pan||i||(e.stopPropagation(),this._panEnabled=!0):(e.stopPropagation(),this.redo()):(e.stopPropagation(),this.undo()):(e.stopPropagation(),this._drawCompleteHandler(e))},s.TOOL),this.view.on("key-up",e=>{e.key===d.pan&&(e.stopPropagation(),this._panEnabled=!1)},s.TOOL)],this._viewHandlesKey)}_addUndoRedoHandles(){this._removeUndoRedoHandles(),this._handles.add([this._editGeometryOperations.on("vertex-remove",e=>{if(this.notifyChange("vertices"),e.operation==="undo"){const t=this._nativeEventHistory.undoStack.pop();this._nativeEventHistory.redoStack.push(t);const i=[...this._committedVertices];r(this._stagedVertex)&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("undo",new C(this.view,t,e.vertices[0].index,i))}}),this._editGeometryOperations.on("vertex-add",e=>{if(this.notifyChange("vertices"),e.operation==="apply"){const t=this._nativeEventHistory.undoStack[this._nativeEventHistory.undoStack.length],i=this._committedVertices.length-1,o=new c(this.view,t,i,this.vertices);this.emit("vertex-add",o),o.defaultPrevented&&(this._popVertexOnPointerMove=!0)}else if(e.operation==="redo"){const t=this._nativeEventHistory.redoStack.pop();this._nativeEventHistory.undoStack.push(t);const i=[...this._committedVertices];r(this._stagedVertex)&&i.push(this._coordinateHelper.pointToArray(this._stagedVertex)),this.emit("redo",new c(this.view,t,e.vertices[0].index,i))}})],this._undoRedoHandlesKey)}_removeViewHandles(){this._handles.remove(this._viewHandlesKey)}_removeUndoRedoHandles(){this._handles.remove(this._undoRedoHandlesKey)}_addDrawTool(){this._drawTool=new p({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"polyline",mode:this.mode}),this.view.addAndActivateTool(this._drawTool),this._handles.add([this._drawTool.on("vertex-add",e=>{e.vertices.length===1&&this.emit("vertex-add",new c(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("cursor-update",e=>{e.vertices.length===1&&this.emit("cursor-update",new v(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("complete",e=>{this.emit("draw-complete",new u(null,this._drawTool.getVertexCoords())),this._removeDrawTool()})],this._drawToolHandlesKey)}_removeDrawTool(){this._handles.remove(this._drawToolHandlesKey),this.view.tools.remove(this._drawTool),this._drawTool=O(this._drawTool)}_addVertex(e,t){const i=this._coordinateHelper.arrayToVector(e);if(this._isDuplicateOfLastVertex(i))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(i);const o=t||new Event("placeholder");this._nativeEventHistory.undoStack.push(o)}_updateCursor(e,t=!1){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const i=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);r(i)&&!t&&this._pushCursorVertex(i.vertex,()=>this.emit("cursor-update",new v(this.view,e,this._activeComponent.vertices.length,this.vertices,r(this._stagedVertex)?new P(this._stagedVertex):null)))}_completeDrawing(e){if(this._activePointerId=null,this._popCursorVertex(),this._committedVertices.length<2)return;this._abortSnapping(),r(this._snappingManager)&&this._snappingManager.doneSnapping();const t=new u(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}};n([a()],m.prototype,"_clickEnabled",null),n([a()],m.prototype,"_dragEnabled",null),n([a({type:U})],m.prototype,"mode",void 0),m=n([w("esri.views.draw.PolylineDrawAction")],m);const se=["freehand","click"];let T=class extends V{constructor(e){super(e),this._isDragging=!1,this._panEnabled=!1,this._addVertexOnPointerUp=!1,this.viewAlignedCoordinateSystem=null,this.mode="freehand"}initialize(){this.view.type==="2d"?this._addViewHandles():this._addDrawTool()}destroy(){this.view.type==="2d"?this._removeViewHandles():this._removeDrawTool(),this.emit("destroy")}complete(){this.view.type==="2d"?this._completeDrawing():this._drawTool.completeCreateOperation()}_getGeometryZValue(){return this.hasZ&&this.vertices.length>0?this.vertices[0][2]:this.defaultZ}_addViewHandles(){this._removeViewHandles(),this.mode==="click"?this._handles.add(this._getClickModeViewHandles(),this._viewHandlesKey):this._handles.add(this._getDragModeViewHandles(),this._viewHandlesKey)}_getDragModeViewHandles(){return[this.view.on("immediate-click",e=>{if(e.stopPropagation(),e.mapPoint&&!this._panEnabled){const t=this.getCoordsFromScreenPoint(l(e));r(t)&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))}},s.TOOL),this.view.on("pointer-down",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._panEnabled||(this._resetGeometry(),this._addVertexOnPointerUp=!0,this._cursorScreenPoint=l(e),this._activePointerId=e.pointerId,this._vertexAddHandler(e),this._isDragging=!1,e.pointerType==="touch"&&this._updateCursor(e.native)))},s.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),x(this._activePointerId)&&e.pointerType!=="touch"&&(this._cursorScreenPoint=l(e),this._updateCursor(e.native))},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._isDragging=!0,this._cursorScreenPoint=l(e),this._updateCursor(e.native))},s.TOOL),this.view.on("pointer-up",e=>{this._shouldHandlePointerEvent(e)&&this._addVertexOnPointerUp&&(this._abortSnapping(),this._activePointerId=null,this._isDragging&&this._vertexAddHandler(e),this._committedVertices.length===2&&this._drawCompleteHandler(e),this._isDragging=!1)},s.TOOL),this.view.on("key-down",e=>{e.key===d.complete&&this._cursorScreenPoint?(this._abortSnapping(),this._vertexAddHandler(e),this._drawCompleteHandler(e)):e.key===d.pan&&(this._panEnabled=!0)},s.TOOL),this.view.on("key-up",e=>{e.key===d.pan&&(this._panEnabled=!1)},s.TOOL),this.view.on("drag",e=>{r(this._activePointerId)&&e.stopPropagation()},s.TOOL),this.view.on("drag",["Shift"],e=>{e.stopPropagation()},s.TOOL)]}_getClickModeViewHandles(){return[this.view.on("pointer-down",e=>{this._abortSnapping(),this._cursorScreenPoint=l(e),this._activePointerId=e.pointerId,this._isDragging=!1,e.pointerType==="touch"&&this._updateCursor(e.native)},s.TOOL),this.view.on("pointer-move",e=>{this._abortSnapping(),this._cursorScreenPoint=l(e),x(this._activePointerId)&&e.pointerType!=="touch"&&this._updateCursor(e.native)},s.TOOL),this.view.on("pointer-drag",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._isDragging=!0)},s.TOOL),this.view.on("pointer-up",e=>{this._shouldHandlePointerEvent(e)&&(this._abortSnapping(),this._activePointerId=null,e.stopPropagation(),this._isDragging||this._vertexAddHandler(e),this.vertices.length!==2||this._isDragging||this._drawCompleteHandler(e),this._isDragging=!1)},s.TOOL),this.view.on("key-down",e=>{e.key===d.vertexAdd&&this._cursorScreenPoint&&(this._vertexAddHandler(e),this.vertices.length===2&&this._drawCompleteHandler(e)),e.key===d.complete&&this._cursorScreenPoint&&this.vertices.length===2&&(this._vertexAddHandler(e),this._drawCompleteHandler(e))},s.TOOL)]}_removeViewHandles(){this._handles.remove(this._viewHandlesKey)}_addDrawTool(){this._drawTool=new p({view:this.view,elevationInfo:this.elevationInfo,hasZ:this.hasZ,geometryType:"segment",mode:this.mode}),this.view.addAndActivateTool(this._drawTool),this._handles.add([this._drawTool.on("vertex-add",e=>{e.vertices.length===1&&this.emit("vertex-add",new c(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("cursor-update",e=>{e.vertices.length===1&&this.emit("cursor-update",new v(this.view,null,e.vertices[0].vertexIndex,this._drawTool.getVertexCoords()))}),this._drawTool.on("complete",e=>{this.emit("draw-complete",new u(null,this._drawTool.getVertexCoords())),this._removeDrawTool()})],this._drawToolHandlesKey)}_removeDrawTool(){this._handles.remove(this._drawToolHandlesKey),this.view.tools.remove(this._drawTool),this._drawTool=O(this._drawTool)}_addVertex(e,t){const i=this._coordinateHelper.arrayToVector(e);if(this._isDuplicateOfLastVertex(i))return;this._lastVertexUnsnapped=this._stagedVertexUnsnapped,this._popCursorVertex(),this._editGeometryOperations.appendVertex(i),this._committedVertices.length===1&&(this.viewAlignedCoordinateSystem=ee(this.view,this._committedVertices[0]));const o=this._committedVertices.length-1,h=new c(this.view,t,o,this.vertices);this.emit("vertex-add",h)}_updateCursor(e){if(this._popCursorVertex(),!this._cursorScreenPoint)return;const t=this.getCoordsAndPointFromScreenPoint(this._cursorScreenPoint);r(t)&&this._pushCursorVertex(t.vertex,()=>this.emit("cursor-update",new v(this.view,e,this._activeComponent.vertices.length,this.vertices,r(this._stagedVertex)?new P(this._stagedVertex):null)))}_completeDrawing(e){if(this._activePointerId=null,this._popCursorVertex(),this._cursorScreenPoint=null,this._isDragging=!1,this._abortSnapping(),r(this._snappingManager)&&this._snappingManager.doneSnapping(),this.vertices.length<1)return;const t=new u(e,this.vertices);this.emit("draw-complete",t),t.defaultPrevented||this._removeViewHandles()}_resetGeometry(){this._editGeometryOperations.destroy(),this._editGeometryOperations=new k(new I("polygon",this._coordinateHelper)),this._activeComponent=new L(this._coordinateHelper.spatialReference,D.Local),this._editGeometryOperations.data.components.push(this._activeComponent)}};n([a({type:se})],T.prototype,"mode",void 0),T=n([w("esri/views/2d/engine/markup/SegmentDrawAction")],T);let y=class extends Y{constructor(){super(...arguments),this.activeAction=null,this.type="draw",this.view=null}destroy(){this.activeAction&&(this.activeAction.destroy(),this.activeAction=null)}create(e,t){this.reset();const i={view:this.view,...t};switch(e){case"point":i.editGeometryType="point",this.activeAction=new f(i);break;case"polyline":i.editGeometryType="polyline",this.activeAction=new m(i);break;case"multipoint":i.editGeometryType="polygon",this.activeAction=new S(i);break;case"polygon":i.editGeometryType="polygon",this.activeAction=new g(i);break;case"rectangle":case"circle":case"ellipse":case"triangle":i.editGeometryType="polygon",this.activeAction=new T(i)}return this.activeAction}complete(){this.activeAction&&this.activeAction.complete(),this.activeAction=null}reset(){this.activeAction&&this.activeAction.destroy(),this.activeAction=null}};n([a()],y.prototype,"activeAction",void 0),n([a({readOnly:!0})],y.prototype,"type",void 0),n([a()],y.prototype,"view",void 0),y=n([w("esri.views.draw.Draw")],y);const ce=y;export{ce as l};
