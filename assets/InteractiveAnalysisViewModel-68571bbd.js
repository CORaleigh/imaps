import{a$ as A,f as $,aC as d,e as a,y as l,a as m,z as y,U as g,qE as T,j1 as v,D as R,E as b,qF as U,qG as F,qH as N,c4 as E,jr as C,x as I,J as n,dr as k,cv as D,a6 as c,at as w,a7 as G,cm as V,aN as M,ac as x,ad as W,f7 as j}from"./index-056c54a4.js";import"./geometryEngineBase-e1a33b0a.js";import{p as B}from"./SnappingDragPipelineStep-53254785.js";import{v as H}from"./InteractiveToolViewModel-fe6f77c2.js";function ee(e){let s,t,i=[],r=!1;function O(..._){return r&&s===this&&S(_,i)||(t=e.apply(this,_),s=this,i=_,r=!0),t}return O}function S(e,s){if(e.length!==s.length)return!1;for(let t=0;t<e.length;++t)if(e[t]!==s[t])return!1;return!0}function se(e){return e.pointerType!=="mouse"||e.button===0}const q=d(),z=d(),P=d();new A({rings:[[q,z,P]],spatialReference:$.WGS84});let p=class extends B{constructor(s){super(s)}initialize(){this.addHandles(y(()=>this.analysisViewData.visible,s=>this.visible=s,g))}deactivate(){this.onDeactivate(),this.created||this.analysis.clear()}resetCreated(){this._set("created",!1)}};a([l({constructOnly:!0})],p.prototype,"analysis",void 0),a([l()],p.prototype,"analysisViewData",void 0),p=a([m("esri.views.interactive.AnalysisToolBase")],p);function Y(e,s){const t=new T({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:(s==null?void 0:s.distance)??v.distance,touchSensitivityMultiplier:(s==null?void 0:s.touchSensitivityMultiplier)??v.touchSensitivityMultiplier});return{...y(()=>{var i,r;return((r=(i=e.map)==null?void 0:i.allLayers)==null?void 0:r.toArray())??[]},i=>{t.featureSources=new b(i.map(r=>new U({layer:r,enabled:!0})))},R),options:t}}const u=new Map;function ie(e){if(!u.has(e)){const i=Y(e,{distance:10}),r=L(e,i.options);u.set(e,{referenceCount:0,snappingManager:r,remove:()=>{i.remove(),r.destroy()}})}const s=u.get(e);s.referenceCount++;const t=E(()=>J(e,s));return{snappingManager:s.snappingManager,...t}}function J(e,s){s.referenceCount--,s.referenceCount>0||C(()=>{s.referenceCount===0&&(s.remove(),u.delete(e))})}function L(e,s){return new F({view:e,options:s,snappingEnginesFactory:(t,i)=>[new N({view:e,spatialReference:e.spatialReference,options:i})]})}var h;(function(e){e[e.PENDING=0]="PENDING",e[e.WAIT_FOR_VIEW_READY=1]="WAIT_FOR_VIEW_READY",e[e.RUNNING=2]="RUNNING"})(h||(h={}));let o=class extends H{constructor(e={}){super(e),this.analysisView=null,this._reconnectViewTask=null,this._analysisBaseHandles=new I,this._parentChangeFromReconnect=!1,this._startUserOperation=null;const s=e==null?void 0:e.analysis;n(s)?this.analysis=s:(this._set("analysis",this.constructAnalysis()),this._set("isAnalysisOwner",!0))}normalizeCtorArgs(e){const{analysis:s,...t}=e;return t}initialize(){this._analysisBaseHandles.add([y(()=>D(this.analysis,({parent:e})=>e),e=>{this._parentChangeFromReconnect||e===this.view||this._set("isAnalysisOwner",!1);const s=!this._parentChangeFromReconnect;this._parentChangeFromReconnect=!1,s&&this._scheduleViewReconnect()},k),y(()=>({view:this.view,ready:n(this.view)&&this.view.ready,supported:this.supported}),({view:e},s)=>{const t=s==null?void 0:s.view;e!==t&&(this._startUserOperation=c(this._startUserOperation),this._disconnectFromView(t)),this._scheduleViewReconnect()},g),y(()=>this.analysis.isEditable,(e,s)=>{w(this.analysisView)||(e&&!s&&w(this.tool)?this.createTool():!e&&s&&n(this.tool)&&!this.tool.active&&this.removeTool())})])}destroy(){this._analysisBaseHandles=G(this._analysisBaseHandles),this._reconnectViewTask=c(this._reconnectViewTask),this._startUserOperation=c(this._startUserOperation),n(this.analysisView)&&(this.analysisView.visible=void 0),this._disconnectFromView(this.view),n(this.analysis)&&this.isAnalysisOwner&&(this.analysis.destroy(),this._set("analysis",null))}set analysis(e){e!==this._get("analysis")&&(this._startUserOperation=c(this._startUserOperation),this._disconnectFromView(this.view),this._setExternalAnalysis(e),this._scheduleViewReconnect())}get ready(){return n(this.analysisView)&&!this.connectingToView}get connectingToView(){return n(this._reconnectViewTask)}get isAnalysisOwner(){return this._get("isAnalysisOwner")}set visible(e){this._set("visible",e),n(this.analysisView)&&(this.analysisView.visible=e)}async start(){this.clear();const e={task:null,abort:null,state:h.PENDING},s=V(async t=>{e.state=h.WAIT_FOR_VIEW_READY,await M(()=>this.ready,t),e.state=h.RUNNING,this.createTool({interactive:!0})});return e.task=s,e.abort=()=>s.abort(),this._startUserOperation=e,s.promise}clear(){this._startUserOperation=c(this._startUserOperation),this.removeTool(),this.analysis.clear()}onConnectToAnalysisView(e){}onDisconnectFromAnalysisView(){}_scheduleViewReconnect(){this._reconnectViewTask=c(this._reconnectViewTask);const e=V(async s=>{try{await this._reconnectView(s)}catch(t){if(x(s),!W(t))return void this.logger.warn("Failed to use analysis in view model",t);throw t}finally{e===this._reconnectViewTask&&(this._reconnectViewTask=null)}});this._reconnectViewTask=e}async _reconnectView(e){const{view:s}=this,t=n(s)&&s.ready&&this.supported,i=this.analysis;if(this._startUserOperation=f(this._startUserOperation),this._disconnectFromView(s),t&&!w(s)&&!w(i)){if(this.isAnalysisOwner){if(n(i.parent))return void this.logError("expected owned analysis to have null parent when connecting to view");this._parentChangeFromReconnect=!0,s.analyses.add(i)}this.analysisView=await s.whenAnalysisView(i),j(e)?this._startUserOperation=f(this._startUserOperation):(this.analysisView.visible=this.visible,this.onConnectToAnalysisView(this.analysisView),this.createTool())}}_disconnectFromView(e){this.removeTool(),n(e)&&this.isAnalysisOwner&&(this._parentChangeFromReconnect=!0,e.analyses.remove(this.analysis),this.analysis.clear()),this.analysisView=null,this.onDisconnectFromAnalysisView()}_setExternalAnalysis(e){n(this.analysisView)&&!this.isAnalysisOwner&&(this.analysisView.visible=!0),this.analysisView=null,this._set("isAnalysisOwner",!1),this._set("analysis",e),this._parentChangeFromReconnect=!1}get testInfo(){return{analysisView:this.analysisView}}};function f(e){return n(e)&&e.state>=h.RUNNING?(e.abort(),null):e}a([l({nonNullable:!0})],o.prototype,"analysis",null),a([l()],o.prototype,"analysisView",void 0),a([l()],o.prototype,"ready",null),a([l()],o.prototype,"connectingToView",null),a([l({readOnly:!0})],o.prototype,"isAnalysisOwner",null),a([l({type:Boolean,value:!0})],o.prototype,"visible",null),a([l()],o.prototype,"_reconnectViewTask",void 0),o=a([m("esri.widgets.support.InteractiveAnalysisViewModel")],o);export{se as E,p as a,ie as b,ee as t,o as v};
